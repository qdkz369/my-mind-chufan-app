# API ä»£ç ä¿®æ”¹æ€»ç»“ - è¡¨æ‹†åˆ†è¿ç§»ï¼ˆå®Œæ•´ç‰ˆï¼‰

## âœ… ä¿®æ”¹å®Œæˆ

å·²å°†æ‰€æœ‰ä½¿ç”¨ `orders` è¡¨çš„ API å’Œå‰ç«¯é¡µé¢ä¿®æ”¹ä¸ºä½¿ç”¨ `repair_orders` æˆ– `delivery_orders` è¡¨ã€‚

## ğŸ“‹ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### 1. åç«¯ APIï¼ˆ10 ä¸ªæ–‡ä»¶ï¼‰

#### âœ… æŠ¥ä¿®å·¥å•ç›¸å…³ APIï¼ˆ3 ä¸ªï¼‰

1. **`app/api/repair/create/route.ts`**
   - ä¿®æ”¹ï¼š`.from("orders")` â†’ `.from("repair_orders")`ï¼ˆ2 å¤„ï¼‰
   - å½±å“ï¼šåˆ›å»ºæŠ¥ä¿®å·¥å•

2. **`app/api/repair/list/route.ts`**
   - ä¿®æ”¹ï¼š`.from("orders")` â†’ `.from("repair_orders")`
   - ç®€åŒ–ï¼šç§»é™¤å¤æ‚çš„ `service_type` è¿‡æ»¤é€»è¾‘ï¼ˆè¡¨å·²åˆ†ç¦»ï¼‰
   - å½±å“ï¼šæŸ¥è¯¢æŠ¥ä¿®å·¥å•åˆ—è¡¨

3. **`app/api/repair/update/route.ts`**
   - ä¿®æ”¹ï¼š`.from("orders")` â†’ `.from("repair_orders")`ï¼ˆ2 å¤„ï¼‰
   - å½±å“ï¼šæ›´æ–°æŠ¥ä¿®å·¥å•çŠ¶æ€

#### âœ… ç‡ƒæ–™é…é€è®¢å•ç›¸å…³ APIï¼ˆ5 ä¸ªï¼‰

4. **`app/api/orders/create/route.ts`**
   - ä¿®æ”¹ï¼š`.from("orders")` â†’ `.from("delivery_orders")`
   - ä¿®æ”¹ï¼š`service_type` å›ºå®šä¸º `"ç‡ƒæ–™é…é€"`ï¼ˆè¡¨å·²åˆ†ç¦»ï¼‰
   - å½±å“ï¼šåˆ›å»ºç‡ƒæ–™é…é€è®¢å•

5. **`app/api/orders/pending/route.ts`**
   - ä¿®æ”¹ï¼š`.from("orders")` â†’ `.from("delivery_orders")`
   - å½±å“ï¼šæŸ¥è¯¢å¾…æ¥å•è®¢å•åˆ—è¡¨

6. **`app/api/orders/accept/route.ts`**
   - ä¿®æ”¹ï¼š`.from("orders")` â†’ `.from("delivery_orders")`ï¼ˆ2 å¤„ï¼‰
   - å½±å“ï¼šé…é€å‘˜æ¥å•

7. **`app/api/orders/dispatch/route.ts`**
   - ä¿®æ”¹ï¼š`.from("orders")` â†’ `.from("delivery_orders")`ï¼ˆ2 å¤„ï¼‰
   - å½±å“ï¼šé…é€å‘˜æ´¾å•

8. **`app/api/orders/complete/route.ts`**
   - ä¿®æ”¹ï¼š`.from("orders")` â†’ `.from("delivery_orders")`ï¼ˆ2 å¤„ï¼‰
   - å½±å“ï¼šå®Œæˆé…é€

#### âœ… å…¶ä»–ç›¸å…³ APIï¼ˆ2 ä¸ªï¼‰

9. **`app/api/payment/alipay/notify/route.ts`**
   - ä¿®æ”¹ï¼šæ”¯æŒä¸¤ç§è®¢å•ç±»å‹
   - é€»è¾‘ï¼šå…ˆå°è¯•æ›´æ–° `delivery_orders`ï¼Œå¤±è´¥åˆ™æ›´æ–° `repair_orders`
   - å½±å“ï¼šæ”¯ä»˜å›è°ƒæ›´æ–°è®¢å•çŠ¶æ€

10. **`app/api/filling/route.ts`**
    - ä¿®æ”¹ï¼š`.from("orders")` â†’ `.from("delivery_orders")`ï¼ˆ2 å¤„ï¼‰
    - å½±å“ï¼šé…é€å®Œæˆåæ›´æ–°è®¢å•çŠ¶æ€

### 2. å‰ç«¯é¡µé¢ï¼ˆ3 ä¸ªæ–‡ä»¶ï¼‰

11. **`app/(admin)/dashboard/page.tsx`**
    - ä¿®æ”¹ä½ç½®ï¼š3 å¤„
    - æ”¹åŠ¨ï¼š
      - `loadRecentOrders`ï¼šåˆ†åˆ«æŸ¥è¯¢ `repair_orders` å’Œ `delivery_orders`ï¼Œç„¶ååˆå¹¶
      - `loadAllOrders`ï¼šæ ¹æ®ç­›é€‰æ¡ä»¶åˆ†åˆ«æŸ¥è¯¢ä¸¤ä¸ªè¡¨ï¼Œç„¶ååˆå¹¶
      - `handleUpdateRepair`ï¼šæ›´æ–° `repair_orders` è¡¨
    - å½±å“ï¼šç®¡ç†åå°è®¢å•åˆ—è¡¨å’ŒæŠ¥ä¿®ç®¡ç†

12. **`app/page.tsx`**
    - ä¿®æ”¹ä½ç½®ï¼š2 å¤„
    - æ”¹åŠ¨ï¼š
      - å†å²ç»´ä¿®æŸ¥è¯¢ï¼š`.from("orders")` â†’ `.from("repair_orders")`
      - ç§»é™¤ `service_type` è¿‡æ»¤ï¼ˆè¡¨å·²åˆ†ç¦»ï¼‰
    - å½±å“ï¼šä¸»é¡µé¢å†å²ç»´ä¿®è®°å½•

13. **`app/customer/confirm/page.tsx`**
    - ä¿®æ”¹ä½ç½®ï¼š1 å¤„
    - æ”¹åŠ¨ï¼š
      - è®¢å•æŸ¥è¯¢ï¼šå…ˆæŸ¥è¯¢ `delivery_orders`ï¼Œå¤±è´¥åˆ™æŸ¥è¯¢ `repair_orders`
    - å½±å“ï¼šå®¢æˆ·ç¡®è®¤é¡µé¢è®¢å•æŸ¥è¯¢

## ğŸ“Š ä¿®æ”¹ç»Ÿè®¡

| ç±»å‹ | æ–‡ä»¶æ•° | ä¿®æ”¹è¡Œæ•° |
|------|--------|---------|
| åç«¯ API | 10 | ~30 |
| å‰ç«¯é¡µé¢ | 3 | ~15 |
| **æ€»è®¡** | **13** | **~45** |

## ğŸ” å…³é”®æ”¹åŠ¨è¯´æ˜

### 1. è¡¨åæ›¿æ¢
- `orders` â†’ `repair_orders`ï¼ˆæŠ¥ä¿®å·¥å•ï¼‰
- `orders` â†’ `delivery_orders`ï¼ˆç‡ƒæ–™é…é€è®¢å•ï¼‰

### 2. æŸ¥è¯¢é€»è¾‘ä¼˜åŒ–

#### æŠ¥ä¿®å·¥å• API
- **repair/list**ï¼šç§»é™¤å¤æ‚çš„ `service_type` è¿‡æ»¤é€»è¾‘ï¼Œå› ä¸ºè¡¨å·²åˆ†ç¦»
- ç›´æ¥æŸ¥è¯¢ `repair_orders` è¡¨ï¼Œæ— éœ€è¿‡æ»¤

#### ç‡ƒæ–™é…é€ API
- **orders/create**ï¼š`service_type` å›ºå®šä¸º `"ç‡ƒæ–™é…é€"`
- æ‰€æœ‰é…é€ç›¸å…³ API ç›´æ¥æŸ¥è¯¢ `delivery_orders` è¡¨

### 3. å‰ç«¯é¡µé¢å¤„ç†

#### ç®¡ç†åå°ï¼ˆdashboard/page.tsxï¼‰
- **loadRecentOrders**ï¼šå¹¶è¡ŒæŸ¥è¯¢ä¸¤ä¸ªè¡¨ï¼Œåˆå¹¶ç»“æœåæ’åº
- **loadAllOrders**ï¼šæ ¹æ®ç­›é€‰æ¡ä»¶åˆ†åˆ«æŸ¥è¯¢ï¼Œç„¶ååˆå¹¶
- **handleUpdateRepair**ï¼šç›´æ¥æ›´æ–° `repair_orders` è¡¨

#### ä¸»é¡µé¢ï¼ˆpage.tsxï¼‰
- å†å²ç»´ä¿®æŸ¥è¯¢ï¼šç›´æ¥æŸ¥è¯¢ `repair_orders` è¡¨

#### å®¢æˆ·ç¡®è®¤é¡µé¢ï¼ˆcustomer/confirm/page.tsxï¼‰
- è®¢å•æŸ¥è¯¢ï¼šå…ˆå°è¯• `delivery_orders`ï¼Œå¤±è´¥åˆ™å°è¯• `repair_orders`

### 4. æ”¯ä»˜å›è°ƒå¤„ç†
- **payment/alipay/notify**ï¼šéœ€è¦åˆ¤æ–­è®¢å•ç±»å‹
- å…ˆå°è¯•æ›´æ–° `delivery_orders`ï¼Œå¤±è´¥åˆ™æ›´æ–° `repair_orders`

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“è¿ç§»å¿…é¡»å…ˆæ‰§è¡Œ**
   - å¿…é¡»å…ˆæ‰§è¡Œ `migrations/20250120_split_orders_table.sql`
   - ç¡®ä¿æ–°è¡¨å·²åˆ›å»ºä¸”æ•°æ®å·²è¿ç§»

2. **å‰ç«¯æŸ¥è¯¢åˆå¹¶**
   - ç®¡ç†åå°éœ€è¦åˆ†åˆ«æŸ¥è¯¢ä¸¤ä¸ªè¡¨ç„¶ååˆå¹¶
   - ç¡®ä¿æ’åºå’Œåˆ†é¡µé€»è¾‘æ­£ç¡®

3. **å­—æ®µæ˜ å°„**
   - `worker_id` å­—æ®µå·²åºŸå¼ƒï¼Œä¼˜å…ˆä½¿ç”¨ `assigned_to`
   - å‰ç«¯æ˜¾ç¤ºæ—¶ä½¿ç”¨ `assigned_to || worker_id`

4. **å‘åå…¼å®¹**
   - ä»£ç ä¿®æ”¹åï¼Œæ—§çš„ `orders` è¡¨ä¸å†ä½¿ç”¨
   - å»ºè®®ä¿ç•™ `orders` è¡¨ 30 å¤©ä½œä¸ºå¤‡ä»½

## âœ… éªŒè¯æ¸…å•

- [x] æ‰€æœ‰åç«¯ API æ–‡ä»¶å·²ä¿®æ”¹ï¼ˆ10 ä¸ªï¼‰
- [x] æ‰€æœ‰å‰ç«¯é¡µé¢å·²ä¿®æ”¹ï¼ˆ3 ä¸ªï¼‰
- [x] è¡¨åæ›¿æ¢å®Œæˆ
- [x] æŸ¥è¯¢é€»è¾‘å·²ä¼˜åŒ–
- [x] æ”¯ä»˜å›è°ƒæ”¯æŒä¸¤ç§è®¢å•ç±»å‹
- [x] å‰ç«¯æŸ¥è¯¢åˆå¹¶é€»è¾‘å·²å®ç°
- [x] æ— å…³é”® linter é”™è¯¯ï¼ˆTailwind CSS è­¦å‘Šå¯å¿½ç•¥ï¼‰
- [ ] æ•°æ®åº“è¿ç§»å·²æ‰§è¡Œï¼ˆå¾…æ‰§è¡Œï¼‰
- [ ] åŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼ˆå¾…æµ‹è¯•ï¼‰

## ğŸ“ ä¸‹ä¸€æ­¥

1. **æ‰§è¡Œæ•°æ®åº“è¿ç§»**
   ```sql
   -- åœ¨ Supabase Dashboard æ‰§è¡Œ
   -- migrations/20250120_split_orders_table.sql
   ```

2. **éƒ¨ç½²ä»£ç **
   - éƒ¨ç½²ä¿®æ”¹åçš„ä»£ç 
   - é‡å¯æœåŠ¡

3. **åŠŸèƒ½æµ‹è¯•**
   - æµ‹è¯•åˆ›å»ºæŠ¥ä¿®å·¥å•
   - æµ‹è¯•åˆ›å»ºé…é€è®¢å•
   - æµ‹è¯•æŸ¥è¯¢åˆ—è¡¨ï¼ˆç®¡ç†åå°ã€ä¸»é¡µé¢ï¼‰
   - æµ‹è¯•æ›´æ–°çŠ¶æ€
   - æµ‹è¯•æ”¯ä»˜å›è°ƒ
   - æµ‹è¯•å®¢æˆ·ç¡®è®¤é¡µé¢

4. **ç›‘æ§è§‚å¯Ÿ**
   - ç›‘æ§é”™è¯¯æ—¥å¿—
   - éªŒè¯æ•°æ®å®Œæ•´æ€§
   - ç¡®è®¤æ€§èƒ½æ­£å¸¸

---

**ä¿®æ”¹å®Œæˆæ—¥æœŸ**ï¼š2025-01-20  
**ä¿®æ”¹ç‰ˆæœ¬**ï¼šv1.0  
**ä¿®æ”¹æ–‡ä»¶æ€»æ•°**ï¼š13 ä¸ªï¼ˆ10 ä¸ª API + 3 ä¸ªå‰ç«¯é¡µé¢ï¼‰
