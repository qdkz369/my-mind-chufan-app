# P2çº§åˆ«åŠŸèƒ½å®ç°å®ŒæˆæŠ¥å‘Š

> å®Œæˆæ—¶é—´ï¼š2025-01-25  
> ä¼˜å…ˆçº§ï¼šP2ï¼ˆè¿è¥æ•ˆç‡æå‡ï¼‰

---

## âœ… å·²å®ŒæˆåŠŸèƒ½æ¸…å•

### ã€P2-1ã€‘è®¾å¤‡æœªå½’è¿˜è‡ªåŠ¨æ£€æµ‹ âœ…

#### 1. è®¾å¤‡æœªå½’è¿˜æ£€æµ‹å®šæ—¶ä»»åŠ¡ API âœ…
**è·¯å¾„**ï¼š`POST /api/cron/check-overdue-rentals`  
**ä¾¿æ·æ¥å£**ï¼š`GET /api/cron/check-overdue-rentals?dry_run=true&auto_mark=false`

**åŠŸèƒ½**ï¼š
- è‡ªåŠ¨æ£€æŸ¥ `end_date < ä»Šå¤©` ä¸” `order_status = 'active'` çš„è®¢å•
- è®¡ç®—é€¾æœŸå¤©æ•°
- æ”¯æŒè‡ªåŠ¨æ ‡è®°æœªå½’è¿˜è®¾å¤‡ï¼ˆå¯é€‰ï¼‰
- æ”¯æŒæ¨¡æ‹Ÿè¿è¡Œï¼ˆdry_runï¼‰

**è¯·æ±‚ä½“ï¼ˆå¯é€‰ï¼‰**ï¼š
```json
{
  "dry_run": false,  // æ˜¯å¦ä»…æ¨¡æ‹Ÿè¿è¡Œï¼ˆé»˜è®¤ï¼šfalseï¼‰
  "auto_mark": false,  // æ˜¯å¦è‡ªåŠ¨æ ‡è®°æœªå½’è¿˜ï¼ˆé»˜è®¤ï¼šfalseï¼‰
  "min_overdue_days": 0,  // æœ€å°é€¾æœŸå¤©æ•°ï¼ˆé»˜è®¤ï¼š0ï¼‰
  "batch_size": 100  // æ‰¹é‡å¤„ç†æ•°é‡ï¼ˆé»˜è®¤ï¼š100ï¼‰
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "data": {
    "checked_count": 10,
    "overdue_orders": [
      {
        "id": "uuid",
        "order_number": "RENT123456",
        "equipment_id": "uuid",
        "end_date": "2025-01-15",
        "overdue_days": 10
      }
    ],
    "marked_count": 0,
    "message": "æ£€æµ‹å®Œæˆï¼šå‘ç° 5 ä¸ªé€¾æœŸè®¢å•"
  }
}
```

**ä½¿ç”¨å»ºè®®**ï¼š
- é…ç½®å¤–éƒ¨å®šæ—¶ä»»åŠ¡æœåŠ¡æ¯å¤©è°ƒç”¨æ­¤æ¥å£
- é¦–æ¬¡è¿è¡Œå»ºè®®ä½¿ç”¨ `dry_run=true` å…ˆæŸ¥çœ‹æœ‰å¤šå°‘è®¢å•é€¾æœŸ
- å»ºè®® `auto_mark=true` æ—¶é…åˆ `min_overdue_days` ä½¿ç”¨ï¼ˆä¾‹å¦‚ï¼šé€¾æœŸ30å¤©ä»¥ä¸Šæ‰è‡ªåŠ¨æ ‡è®°ï¼‰

---

#### 2. è®¾å¤‡æœªå½’è¿˜æ ‡è®° API âœ…
**è·¯å¾„**ï¼š`POST /api/equipment/rental/mark-unreturned`

**åŠŸèƒ½**ï¼š
- æ‰‹åŠ¨æ ‡è®°è®¾å¤‡ä¸ºæœªå½’è¿˜
- æ›´æ–° `rental_records` è¡¨çŠ¶æ€ä¸º `'lost'`
- è®°å½•æœªå½’è¿˜åŸå› å’Œé€¾æœŸå¤©æ•°

**è¯·æ±‚ä½“**ï¼š
```json
{
  "rental_order_id": "uuid",
  "days_overdue": 30,  // å¯é€‰ï¼Œä¸æä¾›åˆ™è‡ªåŠ¨è®¡ç®—
  "action": "mark_lost",  // 'send_reminder' | 'mark_lost' | 'legal_action'
  "notes": "å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "data": {
    "rental_order_id": "uuid",
    "action": "mark_lost",
    "days_overdue": 30,
    "equipment_id": "uuid"
  },
  "message": "è®¾å¤‡æœªå½’è¿˜æ ‡è®°æˆåŠŸï¼ˆæ“ä½œç±»å‹ï¼šmark_lostï¼‰"
}
```

---

### ã€P2-2ã€‘è´¢åŠ¡å¯¹è´¦åŠŸèƒ½ âœ…

#### è´¢åŠ¡å¯¹è´¦ API âœ…
**è·¯å¾„**ï¼š`GET /api/finance/reconciliation`

**åŠŸèƒ½**ï¼š
- æ±‡æ€»æ‰€æœ‰è®¢å•çš„åº”æ”¶åº”ä»˜
- æŒ‰æ—¶é—´èŒƒå›´ã€ä¾›åº”å•†ã€é¤å…ç­›é€‰
- ç»Ÿè®¡è®¢å•å’Œè´¦æœŸæ•°æ®
- è®¡ç®—åº”æ”¶åº”ä»˜æ±‡æ€»

**æŸ¥è¯¢å‚æ•°**ï¼š
```
?start_date=2025-01-01        // å¯é€‰ï¼Œé»˜è®¤ï¼š30å¤©å‰
&end_date=2025-01-31          // å¯é€‰ï¼Œé»˜è®¤ï¼šä»Šå¤©
&provider_id=uuid             // å¯é€‰ï¼Œä¾›åº”å•†ID
&restaurant_id=uuid           // å¯é€‰ï¼Œé¤å…ID
&order_status=active          // å¯é€‰ï¼Œè®¢å•çŠ¶æ€
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "data": {
    "period": {
      "start_date": "2025-01-01",
      "end_date": "2025-01-31"
    },
    "summary": {
      "orders": {
        "total_count": 50,
        "by_status": {
          "active": 30,
          "completed": 20
        },
        "total_amount": 100000.00,
        "total_deposit": 20000.00,
        "total_refunded": 1000.00
      },
      "billing_cycles": {
        "total_count": 150,
        "by_status": {
          "paid": 100,
          "pending": 30,
          "overdue": 20
        },
        "total_amount_due": 150000.00,
        "total_amount_paid": 100000.00,
        "total_amount_overdue": 10000.00
      },
      "receivable": {
        "total": 50000.00,      // æ€»åº”æ”¶
        "overdue": 10000.00,    // é€¾æœŸåº”æ”¶
        "normal": 40000.00      // æ­£å¸¸åº”æ”¶
      },
      "received": {
        "total": 100000.00,     // æ€»å·²æ”¶
        "deposit": 19000.00     // æŠ¼é‡‘å‡€æ”¶å…¥
      }
    },
    "orders": [
      {
        "order_id": "uuid",
        "order_number": "RENT123456",
        "order_status": "active",
        "total_amount": 3000.00,
        "deposit_amount": 500.00,
        "billing_cycles_count": 3,
        "amount_due": 3000.00,
        "amount_paid": 2000.00,
        "amount_overdue": 500.00
      }
    ]
  }
}
```

---

### ã€P2-3ã€‘è®¾å¤‡æœªå½’è¿˜å‚¬æ”¶æµç¨‹ âœ…

#### è®¾å¤‡å½’è¿˜å‚¬æ”¶é€šçŸ¥ API âœ…
**è·¯å¾„**ï¼š`POST /api/equipment/rental/collection/return-notice`

**åŠŸèƒ½**ï¼š
- å‘é€è®¾å¤‡å½’è¿˜å‚¬æ”¶é€šçŸ¥
- æ”¯æŒå¤šç§é€šçŸ¥æ–¹å¼ï¼ˆçŸ­ä¿¡/é‚®ä»¶/ç”µè¯/ç«™å†…ä¿¡ï¼‰
- è‡ªåŠ¨ç”Ÿæˆå‚¬æ”¶æ¶ˆæ¯æ¨¡æ¿
- è®°å½•å‚¬æ”¶å†å²

**è¯·æ±‚ä½“**ï¼š
```json
{
  "rental_order_id": "uuid",
  "notification_type": "sms" | "email" | "phone" | "in_app",
  "days_overdue": 30,  // å¯é€‰ï¼Œä¸æä¾›åˆ™è‡ªåŠ¨è®¡ç®—
  "message": "è‡ªå®šä¹‰å‚¬æ”¶æ¶ˆæ¯ï¼ˆå¯é€‰ï¼‰",
  "recipient_phone": "13800138000",  // å¯é€‰
  "recipient_email": "user@example.com"  // å¯é€‰
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "data": {
    "rental_order_id": "uuid",
    "notification_type": "sms",
    "message": "ã€è®¾å¤‡å½’è¿˜å‚¬æ”¶é€šçŸ¥ã€‘\nè®¢å•å·ï¼šRENT123456\n...",
    "recipient_phone": "13800138000",
    "days_overdue": 30,
    "sent_at": "2025-01-25T10:00:00Z"
  },
  "message": "è®¾å¤‡å½’è¿˜å‚¬æ”¶é€šçŸ¥å·²å‘é€ï¼ˆç±»å‹ï¼šsmsï¼‰",
  "note": "æ³¨æ„ï¼šå½“å‰ç‰ˆæœ¬ä»…è®°å½•é€šçŸ¥ï¼Œå®é™…å‘é€åŠŸèƒ½éœ€è¦é›†æˆç¬¬ä¸‰æ–¹æœåŠ¡"
}
```

**é»˜è®¤å‚¬æ”¶æ¶ˆæ¯æ¨¡æ¿**ï¼š
```
ã€è®¾å¤‡å½’è¿˜å‚¬æ”¶é€šçŸ¥ã€‘
è®¢å•å·ï¼šRENT123456
ç§Ÿèµç»“æŸæ—¥æœŸï¼š2025-01-15
é€¾æœŸå¤©æ•°ï¼š30 å¤©
è¯·å°½å¿«å½’è¿˜è®¾å¤‡ï¼Œæ„Ÿè°¢é…åˆï¼
```

---

## ğŸ“‹ API ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šæ£€æµ‹é€¾æœŸè®¾å¤‡ï¼ˆæ¨¡æ‹Ÿè¿è¡Œï¼‰

```bash
curl -X GET "http://localhost:3000/api/cron/check-overdue-rentals?dry_run=true"
```

### ç¤ºä¾‹ 2ï¼šæ£€æµ‹å¹¶è‡ªåŠ¨æ ‡è®°é€¾æœŸè®¾å¤‡

```bash
curl -X POST http://localhost:3000/api/cron/check-overdue-rentals \
  -H "Content-Type: application/json" \
  -d '{
    "auto_mark": true,
    "min_overdue_days": 30
  }'
```

### ç¤ºä¾‹ 3ï¼šæ‰‹åŠ¨æ ‡è®°è®¾å¤‡ä¸ºæœªå½’è¿˜

```bash
curl -X POST http://localhost:3000/api/equipment/rental/mark-unreturned \
  -H "Content-Type: application/json" \
  -d '{
    "rental_order_id": "xxx",
    "action": "mark_lost",
    "notes": "è®¾å¤‡é€¾æœŸ30å¤©æœªå½’è¿˜"
  }'
```

### ç¤ºä¾‹ 4ï¼šè´¢åŠ¡å¯¹è´¦

```bash
curl -X GET "http://localhost:3000/api/finance/reconciliation?start_date=2025-01-01&end_date=2025-01-31"
```

### ç¤ºä¾‹ 5ï¼šå‘é€è®¾å¤‡å½’è¿˜å‚¬æ”¶é€šçŸ¥

```bash
curl -X POST http://localhost:3000/api/equipment/rental/collection/return-notice \
  -H "Content-Type: application/json" \
  -d '{
    "rental_order_id": "xxx",
    "notification_type": "sms"
  }'
```

---

## ğŸ”§ å®šæ—¶ä»»åŠ¡é…ç½®å»ºè®®

### è®¾å¤‡æœªå½’è¿˜æ£€æµ‹å®šæ—¶ä»»åŠ¡

**æ¨èé…ç½®**ï¼šæ¯å¤©å‡Œæ™¨ 3 ç‚¹æ‰§è¡Œ

**Vercel Cron**ï¼ˆ`vercel.json`ï¼‰ï¼š
```json
{
  "crons": [
    {
      "path": "/api/cron/check-overdue-billing",
      "schedule": "0 2 * * *"  // æ¯å¤©å‡Œæ™¨2ç‚¹ï¼šé€¾æœŸè´¦æœŸæ£€æµ‹
    },
    {
      "path": "/api/cron/check-overdue-rentals",
      "schedule": "0 3 * * *"  // æ¯å¤©å‡Œæ™¨3ç‚¹ï¼šè®¾å¤‡æœªå½’è¿˜æ£€æµ‹
    }
  ]
}
```

**å»ºè®®å‚æ•°**ï¼š
- é€¾æœŸè´¦æœŸæ£€æµ‹ï¼šæ¯å¤©æ‰§è¡Œï¼Œ`dry_run=false`
- è®¾å¤‡æœªå½’è¿˜æ£€æµ‹ï¼šæ¯å¤©æ‰§è¡Œï¼Œ`dry_run=false`ï¼Œ`auto_mark=true`ï¼Œ`min_overdue_days=30`ï¼ˆé€¾æœŸ30å¤©ä»¥ä¸Šæ‰è‡ªåŠ¨æ ‡è®°ï¼‰

---

## ğŸ“Š æ•°æ®è¡¨å˜æ›´

### rental_records è¡¨ä½¿ç”¨

**å­—æ®µæ›´æ–°**ï¼š
- `status`: æ›´æ–°ä¸º `'lost'`ï¼ˆè®¾å¤‡æœªå½’è¿˜æ—¶ï¼‰
- `return_condition`: æ›´æ–°ä¸º `'lost'`
- `notes`: è®°å½•æœªå½’è¿˜åŸå› å’Œé€¾æœŸå¤©æ•°

### rental_events è¡¨è®°å½•

**æ–°å¢äº‹ä»¶ç±»å‹**ï¼š
- `equipment_marked_unreturned`: è®¾å¤‡æœªå½’è¿˜æ ‡è®°
- `return_collection_notification_sent`: è®¾å¤‡å½’è¿˜å‚¬æ”¶é€šçŸ¥å‘é€

---

## ğŸ”„ ä¸šåŠ¡æµç¨‹å»ºè®®

### è‡ªåŠ¨æ£€æµ‹å’Œå‚¬æ”¶æµç¨‹

**æ¯æ—¥æ‰§è¡Œæµç¨‹**ï¼š

1. **å‡Œæ™¨2ç‚¹**ï¼šé€¾æœŸè´¦æœŸæ£€æµ‹
   ```bash
   POST /api/cron/check-overdue-billing
   ```

2. **å‡Œæ™¨3ç‚¹**ï¼šè®¾å¤‡æœªå½’è¿˜æ£€æµ‹
   ```bash
   POST /api/cron/check-overdue-rentals
   {
     "auto_mark": true,
     "min_overdue_days": 30
   }
   ```

3. **ä¸Šåˆ10ç‚¹**ï¼šè‡ªåŠ¨å‚¬æ”¶ï¼ˆå¯é€‰ï¼‰
   - é€¾æœŸè´¦æœŸå‚¬æ”¶ï¼šè°ƒç”¨ `/api/finance/collection/notify`
   - è®¾å¤‡å½’è¿˜å‚¬æ”¶ï¼šè°ƒç”¨ `/api/equipment/rental/collection/return-notice`

---

## âœ… æµ‹è¯•å»ºè®®

### 1. è®¾å¤‡æœªå½’è¿˜æ£€æµ‹æµ‹è¯•

```bash
# 1. åˆ›å»ºä¸€ä¸ªè®¢å•ï¼ˆorder_status = 'active'ï¼Œend_date < ä»Šå¤©ï¼‰
# 2. æ¨¡æ‹Ÿè¿è¡Œæ£€æµ‹
GET /api/cron/check-overdue-rentals?dry_run=true

# 3. å®é™…æ‰§è¡Œæ£€æµ‹
POST /api/cron/check-overdue-rentals

# 4. éªŒè¯æ˜¯å¦æ£€æµ‹åˆ°é€¾æœŸè®¢å•
```

### 2. è´¢åŠ¡å¯¹è´¦æµ‹è¯•

```bash
# 1. ç¡®ä¿æœ‰è®¢å•å’Œè´¦æœŸæ•°æ®
# 2. æŸ¥è¯¢è´¢åŠ¡å¯¹è´¦
GET /api/finance/reconciliation?start_date=2025-01-01&end_date=2025-01-31

# 3. éªŒè¯ç»Ÿè®¡æ•°æ®æ˜¯å¦æ­£ç¡®
# 4. éªŒè¯è®¢å•æ˜ç»†æ˜¯å¦å®Œæ•´
```

### 3. è®¾å¤‡å½’è¿˜å‚¬æ”¶æµ‹è¯•

```bash
# 1. ç¡®ä¿æœ‰é€¾æœŸçš„è®¢å•
# 2. å‘é€å‚¬æ”¶é€šçŸ¥
POST /api/equipment/rental/collection/return-notice

# 3. éªŒè¯ rental_events è¡¨æ˜¯å¦è®°å½•äº‹ä»¶
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æƒé™éªŒè¯**ï¼š
   - æ‰€æœ‰APIéƒ½æ”¯æŒå¤šç§Ÿæˆ·éš”ç¦»ï¼ˆ`provider_id` è¿‡æ»¤ï¼‰
   - å®šæ—¶ä»»åŠ¡APIéœ€è¦ Service Role Key

2. **è‡ªåŠ¨æ ‡è®°**ï¼š
   - `auto_mark=true` æ—¶ä¼šè‡ªåŠ¨æ›´æ–° `rental_records.status = 'lost'`
   - å»ºè®®é…åˆ `min_overdue_days` ä½¿ç”¨ï¼Œé¿å…è¿‡æ—©æ ‡è®°

3. **é€šçŸ¥å‘é€**ï¼š
   - å½“å‰ç‰ˆæœ¬ä»…è®°å½•é€šçŸ¥ï¼Œä¸å®é™…å‘é€
   - éœ€è¦é›†æˆç¬¬ä¸‰æ–¹æœåŠ¡æ‰èƒ½å®é™…å‘é€

4. **å¯¹è´¦æ•°æ®**ï¼š
   - å¯¹è´¦APIè¿”å›çš„æ•°æ®åŒ…å«è®¢å•å’Œè´¦æœŸçš„å®Œæ•´æ±‡æ€»
   - æ”¯æŒæŒ‰æ—¶é—´èŒƒå›´ã€ä¾›åº”å•†ã€é¤å…ç­‰å¤šç»´åº¦ç­›é€‰

---

## ğŸ¯ ä¸‹ä¸€æ­¥

å®Œæˆ P2 çº§åˆ«åï¼Œå»ºè®®ï¼š

1. **é…ç½®å®šæ—¶ä»»åŠ¡**ï¼šå°†é€¾æœŸæ£€æµ‹é…ç½®ä¸ºæ¯å¤©è‡ªåŠ¨æ‰§è¡Œ
2. **é›†æˆé€šçŸ¥æœåŠ¡**ï¼šé›†æˆçŸ­ä¿¡/é‚®ä»¶/ç”µè¯æœåŠ¡ï¼Œå®ç°å®é™…å‘é€
3. **å‰ç«¯é›†æˆ**ï¼šåœ¨ç®¡ç†åå°æ·»åŠ è´¢åŠ¡å¯¹è´¦å’Œè®¾å¤‡å‚¬æ”¶åŠŸèƒ½
4. **æ•°æ®å¯¼å‡º**ï¼šä¸ºè´¢åŠ¡å¯¹è´¦æ·»åŠ  Excel/PDF å¯¼å‡ºåŠŸèƒ½ï¼ˆP3çº§åˆ«ï¼‰

---

## ğŸ“Š å·²å®ŒæˆåŠŸèƒ½æ€»è§ˆ

| ä¼˜å…ˆçº§ | åŠŸèƒ½æ¨¡å— | APIæ•°é‡ | çŠ¶æ€ |
|-------|---------|---------|------|
| **P0** | è®¾å¤‡æŸåä¸ŠæŠ¥ä¸èµ”å¿æµç¨‹ | 2 | âœ… å·²å®Œæˆ |
| **P0** | é€¾æœŸè´¦æœŸè‡ªåŠ¨æ ‡è®°ä¸æŸ¥è¯¢ | 3 | âœ… å·²å®Œæˆ |
| **P1** | æŠ¼é‡‘é€€æ¬¾æµç¨‹ | 1 | âœ… å·²å®Œæˆ |
| **P1** | é€¾æœŸè´¦æœŸå‚¬æ”¶é€šçŸ¥ | 1 | âœ… å·²å®Œæˆ |
| **P2** | è®¾å¤‡æœªå½’è¿˜è‡ªåŠ¨æ£€æµ‹ | 2 | âœ… å·²å®Œæˆ |
| **P2** | è´¢åŠ¡å¯¹è´¦åŠŸèƒ½ | 1 | âœ… å·²å®Œæˆ |
| **P2** | è®¾å¤‡æœªå½’è¿˜å‚¬æ”¶æµç¨‹ | 1 | âœ… å·²å®Œæˆ |
| **æ€»è®¡** | **11ä¸ªAPI** | **11** | **âœ… 100%å®Œæˆ** |

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**å®Œæˆæ—¶é—´**ï¼š2025-01-25  
**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ
