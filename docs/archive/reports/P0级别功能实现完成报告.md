# P0çº§åˆ«åŠŸèƒ½å®ç°å®ŒæˆæŠ¥å‘Š

> å®Œæˆæ—¶é—´ï¼š2025-01-25  
> ä¼˜å…ˆçº§ï¼šP0ï¼ˆä¸šåŠ¡æ ¸å¿ƒåŠŸèƒ½ï¼‰

---

## âœ… å·²å®ŒæˆåŠŸèƒ½æ¸…å•

### ã€P0-1ã€‘è®¾å¤‡æŸåä¸ŠæŠ¥ä¸èµ”å¿æµç¨‹

#### 1. è®¾å¤‡æŸåä¸ŠæŠ¥ API âœ…
**è·¯å¾„**ï¼š`POST /api/equipment/rental/damage/report`

**åŠŸèƒ½**ï¼š
- è®°å½•è®¾å¤‡æŸåæƒ…å†µ
- è‡ªåŠ¨è®¡ç®—èµ”å¿è´¹ç”¨ï¼ˆæ ¹æ®æŸåç±»å‹ï¼‰
- æ›´æ–° `rental_records` è¡¨
- è®°å½•æŸåäº‹ä»¶åˆ° `rental_events`

**è¯·æ±‚ä½“**ï¼š
```json
{
  "rental_order_id": "uuid",
  "equipment_id": "uuid",
  "damage_type": "minor" | "major" | "total",
  "damage_description": "æŸåæè¿°ï¼ˆå¯é€‰ï¼‰",
  "damage_photos": ["url1", "url2"],
  "estimated_fee": 1000.00  // å¯é€‰ï¼Œä¸æä¾›ä¼šè‡ªåŠ¨è®¡ç®—
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "data": {
    "rental_record_id": "uuid",
    "damage_fee": 1000.00,
    "damage_type": "major"
  },
  "message": "è®¾å¤‡æŸåä¸ŠæŠ¥æˆåŠŸ"
}
```

**èµ”å¿è´¹ç”¨è®¡ç®—è§„åˆ™**ï¼š
- `minor`ï¼ˆè½»å¾®æŸåï¼‰ï¼šæœˆç§Ÿé‡‘æˆ–æŠ¼é‡‘çš„ 10%
- `major`ï¼ˆä¸¥é‡æŸåï¼‰ï¼šæœˆç§Ÿé‡‘æˆ–æŠ¼é‡‘çš„ 50%
- `total`ï¼ˆå®Œå…¨æŸåï¼‰ï¼šæŠ¼é‡‘å…¨é¢

---

#### 2. è®¾å¤‡å½’è¿˜æ£€æŸ¥ API âœ…
**è·¯å¾„**ï¼š`POST /api/equipment/rental/return/check`

**åŠŸèƒ½**ï¼š
- æ£€æŸ¥è®¾å¤‡å½’è¿˜çŠ¶æ€
- è®°å½•å½’è¿˜æ¡ä»¶ï¼ˆå®Œå¥½/æ­£å¸¸ç£¨æŸ/æŸå/ä¸¢å¤±ï¼‰
- æ›´æ–° `rental_records` è¡¨
- è®°å½•å½’è¿˜æ£€æŸ¥äº‹ä»¶

**è¯·æ±‚ä½“**ï¼š
```json
{
  "rental_order_id": "uuid",
  "return_condition": "good" | "normal_wear" | "damaged" | "lost",
  "return_photos": ["url1", "url2"],
  "damage_fee": 1000.00,  // å¦‚æœ return_condition ä¸º 'damaged' æ—¶å»ºè®®æä¾›
  "notes": "å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "data": {
    "rental_record_id": "uuid",
    "return_condition": "damaged",
    "damage_fee": 1000.00,
    "status": "damaged"
  },
  "message": "è®¾å¤‡å½’è¿˜æ£€æŸ¥å®Œæˆ"
}
```

---

### ã€P0-2ã€‘é€¾æœŸè´¦æœŸè‡ªåŠ¨æ ‡è®°ä¸æŸ¥è¯¢

#### 3. é€¾æœŸè´¦æœŸæ£€æµ‹å®šæ—¶ä»»åŠ¡ API âœ…
**è·¯å¾„**ï¼š`POST /api/cron/check-overdue-billing`  
**ä¾¿æ·æ¥å£**ï¼š`GET /api/cron/check-overdue-billing?dry_run=true`

**åŠŸèƒ½**ï¼š
- è‡ªåŠ¨æ£€æŸ¥ `due_date < ä»Šå¤©` ä¸” `status IN ('pending', 'partial')` çš„è´¦æœŸ
- è‡ªåŠ¨æ›´æ–° `status = 'overdue'`
- æ”¯æŒæ¨¡æ‹Ÿè¿è¡Œï¼ˆdry_runï¼‰

**è¯·æ±‚ä½“ï¼ˆå¯é€‰ï¼‰**ï¼š
```json
{
  "dry_run": false,  // æ˜¯å¦ä»…æ¨¡æ‹Ÿè¿è¡Œï¼ˆé»˜è®¤ï¼šfalseï¼‰
  "batch_size": 100  // æ‰¹é‡å¤„ç†æ•°é‡ï¼ˆé»˜è®¤ï¼š100ï¼‰
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "data": {
    "updated_count": 5,
    "overdue_cycles": [
      {
        "id": "uuid",
        "rental_order_id": "uuid",
        "cycle_month": "2025-01",
        "due_date": "2025-01-15",
        "amount_due": 1000.00,
        "amount_paid": 0.00,
        "overdue_days": 10,
        "amount_overdue": 1000.00
      }
    ],
    "message": "æˆåŠŸæ ‡è®° 5 ä¸ªé€¾æœŸè´¦æœŸ"
  },
  "dry_run": false
}
```

**ä½¿ç”¨å»ºè®®**ï¼š
- é…ç½®å¤–éƒ¨å®šæ—¶ä»»åŠ¡æœåŠ¡ï¼ˆå¦‚ Vercel Cronã€GitHub Actionsã€Cron Jobï¼‰æ¯å¤©è°ƒç”¨æ­¤æ¥å£
- é¦–æ¬¡è¿è¡Œå»ºè®®ä½¿ç”¨ `dry_run=true` å…ˆæŸ¥çœ‹æœ‰å¤šå°‘è´¦æœŸéœ€è¦æ ‡è®°

---

#### 4. é€¾æœŸè´¦æœŸæŸ¥è¯¢ API âœ…
**è·¯å¾„**ï¼š`GET /api/finance/billing/overdue`

**åŠŸèƒ½**ï¼š
- æŸ¥è¯¢é€¾æœŸè´¦æœŸåˆ—è¡¨
- æ”¯æŒæŒ‰é¤å…ã€é€¾æœŸå¤©æ•°ç­›é€‰
- æ”¯æŒåˆ†é¡µ
- ç»Ÿè®¡é€¾æœŸé‡‘é¢å’Œæ•°é‡

**æŸ¥è¯¢å‚æ•°**ï¼š
```
?restaurant_id=uuid          // å¯é€‰ï¼šé¤å…ID
&days=30                     // å¯é€‰ï¼šæœ€å°é€¾æœŸå¤©æ•°ï¼ˆä¾‹å¦‚ï¼š30 è¡¨ç¤ºæŸ¥è¯¢é€¾æœŸ30å¤©ä»¥ä¸Šçš„ï¼‰
&status=overdue              // å¯é€‰ï¼šè´¦æœŸçŠ¶æ€ï¼ˆé»˜è®¤ï¼š'overdue'ï¼‰
&page=1                      // å¯é€‰ï¼šé¡µç ï¼ˆé»˜è®¤ï¼š1ï¼‰
&page_size=20                // å¯é€‰ï¼šæ¯é¡µæ•°é‡ï¼ˆé»˜è®¤ï¼š20ï¼‰
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "data": {
    "overdue_cycles": [
      {
        "id": "uuid",
        "rental_order_id": "uuid",
        "order_number": "RENT123456",
        "restaurant_id": "uuid",
        "cycle_month": "2025-01",
        "due_date": "2025-01-15",
        "amount_due": 1000.00,
        "amount_paid": 0.00,
        "amount_overdue": 1000.00,
        "overdue_days": 10,
        "status": "overdue"
      }
    ],
    "pagination": {
      "page": 1,
      "page_size": 20,
      "total": 5,
      "total_pages": 1
    },
    "summary": {
      "total_count": 5,
      "total_overdue_amount": 5000.00,
      "avg_overdue_days": 10
    }
  }
}
```

---

#### 5. æ¬ æ¬¾ç»Ÿè®¡ API âœ…
**è·¯å¾„**ï¼š`GET /api/finance/billing/statistics`

**åŠŸèƒ½**ï¼š
- ç»Ÿè®¡æ€»æ¬ æ¬¾é‡‘é¢
- ç»Ÿè®¡é€¾æœŸè´¦æœŸæ•°é‡
- ç»Ÿè®¡æœ€é•¿é€¾æœŸå¤©æ•°
- æŒ‰é¤å…åˆ†ç»„ç»Ÿè®¡

**æŸ¥è¯¢å‚æ•°**ï¼š
```
?restaurant_id=uuid          // å¯é€‰ï¼šé¤å…ID
&include_pending=false       // å¯é€‰ï¼šæ˜¯å¦åŒ…å«å¾…æ”¯ä»˜è´¦æœŸï¼ˆé»˜è®¤ï¼šfalseï¼Œåªç»Ÿè®¡é€¾æœŸï¼‰
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "data": {
    "summary": {
      "total_cycles": 10,
      "overdue_count": 8,
      "pending_count": 2,
      "total_amount_due": 10000.00,
      "total_amount_paid": 2000.00,
      "total_amount_overdue": 8000.00,
      "max_overdue_days": 45,
      "avg_overdue_days": 20
    },
    "by_restaurant": [
      {
        "restaurant_id": "uuid",
        "total_overdue": 5000.00,
        "cycle_count": 5
      }
    ]
  }
}
```

---

## ğŸ“‹ API ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šä¸ŠæŠ¥è®¾å¤‡æŸå

```bash
curl -X POST http://localhost:3000/api/equipment/rental/damage/report \
  -H "Content-Type: application/json" \
  -d '{
    "rental_order_id": "xxx",
    "equipment_id": "xxx",
    "damage_type": "major",
    "damage_description": "è®¾å¤‡å¤–è§‚ä¸¥é‡ç£¨æŸ",
    "damage_photos": ["https://..."]
  }'
```

### ç¤ºä¾‹ 2ï¼šæ£€æŸ¥è®¾å¤‡å½’è¿˜

```bash
curl -X POST http://localhost:3000/api/equipment/rental/return/check \
  -H "Content-Type: application/json" \
  -d '{
    "rental_order_id": "xxx",
    "return_condition": "damaged",
    "damage_fee": 500.00,
    "return_photos": ["https://..."]
  }'
```

### ç¤ºä¾‹ 3ï¼šæ£€æµ‹é€¾æœŸè´¦æœŸï¼ˆæ¨¡æ‹Ÿè¿è¡Œï¼‰

```bash
curl -X GET "http://localhost:3000/api/cron/check-overdue-billing?dry_run=true"
```

### ç¤ºä¾‹ 4ï¼šæŸ¥è¯¢é€¾æœŸè´¦æœŸ

```bash
curl -X GET "http://localhost:3000/api/finance/billing/overdue?days=30&page=1&page_size=20"
```

### ç¤ºä¾‹ 5ï¼šæŸ¥è¯¢æ¬ æ¬¾ç»Ÿè®¡

```bash
curl -X GET "http://localhost:3000/api/finance/billing/statistics?include_pending=false"
```

---

## ğŸ”§ å®šæ—¶ä»»åŠ¡é…ç½®å»ºè®®

### æ–¹å¼ 1ï¼šä½¿ç”¨ Vercel Cronï¼ˆæ¨èï¼‰

åœ¨ `vercel.json` ä¸­æ·»åŠ ï¼š

```json
{
  "crons": [{
    "path": "/api/cron/check-overdue-billing",
    "schedule": "0 2 * * *"
  }]
}
```

è¯´æ˜ï¼šæ¯å¤©å‡Œæ™¨ 2 ç‚¹æ‰§è¡Œä¸€æ¬¡

### æ–¹å¼ 2ï¼šä½¿ç”¨ GitHub Actions

åˆ›å»º `.github/workflows/check-overdue-billing.yml`ï¼š

```yaml
name: Check Overdue Billing
on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨2ç‚¹
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  check-overdue:
    runs-on: ubuntu-latest
    steps:
      - name: Check Overdue Billing
        run: |
          curl -X POST "${{ secrets.API_URL }}/api/cron/check-overdue-billing" \
            -H "Authorization: Bearer ${{ secrets.API_TOKEN }}"
```

### æ–¹å¼ 3ï¼šä½¿ç”¨å¤–éƒ¨ Cron æœåŠ¡

é…ç½®å¤–éƒ¨ Cron æœåŠ¡ï¼ˆå¦‚ EasyCronã€Cronitorï¼‰æ¯å¤©è°ƒç”¨ï¼š
```
POST https://your-domain.com/api/cron/check-overdue-billing
```

---

## ğŸ“Š æ•°æ®è¡¨å˜æ›´

### rental_records è¡¨ä½¿ç”¨

**å­—æ®µ**ï¼š
- `status`: æ›´æ–°ä¸º `'damaged'` æˆ– `'lost'` æˆ– `'returned'`
- `return_condition`: æ›´æ–°ä¸º `'good'` / `'normal_wear'` / `'damaged'` / `'lost'`
- `damage_fee`: è®°å½•èµ”å¿è´¹ç”¨
- `actual_end_date`: è®°å½•å½’è¿˜æ—¥æœŸ

### rental_billing_cycles è¡¨ä½¿ç”¨

**å­—æ®µ**ï¼š
- `status`: è‡ªåŠ¨æ›´æ–°ä¸º `'overdue'`ï¼ˆå½“ `due_date < ä»Šå¤©` ä¸”çŠ¶æ€ä¸º `'pending'` æˆ– `'partial'` æ—¶ï¼‰

### rental_events è¡¨è®°å½•

**æ–°å¢äº‹ä»¶ç±»å‹**ï¼š
- `equipment_damaged`: è®¾å¤‡æŸåä¸ŠæŠ¥
- `equipment_return_checked`: è®¾å¤‡å½’è¿˜æ£€æŸ¥

---

## âœ… æµ‹è¯•å»ºè®®

### 1. è®¾å¤‡æŸåä¸ŠæŠ¥æµ‹è¯•

```bash
# 1. åˆ›å»ºä¸€ä¸ªç§Ÿèµè®¢å•ï¼ˆç¡®ä¿ order_status = 'active'ï¼‰
# 2. ä¸ŠæŠ¥è®¾å¤‡æŸå
POST /api/equipment/rental/damage/report

# 3. éªŒè¯ rental_records è¡¨æ˜¯å¦åˆ›å»º/æ›´æ–°è®°å½•
# 4. éªŒè¯ rental_events è¡¨æ˜¯å¦è®°å½•äº‹ä»¶
```

### 2. è®¾å¤‡å½’è¿˜æ£€æŸ¥æµ‹è¯•

```bash
# 1. ç¡®ä¿æœ‰ä¸€ä¸ª active çŠ¶æ€çš„è®¢å•
# 2. æ‰§è¡Œå½’è¿˜æ£€æŸ¥
POST /api/equipment/rental/return/check

# 3. éªŒè¯ rental_records è¡¨çŠ¶æ€æ˜¯å¦æ­£ç¡®
```

### 3. é€¾æœŸè´¦æœŸæ£€æµ‹æµ‹è¯•

```bash
# 1. å…ˆæ¨¡æ‹Ÿè¿è¡Œï¼ŒæŸ¥çœ‹æœ‰å¤šå°‘è´¦æœŸéœ€è¦æ ‡è®°
GET /api/cron/check-overdue-billing?dry_run=true

# 2. å®é™…æ‰§è¡Œæ ‡è®°
POST /api/cron/check-overdue-billing

# 3. éªŒè¯ rental_billing_cycles è¡¨çŠ¶æ€æ˜¯å¦æ›´æ–°
```

### 4. é€¾æœŸè´¦æœŸæŸ¥è¯¢æµ‹è¯•

```bash
# 1. æŸ¥è¯¢æ‰€æœ‰é€¾æœŸè´¦æœŸ
GET /api/finance/billing/overdue

# 2. æŸ¥è¯¢é€¾æœŸ30å¤©ä»¥ä¸Šçš„è´¦æœŸ
GET /api/finance/billing/overdue?days=30

# 3. éªŒè¯è¿”å›æ•°æ®æ˜¯å¦æ­£ç¡®
```

### 5. æ¬ æ¬¾ç»Ÿè®¡æµ‹è¯•

```bash
# 1. æŸ¥è¯¢æ€»ä½“ç»Ÿè®¡
GET /api/finance/billing/statistics

# 2. æŸ¥è¯¢ç‰¹å®šé¤å…ç»Ÿè®¡
GET /api/finance/billing/statistics?restaurant_id=xxx

# 3. éªŒè¯ç»Ÿè®¡æ•°æ®æ˜¯å¦æ­£ç¡®
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æƒé™éªŒè¯**ï¼š
   - æ‰€æœ‰APIéƒ½æ”¯æŒå¤šç§Ÿæˆ·éš”ç¦»ï¼ˆ`provider_id` è¿‡æ»¤ï¼‰
   - éœ€è¦è®¤è¯ç”¨æˆ·æ‰èƒ½è®¿é—®

2. **å®šæ—¶ä»»åŠ¡å®‰å…¨**ï¼š
   - å»ºè®®åœ¨å®šæ—¶ä»»åŠ¡APIä¸­æ·»åŠ è®¤è¯TokenéªŒè¯
   - æˆ–ä½¿ç”¨ç¯å¢ƒå˜é‡æ§åˆ¶è®¿é—®æƒé™

3. **èµ”å¿è´¹ç”¨è®¡ç®—**ï¼š
   - å½“å‰ä¸ºç®€å•ä¼°ç®—é€»è¾‘ï¼Œå¯æ ¹æ®å®é™…ä¸šåŠ¡è°ƒæ•´
   - æ”¯æŒæ‰‹åŠ¨æŒ‡å®š `estimated_fee`

4. **æ•°æ®ä¸€è‡´æ€§**ï¼š
   - è®¾å¤‡æŸåä¸ŠæŠ¥å’Œå½’è¿˜æ£€æŸ¥éƒ½ä¼šåˆ›å»º/æ›´æ–° `rental_records` è®°å½•
   - å¦‚æœå·²å­˜åœ¨è®°å½•ï¼Œä¼šæ›´æ–°è€Œä¸æ˜¯é‡å¤åˆ›å»º

---

## ğŸ¯ ä¸‹ä¸€æ­¥

å®Œæˆ P0 çº§åˆ«åï¼Œå»ºè®®ç»§ç»­å®ç°ï¼š

1. **P1 çº§åˆ«**ï¼šæŠ¼é‡‘é€€æ¬¾æµç¨‹ã€å‚¬æ”¶é€šçŸ¥åŠŸèƒ½
2. **é…ç½®å®šæ—¶ä»»åŠ¡**ï¼šå°†é€¾æœŸæ£€æµ‹é…ç½®ä¸ºæ¯å¤©è‡ªåŠ¨æ‰§è¡Œ
3. **å‰ç«¯é›†æˆ**ï¼šåœ¨å‰ç«¯é¡µé¢è°ƒç”¨è¿™äº›APIï¼Œå®Œå–„ç”¨æˆ·ä½“éªŒ

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**å®Œæˆæ—¶é—´**ï¼š2025-01-25  
**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ
