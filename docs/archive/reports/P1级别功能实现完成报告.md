# P1çº§åˆ«åŠŸèƒ½å®ç°å®ŒæˆæŠ¥å‘Š

> å®Œæˆæ—¶é—´ï¼š2025-01-25  
> ä¼˜å…ˆçº§ï¼šP1ï¼ˆè´¢åŠ¡åˆè§„ä¸èµ„äº§å®‰å…¨ï¼‰

---

## âœ… å·²å®ŒæˆåŠŸèƒ½æ¸…å•

### ã€P1-1ã€‘æŠ¼é‡‘é€€æ¬¾æµç¨‹ âœ…

#### æŠ¼é‡‘é€€æ¬¾ API
**è·¯å¾„**ï¼š`POST /api/equipment/rental/deposit/refund`

**åŠŸèƒ½**ï¼š
- æ”¯æŒæ‰‹åŠ¨é€€æ¬¾å’Œè‡ªåŠ¨é€€æ¬¾ï¼ˆæ ¹æ®è®¢å•çŠ¶æ€ï¼‰
- æ›´æ–° `rental_orders.payment_status = 'refunded'`
- è®°å½•é€€æ¬¾é‡‘é¢ã€åŸå› ã€å‡­è¯
- è®°å½•é€€æ¬¾äº‹ä»¶åˆ° `rental_events`

**è¯·æ±‚ä½“**ï¼š
```json
{
  "rental_order_id": "uuid",
  "refund_amount": 1000.00,  // å¯é€‰ï¼Œä¸æä¾›åˆ™ä½¿ç”¨è®¢å•çš„ deposit_amount
  "refund_reason": "è®¢å•å–æ¶ˆ/è®¢å•å®Œæˆ",
  "refund_proof": "é€€æ¬¾å‡­è¯URLï¼ˆå¯é€‰ï¼‰",
  "auto_trigger": false  // å¯é€‰ï¼Œæ˜¯å¦è‡ªåŠ¨è§¦å‘ï¼ˆé»˜è®¤ï¼šfalseï¼‰
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "data": {
    "rental_order_id": "uuid",
    "refund_amount": 1000.00,
    "refund_reason": "è®¢å•å®Œæˆ",
    "refund_at": "2025-01-25T10:00:00Z",
    "order_status": "completed",
    "payment_status": "refunded"
  },
  "message": "æŠ¼é‡‘é€€æ¬¾æˆåŠŸï¼Œé€€æ¬¾é‡‘é¢ï¼š1000 å…ƒ"
}
```

**ä¸šåŠ¡è§„åˆ™**ï¼š
- âœ… åªæœ‰ `completed` æˆ– `cancelled` çŠ¶æ€çš„è®¢å•æ‰èƒ½é€€æ¬¾
- âœ… éªŒè¯è®¢å•æ˜¯å¦å·²é€€æ¬¾ï¼ˆé˜²æ­¢é‡å¤é€€æ¬¾ï¼‰
- âœ… æ”¯æŒå¤šç§Ÿæˆ·éš”ç¦»ï¼ˆ`provider_id` æƒé™éªŒè¯ï¼‰
- âœ… æ”¯æŒè‡ªåŠ¨é€€æ¬¾ï¼ˆ`auto_trigger=true` æ—¶ï¼Œæ ¹æ®è®¢å•çŠ¶æ€åˆ¤æ–­ï¼‰

**é€€æ¬¾é‡‘é¢é€»è¾‘**ï¼š
- å¦‚æœæä¾›äº† `refund_amount`ï¼Œä½¿ç”¨æä¾›çš„é‡‘é¢
- å¦‚æœæ²¡æœ‰æä¾›ï¼Œä½¿ç”¨è®¢å•çš„ `deposit_amount`

---

### ã€P1-3ã€‘é€¾æœŸè´¦æœŸå‚¬æ”¶é€šçŸ¥ âœ…

#### å‚¬æ”¶é€šçŸ¥ API
**è·¯å¾„**ï¼š`POST /api/finance/collection/notify`

**åŠŸèƒ½**ï¼š
- æ”¯æŒæŒ‰è®¢å•æˆ–è´¦æœŸå‘é€å‚¬æ”¶é€šçŸ¥
- æ”¯æŒå¤šç§é€šçŸ¥æ–¹å¼ï¼ˆçŸ­ä¿¡/é‚®ä»¶/ç”µè¯/ç«™å†…ä¿¡ï¼‰
- è‡ªåŠ¨ç”Ÿæˆå‚¬æ”¶æ¶ˆæ¯æ¨¡æ¿
- è®°å½•å‚¬æ”¶å†å²åˆ° `rental_events`

**è¯·æ±‚ä½“**ï¼š
```json
{
  "rental_order_id": "uuid",  // å¯é€‰ï¼Œä¸ billing_cycle_id äºŒé€‰ä¸€
  "billing_cycle_id": "uuid",  // å¯é€‰ï¼ŒæŒ‡å®šè´¦æœŸ
  "notification_type": "sms" | "email" | "phone" | "in_app",
  "message": "å‚¬æ”¶æ¶ˆæ¯å†…å®¹ï¼ˆå¯é€‰ï¼Œä¸æä¾›åˆ™ä½¿ç”¨é»˜è®¤æ¨¡æ¿ï¼‰",
  "recipient_phone": "13800138000",  // å¯é€‰
  "recipient_email": "user@example.com"  // å¯é€‰
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "data": {
    "rental_order_id": "uuid",
    "billing_cycle_id": "uuid",
    "notification_type": "sms",
    "message": "ã€ç§Ÿèµè´¦æœŸå‚¬æ”¶é€šçŸ¥ã€‘\nè®¢å•å·ï¼šRENT123456\n...",
    "recipient_phone": "13800138000",
    "sent_at": "2025-01-25T10:00:00Z"
  },
  "message": "å‚¬æ”¶é€šçŸ¥å·²å‘é€ï¼ˆç±»å‹ï¼šsmsï¼‰",
  "note": "æ³¨æ„ï¼šå½“å‰ç‰ˆæœ¬ä»…è®°å½•é€šçŸ¥ï¼Œå®é™…å‘é€åŠŸèƒ½éœ€è¦é›†æˆç¬¬ä¸‰æ–¹æœåŠ¡"
}
```

**é»˜è®¤å‚¬æ”¶æ¶ˆæ¯æ¨¡æ¿**ï¼š
```
ã€ç§Ÿèµè´¦æœŸå‚¬æ”¶é€šçŸ¥ã€‘
è®¢å•å·ï¼šRENT123456
è´¦æœŸæœˆä»½ï¼š2025-01
é€¾æœŸå¤©æ•°ï¼š10 å¤©
é€¾æœŸé‡‘é¢ï¼š1000.00 å…ƒ
è¯·å°½å¿«æ”¯ä»˜ï¼Œæ„Ÿè°¢é…åˆï¼
```

**ä¸šåŠ¡è§„åˆ™**ï¼š
- âœ… æ”¯æŒæŒ‰è®¢å•å‘é€ï¼ˆé’ˆå¯¹è¯¥è®¢å•çš„æ‰€æœ‰é€¾æœŸè´¦æœŸï¼‰
- âœ… æ”¯æŒæŒ‰è´¦æœŸå‘é€ï¼ˆé’ˆå¯¹æŒ‡å®šè´¦æœŸï¼‰
- âœ… è‡ªåŠ¨ä»è®¢å•è·å–æ”¶ä»¶äººç”µè¯/é‚®ç®±
- âœ… æ”¯æŒå¤šç§Ÿæˆ·éš”ç¦»

**æ³¨æ„äº‹é¡¹**ï¼š
- âš ï¸ å½“å‰ç‰ˆæœ¬ä»…è®°å½•é€šçŸ¥åˆ° `rental_events`ï¼Œå®é™…å‘é€éœ€è¦é›†æˆç¬¬ä¸‰æ–¹æœåŠ¡
- âš ï¸ éœ€è¦é…ç½®çŸ­ä¿¡/é‚®ä»¶/ç”µè¯æœåŠ¡æ‰èƒ½å®é™…å‘é€é€šçŸ¥

---

## ğŸ“‹ API ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šæŠ¼é‡‘é€€æ¬¾ï¼ˆæ‰‹åŠ¨ï¼‰

```bash
curl -X POST http://localhost:3000/api/equipment/rental/deposit/refund \
  -H "Content-Type: application/json" \
  -d '{
    "rental_order_id": "xxx",
    "refund_amount": 1000.00,
    "refund_reason": "è®¢å•å®Œæˆï¼Œè®¾å¤‡å®Œå¥½",
    "refund_proof": "https://..."
  }'
```

### ç¤ºä¾‹ 2ï¼šæŠ¼é‡‘é€€æ¬¾ï¼ˆè‡ªåŠ¨è§¦å‘ï¼‰

```bash
curl -X POST http://localhost:3000/api/equipment/rental/deposit/refund \
  -H "Content-Type: application/json" \
  -d '{
    "rental_order_id": "xxx",
    "auto_trigger": true
  }'
```

### ç¤ºä¾‹ 3ï¼šå‘é€å‚¬æ”¶é€šçŸ¥ï¼ˆçŸ­ä¿¡ï¼‰

```bash
curl -X POST http://localhost:3000/api/finance/collection/notify \
  -H "Content-Type: application/json" \
  -d '{
    "rental_order_id": "xxx",
    "notification_type": "sms",
    "recipient_phone": "13800138000"
  }'
```

### ç¤ºä¾‹ 4ï¼šå‘é€å‚¬æ”¶é€šçŸ¥ï¼ˆæŒ‡å®šè´¦æœŸï¼‰

```bash
curl -X POST http://localhost:3000/api/finance/collection/notify \
  -H "Content-Type: application/json" \
  -d '{
    "billing_cycle_id": "xxx",
    "notification_type": "email",
    "message": "è‡ªå®šä¹‰å‚¬æ”¶æ¶ˆæ¯"
  }'
```

---

## ğŸ“Š æ•°æ®è¡¨å˜æ›´

### rental_orders è¡¨ä½¿ç”¨

**å­—æ®µ**ï¼š
- `payment_status`: æ›´æ–°ä¸º `'refunded'`ï¼ˆæŠ¼é‡‘é€€æ¬¾æ—¶ï¼‰

### rental_events è¡¨è®°å½•

**æ–°å¢äº‹ä»¶ç±»å‹**ï¼š
- `deposit_refunded`: æŠ¼é‡‘é€€æ¬¾
- `collection_notification_sent`: å‚¬æ”¶é€šçŸ¥å‘é€

---

## ğŸ”„ ä¸ç°æœ‰åŠŸèƒ½çš„é›†æˆ

### è‡ªåŠ¨é€€æ¬¾è§¦å‘å»ºè®®

å¯ä»¥åœ¨è®¢å•çŠ¶æ€æ›´æ–°æ—¶è‡ªåŠ¨è§¦å‘é€€æ¬¾ï¼š

1. **è®¢å•å®Œæˆæ—¶è‡ªåŠ¨é€€æ¬¾**ï¼ˆå¦‚æœè®¾å¤‡å®Œå¥½ï¼‰ï¼š
   ```typescript
   // åœ¨ app/api/equipment/rental/update/route.ts ä¸­
   if (order_status === 'completed') {
     // æ£€æŸ¥è®¾å¤‡çŠ¶æ€ï¼ˆé€šè¿‡ rental_records è¡¨ï¼‰
     // å¦‚æœè®¾å¤‡å®Œå¥½ï¼Œè‡ªåŠ¨è°ƒç”¨æŠ¼é‡‘é€€æ¬¾API
     await fetch('/api/equipment/rental/deposit/refund', {
       method: 'POST',
       body: JSON.stringify({
         rental_order_id: id,
         auto_trigger: true,
         refund_reason: 'è®¢å•å®Œæˆï¼Œè®¾å¤‡å®Œå¥½'
       })
     })
   }
   ```

2. **è®¢å•å–æ¶ˆæ—¶è‡ªåŠ¨é€€æ¬¾**ï¼š
   ```typescript
   if (order_status === 'cancelled') {
     await fetch('/api/equipment/rental/deposit/refund', {
       method: 'POST',
       body: JSON.stringify({
         rental_order_id: id,
         auto_trigger: true,
         refund_reason: 'è®¢å•å–æ¶ˆ'
       })
     })
   }
   ```

### è‡ªåŠ¨å‚¬æ”¶å»ºè®®

å¯ä»¥ç»“åˆé€¾æœŸæ£€æµ‹å®šæ—¶ä»»åŠ¡ï¼Œè‡ªåŠ¨å‘é€å‚¬æ”¶é€šçŸ¥ï¼š

```typescript
// åœ¨é€¾æœŸæ£€æµ‹å®šæ—¶ä»»åŠ¡åï¼Œè‡ªåŠ¨å‘é€å‚¬æ”¶é€šçŸ¥
const overdueCycles = await getOverdueBillingCycles()

for (const cycle of overdueCycles) {
  // æ ¹æ®é€¾æœŸå¤©æ•°å†³å®šå‚¬æ”¶æ–¹å¼
  const overdueDays = calculateOverdueDays(cycle.due_date)
  
  if (overdueDays <= 7) {
    // é€¾æœŸ7å¤©å†…ï¼šå‘é€ç«™å†…ä¿¡
    await sendCollectionNotification(cycle, 'in_app')
  } else if (overdueDays <= 30) {
    // é€¾æœŸ30å¤©å†…ï¼šå‘é€çŸ­ä¿¡
    await sendCollectionNotification(cycle, 'sms')
  } else {
    // é€¾æœŸ30å¤©ä»¥ä¸Šï¼šå‘é€é‚®ä»¶+ç”µè¯
    await sendCollectionNotification(cycle, 'email')
    await sendCollectionNotification(cycle, 'phone')
  }
}
```

---

## âš ï¸ å¾…å®Œå–„åŠŸèƒ½

### 1. å®é™…é€šçŸ¥å‘é€é›†æˆ

**å½“å‰çŠ¶æ€**ï¼š
- âœ… API å·²åˆ›å»ºï¼Œå¯ä»¥è®°å½•é€šçŸ¥
- âŒ å®é™…å‘é€åŠŸèƒ½éœ€è¦é›†æˆç¬¬ä¸‰æ–¹æœåŠ¡

**å»ºè®®é›†æˆ**ï¼š
- **çŸ­ä¿¡æœåŠ¡**ï¼šé˜¿é‡Œäº‘çŸ­ä¿¡ã€è…¾è®¯äº‘çŸ­ä¿¡
- **é‚®ä»¶æœåŠ¡**ï¼šSendGridã€é˜¿é‡Œäº‘é‚®ä»¶æ¨é€
- **ç”µè¯æœåŠ¡**ï¼šé˜¿é‡Œäº‘è¯­éŸ³é€šçŸ¥ã€è…¾è®¯äº‘è¯­éŸ³é€šçŸ¥

**ç¤ºä¾‹é›†æˆä»£ç **ï¼ˆä¼ªä»£ç ï¼‰ï¼š
```typescript
// åœ¨ app/api/finance/collection/notify/route.ts ä¸­
if (notification_type === 'sms') {
  // é›†æˆçŸ­ä¿¡æœåŠ¡
  // await sendSMS(finalPhone, finalMessage)
}

if (notification_type === 'email') {
  // é›†æˆé‚®ä»¶æœåŠ¡
  // await sendEmail(finalEmail, 'ç§Ÿèµè´¦æœŸå‚¬æ”¶é€šçŸ¥', finalMessage)
}

if (notification_type === 'phone') {
  // é›†æˆè¯­éŸ³é€šçŸ¥æœåŠ¡
  // await makePhoneCall(finalPhone, finalMessage)
}
```

---

## âœ… æµ‹è¯•å»ºè®®

### 1. æŠ¼é‡‘é€€æ¬¾æµ‹è¯•

```bash
# 1. åˆ›å»ºä¸€ä¸ªè®¢å•ï¼ˆorder_status = 'active'ï¼‰
# 2. å°†è®¢å•çŠ¶æ€æ›´æ–°ä¸º 'completed'
# 3. è°ƒç”¨æŠ¼é‡‘é€€æ¬¾API
POST /api/equipment/rental/deposit/refund

# 4. éªŒè¯ rental_orders.payment_status æ˜¯å¦ä¸º 'refunded'
# 5. éªŒè¯ rental_events è¡¨æ˜¯å¦è®°å½•äº‹ä»¶
```

### 2. å‚¬æ”¶é€šçŸ¥æµ‹è¯•

```bash
# 1. ç¡®ä¿æœ‰é€¾æœŸè´¦æœŸï¼ˆstatus = 'overdue'ï¼‰
# 2. å‘é€å‚¬æ”¶é€šçŸ¥
POST /api/finance/collection/notify

# 3. éªŒè¯ rental_events è¡¨æ˜¯å¦è®°å½•äº‹ä»¶
# 4. éªŒè¯é€šçŸ¥æ¶ˆæ¯å†…å®¹æ˜¯å¦æ­£ç¡®
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æƒé™éªŒè¯**ï¼š
   - æ‰€æœ‰APIéƒ½æ”¯æŒå¤šç§Ÿæˆ·éš”ç¦»ï¼ˆ`provider_id` è¿‡æ»¤ï¼‰
   - éœ€è¦è®¤è¯ç”¨æˆ·æ‰èƒ½è®¿é—®

2. **é€€æ¬¾é‡‘é¢**ï¼š
   - å¦‚æœæ²¡æœ‰æä¾› `refund_amount`ï¼Œä½¿ç”¨è®¢å•çš„ `deposit_amount`
   - æ”¯æŒéƒ¨åˆ†é€€æ¬¾ï¼ˆæä¾›å°äº `deposit_amount` çš„é€€æ¬¾é‡‘é¢ï¼‰

3. **é€šçŸ¥å‘é€**ï¼š
   - å½“å‰ç‰ˆæœ¬ä»…è®°å½•é€šçŸ¥ï¼Œä¸å®é™…å‘é€
   - éœ€è¦é›†æˆç¬¬ä¸‰æ–¹æœåŠ¡æ‰èƒ½å®é™…å‘é€

4. **è‡ªåŠ¨é€€æ¬¾**ï¼š
   - `auto_trigger=true` æ—¶ï¼Œä¼šæ ¹æ®è®¢å•çŠ¶æ€è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦é€€æ¬¾
   - å»ºè®®åœ¨è®¢å•çŠ¶æ€æ›´æ–°æ—¶è°ƒç”¨ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨è°ƒç”¨

---

## ğŸ¯ ä¸‹ä¸€æ­¥

å®Œæˆ P1 çº§åˆ«åï¼Œå»ºè®®ï¼š

1. **é›†æˆé€šçŸ¥æœåŠ¡**ï¼šé›†æˆçŸ­ä¿¡/é‚®ä»¶/ç”µè¯æœåŠ¡ï¼Œå®ç°å®é™…å‘é€
2. **è‡ªåŠ¨åŒ–æµç¨‹**ï¼šåœ¨è®¢å•å®Œæˆ/å–æ¶ˆæ—¶è‡ªåŠ¨è§¦å‘é€€æ¬¾
3. **å‰ç«¯é›†æˆ**ï¼šåœ¨å‰ç«¯é¡µé¢æ·»åŠ é€€æ¬¾å’Œå‚¬æ”¶åŠŸèƒ½
4. **ç»§ç»­P2çº§åˆ«**ï¼šå®ç°è®¾å¤‡æœªå½’è¿˜è‡ªåŠ¨æ£€æµ‹ç­‰åŠŸèƒ½

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**å®Œæˆæ—¶é—´**ï¼š2025-01-25  
**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ
