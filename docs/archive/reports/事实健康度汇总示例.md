# 事实健康度汇总示例

## 概述

本文档展示了事实健康度汇总功能的完整示例响应，包含 2 个 high、1 个 medium、1 个 low 级别的警告。

## 健康度计算规则

- **起始分**: 100
- **每个 high 扣**: 30
- **每个 medium 扣**: 10
- **每个 low 扣**: 3
- **最低分**: 0

### 本示例计算

- 起始分: 100
- 2 个 high: -30 × 2 = -60
- 1 个 medium: -10 × 1 = -10
- 1 个 low: -3 × 1 = -3
- **最终健康度分数**: 100 - 60 - 10 - 3 = **27**

## 完整示例响应 JSON

### API 端点
`GET /api/facts/orders/:order_id`

### 响应示例（包含 2 high + 1 medium + 1 low）

```json
{
  "success": true,
  "order": {
    "order_id": "order-123",
    "restaurant_id": "restaurant-456",
    "status": "completed",
    "created_at": "2025-01-20T10:00:00Z",
    "accepted_at": "2025-01-20T10:05:00Z",
    "completed_at": "2025-01-20T09:30:00Z",
    "worker_id": "worker-789"
  },
  "assets": [
    {
      "asset_id": "asset-001",
      "status": "delivered",
      "last_action": "ASSET_DELIVERED",
      "last_action_at": "2025-01-20T11:00:00Z"
    }
  ],
  "traces": [
    {
      "id": "trace-001",
      "asset_id": "asset-001",
      "action_type": "ASSET_DELIVERED",
      "operator_id": "operator-001",
      "order_id": "order-123",
      "created_at": "2025-01-20T09:45:00Z"
    },
    {
      "id": "trace-002",
      "asset_id": "asset-001",
      "action_type": "UNKNOWN_ACTION",
      "operator_id": "operator-002",
      "order_id": "order-123",
      "created_at": "2025-01-20T10:30:00Z"
    }
  ],
  "fact_warnings": [
    "违反事实契约：order.completed_at（2025-01-20T09:30:00Z）早于 order.created_at（2025-01-20T10:00:00Z）。时间逻辑异常。",
    "违反事实契约：traces[0].created_at（2025-01-20T09:45:00Z）早于 order.created_at（2025-01-20T10:00:00Z），但该追溯记录关联了当前订单（order_id=order-123）。时间线断裂。",
    "违反事实契约：traces[1].action_type（UNKNOWN_ACTION）不在允许的枚举值内。允许的值：ASSET_CREATED, ASSET_FILLED, ASSET_DELIVERED, ASSET_RETURNED, ASSET_INSPECTED。",
    "时间线异常（可能合理）：traces[2].created_at（2025-01-20T09:20:00Z）早于 order.created_at（2025-01-20T10:00:00Z），但该追溯记录未关联当前订单（order_id=null）。可能是订单创建前的资产操作。"
  ],
  "fact_warnings_human": [
    "违反事实契约：order.completed_at（2025-01-20T09:30:00Z）早于 order.created_at（2025-01-20T10:00:00Z）。时间逻辑异常。",
    "违反事实契约：traces[0].created_at（2025-01-20T09:45:00Z）早于 order.created_at（2025-01-20T10:00:00Z），但该追溯记录关联了当前订单（order_id=order-123）。时间线断裂。",
    "违反事实契约：traces[1].action_type（UNKNOWN_ACTION）不在允许的枚举值内。允许的值：ASSET_CREATED, ASSET_FILLED, ASSET_DELIVERED, ASSET_RETURNED, ASSET_INSPECTED。",
    "时间线异常（可能合理）：traces[2].created_at（2025-01-20T09:20:00Z）早于 order.created_at（2025-01-20T10:00:00Z），但该追溯记录未关联当前订单（order_id=null）。可能是订单创建前的资产操作。"
  ],
  "fact_warnings_structured": [
    {
      "code": "FACT_TIME_INVERSION",
      "level": "high",
      "domain": "order",
      "message": "违反事实契约：order.completed_at（2025-01-20T09:30:00Z）早于 order.created_at（2025-01-20T10:00:00Z）。时间逻辑异常。",
      "fields": [
        "order.completed_at",
        "order.created_at"
      ],
      "evidence": {
        "order_id": "order-123",
        "created_at": "2025-01-20T10:00:00Z",
        "completed_at": "2025-01-20T09:30:00Z",
        "time_diff_ms": -1800000
      }
    },
    {
      "code": "FACT_TIMELINE_BREAK",
      "level": "high",
      "domain": "trace",
      "message": "违反事实契约：traces[0].created_at（2025-01-20T09:45:00Z）早于 order.created_at（2025-01-20T10:00:00Z），但该追溯记录关联了当前订单（order_id=order-123）。时间线断裂。",
      "fields": [
        "traces[0].created_at",
        "order.created_at",
        "traces[0].order_id"
      ],
      "evidence": {
        "trace_id": "trace-001",
        "trace_index": 0,
        "trace_created_at": "2025-01-20T09:45:00Z",
        "trace_order_id": "order-123",
        "order_id": "order-123",
        "order_created_at": "2025-01-20T10:00:00Z",
        "time_diff_ms": -900000
      }
    },
    {
      "code": "FACT_ENUM_VALUE_INVALID",
      "level": "medium",
      "domain": "trace",
      "message": "违反事实契约：traces[1].action_type（UNKNOWN_ACTION）不在允许的枚举值内。允许的值：ASSET_CREATED, ASSET_FILLED, ASSET_DELIVERED, ASSET_RETURNED, ASSET_INSPECTED。",
      "fields": [
        "traces[1].action_type"
      ],
      "evidence": {
        "trace_id": "trace-002",
        "trace_index": 1,
        "invalid_action_type": "UNKNOWN_ACTION",
        "allowed_action_types": [
          "ASSET_CREATED",
          "ASSET_FILLED",
          "ASSET_DELIVERED",
          "ASSET_RETURNED",
          "ASSET_INSPECTED"
        ]
      }
    },
    {
      "code": "FACT_TIMELINE_ANOMALY",
      "level": "low",
      "domain": "trace",
      "message": "时间线异常（可能合理）：traces[2].created_at（2025-01-20T09:20:00Z）早于 order.created_at（2025-01-20T10:00:00Z），但该追溯记录未关联当前订单（order_id=null）。可能是订单创建前的资产操作。",
      "fields": [
        "traces[2].created_at",
        "order.created_at",
        "traces[2].order_id"
      ],
      "evidence": {
        "trace_id": "trace-003",
        "trace_index": 2,
        "trace_created_at": "2025-01-20T09:20:00Z",
        "trace_order_id": null,
        "order_id": "order-123",
        "order_created_at": "2025-01-20T10:00:00Z",
        "time_diff_ms": -2400000
      }
    }
  ],
  "fact_health": {
    "score": 27,
    "summary": {
      "high": 2,
      "medium": 1,
      "low": 1
    }
  }
}
```

## 警告明细说明

### 1. FACT_TIME_INVERSION (high)
- **级别**: high
- **领域**: order
- **问题**: 订单完成时间早于创建时间
- **扣分**: -30

### 2. FACT_TIMELINE_BREAK (high)
- **级别**: high
- **领域**: trace
- **问题**: 追溯记录创建时间早于订单创建时间，但追溯记录关联了该订单
- **扣分**: -30

### 3. FACT_ENUM_VALUE_INVALID (medium)
- **级别**: medium
- **领域**: trace
- **问题**: 追溯记录的操作类型不在允许的枚举值内
- **扣分**: -10

### 4. FACT_TIMELINE_ANOMALY (low)
- **级别**: low
- **领域**: trace
- **问题**: 追溯记录创建时间早于订单创建时间，但追溯记录未关联该订单（可能是订单创建前的资产操作，这是合理的）
- **扣分**: -3

## 健康度汇总详细说明

### fact_health 字段

```json
{
  "score": 27,
  "summary": {
    "high": 2,
    "medium": 1,
    "low": 1
  }
}
```

- **score**: 27（健康度分数，0-100）
  - 计算过程：100 - (2 × 30) - (1 × 10) - (1 × 3) = 27
- **summary.high**: 2（高级别警告数量）
- **summary.medium**: 1（中级别警告数量）
- **summary.low**: 1（低级别警告数量）

## 使用场景

### 1. 健康度可视化
```typescript
const healthScore = response.fact_health.score
const healthColor = healthScore >= 80 ? 'green' : healthScore >= 60 ? 'yellow' : 'red'

// 显示健康度仪表盘
<HealthDashboard 
  score={healthScore}
  high={response.fact_health.summary.high}
  medium={response.fact_health.summary.medium}
  low={response.fact_health.summary.low}
/>
```

### 2. 自动修复优先级
```typescript
// 根据健康度分数决定修复优先级
if (response.fact_health.score < 50) {
  // 健康度低于 50，优先修复
  await scheduleAutoFix(response.fact_warnings_structured)
}
```

### 3. 治理列表排序
```typescript
// 按健康度分数排序订单列表
orders.sort((a, b) => a.fact_health.score - b.fact_health.score)
```

## 实现细节

### calculateFactHealth 函数

```typescript
export function calculateFactHealth(warnings: FactWarning[]): FactHealthSummary {
  const summary: FactHealthSummary = {
    total: warnings.length,
    by_level: { high: 0, medium: 0, low: 0 },
    by_code: {},
    health_score: 100,
  }

  warnings.forEach((warning) => {
    // 按级别统计
    summary.by_level[warning.level]++
    
    // 按代码统计
    summary.by_code[warning.code] = (summary.by_code[warning.code] || 0) + 1
  })

  // 计算健康度分数
  let score = 100
  score -= summary.by_level.high * 30
  score -= summary.by_level.medium * 10
  score -= summary.by_level.low * 3
  summary.health_score = Math.max(0, score)

  return summary
}
```

## 完成状态

✅ 已创建 `FactHealthSummary` 类型定义  
✅ 已实现 `calculateFactHealth` 纯只读聚合函数  
✅ 已在 API 路由中集成健康度汇总  
✅ 已创建包含 2 high + 1 medium + 1 low 的完整示例响应 JSON  
✅ 保证不改变任何已有返回字段  
✅ 保证不引入数据库写操作  
✅ 保证不引入 UI

**所有任务已完成！**
