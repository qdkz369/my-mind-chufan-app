# 事实校验逻辑检查报告

## 检查结果

### ✅ 已确认：API 已调用事实校验逻辑

**文件**: `app/api/facts/orders/[order_id]/route.ts`

**调用位置**:
1. **第 321 行**: 调用 `OrderFactGuard()` 进行事实治理检查
2. **第 331 行**: 调用 `calculateFactHealth()` 计算健康度汇总

### 问题分析

从验证脚本的输出看，API 返回中没有 `fact_warnings_structured`，健康度分数是 100。这说明虽然调用了 `OrderFactGuard`，但没有检测到警告。

**根本原因**:
- `OrderFactGuard` 只检查最终提取的 `order.completed_at` 和 `order.accepted_at` 是否早于 `order.created_at`
- 但是 API 在提取这些值时，会遍历所有 audit_logs，**后找到的正常记录会覆盖先找到的异常记录**
- 例如：如果 audit_logs 中有：
  - ORDER_COMPLETED（时间异常：早于订单创建时间）
  - ORDER_COMPLETE（正常时间：晚于订单创建时间）
  - 最终 `order.completed_at` 会是 ORDER_COMPLETE 的时间，而不是 ORDER_COMPLETED 的时间
  - 因此 `OrderFactGuard` 检查 `order.completed_at` 时，不会发现时间异常

## 修复方案

### 增强 OrderFactGuard 逻辑

在 `lib/facts/governance/order.fact.guard.ts` 中，新增了两个检查：

1. **检查 2b**: 检查 audit_logs 中所有 ORDER_COMPLETED/ORDER_COMPLETE 记录的时间异常
2. **检查 2c**: 检查 audit_logs 中所有 ORDER_ACCEPTED/ORDER_ACCEPT 记录的时间异常

这样，即使异常记录没有被提取到 `order.completed_at` 或 `order.accepted_at`，也能被检测到。

## 修复后的代码

### 关键修改（lib/facts/governance/order.fact.guard.ts）

```typescript
// ========== 检查 2b：audit_logs 中 ORDER_COMPLETED/ORDER_COMPLETE 记录时间异常 ==========
if (order.created_at) {
  const orderCreatedTime = new Date(order.created_at).getTime()
  
  audit_logs.forEach((log, index) => {
    const actionUpper = log.action?.toUpperCase() || ""
    if (actionUpper === "ORDER_COMPLETED" || actionUpper === "ORDER_COMPLETE") {
      const logCreatedTime = new Date(log.created_at).getTime()
      
      if (logCreatedTime < orderCreatedTime) {
        // 生成警告...
      }
    }
  })
}

// ========== 检查 2c：audit_logs 中 ORDER_ACCEPTED/ORDER_ACCEPT 记录时间异常 ==========
if (order.created_at) {
  const orderCreatedTime = new Date(order.created_at).getTime()
  
  audit_logs.forEach((log, index) => {
    const actionUpper = log.action?.toUpperCase() || ""
    if (actionUpper === "ORDER_ACCEPTED" || actionUpper === "ORDER_ACCEPT") {
      const logCreatedTime = new Date(log.created_at).getTime()
      
      if (logCreatedTime < orderCreatedTime) {
        // 生成警告...
      }
    }
  })
}
```

## 验证预期

修复后，验证脚本应该能够检测到：

1. **FACT_TIME_INVERSION** (high)
   - 来自：ORDER_COMPLETED 记录（时间异常）
   - 关联的 audit_logs 记录：ORDER_COMPLETED（2026-01-12T05:19:36.471Z）

2. **FACT_TIMELINE_BREAK** (high)
   - 来自：ORDER_ACCEPTED 记录（时间异常）
   - 关联的 audit_logs 记录：ORDER_ACCEPTED（2026-01-12T05:39:36.471Z）

### 预期健康度分数

- 2 个 high 警告：100 - (2 × 30) = **40**

## 完成状态

✅ 已确认 API 调用了事实校验逻辑  
✅ 已增强 OrderFactGuard 以检查 audit_logs 中所有相关记录  
✅ 不修改数据库结构  
✅ 不引入 UI  
✅ 不改变已有返回字段  
✅ 如果没有异常，显式返回空 warnings + health=100

**修复已完成！**
