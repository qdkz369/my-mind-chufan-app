# 事实治理层可用性验证报告

## 验证目标

验证 Fact Governance Layer 是否真实生效（而非静态代码），通过实际调用 API 并构造"事实不一致"场景来测试。

---

## 验证步骤与结果

### 步骤 1：找到真实订单

✅ **成功找到测试订单**

- **Order ID**: `a9fb9c2f-5d40-4d47-a951-9f9a70b27bbc`
- **Restaurant ID**: `4481f1d6-dda4-460b-a380-69d80f2ea876`
- **状态**: `pending`
- **创建时间**: `2026-01-09T11:52:57.333+00:00`

---

### 步骤 2：构造"事实不一致"场景

✅ **成功构造 2 种不一致场景**

#### 场景 2b: completed_at 早于 created_at

- **order.created_at**: `2026-01-09T11:52:57.333+00:00`
- **构造的 completed_at**: `2026-01-08T11:52:57.333Z`（早于创建时间 24 小时）
- **操作**: 在 `audit_logs` 中插入一条 `ORDER_COMPLETED` 记录，其 `created_at` 早于订单创建时间
- **测试记录 ID**: `6c6f84be-2334-4ddb-90b8-b96992c6c88f`

#### 场景 2c: trace.action_type 不在允许枚举内

- **操作**: 在 `trace_logs` 中插入一条记录，`action_type = 'INVALID_ACTION'`（不在允许的枚举值内）
- **测试记录 ID**: `b3dc3a68-b45e-4039-979b-ebb862b4c737`
- **允许的枚举值**: `ASSET_CREATED`, `ASSET_FILLED`, `ASSET_DELIVERED`, `ASSET_RETURNED`, `ASSET_INSPECTED`

---

### 步骤 3：调用 API

✅ **API 调用成功**

- **请求 URL**: `GET http://localhost:3000/api/facts/orders/a9fb9c2f-5d40-4d47-a951-9f9a70b27bbc`
- **请求头**: `x-restaurant-id: 4481f1d6-dda4-460b-a380-69d80f2ea876`
- **HTTP 状态码**: `200 OK`

---

### 步骤 4：完整 JSON 响应

```json
{
  "success": true,
  "order": {
    "order_id": "a9fb9c2f-5d40-4d47-a951-9f9a70b27bbc",
    "restaurant_id": "4481f1d6-dda4-460b-a380-69d80f2ea876",
    "status": "pending",
    "created_at": "2026-01-09T11:52:57.333+00:00",
    "worker_id": null,
    "accepted_at": null,
    "completed_at": "2026-01-08T11:52:57.333+00:00"
  },
  "assets": [],
  "traces": [
    {
      "id": "b3dc3a68-b45e-4039-979b-ebb862b4c737",
      "asset_id": "00000000-0000-0000-0000-000000000001",
      "action_type": "INVALID_ACTION",
      "operator_id": null,
      "order_id": "a9fb9c2f-5d40-4d47-a951-9f9a70b27bbc",
      "created_at": "2026-01-11T17:40:32.71+00:00"
    }
  ],
  "fact_warnings": [
    "违反事实契约：order.completed_at（2026-01-08T11:52:57.333+00:00）早于 order.created_at（2026-01-09T11:52:57.333+00:00）。时间逻辑异常。",
    "违反事实契约：traces[0].action_type（INVALID_ACTION）不在允许的枚举值内。允许的值：ASSET_CREATED, ASSET_FILLED, ASSET_DELIVERED, ASSET_RETURNED, ASSET_INSPECTED。"
  ]
}
```

---

### 步骤 5：验证 fact_warnings

✅ **fact_warnings 成功出现**

- **fact_warnings 是否存在**: ✅ 是
- **fact_warnings 数量**: `2`
- **警告内容**:

  1. **警告 1（场景 2b）**:
     ```
     违反事实契约：order.completed_at（2026-01-08T11:52:57.333+00:00）早于 order.created_at（2026-01-09T11:52:57.333+00:00）。时间逻辑异常。
     ```
     - ✅ 与构造场景 2b 完全对应
     - ✅ 正确识别了时间逻辑异常

  2. **警告 2（场景 2c）**:
     ```
     违反事实契约：traces[0].action_type（INVALID_ACTION）不在允许的枚举值内。允许的值：ASSET_CREATED, ASSET_FILLED, ASSET_DELIVERED, ASSET_RETURNED, ASSET_INSPECTED。
     ```
     - ✅ 与构造场景 2c 完全对应
     - ✅ 正确识别了枚举值异常
     - ✅ 列出了所有允许的枚举值

---

### 步骤 6：验证数据完整性

✅ **数据正常返回**

- **order 是否存在**: ✅ 是
  - `order.order_id`: `a9fb9c2f-5d40-4d47-a951-9f9a70b27bbc`
  - `order.status`: `pending`
  - `order.created_at`: `2026-01-09T11:52:57.333+00:00`
  - `order.completed_at`: `2026-01-08T11:52:57.333+00:00`（异常值，但正常返回）
- **assets 是否存在**: ✅ 是（空数组 `[]`）
- **traces 是否存在**: ✅ 是（包含 1 条记录，包含异常 `action_type`）

---

## 验证结果总结

### ✅ 所有验证项通过

| 验证项 | 结果 | 说明 |
|--------|------|------|
| **API 响应正常 (200)** | ✅ 是 | HTTP 状态码 200，无 4xx/5xx 错误 |
| **fact_warnings 出现** | ✅ 是 | 成功返回 2 个警告 |
| **警告与构造场景对应** | ✅ 是 | 2 个警告与 2 个构造场景一一对应 |
| **数据正常返回** | ✅ 是 | order、assets、traces 均正常返回 |

### 🎉 事实治理层验证通过！

---

## 关键发现

### 1. 治理层成功暴露异常事实

- ✅ 成功检测到 `completed_at` 早于 `created_at` 的时间逻辑异常
- ✅ 成功检测到 `action_type` 不在允许枚举内的枚举值异常
- ✅ 所有异常都通过 `fact_warnings` 显性暴露

### 2. API 不阻断响应

- ✅ 即使存在事实不一致，API 仍然返回 `200 OK`
- ✅ 所有数据（order、assets、traces）正常返回
- ✅ 异常事实通过 `fact_warnings` 告知调用方，但不阻止展示

### 3. 警告信息清晰

- ✅ 每个警告都明确描述了违反的事实契约
- ✅ 警告包含具体的字段值和时间戳
- ✅ 警告包含允许的枚举值列表（对于枚举值异常）

---

## 清理测试数据

测试完成后，请手动清理以下测试数据：

### 1. 删除 audit_logs 测试记录

```sql
DELETE FROM audit_logs WHERE id = '6c6f84be-2334-4ddb-90b8-b96992c6c88f';
```

### 2. 删除 trace_logs 测试记录

```sql
DELETE FROM trace_logs WHERE id = 'b3dc3a68-b45e-4039-979b-ebb862b4c737';
```

---

## 结论

**事实治理层（Fact Governance Layer）已成功实现并生效！**

- ✅ 能够检测并暴露事实不一致
- ✅ 不阻断 API 响应
- ✅ 通过 `fact_warnings` 显性告知调用方
- ✅ 所有数据正常返回，支持 UI 层展示

**验证完成时间**: 2026-01-11
