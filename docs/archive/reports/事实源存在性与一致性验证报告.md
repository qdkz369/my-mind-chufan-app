# 事实源存在性与一致性验证报告

## 验证时间：2025-01-20

---

## 1. 三张表是否都被当前 API 实际查询

### ✅ delivery_orders 表

**查询位置：**
- `app/api/facts/orders/[order_id]/route.ts` 第 52-56 行
- `app/api/facts/restaurant/[restaurant_id]/overview/route.ts` 第 63-66 行、第 77-80 行、第 108-113 行
- `app/api/facts/restaurant/[restaurant_id]/latest-order/route.ts` 第 53-58 行

**查询语句：**
```typescript
// 订单事实 API
.from("delivery_orders")
.select("id, restaurant_id, status, created_at, updated_at, worker_id")
.eq("id", order_id)
.single()

// 餐厅总览 API
.from("delivery_orders")
.select("id")
.eq("restaurant_id", restaurant_id)
.in("status", ["accepted", "delivering"])

.from("delivery_orders")
.select("id")
.eq("restaurant_id", restaurant_id)
.eq("status", "completed")

.from("delivery_orders")
.select("updated_at")
.eq("restaurant_id", restaurant_id)
.eq("status", "completed")
.order("updated_at", { ascending: false })
.limit(1)

// 最新订单 API
.from("delivery_orders")
.select("id")
.eq("restaurant_id", restaurant_id)
.eq("status", "completed")
.order("updated_at", { ascending: false })
.limit(1)
```

**结论：** ✅ **delivery_orders 表被实际查询**

---

### ✅ audit_logs 表

**查询位置：**
- `app/api/facts/orders/[order_id]/route.ts` 第 97-102 行

**查询语句：**
```typescript
.from("audit_logs")
.select("action, created_at, actor_id")
.eq("target_type", "delivery_order")
.eq("target_id", order_id)
.order("created_at", { ascending: true })
```

**结论：** ✅ **audit_logs 表被实际查询**

---

### ✅ trace_logs 表

**查询位置：**
- `app/api/facts/orders/[order_id]/route.ts` 第 190-194 行（查询订单关联的溯源记录）
- `app/api/facts/orders/[order_id]/route.ts` 第 234-240 行（查询资产最后一次操作）
- `app/api/facts/restaurant/[restaurant_id]/assets/route.ts` 第 82-87 行（查询设备最后一次操作）

**查询语句：**
```typescript
// 订单关联的溯源记录
.from("trace_logs")
.select("id, asset_id, operator_id, action_type, order_id, created_at")
.eq("order_id", order_id)
.order("created_at", { ascending: true })

// 资产最后一次操作
.from("trace_logs")
.select("action_type, created_at")
.eq("asset_id", asset.id)
.order("created_at", { ascending: false })
.limit(1)
.maybeSingle()

// 设备最后一次操作
.from("trace_logs")
.select("action_type, created_at")
.eq("asset_id", device.device_id)
.order("created_at", { ascending: false })
.limit(1)
.maybeSingle()
```

**结论：** ✅ **trace_logs 表被实际查询**

---

## 2. 查询字段是否与 schema 完全一致（字段名、类型）

### ✅ delivery_orders 表字段验证

**Schema 定义（migrations/20250120_split_orders_table.sql 第 73-105 行）：**
```sql
CREATE TABLE IF NOT EXISTS delivery_orders (
  id UUID PRIMARY KEY,
  restaurant_id UUID NOT NULL,
  status TEXT NOT NULL DEFAULT 'pending',
  worker_id TEXT, -- 兼容字段
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  ...
)
```

**API 查询字段（app/api/facts/orders/[order_id]/route.ts 第 54 行）：**
```typescript
.select("id, restaurant_id, status, created_at, updated_at, worker_id")
```

**字段对比：**
| API 查询字段 | Schema 字段 | 类型匹配 | 状态 |
|-------------|------------|---------|------|
| `id` | `id` | UUID → string (TypeScript) | ✅ 一致 |
| `restaurant_id` | `restaurant_id` | UUID → string (TypeScript) | ✅ 一致 |
| `status` | `status` | TEXT → string | ✅ 一致 |
| `created_at` | `created_at` | TIMESTAMPTZ → string (ISO 8601) | ✅ 一致 |
| `updated_at` | `updated_at` | TIMESTAMPTZ → string (ISO 8601) | ✅ 一致 |
| `worker_id` | `worker_id` | TEXT → string | ✅ 一致 |

**结论：** ✅ **所有查询字段与 schema 完全一致**

---

### ✅ audit_logs 表字段验证

**Schema 定义（migrations/20250120_audit_logs.sql 第 8-16 行）：**
```sql
CREATE TABLE IF NOT EXISTS audit_logs (
  id UUID PRIMARY KEY,
  actor_id UUID,
  action TEXT NOT NULL,
  target_type TEXT,
  target_id UUID,
  metadata JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
)
```

**API 查询字段（app/api/facts/orders/[order_id]/route.ts 第 99 行）：**
```typescript
.select("action, created_at, actor_id")
```

**字段对比：**
| API 查询字段 | Schema 字段 | 类型匹配 | 状态 |
|-------------|------------|---------|------|
| `action` | `action` | TEXT → string | ✅ 一致 |
| `created_at` | `created_at` | TIMESTAMPTZ → string (ISO 8601) | ✅ 一致 |
| `actor_id` | `actor_id` | UUID → string (TypeScript) | ✅ 一致 |

**注意：** API 使用 `.eq("target_type", "delivery_order")` 和 `.eq("target_id", order_id)` 进行过滤，这些字段在 schema 中存在。

**结论：** ✅ **所有查询字段与 schema 完全一致**

---

### ✅ trace_logs 表字段验证

**Schema 定义（migrations/20250120_asset_trace_base.sql 第 31-38 行）：**
```sql
CREATE TABLE IF NOT EXISTS trace_logs (
  id UUID PRIMARY KEY,
  asset_id UUID NOT NULL,
  operator_id UUID,
  action_type TEXT NOT NULL,
  order_id UUID,
  created_at TIMESTAMPTZ DEFAULT NOW()
)
```

**API 查询字段：**

**查询 1（订单关联的溯源记录，第 192 行）：**
```typescript
.select("id, asset_id, operator_id, action_type, order_id, created_at")
```

**查询 2（资产最后一次操作，第 236 行）：**
```typescript
.select("action_type, created_at")
```

**字段对比：**
| API 查询字段 | Schema 字段 | 类型匹配 | 状态 |
|-------------|------------|---------|------|
| `id` | `id` | UUID → string (TypeScript) | ✅ 一致 |
| `asset_id` | `asset_id` | UUID → string (TypeScript) | ✅ 一致 |
| `operator_id` | `operator_id` | UUID → string (TypeScript) | ✅ 一致 |
| `action_type` | `action_type` | TEXT → string | ✅ 一致 |
| `order_id` | `order_id` | UUID → string (TypeScript) | ✅ 一致 |
| `created_at` | `created_at` | TIMESTAMPTZ → string (ISO 8601) | ✅ 一致 |

**结论：** ✅ **所有查询字段与 schema 完全一致**

---

## 3. 是否存在任何前端展示字段并未真实来自数据库（而是写死 / 推断）

### ✅ OrderTimeline 组件验证

**文件：** `components/facts/OrderTimeline.tsx`

**数据来源检查：**

1. **订单创建节点（第 106-114 行）**
   - `order.order_id` → 来自 `delivery_orders.id` ✅
   - `order.status` → 来自 `delivery_orders.status` ✅
   - `order.created_at` → 来自 `delivery_orders.created_at` ✅
   - `statusLabelMap[order.status]` → **仅用于显示映射，不是写死数据** ✅

2. **订单已接单节点（第 118-131 行）**
   - `order.accepted_at` → 来自 `audit_logs.created_at`（当 action = ORDER_ACCEPTED）✅
   - `order.worker_id` → 来自 `delivery_orders.worker_id` ✅
   - 如果 `order.accepted_at` 不存在，节点不显示（不推断）✅

3. **订单已完成节点（第 133-146 行）**
   - `order.completed_at` → 来自 `audit_logs.created_at`（当 action = ORDER_COMPLETED）✅
   - `order.worker_id` → 来自 `delivery_orders.worker_id` ✅
   - 如果 `order.completed_at` 不存在，节点不显示（不推断）✅

4. **溯源记录节点（第 159-171 行）**
   - `trace.id` → 来自 `trace_logs.id` ✅
   - `trace.action_type` → 来自 `trace_logs.action_type` ✅
   - `trace.operator_id` → 来自 `trace_logs.operator_id` ✅
   - `trace.created_at` → 来自 `trace_logs.created_at` ✅
   - `trace.order_id` → 来自 `trace_logs.order_id` ✅
   - `trace.asset_id` → 来自 `trace_logs.asset_id` ✅

**写死数据检查：**
- `statusLabelMap`（第 31-39 行）→ **仅用于显示映射，不是写死的事实数据** ✅
- 所有时间戳、ID、状态都来自数据库 ✅

**结论：** ✅ **OrderTimeline 组件所有展示字段都真实来自数据库，无写死数据**

---

### ✅ AssetFactCard 组件验证

**文件：** `components/facts/AssetFactCard.tsx`

**数据来源检查：**

1. **资产 ID（第 103-105 行）**
   - `asset.asset_id` → 来自 `gas_cylinders.id` 或 `devices.device_id` ✅

2. **当前状态（第 125 行）**
   - `asset.status` → 来自 `gas_cylinders.status` 或 `devices.status` ✅
   - `statusLabelMap[asset.status]` → **仅用于显示映射，不是写死数据** ✅

3. **最近一次行为（第 135 行）**
   - `asset.last_action` → 来自 `trace_logs.action_type`（最后一次操作）✅
   - 如果没有溯源记录，`last_action` 为空字符串（事实：没有溯源记录）✅

4. **最近更新时间（第 153 行）**
   - `asset.last_action_at` → 来自 `trace_logs.created_at`（最后一次操作时间）✅
   - 如果没有溯源记录，使用 `gas_cylinders.updated_at` 或 `created_at`（事实）✅

**写死数据检查：**
- `statusLabelMap`（第 28-35 行）→ **仅用于显示映射，不是写死的事实数据** ✅
- `formatAssetId` 函数（第 73-78 行）→ **仅用于格式化显示，不改变数据本身** ✅
- `formatTime` 函数（第 40-67 行）→ **仅用于格式化显示，不改变数据本身** ✅
- 所有字段都来自数据库 ✅

**结论：** ✅ **AssetFactCard 组件所有展示字段都真实来自数据库，无写死数据**

---

### ✅ user-bound 页面验证

**文件：** `app/user-bound/page.tsx`

**数据来源检查：**

1. **最近订单（第 204-238 行）**
   - `restaurantOverview.active_orders` → 来自 `delivery_orders` 表查询（第 63-66 行 API）✅
   - `restaurantOverview.completed_orders` → 来自 `delivery_orders` 表查询（第 77-80 行 API）✅

2. **最近一次配送（第 240-258 行）**
   - `latestOrder.order` → 来自 `/api/facts/orders/:order_id` API ✅
   - `latestOrder.traces` → 来自 `/api/facts/orders/:order_id` API ✅

3. **关联资产列表（第 260-289 行）**
   - `assetsList` → 来自 `/api/facts/restaurant/:restaurant_id/assets` API ✅

**写死数据检查：**
- 所有数据都通过 API 获取，无写死数据 ✅

**结论：** ✅ **user-bound 页面所有展示字段都真实来自数据库，无写死数据**

---

## 总结

### ✅ 三张表查询状态

| 表名 | 是否被查询 | 查询位置 | 状态 |
|------|-----------|---------|------|
| `delivery_orders` | ✅ 是 | `app/api/facts/orders/[order_id]/route.ts:52-56`<br>`app/api/facts/restaurant/[restaurant_id]/overview/route.ts:63-113`<br>`app/api/facts/restaurant/[restaurant_id]/latest-order/route.ts:53-58` | ✅ |
| `audit_logs` | ✅ 是 | `app/api/facts/orders/[order_id]/route.ts:97-102` | ✅ |
| `trace_logs` | ✅ 是 | `app/api/facts/orders/[order_id]/route.ts:190-194, 234-240`<br>`app/api/facts/restaurant/[restaurant_id]/assets/route.ts:82-87` | ✅ |

---

### ✅ 字段一致性状态

| 表名 | 查询字段 | Schema 字段 | 一致性 | 状态 |
|------|---------|------------|--------|------|
| `delivery_orders` | `id, restaurant_id, status, created_at, updated_at, worker_id` | 完全匹配 | ✅ | ✅ |
| `audit_logs` | `action, created_at, actor_id` | 完全匹配 | ✅ | ✅ |
| `trace_logs` | `id, asset_id, operator_id, action_type, order_id, created_at` | 完全匹配 | ✅ | ✅ |

---

### ✅ 前端展示字段来源状态

| 组件/页面 | 字段 | 数据来源 | 是否写死 | 状态 |
|----------|------|---------|---------|------|
| `OrderTimeline` | `order_id` | `delivery_orders.id` | ❌ 否 | ✅ |
| `OrderTimeline` | `status` | `delivery_orders.status` | ❌ 否 | ✅ |
| `OrderTimeline` | `created_at` | `delivery_orders.created_at` | ❌ 否 | ✅ |
| `OrderTimeline` | `accepted_at` | `audit_logs.created_at` | ❌ 否 | ✅ |
| `OrderTimeline` | `completed_at` | `audit_logs.created_at` | ❌ 否 | ✅ |
| `OrderTimeline` | `worker_id` | `delivery_orders.worker_id` | ❌ 否 | ✅ |
| `OrderTimeline` | `trace.id` | `trace_logs.id` | ❌ 否 | ✅ |
| `OrderTimeline` | `trace.action_type` | `trace_logs.action_type` | ❌ 否 | ✅ |
| `OrderTimeline` | `trace.operator_id` | `trace_logs.operator_id` | ❌ 否 | ✅ |
| `OrderTimeline` | `trace.created_at` | `trace_logs.created_at` | ❌ 否 | ✅ |
| `AssetFactCard` | `asset_id` | `gas_cylinders.id` / `devices.device_id` | ❌ 否 | ✅ |
| `AssetFactCard` | `status` | `gas_cylinders.status` / `devices.status` | ❌ 否 | ✅ |
| `AssetFactCard` | `last_action` | `trace_logs.action_type` | ❌ 否 | ✅ |
| `AssetFactCard` | `last_action_at` | `trace_logs.created_at` / `gas_cylinders.updated_at` | ❌ 否 | ✅ |
| `user-bound` | `active_orders` | `delivery_orders` 表查询 | ❌ 否 | ✅ |
| `user-bound` | `completed_orders` | `delivery_orders` 表查询 | ❌ 否 | ✅ |

**显示映射（非写死数据）：**
- `statusLabelMap` → 仅用于将数据库状态值映射为中文显示，不改变数据本身 ✅
- `formatTime` → 仅用于格式化时间显示，不改变数据本身 ✅
- `formatAssetId` → 仅用于格式化资产ID显示，不改变数据本身 ✅

---

## 最终结论

### ✅ 所有验证项通过

1. ✅ **三张表都被实际查询**：`delivery_orders`、`audit_logs`、`trace_logs` 三张表都在 API 中被实际查询
2. ✅ **查询字段与 schema 完全一致**：所有查询字段名和类型都与数据库 schema 定义完全匹配
3. ✅ **无写死数据**：所有前端展示字段都真实来自数据库，不存在写死或推断的数据

**验证完成时间：** 2025-01-20
