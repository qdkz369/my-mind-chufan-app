# 事实路径最小可用性验证（read-only）

## 概述

本验证脚本用于验证事实治理层和健康度汇总功能是否正常工作，确保：
- 不修改任何数据库结构
- 不引入 UI
- 不引入新的业务逻辑

## 验证步骤

### A. 构造测试订单
- 使用写死的 UUID: `00000000-0000-0000-0000-000000000001`
- 如果订单不存在，会自动创建测试订单

### B. 插入测试 audit_logs 记录
脚本会插入 4 条测试记录：

1. **ORDER_ACCEPT**（正常时间）
   - 订单创建后 5 分钟
   - 用于验证正常的接单记录

2. **ORDER_COMPLETE**（正常时间）
   - 订单创建后 30 分钟
   - 用于验证正常的完成记录

3. **ORDER_COMPLETED**（时间异常）
   - 订单创建前 30 分钟
   - 用于触发 `FACT_TIME_INVERSION` 警告

4. **ORDER_ACCEPTED**（时间异常）
   - 订单创建前 10 分钟
   - 用于触发时间线异常警告

所有测试记录都标记了 `metadata.test = true`，便于后续清理。

### C. 调用 API
- 调用 `GET /api/facts/orders/:order_id`
- 使用正确的 `x-restaurant-id` 请求头

### D. 输出完整响应
- 输出完整的 JSON 响应
- 包含所有字段：order, assets, traces, fact_warnings, fact_warnings_structured, fact_health

### E. 结果分析
脚本会明确指出：
- ✅ 是否生成了 `fact_warnings_structured`
- ✅ `fact_health.score` 是多少
- ✅ 每一条 warning 来自哪条 audit_logs 记录

## 运行方法

### 前置条件

1. **环境变量配置**
   - 确保 `.env.local` 文件存在并包含：
     - `NEXT_PUBLIC_SUPABASE_URL`
     - `SUPABASE_SERVICE_ROLE_KEY` 或 `NEXT_PUBLIC_SUPABASE_ANON_KEY`

2. **Node.js 版本**
   - Node.js 18+（内置 fetch）
   - 或安装 `node-fetch@2`（Node.js < 18）

3. **应用运行**
   - 确保应用正在运行（`npm run dev`）
   - 或设置 `API_BASE_URL` 环境变量指向运行中的应用

### 执行命令

```bash
# 在项目根目录执行
node scripts/verify-fact-path-minimal.js
```

### 预期输出

脚本会输出：

1. **步骤 A**: 订单查找/创建结果
2. **步骤 B**: 插入的测试记录详情
3. **步骤 C**: API 调用信息
4. **步骤 D**: 完整的 JSON 响应
5. **步骤 E**: 详细的分析结果
   - fact_warnings_structured 生成情况
   - fact_health.score 和汇总
   - 每条 warning 与 audit_logs 记录的关联

## 清理测试数据

验证完成后，可以清理测试数据：

```sql
-- 删除测试 audit_logs 记录
DELETE FROM audit_logs 
WHERE target_id = '00000000-0000-0000-0000-000000000001' 
  AND metadata->>'test' = 'true';

-- 如需删除测试订单
DELETE FROM delivery_orders 
WHERE id = '00000000-0000-0000-0000-000000000001';
```

## 验证要点

### 1. fact_warnings_structured 生成
- ✅ 应该生成至少 2 条结构化警告
- ✅ 警告应包含：code, level, domain, message, fields, evidence

### 2. fact_health.score 计算
- ✅ 应该计算健康度分数
- ✅ 分数应该根据警告级别扣分：
  - high: -30
  - medium: -10
  - low: -3

### 3. 警告与 audit_logs 关联
- ✅ 每条警告应该能够追溯到对应的 audit_logs 记录
- ✅ 时间异常的警告应该关联到时间异常的记录

## 示例输出

```
🔍 开始事实路径最小可用性验证（read-only）...

📋 步骤 A: 构造/查找测试订单...
✅ 找到现有订单: 00000000-0000-0000-0000-000000000001
   餐厅ID: restaurant-123
   创建时间: 2025-01-20T10:00:00Z

📝 步骤 B: 插入测试 audit_logs 记录...
✅ 已插入 4 条测试 audit_logs 记录:
   1. ORDER_ACCEPT - 2025-01-20T10:05:00Z (正常 ORDER_ACCEPT 记录)
   2. ORDER_COMPLETE - 2025-01-20T10:30:00Z (正常 ORDER_COMPLETE 记录)
   3. ORDER_COMPLETED - 2025-01-20T09:30:00Z (时间异常：ORDER_COMPLETED 早于订单创建时间)
   4. ORDER_ACCEPTED - 2025-01-20T09:50:00Z (时间异常：ORDER_ACCEPTED 早于订单创建时间)

🌐 步骤 C: 调用 GET /api/facts/orders/:order_id...
   调用: http://localhost:3000/api/facts/orders/00000000-0000-0000-0000-000000000001

📄 步骤 D: 完整 API JSON 响应
[完整的 JSON 响应]

🔍 步骤 E: 结果分析
✅ E1. fact_warnings_structured 生成情况:
   ✅ 已生成 2 条结构化警告
   1. [HIGH] FACT_TIME_INVERSION
   2. [HIGH] FACT_TIMELINE_BREAK

✅ E2. fact_health.score:
   ✅ 健康度分数: 40
   汇总:
     - high: 2
     - medium: 0
     - low: 0

✅ E3. 警告与 audit_logs 记录的关联:
   警告 1: FACT_TIME_INVERSION (high)
      ✅ 关联的 audit_logs 记录:
         - ID: xxx
           Action: ORDER_COMPLETED
           Created At: 2025-01-20T09:30:00Z
           是否为测试记录: 是
           描述: 时间异常：ORDER_COMPLETED 早于订单创建时间
```

## 注意事项

1. **数据库权限**
   - 需要 `SUPABASE_SERVICE_ROLE_KEY` 才能插入测试数据
   - 如果只有 `NEXT_PUBLIC_SUPABASE_ANON_KEY`，可能需要调整 RLS 策略

2. **API 调用**
   - 确保应用正在运行
   - 或设置正确的 `API_BASE_URL` 环境变量

3. **测试数据隔离**
   - 所有测试记录都标记了 `metadata.test = true`
   - 验证完成后建议清理测试数据

4. **订单 ID**
   - 使用写死的 UUID，确保每次运行使用相同的订单
   - 如果订单已存在，会复用现有订单

## 完成状态

✅ 已创建验证脚本  
✅ 已实现所有验证步骤  
✅ 已添加详细的结果分析  
✅ 已添加清理说明

**验证脚本已就绪！**
