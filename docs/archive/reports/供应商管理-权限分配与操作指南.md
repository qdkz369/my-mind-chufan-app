# ä¾›åº”å•†ç®¡ç† - æƒé™åˆ†é…ä¸æ“ä½œæŒ‡å—

## ğŸ“‹ ç›®å½•

1. [æƒé™ä½“ç³»æ¦‚è¿°](#æƒé™ä½“ç³»æ¦‚è¿°)
2. [æƒé™åˆ†é…å®ç°æœºåˆ¶](#æƒé™åˆ†é…å®ç°æœºåˆ¶)
3. [æ•°æ®åº“å±‚æƒé™ï¼ˆRLSç­–ç•¥ï¼‰](#æ•°æ®åº“å±‚æƒé™rlsç­–ç•¥)
4. [APIå±‚æƒé™éªŒè¯](#apiå±‚æƒé™éªŒè¯)
5. [æ“ä½œæŒ‡å—](#æ“ä½œæŒ‡å—)
6. [è§’è‰²æƒé™å¯¹ç…§è¡¨](#è§’è‰²æƒé™å¯¹ç…§è¡¨)

---

## æƒé™ä½“ç³»æ¦‚è¿°

### 1.1 è§’è‰²å®šä¹‰

ä¾›åº”å•†ç®¡ç†ç³»ç»Ÿæ¶‰åŠä»¥ä¸‹è§’è‰²ï¼š

| è§’è‰² | æ ‡è¯† | æƒé™èŒƒå›´ | è¯´æ˜ |
|------|------|---------|------|
| **è¶…çº§ç®¡ç†å‘˜** | `super_admin` | å…¨å¹³å° | å¯ä»¥åˆ›å»ºä¾›åº”å•†ã€åˆ†é…ç”¨æˆ·ã€æŸ¥çœ‹æ‰€æœ‰æ•°æ® |
| **ä¾›åº”å•†ç®¡ç†å‘˜** | `admin` | å•ä¸ªå…¬å¸ | ç®¡ç†å…¬å¸äº§å“å’Œè®¢å• |
| **ä¾›åº”å•†æ‰€æœ‰è€…** | `owner` | å•ä¸ªå…¬å¸ | æ‹¥æœ‰å…¬å¸å®Œå…¨æ§åˆ¶æƒ |
| **ä¾›åº”å•†æˆå‘˜** | `member` | å•ä¸ªå…¬å¸ | å¯ä»¥ä¸Šä¼ äº§å“ï¼Œä½†éœ€è¦å®¡æ ¸ |

### 1.2 æ•°æ®è¡¨ç»“æ„

ä¾›åº”å•†ç®¡ç†æ¶‰åŠä»¥ä¸‹æ ¸å¿ƒæ•°æ®è¡¨ï¼š

- **`companies`** - ä¾›åº”å•†å…¬å¸è¡¨
- **`user_companies`** - ç”¨æˆ·ä¸å…¬å¸çš„å…³è”è¡¨
- **`user_roles`** - ç”¨æˆ·è§’è‰²è¡¨ï¼ˆå®šä¹‰ç”¨æˆ·æ˜¯å¦ä¸º super_adminï¼‰

---

## æƒé™åˆ†é…å®ç°æœºåˆ¶

### 2.1 å‰ç«¯æƒé™æ£€æŸ¥ï¼ˆUIå±‚ï¼‰

**æ–‡ä»¶ä½ç½®ï¼š** `app/(admin)/dashboard/supplier-management.tsx`

**å®ç°æ–¹å¼ï¼š**
- å‰ç«¯ç»„ä»¶é€šè¿‡ Supabase å®¢æˆ·ç«¯ç›´æ¥æŸ¥è¯¢ `companies` è¡¨
- ä¾èµ–æ•°æ®åº“å±‚çš„ RLS ç­–ç•¥æ¥æ§åˆ¶å¯è§æ€§
- å¦‚æœ RLS ç­–ç•¥é…ç½®æ­£ç¡®ï¼Œç”¨æˆ·åªèƒ½çœ‹åˆ°æœ‰æƒé™çš„æ•°æ®

```typescript
// åŠ è½½å…¬å¸åˆ—è¡¨ï¼ˆå— RLS ç­–ç•¥é™åˆ¶ï¼‰
const { data, error } = await supabase
  .from("companies")
  .select("*")
  .order("created_at", { ascending: false })
```

**æƒé™é”™è¯¯å¤„ç†ï¼š**
```typescript
// å¦‚æœæ˜¯ RLS é”™è¯¯ï¼ˆ42501 æˆ– PGRST301ï¼‰ï¼Œæç¤ºæƒé™ä¸è¶³
if (error.code === "42501" || error.code === "PGRST301") {
  alert(`åŠ è½½å¤±è´¥: æƒé™ä¸è¶³ã€‚è¯·æ£€æŸ¥ companies è¡¨çš„ RLS ç­–ç•¥è®¾ç½®ã€‚`)
}
```

### 2.2 APIå±‚æƒé™éªŒè¯

#### 2.2.1 åˆ›å»ºä¾›åº”å•†å…¬å¸ API

**æ–‡ä»¶ä½ç½®ï¼š** `app/api/admin/create-company/route.ts`

**æƒé™è¦æ±‚ï¼š**
- âœ… **ä»…å…è®¸ `super_admin` è§’è‰²**
- âœ… é€šè¿‡ `getUserContext` ç»Ÿä¸€æƒé™éªŒè¯
- âœ… ä½¿ç”¨ Service Role Key åˆ›å»ºå…¬å¸è®°å½•ï¼ˆç»•è¿‡ RLSï¼‰

**éªŒè¯æµç¨‹ï¼š**
```typescript
// 1. è·å–ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆç»Ÿä¸€æƒé™å…¥å£ï¼‰
const userContext = await getUserContext(request)

// 2. æ£€æŸ¥æ˜¯å¦ä¸º super_admin
if (userContext.role !== "super_admin") {
  return NextResponse.json({
    success: false,
    error: "æƒé™ä¸è¶³",
    details: "åªæœ‰è¶…çº§ç®¡ç†å‘˜å¯ä»¥åˆ›å»ºå…¬å¸"
  }, { status: 403 })
}

// 3. ä½¿ç”¨ Service Role Key åˆ›å»ºå…¬å¸ï¼ˆç»•è¿‡ RLSï¼‰
const adminSupabaseClient = createClient(supabaseUrl, serviceRoleKey)
const { data: companyData } = await adminSupabaseClient
  .from("companies")
  .insert(insertData)
  .select()
  .single()

// 4. è‡ªåŠ¨ä¸ºå½“å‰ç”¨æˆ·åˆ›å»º user_companies å…³è”ï¼ˆè®¾ä¸º owner å’Œä¸»å…¬å¸ï¼‰
await adminSupabaseClient
  .from("user_companies")
  .insert({
    user_id: currentUserId,
    company_id: companyData.id,
    role: "owner",
    is_primary: true,
  })
```

**å…³é”®ç‚¹ï¼š**
- ğŸ”’ åªæœ‰ `super_admin` å¯ä»¥è°ƒç”¨æ­¤ API
- ğŸ”‘ ä½¿ç”¨ Service Role Key åˆ›å»ºè®°å½•ï¼Œå› ä¸ºéœ€è¦ç»•è¿‡ RLS
- ğŸ”— åˆ›å»ºå…¬å¸åï¼Œè‡ªåŠ¨ä¸ºåˆ›å»ºè€…å»ºç«‹ `owner` å…³è”

#### 2.2.2 æŸ¥æ‰¾ç”¨æˆ· API

**æ–‡ä»¶ä½ç½®ï¼š** `app/api/admin/find-user/route.ts`

**æƒé™è¦æ±‚ï¼š**
- âœ… **ä»…å…è®¸ `super_admin` è§’è‰²**ï¼ˆè™½ç„¶ä»£ç ä¸­æ²¡æœ‰æ˜¾å¼æ£€æŸ¥ï¼Œä½†åº”ç”±è°ƒç”¨æ–¹ç¡®ä¿ï¼‰
- âœ… ä½¿ç”¨ Service Role Key è®¿é—® `auth.users` è¡¨

**éªŒè¯æµç¨‹ï¼š**
```typescript
// ä½¿ç”¨ Service Role Key åˆ›å»º Admin å®¢æˆ·ç«¯ï¼ˆå”¯ä¸€è®¿é—® auth.users çš„æ–¹å¼ï¼‰
const supabaseAdmin = createClient(supabaseUrl, serviceRoleKey)

// é€šè¿‡é‚®ç®±æŸ¥æ‰¾ç”¨æˆ·
const { data: { users } } = await supabaseAdmin.auth.admin.listUsers()
const user = users?.find((u) => u.email === email)
```

**å…³é”®ç‚¹ï¼š**
- ğŸ”’ è®¿é—® `auth.users` è¡¨å¿…é¡»ä½¿ç”¨ Service Role Key
- ğŸ” é€šè¿‡é‚®ç®±æŸ¥æ‰¾å·²æ³¨å†Œç”¨æˆ·
- âš ï¸ å½“å‰å®ç°æœªæ˜¾å¼éªŒè¯è°ƒç”¨è€…æƒé™ï¼Œå»ºè®®æ·»åŠ  `getUserContext` éªŒè¯

### 2.3 ç»Ÿä¸€æƒé™éªŒè¯æ¨¡å—

**æ–‡ä»¶ä½ç½®ï¼š** `lib/auth/user-context.ts`

**åŠŸèƒ½ï¼š**
- ç³»ç»Ÿä¸­**å”¯ä¸€å¯ä¿¡çš„æƒé™å…¥å£**
- æ‰€æœ‰ API å¿…é¡»é€šè¿‡æ­¤æ¨¡å—è·å–ç”¨æˆ·èº«ä»½å’Œæƒé™ä¿¡æ¯

**éªŒè¯æµç¨‹ï¼š**
```typescript
export async function getUserContext(req: NextRequest | Request): Promise<UserContext> {
  // 1. ä» Supabase Auth session ä¸­è·å– userId
  const { data: { user } } = await supabaseClient.auth.getUser()
  
  // 2. ä» user_roles è¡¨è·å– role
  const { data: roleData } = await adminClient
    .from("user_roles")
    .select("role")
    .eq("user_id", userId)
    .single()
  
  // 3. å¦‚æœ role â‰  super_adminï¼Œå¿…é¡»ä» user_companies è·å– company_id
  if (role !== "super_admin") {
    const { data: companyData } = await adminClient
      .from("user_companies")
      .select("company_id")
      .eq("user_id", userId)
      .eq("is_primary", true)
      .single()
    
    if (!companyId) {
      throw new Error("æƒé™ä¸è¶³ï¼šç”¨æˆ·æœªå…³è”ä»»ä½•å…¬å¸")
    }
  }
  
  // 4. super_admin å…è®¸ companyId ä¸º undefined
  return { userId, role, companyId }
}
```

**è§„åˆ™ï¼š**
1. âœ… ç¦æ­¢ API è‡ªè¡ŒæŸ¥è¯¢ `user_roles` æˆ– `user_companies` è¡¨
2. âœ… `super_admin` å…è®¸ `companyId` ä¸º `undefined`
3. âœ… é `super_admin` å¿…é¡»å…³è”è‡³å°‘ä¸€ä¸ªå…¬å¸

---

## æ•°æ®åº“å±‚æƒé™ï¼ˆRLSç­–ç•¥ï¼‰

### 3.1 companies è¡¨ RLS ç­–ç•¥

**å½“å‰ç­–ç•¥é…ç½®ï¼š**

```sql
-- ç­–ç•¥1ï¼šæœåŠ¡è§’è‰²å®Œå…¨è®¿é—®ï¼ˆAPI è·¯ç”±ä½¿ç”¨ Service Role Keyï¼‰
CREATE POLICY "Service role full access to companies"
  ON companies
  FOR ALL
  TO service_role
  USING (true)
  WITH CHECK (true);

-- ç­–ç•¥2ï¼šè®¤è¯ç”¨æˆ·æŸ¥çœ‹æ‰€æœ‰å…¬å¸ï¼ˆç®¡ç†åå°éœ€è¦ï¼‰
CREATE POLICY "Authenticated users can view all companies"
  ON companies
  FOR SELECT
  TO authenticated
  USING (true);

-- ç­–ç•¥3ï¼šè®¤è¯ç”¨æˆ·åˆ›å»ºå…¬å¸ï¼ˆç®¡ç†åå°éœ€è¦ï¼‰
CREATE POLICY "Authenticated users can create companies"
  ON companies
  FOR INSERT
  TO authenticated
  WITH CHECK (true);

-- ç­–ç•¥4ï¼šè®¤è¯ç”¨æˆ·æ›´æ–°å…¬å¸ï¼ˆç®¡ç†åå°éœ€è¦ï¼‰
CREATE POLICY "Authenticated users can update companies"
  ON companies
  FOR UPDATE
  TO authenticated
  USING (true)
  WITH CHECK (true);

-- ç­–ç•¥5ï¼šè®¤è¯ç”¨æˆ·åˆ é™¤å…¬å¸ï¼ˆç®¡ç†åå°éœ€è¦ï¼‰
CREATE POLICY "Authenticated users can delete companies"
  ON companies
  FOR DELETE
  TO authenticated
  USING (true);
```

**æƒé™è¯´æ˜ï¼š**
- âœ… **Service Role**ï¼šå®Œå…¨è®¿é—®ï¼ˆç”¨äº API è·¯ç”±ï¼‰
- âœ… **å·²è®¤è¯ç”¨æˆ·**ï¼šå¯ä»¥æŸ¥çœ‹ã€åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤æ‰€æœ‰å…¬å¸
- âš ï¸ **æ³¨æ„**ï¼šå½“å‰ç­–ç•¥è¾ƒå®½æ¾ï¼Œå…è®¸æ‰€æœ‰å·²è®¤è¯ç”¨æˆ·æ“ä½œæ‰€æœ‰å…¬å¸æ•°æ®

### 3.2 user_companies è¡¨ RLS ç­–ç•¥

**å½“å‰ç­–ç•¥é…ç½®ï¼š**

```sql
-- ç­–ç•¥1ï¼šæœåŠ¡è§’è‰²å®Œå…¨è®¿é—®
CREATE POLICY "Service role full access to user_companies"
  ON user_companies
  FOR ALL
  TO service_role
  USING (true)
  WITH CHECK (true);

-- ç­–ç•¥2ï¼šè®¤è¯ç”¨æˆ·æŸ¥çœ‹æ‰€æœ‰å…³è”ï¼ˆç®¡ç†åå°éœ€è¦ï¼‰
CREATE POLICY "Authenticated users can view all user_companies"
  ON user_companies
  FOR SELECT
  TO authenticated
  USING (true);

-- ç­–ç•¥3ï¼šè®¤è¯ç”¨æˆ·åˆ›å»ºå…³è”ï¼ˆç®¡ç†åå°éœ€è¦ï¼‰
CREATE POLICY "Authenticated users can create user_companies"
  ON user_companies
  FOR INSERT
  TO authenticated
  WITH CHECK (true);

-- ç­–ç•¥4ï¼šè®¤è¯ç”¨æˆ·æ›´æ–°å…³è”ï¼ˆç®¡ç†åå°éœ€è¦ï¼‰
CREATE POLICY "Authenticated users can update user_companies"
  ON user_companies
  FOR UPDATE
  TO authenticated
  USING (true)
  WITH CHECK (true);

-- ç­–ç•¥5ï¼šè®¤è¯ç”¨æˆ·åˆ é™¤å…³è”ï¼ˆç®¡ç†åå°éœ€è¦ï¼‰
CREATE POLICY "Authenticated users can delete user_companies"
  ON user_companies
  FOR DELETE
  TO authenticated
  USING (true);
```

**æƒé™è¯´æ˜ï¼š**
- âœ… **Service Role**ï¼šå®Œå…¨è®¿é—®ï¼ˆç”¨äº API è·¯ç”±ï¼‰
- âœ… **å·²è®¤è¯ç”¨æˆ·**ï¼šå¯ä»¥æŸ¥çœ‹ã€åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤æ‰€æœ‰ç”¨æˆ·å…³è”
- âš ï¸ **æ³¨æ„**ï¼šå½“å‰ç­–ç•¥è¾ƒå®½æ¾ï¼Œä¾èµ– API å±‚è¿›è¡Œæƒé™éªŒè¯

### 3.3 æƒé™éªŒè¯å±‚çº§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯ UI å±‚                             â”‚
â”‚  (supplier-management.tsx)              â”‚
â”‚  - é€šè¿‡ Supabase å®¢æˆ·ç«¯æŸ¥è¯¢             â”‚
â”‚  - ä¾èµ– RLS ç­–ç•¥æ§åˆ¶å¯è§æ€§              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API è·¯ç”±å±‚                             â”‚
â”‚  (/api/admin/create-company)            â”‚
â”‚  - ä½¿ç”¨ getUserContext éªŒè¯æƒé™         â”‚
â”‚  - æ£€æŸ¥ role === 'super_admin'          â”‚
â”‚  - ä½¿ç”¨ Service Role Key æ“ä½œæ•°æ®åº“     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®åº“ RLS ç­–ç•¥å±‚                      â”‚
â”‚  (companies, user_companies)            â”‚
â”‚  - Service Role: å®Œå…¨è®¿é—®               â”‚
â”‚  - Authenticated: æŸ¥çœ‹/åˆ›å»º/æ›´æ–°/åˆ é™¤   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¤šå±‚é˜²æŠ¤ï¼š**
1. âœ… **UI å±‚**ï¼šRLS ç­–ç•¥æ§åˆ¶æ•°æ®å¯è§æ€§
2. âœ… **API å±‚**ï¼š`getUserContext` éªŒè¯ç”¨æˆ·è§’è‰²
3. âœ… **æ•°æ®åº“å±‚**ï¼šRLS ç­–ç•¥ä½œä¸ºæœ€åé˜²çº¿

---

## APIå±‚æƒé™éªŒè¯

### 4.1 æƒé™éªŒè¯æµç¨‹

#### åˆ›å»ºä¾›åº”å•†å…¬å¸

```typescript
// æ­¥éª¤1ï¼šè·å–ç”¨æˆ·ä¸Šä¸‹æ–‡
const userContext = await getUserContext(request)

// æ­¥éª¤2ï¼šéªŒè¯è§’è‰²
if (userContext.role !== "super_admin") {
  return 403 Forbidden
}

// æ­¥éª¤3ï¼šä½¿ç”¨ Service Role Key åˆ›å»ºè®°å½•
const adminClient = createClient(url, serviceRoleKey)
await adminClient.from("companies").insert(data)

// æ­¥éª¤4ï¼šè‡ªåŠ¨åˆ›å»ºç”¨æˆ·å…³è”
await adminClient.from("user_companies").insert({
  user_id: userContext.userId,
  company_id: companyId,
  role: "owner",
  is_primary: true,
})
```

#### åˆ†é…ç”¨æˆ·åˆ°å…¬å¸

```typescript
// æ­¥éª¤1ï¼šæŸ¥æ‰¾ç”¨æˆ·ï¼ˆé€šè¿‡é‚®ç®±ï¼‰
const response = await fetch("/api/admin/find-user", {
  method: "POST",
  body: JSON.stringify({ email: userEmail }),
})

// æ­¥éª¤2ï¼šæ£€æŸ¥æ˜¯å¦å·²å…³è”
const { data: existing } = await supabase
  .from("user_companies")
  .select("id")
  .eq("user_id", userId)
  .eq("company_id", companyId)
  .single()

// æ­¥éª¤3ï¼šå¦‚æœè®¾ç½®ä¸ºä¸»å…¬å¸ï¼Œå…ˆå–æ¶ˆå…¶ä»–ä¸»å…¬å¸æ ‡è®°
if (is_primary) {
  await supabase
    .from("user_companies")
    .update({ is_primary: false })
    .eq("user_id", userId)
}

// æ­¥éª¤4ï¼šåˆ›å»ºå…³è”
await supabase.from("user_companies").insert({
  user_id: userId,
  company_id: companyId,
  role: role, // 'owner' | 'admin' | 'member'
  is_primary: is_primary,
})
```

### 4.2 æƒé™æ£€æŸ¥ç‚¹

| æ“ä½œ | æƒé™è¦æ±‚ | éªŒè¯ä½ç½® | éªŒè¯æ–¹å¼ |
|------|---------|---------|---------|
| **åˆ›å»ºå…¬å¸** | `super_admin` | API è·¯ç”± | `getUserContext` + è§’è‰²æ£€æŸ¥ |
| **æŸ¥çœ‹å…¬å¸åˆ—è¡¨** | å·²è®¤è¯ç”¨æˆ· | RLS ç­–ç•¥ | æ•°æ®åº“å±‚ RLS |
| **åˆ†é…ç”¨æˆ·** | å·²è®¤è¯ç”¨æˆ· | RLS ç­–ç•¥ + å‰ç«¯éªŒè¯ | æ•°æ®åº“å±‚ RLSï¼ˆå»ºè®®æ·»åŠ  API éªŒè¯ï¼‰ |
| **æ›´æ–°å…¬å¸çŠ¶æ€** | å·²è®¤è¯ç”¨æˆ· | RLS ç­–ç•¥ | æ•°æ®åº“å±‚ RLS |
| **åˆ é™¤ç”¨æˆ·å…³è”** | å·²è®¤è¯ç”¨æˆ· | RLS ç­–ç•¥ | æ•°æ®åº“å±‚ RLS |

---

## æ“ä½œæŒ‡å—

### 5.1 åˆ›å»ºä¾›åº”å•†å…¬å¸

**å‰ç½®æ¡ä»¶ï¼š**
- âœ… ç”¨æˆ·å¿…é¡»å·²ç™»å½•
- âœ… ç”¨æˆ·è§’è‰²å¿…é¡»æ˜¯ `super_admin`

**æ“ä½œæ­¥éª¤ï¼š**

1. **è¿›å…¥ç®¡ç†åå°**
   ```
   http://localhost:3000/dashboard
   ```

2. **ç‚¹å‡»"ä¾›åº”å•†ç®¡ç†"èœå•**
   - å·¦ä¾§å¯¼èˆªæ  â†’ "ä¾›åº”å•†ç®¡ç†"

3. **ç‚¹å‡»"åˆ›å»ºä¾›åº”å•†"æŒ‰é’®**
   - å³ä¸Šè§’è“è‰²æŒ‰é’®

4. **å¡«å†™å…¬å¸ä¿¡æ¯**
   - **å…¬å¸åç§°**ï¼ˆå¿…å¡«ï¼‰ï¼šä¾‹å¦‚"XXè®¾å¤‡ç§Ÿèµæœ‰é™å…¬å¸"
   - **è”ç³»äºº**ï¼ˆå¯é€‰ï¼‰ï¼šè”ç³»äººå§“å
   - **è”ç³»ç”µè¯**ï¼ˆå¯é€‰ï¼‰ï¼šè”ç³»ç”µè¯
   - **è”ç³»é‚®ç®±**ï¼ˆå¯é€‰ï¼‰ï¼šè”ç³»é‚®ç®±
   - **å…¬å¸åœ°å€**ï¼ˆå¯é€‰ï¼‰ï¼šè¯¦ç»†åœ°å€
   - **è¥ä¸šæ‰§ç…§å·**ï¼ˆå¯é€‰ï¼‰ï¼šè¥ä¸šæ‰§ç…§å·
   - **çŠ¶æ€**ï¼ˆé»˜è®¤ `active`ï¼‰ï¼šæ¿€æ´»/åœç”¨/æš‚åœ

5. **ç‚¹å‡»"åˆ›å»ºå…¬å¸"**
   - ç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºåˆ›å»ºè€…å»ºç«‹ `owner` å…³è”ï¼Œå¹¶è®¾ä¸ºä¸»å…¬å¸

**ç»“æœï¼š**
- âœ… å…¬å¸åˆ›å»ºæˆåŠŸ
- âœ… å½“å‰ç”¨æˆ·è‡ªåŠ¨æˆä¸ºå…¬å¸ `owner`
- âœ… å…¬å¸çŠ¶æ€ä¸º `active`

### 5.2 åˆ†é…ç”¨æˆ·åˆ°å…¬å¸

**å‰ç½®æ¡ä»¶ï¼š**
- âœ… ç”¨æˆ·å¿…é¡»å·²ç™»å½•
- âœ… ç›®æ ‡ç”¨æˆ·å¿…é¡»å·²æ³¨å†Œï¼ˆæœ‰è´¦å·ï¼‰

**æ“ä½œæ­¥éª¤ï¼š**

1. **è¿›å…¥ä¾›åº”å•†ç®¡ç†é¡µé¢**
   ```
   http://localhost:3000/dashboard â†’ ä¾›åº”å•†ç®¡ç†
   ```

2. **æ‰¾åˆ°ç›®æ ‡å…¬å¸**
   - åœ¨å…¬å¸åˆ—è¡¨ä¸­ï¼Œæ‰¾åˆ°è¦åˆ†é…ç”¨æˆ·çš„å…¬å¸

3. **ç‚¹å‡»"åˆ†é…ç”¨æˆ·"æŒ‰é’®**
   - åœ¨å…¬å¸å¡ç‰‡ä¸Šï¼Œç‚¹å‡»"åˆ†é…ç”¨æˆ·"æŒ‰é’®

4. **å¡«å†™ç”¨æˆ·ä¿¡æ¯**
   - **ç”¨æˆ·é‚®ç®±**ï¼ˆå¿…å¡«ï¼‰ï¼šè¾“å…¥å·²æ³¨å†Œç”¨æˆ·çš„é‚®ç®±
   - **è§’è‰²**ï¼šé€‰æ‹© `member` / `admin` / `owner`
     - `member`ï¼šæ™®é€šæˆå‘˜ï¼Œå¯ä»¥ä¸Šä¼ äº§å“ï¼ˆéœ€å®¡æ ¸ï¼‰
     - `admin`ï¼šç®¡ç†å‘˜ï¼Œå¯ä»¥ç®¡ç†å…¬å¸äº§å“
     - `owner`ï¼šæ‰€æœ‰è€…ï¼Œæ‹¥æœ‰å…¬å¸å®Œå…¨æ§åˆ¶æƒ
   - **è®¾ä¸ºä¸»å…¬å¸**ï¼ˆå¯é€‰ï¼‰ï¼šå¦‚æœå‹¾é€‰ï¼Œä¼šè‡ªåŠ¨å–æ¶ˆå…¶ä»–ä¸»å…¬å¸æ ‡è®°

5. **ç‚¹å‡»"åˆ†é…ç”¨æˆ·"**
   - ç³»ç»Ÿä¼šæŸ¥æ‰¾ç”¨æˆ·å¹¶åˆ›å»ºå…³è”

**ç»“æœï¼š**
- âœ… ç”¨æˆ·æˆåŠŸå…³è”åˆ°å…¬å¸
- âœ… å¦‚æœè®¾ç½®äº†ä¸»å…¬å¸ï¼Œæ—§çš„ä¸»å…¬å¸æ ‡è®°ä¼šè¢«å–æ¶ˆ
- âœ… ç”¨æˆ·å¯ä»¥åœ¨å…¬å¸å¡ç‰‡ä¸­çœ‹åˆ°å·²åˆ†é…çš„ç”¨æˆ·åˆ—è¡¨

### 5.3 ç®¡ç†ç”¨æˆ·è§’è‰²

**æ“ä½œæ­¥éª¤ï¼š**

1. **æŸ¥çœ‹å·²åˆ†é…ç”¨æˆ·**
   - ç‚¹å‡»å…¬å¸çš„"åˆ†é…ç”¨æˆ·"æŒ‰é’®
   - åœ¨å¯¹è¯æ¡†åº•éƒ¨æŸ¥çœ‹"å·²åˆ†é…ç”¨æˆ·"åˆ—è¡¨

2. **ç§»é™¤ç”¨æˆ·**
   - åœ¨å·²åˆ†é…ç”¨æˆ·åˆ—è¡¨ä¸­ï¼Œç‚¹å‡»ç”¨æˆ·å³ä¾§çš„"åˆ é™¤"å›¾æ ‡
   - ç¡®è®¤åˆ é™¤æ“ä½œ

**æ³¨æ„ï¼š**
- âš ï¸ ç§»é™¤ç”¨æˆ·åï¼Œç”¨æˆ·å°†æ— æ³•è®¿é—®è¯¥å…¬å¸æ•°æ®
- âš ï¸ å¦‚æœç§»é™¤çš„æ˜¯ä¸»å…¬å¸ï¼Œç”¨æˆ·çš„å…¶ä»–å…¬å¸ä¼šè‡ªåŠ¨æˆä¸ºä¸»å…¬å¸ï¼ˆå¦‚æœæœ‰ï¼‰

### 5.4 æ›´æ–°å…¬å¸çŠ¶æ€

**æ“ä½œæ­¥éª¤ï¼š**

1. **è¿›å…¥ä¾›åº”å•†ç®¡ç†é¡µé¢**
2. **æ‰¾åˆ°ç›®æ ‡å…¬å¸**
3. **ç‚¹å‡»çŠ¶æ€ä¸‹æ‹‰èœå•**
   - åœ¨å…¬å¸å¡ç‰‡åº•éƒ¨ï¼Œç‚¹å‡»çŠ¶æ€é€‰æ‹©å™¨
4. **é€‰æ‹©æ–°çŠ¶æ€**
   - `active`ï¼šæ¿€æ´»ï¼ˆæ­£å¸¸ä½¿ç”¨ï¼‰
   - `inactive`ï¼šåœç”¨ï¼ˆæš‚åœä½¿ç”¨ï¼‰
   - `suspended`ï¼šæš‚åœï¼ˆä¸´æ—¶ç¦ç”¨ï¼‰

**çŠ¶æ€è¯´æ˜ï¼š**
- âœ… `active`ï¼šå…¬å¸å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼Œç”¨æˆ·å¯ä»¥ä¸Šä¼ äº§å“
- âš ï¸ `inactive`ï¼šå…¬å¸è¢«åœç”¨ï¼Œå¯èƒ½å½±å“åŠŸèƒ½ä½¿ç”¨
- ğŸš« `suspended`ï¼šå…¬å¸è¢«æš‚åœï¼Œç”¨æˆ·å¯èƒ½æ— æ³•è®¿é—®

### 5.5 æœç´¢å’Œç­›é€‰

**æœç´¢åŠŸèƒ½ï¼š**
- åœ¨æœç´¢æ¡†ä¸­è¾“å…¥å…³é”®è¯
- æ”¯æŒæœç´¢ï¼šå…¬å¸åç§°ã€è”ç³»äººã€ç”µè¯ã€é‚®ç®±

**ç­›é€‰åŠŸèƒ½ï¼š**
- ä½¿ç”¨çŠ¶æ€ä¸‹æ‹‰èœå•ç­›é€‰
- å¯é€‰ï¼šå…¨éƒ¨çŠ¶æ€ / æ¿€æ´» / åœç”¨ / æš‚åœ

---

## è§’è‰²æƒé™å¯¹ç…§è¡¨

### 6.1 æ“ä½œæƒé™çŸ©é˜µ

| æ“ä½œ | super_admin | owner | admin | member |
|------|------------|-------|-------|--------|
| **åˆ›å»ºå…¬å¸** | âœ… | âŒ | âŒ | âŒ |
| **æŸ¥çœ‹æ‰€æœ‰å…¬å¸** | âœ… | âš ï¸ ä»…è‡ªå·±çš„å…¬å¸ | âš ï¸ ä»…è‡ªå·±çš„å…¬å¸ | âš ï¸ ä»…è‡ªå·±çš„å…¬å¸ |
| **åˆ†é…ç”¨æˆ·åˆ°å…¬å¸** | âœ… | âŒ | âŒ | âŒ |
| **æ›´æ–°å…¬å¸çŠ¶æ€** | âœ… | âŒ | âŒ | âŒ |
| **ç§»é™¤ç”¨æˆ·å…³è”** | âœ… | âŒ | âŒ | âŒ |
| **ä¸Šä¼ äº§å“** | âŒ | âœ… | âœ… | âœ…ï¼ˆéœ€å®¡æ ¸ï¼‰|
| **ç®¡ç†äº§å“** | âŒ | âœ… | âœ… | âŒ |
| **å®¡æ ¸äº§å“** | âŒ | âœ… | âœ… | âŒ |

### 6.2 æ•°æ®è®¿é—®æƒé™

| æ•°æ®èŒƒå›´ | super_admin | owner | admin | member |
|---------|------------|-------|-------|--------|
| **æ‰€æœ‰å…¬å¸æ•°æ®** | âœ… å®Œå…¨è®¿é—® | âŒ | âŒ | âŒ |
| **è‡ªå·±å…¬å¸çš„æ•°æ®** | âœ… å®Œå…¨è®¿é—® | âœ… å®Œå…¨è®¿é—® | âœ… éƒ¨åˆ†è®¿é—® | âœ… éƒ¨åˆ†è®¿é—® |
| **å…¶ä»–å…¬å¸çš„æ•°æ®** | âœ… å®Œå…¨è®¿é—® | âŒ | âŒ | âŒ |

### 6.3 æƒé™éªŒè¯å±‚çº§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  super_admin                                 â”‚
â”‚  - å¯ä»¥åˆ›å»ºå…¬å¸                              â”‚
â”‚  - å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å…¬å¸                          â”‚
â”‚  - å¯ä»¥åˆ†é…ç”¨æˆ·                              â”‚
â”‚  - å¯ä»¥ç®¡ç†æ‰€æœ‰å…¬å¸                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  owner (å…¬å¸æ‰€æœ‰è€…)                          â”‚
â”‚  - å¯ä»¥ç®¡ç†å…¬å¸äº§å“                          â”‚
â”‚  - å¯ä»¥å®¡æ ¸äº§å“                              â”‚
â”‚  - å¯ä»¥ä¸Šä¼ äº§å“                              â”‚
â”‚  - æ‹¥æœ‰å…¬å¸å®Œå…¨æ§åˆ¶æƒ                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  admin (å…¬å¸ç®¡ç†å‘˜)                          â”‚
â”‚  - å¯ä»¥ç®¡ç†å…¬å¸äº§å“                          â”‚
â”‚  - å¯ä»¥å®¡æ ¸äº§å“                              â”‚
â”‚  - å¯ä»¥ä¸Šä¼ äº§å“                              â”‚
â”‚  - éƒ¨åˆ†ç®¡ç†æƒé™                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  member (å…¬å¸æˆå‘˜)                           â”‚
â”‚  - å¯ä»¥ä¸Šä¼ äº§å“ï¼ˆéœ€å®¡æ ¸ï¼‰                    â”‚
â”‚  - åªèƒ½æŸ¥çœ‹è‡ªå·±çš„äº§å“                        â”‚
â”‚  - æ— ç®¡ç†æƒé™                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

### 7.1 å½“å‰å®‰å…¨çŠ¶å†µ

**ä¼˜ç‚¹ï¼š**
- âœ… API å±‚ä½¿ç”¨ `getUserContext` ç»Ÿä¸€éªŒè¯
- âœ… åˆ›å»ºå…¬å¸ä»…å…è®¸ `super_admin`
- âœ… RLS ç­–ç•¥ä½œä¸ºæœ€åé˜²çº¿

**é£é™©ç‚¹ï¼š**
- âš ï¸ RLS ç­–ç•¥è¾ƒå®½æ¾ï¼Œå…è®¸æ‰€æœ‰å·²è®¤è¯ç”¨æˆ·æ“ä½œæ‰€æœ‰å…¬å¸æ•°æ®
- âš ï¸ åˆ†é…ç”¨æˆ·ã€æ›´æ–°çŠ¶æ€ç­‰æ“ä½œä¸»è¦ä¾èµ–å‰ç«¯éªŒè¯å’Œ RLS
- âš ï¸ `/api/admin/find-user` æœªæ˜¾å¼éªŒè¯è°ƒç”¨è€…æƒé™

### 7.2 å»ºè®®æ”¹è¿›

1. **å¼ºåŒ– RLS ç­–ç•¥**
   ```sql
   -- å»ºè®®ï¼šåªå…è®¸ç”¨æˆ·æŸ¥çœ‹è‡ªå·±å…³è”çš„å…¬å¸
   CREATE POLICY "Users can view their own companies"
     ON companies
     FOR SELECT
     TO authenticated
     USING (
       EXISTS (
         SELECT 1 FROM user_companies
         WHERE user_companies.user_id = auth.uid()
         AND user_companies.company_id = companies.id
       )
     );
   ```

2. **æ·»åŠ  API å±‚éªŒè¯**
   - ä¸ºåˆ†é…ç”¨æˆ·ã€æ›´æ–°çŠ¶æ€ç­‰æ“ä½œæ·»åŠ  API è·¯ç”±
   - åœ¨ API ä¸­éªŒè¯æ“ä½œè€…æƒé™ï¼ˆå¦‚ï¼šåªå…è®¸ `super_admin` æˆ– `owner` åˆ†é…ç”¨æˆ·ï¼‰

3. **å®Œå–„æ—¥å¿—è®°å½•**
   - è®°å½•æ‰€æœ‰å…¬å¸åˆ›å»ºã€ç”¨æˆ·åˆ†é…ç­‰æ“ä½œ
   - ä¾¿äºå®¡è®¡å’Œé—®é¢˜æ’æŸ¥

---

## ğŸ“ å¿«é€Ÿå‚è€ƒ

### å¸¸ç”¨æ“ä½œå‘½ä»¤

```sql
-- æŸ¥çœ‹æ‰€æœ‰å…¬å¸
SELECT id, name, status, created_at FROM companies;

-- æŸ¥çœ‹ç”¨æˆ·çš„æ‰€æœ‰å…¬å¸å…³è”
SELECT 
  uc.*,
  c.name as company_name,
  c.status as company_status
FROM user_companies uc
JOIN companies c ON uc.company_id = c.id
WHERE uc.user_id = 'ç”¨æˆ·ID';

-- æŸ¥çœ‹ super_admin ç”¨æˆ·
SELECT user_id, role FROM user_roles WHERE role = 'super_admin';

-- åˆ›å»º super_adminï¼ˆä»…ç¤ºä¾‹ï¼Œå®é™…åº”é€šè¿‡ç®¡ç†åå°æ“ä½œï¼‰
INSERT INTO user_roles (user_id, role)
VALUES ('ç”¨æˆ·ID', 'super_admin');
```

### å¸¸è§é—®é¢˜æ’æŸ¥

**é—®é¢˜1ï¼šæ— æ³•åˆ›å»ºå…¬å¸**
- âœ… æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸º `super_admin`
- âœ… æ£€æŸ¥ `SUPABASE_SERVICE_ROLE_KEY` æ˜¯å¦é…ç½®
- âœ… æ£€æŸ¥ RLS ç­–ç•¥æ˜¯å¦æ­£ç¡®

**é—®é¢˜2ï¼šæ— æ³•åˆ†é…ç”¨æˆ·**
- âœ… æ£€æŸ¥ç›®æ ‡ç”¨æˆ·æ˜¯å¦å·²æ³¨å†Œ
- âœ… æ£€æŸ¥é‚®ç®±æ˜¯å¦å®Œå…¨åŒ¹é…
- âœ… æ£€æŸ¥ RLS ç­–ç•¥æ˜¯å¦æ­£ç¡®

**é—®é¢˜3ï¼šæ— æ³•æŸ¥çœ‹å…¬å¸åˆ—è¡¨**
- âœ… æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
- âœ… æ£€æŸ¥ RLS ç­–ç•¥æ˜¯å¦æ­£ç¡®
- âœ… æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯ä¿¡æ¯

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ä¾›åº”å•†è´¦å·å¼€é€šæŒ‡å—](./ä¾›åº”å•†è´¦å·å¼€é€šæŒ‡å—.md)
- [æƒé™ä¸è§’è‰²è¾¹ç•Œæ¢³ç†](./é˜¶æ®µ2B-4-æƒé™ä¸è§’è‰²è¾¹ç•Œæ¢³ç†.md)
- [å¤šç«¯è·¯ç”±ä¸æƒé™åœ°å›¾](./å¤šç«¯è·¯ç”±ä¸æƒé™åœ°å›¾æ–‡æ¡£.md)

---

**æœ€åæ›´æ–°ï¼š** 2025-01-21
**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0
