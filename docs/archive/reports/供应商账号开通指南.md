# 供应商账号开通指南

## 📋 问题说明

当供应商用户访问 `/supplier/upload` 页面时，如果提示"您还没有关联公司，请联系管理员"，说明该用户还没有被分配到任何供应商公司。

## 🔧 解决方案

### 方法一：通过管理后台开通（推荐）

1. **登录管理后台**
   ```
   http://localhost:3000/dashboard
   ```

2. **进入"供应商管理"**
   - 点击左侧菜单的"供应商管理"
   - 或直接访问：管理后台会自动显示该菜单项

3. **创建供应商公司**
   - 点击"创建供应商"按钮
   - 填写公司信息：
     - 公司名称（必填）
     - 联系人
     - 联系电话
     - 联系邮箱
     - 公司地址
     - 营业执照号（可选）
     - 状态（激活/停用/暂停）
   - 点击"创建公司"

4. **分配用户到公司**
   - 在公司卡片上点击"分配用户"按钮
   - 输入用户的邮箱地址（必须是已注册的用户）
   - 选择角色：
     - **成员（member）**：普通成员
     - **管理员（admin）**：可以管理公司产品
     - **所有者（owner）**：公司所有者
   - 可选择"设为主公司"（一个用户可以有多个公司，但只有一个主公司）
   - 点击"分配用户"

5. **验证**
   - 用户登录后访问 `/supplier/upload`
   - 应该可以正常上传产品了

---

### 方法二：通过 SQL 直接创建（高级）

如果管理后台无法使用，可以直接在 Supabase SQL Editor 中执行：

#### 1. 创建供应商公司

```sql
-- 创建公司
INSERT INTO companies (
  name,
  contact_name,
  contact_phone,
  contact_email,
  address,
  status
) VALUES (
  'XX设备租赁有限公司',
  '张三',
  '13800138000',
  'contact@example.com',
  '北京市朝阳区XXX路XXX号',
  'active'
) RETURNING id;
```

**记录返回的 `id`，这是公司ID（company_id）**

#### 2. 查找用户ID

```sql
-- 通过邮箱查找用户ID
-- 注意：如果users表不存在，需要从auth.users表查找
SELECT id, email 
FROM auth.users 
WHERE email = 'user@example.com';
```

**记录返回的 `id`，这是用户ID（user_id）**

#### 3. 关联用户和公司

```sql
-- 将用户关联到公司
INSERT INTO user_companies (
  user_id,
  company_id,
  role,
  is_primary
) VALUES (
  '用户ID（从上一步获取）',
  '公司ID（从第一步获取）',
  'owner',  -- 或 'admin', 'member'
  true      -- 设为主公司
);
```

---

## ⚠️ 注意事项

### 1. 用户必须先注册

- 用户必须先在系统中注册账号
- 可以通过 `/profile` 页面注册
- 或者通过 Supabase Auth 注册

### 2. 邮箱必须匹配

- 分配用户时，输入的邮箱必须与注册时的邮箱完全一致
- 系统会通过邮箱查找用户ID

### 3. 主公司设置

- 一个用户可以关联多个公司
- 但只能有一个主公司（is_primary = true）
- 如果设置新的主公司，会自动取消旧的主公司标记

### 4. 角色说明

- **owner（所有者）**：拥有公司的完全控制权
- **admin（管理员）**：可以管理公司产品和订单
- **member（成员）**：可以上传产品，但需要审核

---

## 🔍 排查步骤

如果用户仍然无法访问供应商上传页面：

1. **检查用户是否已登录**
   - 访问 `/supplier/upload` 时，确保已登录
   - 如果未登录，会提示"请先登录"

2. **检查 user_companies 表**
   ```sql
   -- 查看用户的所有公司关联
   SELECT 
     uc.*,
     c.name as company_name,
     c.status as company_status
   FROM user_companies uc
   JOIN companies c ON uc.company_id = c.id
   WHERE uc.user_id = '用户ID';
   ```

3. **检查公司状态**
   ```sql
   -- 查看公司状态
   SELECT id, name, status 
   FROM companies 
   WHERE id = '公司ID';
   ```
   - 确保公司状态为 `active`
   - 如果状态为 `inactive` 或 `suspended`，用户可能无法正常使用

4. **检查 RLS 策略**
   - 确保 `user_companies` 表的 RLS 策略已正确配置
   - 确保用户可以查询自己的公司关联

---

## 📝 快速测试

### 测试流程

1. **创建测试公司**
   - 在管理后台创建公司："测试供应商A"

2. **创建测试用户**
   - 注册一个新用户：`test@example.com`

3. **关联用户和公司**
   - 在管理后台，点击"测试供应商A"的"分配用户"
   - 输入：`test@example.com`
   - 角色选择：`owner`
   - 勾选"设为主公司"
   - 点击"分配用户"

4. **验证**
   - 使用 `test@example.com` 登录
   - 访问 `/supplier/upload`
   - 应该可以正常上传产品

---

## 🎯 管理后台访问路径

**供应商管理页面：**
```
http://localhost:3000/dashboard
→ 点击左侧菜单"供应商管理"
```

**功能包括：**
- ✅ 创建供应商公司
- ✅ 查看所有供应商列表
- ✅ 搜索和筛选供应商
- ✅ 分配用户到公司
- ✅ 管理用户角色
- ✅ 更新公司状态
- ✅ 移除用户关联

所有功能已自动保存！


