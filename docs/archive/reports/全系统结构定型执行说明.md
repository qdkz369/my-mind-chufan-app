# å…¨ç³»ç»Ÿç»“æ„å®šå‹ä¸å­—æ®µè¡¥å…¨ - æ‰§è¡Œè¯´æ˜

## ğŸ“‹ æ‰§è¡Œæ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬

åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œï¼š

```sql
-- æ–‡ä»¶ï¼šmigrations/20250125_system_structure_finalization.sql
```

**æ­¤è„šæœ¬å°†ï¼š**
1. âœ… ä¸º `restaurants` è¡¨æ·»åŠ  `user_id` å’Œ `company_id` å­—æ®µ
2. âœ… ä¸º `rental_orders` è¡¨æ·»åŠ  `company_id` å­—æ®µï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
3. âœ… ä¸º `fuel_orders` è¡¨æ·»åŠ  `company_id` å­—æ®µï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
4. âœ… ä¸º `order_main` è¡¨æ·»åŠ  `company_id` å­—æ®µï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
5. âœ… ä¸º `worker_tasks` è¡¨æ·»åŠ  `company_id` å­—æ®µï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
6. âœ… ä¸ºæ‰€æœ‰ä¸šåŠ¡è¡¨å¯ç”¨ RLS å¹¶åˆ›å»ºéš”ç¦»ç­–ç•¥

### ç¬¬äºŒæ­¥ï¼šéªŒè¯å­—æ®µæ·»åŠ 

æ‰§è¡Œä»¥ä¸‹æŸ¥è¯¢éªŒè¯å­—æ®µæ˜¯å¦æ·»åŠ æˆåŠŸï¼š

```sql
SELECT
  table_name AS è¡¨å,
  column_name AS åˆ—å,
  data_type AS æ•°æ®ç±»å‹
FROM information_schema.columns
WHERE table_schema = 'public'
AND table_name IN (
  'restaurants',
  'rental_orders',
  'fuel_orders',
  'order_main',
  'worker_tasks'
)
AND column_name = 'company_id'
ORDER BY table_name;
```

### ç¬¬ä¸‰æ­¥ï¼šéªŒè¯ RLS ç­–ç•¥

æ‰§è¡Œä»¥ä¸‹æŸ¥è¯¢éªŒè¯ RLS ç­–ç•¥æ˜¯å¦åˆ›å»ºæˆåŠŸï¼š

```sql
SELECT
  tablename AS è¡¨å,
  policyname AS ç­–ç•¥åç§°,
  cmd AS æ“ä½œç±»å‹
FROM pg_policies
WHERE tablename IN ('rental_orders', 'fuel_orders', 'order_main', 'worker_tasks')
ORDER BY tablename, policyname;
```

### ç¬¬å››æ­¥ï¼šæ›´æ–°ç°æœ‰æ•°æ®

**é‡è¦ï¼š** å¦‚æœè¡¨ä¸­å·²æœ‰æ•°æ®ï¼Œéœ€è¦æ›´æ–° `company_id` å­—æ®µï¼š

```sql
-- ç¤ºä¾‹ï¼šä¸º rental_orders è¡¨æ›´æ–° company_id
-- å¦‚æœå·²æœ‰ provider_idï¼Œå¯ä»¥å¤åˆ¶åˆ° company_id
UPDATE rental_orders
SET company_id = provider_id
WHERE company_id IS NULL AND provider_id IS NOT NULL;

-- æˆ–è€…æ ¹æ® restaurant_id å…³è”æ›´æ–°
UPDATE rental_orders ro
SET company_id = r.company_id
FROM restaurants r
WHERE ro.restaurant_id = r.id
AND ro.company_id IS NULL
AND r.company_id IS NOT NULL;
```

### ç¬¬äº”æ­¥ï¼šæ›´æ–° restaurants è¡¨æ•°æ®

ç¡®ä¿ `restaurants` è¡¨çš„æ•°æ®æ­£ç¡®ï¼š

```sql
-- æ£€æŸ¥ restaurants è¡¨æ˜¯å¦æœ‰ user_id å’Œ company_id
SELECT 
  id,
  name,
  user_id,
  company_id
FROM restaurants
LIMIT 10;

-- å¦‚æœéœ€è¦ï¼Œä¸º restaurants è¡¨è®¾ç½® company_id
-- æ ¹æ®å®é™…ä¸šåŠ¡é€»è¾‘æ›´æ–°
UPDATE restaurants
SET company_id = 'your-company-id'
WHERE company_id IS NULL;
```

---

## ğŸ”§ ä»£ç ä¿®æ”¹è¯´æ˜

### 1. `lib/auth/user-context.ts` ä¿®æ”¹

**ä¿®æ”¹å†…å®¹ï¼š**
- ä¼˜å…ˆä» `restaurants` è¡¨è·å– `company_id`
- å¦‚æœ `restaurants` è¡¨ä¸­æ²¡æœ‰ï¼Œå›é€€åˆ° `user_companies` è¡¨ï¼ˆå‘åå…¼å®¹ï¼‰

**ä¿®æ”¹ä½ç½®ï¼š** ç¬¬ 294-330 è¡Œ

**é€»è¾‘æµç¨‹ï¼š**
```
1. ä» restaurants è¡¨æŸ¥è¯¢ï¼šuser_id = auth.uid()
2. å¦‚æœæ‰¾åˆ° company_idï¼Œä½¿ç”¨å®ƒ
3. å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå›é€€åˆ° user_companies è¡¨
4. å¦‚æœéƒ½æ‰¾ä¸åˆ°ï¼ŒæŠ›å‡ºé”™è¯¯
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®è¿ç§»é£é™©

- **å¤‡ä»½æ•°æ®**ï¼šåœ¨æ‰§è¡Œè¿ç§»å‰ï¼Œè¯·å¤‡ä»½ç›¸å…³è¡¨çš„æ•°æ®
- **æµ‹è¯•ç¯å¢ƒ**ï¼šå»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒæ‰§è¡Œï¼ŒéªŒè¯æ— è¯¯åå†åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œ
- **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿ `restaurants` è¡¨çš„ `user_id` å’Œ `company_id` æ•°æ®æ­£ç¡®

### 2. RLS ç­–ç•¥å½±å“

- **æŸ¥è¯¢æ€§èƒ½**ï¼šRLS ç­–ç•¥ä¼šåœ¨æ¯æ¬¡æŸ¥è¯¢æ—¶æ‰§è¡Œå­æŸ¥è¯¢ï¼Œå¯èƒ½å½±å“æ€§èƒ½
- **ç´¢å¼•ä¼˜åŒ–**ï¼šç¡®ä¿ `restaurants.user_id` å’Œ `restaurants.company_id` æœ‰ç´¢å¼•
- **æµ‹è¯•éªŒè¯**ï¼šæ‰§è¡Œè¿ç§»åï¼Œæµ‹è¯•å„ä¸ª API è·¯ç”±æ˜¯å¦æ­£å¸¸å·¥ä½œ

### 3. å‘åå…¼å®¹

- **user_companies è¡¨**ï¼šä»£ç ä¸­ä¿ç•™äº†ä» `user_companies` è¡¨è·å– `companyId` çš„å›é€€é€»è¾‘
- **æ¸è¿›è¿ç§»**ï¼šå¯ä»¥é€æ­¥å°†æ•°æ®ä» `user_companies` è¿ç§»åˆ° `restaurants` è¡¨

---

## ğŸ“Š éªŒè¯æ¸…å•

æ‰§è¡Œè¿ç§»åï¼Œè¯·éªŒè¯ä»¥ä¸‹å†…å®¹ï¼š

- [ ] `restaurants` è¡¨æœ‰ `user_id` å’Œ `company_id` å­—æ®µ
- [ ] `rental_orders` è¡¨æœ‰ `company_id` å­—æ®µ
- [ ] `fuel_orders` è¡¨æœ‰ `company_id` å­—æ®µï¼ˆå¦‚æœè¡¨å­˜åœ¨ï¼‰
- [ ] `order_main` è¡¨æœ‰ `company_id` å­—æ®µï¼ˆå¦‚æœè¡¨å­˜åœ¨ï¼‰
- [ ] `worker_tasks` è¡¨æœ‰ `company_id` å­—æ®µï¼ˆå¦‚æœè¡¨å­˜åœ¨ï¼‰
- [ ] æ‰€æœ‰ä¸šåŠ¡è¡¨çš„ RLS å·²å¯ç”¨
- [ ] RLS ç­–ç•¥å·²åˆ›å»ºï¼ˆSELECT, INSERT, UPDATE, DELETEï¼‰
- [ ] `service_role` ç­–ç•¥å·²åˆ›å»ºï¼ˆå…è®¸ API ä½¿ç”¨ serviceRoleKey ç»•è¿‡ RLSï¼‰
- [ ] ç”¨æˆ·ç™»å½•åèƒ½æ­£ç¡®è·å– `companyId`
- [ ] API è·¯ç”±èƒ½æ­£å¸¸æŸ¥è¯¢æ•°æ®

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šæŸ¥è¯¢è¿”å›ç©ºç»“æœ

**å¯èƒ½åŸå› ï¼š**
- `restaurants` è¡¨ä¸­æ²¡æœ‰å¯¹åº” `user_id` çš„è®°å½•
- `restaurants` è¡¨ä¸­çš„ `company_id` ä¸º NULL

**è§£å†³æ–¹æ¡ˆï¼š**
```sql
-- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰å…³è”çš„é¤å…
SELECT * FROM restaurants WHERE user_id = 'user-uuid';

-- æ£€æŸ¥é¤å…æ˜¯å¦æœ‰ company_id
SELECT * FROM restaurants WHERE user_id = 'user-uuid' AND company_id IS NOT NULL;
```

### é—®é¢˜ 2ï¼šRLS ç­–ç•¥é˜»æ­¢æŸ¥è¯¢

**å¯èƒ½åŸå› ï¼š**
- RLS ç­–ç•¥ä¸­çš„å­æŸ¥è¯¢è¿”å›ç©ºç»“æœ
- `restaurants` è¡¨æ²¡æœ‰æ­£ç¡®çš„ç´¢å¼•

**è§£å†³æ–¹æ¡ˆï¼š**
```sql
-- æ£€æŸ¥ç´¢å¼•
SELECT indexname, indexdef 
FROM pg_indexes 
WHERE tablename = 'restaurants';

-- å¦‚æœç¼ºå°‘ç´¢å¼•ï¼Œåˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_restaurants_user_id ON restaurants(user_id);
CREATE INDEX IF NOT EXISTS idx_restaurants_company_id ON restaurants(company_id);
```

### é—®é¢˜ 3ï¼šuser-context.ts è·å–ä¸åˆ° companyId

**å¯èƒ½åŸå› ï¼š**
- `restaurants` è¡¨ä¸­æ²¡æœ‰å¯¹åº”è®°å½•
- `user_companies` è¡¨ä¸­ä¹Ÿæ²¡æœ‰å¯¹åº”è®°å½•

**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥ `restaurants` è¡¨æ•°æ®
- æ£€æŸ¥ `user_companies` è¡¨æ•°æ®
- ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªè¡¨ä¸­æœ‰ç”¨æˆ·çš„å…¬å¸å…³è”

---

## ğŸ“ åç»­å·¥ä½œ

1. **æ•°æ®è¿ç§»**ï¼šå°†ç°æœ‰æ•°æ®ä» `user_companies` è¿ç§»åˆ° `restaurants` è¡¨
2. **ç´¢å¼•ä¼˜åŒ–**ï¼šä¸º `restaurants.user_id` å’Œ `restaurants.company_id` åˆ›å»ºå¤åˆç´¢å¼•
3. **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§ RLS ç­–ç•¥å¯¹æŸ¥è¯¢æ€§èƒ½çš„å½±å“
4. **ä»£ç æ¸…ç†**ï¼šåœ¨æ•°æ®è¿ç§»å®Œæˆåï¼Œç§»é™¤ `user_companies` è¡¨çš„å›é€€é€»è¾‘

---

**æ‰§è¡Œæ—¥æœŸï¼š** 2025-01-25  
**ç‰ˆæœ¬ï¼š** 1.0
