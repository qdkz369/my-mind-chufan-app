# 多端路由与权限地图文档

## 📋 文档说明
本文档详细描述了整个应用的路由结构、权限逻辑和页面状态，用于指导后续的 UI 重构和启动动画集成，确保不会破坏现有功能架构。

**生成时间**：2025-01-20  
**扫描范围**：`app/` 目录下所有路由和页面文件

---

## 一、路径划分

### 1.1 客户端（用户中心）路径

#### 核心用户页面
- **`/user-bound`** - 正式用户事实主页（已绑定设备和主体）
  - 功能：IoT 监控看板、订单事实时间线、关联资产列表
  - 权限：已登录 + 已绑定 `restaurantId` + 已绑定设备
  - 状态：✅ **已完成**

- **`/user-unbound`** - 已注册未绑定设备页面
  - 功能：离线状态 IoT Dashboard、服务展示、设备绑定提示
  - 权限：已登录但未绑定设备或主体
  - 状态：✅ **已完成**

- **`/guest`** - 游客营销门户页面
  - 功能：公开服务展示、营销内容
  - 权限：未登录用户
  - 状态：✅ **已完成**

#### 功能页面
- **`/profile`** - 个人资料页面
  - 功能：用户信息展示/编辑、主题切换、菜单导航
  - 权限：已登录用户
  - 状态：✅ **已完成**

- **`/mall`** - B2B 供应链商城
  - 功能：商品浏览、搜索、分类筛选、购物车
  - 权限：已登录用户
  - 状态：✅ **已完成**

- **`/services`** - 服务列表页面
  - 功能：展示各类服务（燃料配送、维修、清洁等）
  - 权限：已登录用户
  - 状态：✅ **已完成**

- **`/orders`** - 订单列表页面
  - 功能：订单查询、状态筛选
  - 权限：已登录用户
  - 状态：✅ **已完成**

- **`/devices`** - 设备管理页面
  - 功能：设备列表、状态查看、设备详情
  - 权限：已登录用户（需要 Supabase Auth）
  - 状态：✅ **已完成**

- **`/settings`** - 设置页面
  - 功能：主题切换、其他设置选项
  - 权限：已登录用户
  - 状态：✅ **已完成**

#### 业务功能页面
- **`/payment`** - 支付页面
  - 功能：燃料配送下单、支付方式选择、GPS 定位
  - 权限：已登录用户
  - 状态：✅ **已完成**

- **`/payment/callback`** - 支付回调页面
  - 功能：处理支付结果回调
  - 权限：公开（支付回调）
  - 状态：✅ **已完成**

- **`/repair/create`** - 报修创建页面
  - 功能：语音录入报修、图片上传、报修信息提交
  - 权限：已登录用户
  - 状态：✅ **已完成**

- **`/addresses`** - 地址管理页面
  - 功能：收货地址管理
  - 权限：已登录用户
  - 状态：✅ **已完成**

- **`/customer/confirm`** - 客户确认验收页面
  - 功能：设备验收确认
  - 权限：已登录用户
  - 状态：✅ **已完成**

- **`/customer/order`** - 客户订单页面
  - 功能：客户订单查看
  - 权限：已登录用户
  - 状态：✅ **已完成**

- **`/equipment-rental`** - 设备租赁页面
  - 功能：设备租赁浏览和下单
  - 权限：已登录用户
  - 状态：✅ **已完成**

- **`/equipment-showcase`** - 设备展示页面
  - 功能：设备展示和浏览
  - 权限：已登录用户
  - 状态：✅ **已完成**

#### 认证相关页面
- **`/login`** - 登录页面
  - 功能：用户登录
  - 权限：未登录用户
  - 状态：✅ **已完成**

- **`/register`** - 注册页面
  - 功能：用户注册
  - 权限：未登录用户
  - 状态：✅ **已完成**

### 1.2 管理端（Admin/Dashboard）路径

- **`/admin`** - 管理端入口（重定向页面）
  - 功能：自动重定向到 `/dashboard`
  - 权限：管理员角色（`super_admin` 或 `admin`）
  - 状态：✅ **已完成**（重定向逻辑）

- **`/(admin)/dashboard`** - 管理后台主页面
  - 功能：管理看板、供应商管理、产品审核
  - 权限：管理员角色（`super_admin` 或 `admin`）
  - 状态：✅ **已完成**

**注意**：`(admin)` 是 Next.js 路由组（Route Group），不会影响 URL 路径，实际访问路径为 `/dashboard`。

### 1.3 员工端（Worker）路径

- **`/worker`** - 员工端主页面
  - 功能：员工工作台、订单接单、任务管理
  - 权限：员工角色（通过 `user_roles` 表判断）
  - 状态：✅ **已完成**

### 1.4 供应商端（Supplier）路径

- **`/supplier/upload`** - 供应商产品上传页面
  - 功能：设备产品信息上传、图片上传、提交审核
  - 权限：供应商角色（通过 `user_companies` 表关联）
  - 状态：✅ **已完成**

### 1.5 其他路径

- **`/course`** - 课程页面（占位符）
  - 功能：课程展示（疑似另一个应用的页面）
  - 权限：公开
  - 状态：⚠️ **占位符**（使用 `BottomNav` 组件，非主应用功能）

- **`/community`** - 社区页面（占位符）
  - 功能：社区交流（疑似另一个应用的页面）
  - 权限：公开
  - 状态：⚠️ **占位符**（使用 `BottomNav` 组件，非主应用功能）

---

## 二、页面清单

### 2.1 已完成页面（可正常访问）

#### 客户端核心页面
1. ✅ `/user-bound` - 正式用户事实主页
2. ✅ `/user-unbound` - 已注册未绑定设备页面
3. ✅ `/guest` - 游客营销门户页面

#### 客户端功能页面
4. ✅ `/profile` - 个人资料页面
5. ✅ `/mall` - B2B 供应链商城
6. ✅ `/services` - 服务列表页面
7. ✅ `/orders` - 订单列表页面
8. ✅ `/devices` - 设备管理页面
9. ✅ `/settings` - 设置页面

#### 客户端业务功能页面
10. ✅ `/payment` - 支付页面
11. ✅ `/payment/callback` - 支付回调页面
12. ✅ `/repair/create` - 报修创建页面
13. ✅ `/addresses` - 地址管理页面
14. ✅ `/customer/confirm` - 客户确认验收页面
15. ✅ `/customer/order` - 客户订单页面
16. ✅ `/equipment-rental` - 设备租赁页面
17. ✅ `/equipment-showcase` - 设备展示页面

#### 认证相关页面
18. ✅ `/login` - 登录页面
19. ✅ `/register` - 注册页面

#### 管理端页面
20. ✅ `/admin` - 管理端入口（重定向）
21. ✅ `/(admin)/dashboard` - 管理后台主页面

#### 员工端页面
22. ✅ `/worker` - 员工端主页面

#### 供应商端页面
23. ✅ `/supplier/upload` - 供应商产品上传页面

**总计**：23 个已完成页面

### 2.2 占位符页面（空页面或未完成）

1. ⚠️ `/course` - 课程页面（疑似另一个应用的页面，使用 `BottomNav` 组件）
2. ⚠️ `/community` - 社区页面（疑似另一个应用的页面，使用 `BottomNav` 组件）

**注意**：`/course` 和 `/community` 页面使用了不同的导航组件（`BottomNav`），与主应用的 `BottomNavigation` 不同，可能是遗留代码或另一个应用的页面。

---

## 三、身份与权限逻辑

### 3.1 身份判断机制

**核心文件**：`app/page.tsx`（入口调度器）

**判断方式**：**在页面组件中判断，不使用 middleware.ts**

**重要说明**：
- ❌ **没有 `middleware.ts` 文件**（已删除或不存在）
- ✅ **身份判断在 `app/page.tsx` 中执行**
- ✅ **只对根路径 `/` 执行身份调度，其他路径允许直接访问**

### 3.2 身份判断流程

#### 判断顺序（严格顺序）

```typescript
// 位置：app/page.tsx (第 84-207 行)

1. 是否已登录？
   ├─ 检查 Supabase Auth user
   ├─ 检查 localStorage 中的 restaurantId（客户端手机号登录）
   └─ 否 → 重定向到 /guest

2. 是否管理员角色？
   ├─ 查询 user_roles 表
   ├─ 检查 role 是否为 "super_admin" 或 "admin"
   └─ 是 → 重定向到 /dashboard

3. 是否已绑定业务主体？
   ├─ 检查 localStorage 中的 restaurantId
   └─ 否 → 重定向到 /user-unbound

4. 是否已绑定设备/资产？
   ├─ 查询 devices 表（restaurant_id = restaurantId）
   └─ 否 → 重定向到 /user-unbound

5. 默认 → 重定向到 /user-bound
```

#### 核心代码片段

```typescript:app/page.tsx
// 第1步：是否已登录
const { data: { user }, error: authError } = await supabase.auth.getUser()
const restaurantId = typeof window !== "undefined" 
  ? localStorage.getItem("restaurantId") 
  : null

if ((!user || authError) && !restaurantId) {
  router.replace('/guest')
  return
}

// 第2步：是否管理员角色
if (user && !authError) {
  const { data: roleData } = await supabase
    .from("user_roles")
    .select("role")
    .eq("user_id", user.id)
    .maybeSingle()

  if (roleData && (roleData.role === "super_admin" || roleData.role === "admin")) {
    router.replace('/dashboard')
    return
  }
}

// 第3步：是否已绑定业务主体
if (!restaurantId) {
  router.replace('/user-unbound')
  return
}

// 第4步：是否已绑定设备/资产
const { data: devices } = await supabase
  .from("devices")
  .select("device_id")
  .eq("restaurant_id", restaurantId)
  .limit(1)

if (!devices || devices.length === 0) {
  router.replace('/user-unbound')
  return
}

// 第5步：默认 → /user-bound
router.replace('/user-bound')
```

### 3.3 重定向目标映射

| 身份状态 | 重定向目标 | 说明 |
|---------|-----------|------|
| 未登录 | `/guest` | 游客营销门户 |
| 管理员 | `/dashboard` | 管理后台 |
| 已登录但未绑定主体 | `/user-unbound` | 已注册未绑定设备页面 |
| 已登录但未绑定设备 | `/user-unbound` | 已注册未绑定设备页面 |
| 已登录且已绑定 | `/user-bound` | 正式用户事实主页 |

### 3.4 权限验证机制

#### 页面级权限验证

**部分页面有自己的权限验证逻辑**：

1. **`/devices`** - 设备管理页面
   - 在页面组件中检查 Supabase Auth user
   - 如果没有 user，重定向到 `/`

2. **`/supplier/upload`** - 供应商产品上传页面
   - 检查 `user_companies` 表获取 `company_id`
   - 如果没有关联公司，显示提示信息

#### API 级权限验证

**所有 `/api/facts/**` 端点**：
- 位置：`lib/auth/facts-auth.ts`
- 验证逻辑：
  - 检查是否已登录（Supabase Auth 或 `restaurantId`）
  - 验证 `restaurant_id` 是否匹配用户归属
  - 禁止使用 `service role` 密钥

---

## 四、布局文件结构

### 4.1 布局文件清单

**只有一个根布局文件**：

- **`app/layout.tsx`** - 根布局（Root Layout）
  - 控制范围：整个应用
  - 功能：
    - 提供 HTML 结构（`<html>`, `<body>`）
    - 集成 `ThemeProvider`（主题系统）
    - 集成 `Toaster`（消息提示）
    - 集成 `Analytics`（分析工具）
    - 加载全局 CSS（`globals.css`）

### 4.2 布局文件代码结构

```typescript:app/layout.tsx
export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode
}>) {
  return (
    <html lang="zh-CN" suppressHydrationWarning>
      <body className={`${inter.className} antialiased`}>
        <ThemeProvider>
          {children}
          <Toaster />
          <Analytics />
        </ThemeProvider>
      </body>
    </html>
  )
}
```

### 4.3 布局层级说明

```
app/
├── layout.tsx (根布局 - 全局)
│   ├── ThemeProvider (主题系统)
│   ├── {children} (所有页面内容)
│   ├── Toaster (消息提示)
│   └── Analytics (分析工具)
│
├── page.tsx (入口调度器 - 根路径 /)
├── user-bound/
│   └── page.tsx (正式用户主页)
├── guest/
│   └── page.tsx (游客页面)
├── profile/
│   └── page.tsx (个人资料)
└── ... (其他页面)
```

**重要说明**：
- ✅ **只有一个 `layout.tsx`**，位于 `app/` 根目录
- ✅ **没有嵌套布局**（没有 `app/(admin)/layout.tsx` 等）
- ✅ **所有页面共享同一个根布局**
- ✅ **`ThemeProvider` 在根布局中，所有页面都可以访问主题系统**

### 4.4 ThemeProvider 集成说明

**位置**：`app/layout.tsx` 第 43 行

```typescript
<ThemeProvider>
  {children}
  <Toaster />
  <Analytics />
</ThemeProvider>
```

**作用范围**：整个应用的所有页面

**主题系统文件**：
- `lib/styles/theme-context.tsx` - 主题上下文提供者
- `lib/styles/themes.ts` - 主题配置定义
- `app/globals.css` - 主题 CSS 变量

**修复 ThemeProvider 报错的关键点**：
- ✅ `ThemeProvider` 已在根布局中正确集成
- ✅ 所有页面都可以通过 `useTheme()` Hook 访问主题系统
- ✅ 主题状态通过 `localStorage` 持久化（键名：`ios-theme-preference`）

---

## 五、路由组（Route Groups）说明

### 5.1 路由组清单

- **`(admin)`** - 管理端路由组
  - 路径：`app/(admin)/dashboard/`
  - 实际 URL：`/dashboard`（括号不影响 URL）
  - 用途：组织管理端相关页面，不影响 URL 结构

### 5.2 路由组的作用

- **组织代码**：将相关页面放在同一文件夹下
- **不影响 URL**：括号内的文件夹名不会出现在 URL 中
- **可以共享布局**：可以在路由组内创建 `layout.tsx`（当前未使用）

---

## 六、导航组件说明

### 6.1 主应用导航组件

**`components/bottom-navigation.tsx`** - 主应用底部导航
- 使用页面：`/user-bound`, `/guest`, `/profile`, `/mall`, `/services`, `/orders`
- 导航项：
  - 首页 (`/`)
  - 服务 (`/services`)
  - 商城 (`/mall`)
  - 订单 (`/orders`)
  - 我的 (`/profile`)

### 6.2 其他导航组件

**`components/bottom-nav.tsx`** - 其他应用导航（疑似遗留代码）
- 使用页面：`/course`, `/community`
- 导航项：
  - 禅修 (`/`)
  - 课程 (`/course`)
  - 交流 (`/community`)

**注意**：`/course` 和 `/community` 页面使用了不同的导航组件，可能是另一个应用的页面或遗留代码。

---

## 七、关键代码片段

### 7.1 入口调度器核心逻辑

**文件**：`app/page.tsx`

**核心功能**：
1. 显示启动动画（`SplashScreen`）
2. 身份判定和重定向
3. 监听认证状态变化

**关键代码**：

```typescript
// 只对根路径 / 执行身份调度
if (pathname !== "/") {
  console.log(`[Entry Resolver] 当前路径为 ${pathname}，非根路径，跳过身份调度（允许直接访问）`)
  return
}

// 身份判定流程（见上文）
```

### 7.2 主题初始化逻辑

**各页面的主题初始化**：

```typescript
// 示例：app/user-bound/page.tsx
useEffect(() => {
  const savedTheme = typeof window !== "undefined" 
    ? localStorage.getItem("ios-theme-preference") 
    : null
  if (!savedTheme) {
    setTheme("midnight") // 正式用户默认主题
  }
}, [setTheme, theme])
```

**默认主题映射**：
- `/guest` → `apple-white`（信任/克制）
- `/user-unbound` → `tech-blue`（理性/潜力）
- `/user-bound` → `midnight`（专业/操作）

---

## 八、注意事项与建议

### 8.1 UI 重构注意事项

1. **不要破坏身份判定逻辑**
   - `app/page.tsx` 是核心入口调度器，修改需谨慎
   - 确保启动动画不会阻塞身份判定

2. **主题系统集成**
   - `ThemeProvider` 已在根布局中，所有页面都可以使用
   - 确保新组件使用主题变量，不要硬编码颜色

3. **导航组件一致性**
   - 主应用使用 `BottomNavigation`
   - `/course` 和 `/community` 使用 `BottomNav`（可能是遗留代码）

### 8.2 启动动画集成建议

1. **集成位置**：`app/page.tsx`（已集成）
2. **显示时机**：在身份判定之前显示
3. **完成时机**：动画完成后继续身份判定流程
4. **状态管理**：使用 `localStorage` 控制是否显示（已实现）

### 8.3 权限验证建议

1. **页面级验证**：部分页面（如 `/devices`）有自己的权限验证
2. **API 级验证**：所有 `/api/facts/**` 端点都有权限验证
3. **统一验证**：建议未来统一使用 middleware 或统一的权限验证组件

---

## 九、总结

### 9.1 路由统计

- **总页面数**：25 个
- **已完成页面**：23 个
- **占位符页面**：2 个（`/course`, `/community`）

### 9.2 权限体系

- **身份判断**：在 `app/page.tsx` 中执行（不使用 middleware）
- **判断顺序**：未登录 → 管理员 → 未绑定主体 → 未绑定设备 → 已绑定
- **重定向目标**：`/guest`, `/dashboard`, `/user-unbound`, `/user-bound`

### 9.3 布局结构

- **布局文件**：1 个（`app/layout.tsx`）
- **主题系统**：在根布局中集成，所有页面可访问
- **路由组**：1 个（`(admin)`）

### 9.4 关键文件清单

1. **`app/page.tsx`** - 入口调度器（身份判定、重定向）
2. **`app/layout.tsx`** - 根布局（主题系统、全局组件）
3. **`lib/styles/theme-context.tsx`** - 主题上下文
4. **`lib/auth/facts-auth.ts`** - 事实 API 权限验证

---

**文档版本**：v1.0  
**最后更新**：2025-01-20  
**维护者**：Cursor AI Assistant
