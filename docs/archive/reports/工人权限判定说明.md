# 工人权限判定说明文档

## 概述

本文档说明工人端（`app/worker/page.tsx`）的权限判定机制。系统支持多职务工人（一人可同时担任配送员、维修工、安装工），权限基于工人的 `worker_types` 数组进行判定。

---

## 1. 登录与身份验证

### 1.1 登录API (`app/api/worker/login/route.ts`)

**登录方式：**
- 通过工人ID (`worker_id`) 或电话号码 (`phone`) 登录
- 只允许状态为 `active` 的在职工人登录

**返回数据：**
```typescript
{
  success: true,
  data: {
    id: string,              // 工人ID
    name: string,             // 工人姓名
    phone: string | null,     // 电话号码
    worker_types: string[],   // 工人类型数组（支持多类型）
    product_types: string[],  // 产品类型数组（仅配送员）
    status: string            // 状态（active/inactive）
  }
}
```

**关键代码：**
```typescript
// 处理worker_type（可能是单个类型或数组，支持多类型）
let workerTypes: string[] = []
if (Array.isArray(worker.worker_type)) {
  workerTypes = worker.worker_type
} else if (worker.worker_type) {
  workerTypes = [worker.worker_type]
}
```

---

## 2. 权限判定机制

### 2.1 工人类型定义

系统支持三种工人类型：
- `"delivery"` - 配送员
- `"repair"` - 维修工
- `"install"` - 安装工

### 2.2 权限存储

工人信息存储在 `workerInfo` 状态中：
```typescript
const [workerInfo, setWorkerInfo] = useState<{
  id: string
  name: string
  phone: string | null
  worker_types: string[]  // 权限数组，支持多类型
  product_types: string[]  // 产品类型（仅配送员）
} | null>(null)
```

### 2.3 权限判定方式

**判定方法：** 使用 `Array.includes()` 检查 `worker_types` 数组中是否包含特定类型

**示例：**
```typescript
// 检查是否有安装权限
workerInfo?.worker_types?.includes("install")

// 检查是否有配送权限
workerInfo?.worker_types?.includes("delivery")

// 检查是否有维修权限
workerInfo?.worker_types?.includes("repair")
```

---

## 3. 功能模块权限控制

### 3.1 首页功能卡片显示

在首页（`currentView === "home"`），根据 `worker_types` 动态显示功能卡片：

```typescript
// 安装功能 - 需要 "install" 权限
{workerInfo?.worker_types?.includes("install") && (
  <Card onClick={() => setCurrentView("install")}>
    {/* 设备安装登记 */}
  </Card>
)}

// 待接单订单 - 需要 "delivery" 权限
{workerInfo?.worker_types?.includes("delivery") && (
  <Card onClick={() => setCurrentView("orders")}>
    {/* 待接单订单 */}
  </Card>
)}

// 配送功能 - 需要 "delivery" 权限
{workerInfo?.worker_types?.includes("delivery") && (
  <Card onClick={() => setCurrentView("delivery")}>
    {/* 燃料配送 */}
  </Card>
)}

// 维修功能 - 需要 "repair" 权限
{workerInfo?.worker_types?.includes("repair") && (
  <Card onClick={() => setCurrentView("repair")}>
    {/* 故障维修 */}
  </Card>
)}
```

### 3.2 页面访问控制

当用户尝试访问特定功能页面时，系统会检查权限：

**安装页面：**
```typescript
{currentView === "install" && (
  <InstallForm onBack={() => setCurrentView("home")} />
)}
// 注意：安装页面没有显式权限检查，但首页卡片已控制访问
```

**配送页面：**
```typescript
{currentView === "delivery" && workerInfo?.worker_types?.includes("delivery") ? (
  <DeliveryForm onBack={() => setCurrentView("home")} />
) : currentView === "delivery" ? (
  <div>
    <AlertCircle />
    <p>您没有配送权限，请联系管理员</p>
  </div>
) : null}
```

**维修页面：**
```typescript
{currentView === "repair" && workerInfo?.worker_types?.includes("repair") ? (
  <div>
    <WorkerRepairList workerId={workerId} statusFilter={repairStatusFilter} />
  </div>
) : currentView === "repair" ? (
  <div>
    <AlertCircle />
    <p>您没有维修权限，请联系管理员</p>
  </div>
) : null}
```

**待接单订单页面：**
```typescript
{currentView === "orders" && (
  <WorkerOrderList
    productType={productType as any}
    workerId={workerId}
    onAcceptOrder={(orderId) => {
      setCurrentView("delivery")
    }}
  />
)}
// 注意：待接单订单页面没有显式权限检查，但首页卡片已控制访问
```

---

## 4. 多职务支持

### 4.1 多职务工人

系统支持一个工人同时拥有多个职务类型，例如：
- 既是配送员又是维修工：`worker_types: ["delivery", "repair"]`
- 同时是三种类型：`worker_types: ["delivery", "repair", "install"]`

### 4.2 权限叠加

多职务工人的权限是叠加的：
- 如果 `worker_types` 包含 `["delivery", "repair"]`，则该工人可以：
  - 访问配送功能
  - 访问维修功能
  - 但**不能**访问安装功能（除非也包含 `"install"`）

---

## 5. 数据持久化

### 5.1 登录状态保存

登录成功后，工人信息保存到 `localStorage`：
```typescript
localStorage.setItem("workerId", workerData.id)
localStorage.setItem("workerInfo", JSON.stringify(workerData))
```

### 5.2 页面刷新恢复

页面刷新时，从 `localStorage` 恢复登录状态：
```typescript
useEffect(() => {
  const savedWorkerId = localStorage.getItem("workerId")
  const savedWorkerInfo = localStorage.getItem("workerInfo")
  
  if (savedWorkerId && savedWorkerInfo) {
    const info = JSON.parse(savedWorkerInfo)
    setWorkerId(savedWorkerId)
    setWorkerInfo(info)
    setIsLoggedIn(true)
  }
}, [])
```

---

## 6. 安全注意事项

### 6.1 客户端权限控制

⚠️ **重要提示：** 当前的权限判定主要在**客户端**进行，主要用于UI显示控制。

### 6.2 服务端验证建议

为了确保安全性，建议在服务端API中也进行权限验证：

```typescript
// 示例：在API路由中验证权限
export async function POST(request: Request) {
  const workerId = request.headers.get("worker-id")
  const requiredPermission = "delivery" // 需要的权限
  
  // 从数据库查询工人信息
  const worker = await getWorkerById(workerId)
  
  if (!worker.worker_types?.includes(requiredPermission)) {
    return NextResponse.json(
      { error: "权限不足" },
      { status: 403 }
    )
  }
  
  // 继续处理请求...
}
```

---

## 7. 权限判定流程图

```
用户访问工人端
    ↓
检查 localStorage 中的登录信息
    ↓
[有登录信息] → 解析 workerInfo → 显示对应功能卡片
    ↓
[无登录信息] → 显示登录对话框
    ↓
用户输入 ID 或电话 → 调用 /api/worker/login
    ↓
验证成功 → 返回 worker_types 数组
    ↓
保存到 localStorage 和 state
    ↓
根据 worker_types 显示功能卡片
    ↓
用户点击功能卡片
    ↓
检查 worker_types.includes(对应类型)
    ↓
[有权限] → 显示功能页面
[无权限] → 显示"权限不足"提示
```

---

## 8. 数据库结构

### 8.1 workers 表结构

```sql
CREATE TABLE public.workers (
  id UUID PRIMARY KEY,
  name TEXT NOT NULL,
  phone TEXT,
  worker_type TEXT,              -- 单个类型为字符串，多个类型为JSON字符串
  product_types JSONB DEFAULT '[]'::jsonb,  -- 产品类型数组
  status TEXT DEFAULT 'active',  -- active/inactive
  created_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ
);
```

### 8.2 worker_type 存储格式

- **单个类型：** `"delivery"`（字符串）
- **多个类型：** `'["delivery","repair","install"]'`（JSON字符串）

---

## 9. 总结

### 9.1 权限判定核心逻辑

1. **登录时：** 从数据库获取工人的 `worker_type`，转换为 `worker_types` 数组
2. **显示时：** 使用 `workerInfo?.worker_types?.includes(type)` 判断权限
3. **访问时：** 在页面路由处再次检查权限，无权限则显示提示

### 9.2 多职务支持

- 支持一个工人同时拥有多个职务类型
- 权限是叠加的，拥有多个类型即可访问多个功能模块
- 数据存储：单个类型存字符串，多个类型存JSON字符串

### 9.3 安全建议

- 当前实现主要依赖客户端权限控制
- 建议在服务端API中也添加权限验证
- 敏感操作应进行双重验证

---

## 10. 相关文件

- **工人端页面：** `app/worker/page.tsx`
- **登录API：** `app/api/worker/login/route.ts`
- **管理端工人管理：** `app/(admin)/dashboard/page.tsx`

---

**文档生成时间：** 2024年
**最后更新：** 支持多职务工人权限判定

