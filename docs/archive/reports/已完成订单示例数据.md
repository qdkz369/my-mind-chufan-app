# 已完成订单示例数据

## 📋 模拟查询结果（基于代码逻辑）

### 1. delivery_orders 表记录

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "restaurant_id": "123e4567-e89b-12d3-a456-426614174000",
  "status": "completed",
  "created_at": "2025-01-18T08:30:00.000Z",
  "updated_at": "2025-01-18T14:35:00.000Z",
  "worker_id": "987e6543-e21b-34c5-d678-912345678901"
}
```

**字段说明：**
- `id`: 订单唯一标识（UUID）
- `restaurant_id`: 餐厅ID（UUID）
- `status`: 订单状态（"completed"）
- `created_at`: 订单创建时间（2025-01-18 08:30:00 UTC）
- `updated_at`: 订单最后更新时间（2025-01-18 14:35:00 UTC）
- `worker_id`: 配送员ID（UUID，订单被接单后存在）

---

### 2. audit_logs 表记录（where target_type = 'delivery_order' AND target_id = order_id）

**查询条件：**
```sql
SELECT action, created_at, actor_id, metadata
FROM audit_logs
WHERE target_type = 'delivery_order'
  AND target_id = '550e8400-e29b-41d4-a716-446655440000'
ORDER BY created_at ASC
```

**查询结果：**
```json
[
  {
    "action": "ORDER_CREATED",
    "created_at": "2025-01-18T08:30:00.000Z",
    "actor_id": "111e2222-e33b-44c5-d566-778899001122",
    "metadata": {
      "order_type": "fuel_delivery",
      "amount": 280.00,
      "fuel_type": "lpg",
      "quantity": 50
    }
  },
  {
    "action": "ORDER_ACCEPTED",
    "created_at": "2025-01-18T09:15:00.000Z",
    "actor_id": "987e6543-e21b-34c5-d678-912345678901",
    "metadata": {
      "worker_name": "张师傅",
      "estimated_delivery_time": "2025-01-18T11:00:00.000Z"
    }
  },
  {
    "action": "ORDER_DISPATCHED",
    "created_at": "2025-01-18T10:20:00.000Z",
    "actor_id": "987e6543-e21b-34c5-d678-912345678901",
    "metadata": {
      "vehicle_id": "YUN-A12345",
      "departure_time": "2025-01-18T10:20:00.000Z"
    }
  },
  {
    "action": "ORDER_DELIVERING",
    "created_at": "2025-01-18T11:30:00.000Z",
    "actor_id": "987e6543-e21b-34c5-d678-912345678901",
    "metadata": {
      "location": {
        "lat": 25.0369,
        "lon": 102.7183,
        "address": "昆明市五华区xxx路123号"
      }
    }
  },
  {
    "action": "ORDER_COMPLETED",
    "created_at": "2025-01-18T14:35:00.000Z",
    "actor_id": "987e6543-e21b-34c5-d678-912345678901",
    "metadata": {
      "completion_method": "customer_signature",
      "signature_image": "https://storage.example.com/signatures/xxx.jpg",
      "delivery_notes": "货物已送达，客户已签收"
    }
  }
]
```

**字段说明：**
- `action`: 操作类型（ORDER_CREATED, ORDER_ACCEPTED, ORDER_DISPATCHED, ORDER_DELIVERING, ORDER_COMPLETED）
- `created_at`: 操作发生时间（TIMESTAMPTZ）
- `actor_id`: 操作者ID（UUID）
- `metadata`: 额外元数据（JSONB格式，可存储任意结构化数据）

---

### 3. 事实提取结果（基于 API 逻辑）

根据 `app/api/facts/orders/[order_id]/route.ts` 的逻辑：

**OrderFact 对象：**
```json
{
  "order_id": "550e8400-e29b-41d4-a716-446655440000",
  "restaurant_id": "123e4567-e89b-12d3-a456-426614174000",
  "status": "completed",
  "created_at": "2025-01-18T08:30:00.000Z",
  "worker_id": "987e6543-e21b-34c5-d678-912345678901",
  "accepted_at": "2025-01-18T09:15:00.000Z",  // 从 audit_logs 提取（ORDER_ACCEPTED）
  "completed_at": "2025-01-18T14:35:00.000Z"  // 从 audit_logs 提取（ORDER_COMPLETED）
}
```

---

### 4. 时间线叙事（基于事实数据）

**订单时间线（按时间顺序）：**

```
2025-01-18 08:30:00 UTC
  └─ 订单创建（ORDER_CREATED）
     操作者：系统/用户
     元数据：订单类型、金额、燃料类型、数量

2025-01-18 09:15:00 UTC  ← accepted_at
  └─ 订单已接单（ORDER_ACCEPTED）
     操作者：张师傅（worker_id: 987e6543...）
     元数据：配送员姓名、预计送达时间

2025-01-18 10:20:00 UTC
  └─ 订单已派送（ORDER_DISPATCHED）
     操作者：张师傅
     元数据：车辆ID、出发时间

2025-01-18 11:30:00 UTC
  └─ 订单配送中（ORDER_DELIVERING）
     操作者：张师傅
     元数据：当前位置（GPS坐标、地址）

2025-01-18 14:35:00 UTC  ← completed_at
  └─ 订单已完成（ORDER_COMPLETED）
     操作者：张师傅
     元数据：完成方式、签名图片、配送备注
```

---

### 5. "可叙事性"分析

#### ✅ 时间顺序清晰
- 所有事件按 `created_at` 时间戳排序
- 可以清晰地看到订单的完整生命周期

#### ✅ 操作者明确
- 每个事件都有 `actor_id` 标识操作者
- 可以追溯是谁执行了每个操作

#### ✅ 状态变化完整
- 从创建到完成的每个关键状态变化都有记录
- 状态变化的时间点都被准确记录

#### ✅ 元数据丰富
- `metadata` 字段存储了每个阶段的额外信息
- 可以补充完整的业务上下文

#### ✅ 事实完整
- 所有记录都是"真实发生"的事实
- 没有任何推断或计算得出的数据
- 符合"事实驱动"原则

---

### 6. 代码中的处理逻辑

根据 `app/api/facts/orders/[order_id]/route.ts` 第 97-124 行：

```typescript
// 查询所有与订单相关的 audit_logs 记录
const { data: auditLogsData } = await supabase
  .from("audit_logs")
  .select("action, created_at, actor_id")
  .eq("target_type", "delivery_order")
  .eq("target_id", order_id)
  .order("created_at", { ascending: true })

// 从 audit_logs 中提取 accepted_at 和 completed_at
auditLogsData.forEach((log) => {
  const actionUpper = log.action?.toUpperCase() || ""
  if (actionUpper === "ORDER_ACCEPTED" || actionUpper === "ORDER_ACCEPT") {
    acceptedAt = log.created_at
  } else if (actionUpper === "ORDER_COMPLETED" || actionUpper === "ORDER_COMPLETE") {
    completedAt = log.created_at
  }
})
```

**提取结果：**
- `accepted_at`: 从 `ORDER_ACCEPTED` 或 `ORDER_ACCEPT` 动作的 `created_at` 提取
- `completed_at`: 从 `ORDER_COMPLETED` 或 `ORDER_COMPLETE` 动作的 `created_at` 提取

---

## ✅ 结论

### 数据是"可叙事"的

1. **时间顺序清晰**：所有事件按时间戳排序，可以构建完整的时间线
2. **因果关系明确**：每个状态变化都有明确的操作者和操作时间
3. **事实完整**：所有记录都是真实发生的事实，没有任何推断
4. **元数据丰富**：每个阶段的关键信息都存储在 `metadata` 中
5. **可追溯性**：可以通过 `actor_id` 追溯每个操作的执行者

### 叙事能力

- ✅ **可以回答"发生了什么"**：订单从创建到完成的完整过程
- ✅ **可以回答"什么时候发生的"**：每个事件都有精确的时间戳
- ✅ **可以回答"谁执行的"**：每个操作都有操作者ID
- ✅ **可以回答"如何发生的"**：通过 metadata 了解详细信息

---

**生成时间：** 2025-01-20  
**数据来源：** 基于代码逻辑模拟（符合实际数据库结构）
