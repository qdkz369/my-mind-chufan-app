# 押金与账务处理现状说明

> 更新时间：2025-01-25

---

## 📊 整体结论

| 功能模块 | 是否存在 | 完整度 | 说明 |
|---------|---------|--------|------|
| **押金存储** | ✅ 是 | 100% | 存储在 `rental_orders.deposit_amount` |
| **押金计算** | ✅ 是 | 100% | 创建订单时自动计算 |
| **押金退款** | ❌ 否 | 0% | **未实现**，无退款API和流程 |
| **账期管理** | ✅ 是 | 100% | `rental_billing_cycles` 表完整 |
| **账期支付** | ✅ 是 | 100% | 每月支付API更新账期状态 |
| **财务对账** | ❌ 否 | 0% | **未实现**，无对账功能 |
| **财务报表** | ❌ 否 | 0% | **未实现**，无报表生成 |

---

## 1️⃣ 押金处理现状

### ✅ 已实现功能

#### 1.1 押金存储（100% 完成）

**存储位置**：
- `rental_orders.deposit_amount`（订单押金金额）
- `equipment.deposit_amount`（设备参考押金）

**DDL**：
```sql
-- rental_orders 表
deposit_amount DECIMAL(10, 2) DEFAULT 0,  -- 押金

-- equipment 表
deposit_amount DECIMAL(10, 2) DEFAULT 0,  -- 押金
```

#### 1.2 押金计算（100% 完成）

**计算逻辑**（`app/api/equipment/rental/create/route.ts`）：
```typescript
// 计算押金 = 设备押金 × 租赁数量
const depositAmount = equipment.deposit_amount * requestedQuantity

// 写入订单
rentalOrderData.deposit_amount = depositAmount
```

**触发时机**：
- 创建租赁订单时（Step 1：POST /api/equipment/rental/create）

---

### ❌ 未实现功能

#### 1.3 押金退款（0% 完成）

**缺失内容**：
- ❌ 没有独立的 `rental_deposits` 表
- ❌ 没有押金退款 API（如：`POST /api/equipment/rental/deposit/refund`）
- ❌ 没有押金收退流程记录
- ❌ 没有押金退款状态字段

**`payment_status` 字段说明**：
```sql
payment_status VARCHAR(20) DEFAULT 'pending'
-- 状态值：pending, paid, partial, refunded
```
- ⚠️ 虽然有 `refunded` 状态，但**没有退款API和退款流程**来更新这个状态

**业务影响**：
- 无法记录押金的收退时间
- 无法追踪押金退款操作
- 无法生成押金退款凭证

**建议**：
如需实现押金退款，建议：
1. 创建 `rental_deposits` 表（记录押金的收退记录）
2. 创建押金退款 API（`POST /api/equipment/rental/deposit/refund`）
3. 在订单完成/取消时触发押金退款流程
4. 记录退款凭证和时间

---

## 2️⃣ 账务处理现状

### ✅ 已实现功能

#### 2.1 账期管理（100% 完成）

**表结构**：`rental_billing_cycles`
```sql
CREATE TABLE rental_billing_cycles (
  id UUID PRIMARY KEY,
  rental_order_id UUID NOT NULL,        -- 关联订单
  cycle_number INTEGER NOT NULL,        -- 账期序号（1, 2, 3...）
  cycle_month VARCHAR(7) NOT NULL,      -- 账期月份（YYYY-MM）
  due_date DATE NOT NULL,               -- 到期日期
  amount_due DECIMAL(10, 2) NOT NULL,   -- 应收金额
  amount_paid DECIMAL(10, 2) NOT NULL,  -- 已收金额
  status VARCHAR(20) DEFAULT 'pending', -- 状态：pending, paid, partial, overdue
  paid_at TIMESTAMPTZ,                  -- 支付时间
  payment_method VARCHAR(50),           -- 支付方式
  payment_proof TEXT,                   -- 支付凭证
  UNIQUE(rental_order_id, cycle_month)  -- 唯一约束
);
```

**功能说明**：
- ✅ 订单创建时自动生成账期记录（每个订单每月一条）
- ✅ 支付时更新账期状态和已收金额
- ✅ 支持部分支付（`status = 'partial'`）
- ✅ 记录支付凭证和时间

#### 2.2 账期支付（100% 完成）

**API**：`POST /api/equipment/rental/payment/monthly`

**功能**：
- ✅ 每月支付租金
- ✅ 更新 `rental_orders.monthly_payments`（JSONB 历史记录）
- ✅ 更新 `rental_billing_cycles`（账期记录）
- ✅ 记录支付事件到 `rental_events`

**代码示例**（`app/api/equipment/rental/payment/monthly/route.ts`）：
```typescript
// 更新账期记录
const { data: billingCycle } = await supabaseClient
  .from("rental_billing_cycles")
  .select("*")
  .eq("rental_order_id", order_id)
  .eq("cycle_month", payment_month)
  .single()

if (billingCycle) {
  const newAmountPaid = (billingCycle.amount_paid || 0) + paymentAmount
  const newStatus = newAmountPaid >= amountDue ? "paid" : "partial"
  
  await supabaseClient
    .from("rental_billing_cycles")
    .update({
      amount_paid: newAmountPaid,
      status: newStatus,
      paid_at: new Date().toISOString(),
      payment_method: payment_method,
      payment_proof: payment_proof,
    })
    .eq("id", billingCycle.id)
}
```

---

### ❌ 未实现功能

#### 2.3 财务对账（0% 完成）

**缺失内容**：
- ❌ 没有财务对账 API（如：`GET /api/finance/reconciliation`）
- ❌ 没有应收应付汇总功能
- ❌ 没有账期对账报表
- ❌ 没有逾期账期提醒功能

**业务影响**：
- 无法快速查看所有未收账款
- 无法生成应收账款报表
- 无法追踪逾期账期
- 无法进行批量对账

**建议**：
如需实现财务对账，建议：
1. 创建财务对账 API（汇总所有订单的应收应付）
2. 实现逾期账期查询（`status = 'overdue'`）
3. 生成财务报表（Excel/PDF导出）
4. 实现账期提醒功能（邮件/短信）

#### 2.4 财务报表（0% 完成）

**缺失内容**：
- ❌ 没有财务报表生成 API
- ❌ 没有收入统计报表
- ❌ 没有账期统计报表
- ❌ 没有财务报表导出功能（Excel/PDF）

**业务影响**：
- 无法快速查看收入统计
- 无法生成月度/年度报表
- 无法进行财务数据分析

**建议**：
如需实现财务报表，建议：
1. 创建财务报表 API（按时间范围、供应商等维度统计）
2. 实现数据导出功能（Excel/PDF）
3. 实现图表展示（收入趋势、账期分布等）

---

## 3️⃣ 数据流向图

### 押金数据流

```
equipment.deposit_amount (设备参考押金)
        ↓
创建订单时计算
        ↓
rental_orders.deposit_amount (订单押金)
        ↓
❌ 缺少：押金退款流程
❌ 缺少：押金收退记录表
```

### 账务数据流

```
订单创建
    ↓
生成 rental_billing_cycles (账期记录)
    ↓
每月支付
    ↓
更新 rental_billing_cycles (已收金额、状态)
    ↓
✅ 已完成：账期管理、支付记录
❌ 缺少：财务对账、报表生成
```

---

## 4️⃣ 总结与建议

### 当前状态

| 模块 | 存储 | 计算 | 流程 | 对账/报表 |
|------|------|------|------|----------|
| **押金** | ✅ | ✅ | ❌ | ❌ |
| **账务** | ✅ | ✅ | ✅ | ❌ |

### 优先级建议

#### 🔴 高优先级（如果业务需要）

1. **押金退款流程**
   - 创建 `rental_deposits` 表
   - 实现押金退款 API
   - 订单完成/取消时自动触发退款

#### 🟡 中优先级（运营需要）

2. **账期对账功能**
   - 实现逾期账期查询
   - 实现应收应付汇总
   - 实现账期提醒

#### 🟢 低优先级（数据分析）

3. **财务报表**
   - 收入统计报表
   - 账期分析报表
   - 数据导出功能

---

## 5️⃣ 相关 API 清单

### ✅ 已实现 API

| API 路径 | 方法 | 功能 | 状态 |
|---------|------|------|------|
| `/api/equipment/rental/create` | POST | 创建订单（计算押金） | ✅ |
| `/api/equipment/rental/payment/monthly` | POST | 每月支付（更新账期） | ✅ |

### ❌ 缺失 API

| API 路径 | 方法 | 功能 | 状态 |
|---------|------|------|------|
| `/api/equipment/rental/deposit/refund` | POST | 押金退款 | ❌ |
| `/api/finance/reconciliation` | GET | 财务对账 | ❌ |
| `/api/finance/report` | GET | 财务报表 | ❌ |
| `/api/finance/billing/overdue` | GET | 逾期账期查询 | ❌ |

---

**文档版本**：v1.0  
**最后更新**：2025-01-25
