# æ•°æ®åº“å‡çº§è¯´æ˜

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®åº“è¡¨ç»“æ„å‡çº§

#### rental_orders è¡¨æ–°å¢å­—æ®µ
- âœ… `provider_id` - ä¾›åº”å•†IDï¼ˆå…³è” companies è¡¨ï¼‰
- âœ… `funding_type` - è´¢åŠ¡æ¨¡å¼ï¼ˆdirect=ç›´ç§Ÿ, third_party=ç¬¬ä¸‰æ–¹èèµ„ï¼‰
- âœ… `is_signed` - å®¢æˆ·æ˜¯å¦ç­¾æ”¶ï¼ˆå¸ƒå°”å€¼ï¼‰
- âœ… `setup_photo` - å®‰è£…å®Œæˆç…§ç‰‡URLæ•°ç»„

#### æ–°å»ºè¡¨
- âœ… `companies` è¡¨ - ä¾›åº”å•†/å…¬å¸ä¿¡æ¯è¡¨
- âœ… `equipment_catalog` è¡¨ - äº§å“åº“è¡¨ï¼ˆä¾›åº”å•†ä¸Šä¼ äº§å“ï¼Œå®¡æ ¸é€šè¿‡åæ‰èƒ½è¢«å®¢æˆ·çœ‹åˆ°ï¼‰

### 2. SQL è„šæœ¬æ–‡ä»¶

å·²åˆ›å»ºä»¥ä¸‹ SQL è„šæœ¬ï¼š

1. **å‡çº§rental_ordersè¡¨_æ·»åŠ ä¾›åº”å•†å’Œäº¤ä»˜å‡­è¯.sql**
   - åˆ›å»º companies è¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
   - ä¸º rental_orders è¡¨æ·»åŠ æ–°å­—æ®µ
   - åˆ›å»ºç´¢å¼•å’Œæ³¨é‡Š

2. **åˆ›å»ºequipment_catalogè¡¨.sql**
   - åˆ›å»ºäº§å“åº“è¡¨
   - åŒ…å«å®¡æ ¸æœºåˆ¶ï¼ˆis_approved, approved_at, approved_by, rejection_reasonï¼‰
   - åˆ›å»º RLS ç­–ç•¥

### 3. API æ›´æ–°

#### å·²æ›´æ–°çš„ API
- âœ… `app/api/equipment/rental/create/route.ts` - æ”¯æŒæ–°å­—æ®µï¼ˆprovider_id, funding_typeï¼‰
- âœ… `app/api/equipment/rental/update/route.ts` - æ”¯æŒæ›´æ–°æ–°å­—æ®µï¼ˆis_signed, setup_photo, funding_type, provider_idï¼‰
- âœ… `app/api/equipment/rental/admin/list/route.ts` - æŸ¥è¯¢æ—¶åŒ…å« companies å…³è”

#### æ–°å»ºçš„ API
- âœ… `app/api/equipment/catalog/list/route.ts` - è·å–äº§å“åº“åˆ—è¡¨
- âœ… `app/api/equipment/catalog/create/route.ts` - ä¾›åº”å•†ä¸Šä¼ äº§å“
- âœ… `app/api/equipment/catalog/approve/route.ts` - å®¡æ ¸äº§å“

### 4. å‰ç«¯ä»£ç æ›´æ–°

#### å·²æ›´æ–°çš„çŠ¶æ€
- âœ… `newRentalOrder` çŠ¶æ€æ·»åŠ äº† `provider_id` å’Œ `funding_type`
- âœ… æ·»åŠ äº† `companyList` çŠ¶æ€ç”¨äºå­˜å‚¨ä¾›åº”å•†åˆ—è¡¨
- âœ… `loadEquipmentAndRestaurants` å‡½æ•°æ·»åŠ äº†åŠ è½½å…¬å¸åˆ—è¡¨çš„é€»è¾‘

#### å·²æ›´æ–°çš„æ˜¾ç¤º
- âœ… è®¢å•åˆ—è¡¨ä¸­æ·»åŠ äº†ä¾›åº”å•†ã€è´¢åŠ¡æ¨¡å¼ã€ç­¾æ”¶çŠ¶æ€çš„æ˜¾ç¤º

---

## ğŸ“‹ éœ€è¦æ‰§è¡Œçš„æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ‰§è¡Œæ•°æ®åº“å‡çº§è„šæœ¬

åœ¨ Supabase SQL Editor ä¸­æŒ‰é¡ºåºè¿è¡Œï¼š

1. **å‡çº§rental_ordersè¡¨_æ·»åŠ ä¾›åº”å•†å’Œäº¤ä»˜å‡­è¯.sql**
   ```sql
   -- è¿è¡Œæ­¤è„šæœ¬æ·»åŠ æ–°å­—æ®µ
   ```

2. **åˆ›å»ºequipment_catalogè¡¨.sql**
   ```sql
   -- è¿è¡Œæ­¤è„šæœ¬åˆ›å»ºäº§å“åº“è¡¨
   ```

### ç¬¬äºŒæ­¥ï¼šéªŒè¯æ•°æ®åº“ç»“æ„

è¿è¡Œä»¥ä¸‹ SQL éªŒè¯å­—æ®µæ˜¯å¦æ·»åŠ æˆåŠŸï¼š

```sql
-- æ£€æŸ¥ rental_orders è¡¨çš„æ–°å­—æ®µ
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_schema = 'public' 
  AND table_name = 'rental_orders'
  AND column_name IN ('provider_id', 'funding_type', 'is_signed', 'setup_photo')
ORDER BY column_name;

-- æ£€æŸ¥ equipment_catalog è¡¨æ˜¯å¦å­˜åœ¨
SELECT COUNT(*) AS table_exists
FROM information_schema.tables
WHERE table_schema = 'public' 
  AND table_name = 'equipment_catalog';
```

### ç¬¬ä¸‰æ­¥ï¼šå®Œå–„å‰ç«¯ä»£ç ï¼ˆéœ€è¦æ‰‹åŠ¨å®Œæˆï¼‰

ç”±äºæ–‡ä»¶è¾ƒå¤§ï¼Œä»¥ä¸‹åŠŸèƒ½éœ€è¦æ‰‹åŠ¨æ·»åŠ åˆ°å‰ç«¯ï¼š

#### 1. è®¢å•è¯¦æƒ…å¯¹è¯æ¡† - æ·»åŠ æ–°å­—æ®µæ˜¾ç¤º

åœ¨ `renderEquipmentRental` å‡½æ•°çš„è®¢å•è¯¦æƒ…å¯¹è¯æ¡†ä¸­ï¼Œåœ¨"è´¹ç”¨ä¿¡æ¯"éƒ¨åˆ†åæ·»åŠ ï¼š

```tsx
{/* ä¾›åº”å•†å’Œè´¢åŠ¡ä¿¡æ¯ */}
<div className="bg-slate-800/50 p-4 rounded-lg">
  <h4 className="text-lg font-semibold text-white mb-3">ä¾›åº”å•†å’Œè´¢åŠ¡ä¿¡æ¯</h4>
  <div className="space-y-2 text-sm">
    {selectedRentalOrder.companies && (
      <div className="flex justify-between">
        <span className="text-slate-400">ä¾›åº”å•†ï¼š</span>
        <span className="text-white">{selectedRentalOrder.companies.name}</span>
      </div>
    )}
    <div className="flex justify-between">
      <span className="text-slate-400">è´¢åŠ¡æ¨¡å¼ï¼š</span>
      <Badge className={selectedRentalOrder.funding_type === "direct" ? "bg-blue-500/20 text-blue-400" : "bg-purple-500/20 text-purple-400"}>
        {selectedRentalOrder.funding_type === "direct" ? "ç›´ç§Ÿ" : "ç¬¬ä¸‰æ–¹èèµ„"}
      </Badge>
    </div>
  </div>
</div>

{/* äº¤ä»˜å‡­è¯ */}
<div className="bg-slate-800/50 p-4 rounded-lg">
  <h4 className="text-lg font-semibold text-white mb-3">äº¤ä»˜å‡­è¯</h4>
  <div className="space-y-2 text-sm">
    <div className="flex justify-between items-center">
      <span className="text-slate-400">å®¢æˆ·ç­¾æ”¶ï¼š</span>
      <div className="flex items-center gap-2">
        <input
          type="checkbox"
          checked={selectedRentalOrder.is_signed || false}
          onChange={async (e) => {
            await handleUpdateRentalOrderField(selectedRentalOrder.id, "is_signed", e.target.checked)
          }}
          className="h-4 w-4 rounded border-slate-600 bg-slate-700 text-blue-600"
        />
        <span className="text-white">{selectedRentalOrder.is_signed ? "å·²ç­¾æ”¶" : "æœªç­¾æ”¶"}</span>
      </div>
    </div>
    {selectedRentalOrder.setup_photo && selectedRentalOrder.setup_photo.length > 0 && (
      <div>
        <span className="text-slate-400">å®‰è£…ç…§ç‰‡ï¼š</span>
        <div className="grid grid-cols-2 gap-2 mt-2">
          {selectedRentalOrder.setup_photo.map((photo: string, index: number) => (
            <img
              key={index}
              src={photo}
              alt={`å®‰è£…ç…§ç‰‡ ${index + 1}`}
              className="w-full h-32 object-cover rounded border border-slate-600"
            />
          ))}
        </div>
      </div>
    )}
  </div>
</div>
```

#### 2. æ–°å¢è®¢å•å¯¹è¯æ¡† - æ·»åŠ æ–°å­—æ®µè¾“å…¥

åœ¨æ–°å¢è®¢å•å¯¹è¯æ¡†ä¸­ï¼Œåœ¨"æ”¯ä»˜æ–¹å¼"å­—æ®µåæ·»åŠ ï¼š

```tsx
<div>
  <Label className="text-slate-300 mb-2 block">ä¾›åº”å•†</Label>
  <Select
    value={newRentalOrder.provider_id}
    onValueChange={(value) => setNewRentalOrder({ ...newRentalOrder, provider_id: value })}
  >
    <SelectTrigger className="bg-slate-700 border-slate-600 text-white">
      <SelectValue placeholder="é€‰æ‹©ä¾›åº”å•†ï¼ˆå¯é€‰ï¼‰" />
    </SelectTrigger>
    <SelectContent>
      <SelectItem value="">æ— </SelectItem>
      {companyList.map((company) => (
        <SelectItem key={company.id} value={company.id}>
          {company.name}
        </SelectItem>
      ))}
    </SelectContent>
  </Select>
</div>
<div>
  <Label className="text-slate-300 mb-2 block">è´¢åŠ¡æ¨¡å¼</Label>
  <Select
    value={newRentalOrder.funding_type}
    onValueChange={(value) => setNewRentalOrder({ ...newRentalOrder, funding_type: value })}
  >
    <SelectTrigger className="bg-slate-700 border-slate-600 text-white">
      <SelectValue />
    </SelectTrigger>
    <SelectContent>
      <SelectItem value="direct">ç›´ç§Ÿ</SelectItem>
      <SelectItem value="third_party">ç¬¬ä¸‰æ–¹èèµ„</SelectItem>
    </SelectContent>
  </Select>
</div>
```

#### 3. æ·»åŠ æ›´æ–°å­—æ®µçš„å¤„ç†å‡½æ•°

åœ¨ `handleUpdateRentalOrderPaymentStatus` å‡½æ•°åæ·»åŠ ï¼š

```tsx
// æ›´æ–°è®¢å•å­—æ®µï¼ˆé€šç”¨å‡½æ•°ï¼‰
const handleUpdateRentalOrderField = useCallback(async (orderId: string, field: string, value: any) => {
  setIsUpdatingRentalOrder(true)
  try {
    const response = await fetch("/api/equipment/rental/update", {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: orderId, [field]: value }),
    })
    const result = await response.json()
    if (result.success) {
      await loadRentalOrders()
      setSelectedRentalOrder({ ...selectedRentalOrder!, [field]: value })
    } else {
      alert(`æ›´æ–°å¤±è´¥: ${result.error}`)
    }
  } catch (err: any) {
    alert(`æ›´æ–°å¤±è´¥: ${err.message}`)
  } finally {
    setIsUpdatingRentalOrder(false)
  }
}, [selectedRentalOrder, loadRentalOrders])
```

---

## ğŸ¯ åŠŸèƒ½è¯´æ˜

### 1. ä¾›åº”å•†å…³è”
- æ¯ä¸ªç§Ÿèµè®¢å•å¯ä»¥å…³è”ä¸€ä¸ªä¾›åº”å•†ï¼ˆcompanies è¡¨ï¼‰
- åœ¨è®¢å•åˆ—è¡¨å’Œè¯¦æƒ…ä¸­æ˜¾ç¤ºä¾›åº”å•†åç§°
- æ–°å¢è®¢å•æ—¶å¯ä»¥é€‰æ‹©ä¾›åº”å•†

### 2. è´¢åŠ¡æ¨¡å¼
- **ç›´ç§Ÿï¼ˆdirectï¼‰**ï¼šå®¢æˆ·ç›´æ¥å‘å¹³å°æ”¯ä»˜ç§Ÿé‡‘
- **ç¬¬ä¸‰æ–¹èèµ„ï¼ˆthird_partyï¼‰**ï¼šé€šè¿‡ç¬¬ä¸‰æ–¹é‡‘èæœºæ„èèµ„

### 3. äº¤ä»˜å‡­è¯
- **is_signed**ï¼šå®¢æˆ·æ˜¯å¦ç­¾æ”¶ï¼ˆå¯åœ¨è¯¦æƒ…å¯¹è¯æ¡†ä¸­å‹¾é€‰ï¼‰
- **setup_photo**ï¼šå®‰è£…å®Œæˆç…§ç‰‡æ•°ç»„ï¼ˆå¯ä¸Šä¼ å¤šå¼ ç…§ç‰‡ï¼‰

### 4. äº§å“åº“ï¼ˆequipment_catalogï¼‰
- ä¾›åº”å•†å¯ä»¥ä¸Šä¼ äº§å“ä¿¡æ¯
- ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡åï¼ˆis_approved = trueï¼‰æ‰èƒ½è¢«å®¢æˆ·çœ‹åˆ°
- æ”¯æŒå®¡æ ¸æ‹’ç»ï¼Œå¹¶è®°å½•æ‹’ç»åŸå› 

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ‰§è¡Œé¡ºåº**ï¼šå¿…é¡»å…ˆè¿è¡Œæ•°æ®åº“å‡çº§è„šæœ¬ï¼Œå†åˆ·æ–°å‰ç«¯é¡µé¢
2. **companies è¡¨**ï¼šå¦‚æœ companies è¡¨å·²å­˜åœ¨ï¼Œè„šæœ¬ä¼šè·³è¿‡åˆ›å»º
3. **æ•°æ®è¿ç§»**ï¼šç°æœ‰è®¢å•çš„ `provider_id` å’Œ `funding_type` å­—æ®µå°†ä¸º NULLï¼Œéœ€è¦æ‰‹åŠ¨è¡¥å……
4. **RLS ç­–ç•¥**ï¼šequipment_catalog è¡¨å·²åˆ›å»º RLS ç­–ç•¥ï¼Œç¡®ä¿æƒé™æ­£ç¡®

---

## ğŸ“ ä¸‹ä¸€æ­¥

1. âœ… æ‰§è¡Œæ•°æ®åº“å‡çº§è„šæœ¬
2. âœ… éªŒè¯æ•°æ®åº“ç»“æ„
3. â³ å®Œå–„å‰ç«¯ä»£ç ï¼ˆæŒ‰ç…§ä¸Šé¢çš„è¯´æ˜æ‰‹åŠ¨æ·»åŠ ï¼‰
4. â³ æµ‹è¯•æ–°åŠŸèƒ½

æ‰€æœ‰ä»£ç å·²è‡ªåŠ¨ä¿å­˜ï¼


