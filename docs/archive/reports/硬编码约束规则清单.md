# ç¡¬ç¼–ç çº¦æŸè§„åˆ™æ¸…å•

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£åˆ—å‡ºäº†ä»£ç åº“ä¸­æ‰€æœ‰ç¡¬ç¼–ç çš„"æ³•å¾‹çº¦æŸ"ã€"çºªå¾‹è§„åˆ™"å’Œ"åˆè§„æ€§æ£€æŸ¥"é€»è¾‘ã€‚

---

## 1. æƒé™ä¸è®¤è¯çº¦æŸ

### 1.1 `lib/auth/user-context.ts` - ç»Ÿä¸€æƒé™å…¥å£

**æ–‡ä»¶ä½ç½®ï¼š** `lib/auth/user-context.ts`

**ç¡¬ç¼–ç è§„åˆ™ï¼š**
```typescript
/**
 * è§„åˆ™ï¼š
 * 1. ä» Supabase Auth session ä¸­è·å– userId
 * 2. ä» user_roles è¡¨è·å– role
 * 3. å¦‚æœ role â‰  super_adminï¼Œå¿…é¡»ä» user_companies è·å– company_id
 * 4. å¦‚æœæŸ¥ä¸åˆ° company_idï¼ˆé super_adminï¼‰ï¼Œç›´æ¥æŠ›å‡º 403 é”™è¯¯
 * 5. super_admin å…è®¸ companyId ä¸º undefined
 * 
 * ç¦æ­¢ API è‡ªè¡ŒæŸ¥è¯¢ user_roles æˆ– user_companies è¡¨ï¼Œå¿…é¡»ä½¿ç”¨æ­¤æ¨¡å—ã€‚
 */
```

**çº¦æŸç‚¹ï¼š**
- ç¬¬ 9 è¡Œï¼š`å¿…é¡»ä» user_companies è·å– company_id`
- ç¬¬ 10 è¡Œï¼š`å¦‚æœæŸ¥ä¸åˆ° company_idï¼ˆé super_adminï¼‰ï¼Œç›´æ¥æŠ›å‡º 403 é”™è¯¯`
- ç¬¬ 13 è¡Œï¼š`ç¦æ­¢ API è‡ªè¡ŒæŸ¥è¯¢ user_roles æˆ– user_companies è¡¨`

**å®é™…ä»£ç ï¼š**
```typescript
// ç¬¬ 294-330 è¡Œ
if (role !== "super_admin") {
  // ä» restaurants è¡¨è·å– company_idï¼ˆæœ€æ–°ä¿®æ”¹ï¼‰
  // å¦‚æœæŸ¥ä¸åˆ° company_idï¼Œç›´æ¥æŠ›å‡ºé”™è¯¯
  if (!companyId) {
    throw new Error("æƒé™ä¸è¶³ï¼šç”¨æˆ·æœªå…³è”ä»»ä½•å…¬å¸")
  }
}
```

---

## 2. äº‹å®ç³»ç»Ÿçº¦æŸï¼ˆFacts Systemï¼‰

### 2.1 `lib/facts/contracts/order.fact.ts` - äº‹å®å¥‘çº¦çº¦æŸ

**æ–‡ä»¶ä½ç½®ï¼š** `lib/facts/contracts/order.fact.ts`

**ç¡¬ç¼–ç è§„åˆ™ï¼š**

#### è§„åˆ™ 1ï¼šç¦æ­¢æ¨æ–­æ—¶é—´
```typescript
/**
 * - ç¦æ­¢ä»»ä½•"æ¨æ–­""é»˜è®¤""å…œåº•æ—¶é—´"
 * - ç©ºå€¼å¿…é¡»æ˜ç¡®è¡¨è¾¾"äº‹å®ä¸å­˜åœ¨"æˆ–"å°šæœªå‘ç”Ÿ"
 */
```

#### è§„åˆ™ 2ï¼šaccepted_at / completed_at åªèƒ½æ¥è‡ª audit_logs
```typescript
/**
 * è®¢å•è¢«æ¥å•æ—¶é—´
 * 
 * çº¦æŸï¼š
 * - åªèƒ½æ¥è‡ª audit_logs è¡¨
 * - ä¸¥ç¦ä» delivery_orders.status æ¨æ–­
 * - ä¸¥ç¦ä½¿ç”¨ delivery_orders.updated_at ä½œä¸ºå…œåº•
 * - ä¸¥ç¦ UI è‡ªè¡Œç”Ÿæˆæˆ–æ¨æ–­æ—¶é—´
 */
accepted_at: string | null
```

#### è§„åˆ™ 3ï¼šéªŒè¯å‡½æ•°å¼ºåˆ¶æ£€æŸ¥
```typescript
// ç¬¬ 318-328 è¡Œ
// éªŒè¯ accepted_at å’Œ completed_at ä¸èƒ½æ˜¯ undefined
if (fact.accepted_at === undefined) {
  errors.push("accepted_at å¿…é¡»æ˜¯ string | nullï¼Œä¸èƒ½æ˜¯ undefined")
}
if (fact.completed_at === undefined) {
  errors.push("completed_at å¿…é¡»æ˜¯ string | nullï¼Œä¸èƒ½æ˜¯ undefined")
}
```

### 2.2 `lib/facts/governance/order.fact.guard.ts` - äº‹å®æ²»ç†çº¦æŸ

**æ–‡ä»¶ä½ç½®ï¼š** `lib/facts/governance/order.fact.guard.ts`

**ç¡¬ç¼–ç è§„åˆ™ï¼š**
```typescript
/**
 * - æ‰€æœ‰è¿åäº‹å®å¥‘çº¦çš„æƒ…å†µå¿…é¡»è¢«è®°å½•ï¼Œä½†ä¸å¾—é˜»æ–­ API å“åº”
 * - æ‰€æœ‰å¼‚å¸¸å¿…é¡»é€šè¿‡ fact_warnings æ˜¾æ€§æš´éœ²
 * - åœ¨ API å±‚è¿”å›æ•°æ®å‰å¼ºåˆ¶æ‰§è¡Œäº‹å®å¥‘çº¦æ£€æŸ¥
 */
```

### 2.3 Facts API ç¦æ­¢äº‹é¡¹

**æ–‡ä»¶ä½ç½®ï¼š** `app/api/facts/**/*.ts`

**ç¡¬ç¼–ç è§„åˆ™ï¼š**

#### è§„åˆ™ 1ï¼šç¦æ­¢ä¸šåŠ¡åˆ¤æ–­
```typescript
/**
 * - UI ç¦æ­¢åŸºäº Facts è¿›è¡Œä¸šåŠ¡åˆ¤æ–­æˆ–æµç¨‹æ§åˆ¶
 * - UI ç¦æ­¢æ ¹æ® fact_warnings æˆ– fact_health è‡ªåŠ¨è§¦å‘ä¸šåŠ¡åŠ¨ä½œ
 * - UI ç¦æ­¢å°† Facts å½“ä½œä¸šåŠ¡ API ä½¿ç”¨
 */
```

#### è§„åˆ™ 2ï¼šç¦æ­¢æ•°æ®åº“å†™å…¥
```typescript
/**
 * Facts API æ˜¯çº¯åªè¯»ç³»ç»Ÿï¼Œä¸æ‰§è¡Œä»»ä½•æ•°æ®åº“å†™å…¥æ“ä½œã€‚
 * ç¦æ­¢æ“ä½œï¼š
 * - ç¦æ­¢ INSERTã€UPDATEã€DELETEã€UPSERT ç­‰å†™å…¥æ“ä½œ
 * - ç¦æ­¢ä¿®æ”¹ audit_logsã€delivery_orders ç­‰åŸå§‹æ•°æ®è¡¨
 */
```

#### è§„åˆ™ 3ï¼šç¦æ­¢è¿”å›é‡‘èå­—æ®µ
```typescript
// app/api/facts/restaurant/[restaurant_id]/stats/route.ts ç¬¬ 94 è¡Œ
// âš ï¸ Facts API ç¦æ­¢ï¼šä¸æŸ¥è¯¢ä»»ä½•é‡‘èå­—æ®µï¼ˆamount, rate, installment, repayment, interestï¼‰
// âš ï¸ Facts API ç¦æ­¢ï¼šä¸è®¡ç®—ä»»ä½•é‡‘é¢æˆ–è´¹ç”¨
```

---

## 3. ç§Ÿèµç³»ç»Ÿçº¦æŸï¼ˆRental Systemï¼‰

### 3.1 `lib/rental/README.md` - ç§Ÿèµç³»ç»Ÿç¦æ­¢äº‹é¡¹

**æ–‡ä»¶ä½ç½®ï¼š** `lib/rental/README.md`

**ç¡¬ç¼–ç è§„åˆ™ï¼š**

#### è§„åˆ™ 1ï¼šç¦æ­¢åå‘å½±å“ Facts
```markdown
- **ç¦æ­¢**ï¼šåœ¨ç§Ÿèµé€»è¾‘ä¸­ä¿®æ”¹ Facts è¡¨ç»“æ„
- **ç¦æ­¢**ï¼šå‘ Facts API è¿”å›ç»“æœä¸­æ·»åŠ ç§Ÿèµç›¸å…³å­—æ®µ
- **ç¦æ­¢**ï¼šåœ¨ Facts è¡¨ä¸­æ·»åŠ ç§ŸèµçŠ¶æ€å­—æ®µ
- **åŸåˆ™**ï¼šç§Ÿèµç³»ç»Ÿåªèƒ½æ¶ˆè´¹ Factsï¼Œä¸èƒ½æ±¡æŸ“ Facts
```

#### è§„åˆ™ 2ï¼šç¦æ­¢åˆ¤æ–­è®¾å¤‡å¯ç”¨æ€§
```markdown
- **ç¦æ­¢**ï¼šåœ¨ç§Ÿèµé€»è¾‘ä¸­åˆ¤æ–­è®¾å¤‡æ˜¯å¦"å¯ç”¨"
- **ç¦æ­¢**ï¼šåŸºäºç§ŸèµçŠ¶æ€å†³å®šè®¾å¤‡æ˜¯å¦å¯åˆ†é…
- **ç¦æ­¢**ï¼šåŸºäºç§ŸèµåˆåŒçŠ¶æ€é˜»æ­¢è®¢å•åˆ›å»º
```

#### è§„åˆ™ 3ï¼šç¦æ­¢å¼•å…¥æ”¯ä»˜/ç»“ç®—/å‘ç¥¨
```markdown
- **ç¦æ­¢**ï¼šå¼•å…¥ `payment` ç›¸å…³é€»è¾‘
- **ç¦æ­¢**ï¼šå¼•å…¥ `settlement`ï¼ˆç»“ç®—ï¼‰ç›¸å…³é€»è¾‘
- **ç¦æ­¢**ï¼šå¼•å…¥ `invoice`ï¼ˆå‘ç¥¨ï¼‰ç›¸å…³é€»è¾‘
```

### 3.2 Usage Snapshot ç¦æ­¢äº‹é¡¹

**æ–‡ä»¶ä½ç½®ï¼š** `lib/rental/usage-snapshot.ts` å’Œ `app/api/admin/rental/usage-snapshots/route.ts`

**ç¡¬ç¼–ç è§„åˆ™ï¼š**

#### è§„åˆ™ 1ï¼šç¦æ­¢ç”Ÿæˆè´¦å•
```typescript
/**
 * 1. ç¦æ­¢ç”Ÿæˆè´¦å•ï¼šç¦æ­¢åŸºäº Usage Snapshot ç”Ÿæˆè´¦å•ï¼ˆbill/invoiceï¼‰
 * 2. ç¦æ­¢ç”Ÿæˆåº”æ”¶åº”ä»˜ï¼šç¦æ­¢åŸºäº Usage Snapshot ç”Ÿæˆåº”æ”¶/åº”ä»˜
 * 3. ç¦æ­¢è®¡ç®—é‡‘é¢ï¼šç¦æ­¢åŸºäº usage_value è®¡ç®—ä»»ä½•é‡‘é¢
 * 4. ç¦æ­¢å¯¹è®¢å•çŠ¶æ€äº§ç”Ÿä»»ä½•åå‘å½±å“
 * 5. ç¦æ­¢åœ¨ Snapshot ä¸­ä¿®æ”¹æˆ–çº æ­£ Facts
 */
```

#### è§„åˆ™ 2ï¼šç¦æ­¢ç¼–è¾‘ usage_value
```typescript
// app/api/admin/rental/usage-snapshots/route.ts ç¬¬ 227 è¡Œ
// å¦‚æœå·²ç»æ˜¯ locked çŠ¶æ€ï¼Œä¸å…è®¸ä¿®æ”¹
if (existingSnapshot.status === 'locked') {
  return NextResponse.json({
    success: false,
    error: "locked çŠ¶æ€çš„å¿«ç…§ä¸å…è®¸ä¿®æ”¹"
  }, { status: 400 })
}
```

---

## 4. ä¸»é¢˜ç³»ç»Ÿçº¦æŸï¼ˆTheme Systemï¼‰

### 4.1 `lib/styles/themes.ts` - ä¸»é¢˜çº¦æŸ

**æ–‡ä»¶ä½ç½®ï¼š** `lib/styles/themes.ts`

**ç¡¬ç¼–ç è§„åˆ™ï¼š**

#### è§„åˆ™ 1ï¼šBase Theme ä¸å…è®¸åˆ‡æ¢
```typescript
/**
 * - Base Theme ä¸å…è®¸è¢«åˆ‡æ¢ã€ä¸å‚ä¸ä¸»é¢˜é€‰æ‹©ã€ä¸ä¿å­˜åˆ° localStorage
 * - Base Theme æ˜¯å”¯ä¸€çš„åŸºç¡€ä¸»é¢˜ï¼Œä¸å…è®¸è¢«åˆ‡æ¢
 */
```

#### è§„åˆ™ 2ï¼šç¦æ­¢ç›´æ¥å¤åˆ¶ Design Baseline
```typescript
/**
 * - æ‰€æœ‰æ–°ä¸»é¢˜å¿…é¡»åŸºäº Design Baseline çš„å·®å¼‚ç”Ÿæˆ
 * - ç¦æ­¢ç›´æ¥å¤åˆ¶ Design Baseline æ–‡ä»¶
 * - Theme diff å¿…é¡»æ˜¾å¼å£°æ˜ override å­—æ®µ
 */
```

### 4.2 `lib/styles/system-state.ts` - ä¸»é¢˜åˆ‡æ¢çº¦æŸ

**æ–‡ä»¶ä½ç½®ï¼š** `lib/styles/system-state.ts`

**ç¡¬ç¼–ç è§„åˆ™ï¼š**
```typescript
/**
 * 1. ä¸»é¢˜åˆ‡æ¢ç”± systemState é©±åŠ¨ï¼ˆç¦æ­¢ä¸šåŠ¡ç»„ä»¶ä¸»åŠ¨åˆ‡æ¢ä¸»é¢˜ï¼‰
 * 2. ä¸šåŠ¡ç»„ä»¶ç¦æ­¢ç›´æ¥è°ƒç”¨ setTheme
 * 3. æ‰€æœ‰ä¸»é¢˜åˆ‡æ¢å¿…é¡»é€šè¿‡ systemState é©±åŠ¨
 * 4. æ‰€æœ‰ä¸»é¢˜åˆ‡æ¢å¿…é¡»è®°å½•æ—¥å¿—
 */
```

---

## 5. UI ç»„ä»¶çº¦æŸ

### 5.1 `lib/ui-semantic/semantic-levels.ts` - è¯­ä¹‰åŒ–çº§åˆ«çº¦æŸ

**æ–‡ä»¶ä½ç½®ï¼š** `lib/ui-semantic/semantic-levels.ts`

**ç¡¬ç¼–ç è§„åˆ™ï¼š**
```typescript
/**
 * - æ‰€æœ‰ Card / Section / Panel ç»„ä»¶å¿…é¡»å£°æ˜ semanticLevel
 * - ç¦æ­¢ç»„ä»¶é€šè¿‡é¢œè‰²è‡ªè¡Œè¡¨è¾¾é‡è¦æ€§
 */
```

### 5.2 `lib/ui-contexts/rental-ui-context.tsx` - ç§Ÿèµ UI çº¦æŸ

**æ–‡ä»¶ä½ç½®ï¼š** `lib/ui-contexts/rental-ui-context.tsx`

**ç¡¬ç¼–ç è§„åˆ™ï¼š**
```typescript
/**
 * - ç¦æ­¢ä½¿ç”¨ Facts é¡µé¢å¡ç‰‡æ ·å¼
 * - ç¦æ­¢ä½¿ç”¨äº‹å®æ—¶é—´çº¿ç»„ä»¶
 */
```

---

## 6. API è·¯ç”±çº¦æŸ

### 6.1 å¤šç§Ÿæˆ·éš”ç¦»çº¦æŸ

**æ–‡ä»¶ä½ç½®ï¼š** `app/api/**/*.ts`

**ç¡¬ç¼–ç è§„åˆ™ï¼š**

#### è§„åˆ™ 1ï¼šå¼ºåˆ¶ company_id è¿‡æ»¤
```typescript
// å¤šä¸ª API è·¯ç”±ä¸­çš„æ³¨é‡Š
// è¯´æ˜ï¼šadmin/staff è°ƒç”¨ï¼Œå¿…é¡»å¼ºåˆ¶ company_id è¿‡æ»¤
// ğŸ”’ å¤šç§Ÿæˆ·éš”ç¦»ï¼šå¼ºåˆ¶æŒ‰ provider_id è¿‡æ»¤
```

**æ¶‰åŠæ–‡ä»¶ï¼š**
- `app/api/equipment/rental/admin/list/route.ts`
- `app/api/equipment/rental/list/route.ts`
- `app/api/equipment/catalog/create/route.ts`
- `app/api/storage/upload/route.ts`
- ç­‰ç­‰...

#### è§„åˆ™ 2ï¼šsuper_admin ç‰¹æ®Šå¤„ç†
```typescript
// app/api/equipment/rental/list/route.ts ç¬¬ 51 è¡Œ
// super_admin å…è®¸ companyId ä¸º undefinedï¼Œä½†æ™®é€šç”¨æˆ·å¿…é¡»æœ‰ companyId
if (userContext.role === "super_admin") {
  // ä¸åº”ç”¨ company_id è¿‡æ»¤
} else {
  // å¼ºåˆ¶åº”ç”¨ company_id è¿‡æ»¤
}
```

### 6.2 çŠ¶æ€æµè½¬çº¦æŸ

**æ–‡ä»¶ä½ç½®ï¼š** `app/api/orders/**/*.ts`

**ç¡¬ç¼–ç è§„åˆ™ï¼š**
```typescript
// app/api/orders/accept/route.ts ç¬¬ 98 è¡Œ
// éªŒè¯çŠ¶æ€æ˜¯å¦å¯ä»¥æµè½¬ï¼šä½¿ç”¨ç»Ÿä¸€çŠ¶æ€æµè½¬ç™½åå•ï¼ˆç¦æ­¢ç¡¬ç¼–ç ï¼‰

// app/api/orders/complete/route.ts ç¬¬ 110 è¡Œ
// éªŒè¯çŠ¶æ€æ˜¯å¦å¯ä»¥æµè½¬ï¼šä½¿ç”¨ç»Ÿä¸€çŠ¶æ€æµè½¬ç™½åå•ï¼ˆç¦æ­¢ç¡¬ç¼–ç ï¼‰
```

### 6.3 å­—æ®µéªŒè¯çº¦æŸ

**æ–‡ä»¶ä½ç½®ï¼š** `app/api/**/*.ts`

**ç¡¬ç¼–ç è§„åˆ™ï¼š**

#### è§„åˆ™ 1ï¼šå¿…é¡»å­—æ®µæ£€æŸ¥
```typescript
// app/api/orders/complete/route.ts ç¬¬ 59 è¡Œ
// éªŒè¯å¿…è¦å­—æ®µï¼ˆé…é€å®Œæˆå¿…é¡»æä¾›æº¯æºç å’Œå‡­è¯ï¼‰
if (!tracking_code || !proof_image) {
  return NextResponse.json({
    error: "å®Œæˆé…é€å¿…é¡»æä¾› tracking_code å’Œ proof_image"
  }, { status: 400 })
}
```

#### è§„åˆ™ 2ï¼šæšä¸¾å€¼æ£€æŸ¥
```typescript
// app/api/equipment/rental/damage/report/route.ts ç¬¬ 80 è¡Œ
if (!['minor', 'major', 'total'].includes(damage_type)) {
  return NextResponse.json({
    error: "damage_type å¿…é¡»æ˜¯ 'minor'ã€'major' æˆ– 'total'"
  }, { status: 400 })
}
```

---

## 7. å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»çº¦æŸ

### 7.1 `lib/multi-tenant.ts` - å¤šç§Ÿæˆ·å·¥å…·çº¦æŸ

**æ–‡ä»¶ä½ç½®ï¼š** `lib/multi-tenant.ts`

**ç¡¬ç¼–ç è§„åˆ™ï¼š**

#### è§„åˆ™ 1ï¼šå¼ºåˆ¶å…¬å¸è¿‡æ»¤
```typescript
// ç¬¬ 145-155 è¡Œ
export function enforceCompanyFilter(
  query: any,
  companyId: string | null,
  companyIdField: string = "provider_id"
): any {
  if (!companyId) {
    throw new Error(`ç¼ºå°‘ company_idï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢ã€‚å­—æ®µå: ${companyIdField}`)
  }
  return query.eq(companyIdField, companyId)
}
```

#### è§„åˆ™ 2ï¼šç¦æ­¢ç›´æ¥æŸ¥è¯¢ user_companies
```typescript
// ç¬¬ 106 è¡Œå’Œç¬¬ 190 è¡Œ
// TODO: ä½¿ç”¨ getUserContext ç»Ÿä¸€è·å–ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼Œç¦æ­¢ç›´æ¥æŸ¥è¯¢ user_companies
```

---

## 8. çŠ¶æ€ç®¡ç†çº¦æŸ

### 8.1 `lib/status-manager.ts` - çŠ¶æ€æµè½¬çº¦æŸ

**æ–‡ä»¶ä½ç½®ï¼š** `lib/status-manager.ts`

**ç¡¬ç¼–ç è§„åˆ™ï¼š**
```typescript
// ç¬¬ 14-15 è¡Œ
completed: [], // ç»ˆæ€ï¼Œä¸å…è®¸å†å˜æ›´
cancelled: [], // ç»ˆæ€ï¼Œä¸å…è®¸å†å˜æ›´

// ç¬¬ 71 è¡Œ
throw new Error(
  `ä¸å…è®¸ä» ${currentStatus} ç›´æ¥å˜æ›´ä¸º ${newStatus}ã€‚å…è®¸çš„çŠ¶æ€ï¼š${allowedStatuses.join(", ")}`
)
```

---

## 9. é€‚é…å™¨çº¦æŸï¼ˆAdaptersï¼‰

### 9.1 `lib/facts/adapters/**/*.ts` - é€‚é…å™¨çº¦æŸ

**æ–‡ä»¶ä½ç½®ï¼š** `lib/facts/adapters/*.adapter.ts`

**ç¡¬ç¼–ç è§„åˆ™ï¼š**
```typescript
/**
 * âš ï¸ é‡è¦ï¼šViewModel ä¸å…è®¸å†ç›´æ¥è¯»å– API response
 * æ‰€æœ‰ API response å¿…é¡»å…ˆé€šè¿‡ Adapter å¤„ç†
 * 
 * - ç¦æ­¢ throw
 * - ç¦æ­¢ console.error
 */
```

**å®é™…ä»£ç ï¼š**
```typescript
// å¤šä¸ªé€‚é…å™¨æ–‡ä»¶ä¸­
// âš ï¸ ç¦æ­¢ throwï¼Œæ‰€æœ‰å¼‚å¸¸åªè®°å½• console.warnï¼ˆC ç±»ï¼‰
```

---

## 10. é‡‘èç³»ç»Ÿçº¦æŸ

### 10.1 `lib/financial/README.md` - é‡‘èç³»ç»Ÿç¦æ­¢äº‹é¡¹

**æ–‡ä»¶ä½ç½®ï¼š** `lib/financial/README.md`

**ç¡¬ç¼–ç è§„åˆ™ï¼š**
```markdown
### âš ï¸ ç¦æ­¢äº‹é¡¹

1. **ç¦æ­¢å†™å…¥äº‹å®å±‚**
   - â›” ç¦æ­¢å†™å…¥ `facts` è¡¨æˆ–ç»“æ„
   - â›” ç¦æ­¢å‚ä¸äº‹å®è®¡ç®—
   - â›” ç¦æ­¢å½±å“äº‹å® API è¿”å›
   - â›” ç¦æ­¢ä¿®æ”¹ä»»ä½•äº‹å®æ•°æ®

2. **ç¦æ­¢ç»‘å®šäº‹å®å±‚**
   - â›” ç¦æ­¢åœ¨ FinancialView ä¸­ç›´æ¥è°ƒç”¨ Facts API
   - â›” ç¦æ­¢å°† Facts æ•°æ®ä¸ Financial æ•°æ®æ··åˆ
```

---

## 11. æ•°æ®åº“ RLS ç­–ç•¥çº¦æŸ

### 11.1 å¤šç§Ÿæˆ· RLS ç­–ç•¥

**æ–‡ä»¶ä½ç½®ï¼š** `migrations/**/*.sql`

**ç¡¬ç¼–ç è§„åˆ™ï¼š**
```sql
-- æ‰€æœ‰ä¸šåŠ¡è¡¨çš„ RLS ç­–ç•¥ç»Ÿä¸€ä½¿ç”¨ï¼š
-- company_id IN (SELECT company_id FROM restaurants WHERE user_id = auth.uid())
```

**æ¶‰åŠè¡¨ï¼š**
- `agreements`
- `rental_orders`
- `fuel_orders`
- `order_main`
- `worker_tasks`

---

## 12. æ—¥å¿—ä¸å®¡è®¡çº¦æŸ

### 12.1 `lib/utils/logger.ts` - æ—¥å¿—çº¦æŸ

**æ–‡ä»¶ä½ç½®ï¼š** `lib/utils/logger.ts`

**ç¡¬ç¼–ç è§„åˆ™ï¼š**
```typescript
/**
 * - ç¦æ­¢è§¦å‘ Cursor é”™è¯¯å¼¹çª—
 * - æ‰€æœ‰ä¸»é¢˜åˆ‡æ¢å¿…é¡»è®°å½•æ—¥å¿—ï¼ˆå¿…é¡»å¯è¿½è¸ªï¼‰
 */
```

---

## ğŸ“Š çº¦æŸåˆ†ç±»ç»Ÿè®¡

| ç±»åˆ« | çº¦æŸæ•°é‡ | ä¸»è¦æ–‡ä»¶ |
|------|----------|----------|
| æƒé™ä¸è®¤è¯ | 5+ | `lib/auth/user-context.ts` |
| äº‹å®ç³»ç»Ÿ | 10+ | `lib/facts/**/*.ts` |
| ç§Ÿèµç³»ç»Ÿ | 15+ | `lib/rental/**/*.ts` |
| ä¸»é¢˜ç³»ç»Ÿ | 8+ | `lib/styles/**/*.ts` |
| UI ç»„ä»¶ | 5+ | `lib/ui-*/**/*.ts` |
| API è·¯ç”± | 50+ | `app/api/**/*.ts` |
| å¤šç§Ÿæˆ·éš”ç¦» | 10+ | `lib/multi-tenant.ts` |
| çŠ¶æ€ç®¡ç† | 3+ | `lib/status-manager.ts` |
| é€‚é…å™¨ | 5+ | `lib/facts/adapters/**/*.ts` |
| é‡‘èç³»ç»Ÿ | 5+ | `lib/financial/**/*.ts` |
| RLS ç­–ç•¥ | 20+ | `migrations/**/*.sql` |

**æ€»è®¡ï¼š** 130+ ä¸ªç¡¬ç¼–ç çº¦æŸè§„åˆ™

---

## ğŸ” å…³é”®çº¦æŸç‚¹æ€»ç»“

### æœ€ä¸¥æ ¼çš„çº¦æŸ

1. **äº‹å®ç³»ç»Ÿçº¦æŸ** - ç¦æ­¢æ¨æ–­ã€ç¦æ­¢å†™å…¥ã€ç¦æ­¢ä¸šåŠ¡åˆ¤æ–­
2. **æƒé™ç³»ç»Ÿçº¦æŸ** - ç¦æ­¢ç›´æ¥æŸ¥è¯¢ã€å¿…é¡»ä½¿ç”¨ç»Ÿä¸€å…¥å£
3. **ç§Ÿèµç³»ç»Ÿçº¦æŸ** - ç¦æ­¢åå‘å½±å“ Factsã€ç¦æ­¢åˆ¤æ–­å¯ç”¨æ€§
4. **å¤šç§Ÿæˆ·éš”ç¦»** - å¼ºåˆ¶ company_id è¿‡æ»¤ã€ç¦æ­¢ç»•è¿‡

### éœ€è¦ç‰¹åˆ«æ³¨æ„çš„çº¦æŸ

1. **accepted_at / completed_at** - åªèƒ½æ¥è‡ª audit_logsï¼Œä¸¥ç¦æ¨æ–­
2. **Usage Snapshot** - ç¦æ­¢ç”Ÿæˆè´¦å•ã€ç¦æ­¢è®¡ç®—é‡‘é¢
3. **Base Theme** - ä¸å…è®¸åˆ‡æ¢ã€ä¸å‚ä¸ä¸»é¢˜é€‰æ‹©
4. **Facts API** - ç¦æ­¢è¿”å›é‡‘èå­—æ®µã€ç¦æ­¢ä¸šåŠ¡åˆ¤æ–­

---

## ğŸ“ å»ºè®®

1. **æ–‡æ¡£åŒ–**ï¼šæ‰€æœ‰ç¡¬ç¼–ç çº¦æŸåº”è¯¥ç»Ÿä¸€æ–‡æ¡£åŒ–
2. **å¯é…ç½®åŒ–**ï¼šéƒ¨åˆ†çº¦æŸå¯ä»¥è€ƒè™‘æ”¹ä¸ºå¯é…ç½®
3. **æµ‹è¯•è¦†ç›–**ï¼šç¡®ä¿æ‰€æœ‰çº¦æŸéƒ½æœ‰å¯¹åº”çš„æµ‹è¯•ç”¨ä¾‹
4. **ä»£ç å®¡æŸ¥**ï¼šåœ¨ä»£ç å®¡æŸ¥æ—¶æ£€æŸ¥æ˜¯å¦è¿åçº¦æŸ

---

**ç”Ÿæˆæ—¶é—´ï¼š** 2025-01-25  
**ç‰ˆæœ¬ï¼š** 1.0
