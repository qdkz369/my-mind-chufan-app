# ç³»ç»Ÿæ¶æ„é—®é¢˜æ€»ç»“ä¸è§£å†³æ–¹æ¡ˆ

## ğŸ“Š é—®é¢˜åˆ†ææ€»ç»“

### 1. âŒ å¤šç§Ÿæˆ·éš”ç¦» - **ä¸¥é‡å®‰å…¨æ¼æ´**

**é—®é¢˜ï¼š**
- ä»£ç ä¸­**å®Œå…¨æ²¡æœ‰ä½¿ç”¨ `company_id` è¿›è¡Œæ•°æ®è¿‡æ»¤**
- æ‰€æœ‰ API æŸ¥è¯¢éƒ½æ²¡æœ‰æŒ‰ä¾›åº”å•†éš”ç¦»
- å¦‚æœå¼•å…¥ç¬¬ä¸‰æ–¹ä¾›åº”å•†ï¼Œ**ä¾›åº”å•† A å¯ä»¥çœ‹åˆ°ä¾›åº”å•† B çš„æ‰€æœ‰æ•°æ®**

**é£é™©ç­‰çº§ï¼šğŸ”´ æé«˜ - æ•°æ®æ³„éœ²é£é™©**

**è§£å†³æ–¹æ¡ˆï¼š**
- âœ… å·²åˆ›å»º `lib/multi-tenant.ts` - å¤šç§Ÿæˆ·éš”ç¦»å·¥å…·
- âœ… å·²æ›´æ–° `app/api/equipment/rental/admin/list/route.ts` - æ·»åŠ  `company_id` è¿‡æ»¤
- âœ… å·²æ›´æ–° `app/api/equipment/catalog/list/route.ts` - æ·»åŠ  `provider_id` è¿‡æ»¤
- âœ… å·²åˆ›å»º `å¤šç§Ÿæˆ·RLSç­–ç•¥.sql` - æ•°æ®åº“å±‚é¢éš”ç¦»

**éœ€è¦ç»§ç»­å®Œæˆï¼š**
- â³ æ›´æ–°æ‰€æœ‰å…¶ä»– API è·¯ç”±ï¼ˆrepair, orders ç­‰ï¼‰
- â³ åˆ›å»º `user_companies` å…³è”è¡¨ï¼ˆç”¨æˆ·-å…¬å¸å…³ç³»ï¼‰
- â³ å®ç° JWT token ä¸­åŒ…å« `company_id`

---

### 2. âš ï¸ æ•°æ®åº“å…³è”å®Œæ•´æ€§ - **éƒ¨åˆ†å®ç°**

**ç°çŠ¶ï¼š**
- âœ… SQL è„šæœ¬ä¸­ä½¿ç”¨äº†å¤–é”®ï¼ˆ`REFERENCES`ï¼‰
- âœ… `equipment_catalog` è¡¨è®¾è®¡æ”¯æŒæ‰©å±•ï¼Œä¸ä¼šå†²çª
- âš ï¸ ä½†ä»£ç ä¸­å¯èƒ½æ²¡æœ‰å……åˆ†åˆ©ç”¨å¤–é”®çº¦æŸ

**å¤–é”®ä½¿ç”¨æƒ…å†µï¼š**
```
rental_orders.provider_id â†’ companies.id (ON DELETE SET NULL) âœ…
equipment_catalog.provider_id â†’ companies.id (ON DELETE CASCADE) âœ…
equipment_catalog.category_id â†’ equipment_categories.id âœ…
rental_orders.equipment_id â†’ equipment.id âœ…
```

**ç»“è®ºï¼š** æ•°æ®åº“å±‚é¢æœ‰å¤–é”®çº¦æŸï¼Œä½†åº”ç”¨å±‚éœ€è¦åŠ å¼ºéªŒè¯ã€‚

---

### 3. âŒ çŠ¶æ€æµç®¡ç† - **æ•£è½å„å¤„ï¼Œæ— ç»Ÿä¸€é€»è¾‘**

**é—®é¢˜ï¼š**
- âŒ çŠ¶æ€å˜æ›´é€»è¾‘æ•£è½åœ¨å„ä¸ªå‰ç«¯é¡µé¢
- âŒ æ²¡æœ‰ç»Ÿä¸€çš„åç«¯çŠ¶æ€æœº
- âŒ æ²¡æœ‰çŠ¶æ€å˜æ›´å†å²è®°å½•
- âŒ æ²¡æœ‰çŠ¶æ€æµè½¬è§„åˆ™éªŒè¯

**è§£å†³æ–¹æ¡ˆï¼š**
- âœ… å·²åˆ›å»º `lib/status-manager.ts` - ç»Ÿä¸€çŠ¶æ€ç®¡ç†
- âœ… å·²åˆ›å»º `app/api/status/transition/route.ts` - ç»Ÿä¸€çŠ¶æ€å˜æ›´ API
- âœ… å·²åˆ›å»º `åˆ›å»ºçŠ¶æ€å˜æ›´æ—¥å¿—è¡¨.sql` - çŠ¶æ€å˜æ›´å†å²

**éœ€è¦ç»§ç»­å®Œæˆï¼š**
- â³ æ›´æ–°æ‰€æœ‰å‰ç«¯çŠ¶æ€å˜æ›´é€»è¾‘ï¼Œä½¿ç”¨ç»Ÿä¸€ API
- â³ æ‰§è¡Œ SQL è„šæœ¬åˆ›å»º `status_change_logs` è¡¨

---

### 4. âš ï¸ æ–‡ä»¶å­˜å‚¨é€»è¾‘ - **æ— ä¾›åº”å•†éš”ç¦»**

**é—®é¢˜ï¼š**
- âŒ ä½¿ç”¨å›ºå®šçš„ bucket åç§°
- âŒ æ‰€æœ‰ä¾›åº”å•†çš„æ–‡ä»¶æ··åœ¨ä¸€èµ·
- âŒ æ²¡æœ‰æŒ‰ä¾›åº”å•†åˆ†é…ç‹¬ç«‹æ–‡ä»¶å¤¹

**è§£å†³æ–¹æ¡ˆï¼š**
- âœ… å·²æ›´æ–° `app/api/storage/upload/route.ts` - ä½¿ç”¨ `company_id` ç»„ç»‡æ–‡ä»¶å¤¹
- âœ… æ–‡ä»¶å¤¹ç»“æ„ï¼š`companies/{company_id}/{sub_folder}/{filename}`

**å½“å‰å®ç°ï¼š**
```typescript
const folder = companyId 
  ? `companies/${companyId}/${subFolder}`
  : subFolder // å‘åå…¼å®¹
```

**å»ºè®®ï¼š**
- ä¸ºæ¯ä¸ªä¾›åº”å•†åˆ›å»ºç‹¬ç«‹çš„ bucketï¼ˆå¯é€‰ï¼‰
- æˆ–ä½¿ç”¨ç»Ÿä¸€çš„ bucketï¼Œä½†ä¸¥æ ¼æŒ‰ `company_id` ç»„ç»‡æ–‡ä»¶å¤¹

---

### 5. âš ï¸ æ€§èƒ½ä¸æ‰©å±•é£é™© - **å­˜åœ¨éšæ‚£**

**é—®é¢˜ï¼š**
- âš ï¸ ä½¿ç”¨ Supabase ç›´è¿æ¨¡å¼
- âš ï¸ RLS ç­–ç•¥å¯èƒ½ä¸å¤Ÿä¸¥æ ¼
- âš ï¸ æ²¡æœ‰æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–

**æ½œåœ¨é£é™©ï¼š**
- **å®‰å…¨é£é™©**ï¼šå¦‚æœ RLS é…ç½®é”™è¯¯ï¼Œå®¢æˆ·ç«¯å¯èƒ½ç»•è¿‡æƒé™
- **æ€§èƒ½é£é™©**ï¼š100 å®¶ä¾›åº”å•† Ã— 1000 å®¢æˆ· = 10ä¸‡å¹¶å‘æŸ¥è¯¢
- **æ‰©å±•é£é™©**ï¼šSupabase å…è´¹ç‰ˆæœ‰è¿æ¥æ•°é™åˆ¶

**å»ºè®®ï¼š**
1. **æ‰€æœ‰æŸ¥è¯¢éƒ½é€šè¿‡ API è·¯ç”±**ï¼Œä¸è¦åœ¨å‰ç«¯ç›´æ¥è¿æ¥ Supabase
2. **ä½¿ç”¨ Service Role Key** åœ¨ API è·¯ç”±ä¸­ï¼Œç»•è¿‡ RLS ä½†ç”±åº”ç”¨å±‚æ§åˆ¶æƒé™
3. **æ·»åŠ æ•°æ®åº“ç´¢å¼•**ï¼ˆå·²åŒ…å«åœ¨ SQL è„šæœ¬ä¸­ï¼‰
4. **å®ç°æŸ¥è¯¢ç¼“å­˜**ï¼ˆRedis æˆ–å†…å­˜ç¼“å­˜ï¼‰

---

## ğŸ› ï¸ å·²å®æ–½çš„æ”¹è¿›

### 1. å¤šç§Ÿæˆ·éš”ç¦»å·¥å…·

**æ–‡ä»¶ï¼š** `lib/multi-tenant.ts`

**åŠŸèƒ½ï¼š**
- `getCurrentCompanyId()` - ä»è¯·æ±‚ä¸­è·å– company_id
- `enforceCompanyFilter()` - å¼ºåˆ¶åœ¨æŸ¥è¯¢ä¸­æ·»åŠ  company_id è¿‡æ»¤
- `verifyCompanyAccess()` - éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®æŒ‡å®šå…¬å¸çš„æ•°æ®

### 2. ç»Ÿä¸€çŠ¶æ€ç®¡ç†

**æ–‡ä»¶ï¼š** `lib/status-manager.ts`

**åŠŸèƒ½ï¼š**
- `validateStatusTransition()` - éªŒè¯çŠ¶æ€æµè½¬æ˜¯å¦åˆæ³•
- `getNextPossibleStatuses()` - è·å–æ‰€æœ‰å¯èƒ½çš„ä¸‹ä¸€ä¸ªçŠ¶æ€
- `isTerminalStatus()` - æ£€æŸ¥æ˜¯å¦ä¸ºç»ˆæ€
- `logStatusChange()` - è®°å½•çŠ¶æ€å˜æ›´æ—¥å¿—

### 3. ç»Ÿä¸€çŠ¶æ€å˜æ›´ API

**æ–‡ä»¶ï¼š** `app/api/status/transition/route.ts`

**åŠŸèƒ½ï¼š**
- ç»Ÿä¸€çš„çŠ¶æ€å˜æ›´æ¥å£
- çŠ¶æ€æµè½¬éªŒè¯
- æƒé™æ£€æŸ¥
- å˜æ›´æ—¥å¿—è®°å½•

### 4. æ–‡ä»¶å­˜å‚¨éš”ç¦»

**æ–‡ä»¶ï¼š** `app/api/storage/upload/route.ts`

**æ”¹è¿›ï¼š**
- ä½¿ç”¨ `company_id` ç»„ç»‡æ–‡ä»¶å¤¹ç»“æ„
- æ ¼å¼ï¼š`companies/{company_id}/{sub_folder}/{filename}`

### 5. æ•°æ®åº“è„šæœ¬

**æ–‡ä»¶ï¼š**
- `å¤šç§Ÿæˆ·RLSç­–ç•¥.sql` - æ•°æ®åº“å±‚é¢å¤šç§Ÿæˆ·éš”ç¦»
- `åˆ›å»ºçŠ¶æ€å˜æ›´æ—¥å¿—è¡¨.sql` - çŠ¶æ€å˜æ›´å†å²è®°å½•

---

## ğŸ“‹ ç«‹å³æ‰§è¡Œçš„æ“ä½œ

### ç¬¬ä¸€æ­¥ï¼šæ‰§è¡Œæ•°æ®åº“è„šæœ¬

åœ¨ Supabase SQL Editor ä¸­æŒ‰é¡ºåºè¿è¡Œï¼š

1. **åˆ›å»ºçŠ¶æ€å˜æ›´æ—¥å¿—è¡¨.sql**
   ```sql
   -- åˆ›å»º status_change_logs è¡¨
   ```

2. **å¤šç§Ÿæˆ·RLSç­–ç•¥.sql**
   ```sql
   -- åˆ›å»ºå¤šç§Ÿæˆ· RLS ç­–ç•¥
   -- âš ï¸ æ³¨æ„ï¼šéœ€è¦æ ¹æ®å®é™…ç”¨æˆ·è¡¨ç»“æ„è°ƒæ•´
   ```

### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºç”¨æˆ·-å…¬å¸å…³è”è¡¨

```sql
-- åˆ›å»ºç”¨æˆ·-å…¬å¸å…³è”è¡¨
CREATE TABLE IF NOT EXISTS user_companies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,
  company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
  role VARCHAR(50) DEFAULT 'member', -- member, admin, owner
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(user_id, company_id)
);

CREATE INDEX idx_user_companies_user ON user_companies(user_id);
CREATE INDEX idx_user_companies_company ON user_companies(company_id);
```

### ç¬¬ä¸‰æ­¥ï¼šæ›´æ–°æ‰€æœ‰ API è·¯ç”±

éœ€è¦æ›´æ–°ä»¥ä¸‹ API è·¯ç”±ï¼Œæ·»åŠ  `company_id` è¿‡æ»¤ï¼š

- [ ] `app/api/repair/list/route.ts`
- [ ] `app/api/repair/create/route.ts`
- [ ] `app/api/repair/update/route.ts`
- [ ] `app/api/orders/create/route.ts`
- [ ] `app/api/orders/accept/route.ts`
- [ ] `app/api/equipment/rental/list/route.ts`ï¼ˆå®¢æˆ·ç«¯ï¼‰
- [ ] å…¶ä»–æ‰€æœ‰æ¶‰åŠæ•°æ®çš„ API

---

## ğŸš¨ å®‰å…¨å»ºè®®

### ç«‹å³è¡ŒåŠ¨ï¼ˆç´§æ€¥ï¼‰

1. **ç¦ç”¨ä¾›åº”å•†è´¦å·ç™»å½•**ï¼Œç›´åˆ°å¤šç§Ÿæˆ·éš”ç¦»å®Œæˆ
2. **å®¡æŸ¥æ‰€æœ‰ API è·¯ç”±**ï¼Œç¡®ä¿éƒ½æœ‰ `company_id` è¿‡æ»¤
3. **å¯ç”¨ Supabase å®¡è®¡æ—¥å¿—**ï¼Œç›‘æ§æ•°æ®è®¿é—®

### çŸ­æœŸï¼ˆæœ¬å‘¨å†…ï¼‰

1. **å®ç°å®Œæ•´çš„ç”¨æˆ·-å…¬å¸å…³è”**
2. **æ›´æ–°æ‰€æœ‰ API è·¯ç”±**ï¼Œæ·»åŠ å¤šç§Ÿæˆ·è¿‡æ»¤
3. **æµ‹è¯•å¤šç§Ÿæˆ·éš”ç¦»**ï¼Œç¡®ä¿ä¾›åº”å•† A çœ‹ä¸åˆ°ä¾›åº”å•† B çš„æ•°æ®

### é•¿æœŸï¼ˆä¸‹ä¸ªè¿­ä»£ï¼‰

1. **å®ç°æŸ¥è¯¢ç¼“å­˜**
2. **ä¼˜åŒ–æ•°æ®åº“ç´¢å¼•**
3. **æ·»åŠ  API é™æµ**
4. **å®ç°å®Œæ•´çš„å®¡è®¡æ—¥å¿—**

---

## ğŸ“ ä»£ç ä½¿ç”¨ç¤ºä¾‹

### åœ¨ API è·¯ç”±ä¸­ä½¿ç”¨å¤šç§Ÿæˆ·è¿‡æ»¤

```typescript
import { getCurrentCompanyId, enforceCompanyFilter } from "@/lib/multi-tenant"

export async function GET(request: Request) {
  // è·å– company_id
  const companyId = await getCurrentCompanyId(request)
  
  if (!companyId) {
    return NextResponse.json(
      { error: "ç¼ºå°‘ company_id" },
      { status: 400 }
    )
  }
  
  // æ„å»ºæŸ¥è¯¢
  let query = supabase
    .from("rental_orders")
    .select("*")
  
  // å¼ºåˆ¶æ·»åŠ  company_id è¿‡æ»¤
  query = enforceCompanyFilter(query, companyId, "provider_id")
  
  const { data, error } = await query
  // ...
}
```

### ä½¿ç”¨ç»Ÿä¸€çŠ¶æ€å˜æ›´ API

```typescript
// å‰ç«¯è°ƒç”¨
const response = await fetch("/api/status/transition", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    table: "rental_orders",
    record_id: orderId,
    new_status: "confirmed",
    reason: "è®¢å•å·²ç¡®è®¤",
  }),
})
```

---

## âš ï¸ é‡è¦æé†’

1. **åœ¨å®Œæˆå¤šç§Ÿæˆ·éš”ç¦»ä¹‹å‰ï¼Œä¸è¦å¯ç”¨ä¾›åº”å•†è´¦å·ç™»å½•**
2. **æ‰€æœ‰æ¶‰åŠæ•°æ®çš„ API éƒ½å¿…é¡»æ·»åŠ  `company_id` è¿‡æ»¤**
3. **å®šæœŸå®¡æŸ¥ RLS ç­–ç•¥ï¼Œç¡®ä¿æƒé™æ­£ç¡®**
4. **ç›‘æ§ Supabase å®¡è®¡æ—¥å¿—ï¼Œå‘ç°å¼‚å¸¸è®¿é—®**

æ‰€æœ‰ä»£ç å·²è‡ªåŠ¨ä¿å­˜ï¼


