# ğŸ‰ ç»Ÿä¸€è®¢å•ç³»ç»Ÿéƒ¨ç½²å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ éƒ¨ç½²æ¦‚è§ˆ

**éƒ¨ç½²æ—¥æœŸ**: 2025-01-25  
**ç³»ç»Ÿåç§°**: ç»Ÿä¸€è®¢å•ç®¡ç†ç³»ç»Ÿ (Unified Order Management)  
**éƒ¨ç½²çŠ¶æ€**: âœ… **å…¨éƒ¨å®Œæˆ**  

## âœ… å·²å®Œæˆéƒ¨ç½²

### 1. ğŸ—ƒï¸ æ•°æ®åº“æ¶æ„éƒ¨ç½²

#### æ ¸å¿ƒè¡¨ç»“æ„
- âœ… **order_main è¡¨** - è®¢å•ä¸»è¡¨ï¼ˆç»Ÿä¸€ç®¡ç†ï¼‰
  - è®¢å•å·ã€ç±»å‹ã€å…¬å¸IDã€çŠ¶æ€ã€é‡‘é¢
  - å…³è”å­—æ®µï¼šfuel_order_idã€rental_order_id  
  - å…ƒæ•°æ®ï¼šé¤å…IDã€ç”¨æˆ·IDã€å¤‡æ³¨
  - è‡ªåŠ¨æ›´æ–°æ—¶é—´æˆ³

- âœ… **ä¸šåŠ¡è¡¨å…³è”å­—æ®µ**
  - `delivery_orders.main_order_id` - ç‡ƒæ–™è®¢å•å…³è”
  - `rental_orders.main_order_id` - ç§Ÿèµè®¢å•å…³è”
  - å¤–é”®çº¦æŸå’Œçº§è”ç­–ç•¥

#### RLSå®‰å…¨ç­–ç•¥  
```sql
-- âœ… å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»
USING (
  company_id IN (
    SELECT company_id FROM restaurants WHERE user_id = auth.uid()
  ) OR company_id IS NULL
)

-- âœ… Service Role å®Œå…¨è®¿é—®
CREATE POLICY "Service role full access to order_main"
ON order_main FOR ALL TO service_role
USING (true) WITH CHECK (true);
```

### 2. ğŸ”„ å½±å­å†™å…¥æœºåˆ¶éƒ¨ç½²

#### ç‡ƒæ–™è®¢å•å½±å­å†™å…¥
**æ–‡ä»¶**: `app/api/orders/create/route.ts`  
**åŠŸèƒ½**: åˆ›å»ºç‡ƒæ–™è®¢å•æ—¶åŒæ­¥å†™å…¥ order_main

```typescript
// âœ… å½±å­å†™å…¥é€»è¾‘å·²å®ç°
const { data: mainOrder, error: mainOrderError } = await adminClient
  .from("order_main")
  .insert({
    order_number: newOrder.order_number,
    order_type: "fuel",
    company_id: userContext.companyId,
    status: newOrder.status,
    total_amount: newOrder.total_amount || 0,
    fuel_order_id: newOrder.id,
    restaurant_id: newOrder.restaurant_id,
    user_id: userContext.userId,
  })
```

#### ç§Ÿèµè®¢å•å½±å­å†™å…¥
**æ–‡ä»¶**: `app/api/equipment/rental/create/route.ts`  
**åŠŸèƒ½**: åˆ›å»ºç§Ÿèµè®¢å•æ—¶åŒæ­¥å†™å…¥ order_main

```typescript
// âœ… å½±å­å†™å…¥é€»è¾‘å·²å®ç°  
const { data: mainOrder, error: mainOrderError } = await adminClient
  .from("order_main")
  .insert({
    order_number: rentalOrder.order_number,
    order_type: "rental", 
    company_id: userContext.companyId,
    status: rentalOrder.status,
    total_amount: totalAmount,
    rental_order_id: rentalOrder.id,
    restaurant_id: rentalOrder.restaurant_id,
    user_id: currentUserId,
  })
```

### 3. ğŸ“Š ç»Ÿä¸€è®¢å•åˆ—è¡¨ç³»ç»Ÿ

#### åç«¯API  
**æ–‡ä»¶**: `app/api/orders/main/list/route.ts`  
**åŠŸèƒ½**: ç»Ÿä¸€æŸ¥è¯¢ç‡ƒæ–™è®¢å•å’Œç§Ÿèµè®¢å•

**ç‰¹æ€§**:
- âœ… å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»
- âœ… Super Admin å…¨å±€è®¿é—®
- âœ… è®¢å•ç±»å‹ç­›é€‰ (fuel/rental)
- âœ… çŠ¶æ€ç­›é€‰
- âœ… é¤å…ç­›é€‰  
- âœ… åˆ†é¡µæ”¯æŒ
- âœ… å…³è”é¤å…ä¿¡æ¯æŸ¥è¯¢

#### å‰ç«¯UI
**æ–‡ä»¶**: `app/(dashboard)/orders/page.tsx`  
**åŠŸèƒ½**: ç»Ÿä¸€è®¢å•åˆ—è¡¨ç•Œé¢

**ç‰¹æ€§**:
- âœ… è®¢å•ç±»å‹å›¾æ ‡æ˜¾ç¤º (ğŸššç‡ƒæ–™ ğŸ“¦ç§Ÿèµ)
- âœ… çŠ¶æ€æ ‡ç­¾æ˜¾ç¤º  
- âœ… é‡‘é¢æ ¼å¼åŒ–æ˜¾ç¤º
- âœ… ç­›é€‰å™¨ (ç±»å‹+çŠ¶æ€)
- âœ… åˆ†é¡µå¯¼èˆª
- âœ… åŠ è½½çŠ¶æ€å’Œé”™è¯¯å¤„ç†
- âœ… å“åº”å¼è®¾è®¡

### 4. ğŸ”’ å®‰å…¨ä¸æƒé™

#### å¤šç§Ÿæˆ·éš”ç¦»
```typescript
// âœ… å…¬å¸çº§æ•°æ®éš”ç¦»
if (userContext?.companyId && userContext?.role !== "super_admin") {
  query = query.eq("company_id", userContext.companyId)
}
```

#### Super Admin ç»•è¿‡
```typescript
// âœ… ç³»ç»Ÿç®¡ç†å‘˜å…¨å±€è®¿é—®
if (userContext?.role === "super_admin") {
  console.log("[è®¢å•ä¸»è¡¨API] Super Admin è®¿é—®ï¼Œè·³è¿‡å¤šç§Ÿæˆ·è¿‡æ»¤")
}
```

#### ç”¨æˆ·è§’è‰²ä½“ç³»
- âœ… `super_admin` - ç³»ç»Ÿçº§å…¨å¹³å°è®¿é—®
- âœ… `platform_admin` - å¹³å°è¿è¥è®¿é—®  
- âœ… `company_admin` - å…¬å¸ç®¡ç†å‘˜è®¿é—®
- âœ… å…¶ä»–ä¸šåŠ¡è§’è‰²

## ğŸ¯ ç³»ç»Ÿæ¶æ„ä¼˜åŠ¿

### ç»Ÿä¸€æ•°æ®è§†å›¾
- ğŸ“Š **å•ä¸€å…¥å£**: æ‰€æœ‰è®¢å•ç»Ÿä¸€æŸ¥è¯¢å’Œç®¡ç†
- ğŸ” **æ¨ªå‘åˆ†æ**: è·¨è®¢å•ç±»å‹çš„æ•°æ®åˆ†æ  
- ğŸ“ˆ **ä¸šåŠ¡æ´å¯Ÿ**: ç»Ÿä¸€çš„è®¢å•ç»Ÿè®¡å’ŒæŠ¥è¡¨

### æ•°æ®ä¸€è‡´æ€§  
- ğŸ”„ **åŒæ­¥å†™å…¥**: ä¸šåŠ¡è¡¨å’Œç»Ÿä¸€è¡¨å®æ—¶åŒæ­¥
- ğŸ›¡ï¸ **æ•…éšœéš”ç¦»**: å½±å­å†™å…¥å¤±è´¥ä¸å½±å“ä¸»æµç¨‹
- ğŸ“ **å®¡è®¡è¿½è¸ª**: å®Œæ•´çš„è®¢å•åˆ›å»ºæ—¥å¿—

### æ‰©å±•æ€§è®¾è®¡
- â• **æ–°è®¢å•ç±»å‹**: æ˜“äºæ·»åŠ æ–°çš„è®¢å•ç±»å‹
- ğŸ”§ **è‡ªå®šä¹‰ç­›é€‰**: æ”¯æŒçµæ´»çš„ç­›é€‰æ¡ä»¶
- ğŸ“± **å¤šç«¯æ”¯æŒ**: ç»Ÿä¸€APIæ”¯æŒWeb/Mobile

## ğŸš€ æµ‹è¯•æŒ‡å—

### 1. åˆ›å»ºç‡ƒæ–™è®¢å•æµ‹è¯•
```bash
# POST /api/orders/create
# é¢„æœŸç»“æœï¼š
# - delivery_orders è¡¨æ’å…¥æˆåŠŸ
# - order_main è¡¨åŒæ­¥æ’å…¥ 
# - main_order_id æ­£ç¡®å…³è”
```

### 2. åˆ›å»ºç§Ÿèµè®¢å•æµ‹è¯•  
```bash
# POST /api/equipment/rental/create  
# é¢„æœŸç»“æœï¼š
# - rental_orders è¡¨æ’å…¥æˆåŠŸ
# - order_main è¡¨åŒæ­¥æ’å…¥
# - main_order_id æ­£ç¡®å…³è”
```

### 3. ç»Ÿä¸€åˆ—è¡¨æŸ¥è¯¢æµ‹è¯•
```bash
# GET /api/orders/main/list
# é¢„æœŸç»“æœï¼š
# - æ˜¾ç¤ºæ‰€æœ‰ç±»å‹è®¢å•
# - å¤šç§Ÿæˆ·æ­£ç¡®éš”ç¦»
# - ç­›é€‰å’Œåˆ†é¡µæ­£å¸¸
```

### 4. å‰ç«¯UIæµ‹è¯•
```bash
# è®¿é—® /orders
# é¢„æœŸç»“æœï¼š
# - è®¢å•åˆ—è¡¨æ­£å¸¸æ˜¾ç¤º
# - ç­›é€‰å™¨å·¥ä½œæ­£å¸¸  
# - åˆ†é¡µå¯¼èˆªæ­£å¸¸
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“ç´¢å¼•
```sql
-- âœ… å·²åˆ›å»ºæ ¸å¿ƒç´¢å¼•
CREATE INDEX idx_order_main_order_type ON order_main(order_type);
CREATE INDEX idx_order_main_company_id ON order_main(company_id);
CREATE INDEX idx_order_main_status ON order_main(status);
CREATE INDEX idx_order_main_created_at ON order_main(created_at DESC);
```

### æŸ¥è¯¢ä¼˜åŒ–
- âœ… **é€‰æ‹©æ€§æŸ¥è¯¢**: åªæŸ¥è¯¢å¿…éœ€å­—æ®µ
- âœ… **å…³è”ä¼˜åŒ–**: ä½¿ç”¨ JOIN è€Œéå¤šæ¬¡æŸ¥è¯¢
- âœ… **åˆ†é¡µé™åˆ¶**: é¿å…å¤§æ•°æ®é‡ä¸€æ¬¡åŠ è½½

## ğŸ”® åç»­è§„åˆ’

### çŸ­æœŸä¼˜åŒ– (1-2å‘¨)
- ğŸ” **é«˜çº§ç­›é€‰**: æ—¶é—´èŒƒå›´ã€é‡‘é¢èŒƒå›´ç­›é€‰
- ğŸ“Š **ç»Ÿè®¡é¢æ¿**: è®¢å•æ•°é‡ã€é‡‘é¢ç»Ÿè®¡  
- ğŸ”” **å®æ—¶æ›´æ–°**: WebSocket å®æ—¶è®¢å•çŠ¶æ€

### ä¸­æœŸæ‰©å±• (1-2æœˆ)
- ğŸ“± **ç§»åŠ¨ç«¯é€‚é…**: å“åº”å¼è®¾è®¡ä¼˜åŒ–
- ğŸ“ˆ **æŠ¥è¡¨åŠŸèƒ½**: è®¢å•åˆ†ææŠ¥è¡¨
- ğŸ”„ **æ‰¹é‡æ“ä½œ**: æ‰¹é‡çŠ¶æ€æ›´æ–°

### é•¿æœŸè§„åˆ’ (3-6æœˆ)  
- ğŸ¤– **æ™ºèƒ½æ¨è**: åŸºäºå†å²è®¢å•çš„æ™ºèƒ½æ¨è
- ğŸ“‹ **å·¥ä½œæµ**: å¯é…ç½®çš„è®¢å•å®¡æ‰¹æµç¨‹
- ğŸŒ **APIå¼€æ”¾**: ç¬¬ä¸‰æ–¹ç³»ç»Ÿé›†æˆæ¥å£

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [x] **æ•°æ®åº“è¿ç§»** - order_main è¡¨åˆ›å»ºæˆåŠŸ
- [x] **ä¸šåŠ¡è¡¨æ›´æ–°** - main_order_id å­—æ®µæ·»åŠ æˆåŠŸ  
- [x] **RLSç­–ç•¥** - å¤šç§Ÿæˆ·å®‰å…¨ç­–ç•¥ç”Ÿæ•ˆ
- [x] **å½±å­å†™å…¥** - ç‡ƒæ–™è®¢å•åŒæ­¥å†™å…¥æµ‹è¯•é€šè¿‡
- [x] **å½±å­å†™å…¥** - ç§Ÿèµè®¢å•åŒæ­¥å†™å…¥æµ‹è¯•é€šè¿‡
- [x] **ç»Ÿä¸€API** - è®¢å•åˆ—è¡¨APIåŠŸèƒ½å®Œæ•´
- [x] **å‰ç«¯UI** - ç»Ÿä¸€è®¢å•åˆ—è¡¨ç•Œé¢å®Œæˆ
- [x] **æƒé™éªŒè¯** - å¤šç§Ÿæˆ·éš”ç¦»å’ŒSuper Adminç»•è¿‡æ­£å¸¸
- [x] **å®‰å…¨ä¿®å¤** - ä¸´æ—¶ä»£ç è§„èŒƒåŒ–å®Œæˆ
- [x] **è§’è‰²ä½“ç³»** - ç”¨æˆ·è§’è‰²å®šä¹‰ç»Ÿä¸€

## ğŸŠ æ€»ç»“

**ç»Ÿä¸€è®¢å•ç®¡ç†ç³»ç»Ÿéƒ¨ç½²åœ†æ»¡å®Œæˆï¼** ğŸ‰

### æ ¸å¿ƒæˆå°±
1. âœ… **æ•°æ®ç»Ÿä¸€**: ç‡ƒæ–™è®¢å•å’Œç§Ÿèµè®¢å•ç»Ÿä¸€ç®¡ç†
2. âœ… **å®æ—¶åŒæ­¥**: å½±å­å†™å…¥æœºåˆ¶ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
3. âœ… **å®‰å…¨å¯é **: å¤šç§Ÿæˆ·éš”ç¦»å’Œå®Œæ•´çš„æƒé™æ§åˆ¶  
4. âœ… **ç”¨æˆ·å‹å¥½**: ç›´è§‚çš„ç»Ÿä¸€è®¢å•åˆ—è¡¨ç•Œé¢
5. âœ… **æ‰©å±•æ€§å¼º**: æ˜“äºæ·»åŠ æ–°è®¢å•ç±»å‹å’ŒåŠŸèƒ½

### æŠ€æœ¯äº®ç‚¹  
- ğŸ—ï¸ **æ¶æ„ä¼˜é›…**: å½±å­å†™å…¥æ¨¡å¼ä¿è¯ä¸šåŠ¡è§£è€¦
- ğŸ”’ **å®‰å…¨ç¬¬ä¸€**: RLSç­–ç•¥ç¡®ä¿æ•°æ®éš”ç¦»
- âš¡ **æ€§èƒ½ä¼˜åŒ–**: åˆç†çš„ç´¢å¼•å’ŒæŸ¥è¯¢ä¼˜åŒ–
- ğŸ¨ **ä½“éªŒä¼˜ç§€**: å“åº”å¼è®¾è®¡å’Œäº¤äº’å‹å¥½

**ç³»ç»Ÿå·²å‡†å¤‡æŠ•äº§ï¼Œå¯å¼€å§‹æ­£å¼ä½¿ç”¨ï¼** ğŸš€