# 解决循环登录的完整步骤

## ⚠️ 重要说明

你看到的 `ERR_CONNECTION_REFUSED` 错误是因为**开发服务器没有运行**，不是循环登录的原因。

这些错误包括：
- WebSocket 连接失败（用于热更新）
- 静态资源加载失败
- 这些都是正常的，因为服务器被关闭了

---

## 🔄 第一步：重新启动开发服务器

### 1. 在终端中运行：
```bash
npm run dev
```

### 2. 等待服务器启动完成
应该看到类似这样的输出：
```
▲ Next.js 16.0.10
- Local:        http://localhost:3000
- Ready in XXXms
```

### 3. 确认服务器正在运行
- 不要关闭终端窗口
- 保持服务器运行状态

---

## 🧪 第二步：测试登录（使用无痕模式）

### 1. 打开无痕窗口
- Chrome/Edge: `Ctrl + Shift + N`
- Firefox: `Ctrl + Shift + P`

### 2. 访问登录页面
```
http://localhost:3000/login
```

### 3. 打开浏览器控制台（F12）
- 切换到 **Console** 标签页
- 切换到 **Network** 标签页（准备查看网络请求）

### 4. 输入管理员账号密码并登录

---

## 📊 第三步：观察和收集信息

### 观察登录流程

**正常流程应该是：**
1. 点击登录按钮
2. 看到"登录中..."状态
3. 控制台显示登录日志
4. 自动跳转到 `/dashboard`

**如果出现循环：**
1. 点击登录按钮
2. 看到"检查登录状态..."
3. 然后回到登录页面
4. 或者一直停留在"检查登录状态..."

### 收集控制台日志

在 Console 标签页中，查找并复制以下日志：

**登录相关日志：**
```
[登录页] 开始登录流程...
[登录页] 登录成功，用户ID: ...
[登录页] 角色查询结果: ...
[登录页] 用户角色: ...
[登录页] 登录成功，验证会话状态...
[登录页] 会话已验证，用户: ...
[登录页] 等待 Cookie 同步...
[登录页] Cookie 已同步，准备跳转到管理后台
```

**中间件日志：**
```
[中间件] 用户已登录，允许访问: ... 路径: /dashboard
```

**或者错误日志：**
```
[登录页] 查询角色失败: ...
[中间件] 未检测到会话，重定向到登录页。路径: /dashboard
```

### 收集网络请求信息

在 Network 标签页中：

1. **查找 `/user_roles` 请求**
   - 点击该请求
   - 查看 **Status**（状态码）
   - 查看 **Response**（响应内容）
   - 如果是错误，查看 **Headers** 和错误详情

2. **查找 `/dashboard` 请求**
   - 查看状态码
   - 查看是否有重定向（307/308）
   - 查看重定向的目标 URL

3. **查找 `/login` 请求**
   - 查看是否有重复的登录请求
   - 查看请求的触发原因

---

## 🔍 第四步：根据结果判断问题

### 情况1：登录成功，但立即跳回登录页

**可能原因：**
- 中间件检测不到 session（Cookie 未同步）
- Dashboard 页面有认证检查导致重定向

**检查：**
- 查看中间件日志：`[中间件] 未检测到会话`
- 查看 Network 中 `/dashboard` 是否被重定向到 `/login`

### 情况2：登录成功，但一直显示"检查登录状态..."

**可能原因：**
- 角色查询失败（RLS 策略问题）
- 用户没有角色记录

**检查：**
- 查看控制台：`[登录页] 查询角色失败`
- 查看 Network 中 `/user_roles` 的状态码和响应

### 情况3：登录后跳转到 dashboard，但页面空白或报错

**可能原因：**
- Dashboard 页面加载失败
- 权限检查导致错误

**检查：**
- 查看 Dashboard 页面的错误信息
- 查看控制台的错误日志

---

## 📝 第五步：提供信息给我

请提供以下信息：

1. **控制台日志**
   - 所有 `[登录页]` 开头的日志
   - 所有 `[中间件]` 开头的日志
   - 所有红色错误信息

2. **网络请求详情**
   - `/user_roles` 请求的状态码和响应
   - `/dashboard` 请求的状态码和重定向情况
   - 任何失败的请求

3. **现象描述**
   - 登录后发生了什么？
   - 是否跳转？跳转到哪里？
   - 是否又回到登录页？
   - 是否一直显示"检查登录状态..."？

---

## 🛠️ 临时调试技巧

### 如果问题持续存在，可以尝试：

1. **完全清除浏览器数据**
   - 关闭所有浏览器窗口
   - 清除所有 Cookie 和缓存
   - 重启浏览器

2. **检查 Supabase 配置**
   - 确认 `.env.local` 文件存在
   - 确认环境变量正确
   - 重启开发服务器

3. **检查用户角色**
   - 在 Supabase Dashboard → SQL Editor 中执行：
   ```sql
   SELECT * FROM user_roles WHERE user_id = '你的用户ID';
   ```

4. **检查 RLS 策略**
   - 在 Supabase Dashboard → SQL Editor 中执行：
   ```sql
   SELECT policyname, cmd, roles 
   FROM pg_policies 
   WHERE tablename = 'user_roles';
   ```

---

**现在请按照上述步骤操作，然后告诉我具体的日志和错误信息！** 🚀
