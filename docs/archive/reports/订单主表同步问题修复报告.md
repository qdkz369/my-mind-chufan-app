# ğŸ”§ è®¢å•ä¸»è¡¨åŒæ­¥é—®é¢˜ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜è¯Šæ–­

### é—®é¢˜ç°è±¡
- `delivery_orders` è¡¨ä¸­æœ‰ **18 æ¡è®¢å•**
- `order_main` è¡¨ä¸­æœ‰ **0 æ¡è®¢å•**
- è®¢å•åˆ—è¡¨é¡µé¢æ˜¾ç¤º **0 æ¡è®¢å•**

### æ ¹æœ¬åŸå› 

**å½±å­å†™å…¥æœºåˆ¶å®Œå…¨å¤±è´¥**ï¼Œå¯¼è‡´æ‰€æœ‰è®¢å•éƒ½æœªåŒæ­¥åˆ° `order_main` è¡¨ã€‚

#### åŸå› åˆ†æï¼š

1. **Service Role Key å›é€€é—®é¢˜**
   - åŸä»£ç åœ¨ `SUPABASE_SERVICE_ROLE_KEY` æœªè®¾ç½®æ—¶ä¼šå›é€€åˆ°ä½¿ç”¨ `anonKey`
   - ä½¿ç”¨ `anonKey` æ—¶ï¼ŒRLS ç­–ç•¥ä¼šé˜»æ­¢æ’å…¥ï¼ˆéœ€è¦ `auth.uid()`ï¼‰
   - API è·¯ç”±ä¸­æ²¡æœ‰è®¤è¯ç”¨æˆ·ï¼ˆå®¢æˆ·ç«¯ç”¨æˆ·é€šè¿‡ `x-restaurant-id` header è®¤è¯ï¼‰
   - å› æ­¤æ‰€æœ‰å½±å­å†™å…¥éƒ½è¢« RLS ç­–ç•¥æ‹’ç»

2. **é”™è¯¯å¤„ç†ä¸å®Œå–„**
   - å½±å­å†™å…¥å¤±è´¥æ—¶åªè®°å½•é”™è¯¯ï¼Œä¸å½±å“ä¸»æµç¨‹
   - ç”¨æˆ·çœ‹åˆ°"è®¢å•åˆ›å»ºæˆåŠŸ"ï¼Œä½†å®é™…æœªåŒæ­¥åˆ° `order_main` è¡¨
   - è®¢å•åˆ—è¡¨æŸ¥è¯¢ `order_main` è¡¨ï¼Œæ‰€ä»¥è¿”å› 0 æ¡è®¢å•

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. ä»£ç ä¿®å¤ (`app/api/orders/create/route.ts`)

#### ä¿®å¤1ï¼šå¼ºåˆ¶ä½¿ç”¨ Service Role Key
```typescript
// âŒ æ—§ä»£ç ï¼šä¼šå›é€€åˆ° anonKey
const adminClient = createClient(
  supabaseUrl,
  serviceRoleKey || anonKey!, // é—®é¢˜ï¼šå¦‚æœ serviceRoleKey ä¸ºç©ºï¼Œä¼šä½¿ç”¨ anonKey
  ...
)

// âœ… æ–°ä»£ç ï¼šå¿…é¡»ä½¿ç”¨ Service Role Key
if (!supabaseUrl || !serviceRoleKey) {
  shadowWriteWarning = "è®¢å•å·²åˆ›å»ºï¼Œä½†æ— æ³•åŒæ­¥åˆ°è®¢å•ä¸»è¡¨ï¼ˆService Role Key æœªé…ç½®ï¼‰..."
} else {
  const adminClient = createClient(
    supabaseUrl,
    serviceRoleKey, // å¿…é¡»ä½¿ç”¨ Service Role Keyï¼Œä¸èƒ½å›é€€
    ...
  )
}
```

#### ä¿®å¤2ï¼šæ”¹è¿›é”™è¯¯å¤„ç†å’Œè­¦å‘Š
- å½±å­å†™å…¥å¤±è´¥æ—¶ï¼Œåœ¨å“åº”ä¸­åŒ…å« `warning` å­—æ®µ
- è¯¦ç»†è®°å½•é”™è¯¯ä¿¡æ¯ï¼ˆcode, message, details, hintï¼‰
- ç”¨æˆ·å¯ä»¥çœ‹åˆ°æ˜ç¡®çš„è­¦å‘Šä¿¡æ¯

### 2. æ•°æ®ä¿®å¤è„šæœ¬ (`ä¿®å¤è®¢å•ä¸»è¡¨åŒæ­¥é—®é¢˜.sql`)

åˆ›å»ºäº†å®Œæ•´çš„ SQL è„šæœ¬ï¼Œç”¨äºï¼š
- æ£€æŸ¥éœ€è¦åŒæ­¥çš„è®¢å•
- æ‰¹é‡åŒæ­¥ç°æœ‰è®¢å•åˆ° `order_main` è¡¨
- ç”Ÿæˆå”¯ä¸€çš„è®¢å•å·
- æ›´æ–° `delivery_orders.main_order_id`
- éªŒè¯åŒæ­¥ç»“æœ

## ğŸš€ æ‰§è¡Œæ­¥éª¤

### æ­¥éª¤1ï¼šæ£€æŸ¥ç¯å¢ƒå˜é‡

ç¡®ä¿ `.env.local` æ–‡ä»¶ä¸­é…ç½®äº† `SUPABASE_SERVICE_ROLE_KEY`ï¼š

```bash
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key_here
```

### æ­¥éª¤2ï¼šæ‰§è¡Œæ•°æ®ä¿®å¤è„šæœ¬

åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œ `ä¿®å¤è®¢å•ä¸»è¡¨åŒæ­¥é—®é¢˜.sql`ï¼š

1. æ‰“å¼€ Supabase Dashboard
2. è¿›å…¥ SQL Editor
3. å¤åˆ¶ç²˜è´´ `ä¿®å¤è®¢å•ä¸»è¡¨åŒæ­¥é—®é¢˜.sql` çš„å†…å®¹
4. **ç¡®ä¿ä½¿ç”¨ Service Role Key æ‰§è¡Œ**ï¼ˆç»•è¿‡ RLSï¼‰
5. æ‰§è¡Œè„šæœ¬

### æ­¥éª¤3ï¼šéªŒè¯ä¿®å¤ç»“æœ

æ‰§è¡Œè„šæœ¬ä¸­çš„éªŒè¯æŸ¥è¯¢ï¼Œç¡®è®¤ï¼š
- âœ… æ‰€æœ‰è®¢å•éƒ½å·²åŒæ­¥åˆ° `order_main` è¡¨
- âœ… `delivery_orders.main_order_id` å·²æ­£ç¡®å…³è”
- âœ… è®¢å•åˆ—è¡¨å¯ä»¥æ­£å¸¸æ˜¾ç¤º

### æ­¥éª¤4ï¼šæµ‹è¯•æ–°è®¢å•åˆ›å»º

1. åˆ›å»ºä¸€ä¸ªæ–°è®¢å•
2. æ£€æŸ¥å“åº”ä¸­æ˜¯å¦åŒ…å« `warning` å­—æ®µ
3. å¦‚æœæ²¡æœ‰è­¦å‘Šï¼Œè¯´æ˜å½±å­å†™å…¥æˆåŠŸ
4. æ£€æŸ¥è®¢å•åˆ—è¡¨ï¼Œç¡®è®¤æ–°è®¢å•æ˜¾ç¤º

## ğŸ“Š é¢„æœŸç»“æœ

### ä¿®å¤å‰
```
delivery_orders: 18 æ¡è®¢å•
order_main: 0 æ¡è®¢å•
è®¢å•åˆ—è¡¨: 0 æ¡è®¢å• âŒ
```

### ä¿®å¤å
```
delivery_orders: 18 æ¡è®¢å•
order_main: 18 æ¡è®¢å• âœ…
è®¢å•åˆ—è¡¨: 18 æ¡è®¢å• âœ…
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **Service Role Key å¿…é¡»é…ç½®**
   - å¦‚æœæœªé…ç½®ï¼Œæ–°è®¢å•åˆ›å»ºä¼šæˆåŠŸï¼Œä½†ä¸ä¼šåŒæ­¥åˆ° `order_main` è¡¨
   - å“åº”ä¸­ä¼šåŒ…å«è­¦å‘Šä¿¡æ¯

2. **è®¢å•å·å”¯ä¸€æ€§**
   - ä¿®å¤è„šæœ¬ä¼šç”Ÿæˆå”¯ä¸€çš„è®¢å•å·
   - æ ¼å¼ï¼š`FUEL` + æ—¶é—´æˆ³ + UUID ç‰‡æ®µ
   - å¦‚æœè®¢å•å·é‡å¤ï¼Œä¼šè‡ªåŠ¨æ·»åŠ åç¼€

3. **æ•°æ®ä¸€è‡´æ€§**
   - ä¿®å¤è„šæœ¬ä¼šæ£€æŸ¥é‡å¤ï¼Œé¿å…é‡å¤æ’å…¥
   - ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§

4. **RLS ç­–ç•¥**
   - ä¿®å¤è„šæœ¬å¿…é¡»ä½¿ç”¨ Service Role Key æ‰§è¡Œ
   - Service Role Key å¯ä»¥ç»•è¿‡ RLS ç­–ç•¥

## ğŸ” æ•…éšœæ’æŸ¥

### å¦‚æœä¿®å¤è„šæœ¬æ‰§è¡Œå¤±è´¥

1. **æ£€æŸ¥ Service Role Key**
   ```sql
   -- æ£€æŸ¥æ˜¯å¦æœ‰æƒé™æ’å…¥ order_main è¡¨
   SELECT * FROM order_main LIMIT 1;
   ```

2. **æ£€æŸ¥è®¢å•å·å”¯ä¸€æ€§**
   ```sql
   -- æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„è®¢å•å·
   SELECT order_number, COUNT(*) 
   FROM order_main 
   GROUP BY order_number 
   HAVING COUNT(*) > 1;
   ```

3. **æ£€æŸ¥å¤–é”®çº¦æŸ**
   ```sql
   -- æ£€æŸ¥ restaurant_id æ˜¯å¦å­˜åœ¨
   SELECT DISTINCT restaurant_id 
   FROM delivery_orders 
   WHERE restaurant_id NOT IN (SELECT id FROM restaurants);
   ```

### å¦‚æœæ–°è®¢å•ä»ç„¶æ— æ³•åŒæ­¥

1. **æ£€æŸ¥ç¯å¢ƒå˜é‡**
   ```bash
   # åœ¨ç»ˆç«¯ä¸­æ£€æŸ¥
   echo $SUPABASE_SERVICE_ROLE_KEY
   ```

2. **æ£€æŸ¥ API æ—¥å¿—**
   - æŸ¥çœ‹ç»ˆç«¯è¾“å‡ºï¼ŒæŸ¥æ‰¾ `[åˆ›å»ºè®¢å•API]` ç›¸å…³æ—¥å¿—
   - ç¡®è®¤æ˜¯å¦æœ‰ `âœ… å½±å­å†™å…¥æˆåŠŸ` æˆ–é”™è¯¯ä¿¡æ¯

3. **æ£€æŸ¥ RLS ç­–ç•¥**
   ```sql
   -- ç¡®è®¤ Service Role ç­–ç•¥å­˜åœ¨
   SELECT * FROM pg_policies 
   WHERE tablename = 'order_main' 
   AND policyname LIKE '%Service role%';
   ```

## ğŸ“ ç›¸å…³æ–‡ä»¶

- `app/api/orders/create/route.ts` - è®¢å•åˆ›å»º APIï¼ˆå·²ä¿®å¤ï¼‰
- `ä¿®å¤è®¢å•ä¸»è¡¨åŒæ­¥é—®é¢˜.sql` - æ•°æ®ä¿®å¤è„šæœ¬
- `è¯Šæ–­è®¢å•åˆ—è¡¨ä¸ºç©ºé—®é¢˜.sql` - è¯Šæ–­æŸ¥è¯¢è„šæœ¬
- `migrations/20250125_create_order_main_table.sql` - order_main è¡¨ç»“æ„

## âœ… éªŒè¯æ¸…å•

- [ ] Service Role Key å·²é…ç½®
- [ ] ä¿®å¤è„šæœ¬å·²æ‰§è¡Œ
- [ ] 18 æ¡è®¢å•å·²åŒæ­¥åˆ° `order_main` è¡¨
- [ ] `delivery_orders.main_order_id` å·²æ­£ç¡®å…³è”
- [ ] è®¢å•åˆ—è¡¨å¯ä»¥æ­£å¸¸æ˜¾ç¤º
- [ ] æ–°è®¢å•åˆ›å»ºæ—¶å½±å­å†™å…¥æˆåŠŸ
- [ ] æ²¡æœ‰è­¦å‘Šä¿¡æ¯

---

**ä¿®å¤æ—¥æœŸ**: 2025-01-28  
**ä¿®å¤çŠ¶æ€**: âœ… ä»£ç å·²ä¿®å¤ï¼Œç­‰å¾…æ‰§è¡Œæ•°æ®ä¿®å¤è„šæœ¬
