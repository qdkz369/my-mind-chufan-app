# ğŸ”„ è®¢å•é—­ç¯æµ‹è¯•æŒ‡å—

## ğŸ“‹ æµ‹è¯•æ¦‚è§ˆ

**ç›®æ ‡**: éªŒè¯ä»ä¸‹å•åˆ°æ˜¾ç¤ºçš„å®Œæ•´æ•°æ®æµ  
**èŒƒå›´**: å‰ç«¯UI â†’ åç«¯API â†’ æ•°æ®åº“ â†’ ç»Ÿä¸€åˆ—è¡¨  
**å…³é”®ç‚¹**: å‚æ•°ä¼ é€’ã€é”™è¯¯å¤„ç†ã€æ•°æ®åŒæ­¥

## ğŸ¯ æµ‹è¯•æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šåŸºç¡€ç¯å¢ƒéªŒè¯
```bash
# 1. éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€
curl -X GET "http://localhost:3000/api/user/context" \
  -H "Cookie: ä½ çš„ç™»å½•Cookie" \
  -H "Content-Type: application/json"

# æœŸæœ›ç»“æœï¼š
{
  "success": true,
  "data": {
    "userId": "xxx",
    "role": "platform_admin",
    "companyId": "xxx"
  }
}
```

```bash
# 2. éªŒè¯é¤å…ä¿¡æ¯è·å–
curl -X GET "http://localhost:3000/api/restaurants/current" \
  -H "Cookie: ä½ çš„ç™»å½•Cookie" \
  -H "Content-Type: application/json"

# æœŸæœ›ç»“æœï¼š
{
  "success": true,  
  "data": {
    "id": "xxx",
    "name": "é¤å…åç§°",
    "contact_name": "è”ç³»äºº",
    "contact_phone": "ç”µè¯",
    "address": "åœ°å€",
    "company_id": "xxx"
  }
}
```

### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºè®¢å•æµ‹è¯•
```bash
# 3. æµ‹è¯•è®¢å•åˆ›å»ºAPI
curl -X POST "http://localhost:3000/api/orders/create" \
  -H "Cookie: ä½ çš„ç™»å½•Cookie" \
  -H "Content-Type: application/json" \
  -d '{
    "order_number": "ORD-1737800000000",
    "restaurant_id": "é¤å…ID",
    "company_id": "å…¬å¸ID", 
    "product_type": "LPG",
    "service_type": "æ¶²åŒ–æ°” - 50kg",
    "status": "pending",
    "amount": 575,
    "total_amount": 575,
    "contact_name": "å¼ ä¸‰",
    "contact_phone": "13800000000",
    "delivery_address": "æµ‹è¯•åœ°å€",
    "notes": "æµ‹è¯•è®¢å•"
  }'

# æœŸæœ›ç»“æœï¼š
{
  "success": true,
  "message": "è®¢å•åˆ›å»ºæˆåŠŸ",
  "data": {
    "id": "delivery_order_id",
    "order_number": "ORD-1737800000000",
    "status": "pending"
  }
}
```

### ç¬¬ä¸‰æ­¥ï¼šéªŒè¯æ•°æ®åŒæ­¥
```bash
# 4. éªŒè¯è®¢å•ä¸»è¡¨åŒæ­¥
curl -X GET "http://localhost:3000/api/orders/main/list?order_number=ORD-1737800000000" \
  -H "Cookie: ä½ çš„ç™»å½•Cookie" \
  -H "Content-Type: application/json"

# æœŸæœ›ç»“æœï¼š
{
  "success": true,
  "data": [
    {
      "id": "order_main_id", 
      "order_number": "ORD-1737800000000",
      "order_type": "fuel",
      "fuel_order_id": "delivery_order_id",
      "status": "pending",
      "total_amount": 575
    }
  ]
}
```

### ç¬¬å››æ­¥ï¼šUIåŠŸèƒ½æµ‹è¯•

#### A. åˆ›å»ºè®¢å•é¡µé¢ (`/orders/create`)
- [ ] **é¡µé¢åŠ è½½**: è®¢å•å·è‡ªåŠ¨ç”Ÿæˆ
- [ ] **ä¿¡æ¯å¡«å……**: è”ç³»æ–¹å¼è‡ªåŠ¨å¡«å……
- [ ] **äº§å“é€‰æ‹©**: ä»·æ ¼å®æ—¶è®¡ç®—
- [ ] **è¡¨å•éªŒè¯**: å¿…å¡«å­—æ®µéªŒè¯
- [ ] **æäº¤æµ‹è¯•**: å®Œæ•´åˆ›å»ºæµç¨‹
- [ ] **ç»“æœæ˜¾ç¤º**: æˆåŠŸæç¤ºå’Œå½±å­å†™å…¥çŠ¶æ€

#### B. è®¢å•åˆ—è¡¨é¡µé¢ (`/orders`)  
- [ ] **æ•°æ®åŠ è½½**: è®¢å•åˆ—è¡¨æ­£å¸¸æ˜¾ç¤º
- [ ] **ç­›é€‰åŠŸèƒ½**: ç‡ƒæ–™/ç§Ÿèµç­›é€‰æ­£å¸¸
- [ ] **çŠ¶æ€ç­›é€‰**: å¾…å¤„ç†/å·²å®Œæˆç­›é€‰æ­£å¸¸
- [ ] **åˆ†é¡µåŠŸèƒ½**: åˆ†é¡µå¯¼èˆªæ­£å¸¸
- [ ] **é”™è¯¯å¤„ç†**: åŠ è½½å¤±è´¥æ—¶å‹å¥½æç¤º

## ğŸ” é—®é¢˜æ’æŸ¥

### å¸¸è§é—®é¢˜1ï¼šrestaurant_id ç¼ºå¤±
**ç°è±¡**: å‰ç«¯æç¤º"æ— æ³•è·å–é¤å…ä¿¡æ¯"  
**æ’æŸ¥**:
```javascript
// æµè§ˆå™¨æ§åˆ¶å°æ£€æŸ¥
console.log('é¤å…ä¿¡æ¯:', restaurantInfo)
console.log('ç”¨æˆ·ä¸Šä¸‹æ–‡:', await fetch('/api/user/context', {credentials: 'include'}).then(r => r.json()))
```

**è§£å†³**:
- ç¡®ä¿ç”¨æˆ·å·²æ­£ç¡®ç™»å½•
- æ£€æŸ¥ `user_roles` è¡¨ä¸­æ˜¯å¦æœ‰ç”¨æˆ·è®°å½•
- æ£€æŸ¥ `restaurants` è¡¨ä¸­æ˜¯å¦æœ‰ `user_id` å…³è”

### å¸¸è§é—®é¢˜2ï¼šè®¢å•åˆ—è¡¨500é”™è¯¯  
**ç°è±¡**: è®¢å•åˆ—è¡¨é¡µé¢æ˜¾ç¤º"æœåŠ¡å™¨æš‚æ—¶ç¹å¿™"  
**æ’æŸ¥**:
```bash
# æ£€æŸ¥ order_main è¡¨æ˜¯å¦å­˜åœ¨
psql -c "SELECT COUNT(*) FROM order_main;"

# æ£€æŸ¥ RLS ç­–ç•¥
psql -c "SELECT * FROM pg_policies WHERE tablename = 'order_main';"
```

**è§£å†³**:
- ç¡®ä¿æ•°æ®åº“è¿ç§»å·²æ‰§è¡Œ
- æ£€æŸ¥ RLS ç­–ç•¥æ˜¯å¦æ­£ç¡®é…ç½®
- æ£€æŸ¥ Service Role Key é…ç½®

### å¸¸è§é—®é¢˜3ï¼šå½±å­å†™å…¥å¤±è´¥
**ç°è±¡**: åˆ›å»ºæˆåŠŸä½†ç»Ÿä¸€åˆ—è¡¨ä¸­æ²¡æœ‰æ˜¾ç¤º  
**æ’æŸ¥**:
```bash
# æ£€æŸ¥è¡¨å…³è”
psql -c "SELECT o.id, o.order_number, m.id as main_id, o.main_order_id 
         FROM delivery_orders o 
         LEFT JOIN order_main m ON o.main_order_id = m.id
         ORDER BY o.created_at DESC LIMIT 5;"
```

**è§£å†³**:
- æ£€æŸ¥ Service Role Key æƒé™
- æ£€æŸ¥è®¢å•å·æ˜¯å¦é‡å¤
- æ£€æŸ¥å¤–é”®çº¦æŸ

## ğŸš¨ ç´§æ€¥æ•…éšœå¤„ç†

### å¿«é€Ÿæ¢å¤å‘½ä»¤
```bash
# 1. é‡ç½® RLS ç­–ç•¥ï¼ˆå¦‚æœæƒé™é—®é¢˜ï¼‰
psql -c "DROP POLICY IF EXISTS 'Service role full access to order_main' ON order_main;
         CREATE POLICY 'Service role full access to order_main' 
         ON order_main FOR ALL TO service_role 
         USING (true) WITH CHECK (true);"

# 2. æ¸…ç†æµ‹è¯•æ•°æ®  
psql -c "DELETE FROM order_main WHERE order_number LIKE 'ORD-%' AND notes = 'æµ‹è¯•è®¢å•';"

# 3. é‡å¯åº”ç”¨æœåŠ¡
npm run dev
```

## âœ… æˆåŠŸæ ‡å‡†

### å®Œæ•´é—­ç¯éªŒè¯æ¸…å•
1. **åˆ›å»ºè®¢å•** âœ…
   - [ ] å‰ç«¯ä¿¡æ¯è‡ªåŠ¨å¡«å……
   - [ ] APIæˆåŠŸåˆ›å»º delivery_orders è®°å½•
   - [ ] åŒæ—¶åˆ›å»º order_main è®°å½•  
   - [ ] main_order_id æ­£ç¡®å…³è”

2. **åˆ—è¡¨æ˜¾ç¤º** âœ…
   - [ ] ç»Ÿä¸€åˆ—è¡¨æ˜¾ç¤ºæ–°è®¢å•
   - [ ] ç­›é€‰å™¨æ­£å¸¸å·¥ä½œ
   - [ ] è®¢å•è¯¦æƒ…å®Œæ•´æ˜¾ç¤º
   - [ ] å¤šç§Ÿæˆ·éš”ç¦»æ­£ç¡®

3. **å¼‚å¸¸å¤„ç†** âœ…
   - [ ] åˆ›å»ºå¤±è´¥æ—¶å‹å¥½æç¤º
   - [ ] åˆ—è¡¨åŠ è½½å¤±è´¥æ—¶é‡è¯•æœºåˆ¶
   - [ ] å½±å­å†™å…¥å¤±è´¥æ—¶è­¦å‘Šæç¤º

### æ•°æ®ä¸€è‡´æ€§éªŒè¯
```sql
-- éªŒè¯æ•°æ®åŒæ­¥
SELECT 
  d.id as delivery_id,
  d.order_number as delivery_order_number,
  d.main_order_id,
  m.id as main_id,
  m.order_number as main_order_number,
  m.order_type,
  m.total_amount
FROM delivery_orders d
LEFT JOIN order_main m ON d.main_order_id = m.id
WHERE d.order_number LIKE 'ORD-%'
ORDER BY d.created_at DESC
LIMIT 10;
```

**æœŸæœ›ç»“æœ**: æ¯ä¸ª delivery_orders è®°å½•éƒ½åº”è¯¥æœ‰å¯¹åº”çš„ order_main è®°å½•ï¼Œä¸”è®¢å•å·ä¸€è‡´ã€‚

## ğŸ‰ æµ‹è¯•æˆåŠŸæ ‡å¿—

å½“ä»¥ä¸‹æ‰€æœ‰æ¡ä»¶æ»¡è¶³æ—¶ï¼Œé—­ç¯æµ‹è¯•é€šè¿‡ï¼š
- âœ… ç”¨æˆ·å¯ä»¥æ­£å¸¸è®¿é—® `/orders/create` é¡µé¢
- âœ… è¡¨å•ä¿¡æ¯èƒ½è‡ªåŠ¨å¡«å……å’Œæ‰‹åŠ¨ä¿®æ”¹
- âœ… ç‚¹å‡»"ç¡®è®¤ä¸‹å•"èƒ½æˆåŠŸåˆ›å»ºè®¢å•
- âœ… åˆ›å»ºæˆåŠŸåæ˜¾ç¤ºå½±å­å†™å…¥çŠ¶æ€
- âœ… åœ¨ `/orders` åˆ—è¡¨ä¸­èƒ½çœ‹åˆ°æ–°åˆ›å»ºçš„è®¢å•
- âœ… ç­›é€‰å’Œåˆ†é¡µåŠŸèƒ½æ­£å¸¸å·¥ä½œ
- âœ… æ‰€æœ‰é”™è¯¯æƒ…å†µéƒ½æœ‰å‹å¥½æç¤º

**ğŸš€ è¾¾æˆä»¥ä¸Šæ ‡å‡†å³è¡¨ç¤ºè®¢å•ç³»ç»Ÿå·²å®Œæˆå…¨çº¿æ‰“é€šï¼**