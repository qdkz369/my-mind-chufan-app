# 调试登录权限问题

## 🔍 问题分析

从网络请求看：
- ✅ 认证成功（`user` 请求 200 OK）
- ✅ 角色查询成功（`user_roles` 请求 200 OK）
- ❌ 但前端显示"您没有管理员权限"

**可能的原因：**
1. 用户角色不是 `super_admin` 或 `admin`
2. 角色查询返回的数据格式不对
3. 用户没有角色记录（返回 null）

---

## 📋 调试步骤

### 第一步：查看浏览器控制台日志

打开浏览器控制台（F12），查看 Console 标签页，寻找以下日志：

```
[登录页] 角色查询结果: {...}
[登录页] 用户角色详情: {...}
```

**关键信息：**
- `roleData` 的值是什么？
- `actualRole` 的值是什么？
- `roleMatch` 是否为 `true`？

### 第二步：检查数据库中的用户角色

在 Supabase SQL Editor 中执行：

```sql
-- 查看所有用户及其角色
SELECT 
  u.id AS 用户ID,
  u.email AS 邮箱,
  ur.role AS 角色,
  CASE 
    WHEN ur.role IS NULL THEN '❌ 没有角色记录'
    WHEN ur.role NOT IN ('super_admin', 'admin') THEN '❌ 角色不是管理员: ' || ur.role
    ELSE '✅ 角色正确'
  END AS 状态
FROM auth.users u
LEFT JOIN user_roles ur ON u.id = ur.user_id
WHERE u.email = 'admin@example.com';
```

### 第三步：根据结果处理

#### 情况1：没有角色记录（`roleData` 为 `null`）

**解决方法：**
1. 在 Supabase SQL Editor 中执行：
   ```sql
   -- 首先获取用户ID
   SELECT id FROM auth.users WHERE email = 'admin@example.com';
   
   -- 然后分配角色（替换用户ID）
   INSERT INTO user_roles (user_id, role)
   VALUES ('你的用户ID', 'super_admin')
   ON CONFLICT (user_id) DO UPDATE SET role = 'super_admin';
   ```

#### 情况2：角色不是 `super_admin` 或 `admin`

**解决方法：**
1. 在 Supabase SQL Editor 中执行：
   ```sql
   -- 更新用户角色（替换用户ID）
   UPDATE user_roles
   SET role = 'super_admin'
   WHERE user_id = '你的用户ID';
   ```

#### 情况3：角色查询返回数组而不是对象

**解决方法：**
- 代码已经处理了这种情况（使用 `maybeSingle()` 和数组检查）
- 如果仍然有问题，查看控制台日志中的 `roleData` 格式

---

## 🔧 快速修复脚本

如果用户没有角色记录，执行以下 SQL：

```sql
-- 1. 查找用户ID
SELECT id, email FROM auth.users WHERE email = 'admin@example.com';

-- 2. 分配角色（替换上面的用户ID）
INSERT INTO user_roles (user_id, role)
VALUES ('你的用户ID', 'super_admin')
ON CONFLICT (user_id) DO UPDATE SET role = 'super_admin';

-- 3. 验证
SELECT 
  u.email,
  ur.role
FROM auth.users u
JOIN user_roles ur ON u.id = ur.user_id
WHERE u.email = 'admin@example.com';
```

---

## 📊 预期结果

**成功标志：**
- 控制台显示：`[登录页] 用户角色详情: { actualRole: 'super_admin', roleMatch: true }`
- 登录成功并跳转到 `/dashboard`
- 不再显示"您没有管理员权限"错误

**如果仍然失败：**
- 查看控制台日志中的 `roleData` 和 `actualRole` 值
- 执行 SQL 查询确认数据库中的角色
- 提供控制台日志给我进一步分析

---

**请先查看浏览器控制台的日志，然后告诉我 `roleData` 和 `actualRole` 的值！** 🔍
