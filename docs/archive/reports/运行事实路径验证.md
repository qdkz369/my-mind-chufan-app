# 运行事实路径最小可用性验证

## 快速开始

### 1. 确保环境配置

```bash
# 检查 .env.local 文件是否存在并包含：
# NEXT_PUBLIC_SUPABASE_URL=...
# SUPABASE_SERVICE_ROLE_KEY=... (或 NEXT_PUBLIC_SUPABASE_ANON_KEY)
```

### 2. 启动应用（如果需要通过 HTTP 调用 API）

```bash
npm run dev
```

### 3. 运行验证脚本

```bash
node scripts/verify-fact-path-minimal.js
```

## 预期结果

脚本会：

1. ✅ 查找或创建测试订单（ID: `00000000-0000-0000-0000-000000000001`）
2. ✅ 插入 4 条测试 audit_logs 记录：
   - ORDER_ACCEPT（正常时间）
   - ORDER_COMPLETE（正常时间）
   - ORDER_COMPLETED（时间异常：早于订单创建时间）
   - ORDER_ACCEPTED（时间异常：早于订单创建时间）
3. ✅ 调用 `GET /api/facts/orders/:order_id`
4. ✅ 输出完整的 JSON 响应
5. ✅ 分析并显示：
   - fact_warnings_structured 生成情况
   - fact_health.score 和汇总
   - 每条 warning 与 audit_logs 记录的关联

## 验证要点

### ✅ 应该生成的警告

1. **FACT_TIME_INVERSION** (high)
   - 原因：ORDER_COMPLETED 的 created_at 早于订单 created_at
   - 关联记录：ORDER_COMPLETED（时间异常）

2. **FACT_TIMELINE_BREAK** 或 **FACT_TIMELINE_ANOMALY** (high/low)
   - 原因：ORDER_ACCEPTED 的 created_at 早于订单 created_at
   - 关联记录：ORDER_ACCEPTED（时间异常）

### ✅ 健康度分数计算

- 2 个 high 警告：100 - (2 × 30) = 40
- 或 1 个 high + 1 个 low：100 - 30 - 3 = 67

## 清理测试数据

验证完成后：

```sql
-- 删除测试 audit_logs 记录
DELETE FROM audit_logs 
WHERE target_id = '00000000-0000-0000-0000-000000000001' 
  AND metadata->>'test' = 'true';
```

## 故障排除

### 问题：API 调用失败（401 未授权）

**原因**：权限验证失败

**解决**：
- 确保传递了正确的 `x-restaurant-id` 请求头
- 检查订单的 `restaurant_id` 是否与请求头匹配

### 问题：无法插入 audit_logs

**原因**：RLS 策略限制或缺少权限

**解决**：
- 使用 `SUPABASE_SERVICE_ROLE_KEY`（绕过 RLS）
- 或调整 RLS 策略允许插入测试记录

### 问题：找不到订单

**原因**：订单不存在且无法创建

**解决**：
- 确保数据库中有至少一个餐厅记录
- 检查 delivery_orders 表的 RLS 策略

## 完整文档

详细说明请参考：`事实路径最小可用性验证说明.md`
