# é˜¶æ®µ 2A ç¬¬ 1 æ­¥ - å®ŒæˆæŠ¥å‘Š

## âœ… å·²å®Œæˆå·¥ä½œ

### 1ï¸âƒ£ æ–°å»ºç»Ÿä¸€ç”¨æˆ·ä¸Šä¸‹æ–‡æ¨¡å—

**æ–°å¢æ–‡ä»¶ï¼š** `lib/auth/user-context.ts`

**åŠŸèƒ½ï¼š**
- å¯¼å‡º `getUserContext` å‡½æ•°ï¼Œä½œä¸ºç³»ç»Ÿä¸­å”¯ä¸€å¯ä¿¡çš„æƒé™å…¥å£
- ä» Supabase Auth session ä¸­è·å– `userId`
- ä» `user_roles` è¡¨è·å– `role`
- å¦‚æœ `role â‰  super_admin`ï¼Œå¿…é¡»ä» `user_companies` è·å– `company_id`
- å¦‚æœæŸ¥ä¸åˆ° `company_id`ï¼ˆé super_adminï¼‰ï¼Œç›´æ¥æŠ›å‡ºé”™è¯¯
- `super_admin` å…è®¸ `companyId` ä¸º `undefined`

**ç±»å‹å®šä¹‰ï¼š**
```typescript
export type UserRole = "super_admin" | "admin" | "staff"

export interface UserContext {
  userId: string
  role: UserRole
  companyId?: string
}
```

### 2ï¸âƒ£ æ ‡æ³¨ç°æœ‰ç›´æ¥æŸ¥è¯¢é€»è¾‘

å·²åœ¨ä»¥ä¸‹æ–‡ä»¶ä¸­æ ‡æ³¨ TODOï¼Œç¦æ­¢ API è‡ªè¡ŒæŸ¥è¯¢ `user_roles` æˆ– `user_companies`ï¼š

**æ–‡ä»¶ï¼š** `app/api/admin/create-company/route.ts`
- ç¬¬ 72-76 è¡Œï¼šç›´æ¥æŸ¥è¯¢ `user_roles` è¡¨ï¼ˆå·²æ ‡æ³¨ TODOï¼‰
- ç¬¬ 209-225 è¡Œï¼šç›´æ¥æŸ¥è¯¢ `user_companies` è¡¨ï¼ˆå·²æ ‡æ³¨ TODOï¼Œä½†å†™å…¥æ“ä½œä¿ç•™ï¼‰

**æ–‡ä»¶ï¼š** `lib/multi-tenant.ts`
- `getCurrentCompanyId` å‡½æ•°ä¸­æŸ¥è¯¢ `user_companies`ï¼ˆå·²æ ‡æ³¨ TODOï¼‰
- `verifyCompanyAccess` å‡½æ•°ä¸­æŸ¥è¯¢ `user_companies`ï¼ˆå·²æ ‡æ³¨ TODOï¼‰

## ğŸ“‹ å‡†å¤‡åœ¨ä¸‹ä¸€æ­¥æ¥å…¥çš„ API

ä»¥ä¸‹ API æ–‡ä»¶ä½¿ç”¨äº† `getCurrentUserId`ã€`getCurrentCompanyId` æˆ– `verifyCompanyAccess`ï¼Œè¿™äº›å‡½æ•°å†…éƒ¨ä¼šæŸ¥è¯¢ `user_companies`ï¼Œéœ€è¦åœ¨ä¸‹ä¸€æ­¥æ¥å…¥ `getUserContext`ï¼š

1. **`app/api/admin/create-company/route.ts`**
   - å½“å‰ï¼šç›´æ¥æŸ¥è¯¢ `user_roles` å’Œ `user_companies`
   - éœ€è¦ï¼šä½¿ç”¨ `getUserContext` è·å–ç”¨æˆ·ä¸Šä¸‹æ–‡

2. **`app/api/status/transition/route.ts`**
   - å½“å‰ï¼šä½¿ç”¨ `getCurrentUserId` å’Œ `getCurrentCompanyId`
   - éœ€è¦ï¼šæ›¿æ¢ä¸º `getUserContext`

3. **`app/api/equipment/rental/update/route.ts`**
   - å½“å‰ï¼šä½¿ç”¨ `getCurrentUserId` å’Œ `getCurrentCompanyId`
   - éœ€è¦ï¼šæ›¿æ¢ä¸º `getUserContext`

4. **`app/api/equipment/rental/list/route.ts`**
   - å½“å‰ï¼šä½¿ç”¨ `getCurrentUserId` å’Œ `getCurrentCompanyId`
   - éœ€è¦ï¼šæ›¿æ¢ä¸º `getUserContext`

5. **`app/api/equipment/rental/admin/list/route.ts`**
   - å½“å‰ï¼šä½¿ç”¨ `getCurrentUserId` å’Œ `getCurrentCompanyId`
   - éœ€è¦ï¼šæ›¿æ¢ä¸º `getUserContext`

6. **`app/api/equipment/catalog/list/route.ts`**
   - å½“å‰ï¼šä½¿ç”¨ `getCurrentUserId` å’Œ `getCurrentCompanyId`
   - éœ€è¦ï¼šæ›¿æ¢ä¸º `getUserContext`

7. **`app/api/equipment/rental/create/route.ts`**
   - å½“å‰ï¼šä½¿ç”¨ `getCurrentUserId` å’Œ `getCurrentCompanyId`
   - éœ€è¦ï¼šæ›¿æ¢ä¸º `getUserContext`

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æµ‹è¯• API é™¤å¤–ï¼š** `app/api/test/env/route.ts` ä¸­çš„æŸ¥è¯¢ç”¨äºæµ‹è¯•è¿æ¥ï¼Œä¿ç•™ä¸å˜

2. **å†™å…¥æ“ä½œä¿ç•™ï¼š** `app/api/admin/create-company/route.ts` ä¸­åˆ›å»º `user_companies` å…³è”è®°å½•çš„å†™å…¥æ“ä½œä¿ç•™ï¼Œä½†è¯»å–é€»è¾‘åº”é€šè¿‡ `getUserContext` è·å–

3. **ä¸æ”¹ä¸šåŠ¡é€»è¾‘ï¼š** æœ¬é˜¶æ®µåªåšèº«ä»½ä¸æƒé™å…¥å£æ”¶å£ï¼Œä¸æ”¹ä¸šåŠ¡é€»è¾‘ã€UI å’ŒåŠŸèƒ½

## ğŸ¯ ä¸‹ä¸€æ­¥å·¥ä½œ

åœ¨é˜¶æ®µ 2A ç¬¬ 2 æ­¥ä¸­ï¼Œéœ€è¦ï¼š
1. å°†æ‰€æœ‰æ ‡æ³¨äº† TODO çš„ API æ¥å…¥ `getUserContext`
2. ç§»é™¤ç›´æ¥æŸ¥è¯¢ `user_roles` å’Œ `user_companies` çš„é€»è¾‘
3. ç¡®ä¿æ‰€æœ‰æƒé™æ£€æŸ¥éƒ½é€šè¿‡ç»Ÿä¸€çš„ `getUserContext` å…¥å£
