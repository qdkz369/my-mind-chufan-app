# 阶段 2B-3：功能与数据确定性验证 - 实证执行指南

**执行日期**：2025-01-20  
**执行目标**：完成实际功能验证，确认系统可正常运行

---

## 📋 执行前准备

### 1. 环境准备

- [ ] 确保本地开发服务器正在运行：`npm run dev`
- [ ] 确认 Supabase 连接正常
- [ ] 准备测试数据（餐厅ID、工人ID等）

### 2. 测试数据准备

修改 `scripts/verify-phase-2b3-execute.js` 中的测试数据：

```javascript
const TEST_DATA = {
  restaurant_id: 'YOUR_RESTAURANT_ID', // 替换为真实餐厅ID
  worker_id: 'YOUR_WORKER_ID', // 替换为真实工人ID
  user_token: '', // 可选：用户认证令牌
};
```

或设置环境变量：

```bash
export TEST_RESTAURANT_ID="your-restaurant-id"
export TEST_WORKER_ID="your-worker-id"
```

---

## 一、功能实证验证（API 实际调用）

### 执行步骤

1. **启动验证脚本**：
   ```bash
   node scripts/verify-phase-2b3-execute.js
   ```

2. **观察输出结果**：
   - 每个 API 调用的 HTTP 状态码
   - 是否成功写入/更新数据库
   - 是否有 RLS/permission 错误
   - 是否有未捕获异常

3. **记录验证结果**：
   - 查看生成的 `phase-2b3-execution-results.json` 文件
   - 将结果填写到验证报告

### 验证清单

| 测试项 | API | 验证点 | 状态 |
|--------|-----|--------|------|
| 1. 创建报修工单 | POST /api/repair/create | HTTP 200, 数据库写入, 无 RLS 错误 | ⬜ |
| 2. 查询报修工单列表 | GET /api/repair/list | HTTP 200, 返回数据, 包含刚创建的工单 | ⬜ |
| 3. 更新报修工单状态 | POST /api/repair/update | HTTP 200, 数据库更新, 状态变更 | ⬜ |
| 4. 创建燃料配送订单 | POST /api/orders/create | HTTP 200, 数据库写入, 无 RLS 错误 | ⬜ |
| 5. 查询待接单列表 | GET /api/orders/pending | HTTP 200, 返回数据, 包含刚创建的订单 | ⬜ |
| 6. 接单流程 | POST /api/orders/accept | HTTP 200, 状态更新为 active | ⬜ |
| 7. 派单流程 | POST /api/orders/dispatch | HTTP 200, 状态更新为 delivering | ⬜ |
| 8. 完成配送 | POST /api/orders/complete | HTTP 200, 状态更新为 completed | ⬜ |
| 9. 支付回调（模拟） | POST /api/payment/alipay/notify | HTTP 200, 状态更新为 paid | ⬜ |

### 预期结果

- ✅ **所有 API 返回 HTTP 200**
- ✅ **数据库记录正确写入/更新**
- ✅ **无 RLS 错误**
- ✅ **无权限错误**
- ✅ **无未捕获异常**

---

## 二、数据一致性验证（SQL 实际执行）

### 执行步骤

1. **打开 Supabase Dashboard**：
   - 登录 Supabase Dashboard
   - 进入 SQL Editor

2. **执行验证 SQL**：
   - 复制 `scripts/verify-phase-2b3-sql.sql` 内容
   - 在 SQL Editor 中执行
   - 记录所有查询结果

3. **重点验证**：
   - [ ] `repair_orders` 表数据量
   - [ ] `delivery_orders` 表数据量
   - [ ] 与原 `orders` 表数据对比
   - [ ] NULL 值检查
   - [ ] 数据完整性检查

### 验证清单

| 验证项 | SQL 查询 | 预期结果 | 实际结果 | 状态 |
|--------|---------|---------|---------|------|
| 1. 数据量统计 | 查询 1 | repair_orders > 0, delivery_orders > 0 | ⬜ | ⬜ |
| 2. 数据迁移对比 | 查询 2 | 差异 < 10% | ⬜ | ⬜ |
| 3. NULL 值检查 | 查询 3 | 关键字段 NULL = 0 | ⬜ | ⬜ |
| 4. 数据完整性 | 查询 4 | 数据分布合理 | ⬜ | ⬜ |
| 5. 表结构检查 | 查询 5 | 字段完整 | ⬜ | ⬜ |
| 6. 索引检查 | 查询 6 | 索引存在 | ⬜ | ⬜ |
| 7. RLS 策略检查 | 查询 7 | 6 条策略 | ⬜ | ⬜ |

### 预期结果

- ✅ **数据迁移完整**（差异 < 10%）
- ✅ **关键字段无 NULL 值**
- ✅ **数据完整性正常**
- ✅ **表结构正确**
- ✅ **索引完整**
- ✅ **RLS 策略完整**

---

## 三、日志与权限风险扫描

### 检查步骤

1. **本地服务器日志**：
   ```bash
   # 查看 Next.js 开发服务器输出
   # 搜索以下关键词：
   # - relation does not exist
   # - permission denied
   # - RLS violation
   # - row-level security
   ```

2. **Supabase Logs**：
   - 登录 Supabase Dashboard
   - 进入 Logs 页面
   - 搜索错误日志

3. **浏览器 Console**：
   - 打开浏览器开发者工具
   - 查看 Console 标签
   - 搜索错误信息

4. **验证 SYSTEM_LEVEL API**：
   - 测试 `POST /api/admin/create-company`
   - 测试 `POST /api/admin/find-user`

### 检查清单

| 检查项 | 位置 | 预期结果 | 实际结果 | 状态 |
|--------|------|---------|---------|------|
| 1. 服务器日志 | Next.js 输出 | 无 relation does not exist | ⬜ | ⬜ |
| 2. 服务器日志 | Next.js 输出 | 无 permission denied | ⬜ | ⬜ |
| 3. 服务器日志 | Next.js 输出 | 无 RLS violation | ⬜ | ⬜ |
| 4. Supabase 日志 | Dashboard | 无严重错误 | ⬜ | ⬜ |
| 5. 浏览器 Console | DevTools | 无 API 错误 | ⬜ | ⬜ |
| 6. create-company API | 实际调用 | 正常工作 | ⬜ | ⬜ |
| 7. find-user API | 实际调用 | 正常工作 | ⬜ | ⬜ |

### 预期结果

- ✅ **无 relation does not exist 错误**
- ✅ **无 permission denied 错误**
- ✅ **无 RLS violation 错误**
- ✅ **SYSTEM_LEVEL API 正常工作**

---

## 四、输出最终结论

### 验证结果汇总

完成所有验证后，请填写以下结论：

#### 1. 功能验证

- [ ] ✅ **通过** - 所有 API 功能正常
- [ ] ❌ **不通过** - 存在功能问题（列出问题）

**详细说明**：
```
[填写功能验证结果]
```

#### 2. 数据验证

- [ ] ✅ **通过** - 数据一致性正常
- [ ] ⚠️ **轻微偏差** - 存在轻微偏差（说明原因）
- [ ] ❌ **明显异常** - 存在明显异常（阻塞）

**详细说明**：
```
[填写数据验证结果]
```

#### 3. 风险扫描

- [ ] ✅ **通过** - 无严重风险
- [ ] ⚠️ **有警告** - 存在警告但不影响功能
- [ ] ❌ **有错误** - 存在错误需要修复

**详细说明**：
```
[填写风险扫描结果]
```

#### 4. 阻塞问题

**是否存在阻塞进入 2B-4 的问题？**

- [ ] ✅ **无阻塞问题** - 可以进入下一阶段
- [ ] ❌ **存在阻塞问题** - 需要先解决（列出问题）

**阻塞问题列表**：
1. `____`
2. `____`
3. `____`

#### 5. 最终结论

**是否可以正式进入【阶段 2B-4：权限迁移】？**

- [ ] ✅ **是** - 所有验证通过，可以进入阶段 2B-4
- [ ] ❌ **否** - 存在阻塞问题，需要先解决
- [ ] ⚠️ **部分通过** - 部分问题需要解决，但不阻塞下一阶段

**结论说明**：
```
[填写最终结论和说明]
```

---

## 📝 验证报告填写

完成所有验证后，请将结果填写到：
- `阶段2B-3-功能与数据确定性验证-验证结果汇总.md`

重点填写：
1. 第一部分：功能主干路径测试结果（实际验证结果）
2. 第二部分：数据一致性验证结果（SQL 查询结果）
3. 第三部分：风险扫描结果（日志检查结果）
4. 第五部分：验证结论（最终结论）

---

## ⚠️ 重要提醒

**在未明确确认前**：
- ❌ 不得开始权限迁移
- ❌ 不得修改 RLS
- ❌ 不得合并或删除旧权限逻辑
- ❌ 不得进入阶段 2B-4

**只有所有验证通过后，才能进入下一阶段！**
