# é˜¶æ®µ 2B-3 éªŒè¯ç»“æœé—®é¢˜åˆ†æ

**éªŒè¯æ—¥æœŸ**ï¼š2026-01-09  
**éªŒè¯çŠ¶æ€**ï¼šå‘ç° RLS ç­–ç•¥é—®é¢˜

---

## ğŸ“Š éªŒè¯ç»“æœæ±‡æ€»

### æµ‹è¯•æ‰§è¡Œæƒ…å†µ

- **æ€»æµ‹è¯•æ•°**ï¼š5
- **é€šè¿‡**ï¼š3 âœ…
- **å¤±è´¥**ï¼š2 âŒ
- **é€šè¿‡ç‡**ï¼š60.0%

### è¯¦ç»†ç»“æœ

| æµ‹è¯•é¡¹ | API | HTTP çŠ¶æ€ç  | ç»“æœ | é—®é¢˜ |
|--------|-----|------------|------|------|
| 1. åˆ›å»ºæŠ¥ä¿®å·¥å• | POST /api/repair/create | 200 | âœ… æˆåŠŸ | âš ï¸ æ•°æ®åº“éªŒè¯å¤±è´¥ï¼ˆRLSé—®é¢˜ï¼‰ |
| 2. æŸ¥è¯¢æŠ¥ä¿®å·¥å•åˆ—è¡¨ | GET /api/repair/list | 200 | âœ… æˆåŠŸ | âš ï¸ è¿”å›0æ¡ï¼Œä¸åŒ…å«åˆšåˆ›å»ºçš„å·¥å•ï¼ˆRLSé—®é¢˜ï¼‰ |
| 3. æ›´æ–°æŠ¥ä¿®å·¥å•çŠ¶æ€ | POST /api/repair/update | 500 | âŒ å¤±è´¥ | ğŸ”´ RLS/æŸ¥è¯¢é—®é¢˜ |
| 4. åˆ›å»ºç‡ƒæ–™é…é€è®¢å• | POST /api/orders/create | 500 | âŒ å¤±è´¥ | ğŸ”´ **RLSç­–ç•¥è¿å** |
| 5. æŸ¥è¯¢å¾…æ¥å•åˆ—è¡¨ | GET /api/orders/pending | 200 | âœ… æˆåŠŸ | - |

---

## ğŸ” é—®é¢˜åˆ†æ

### é—®é¢˜ 1ï¼šåˆ›å»ºæŠ¥ä¿®å·¥å• - RLS æŸ¥è¯¢é—®é¢˜

**ç°è±¡**ï¼š
- API è¿”å› 200ï¼Œåˆ›å»ºæˆåŠŸ
- ä½†æ•°æ®åº“éªŒè¯å¤±è´¥ï¼š"Record not found"
- æŸ¥è¯¢åˆ—è¡¨è¿”å›0æ¡ï¼Œä¸åŒ…å«åˆšåˆ›å»ºçš„å·¥å•

**åŸå› åˆ†æ**ï¼š
- æ•°æ®å¯èƒ½å·²åˆ›å»ºï¼Œä½† RLS ç­–ç•¥é˜»æ­¢äº†æŸ¥è¯¢
- RLS ç­–ç•¥å¯èƒ½è¦æ±‚ `user_id` åŒ¹é… `auth.uid()`
- ä½†åˆ›å»ºæ—¶å¯èƒ½ä½¿ç”¨äº† Service Role Keyï¼Œå¯¼è‡´ `user_id` ä¸º NULL æˆ–ä¸åŒ¹é…

**é”™è¯¯ä¿¡æ¯**ï¼š
- æ•°æ®åº“éªŒè¯ï¼š`Record not found`
- æŸ¥è¯¢åˆ—è¡¨ï¼šè¿”å›ç©ºæ•°ç»„

---

### é—®é¢˜ 2ï¼šæ›´æ–°æŠ¥ä¿®å·¥å•çŠ¶æ€ - æŸ¥è¯¢é”™è¯¯

**ç°è±¡**ï¼š
- HTTP 500 é”™è¯¯
- é”™è¯¯ä¿¡æ¯ï¼š`"Cannot coerce the result to a single JSON object"`

**åŸå› åˆ†æ**ï¼š
- æŸ¥è¯¢æ—¶ä½¿ç”¨äº† `.single()`ï¼Œä½†è¿”å›äº†å¤šæ¡è®°å½•æˆ–0æ¡è®°å½•
- å¯èƒ½æ˜¯ RLS ç­–ç•¥å¯¼è‡´æŸ¥è¯¢ä¸åˆ°è®°å½•
- æˆ–è€…æŸ¥è¯¢æ¡ä»¶æœ‰é—®é¢˜

**é”™è¯¯ä¿¡æ¯**ï¼š
```json
{
  "error": "æŸ¥è¯¢æŠ¥ä¿®å·¥å•å¤±è´¥",
  "details": "Cannot coerce the result to a single JSON object"
}
```

---

### é—®é¢˜ 3ï¼šåˆ›å»ºç‡ƒæ–™é…é€è®¢å• - RLS ç­–ç•¥è¿å ğŸ”´

**ç°è±¡**ï¼š
- HTTP 500 é”™è¯¯
- é”™è¯¯ä¿¡æ¯ï¼š`"new row violates row-level security policy for table \"delivery_orders\""`

**åŸå› åˆ†æ**ï¼š
- **æ˜ç¡®çš„ RLS ç­–ç•¥è¿åé”™è¯¯**
- RLS ç­–ç•¥é˜»æ­¢äº†æ’å…¥æ“ä½œ
- å¯èƒ½åŸå› ï¼š
  1. `user_id` å­—æ®µä¸º NULL æˆ–ä¸åŒ¹é… `auth.uid()`
  2. `restaurant_id` ä¸æ»¡è¶³ RLS ç­–ç•¥æ¡ä»¶
  3. å½“å‰ç”¨æˆ·æ²¡æœ‰æƒé™åˆ›å»ºè¯¥é¤å…çš„è®¢å•

**é”™è¯¯ä¿¡æ¯**ï¼š
```json
{
  "error": "åˆ›å»ºè®¢å•å¤±è´¥",
  "details": "new row violates row-level security policy for table \"delivery_orders\""
}
```

---

## ğŸ”§ æ ¹æœ¬åŸå› 

### RLS ç­–ç•¥é—®é¢˜

ä»è¿ç§»è„šæœ¬ä¸­çœ‹åˆ°çš„ RLS ç­–ç•¥ï¼š

```sql
-- repair_orders INSERT ç­–ç•¥
CREATE POLICY "Users can create repair orders for their restaurant"
  ON repair_orders FOR INSERT
  WITH CHECK (
    restaurant_id IN (
      SELECT id FROM restaurants WHERE user_id = auth.uid()
    )
  );

-- delivery_orders INSERT ç­–ç•¥
CREATE POLICY "Users can create delivery orders for their restaurant"
  ON delivery_orders FOR INSERT
  WITH CHECK (
    restaurant_id IN (
      SELECT id FROM restaurants WHERE user_id = auth.uid()
    )
  );
```

**é—®é¢˜**ï¼š
- RLS ç­–ç•¥è¦æ±‚ `restaurants.user_id = auth.uid()`
- ä½† API è°ƒç”¨æ—¶å¯èƒ½æ²¡æœ‰è®¤è¯ç”¨æˆ·ï¼ˆ`auth.uid()` ä¸º NULLï¼‰
- æˆ–è€… `restaurants` è¡¨ä¸­çš„ `user_id` å­—æ®µä¸åŒ¹é…å½“å‰ç”¨æˆ·

---

## ğŸ“ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šæ£€æŸ¥ restaurants è¡¨çš„ user_id

åœ¨ Supabase Dashboard æ‰§è¡Œï¼š
```sql
SELECT id, name, user_id, owner_id 
FROM restaurants 
WHERE id = '4481f1d6-dda4-460b-a380-69d80f2ea876';
```

ç¡®è®¤è¯¥é¤å…çš„ `user_id` æˆ– `owner_id` å­—æ®µæ˜¯å¦æœ‰å€¼ã€‚

### æ–¹æ¡ˆ 2ï¼šä¸´æ—¶è°ƒæ•´ RLS ç­–ç•¥ï¼ˆä»…ç”¨äºéªŒè¯ï¼‰

å¦‚æœéœ€è¦å¿«é€ŸéªŒè¯åŠŸèƒ½ï¼Œå¯ä»¥ä¸´æ—¶æ”¾å®½ RLS ç­–ç•¥ï¼š

```sql
-- ä¸´æ—¶å…è®¸æ‰€æœ‰è®¤è¯ç”¨æˆ·åˆ›å»ºè®¢å•ï¼ˆä»…ç”¨äºéªŒè¯ï¼‰
DROP POLICY IF EXISTS "Users can create repair orders for their restaurant" ON repair_orders;
CREATE POLICY "Users can create repair orders for their restaurant"
  ON repair_orders FOR INSERT
  WITH CHECK (true); -- ä¸´æ—¶å…è®¸æ‰€æœ‰æ’å…¥

DROP POLICY IF EXISTS "Users can create delivery orders for their restaurant" ON delivery_orders;
CREATE POLICY "Users can create delivery orders for their restaurant"
  ON delivery_orders FOR INSERT
  WITH CHECK (true); -- ä¸´æ—¶å…è®¸æ‰€æœ‰æ’å…¥
```

**âš ï¸ æ³¨æ„**ï¼šè¿™åªæ˜¯ä¸´æ—¶æ–¹æ¡ˆï¼ŒéªŒè¯å®Œæˆåéœ€è¦æ¢å¤æ­£ç¡®çš„ RLS ç­–ç•¥ã€‚

### æ–¹æ¡ˆ 3ï¼šä½¿ç”¨ Service Role Keyï¼ˆå¦‚æœ API æ”¯æŒï¼‰

æ£€æŸ¥ API æ˜¯å¦æ”¯æŒä½¿ç”¨ Service Role Key ç»•è¿‡ RLSï¼š
- `repair/create` API å·²æ”¯æŒ Service Role Key fallback
- `orders/create` API å¯èƒ½éœ€è¦æ·»åŠ  Service Role Key æ”¯æŒ

---

## âœ… éªŒè¯ç»“è®ºï¼ˆå½“å‰çŠ¶æ€ï¼‰

### åŠŸèƒ½éªŒè¯

- [x] âš ï¸ **éƒ¨åˆ†é€šè¿‡** - 3 ä¸ª API æˆåŠŸï¼Œ2 ä¸ªå¤±è´¥
  - âœ… æŸ¥è¯¢ç±» API éƒ½æ­£å¸¸å·¥ä½œï¼ˆ2/2ï¼‰
  - âš ï¸ åˆ›å»ºç±» API å­˜åœ¨ RLS ç­–ç•¥é—®é¢˜ï¼ˆ2/2ï¼‰

### é—®é¢˜åˆ†ç±»

- ğŸ”´ **RLS ç­–ç•¥é—®é¢˜**ï¼ˆé˜»å¡ï¼‰ï¼š
  1. åˆ›å»ºç‡ƒæ–™é…é€è®¢å•ï¼šRLS ç­–ç•¥è¿å
  2. åˆ›å»ºæŠ¥ä¿®å·¥å•ï¼šRLS ç­–ç•¥é˜»æ­¢æŸ¥è¯¢
  3. æ›´æ–°æŠ¥ä¿®å·¥å•çŠ¶æ€ï¼šRLS ç­–ç•¥é˜»æ­¢æŸ¥è¯¢

### æ˜¯å¦å¯ä»¥è¿›å…¥é˜¶æ®µ 2B-4ï¼Ÿ

**ç»“è®º**ï¼šâš ï¸ **éœ€è¦å…ˆè§£å†³ RLS ç­–ç•¥é—®é¢˜**

**å»ºè®®**ï¼š
1. æ£€æŸ¥ `restaurants` è¡¨çš„ `user_id` å­—æ®µ
2. ç¡®è®¤ API è°ƒç”¨æ—¶çš„ç”¨æˆ·è®¤è¯çŠ¶æ€
3. ä¿®å¤ RLS ç­–ç•¥æˆ–è°ƒæ•´ API ä½¿ç”¨ Service Role Key
4. é‡æ–°æ‰§è¡ŒéªŒè¯

---

## ğŸ”§ ä¸‹ä¸€æ­¥æ“ä½œ

### 1. æ£€æŸ¥ restaurants è¡¨æ•°æ®

```sql
SELECT id, name, user_id, owner_id 
FROM restaurants 
WHERE id = '4481f1d6-dda4-460b-a380-69d80f2ea876';
```

### 2. æ£€æŸ¥åˆ›å»ºçš„è®°å½•

```sql
-- æ£€æŸ¥ repair_orders è¡¨
SELECT id, restaurant_id, user_id, service_type, status, created_at
FROM repair_orders
WHERE restaurant_id = '4481f1d6-dda4-460b-a380-69d80f2ea876'
ORDER BY created_at DESC
LIMIT 5;

-- æ£€æŸ¥ delivery_orders è¡¨ï¼ˆå¦‚æœæœ‰ï¼‰
SELECT id, restaurant_id, user_id, service_type, status, created_at
FROM delivery_orders
WHERE restaurant_id = '4481f1d6-dda4-460b-a380-69d80f2ea876'
ORDER BY created_at DESC
LIMIT 5;
```

### 3. æ ¹æ®æ£€æŸ¥ç»“æœå†³å®šä¿®å¤æ–¹æ¡ˆ
