# 阶段 2B-4：权限与角色边界梳理

**生成日期**：2026-01-09  
**目标**：明确管理员/餐厅/工人边界，识别系统级API和登录态要求

---

## 一、角色定义

### 1.1 用户角色体系

| 角色 | 标识 | 说明 | 数据隔离范围 |
|------|------|------|------------|
| **超级管理员** | `super_admin` | 平台级管理员，可管理所有租户 | 无限制（可访问所有数据） |
| **供应商管理员** | `admin` | 供应商/公司管理员 | 仅本租户（company_id）数据 |
| **员工** | `staff` | 配送员/维修工/安装工 | 仅分配给自己的订单/工单 |
| **餐厅/商户** | `restaurant` | 餐厅用户（客户端） | 仅本餐厅数据 |
| **公开访问** | `PUBLIC` | 无需认证 | 无限制（但受RLS策略限制） |

### 1.2 角色与数据边界

```
super_admin (超级管理员)
  └─ 可访问：所有租户数据
  └─ 可操作：创建供应商、查找用户、平台配置

admin (供应商管理员)
  └─ 可访问：本租户（company_id）数据
  └─ 可操作：订单管理、设备管理、产品审核

staff (员工：配送员/维修工)
  └─ 可访问：分配给自己的订单/工单
  └─ 可操作：接单、派单、完成、报修处理

restaurant (餐厅/商户)
  └─ 可访问：本餐厅数据
  └─ 可操作：下单、查询订单、设备管理
```

---

## 二、API 权限级别分类

### 2.1 系统级 API (SYSTEM_LEVEL)

**定义**：只能由 `super_admin` 调用，允许使用 Service Role Key

| API路径 | 方法 | 说明 | 当前Key | 登录态要求 |
|---------|------|------|---------|-----------|
| `/api/admin/create-company` | POST | 创建供应商公司 | Service Role Key | ✅ 需要（super_admin） |
| `/api/admin/find-user` | POST | 查找用户（按邮箱） | Service Role Key | ✅ 需要（super_admin） |

**特点**：
- ✅ 已接入 `getUserContext` 统一权限验证
- ✅ 明确要求 `role === 'super_admin'`
- ✅ 允许使用 Service Role Key（系统级操作）
- ✅ 需要登录态（通过 `getUserContext` 验证）

---

### 2.2 租户级 API (COMPANY_LEVEL)

**定义**：`admin`/`staff` 调用，必须强制 `company_id` 过滤，后续必须迁移到 Anon Key + RLS

| API路径 | 方法 | 说明 | 当前Key | 登录态要求 |
|---------|------|------|---------|-----------|
| `/api/orders/create` | POST | 创建配送订单 | Anon Key | ⚠️ 未明确验证 |
| `/api/equipment/rental/list` | GET | 租赁订单列表 | Anon Key | ✅ 需要（已接入 getUserContext） |
| `/api/equipment/rental/create` | POST | 创建租赁订单 | Anon Key | ⚠️ 未明确验证 |
| `/api/equipment/rental/update` | POST | 更新租赁订单 | Anon Key | ⚠️ 未明确验证 |
| `/api/equipment/rental/admin/list` | GET | 管理端租赁列表 | Anon Key | ⚠️ 未明确验证 |
| `/api/equipment/rental/finance` | GET | 租赁财务信息 | Anon Key | ⚠️ 未明确验证 |
| `/api/equipment/list` | GET | 设备列表 | Anon Key | ⚠️ 未明确验证 |
| `/api/equipment/categories` | GET | 设备分类 | Anon Key | ⚠️ 未明确验证 |
| `/api/equipment/catalog/list` | GET | 产品目录列表 | Anon Key | ⚠️ 未明确验证 |
| `/api/equipment/catalog/create` | POST | 创建产品 | Anon Key | ⚠️ 未明确验证 |
| `/api/equipment/catalog/approve` | POST | 审核产品 | Anon Key | ⚠️ 未明确验证 |
| `/api/status/transition` | POST | 状态变更 | Anon Key | ⚠️ 未明确验证 |
| `/api/storage/upload` | POST | 文件上传 | Anon Key | ⚠️ 未明确验证 |
| `/api/restaurant/generate-token` | POST | 生成餐厅Token | Anon Key | ⚠️ 未明确验证 |

**特点**：
- ⚠️ **大部分未接入统一权限验证**（仅 `equipment/rental/list` 已接入）
- ⚠️ **需要登录态**（但当前未强制验证）
- ⚠️ **必须强制 `company_id` 过滤**（当前可能未实现）
- ⚠️ **目标**：迁移到 Anon Key + RLS

---

### 2.3 员工级 API (STAFF_LEVEL)

**定义**：只能 `staff` 调用，必须绑定 `worker_id`/`assigned_to`，后续必须使用 RLS 限制只能访问自己数据

| API路径 | 方法 | 说明 | 当前Key | 登录态要求 |
|---------|------|------|---------|-----------|
| `/api/orders/accept` | POST | 接单 | Anon Key | ⚠️ 系统信任模式（不验证登录） |
| `/api/orders/dispatch` | POST | 派单 | Anon Key | ⚠️ 系统信任模式（不验证登录） |
| `/api/orders/complete` | POST | 完成配送 | Anon Key | ⚠️ 系统信任模式（不验证登录） |
| `/api/orders/pending` | GET | 待接单列表 | Anon Key | ⚠️ 系统信任模式（不验证登录） |
| `/api/repair/create` | POST | 创建报修工单 | Anon Key | ⚠️ 未明确验证 |
| `/api/repair/list` | GET | 报修工单列表 | Anon Key | ⚠️ 系统信任模式（不验证登录） |
| `/api/repair/update` | POST | 更新报修工单 | Anon Key | ⚠️ 系统信任模式（不验证登录） |
| `/api/filling` | POST | 配送完成 | Anon Key | ⚠️ 系统信任模式（不验证登录） |
| `/api/delivery` | POST | 配送相关 | Anon Key | ⚠️ 系统信任模式（不验证登录） |
| `/api/delivery/location` | GET | 配送员位置 | Anon Key | ⚠️ 系统信任模式（不验证登录） |
| `/api/install` | POST | 安装服务 | Anon Key | ⚠️ 系统信任模式（不验证登录） |

**特点**：
- ⚠️ **当前使用系统信任模式**（2B-3阶段，不验证登录态）
- ✅ **通过 `verifyWorkerPermission` 验证 worker_id**
- ⚠️ **需要登录态**（但当前阶段2B-3已临时关闭）
- ⚠️ **目标**：后续必须使用 RLS 限制只能访问自己数据

---

### 2.4 公开 API (PUBLIC)

**定义**：公开访问，无需权限验证

| API路径 | 方法 | 说明 | 当前Key | 登录态要求 |
|---------|------|------|---------|-----------|
| `/api/restaurant/login` | POST | 餐厅登录 | Anon Key | ❌ 不需要 |
| `/api/restaurant/register` | POST | 餐厅注册 | Anon Key | ❌ 不需要 |
| `/api/restaurant` | GET | 餐厅信息查询 | Anon Key | ❌ 不需要 |
| `/api/worker/login` | POST | 工人登录 | Anon Key | ❌ 不需要 |
| `/api/payment/alipay/notify` | POST | 支付宝回调 | Anon Key | ❌ 不需要（需验证签名） |
| `/api/payment/alipay/create` | POST | 创建支付 | Anon Key | ⚠️ 标注为COMPANY_LEVEL，但可能未验证 |
| `/api/fuel-sensor` | POST | 燃料传感器数据 | Anon Key | ❌ 不需要 |
| `/api/merchant/location` | GET | 商户位置 | Anon Key | ❌ 不需要 |

**特点**：
- ❌ **不需要登录态**
- ⚠️ **部分API可能需要签名验证**（如支付宝回调）
- ⚠️ **受RLS策略限制**（即使公开，数据访问仍受限制）

---

### 2.5 测试/工具 API (TEST)

| API路径 | 方法 | 说明 | 当前Key | 登录态要求 |
|---------|------|------|---------|-----------|
| `/api/test/env` | GET | 环境变量测试 | - | ❌ 不需要 |
| `/api/worker/check-table` | GET | 检查表结构 | Anon Key | ❌ 不需要 |

---

## 三、登录态要求分析

### 3.1 需要登录态的 API

#### ✅ 已实现登录态验证

| API | 验证方式 | 状态 |
|-----|---------|------|
| `/api/admin/create-company` | `getUserContext` → 要求 `super_admin` | ✅ 已实现 |
| `/api/admin/find-user` | 标注为 SYSTEM_LEVEL | ⚠️ 需确认实现 |
| `/api/equipment/rental/list` | `getUserContext` → 要求 `companyId` | ✅ 已实现 |

#### ⚠️ 标注需要但未实现登录态验证

**COMPANY_LEVEL API（13个）**：
- `/api/orders/create`
- `/api/equipment/rental/create`
- `/api/equipment/rental/update`
- `/api/equipment/rental/admin/list`
- `/api/equipment/rental/finance`
- `/api/equipment/list`
- `/api/equipment/categories`
- `/api/equipment/catalog/list`
- `/api/equipment/catalog/create`
- `/api/equipment/catalog/approve`
- `/api/status/transition`
- `/api/storage/upload`
- `/api/restaurant/generate-token`

**STAFF_LEVEL API（11个）**：
- 当前使用系统信任模式（2B-3阶段）
- 后续需要恢复登录态验证

---

### 3.2 不需要登录态的 API

**PUBLIC API（8个）**：
- `/api/restaurant/login`
- `/api/restaurant/register`
- `/api/restaurant`
- `/api/worker/login`
- `/api/payment/alipay/notify`
- `/api/fuel-sensor`
- `/api/merchant/location`
- `/api/test/env`
- `/api/worker/check-table`

---

## 四、权限验证方式

### 4.1 当前使用的验证方式

#### 方式1：统一用户上下文（推荐）
```typescript
// 使用 getUserContext
import { getUserContext } from "@/lib/auth/user-context"

const userContext = await getUserContext(request)
if (userContext.role !== "super_admin") {
  return NextResponse.json({ error: "权限不足" }, { status: 403 })
}
```

**使用场景**：
- ✅ `/api/admin/create-company` - 验证 super_admin
- ✅ `/api/equipment/rental/list` - 验证 companyId

#### 方式2：工人权限验证
```typescript
// 使用 verifyWorkerPermission
import { verifyWorkerPermission } from "@/lib/auth/worker-auth"

const authResult = await verifyWorkerPermission(request, "delivery", body)
if (authResult instanceof NextResponse) {
  return authResult
}
```

**使用场景**：
- ✅ 所有 STAFF_LEVEL API（通过 worker_id 验证）

#### 方式3：系统信任模式（临时）
```typescript
// 2B-3阶段：系统信任 worker_id
const { worker_id } = body
if (!worker_id) {
  return NextResponse.json({ error: "缺少 worker_id" }, { status: 400 })
}
```

**使用场景**：
- ⚠️ 当前阶段2B-3的接单/派单/完成API（临时方案）

---

### 4.2 权限验证缺失

**问题**：大部分 COMPANY_LEVEL API 未实现登录态验证

**影响**：
- ⚠️ 可能被未授权用户调用
- ⚠️ 无法强制 `company_id` 过滤
- ⚠️ 多租户数据隔离存在风险

**建议**：
- 所有 COMPANY_LEVEL API 应接入 `getUserContext`
- 强制验证 `companyId` 存在
- 使用 `companyId` 作为数据过滤条件

---

## 五、系统级 API 详细分析

### 5.1 `/api/admin/create-company`

**权限要求**：
- ✅ 必须登录（通过 `getUserContext` 验证）
- ✅ 必须是 `super_admin` 角色
- ✅ 使用 Service Role Key（系统级操作）

**实现状态**：
- ✅ 已接入 `getUserContext`
- ✅ 明确要求 `role === 'super_admin'`
- ✅ 返回 403 如果非 super_admin

**数据操作**：
- 创建 `companies` 表记录
- 创建 `user_companies` 关联记录

---

### 5.2 `/api/admin/find-user`

**权限要求**：
- ⚠️ 标注为 SYSTEM_LEVEL，需要 super_admin
- ⚠️ 需确认是否已实现登录态验证

**建议**：
- 接入 `getUserContext` 验证 super_admin
- 或使用 Service Role Key + 手动验证

---

## 六、登录态验证实现建议

### 6.1 COMPANY_LEVEL API 统一接入方案

**目标**：所有 COMPANY_LEVEL API 统一使用 `getUserContext`

**步骤**：
1. 在 API 开头调用 `getUserContext(request)`
2. 验证 `userContext.companyId` 存在（非 super_admin 必须）
3. 使用 `companyId` 作为数据过滤条件
4. 返回 403 如果验证失败

**示例**：
```typescript
// 统一接入 getUserContext
const userContext = await getUserContext(request)

// 非 super_admin 必须提供 companyId
if (userContext.role !== 'super_admin' && !userContext.companyId) {
  return NextResponse.json(
    { error: "无法获取租户信息" },
    { status: 403 }
  )
}

// 使用 companyId 过滤数据
const companyId = userContext.companyId
const { data } = await supabase
  .from("orders")
  .select("*")
  .eq("company_id", companyId) // 强制租户过滤
```

---

### 6.2 STAFF_LEVEL API 登录态恢复方案

**当前状态**：2B-3阶段使用系统信任模式（不验证登录）

**后续方案**：
1. 恢复登录态验证（通过 `getUserContext` 或 `verifyWorkerPermission`）
2. 验证 `user.id` 与 `worker_id` 匹配
3. 使用 RLS 策略限制数据访问

**示例**：
```typescript
// 恢复登录态验证
const userContext = await getUserContext(request)

// 验证 worker_id 与登录用户匹配
const { worker_id } = body
if (userContext.userId !== worker_id) {
  return NextResponse.json(
    { error: "worker_id 与登录用户不匹配" },
    { status: 403 }
  )
}
```

---

## 七、权限边界总结

### 7.1 系统级边界

**系统级 API（2个）**：
- 只能由 `super_admin` 调用
- 允许使用 Service Role Key
- 需要登录态验证
- 可访问所有租户数据

**边界规则**：
- ✅ 必须通过 `getUserContext` 验证
- ✅ 明确要求 `role === 'super_admin'`
- ✅ 返回 403 如果权限不足

---

### 7.2 租户级边界

**租户级 API（15个）**：
- 由 `admin`/`staff` 调用
- 必须强制 `company_id` 过滤
- 需要登录态验证（大部分未实现）
- 只能访问本租户数据

**边界规则**：
- ⚠️ 需要接入 `getUserContext`（大部分未实现）
- ⚠️ 必须验证 `companyId` 存在
- ⚠️ 所有查询必须包含 `company_id` 过滤
- ⚠️ 目标：迁移到 Anon Key + RLS

---

### 7.3 员工级边界

**员工级 API（11个）**：
- 只能由 `staff` 调用
- 必须绑定 `worker_id`/`assigned_to`
- 当前使用系统信任模式（2B-3阶段）
- 只能访问分配给自己的数据

**边界规则**：
- ⚠️ 当前不验证登录态（系统信任模式）
- ✅ 通过 `verifyWorkerPermission` 验证 worker_id
- ⚠️ 后续需要恢复登录态验证
- ⚠️ 目标：使用 RLS 限制只能访问自己数据

---

### 7.4 公开访问边界

**公开 API（8个）**：
- 无需登录态
- 无需权限验证
- 受 RLS 策略限制

**边界规则**：
- ❌ 不需要登录态
- ⚠️ 部分API需要签名验证（如支付宝回调）
- ⚠️ 数据访问受 RLS 策略限制

---

## 八、关键问题与建议

### 8.1 当前问题

#### 问题1：COMPANY_LEVEL API 登录态验证缺失 ⚠️ **高风险**

**现状**：
- 13个 COMPANY_LEVEL API 中，仅1个已接入 `getUserContext`
- 其余12个未实现登录态验证

**风险**：
- 未授权用户可能调用这些API
- 无法强制 `company_id` 过滤
- 多租户数据隔离存在漏洞

**建议**：
- 优先接入 `getUserContext` 到所有 COMPANY_LEVEL API
- 强制验证 `companyId` 存在
- 使用 `companyId` 作为数据过滤条件

#### 问题2：STAFF_LEVEL API 使用系统信任模式 ⚠️ **临时方案**

**现状**：
- 2B-3阶段临时使用系统信任模式
- 不验证登录态，直接信任 `worker_id`

**风险**：
- 任何知道 `worker_id` 的用户都可以调用
- 无法验证调用者身份

**建议**：
- 阶段2B-3完成后，恢复登录态验证
- 验证 `user.id` 与 `worker_id` 匹配
- 使用 RLS 策略限制数据访问

#### 问题3：权限验证方式不统一 ⚠️ **技术债**

**现状**：
- 部分API使用 `getUserContext`
- 部分API使用 `verifyWorkerPermission`
- 部分API未实现验证

**建议**：
- 统一使用 `getUserContext` 作为权限入口
- `verifyWorkerPermission` 作为辅助验证（验证worker权限类型）
- 所有需要登录的API必须接入统一验证

---

### 8.2 下一步行动建议

#### 优先级 P0：COMPANY_LEVEL API 接入统一权限验证

**目标**：所有 COMPANY_LEVEL API 接入 `getUserContext`

**步骤**：
1. 选择3-5个高风险API优先接入
2. 验证 `companyId` 存在
3. 使用 `companyId` 作为数据过滤条件
4. 逐步扩展到所有 COMPANY_LEVEL API

**高风险API推荐**：
- `/api/equipment/catalog/approve` - 产品审核
- `/api/equipment/rental/admin/list` - 管理端列表
- `/api/orders/create` - 创建订单
- `/api/storage/upload` - 文件上传

#### 优先级 P1：恢复 STAFF_LEVEL API 登录态验证

**目标**：阶段2B-3完成后，恢复登录态验证

**步骤**：
1. 等待阶段2B-3功能验证完成
2. 恢复登录态验证（通过 `getUserContext`）
3. 验证 `user.id` 与 `worker_id` 匹配
4. 完善 RLS 策略

#### 优先级 P2：统一权限验证方式

**目标**：所有API使用统一的权限验证方式

**步骤**：
1. 统一使用 `getUserContext` 作为权限入口
2. 保留 `verifyWorkerPermission` 作为辅助验证
3. 移除所有直接查询 `user_roles`/`user_companies` 的代码

---

## 九、API 权限级别统计

### 9.1 按权限级别统计

| 权限级别 | 数量 | 已接入统一验证 | 需要登录态 | 状态 |
|---------|------|--------------|-----------|------|
| **SYSTEM_LEVEL** | 2 | 1/2 (50%) | ✅ 2/2 (100%) | ⚠️ 部分完成 |
| **COMPANY_LEVEL** | 15 | 1/15 (7%) | ⚠️ 1/15 (7%) | ❌ 大部分未完成 |
| **STAFF_LEVEL** | 11 | 0/11 (0%) | ⚠️ 0/11 (0%) | ⚠️ 系统信任模式 |
| **PUBLIC** | 8 | - | ❌ 不需要 | ✅ 完成 |
| **TEST** | 2 | - | ❌ 不需要 | ✅ 完成 |
| **总计** | **38** | **2/28 (7%)** | **3/28 (11%)** | ⚠️ 需要完善 |

### 9.2 按登录态要求统计

| 登录态要求 | 数量 | API列表 |
|-----------|------|---------|
| **需要登录态** | 28 | SYSTEM_LEVEL (2) + COMPANY_LEVEL (15) + STAFF_LEVEL (11) |
| **不需要登录态** | 10 | PUBLIC (8) + TEST (2) |

---

## 十、总结

### 10.1 系统级 API

**数量**：2个

**特点**：
- ✅ 已明确标注为 SYSTEM_LEVEL
- ✅ 已要求 super_admin 权限
- ⚠️ 1个已接入 `getUserContext`，1个需确认

**建议**：
- 所有 SYSTEM_LEVEL API 必须接入 `getUserContext`
- 明确要求 `role === 'super_admin'`
- 允许使用 Service Role Key

---

### 10.2 需要登录态的 API

**数量**：28个（SYSTEM_LEVEL 2 + COMPANY_LEVEL 15 + STAFF_LEVEL 11）

**当前状态**：
- ✅ 已实现：2个（SYSTEM_LEVEL 1 + COMPANY_LEVEL 1）
- ⚠️ 未实现：26个（SYSTEM_LEVEL 1 + COMPANY_LEVEL 14 + STAFF_LEVEL 11）

**建议**：
- 优先接入 COMPANY_LEVEL API 到 `getUserContext`
- 阶段2B-3完成后，恢复 STAFF_LEVEL API 登录态验证
- 统一使用 `getUserContext` 作为权限入口

---

### 10.3 权限边界清晰度

**当前状态**：
- ✅ 角色定义清晰（super_admin / admin / staff）
- ✅ API 权限级别已标注
- ⚠️ 权限验证实现不完整（仅7%已接入统一验证）
- ⚠️ 登录态验证缺失（仅11%已实现）

**建议**：
- 完善 COMPANY_LEVEL API 的权限验证
- 恢复 STAFF_LEVEL API 的登录态验证
- 统一权限验证方式

---

**报告生成日期**：2026-01-09  
**状态**：权限边界已梳理，待完善权限验证实现
