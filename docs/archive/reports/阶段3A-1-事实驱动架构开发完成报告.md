# é˜¶æ®µ3A-1ï¼šäº‹å®é©±åŠ¨æ¶æ„å¼€å‘å®ŒæˆæŠ¥å‘Š

## ğŸ“… å®Œæˆæ—¥æœŸ
2025å¹´1æœˆ20æ—¥

## âœ… ä»»åŠ¡å®Œæˆæƒ…å†µ

### ä»»åŠ¡ 1.1ï¼šç»Ÿä¸€"äº‹å®å¯¹è±¡"å®šä¹‰ âœ…
**æ–‡ä»¶ï¼š** `lib/facts/types.ts`

åˆ›å»ºäº†ä¸‰ä¸ªæ ¸å¿ƒäº‹å®ç±»å‹ï¼š
- `OrderFact`ï¼šè®¢å•äº‹å®ï¼ˆåŒ…å« `accepted_at` å’Œ `completed_at`ï¼Œä» `audit_logs` è·å–ï¼‰
- `AssetFact`ï¼šèµ„äº§äº‹å®ï¼ˆèµ„äº§IDã€çŠ¶æ€ã€æœ€åè¡Œä¸ºã€æœ€åæ›´æ–°æ—¶é—´ï¼‰
- `TraceFact`ï¼šè¿½è¸ªäº‹å®ï¼ˆèµ„äº§æ“ä½œè®°å½•ï¼ŒåŒ…å«æ“ä½œç±»å‹ã€æ“ä½œäººã€å…³è”è®¢å•ç­‰ï¼‰

**æ ¸å¿ƒåŸåˆ™ï¼š**
- ä»…åŒ…å«"çœŸå®ä¸–ç•Œ"æ•°æ®
- æ’é™¤ä¸šåŠ¡è§£é‡Šå­—æ®µï¼ˆå¦‚ `is_abnormal`ã€`risk_level`ã€`score`ã€`comment`ï¼‰
- åæ˜ å®é™…æ•°æ®åº“è®°å½•

---

### ä»»åŠ¡ 2ï¼šäº‹å®èšåˆ APIï¼ˆRead-Onlyï¼‰âœ…

#### ä»»åŠ¡ 2.1ï¼šè®¢å•äº‹å® API âœ…
**æ–‡ä»¶ï¼š** `app/api/facts/orders/[order_id]/route.ts`

**ç«¯ç‚¹ï¼š** `GET /api/facts/orders/:order_id`

**è¿”å›ç»“æ„ï¼š**
```typescript
{
  order: OrderFact,
  assets: AssetFact[],
  traces: TraceFact[]
}
```

**æ•°æ®æ¥æºï¼š**
- `order` â†’ `delivery_orders` è¡¨
- `assets` â†’ `devices` è¡¨ï¼ˆé€šè¿‡ `trace_logs` åæŸ¥ï¼‰
- `traces` â†’ `trace_logs` è¡¨ï¼ˆæŒ‰ `created_at ASC` æ’åºï¼‰
- `accepted_at` / `completed_at` â†’ `audit_logs` è¡¨ï¼ˆæŸ¥è¯¢ `ORDER_ACCEPTED` å’Œ `ORDER_COMPLETED` äº‹ä»¶ï¼‰

**æ ¸å¿ƒç‰¹æ€§ï¼š**
- åª SELECTï¼Œä¸å†™å…¥ã€ä¸æ¨æ–­ã€ä¸ä¿®æ”¹ status
- ä» `audit_logs` è¡¨è·å–è®¢å•çŠ¶æ€å˜åŒ–æ—¶é—´æˆ³ï¼Œç¡®ä¿äº‹å®å‡†ç¡®æ€§

#### ä»»åŠ¡ 2.2ï¼šé¤å…äº‹å®æ€»è§ˆ API âœ…
**æ–‡ä»¶ï¼š** `app/api/facts/restaurant/[restaurant_id]/overview/route.ts`

**ç«¯ç‚¹ï¼š** `GET /api/facts/restaurant/:restaurant_id/overview`

**è¿”å›ç»“æ„ï¼š**
```typescript
{
  active_orders: number,
  completed_orders: number,
  active_assets: number,
  last_delivery_at: string | null
}
```

**æ ¸å¿ƒç‰¹æ€§ï¼š**
- è¿™æ˜¯äº‹å®æ±‡æ€»ï¼Œä¸æ˜¯ KPI
- ä½¿ç”¨ `select("id")` ç„¶å `.length` è®¡ç®—ï¼Œé¿å…æ¨æ–­

#### ä»»åŠ¡ 2.3ï¼šè¾…åŠ© API âœ…

**æœ€æ–°è®¢å• APIï¼š**
- **æ–‡ä»¶ï¼š** `app/api/facts/restaurant/[restaurant_id]/latest-order/route.ts`
- **ç«¯ç‚¹ï¼š** `GET /api/facts/restaurant/:restaurant_id/latest-order`
- **ç”¨é€”ï¼š** è·å–æœ€è¿‘ä¸€æ¬¡å®Œæˆçš„è®¢å•IDï¼Œä¾›å‰ç«¯è·å–å®Œæ•´è®¢å•äº‹å®

**èµ„äº§åˆ—è¡¨ APIï¼š**
- **æ–‡ä»¶ï¼š** `app/api/facts/restaurant/[restaurant_id]/assets/route.ts`
- **ç«¯ç‚¹ï¼š** `GET /api/facts/restaurant/:restaurant_id/assets`
- **ç”¨é€”ï¼š** è·å–é¤å…å…³è”çš„æ‰€æœ‰èµ„äº§äº‹å®åˆ—è¡¨

---

### ä»»åŠ¡ 3ï¼šäº‹å®å¯è§†åŒ–ç»„ä»¶ï¼ˆå‰ç«¯ï¼‰âœ…

#### ä»»åŠ¡ 3.1ï¼šè®¢å•äº‹å®æ—¶é—´çº¿ç»„ä»¶ âœ…
**æ–‡ä»¶ï¼š** `components/facts/OrderTimeline.tsx`

**åŠŸèƒ½ï¼š**
- å‚ç›´æ—¶é—´çº¿å±•ç¤º
- åˆå¹¶è®¢å•çŠ¶æ€å˜åŒ–ï¼ˆä» `OrderFact` çš„ `accepted_at`ã€`completed_at`ï¼‰å’Œ `trace_logs` è®°å½•
- æŒ‰æ—¶é—´é¡ºåºæ’åºæ˜¾ç¤º

**æ˜¾ç¤ºå†…å®¹ï¼š**
- è¡Œä¸ºï¼ˆè®¢å•åˆ›å»ºã€æ¥å•ã€å®Œæˆã€èµ„äº§æ“ä½œç­‰ï¼‰
- æ“ä½œäºº
- æ—¶é—´
- å…³è”è®¢å•ï¼ˆå¦‚æœ‰ï¼‰
- å…³è”èµ„äº§ï¼ˆå¦‚æœ‰ï¼‰

**è§†è§‰åŸåˆ™ï¼š**
- iOS é£æ ¼è®¾è®¡
- ä¸å¼ºè°ƒé¢œè‰²åˆ¤æ–­ï¼ˆçº¢/ç»¿ä»…è¡¨ç¤ºå‘ç”Ÿä¸å¦ï¼‰
- ä¸æ˜¾ç¤º"æ­£å¸¸ / å¼‚å¸¸"çŠ¶æ€

#### ä»»åŠ¡ 3.2ï¼šèµ„äº§äº‹å®å¡ç‰‡ âœ…
**æ–‡ä»¶ï¼š** `components/facts/AssetFactCard.tsx`

**å±•ç¤ºå­—æ®µï¼š**
- èµ„äº§ IDï¼ˆäºŒç»´ç å€¼ï¼‰
- å½“å‰çŠ¶æ€
- æœ€è¿‘ä¸€æ¬¡è¡Œä¸º
- æœ€è¿‘æ›´æ–°æ—¶é—´

**è§†è§‰åŸåˆ™ï¼š**
- iOS é£æ ¼è®¾è®¡
- ä¸åŒ…å«ä¸šåŠ¡è§£é‡Šå­—æ®µ

---

### ä»»åŠ¡ 4ï¼šæ¥å…¥å…¥å£é¡µé¢ âœ…
**æ–‡ä»¶ï¼š** `app/user-bound/page.tsx`

**é›†æˆå†…å®¹ï¼š**
- âœ… ä»Šæ—¥è®¢å•ï¼ˆåªæ˜¾ç¤ºçŠ¶æ€ï¼‰
- âœ… æœ€è¿‘ä¸€æ¬¡é…é€ï¼ˆä½¿ç”¨ `OrderTimeline` ç»„ä»¶ï¼‰
- âœ… å…³è”èµ„äº§åˆ—è¡¨ï¼ˆä½¿ç”¨ `AssetFactCard` ç»„ä»¶ï¼‰

**è®¿é—®æ§åˆ¶ï¼š**
- âœ… ä»…å…è®¸åœ¨ `/user-bound` é¡µé¢ä½¿ç”¨äº‹å®ç»„ä»¶
- âœ… æ˜ç¡®ç¦æ­¢åœ¨ `/guest`ã€`/user-unbound`ã€`/dashboard` ä½¿ç”¨

**æ•°æ®è·å–ï¼š**
- ä½¿ç”¨ `x-restaurant-id` è¯·æ±‚å¤´è¿›è¡Œèº«ä»½éªŒè¯
- è°ƒç”¨æ‰€æœ‰ `/api/facts/**` ç«¯ç‚¹è·å–æ•°æ®
- å®Œæ•´çš„åŠ è½½çŠ¶æ€å’Œé”™è¯¯å¤„ç†

---

### ä»»åŠ¡ 5ï¼šæƒé™ä¸çœŸå®æ€§çº¦æŸ âœ…
**æ–‡ä»¶ï¼š** `lib/auth/facts-auth.ts`

**æƒé™éªŒè¯ï¼š**
- âœ… ä»…å…è®¸å·²ç™»å½•ç”¨æˆ·
- âœ… `restaurant_id` å¿…é¡»åŒ¹é…ç”¨æˆ·å½’å±
- âœ… ä¸å¾—å¤ç”¨ç®¡ç†ç«¯ API
- âœ… ä¸å¾—ä½¿ç”¨ `service role` å¯†é’¥

**å®ç°æ–¹å¼ï¼š**
- æ”¯æŒä¸¤ç§ç”¨æˆ·ç±»å‹ï¼š
  1. **ç®¡ç†å‘˜ç”¨æˆ·**ï¼šé€šè¿‡ Supabase Auth éªŒè¯
  2. **å®¢æˆ·ç«¯ç”¨æˆ·**ï¼šé€šè¿‡ `x-restaurant-id` è¯·æ±‚å¤´éªŒè¯
- ç»Ÿä¸€çš„ `verifyFactAccess` å‡½æ•°è¿›è¡Œæƒé™æ£€æŸ¥
- `verifyOrderOwnership` å‡½æ•°éªŒè¯è®¢å•å½’å±

---

## ğŸ¯ 3A-1 å®Œæˆæ ‡å‡†éªŒè¯

### âœ… 1. ç”¨æˆ·å¯ä»¥çœ‹åˆ°å®Œæ•´è®¢å•æ—¶é—´çº¿
- `OrderTimeline` ç»„ä»¶å®ç°äº†å®Œæ•´æ—¶é—´çº¿åˆå¹¶å’Œæ’åº
- åŒ…å«è®¢å•åˆ›å»ºã€çŠ¶æ€å˜åŒ–ï¼ˆæ¥å•ã€å®Œæˆï¼‰ã€èµ„äº§æ“ä½œè®°å½•
- æ‰€æœ‰äº‹ä»¶æŒ‰æ—¶é—´é¡ºåºæ˜¾ç¤º

### âœ… 2. èµ„äº§è¡Œä¸ºä¸è®¢å•èƒ½å¯¹å¾—ä¸Š
- èµ„äº§è¡Œä¸ºé€šè¿‡ `trace_logs.order_id` å…³è”è®¢å•
- åœ¨æ—¶é—´çº¿ä¸­æ˜¾ç¤ºå…³è”å…³ç³»
- èµ„äº§å¡ç‰‡æ˜¾ç¤ºæœ€åæ“ä½œå’Œå…³è”è®¢å•ä¿¡æ¯

### âœ… 3. å®¢æˆ·ä¸æœåŠ¡å•†çœ‹åˆ°çš„æ˜¯åŒä¸€å¥—äº‹å®
- æ‰€æœ‰ç”¨æˆ·éƒ½ä½¿ç”¨åŒä¸€å¥—äº‹å® API
- æ•°æ®æºç»Ÿä¸€ï¼ˆ`delivery_orders`ã€`trace_logs`ã€`audit_logs`ã€`devices`ï¼‰
- æƒé™éªŒè¯ç¡®ä¿ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±é¤å…çš„æ•°æ®

### âœ… 4. æ²¡æœ‰ä»»ä½•"ä½ è§‰å¾— / ç³»ç»Ÿåˆ¤æ–­"çš„è¯æœ¯
- æ‰€æœ‰ä»£ç æ³¨é‡Šå’Œ UI æ–‡æœ¬éƒ½æ˜¯çº¯æè¿°æ€§
- ç§»é™¤äº†æ‰€æœ‰åˆ¤æ–­æ€§è¯­è¨€ï¼ˆå¦‚"åº”è¯¥"ã€"æ³¨æ„"ã€"å¯èƒ½"ã€"å¼‚å¸¸"ç­‰ï¼‰
- çŠ¶æ€æ˜ å°„ä½¿ç”¨ä¸­æ€§æè¿°

### âœ… 5. åªè¦äº‹å®å‘ç”Ÿè¿‡ï¼Œå°±ä¸€å®šèƒ½è¢«å±•ç¤º
- ä» `audit_logs` è¡¨è·å–è®¢å•çŠ¶æ€å˜åŒ–æ—¶é—´æˆ³
- æ‰€æœ‰ `trace_logs` è®°å½•éƒ½ä¼šè¢«æŸ¥è¯¢å’Œæ˜¾ç¤º
- æ—¶é—´çº¿æŒ‰ `created_at ASC` æ’åºï¼Œç¡®ä¿å®Œæ•´å±•ç¤º

---

## ğŸ“ æ–°å¢æ–‡ä»¶æ¸…å•

### ç±»å‹å®šä¹‰
- `lib/facts/types.ts` - äº‹å®å¯¹è±¡ç±»å‹å®šä¹‰

### API è·¯ç”±
- `app/api/facts/orders/[order_id]/route.ts` - è®¢å•äº‹å® API
- `app/api/facts/restaurant/[restaurant_id]/overview/route.ts` - é¤å…äº‹å®æ€»è§ˆ API
- `app/api/facts/restaurant/[restaurant_id]/latest-order/route.ts` - æœ€æ–°è®¢å• API
- `app/api/facts/restaurant/[restaurant_id]/assets/route.ts` - èµ„äº§åˆ—è¡¨ API

### æƒé™éªŒè¯
- `lib/auth/facts-auth.ts` - äº‹å® API æƒé™éªŒè¯æ¨¡å—

### å‰ç«¯ç»„ä»¶
- `components/facts/OrderTimeline.tsx` - è®¢å•äº‹å®æ—¶é—´çº¿ç»„ä»¶
- `components/facts/AssetFactCard.tsx` - èµ„äº§äº‹å®å¡ç‰‡ç»„ä»¶

### é¡µé¢é›†æˆ
- `app/user-bound/page.tsx` - ç”¨æˆ·äº‹å®ä¸»é¡µï¼ˆå·²æ›´æ–°ï¼‰

---

## ğŸ”§ æŠ€æœ¯å®ç°è¦ç‚¹

### 1. äº‹å®è·å–ç­–ç•¥
- **è®¢å•çŠ¶æ€æ—¶é—´æˆ³**ï¼šä» `audit_logs` è¡¨æŸ¥è¯¢ `ORDER_ACCEPTED` å’Œ `ORDER_COMPLETED` äº‹ä»¶ï¼Œè€Œä¸æ˜¯ä» `delivery_orders` è¡¨çš„ `updated_at` æ¨æ–­
- **èµ„äº§å…³è”**ï¼šé€šè¿‡ `trace_logs` è¡¨çš„ `order_id` å’Œ `asset_id` å»ºç«‹è®¢å•ä¸èµ„äº§çš„å…³è”
- **æ—¶é—´æ’åº**ï¼šæ‰€æœ‰æ—¶é—´çº¿èŠ‚ç‚¹æŒ‰ `created_at` å‡åºæ’åº

### 2. æƒé™éªŒè¯æ¶æ„
- **åŒé‡éªŒè¯æœºåˆ¶**ï¼šæ”¯æŒç®¡ç†å‘˜ï¼ˆSupabase Authï¼‰å’Œå®¢æˆ·ç«¯ç”¨æˆ·ï¼ˆ`x-restaurant-id` è¯·æ±‚å¤´ï¼‰
- **é¤å…å½’å±éªŒè¯**ï¼šç¡®ä¿ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±é¤å…çš„æ•°æ®
- **è®¢å•å½’å±éªŒè¯**ï¼šç¡®ä¿è®¢å•å±äºç”¨æˆ·æ‰€å±çš„é¤å…

### 3. å‰ç«¯æ•°æ®æµ
- **ç»Ÿä¸€è¯·æ±‚å¤´**ï¼šæ‰€æœ‰äº‹å® API è¯·æ±‚éƒ½æºå¸¦ `x-restaurant-id` è¯·æ±‚å¤´
- **é”™è¯¯å¤„ç†**ï¼šå®Œæ•´çš„åŠ è½½çŠ¶æ€å’Œé”™è¯¯æç¤º
- **æ•°æ®åˆå¹¶**ï¼šå‰ç«¯ç»„ä»¶è´Ÿè´£åˆå¹¶å’Œæ’åºæ—¶é—´çº¿èŠ‚ç‚¹

---

## ğŸš€ ç¯å¢ƒé…ç½®å®Œæˆ

### åŒ…ç®¡ç†å™¨ç»Ÿä¸€
- âœ… åˆ é™¤ `pnpm-lock.yaml`
- âœ… åˆ é™¤ `pnpm-workspace.yaml`
- âœ… ä¿ç•™ `package-lock.json` å’Œ `package.json`
- âœ… è¿è¡Œ `npm install` é‡æ–°å®‰è£…ä¾èµ–

### å¼€å‘æœåŠ¡å™¨
- âœ… è¿è¡Œ `npm run dev`
- âœ… ç¡®è®¤æœåŠ¡å™¨åœ¨ 3000 ç«¯å£è¿è¡Œ

---

## ğŸ“ ä¸‹ä¸€æ­¥å·¥ä½œå»ºè®®

1. **UI ä¼˜åŒ–**ï¼šç»§ç»­æ‰“ç£¨ iOS é£æ ¼çš„æ—¶é—´çº¿å’Œå¡ç‰‡ç»„ä»¶è§†è§‰æ•ˆæœ
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šè€ƒè™‘å¯¹å¤§é‡æ—¶é—´çº¿èŠ‚ç‚¹è¿›è¡Œè™šæ‹Ÿæ»šåŠ¨
3. **é”™è¯¯å¤„ç†å¢å¼º**ï¼šæ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯æç¤ºå’Œé‡è¯•æœºåˆ¶
4. **æ•°æ®ç¼“å­˜**ï¼šè€ƒè™‘åœ¨å‰ç«¯æ·»åŠ é€‚å½“çš„æ•°æ®ç¼“å­˜ç­–ç•¥
5. **æµ‹è¯•è¦†ç›–**ï¼šä¸ºäº‹å® API å’Œç»„ä»¶æ·»åŠ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

---

## âœ¨ æ€»ç»“

é˜¶æ®µ 3A-1 çš„æ‰€æœ‰ä»»åŠ¡å·²å…¨éƒ¨å®Œæˆï¼Œå®ç°äº†å®Œæ•´çš„äº‹å®é©±åŠ¨æ¶æ„ï¼š
- âœ… ç»Ÿä¸€çš„äº‹å®å¯¹è±¡ç±»å‹å®šä¹‰
- âœ… åªè¯»çš„äº‹å®èšåˆ API
- âœ… çº¯äº‹å®å±•ç¤ºçš„å‰ç«¯ç»„ä»¶
- âœ… ä¸¥æ ¼çš„æƒé™éªŒè¯æœºåˆ¶
- âœ… ç¬¦åˆ 3A-1 å®Œæˆæ ‡å‡†çš„æ‰€æœ‰è¦æ±‚

é¡¹ç›®å·²å‡†å¤‡å¥½è¿›å…¥ä¸‹ä¸€é˜¶æ®µçš„å¼€å‘å’Œä¼˜åŒ–å·¥ä½œã€‚
