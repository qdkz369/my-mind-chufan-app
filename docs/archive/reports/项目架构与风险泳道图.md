# é¡¹ç›®æ¶æ„ä¸é£é™©æ³³é“å›¾

## æ¨ªå‘æ³³é“æ¶æ„å›¾ï¼ˆæŒ‰ç«¯åˆ’åˆ†ï¼‰

```mermaid
flowchart LR
    subgraph "ç®¡ç†ç«¯ Admin Lane"
        direction TB
        A1[å·¥ä½œå°]
        A2[é¤å…ç®¡ç†]
        A3[è®¢å•ç®¡ç†]
        A4[æŠ¥ä¿®ç®¡ç†]
        A5[ä¾›åº”å•†ç®¡ç†]
        A6[äº§å“å®¡æ ¸]
        A7[è®¾å¤‡ç›‘æ§]
        A8[å·¥äººç®¡ç†]
        A9["æ•°æ®ç»Ÿè®¡ âš ï¸<br/>åŠŸèƒ½ä¸å®Œæ•´"]
        A10["ç³»ç»Ÿè®¾ç½® âš ï¸<br/>åŠŸèƒ½ä¸å®Œæ•´"]
    end
    
    subgraph "å‘˜å·¥ç«¯ Worker Lane"
        direction TB
        W1[è®¢å•åˆ—è¡¨]
        W2[æŠ¥ä¿®åˆ—è¡¨]
        W3[äºŒç»´ç æ‰«æ]
        W4[è®¾å¤‡å®‰è£…]
        W5[å›¾ç‰‡ä¸Šä¼ ]
        W6["ç¦»çº¿åŒæ­¥ âœ…<br/>å·²å®ç°"]
    end
    
    subgraph "å®¢æˆ·ç«¯ Customer Lane"
        direction TB
        C1[æ”¯ä»˜é¡µé¢]
        C2[è®¢å•åˆ—è¡¨]
        C3[è®¾å¤‡å±•ç¤ºå¢™]
        C4[è®¾å¤‡ç§Ÿèµ]
        C5["å•†åŸ âš ï¸<br/>åŠŸèƒ½ä¸å®Œæ•´"]
        C6["ç¤¾åŒº âš ï¸<br/>åŠŸèƒ½ä¸å®Œæ•´"]
        C7["è¯¾ç¨‹ âš ï¸<br/>åŠŸèƒ½ä¸å®Œæ•´"]
    end
    
    subgraph "APIå±‚ API Layer"
        direction TB
        API1["è®¤è¯API<br/>/api/restaurant/login<br/>/api/worker/login"]
        API2["è®¢å•API<br/>/api/orders/*"]
        API3["æŠ¥ä¿®API âš ï¸<br/>/api/repair/*<br/>æƒé™éªŒè¯è¢«æ³¨é‡Š"]
        API4["è®¾å¤‡API<br/>/api/equipment/*"]
        API5["æ”¯ä»˜API âš ï¸<br/>/api/payment/*<br/>ä»…æ²™ç®±ç¯å¢ƒ"]
        API6["ä¾›åº”å•†API âš ï¸<br/>/api/admin/*<br/>ç»•è¿‡RLS"]
        API7["é…é€API<br/>/api/delivery/*"]
    end
    
    subgraph "æ•°æ®å±‚ Data Layer"
        direction TB
        DB1["ç”¨æˆ·æ•°æ®<br/>auth.users<br/>user_roles"]
        DB2["ä¸šåŠ¡æ•°æ®<br/>restaurants<br/>orders<br/>repairs<br/>workers<br/>devices"]
        DB3["å¤šç§Ÿæˆ·æ•°æ® ğŸ”’<br/>companies<br/>user_companies<br/>equipment_catalog<br/>rental_orders"]
        DB4["ä½ç½®æ•°æ®<br/>delivery_locations<br/>merchant_locations"]
        DB5["é—ç•™è¡¨ âš ï¸<br/>rentals<br/>ç»“æ„ä¸ä¸€è‡´"]
    end
    
    subgraph "åŸºç¡€è®¾æ–½ Infrastructure"
        direction TB
        INF1["Supabase Auth ğŸ”<br/>è®¤è¯æœåŠ¡"]
        INF2["Supabase DB ğŸ”<br/>æ•°æ®åº“æœåŠ¡"]
        INF3["Route Proxy ğŸ”<br/>è·¯ç”±ä¿æŠ¤"]
        INF4["ç¡¬ç¼–ç å¯†é’¥ âš ï¸<br/>FALLBACKå€¼"]
    end
    
    A1 --> API2
    A2 --> API2
    A3 --> API2
    A4 --> API3
    A5 --> API6
    A6 --> API4
    A7 --> API4
    A8 --> API1
    
    W1 --> API2
    W2 --> API3
    W3 --> API1
    W4 --> API4
    W5 --> INF2
    W6 --> API2
    
    C1 --> API5
    C2 --> API2
    C3 --> API4
    C4 --> API4
    C5 -.-> API2
    
    API1 --> INF1
    API2 --> INF2
    API3 --> INF2
    API4 --> INF2
    API5 --> INF2
    API6 --> INF2
    API7 --> INF2
    
    INF1 --> DB1
    INF2 --> DB2
    INF2 --> DB3
    INF2 --> DB4
    INF2 --> DB5
    
    INF3 --> INF1
    INF4 -.-> INF2
    
    classDef risk fill:#ffcccc,stroke:#ff0000,stroke-width:3px
    classDef secure fill:#ccffcc,stroke:#00ff00,stroke-width:2px
    classDef incomplete fill:#ffffcc,stroke:#ffaa00,stroke-width:2px
    classDef multiTenant fill:#ccccff,stroke:#0000ff,stroke-width:2px
    
    class A9,A10,C5,C6,C7,API3,API5,API6,DB5,INF4 risk
    class INF1,INF2,INF3,DB3 secure
    class W6 incomplete
    class DB3 multiTenant
```

## è¯¦ç»†ç»„ä»¶å…³ç³»å›¾

```mermaid
graph TB
    subgraph "å‰ç«¯å±‚ Frontend Layer"
        subgraph "ç®¡ç†ç«¯ Admin"
            A1[å·¥ä½œå° Dashboard]
            A2[é¤å…ç®¡ç† Restaurants]
            A3[è®¢å•ç®¡ç† Orders]
            A4[æŠ¥ä¿®ç®¡ç† Repairs]
            A5[ä¾›åº”å•†ç®¡ç† Suppliers]
            A6[äº§å“å®¡æ ¸ Product Approval]
            A7[è®¾å¤‡ç›‘æ§ Devices]
            A8[å·¥äººç®¡ç† Workers]
            A9[æ•°æ®ç»Ÿè®¡ Analytics âš ï¸]
            A10[ç³»ç»Ÿè®¾ç½® Settings âš ï¸]
        end
        
        subgraph "å‘˜å·¥ç«¯ Worker"
            W1[è®¢å•åˆ—è¡¨ Order List]
            W2[æŠ¥ä¿®åˆ—è¡¨ Repair List]
            W3[äºŒç»´ç æ‰«æ QR Scanner]
            W4[è®¾å¤‡å®‰è£… Device Install]
            W5[å›¾ç‰‡ä¸Šä¼  Image Upload]
            W6[ç¦»çº¿åŒæ­¥ Offline Sync âœ…]
        end
        
        subgraph "å®¢æˆ·ç«¯ Customer"
            C1[æ”¯ä»˜é¡µé¢ Payment]
            C2[è®¢å•åˆ—è¡¨ Orders]
            C3[è®¾å¤‡å±•ç¤ºå¢™ Equipment Showcase]
            C4[è®¾å¤‡ç§Ÿèµ Equipment Rental]
            C5[å•†åŸ Mall âš ï¸]
            C6[ç¤¾åŒº Community âš ï¸]
            C7[è¯¾ç¨‹ Course âš ï¸]
        end
    end
    
    subgraph "APIå±‚ API Layer"
        subgraph "è®¤è¯ API"
            API1[ç®¡ç†å‘˜ç™»å½• /api/restaurant/login]
            API2[å·¥äººç™»å½• /api/worker/login]
            API3[é¤å…ç™»å½• /api/restaurant/login]
        end
        
        subgraph "ä¸šåŠ¡ API"
            API4[è®¢å• API /api/orders/*]
            API5[æŠ¥ä¿® API /api/repair/* âš ï¸]
            API6[è®¾å¤‡ API /api/equipment/*]
            API7[æ”¯ä»˜ API /api/payment/* âš ï¸]
            API8[é…é€ API /api/delivery/*]
            API9[ä¾›åº”å•† API /api/admin/* âš ï¸]
        end
    end
    
    subgraph "æ•°æ®å±‚ Data Layer"
        subgraph "ç”¨æˆ·ç›¸å…³"
            DB1[(auth.users)]
            DB2[(user_roles)]
            DB3[(user_companies) ğŸ”’]
        end
        
        subgraph "ä¸šåŠ¡æ•°æ®"
            DB4[(restaurants)]
            DB5[(orders)]
            DB6[(repairs)]
            DB7[(workers)]
            DB8[(devices)]
            DB9[(companies) ğŸ”’]
            DB10[(equipment_catalog) ğŸ”’]
            DB11[(rental_orders) ğŸ”’]
            DB12[(rentals) âš ï¸]
        end
        
        subgraph "ä½ç½®æ•°æ®"
            DB13[(delivery_locations)]
            DB14[(merchant_locations)]
        end
    end
    
    subgraph "åŸºç¡€è®¾æ–½ Infrastructure"
        INF1[Supabase Auth ğŸ”]
        INF2[Supabase Database ğŸ”]
        INF3[Supabase Storage]
        INF4[Next.js API Routes]
        INF5[Route Proxy ğŸ”]
    end
    
    %% è¿æ¥å…³ç³»
    A1 --> API4
    A2 --> API4
    A3 --> API4
    A4 --> API5
    A5 --> API9
    A6 --> API6
    A7 --> API6
    A8 --> API2
    
    W1 --> API4
    W2 --> API5
    W3 --> API1
    W4 --> API6
    W5 --> INF3
    W6 --> API4
    
    C1 --> API7
    C2 --> API4
    C3 --> API6
    C4 --> API6
    
    API1 --> INF1
    API2 --> INF1
    API3 --> INF1
    API4 --> INF2
    API5 --> INF2
    API6 --> INF2
    API7 --> INF2
    API8 --> INF2
    API9 --> INF2
    
    API9 --> DB1
    API9 --> DB2
    API9 --> DB3
    API9 --> DB9
    
    API4 --> DB5
    API5 --> DB6
    API6 --> DB8
    API6 --> DB10
    API6 --> DB11
    API7 --> DB5
    
    INF1 --> DB1
    INF1 --> DB2
    INF2 --> DB4
    INF2 --> DB5
    INF2 --> DB6
    INF2 --> DB7
    INF2 --> DB8
    INF2 --> DB9
    INF2 --> DB10
    INF2 --> DB11
    INF2 --> DB12
    INF2 --> DB13
    INF2 --> DB14
    
    INF5 --> INF1
    
    %% æ ·å¼
    classDef risk fill:#ffcccc,stroke:#ff0000,stroke-width:2px
    classDef secure fill:#ccffcc,stroke:#00ff00,stroke-width:2px
    classDef incomplete fill:#ffffcc,stroke:#ffaa00,stroke-width:2px
    classDef multiTenant fill:#ccccff,stroke:#0000ff,stroke-width:2px
    
    class A9,A10,C5,C6,C7,API5,API7,API9,DB12 risk
    class INF1,INF2,INF5,DB3,DB9,DB10,DB11 secure
    class W6 incomplete
    class DB3,DB9,DB10,DB11 multiTenant
```

## é£é™©ç‚¹è¯´æ˜

### ğŸ”´ é«˜é£é™©åŒºåŸŸï¼ˆçº¢è‰²æ ‡æ³¨ï¼‰
- **A9, A10**: æ•°æ®ç»Ÿè®¡ã€ç³»ç»Ÿè®¾ç½® - åŠŸèƒ½ä¸å®Œæ•´
- **C5, C6, C7**: å•†åŸã€ç¤¾åŒºã€è¯¾ç¨‹ - åŠŸèƒ½ä¸å®Œæ•´
- **API5**: æŠ¥ä¿®API - æƒé™éªŒè¯è¢«æ³¨é‡Š
- **API7**: æ”¯ä»˜API - å›è°ƒå¤„ç†ä¸å®Œæ•´ï¼Œä»…æ²™ç®±ç¯å¢ƒ
- **API9**: ä¾›åº”å•†API - ä½¿ç”¨Service Role Keyç»•è¿‡RLS
- **DB12**: rentalsè¡¨ - ä¸rental_ordersè¡¨ç»“æ„ä¸ä¸€è‡´

### ğŸŸ¢ å®‰å…¨æ§åˆ¶åŒºåŸŸï¼ˆç»¿è‰²æ ‡æ³¨ï¼‰
- **INF1**: Supabase Auth - è®¤è¯æœåŠ¡
- **INF2**: Supabase Database - æ•°æ®åº“æœåŠ¡
- **INF5**: Route Proxy - è·¯ç”±ä¿æŠ¤
- **DB3, DB9, DB10, DB11**: å¤šç§Ÿæˆ·ç›¸å…³è¡¨ - éœ€è¦ä¸¥æ ¼éš”ç¦»

### ğŸŸ¡ éƒ¨åˆ†å®ŒæˆåŒºåŸŸï¼ˆé»„è‰²æ ‡æ³¨ï¼‰
- **W6**: ç¦»çº¿åŒæ­¥ - å·²å®ç°ä½†éœ€è¦è¿›ä¸€æ­¥æµ‹è¯•

### ğŸ”µ å¤šç§Ÿæˆ·éš”ç¦»åŒºåŸŸï¼ˆè“è‰²æ ‡æ³¨ï¼‰
- **DB3**: user_companies - ç”¨æˆ·å…¬å¸å…³è”è¡¨
- **DB9**: companies - ä¾›åº”å•†å…¬å¸è¡¨
- **DB10**: equipment_catalog - è®¾å¤‡ç›®å½•è¡¨ï¼ˆæŒ‰provider_idéš”ç¦»ï¼‰
- **DB11**: rental_orders - ç§Ÿèµè®¢å•è¡¨ï¼ˆæŒ‰provider_idéš”ç¦»ï¼‰

## æ•°æ®æµå‘è¯´æ˜

### è®¤è¯æµç¨‹
1. ç”¨æˆ·ç™»å½• â†’ Supabase Auth â†’ ç”ŸæˆJWT Token
2. Tokenå­˜å‚¨åœ¨Cookie â†’ Route ProxyéªŒè¯ â†’ å…è®¸è®¿é—®

### ä¸šåŠ¡æ•°æ®æµç¨‹
1. å‰ç«¯è¯·æ±‚ â†’ Next.js API Routes
2. APIéªŒè¯æƒé™ â†’ æŸ¥è¯¢Supabase Database
3. å¤šç§Ÿæˆ·è¿‡æ»¤ â†’ è¿”å›æ•°æ® â†’ å‰ç«¯å±•ç¤º

### å¤šç§Ÿæˆ·éš”ç¦»æµç¨‹
1. è·å–å½“å‰ç”¨æˆ·ID â†’ æŸ¥è¯¢user_companiesè¡¨
2. è·å–company_id â†’ åœ¨æŸ¥è¯¢ä¸­æ·»åŠ provider_idè¿‡æ»¤
3. ç¡®ä¿æ•°æ®éš”ç¦»

## å…³é”®é£é™©è·¯å¾„

### è·¯å¾„1ï¼šä¾›åº”å•†ç®¡ç†ï¼ˆé«˜é£é™©ï¼‰
```
Adminç«¯ â†’ API9(/api/admin/create-company) 
â†’ ä½¿ç”¨Service Role Keyç»•è¿‡RLS 
â†’ ç›´æ¥æ“ä½œcompaniesè¡¨
```
**é£é™©**: ç»•è¿‡æ•°æ®åº“æƒé™æ§åˆ¶ï¼Œéš¾ä»¥å®¡è®¡

### è·¯å¾„2ï¼šæŠ¥ä¿®ç®¡ç†ï¼ˆé«˜é£é™©ï¼‰
```
Workerç«¯ â†’ API5(/api/repair/list) 
â†’ æƒé™éªŒè¯è¢«æ³¨é‡Š 
â†’ ç›´æ¥æŸ¥è¯¢repairsè¡¨
```
**é£é™©**: æƒé™éªŒè¯ç¼ºå¤±ï¼Œå¯èƒ½æ•°æ®æ³„éœ²

### è·¯å¾„3ï¼šæ”¯ä»˜æµç¨‹ï¼ˆé«˜é£é™©ï¼‰
```
Customerç«¯ â†’ API7(/api/payment/alipay/create) 
â†’ ä»…æ²™ç®±ç¯å¢ƒ 
â†’ å›è°ƒå¤„ç†ä¸å®Œæ•´
```
**é£é™©**: ç”Ÿäº§ç¯å¢ƒæ— æ³•ä½¿ç”¨ï¼Œæ”¯ä»˜æµç¨‹ä¸å®Œæ•´

### è·¯å¾„4ï¼šå¤šç§Ÿæˆ·æ•°æ®éš”ç¦»ï¼ˆä¸­é£é™©ï¼‰
```
å„ç«¯ â†’ API Routes 
â†’ éƒ¨åˆ†APIæœªå¼ºåˆ¶æ·»åŠ company_idè¿‡æ»¤ 
â†’ æŸ¥è¯¢ä¸šåŠ¡æ•°æ®
```
**é£é™©**: å¯èƒ½è·¨ç§Ÿæˆ·æ•°æ®æ³„éœ²
