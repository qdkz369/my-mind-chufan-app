# Facts API æ±‡æ€»åˆ†æ

## ç›®çš„
- ç¡®è®¤ Facts API æ˜¯å¦å·²ç»è¢« UI åå‘ç»‘æ­»
- åˆ¤æ–­æ˜¯å¦å­˜åœ¨"UI ä¸ºäº†å±•ç¤ºè€Œæ±¡æŸ“äº‹å®ç»“æ„"çš„é£é™©

---

## æ‰€æœ‰ Facts API åˆ—è¡¨

### 1. `/api/facts/orders/:order_id`

**è·¯å¾„**ï¼š`GET /api/facts/orders/:order_id`

**è¿”å›ç»“æ„**ï¼š
```typescript
{
  success: true,
  order: OrderFactContract {
    order_id: string
    restaurant_id: string
    status: string
    created_at: string
    worker_id: string | null
    accepted_at: string | null
    completed_at: string | null
  },
  assets: AssetFactContract[],
  traces: TraceFactContract[],
  fact_warnings?: string[],                    // å‘åå…¼å®¹
  fact_warnings_human?: string[],              // äººç±»å¯è¯»æ ¼å¼
  fact_warnings_structured?: FactWarning[],    // ç»“æ„åŒ–æ ¼å¼
  fact_health: {
    score: number,                              // 0-100
    summary: {
      high: number,
      medium: number,
      low: number
    }
  }
}
```

**é¢å‘çš„ä½¿ç”¨æ–¹**ï¼š
- âœ… **å‰ç«¯**ï¼ˆ`app/user-bound/page.tsx`ï¼‰ï¼šç”¨äºæ˜¾ç¤ºè®¢å•äº‹å®æ—¶é—´çº¿
- âœ… **ç®¡ç†ç«¯**ï¼šå¯ç”¨äºè®¢å•å®¡è®¡å’Œæ²»ç†
- âœ… **å·¥äººç«¯**ï¼šæœªç›´æ¥ä½¿ç”¨ï¼ˆå·¥äººç«¯ä½¿ç”¨ä¸šåŠ¡ APIï¼‰
- âœ… **Machine**ï¼šå¯ç”¨äºç­–ç•¥å¼•æ“å’Œé£æ§ç³»ç»Ÿ
- âœ… **AI**ï¼šå¯ç”¨äºè§£é‡Šå¼•æ“å’Œåˆ†æç³»ç»Ÿ

**UI ä½¿ç”¨æƒ…å†µ**ï¼š
- `app/user-bound/page.tsx`ï¼šè°ƒç”¨æ­¤ API è·å–è®¢å•äº‹å®ï¼Œä¼ é€’ç»™ `OrderTimeline` ç»„ä»¶
- `components/facts/OrderTimeline.tsx`ï¼šæ¥æ”¶ `order` å’Œ `traces`ï¼Œè¿›è¡Œ UI æ¸²æŸ“

**æ˜¯å¦å­˜åœ¨ UI åå‘ç»‘å®š**ï¼š
- âœ… **æ— åå‘ç»‘å®š**ï¼šè¿”å›ç»“æ„ç¬¦åˆäº‹å®å¥‘çº¦ï¼ˆ`OrderFactContract`, `TraceFactContract`ï¼‰
- âœ… **æ—  UI ç‰¹å®šå­—æ®µ**ï¼šä¸åŒ…å«é¢œè‰²ã€å›¾æ ‡ã€æŒ‰é’®çŠ¶æ€ç­‰ UI å­—æ®µ
- âœ… **UI å±‚è´Ÿè´£è½¬æ¢**ï¼š`OrderTimeline` ç»„ä»¶å†…éƒ¨è¿›è¡ŒçŠ¶æ€æ˜ å°„ï¼ˆ`statusLabelMap`ï¼‰å’Œæ—¶é—´æ ¼å¼åŒ–

---

### 2. `/api/facts/restaurant/:restaurant_id/overview`

**è·¯å¾„**ï¼š`GET /api/facts/restaurant/:restaurant_id/overview`

**è¿”å›ç»“æ„**ï¼š
```typescript
{
  success: true,
  active_orders: number,          // æ´»è·ƒè®¢å•æ•°ï¼ˆaccepted / deliveringï¼‰
  completed_orders: number,       // å·²å®Œæˆè®¢å•æ•°ï¼ˆcompletedï¼‰
  active_assets: number,          // æ´»è·ƒèµ„äº§æ•°ï¼ˆactive / æŒæœ‰ï¼‰
  last_delivery_at: string | null // æœ€åä¸€æ¬¡é…é€å®Œæˆæ—¶é—´
}
```

**é¢å‘çš„ä½¿ç”¨æ–¹**ï¼š
- âœ… **å‰ç«¯**ï¼ˆ`app/user-bound/page.tsx`ï¼‰ï¼šç”¨äºæ˜¾ç¤ºé¤å…äº‹å®æ€»è§ˆ
- âœ… **ç®¡ç†ç«¯**ï¼šå¯ç”¨äºè¿è¥çœ‹æ¿
- âœ… **Machine**ï¼šå¯ç”¨äºç­–ç•¥å¼•æ“ï¼ˆå¦‚ï¼šactive_orders > X è§¦å‘å‘Šè­¦ï¼‰
- âœ… **AI**ï¼šå¯ç”¨äºåˆ†æç³»ç»Ÿ

**UI ä½¿ç”¨æƒ…å†µ**ï¼š
- `app/user-bound/page.tsx`ï¼šè°ƒç”¨æ­¤ API è·å–é¤å…æ€»è§ˆï¼Œç›´æ¥æ¸²æŸ“æ•°å­—

**æ˜¯å¦å­˜åœ¨ UI åå‘ç»‘å®š**ï¼š
- âœ… **æ— åå‘ç»‘å®š**ï¼šè¿”å›ç»“æ„ä¸ºçº¯æ•°å­—å’Œå­—ç¬¦ä¸²ï¼Œæ—  UI ç‰¹å®šå­—æ®µ
- âœ… **æ—  UI ç‰¹å®šå­—æ®µ**ï¼šä¸åŒ…å«é¢œè‰²ã€å›¾æ ‡ã€æ ¼å¼åŒ–ç­‰ UI å­—æ®µ
- âœ… **UI å±‚è´Ÿè´£æ ¼å¼åŒ–**ï¼šå‰ç«¯è´Ÿè´£æ•°å­—æ˜¾ç¤ºå’Œæ ¼å¼åŒ–

---

### 3. `/api/facts/restaurant/:restaurant_id/stats`

**è·¯å¾„**ï¼š`GET /api/facts/restaurant/:restaurant_id/stats`

**è¿”å›ç»“æ„**ï¼š
```typescript
{
  success: true,
  total_orders: number,           // ç´¯è®¡è®¢å•æ•°
  total_spent: number,            // ç´¯è®¡æ¶ˆè´¹é‡‘é¢
  points_balance: number         // ç§¯åˆ†ä½™é¢
}
```

**é¢å‘çš„ä½¿ç”¨æ–¹**ï¼š
- âœ… **å‰ç«¯**ï¼ˆ`components/profile-content.tsx`ï¼‰ï¼šç”¨äºæ˜¾ç¤ºç”¨æˆ·ç»Ÿè®¡æ•°æ®
- âœ… **ç®¡ç†ç«¯**ï¼šå¯ç”¨äºè¿è¥åˆ†æ
- âœ… **Machine**ï¼šå¯ç”¨äºç­–ç•¥å¼•æ“ï¼ˆå¦‚ï¼špoints_balance > X è§¦å‘å¥–åŠ±ï¼‰
- âœ… **AI**ï¼šå¯ç”¨äºåˆ†æç³»ç»Ÿ

**UI ä½¿ç”¨æƒ…å†µ**ï¼š
- `components/profile-content.tsx`ï¼šè°ƒç”¨æ­¤ API è·å–ç»Ÿè®¡æ•°æ®ï¼Œç›´æ¥æ¸²æŸ“æ•°å­—

**æ˜¯å¦å­˜åœ¨ UI åå‘ç»‘å®š**ï¼š
- âœ… **æ— åå‘ç»‘å®š**ï¼šè¿”å›ç»“æ„ä¸ºçº¯æ•°å­—ï¼Œæ—  UI ç‰¹å®šå­—æ®µ
- âœ… **æ—  UI ç‰¹å®šå­—æ®µ**ï¼šä¸åŒ…å«é¢œè‰²ã€å›¾æ ‡ã€æ ¼å¼åŒ–ç­‰ UI å­—æ®µ
- âœ… **UI å±‚è´Ÿè´£æ ¼å¼åŒ–**ï¼šå‰ç«¯è´Ÿè´£æ•°å­—æ˜¾ç¤ºå’Œæ ¼å¼åŒ–ï¼ˆå¦‚ï¼šè´§å¸æ ¼å¼åŒ–ï¼‰

---

### 4. `/api/facts/restaurant/:restaurant_id/assets`

**è·¯å¾„**ï¼š`GET /api/facts/restaurant/:restaurant_id/assets`

**è¿”å›ç»“æ„**ï¼š
```typescript
{
  success: true,
  assets: AssetFactContract[] {
    asset_id: string
    status: string
    last_action: string           // æœ€åä¸€æ¬¡æ“ä½œç±»å‹ï¼ˆå¯èƒ½ä¸ºç©ºå­—ç¬¦ä¸²ï¼‰
    last_action_at: string | null // æœ€åä¸€æ¬¡æ“ä½œæ—¶é—´ï¼ˆå¯èƒ½ä¸º nullï¼‰
  }[]
}
```

**é¢å‘çš„ä½¿ç”¨æ–¹**ï¼š
- âœ… **å‰ç«¯**ï¼ˆ`app/user-bound/page.tsx`ï¼‰ï¼šç”¨äºæ˜¾ç¤ºå…³è”èµ„äº§åˆ—è¡¨
- âœ… **ç®¡ç†ç«¯**ï¼šå¯ç”¨äºèµ„äº§ç®¡ç†
- âœ… **Machine**ï¼šå¯ç”¨äºç­–ç•¥å¼•æ“ï¼ˆå¦‚ï¼šèµ„äº§çŠ¶æ€å¼‚å¸¸è§¦å‘å‘Šè­¦ï¼‰
- âœ… **AI**ï¼šå¯ç”¨äºåˆ†æç³»ç»Ÿ

**UI ä½¿ç”¨æƒ…å†µ**ï¼š
- `app/user-bound/page.tsx`ï¼šè°ƒç”¨æ­¤ API è·å–èµ„äº§åˆ—è¡¨ï¼Œä¼ é€’ç»™ `AssetFactCard` ç»„ä»¶
- `components/facts/AssetFactCard.tsx`ï¼šæ¥æ”¶ `asset`ï¼Œè¿›è¡Œ UI æ¸²æŸ“

**æ˜¯å¦å­˜åœ¨ UI åå‘ç»‘å®š**ï¼š
- âœ… **æ— åå‘ç»‘å®š**ï¼šè¿”å›ç»“æ„ç¬¦åˆäº‹å®å¥‘çº¦ï¼ˆ`AssetFactContract`ï¼‰
- âœ… **æ—  UI ç‰¹å®šå­—æ®µ**ï¼šä¸åŒ…å«é¢œè‰²ã€å›¾æ ‡ã€æŒ‰é’®çŠ¶æ€ç­‰ UI å­—æ®µ
- âœ… **UI å±‚è´Ÿè´£è½¬æ¢**ï¼š`AssetFactCard` ç»„ä»¶å†…éƒ¨è¿›è¡ŒçŠ¶æ€æ˜ å°„ï¼ˆ`statusLabelMap`ï¼‰å’Œæ—¶é—´æ ¼å¼åŒ–

---

### 5. `/api/facts/restaurant/:restaurant_id/latest-order`

**è·¯å¾„**ï¼š`GET /api/facts/restaurant/:restaurant_id/latest-order`

**è¿”å›ç»“æ„**ï¼š
```typescript
{
  success: true,
  order_id: string | null          // æœ€è¿‘ä¸€æ¬¡å®Œæˆçš„è®¢å• ID
}
```

**é¢å‘çš„ä½¿ç”¨æ–¹**ï¼š
- âœ… **å‰ç«¯**ï¼ˆ`app/user-bound/page.tsx`ï¼‰ï¼šç”¨äºè·å–æœ€è¿‘è®¢å• IDï¼Œç„¶åè°ƒç”¨è®¢å•äº‹å® API
- âœ… **ç®¡ç†ç«¯**ï¼šå¯ç”¨äºå¿«é€Ÿå®šä½æœ€è¿‘è®¢å•
- âœ… **Machine**ï¼šå¯ç”¨äºç­–ç•¥å¼•æ“ï¼ˆå¦‚ï¼šæœ€è¿‘è®¢å•æ—¶é—´ > X è§¦å‘æé†’ï¼‰
- âœ… **AI**ï¼šå¯ç”¨äºåˆ†æç³»ç»Ÿ

**UI ä½¿ç”¨æƒ…å†µ**ï¼š
- `app/user-bound/page.tsx`ï¼šè°ƒç”¨æ­¤ API è·å–æœ€è¿‘è®¢å• IDï¼Œç„¶åè°ƒç”¨ `/api/facts/orders/:order_id` è·å–å®Œæ•´è®¢å•äº‹å®

**æ˜¯å¦å­˜åœ¨ UI åå‘ç»‘å®š**ï¼š
- âœ… **æ— åå‘ç»‘å®š**ï¼šè¿”å›ç»“æ„ä¸ºçº¯ IDï¼Œæ—  UI ç‰¹å®šå­—æ®µ
- âœ… **æ—  UI ç‰¹å®šå­—æ®µ**ï¼šä¸åŒ…å«ä»»ä½• UI ç›¸å…³å­—æ®µ
- âœ… **UI å±‚è´Ÿè´£åç»­å¤„ç†**ï¼šå‰ç«¯è´Ÿè´£è°ƒç”¨åç»­ API è·å–å®Œæ•´æ•°æ®

---

### 6. `/api/facts/fuel/:device_id/stats`

**è·¯å¾„**ï¼š`GET /api/facts/fuel/:device_id/stats`

**è¿”å›ç»“æ„**ï¼š
```typescript
{
  success: true,
  total_refilled: number,         // ç´¯è®¡åŠ æ³¨é‡ï¼ˆkgï¼‰
  daily_consumption: number,      // æ—¥å‡æ¶ˆè€—ï¼ˆkg/å¤©ï¼‰
  usage_efficiency: number        // ä½¿ç”¨æ•ˆç‡ï¼ˆ%ï¼‰
}
```

**é¢å‘çš„ä½¿ç”¨æ–¹**ï¼š
- âœ… **å‰ç«¯**ï¼ˆ`components/iot-dashboard.tsx`ï¼‰ï¼šç”¨äºæ˜¾ç¤ºç‡ƒæ–™ç»Ÿè®¡æ•°æ®
- âœ… **ç®¡ç†ç«¯**ï¼šå¯ç”¨äºè¿è¥åˆ†æ
- âœ… **Machine**ï¼šå¯ç”¨äºç­–ç•¥å¼•æ“ï¼ˆå¦‚ï¼šusage_efficiency < X è§¦å‘å‘Šè­¦ï¼‰
- âœ… **AI**ï¼šå¯ç”¨äºåˆ†æç³»ç»Ÿ

**UI ä½¿ç”¨æƒ…å†µ**ï¼š
- `components/iot-dashboard.tsx`ï¼šè°ƒç”¨æ­¤ API è·å–ç‡ƒæ–™ç»Ÿè®¡æ•°æ®ï¼Œç›´æ¥æ¸²æŸ“æ•°å­—

**æ˜¯å¦å­˜åœ¨ UI åå‘ç»‘å®š**ï¼š
- âœ… **æ— åå‘ç»‘å®š**ï¼šè¿”å›ç»“æ„ä¸ºçº¯æ•°å­—ï¼Œæ—  UI ç‰¹å®šå­—æ®µ
- âœ… **æ—  UI ç‰¹å®šå­—æ®µ**ï¼šä¸åŒ…å«é¢œè‰²ã€å›¾æ ‡ã€æ ¼å¼åŒ–ç­‰ UI å­—æ®µ
- âœ… **UI å±‚è´Ÿè´£æ ¼å¼åŒ–**ï¼šå‰ç«¯è´Ÿè´£æ•°å­—æ˜¾ç¤ºå’Œæ ¼å¼åŒ–ï¼ˆå¦‚ï¼šç™¾åˆ†æ¯”æ ¼å¼åŒ–ï¼‰

---

## æ€»ä½“åˆ†æ

### âœ… ä¼˜ç‚¹ï¼šFacts API æœªè¢« UI åå‘ç»‘å®š

**è¯æ®**ï¼š
1. **æ‰€æœ‰ API è¿”å›ç»“æ„ç¬¦åˆäº‹å®å¥‘çº¦**ï¼š
   - ä½¿ç”¨ `OrderFactContract`, `AssetFactContract`, `TraceFactContract` ç­‰ç±»å‹
   - ä¸åŒ…å« UI ç‰¹å®šå­—æ®µï¼ˆé¢œè‰²ã€å›¾æ ‡ã€æŒ‰é’®çŠ¶æ€ç­‰ï¼‰

2. **UI å±‚è´Ÿè´£è½¬æ¢**ï¼š
   - `OrderTimeline` ç»„ä»¶å†…éƒ¨è¿›è¡ŒçŠ¶æ€æ˜ å°„ï¼ˆ`statusLabelMap`ï¼‰
   - `AssetFactCard` ç»„ä»¶å†…éƒ¨è¿›è¡ŒçŠ¶æ€æ˜ å°„ï¼ˆ`statusLabelMap`ï¼‰
   - æ—¶é—´æ ¼å¼åŒ–åœ¨ UI å±‚å®Œæˆï¼ˆ`formatTime` å‡½æ•°ï¼‰

3. **æ—  UI ç‰¹å®šå­—æ®µ**ï¼š
   - æ‰€æœ‰ API è¿”å›çš„éƒ½æ˜¯çº¯æ•°æ®ï¼ˆæ•°å­—ã€å­—ç¬¦ä¸²ã€å¯¹è±¡ï¼‰
   - ä¸åŒ…å« `statusColor`, `statusIcon`, `canEdit`, `buttonState` ç­‰ UI å­—æ®µ

4. **ç¬¦åˆ Facts API é“å¾‹**ï¼š
   - âœ… æ°¸è¿œåªè¯»
   - âœ… ä¸ä¸º UI æœåŠ¡ï¼Œåªä¸º"äº‹å®è§†å›¾"
   - âœ… è¿”å›çš„æ˜¯"å¯è¢«è´¨ç–‘çš„äº‹å®"ï¼Œä¸æ˜¯"ä¸šåŠ¡çœŸç›¸"

---

### âš ï¸ æ½œåœ¨é£é™©ï¼šUI ä½¿ç”¨æ–¹å¼éœ€è¦å…³æ³¨

**é£é™©ç‚¹**ï¼š
1. **UI ç»„ä»¶ç›´æ¥ä¾èµ– Facts API**ï¼š
   - `app/user-bound/page.tsx` ç›´æ¥è°ƒç”¨å¤šä¸ª Facts API
   - `components/iot-dashboard.tsx` ç›´æ¥è°ƒç”¨ Facts API
   - `components/profile-content.tsx` ç›´æ¥è°ƒç”¨ Facts API

2. **UI å±‚å¯èƒ½äº§ç”Ÿ"äº‹å®è§†å›¾"ä¸"UI è§†å›¾"æ··æ·†**ï¼š
   - è™½ç„¶è¿”å›ç»“æ„ç¬¦åˆäº‹å®å¥‘çº¦ï¼Œä½† UI å±‚å¯èƒ½å°†"äº‹å®è§†å›¾"ç›´æ¥å½“ä½œ"UI è§†å›¾"ä½¿ç”¨
   - éœ€è¦ç¡®ä¿ UI å±‚æ˜ç¡®åŒºåˆ†"äº‹å®è§†å›¾"å’Œ"UI è§†å›¾"

3. **ç¼ºå°‘ä¸­é—´å±‚**ï¼š
   - ç›®å‰ UI å±‚ç›´æ¥è°ƒç”¨ Facts APIï¼Œç¼ºå°‘"äº‹å®è§†å›¾ â†’ UI è§†å›¾"çš„è½¬æ¢å±‚
   - å¦‚æœæœªæ¥éœ€è¦æ”¯æŒå¤šä¸ª UI æ¡†æ¶ï¼ˆå¦‚ç§»åŠ¨ç«¯ã€ç®¡ç†ç«¯ï¼‰ï¼Œå¯èƒ½éœ€è¦ä¸­é—´å±‚

---

### ğŸ“Š ä½¿ç”¨æ–¹ç»Ÿè®¡

| API | å‰ç«¯ | ç®¡ç†ç«¯ | å·¥äººç«¯ | Machine | AI |
|-----|------|--------|--------|---------|-----|
| `/api/facts/orders/:order_id` | âœ… | âœ… | âŒ | âœ… | âœ… |
| `/api/facts/restaurant/:restaurant_id/overview` | âœ… | âœ… | âŒ | âœ… | âœ… |
| `/api/facts/restaurant/:restaurant_id/stats` | âœ… | âœ… | âŒ | âœ… | âœ… |
| `/api/facts/restaurant/:restaurant_id/assets` | âœ… | âœ… | âŒ | âœ… | âœ… |
| `/api/facts/restaurant/:restaurant_id/latest-order` | âœ… | âœ… | âŒ | âœ… | âœ… |
| `/api/facts/fuel/:device_id/stats` | âœ… | âœ… | âŒ | âœ… | âœ… |

**ç»“è®º**ï¼š
- âœ… Facts API ä¸»è¦è¢«å‰ç«¯ä½¿ç”¨ï¼ˆç¬¦åˆè®¾è®¡ï¼šå‰ç«¯éœ€è¦äº‹å®è§†å›¾ï¼‰
- âœ… ç®¡ç†ç«¯å¯ä»¥ä½¿ç”¨ï¼ˆç¬¦åˆè®¾è®¡ï¼šç®¡ç†ç«¯éœ€è¦äº‹å®è§†å›¾ï¼‰
- âŒ å·¥äººç«¯æœªç›´æ¥ä½¿ç”¨ï¼ˆç¬¦åˆè®¾è®¡ï¼šå·¥äººç«¯ä½¿ç”¨ä¸šåŠ¡ APIï¼‰
- âœ… Machine å’Œ AI å¯ä»¥ä½¿ç”¨ï¼ˆç¬¦åˆè®¾è®¡ï¼šç­–ç•¥å¼•æ“å’Œåˆ†æç³»ç»Ÿéœ€è¦äº‹å®è§†å›¾ï¼‰

---

## ç»“è®º

### âœ… Facts API æœªè¢« UI åå‘ç»‘å®š

**è¯æ®**ï¼š
1. æ‰€æœ‰ API è¿”å›ç»“æ„ç¬¦åˆäº‹å®å¥‘çº¦ï¼Œä¸åŒ…å« UI ç‰¹å®šå­—æ®µ
2. UI å±‚è´Ÿè´£çŠ¶æ€æ˜ å°„å’Œæ—¶é—´æ ¼å¼åŒ–ï¼Œä¸ä¾èµ– API è¿”å›çš„ UI å­—æ®µ
3. ç¬¦åˆ Facts API ä¸‰æ¡é“å¾‹

### âš ï¸ éœ€è¦å…³æ³¨çš„é£é™©

**é£é™©**ï¼š
1. UI å±‚ç›´æ¥è°ƒç”¨ Facts APIï¼Œå¯èƒ½äº§ç”Ÿ"äº‹å®è§†å›¾"ä¸"UI è§†å›¾"æ··æ·†
2. ç¼ºå°‘"äº‹å®è§†å›¾ â†’ UI è§†å›¾"çš„ä¸­é—´è½¬æ¢å±‚

**å»ºè®®**ï¼š
1. ä¿æŒç°çŠ¶ï¼šå½“å‰è®¾è®¡ç¬¦åˆ Facts API é“å¾‹ï¼Œæ— éœ€ä¿®æ”¹
2. æ–‡æ¡£åŒ–ï¼šæ˜ç¡®è¯´æ˜ UI å±‚éœ€è¦å°†"äº‹å®è§†å›¾"è½¬æ¢ä¸º"UI è§†å›¾"
3. æœªæ¥è€ƒè™‘ï¼šå¦‚æœæ”¯æŒå¤šä¸ª UI æ¡†æ¶ï¼Œå¯ä»¥è€ƒè™‘å¼•å…¥ä¸­é—´è½¬æ¢å±‚

---

## ç›¸å…³æ–‡æ¡£

- [Facts API é“å¾‹](../app/api/facts/README.md)
- [Facts æ¶ˆè´¹è€…è¯´æ˜](./facts-consumers.md)
- [Facts æ¶ˆè´¹è€…ä½¿ç”¨è¯´æ˜](./facts-consumers-usage.md)
