# Facts API 消费方契约

## 系统定位

Facts API 是一个**只读事实表面（Read-Only Truth Surface）**。它不执行任何业务逻辑，不修改任何数据，仅负责从原始数据源聚合、验证并暴露事实信息。

## 事实消费方

Facts API 服务于三类消费方，每类消费方基于相同的事实输出做出不同的决策与行动：

### 1. Human（人类）

**角色**：管理员、审计员、运营人员

**职责**：
- 通过可视化界面查看事实状态
- 基于 `fact_warnings_structured` 进行人工审计
- 根据 `fact_health` 评估数据质量
- 做出业务决策并执行修复操作

**输出使用**：
- `facts`：查看订单、资产、轨迹的完整事实状态
- `fact_warnings_structured`：识别数据异常并决定修复优先级
- `fact_health`：评估整体数据健康度

### 2. Machine（机器）

**角色**：业务策略引擎、风控系统、自动化规则

**职责**：
- 基于事实状态触发业务规则
- 执行风控检查
- 自动生成告警或通知
- 驱动下游业务流程

**输出使用**：
- `facts`：作为业务决策的输入数据
- `fact_warnings_structured`：触发自动修复流程或告警规则
- `fact_health`：作为系统健康度指标，影响业务策略执行

### 3. AI（人工智能）

**角色**：解释引擎、分析系统、智能助手

**职责**：
- 解释业务状态变化的原因
- 分析数据异常模式
- 生成自然语言报告
- 提供智能建议

**输出使用**：
- `facts`：作为上下文信息，理解业务状态
- `fact_warnings_structured`：分析异常模式，生成解释性报告
- `fact_health`：评估系统整体状态，生成健康度分析

## Facts API 唯一输出

Facts API 仅输出以下三个字段，不包含任何其他业务数据或状态信息：

### 1. facts

**定义**：聚合的事实对象，包含订单、资产、轨迹等核心业务事实。

**结构**：
- `order`：订单事实
- `assets`：资产事实列表
- `traces`：轨迹事实列表

**特性**：
- 只读聚合，不修改原始数据
- 基于原始数据源（audit_logs、delivery_orders 等）计算得出
- 符合事实契约（Fact Contract）定义的结构

### 2. fact_warnings_structured

**定义**：结构化的事实警告数组，标识数据质量异常。

**结构**：
- `code`：警告代码（如 `FACT_TIME_INVERSION`）
- `level`：严重程度（`high` | `medium` | `low`）
- `domain`：影响域（`order` | `trace` | `audit`）
- `message`：人类可读的描述
- `fields`：相关字段列表
- `evidence`：原始值快照（只读）

**特性**：
- 仅标识异常，不修复数据
- 基于原始 audit_logs 记录检测，不受聚合结果影响
- 机器可读，支持自动化处理

### 3. fact_health

**定义**：事实健康度汇总，量化数据质量。

**结构**：
- `score`：健康度分数（0-100）
- `summary`：按严重程度统计的数量
  - `high`：高严重程度警告数量
  - `medium`：中等严重程度警告数量
  - `low`：低严重程度警告数量

**特性**：
- 纯只读聚合计算
- 基于 `fact_warnings_structured` 计算得出
- 不依赖任何外部状态或配置

## 禁止事项

Facts API **严格禁止**以下行为，这些行为必须由消费方在 Facts API 之外执行：

### 1. 不做决策

Facts API 不包含任何业务决策逻辑。它仅提供事实信息，不判断"应该做什么"或"不应该做什么"。

**禁止示例**：
- 禁止根据事实状态自动修改订单状态
- 禁止根据警告自动触发修复流程
- 禁止根据健康度自动调整业务策略

**正确做法**：
- 消费方（Human/Machine/AI）基于 Facts API 输出做出决策
- 决策逻辑在消费方系统中实现

### 2. 不写数据库

Facts API 是纯只读系统，不执行任何数据库写入操作。

**禁止操作**：
- 禁止 `INSERT`、`UPDATE`、`DELETE`、`UPSERT` 等写入操作
- 禁止修改 `audit_logs`、`delivery_orders` 等原始数据表
- 禁止创建临时表或缓存表

**验证方式**：
- 代码中不包含任何数据库写入函数调用
- 所有查询均为 `SELECT` 操作

### 3. 不改变业务状态

Facts API 不改变任何业务状态，包括但不限于：

**禁止操作**：
- 禁止修改订单状态
- 禁止触发业务流程
- 禁止发送通知或告警
- 禁止调用外部 API
- 禁止修改用户界面状态

**正确做法**：
- 消费方系统基于 Facts API 输出决定是否改变业务状态
- 状态变更操作在消费方系统中执行

## 契约保证

### 只读保证

Facts API 保证：
- 所有数据操作均为只读查询
- 不修改任何数据库记录
- 不产生任何副作用

### 输出稳定性

Facts API 保证：
- 输出结构稳定，不因内部实现变化而改变
- 输出字段明确，仅包含 `facts`、`fact_warnings_structured`、`fact_health`
- 向后兼容，新增字段不影响现有消费方

### 职责边界

Facts API 职责：
- ✅ 聚合事实数据
- ✅ 检测数据异常
- ✅ 计算健康度指标
- ❌ 不执行业务逻辑
- ❌ 不修改数据
- ❌ 不改变状态

消费方职责：
- ✅ 基于事实做出决策
- ✅ 执行业务逻辑
- ✅ 修改数据和状态
- ❌ 不直接访问原始数据源（应通过 Facts API）

## 总结

Facts API 是一个**只读事实表面**，为三类消费方（Human、Machine、AI）提供统一的事实视图。它仅输出 `facts`、`fact_warnings_structured` 和 `fact_health`，不执行任何决策、写入或状态变更操作。所有业务逻辑、数据修改和状态变更必须由消费方在 Facts API 之外实现。
