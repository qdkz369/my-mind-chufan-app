# 全链路测试流程指南

## 前置准备

### 1. 数据库预设（必须在 Supabase 中执行）

**步骤**：
1. 登录 Supabase Dashboard
2. 进入 **SQL Editor**
3. 执行 `docs/test-data-setup.sql` 中的 SQL 脚本
4. 确认以下数据已创建：
   - ✅ 3 个测试设备（TEST-DEV-001, TEST-DEV-002, TEST-DEV-003）
   - ✅ 测试餐厅数据
   - ✅ 测试配送员数据（如果 workers 表存在）

### 2. 创建 Storage Bucket（必须在 Supabase 中执行）

**步骤**：
1. 在 Supabase Dashboard 中，进入 **Storage**
2. 点击 **New bucket**
3. 创建名为 `delivery-proofs` 的 bucket
4. ✅ 勾选 **Public bucket**（允许公开读取）
5. 设置文件大小限制：5MB
6. 详细步骤请查看 `docs/storage-setup.md`

## 完整测试流程

### 第一步：安装员安装设备

1. **访问安装页面**
   - URL: `/worker`
   - 点击"设备安装"

2. **填写安装信息**
   - 设备ID：点击"TEST-DEV-001"快速填充按钮，或手动输入
   - 安装地址：填写测试地址
   - 安装人：填写测试姓名

3. **提交安装**
   - 点击"提交登记"
   - ✅ 系统自动创建订单，状态为 `pending_acceptance`

4. **获取订单ID**
   - 查看浏览器控制台，找到订单ID
   - 或查询数据库：`SELECT id FROM orders WHERE status = 'pending_acceptance' ORDER BY created_at DESC LIMIT 1;`

### 第二步：客户确认验收

1. **访问确认页面**
   - URL: `/customer/confirm?order_id=订单ID`
   - 替换 `订单ID` 为第一步获取的订单ID

2. **查看信息**
   - ✅ 确认订单信息
   - ✅ 确认餐厅信息
   - ✅ 确认设备信息

3. **确认验收**
   - 点击"确认验收"按钮
   - ✅ 订单状态转为 `active`

### 第三步：客户下单

1. **访问下单页面**
   - URL: `/customer/order`

2. **选择产品类型**
   - 选择"液化气"、"甲醇"、"热能清洁燃料"或"户外环保燃料"
   - 输入数量

3. **创建订单**
   - 点击"创建订单"
   - ✅ 订单创建成功，状态为 `active` 或 `processing`

4. **记录订单ID**
   - 从成功提示中获取订单ID

### 第四步：配送员接单

1. **访问配送员页面**
   - URL: `/worker`
   - 点击"待接单订单"

2. **查看订单列表**
   - ✅ 看到待接单的订单
   - ✅ 订单显示产品类型

3. **选择订单**
   - 点击"选择订单"按钮
   - ✅ 进入配送证明步骤

### 第五步：配送员完成配送

1. **扫描瓶身溯源二维码**
   - 方式1：点击扫码按钮，使用摄像头扫描（如果有真实二维码）
   - 方式2：在"测试模式"中输入 `BOTTLE-999`，点击"快速填充"
   - ✅ 溯源码已填充

2. **上传配送凭证图片**
   - 点击"拍照或选择图片"
   - 选择一张测试图片（JPG 或 PNG，小于 5MB）
   - ✅ 图片上传成功，显示预览
   - ✅ 显示图片 URL

3. **完成配送**
   - 点击"完成配送"按钮
   - ✅ 订单状态转为 `completed`
   - ✅ 订单包含 `tracking_code` 和 `proof_image`

## 测试检查清单

### 安装环节
- [ ] 可以使用快速填充按钮选择测试设备
- [ ] 可以手动输入设备ID
- [ ] 安装成功后创建订单，状态为 `pending_acceptance`

### 客户确认环节
- [ ] 可以访问确认页面
- [ ] 显示完整的订单、餐厅、设备信息
- [ ] 确认后订单状态转为 `active`

### 客户下单环节
- [ ] 可以选择产品类型
- [ ] 可以输入数量并计算价格
- [ ] 创建订单成功

### 配送员接单环节
- [ ] 可以看到待接单订单列表
- [ ] 订单显示产品类型
- [ ] 可以选择订单进入配送步骤

### 配送完成环节
- [ ] 可以手动输入溯源码（测试模式）
- [ ] 可以上传图片
- [ ] 图片上传成功并显示预览
- [ ] 完成配送后订单状态为 `completed`

## 常见问题

### Q: 图片上传失败，提示 "Bucket not found"
**A**: 需要在 Supabase Dashboard 中创建 `delivery-proofs` bucket，详见 `docs/storage-setup.md`

### Q: 扫码功能无法使用
**A**: 
- 检查浏览器是否允许摄像头权限
- 使用测试模式的快速填充功能
- 手动输入测试ID

### Q: 订单列表为空
**A**: 
- 确认已创建订单
- 检查订单状态是否为 `processing` 或 `delivering`
- 检查配送员ID是否正确

### Q: 设备安装后没有创建订单
**A**: 
- 检查浏览器控制台是否有错误
- 确认 `NewCustomerInstallGuide` 组件中的订单创建逻辑已执行
- 检查数据库 `orders` 表是否有新记录

## 测试数据参考

### 测试设备ID
- `TEST-DEV-001`
- `TEST-DEV-002`
- `TEST-DEV-003`

### 测试溯源码
- `BOTTLE-999`
- `BOTTLE-888`
- `BOTTLE-777`

### 测试配送员ID
- `worker_001`
- `worker_002`

### 测试图片
- 可以使用任何 JPG 或 PNG 图片
- 建议大小：小于 5MB
- 建议尺寸：800x600 或更小

