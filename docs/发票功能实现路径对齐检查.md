# 发票功能实现路径对齐检查

对照文档「功能实现路径 3.1 / 3.2」与当前实现。

---

## 3.1 客户端：申请与查看

| 要求 | 现状 | 对齐 |
|------|------|------|
| **入口**：在「订单详情」页，若 payment_method === 'corporate'，显示「申请开票」按钮 | 订单列表卡片可点击打开详情弹窗，对公订单且未开票时显示「申请开票」，跳转 `/invoices?orderId=xxx` | ✅ |
| **表单**：自动带入 corporate_company_name 和 tax_id | 可开票订单 API 返回 corporate 字段，表单选择订单后自动填充 | ✅ |
| **展示**：开票成功后显示「下载 PDF」按钮 | 「下载 PDF」+「复制下载链接」，通过鉴权 API 获取 URL | ✅ |

---

## 3.2 管理端：审核与回传

| 要求 | 现状 | 对齐 |
|------|------|------|
| **列表**：发票管理模块，供应商管理员可筛选「待处理」 | 有发票管理模块，状态筛选包含「待处理」 | ✅ |
| **操作**：查看客户提交的抬头信息 | 详情弹窗展示 company_name、tax_id、address、phone、bank_name、bank_account、email | ✅ |
| **操作**：点击「上传发票」，调用 upload 接口 | 有上传入口，调用 `/api/admin/invoices/[id]/upload` | ✅ |
| **上传成功后**：系统自动更新 invoices 表状态 | 上传成功后，若状态为 processing 自动更新为 issued | ✅ |

---

## 安全与优化（已实现）

| 项目 | 实现 |
|------|------|
| **存储隔离** | 鉴权下载 API `/api/invoices/download-url`、`/api/admin/invoices/[id]/download-url`，仅授权用户可获取 URL。可创建私有桶 `invoice-files` 后改用签名 URL。 |
| **事实审计** | 上传、状态更新均写入 `audit_logs`（action: INVOICE_FILE_UPLOADED、INVOICE_STATUS_UPDATED） |
| **PDF 预览/移动端** | 「下载 PDF」新窗口打开，「复制下载链接」复制到剪贴板 |
