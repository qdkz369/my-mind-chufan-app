# 发票表结构对比与优化建议

## 一、方案对比

| 维度 | 当前实现 (20250131_invoices_table.sql) | 您建议的方案 | 推荐 |
|------|----------------------------------------|--------------|------|
| **订单关联** | `order_main_id` → order_main | `order_id` → delivery_orders | **当前** |
| **公司/供应商** | 无 company_id | `company_id` → companies | **建议添加** |
| **抬头** | `company_name` + `title_type` | `title` 单一字段 | **当前** |
| **税号** | `tax_id` 可选 | `tax_id` 必填 | **当前** |
| **状态** | pending, processing, issued, rejected | pending, issued, rejected | **当前** |
| **发票文件** | `invoice_file_url` (PDF+图片) | `invoice_pdf_url` (仅 PDF) | **当前** |
| **发票号** | `invoice_number` | `invoice_no` | 均可 |
| **驳回/备注** | 无 | `remark` | **建议添加** |
| **UUID 生成** | `gen_random_uuid()` | `uuid_generate_v4()` | **当前** |

## 二、关键说明

### 1. order_main_id vs delivery_orders.order_id

- **当前使用 `order_main`**：项目有统一订单主表 `order_main`，涵盖燃料订单(fuel)、租赁订单(rental)，可开票订单来自该表。
- **若改用 delivery_orders**：只能对配送订单开票，租赁订单无法开票。
- **结论**：保留 `order_main_id`。

### 2. company_id

- 建议增加 `company_id`（可选），用于：
  - 多租户 / 供应商数据隔离
  - 按供应商筛选、统计发票
- 可从 `order_main.company_id` 或 `restaurants.company_id` 冗余存储。

### 3. tax_id 是否必填

- 个人抬头一般无税号，`tax_id` 应保持可选。

### 4. remark

- 驳回时需记录原因，建议增加 `remark` 字段。

### 5. invoice_file_url vs invoice_pdf_url

- 支持上传 PDF 与图片，使用 `invoice_file_url` 更准确。

### 6. uuid_generate_v4 vs gen_random_uuid

- `gen_random_uuid()`：PostgreSQL 13+ 内置，无需扩展。
- `uuid_generate_v4()`：需启用 `uuid-ossp` 扩展。
- 建议使用 `gen_random_uuid()`。

## 三、增量优化迁移

已存在的 `invoices` 表可执行 `migrations/20250131_invoices_optimizations.sql`，补充：

- `company_id`：所属公司/供应商，便于多租户筛选
- `remark`：驳回原因或备注

## 四、建议保留当前设计的理由

| 项目 | 说明 |
|------|------|
| order_main_id | 统一订单主表，支持燃料、租赁等多种订单类型开票 |
| invoice_type / title_type | 区分普票/专票、个人/企业，满足税务开票要求 |
| tax_id 可选 | 个人抬头无税号 |
| processing 状态 | 表示「开票中」，便于工单流转 |
| invoice_file_url | 支持 PDF 与图片上传 |
| gen_random_uuid() | 无需 uuid-ossp 扩展 |
