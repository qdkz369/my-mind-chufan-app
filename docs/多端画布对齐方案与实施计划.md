# 多端画布对齐方案与实施计划

**目标**：客户端在手机、平板、电脑上显示一致，卡片不被压缩、文字不溢出，体验对齐桌面浏览器。

**涉及页面**：游客门户(guest)、用户首页(user-bound)、支付页(payment)、设备页(devices)、工人页签名(canvas) 等。

### 深度优化点（3 项）

| 序号 | 优化点 | 问题 | 方案 | 对应 Phase |
|------|--------|------|------|------------|
| 1 | 视觉基准线 | 手机端字体过大易撑爆卡片 | 使用 `text-balance` 配合 truncate，多行换行更均匀 | Phase 3 增强 |
| 2 | 画布手势防护 | 签名时易触发下拉刷新、左滑返回 | 画布容器 `touch-action: none`、`overscroll-behavior: contain`，触摸 `preventDefault()` | Phase 4 增强 |
| 3 | 自检工具 | 对齐效果难以快速验证 | 开发环境 Debug 悬浮窗显示 width、height、currentScale | Phase 6 新增 |

---

## 一、核心原则

### 1.1 比例适配（Ratio Scaling）

- **逻辑画布**：以桌面端为设计基准（如 1920×1080 或 414×896 逻辑宽）
- **不固定像素**：避免 `width="1200"` 等硬编码
- **等比缩放**：通过 CSS 或 JS 保持视觉比例一致

### 1.2 三要素

| 维度 | 说明 | 实现方式 |
|------|------|----------|
| 比例锁定 | 画布/卡片宽高比不变 | aspect-ratio、max-width + 比例 |
| 容器自适应 | 父容器 100% 宽度，内容等比 | 百分比、vw、flex/grid |
| 逻辑坐标转换 | 触摸/点击坐标映射 | getBoundingClientRect + 换算 |

---

## 二、方案选型

### 方案 A：CSS 容器等比缩放（推荐先行）

**适用**：卡片、Grid 布局、无交互的展示区域。

**要点**：
- 父容器 `width: 100%`，`max-width` 限制最大宽度（如 1200px）
- 使用 `aspect-ratio` 锁定卡片比例
- 文字使用 `clamp()`、`min()`、`truncate` 防止溢出
- Grid 在窄屏改为 1–2 列，避免 3 列挤压

**优点**：实现简单，无需 JS，性能好。  
**缺点**：复杂交互（如画布涂鸦）需配合方案 B。

### 方案 B：动态 Scale Factor（含 Canvas 时使用）

**适用**：签名画布、图表、可点击/拖拽的画布区域。

**要点**：
- 基准宽度 `baseWidth = 400`（或设计稿宽度）
- `scale = currentWidth / baseWidth`
- 绘图坐标 × scale
- 点击/触摸坐标 ÷ scale 映射回逻辑坐标

**优点**：任意尺寸下逻辑坐标一致，交互精确。  
**缺点**：需维护 scale 和坐标转换逻辑。

### 方案 C：平板横竖屏

**适用**：平板（如 768px–1024px）。

**要点**：
- 横屏：画布/主内容占满，操作区在侧或底
- 竖屏：`flex-direction: column`，画布在上、操作在下
- 可选：强制横屏显示（`@media (orientation: portrait)` 提示旋转）

---

## 三、实施计划

### Phase 1：全局容器与断点（优先）

| 任务 | 文件 | 操作 |
|------|------|------|
| 1.1 统一页面容器 | `app/guest/page.tsx`、`app/user-bound/page.tsx`、`app/payment/page.tsx` 等 | 容器 `max-w-7xl mx-auto`，padding 使用 `px-4 sm:px-6 lg:px-8` |
| 1.2 定义逻辑基准 | `tailwind.config` 或 `globals.css` | 定义 `--canvas-base-width: 414`（手机逻辑宽）等变量 |
| 1.3 响应式断点 | 全局 | 确保 `sm`(640)、`md`(768)、`lg`(1024) 断点一致 |

### Phase 2：卡片与 Grid 布局

| 任务 | 文件 | 操作 |
|------|------|------|
| 2.1 游客服务卡片 | `components/guest-services.tsx` | `grid-cols-2 sm:grid-cols-3`，窄屏 2 列；卡片 `min-w-0`、`overflow-hidden`；文字 `line-clamp-2` 或 `truncate` |
| 2.2 用户首页卡片 | `app/user-bound/page.tsx`、`components/core-services.tsx` | 同上，卡片加 `aspect-ratio` 或 `min-h` 保持比例 |
| 2.3 支付页卡片 | `app/payment/page.tsx` | 表单/卡片区域 `max-w-md mx-auto` 或按比例缩放 |
| 2.4 设备列表 | `app/devices/page.tsx` | 列表项 `flex-shrink-0` 或 `min-w-0`，防止挤压 |

### Phase 3：视觉基准线 - 响应式字体与文字防溢出（增强）

| 任务 | 文件 | 操作 |
|------|------|------|
| 3.1 标题与描述 | 各卡片组件 | `truncate`、`line-clamp-2`、`text-ellipsis overflow-hidden` |
| 3.2 视觉基准线：text-balance | 各卡片组件 | **多行文本使用 `text-balance`**，使换行更均匀，避免单行过长撑爆卡片 |
| 3.3 字号适配 | `globals.css` 或组件 | `text-sm sm:text-base`，必要时 `clamp(0.875rem, 2vw, 1rem)` |

### Phase 4：Canvas 与交互（工人签名等）（增强）

| 任务 | 文件 | 操作 |
|------|------|------|
| 4.1 签名画布容器 | `app/worker/page.tsx` | 父容器 `width: 100%`，`aspect-ratio: 2/1`（400×200 比例） |
| 4.2 Canvas 尺寸 | 同上 | 保持 `width={400} height={200}` 内部分辨率；CSS `width: 100%` 控制显示尺寸 |
| 4.3 坐标转换 | 同上 | 在 `startDrawing`、`draw` 中：`const rect = canvas.getBoundingClientRect()`，`scaleX = canvas.width / rect.width`，`scaleY = canvas.height / rect.height`，物理坐标 × scale 得到逻辑坐标 |
| 4.4 防抖与系统手势禁用 | 同上 | 画布容器添加 `touch-action: none`、`overscroll-behavior: contain`，阻止下拉刷新、左滑返回；触摸事件 `preventDefault()` |

### Phase 5：平板与横竖屏

| 任务 | 文件 | 操作 |
|------|------|------|
| 5.1 平板布局 | 各主页面 | `@media (min-width: 768px) and (max-width: 1024px)` 使用 `flex-col` 或 `grid-cols-2` |
| 5.2 竖屏提示 | 可选 | 平板竖屏时显示「建议横屏使用」提示 |

### Phase 6：多端对齐自检工具（新增）

| 任务 | 文件 | 操作 |
|------|------|------|
| 6.1 Debug 悬浮窗 | 新建 `components/canvas-debug-overlay.tsx` | 仅 `NODE_ENV === 'development'` 时渲染；显示 `width`、`height`、`currentScale`（基于 viewport 或设计基准） |
| 6.2 集成到布局 | `app/layout.tsx` 或根布局 | 开发环境下挂载悬浮窗，固定定位在角落 |

---

## 四、具体实现指令（按 Phase 执行）

### Phase 1 指令

> 请修改 `app/guest/page.tsx`、`app/user-bound/page.tsx`、`app/payment/page.tsx` 的主容器：使用 `container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8`，确保移动端和平板有合适的内边距。

### Phase 2 指令

> 请修改 `components/guest-services.tsx`：将 `grid grid-cols-3` 改为 `grid grid-cols-2 sm:grid-cols-3`；为每个 Card 添加 `min-w-0 overflow-hidden`；为 `description`、`marketingText` 添加 `line-clamp-2` 或 `truncate` 防止文字溢出。

### Phase 3 指令

> 请在各卡片组件的标题、描述上添加 `truncate` 或 `line-clamp-2`，并为可能过长的 Badge/标签添加 `max-w-full truncate`。**同时为多行描述文本添加 `text-balance`**，使换行更均匀，避免单行过长撑爆卡片。

### Phase 4 指令

> 请在 `app/worker/page.tsx` 的签名 Canvas 中：1) 将 Canvas 包裹在 `div className="w-full touch-none overscroll-none" style={{ aspectRatio: '2/1', touchAction: 'none', overscrollBehavior: 'contain' }}` 中；2) Canvas 设置 `className="w-full h-full"` 且保持 `width={400} height={200}`；3) 在 `startDrawing` 和 `draw` 中，使用 `getBoundingClientRect()` 计算 scaleX/scaleY，将触摸/鼠标的物理坐标转换为 Canvas 逻辑坐标；4) **在触摸事件中调用 `e.preventDefault()` 阻止系统手势**（下拉刷新、左滑返回）。

### Phase 5 指令

> 请在平板断点（768px–1024px）下，为主要内容区域添加 `md:flex md:flex-col` 或 `md:grid md:grid-cols-2`，使画布在上、操作区在下；可选添加竖屏提示组件。

### Phase 6 指令

> 请新建 `components/canvas-debug-overlay.tsx`：仅在 `process.env.NODE_ENV === 'development'` 时渲染的悬浮窗组件。显示：当前 `window.innerWidth`、`window.innerHeight`、以及 `currentScale`（如 `innerWidth / 414`，以 414 为逻辑基准）。固定定位在右上角，半透明背景，小字号。在 `app/layout.tsx` 中引入，置于 `body` 末尾。

---

## 五、验收标准

- [ ] 手机（320px–430px）：卡片 2 列，无横向溢出，文字不换行溢出
- [ ] 平板竖屏（768×1024）：布局合理，画布与操作区分离
- [ ] 平板横屏 / 电脑：与设计稿视觉比例一致
- [ ] 签名 Canvas：触摸/点击位置与绘制位置一致；操作时不触发下拉刷新、左滑返回
- [ ] 各端无横向滚动条（除 intentionally 可滚区域）
- [ ] 开发环境：Debug 悬浮窗显示 width、height、currentScale；生产环境不渲染

---

## 六、涉及文件清单

| 文件 | Phase | 说明 |
|------|-------|------|
| `app/guest/page.tsx` | 1 | 游客页容器 |
| `app/user-bound/page.tsx` | 1 | 用户首页容器 |
| `app/payment/page.tsx` | 1, 2 | 支付页容器与卡片 |
| `app/devices/page.tsx` | 2 | 设备列表 |
| `components/guest-services.tsx` | 2, 3 | 游客服务卡片 |
| `components/core-services.tsx` | 2 | 核心服务卡片 |
| `components/iot-dashboard.tsx` | 2 | IoT 看板 |
| `app/worker/page.tsx` | 4 | 签名 Canvas、坐标转换、手势禁用 |
| `components/canvas-debug-overlay.tsx` | 6 | Debug 悬浮窗（开发环境） |
| `app/layout.tsx` | 6 | 挂载 Debug 悬浮窗 |
| `app/globals.css` | 1, 3 | 全局变量、响应式工具类 |
