# 对公支付设计与实现指南

**版本**: v1.1  
**日期**: 2026-01-31  
**场景**: 企业客户在客户端下单时选择对公支付（银行转账、开票后付款）

---

## 一、业务场景

- **个人/个体户客户**：微信、支付宝、银行卡等即时支付
- **企业客户**：需要开票、走报销流程，常用**对公转账**或**月结/账期**
- 对公支付特点：订单创建后不即时扣款，需人工/系统确认收款
- **痛点**：对公转账往往需要 1–3 天到账，但客户要燃料可能很急 → 引入**授信额度**解耦

---

## 二、核心设计原则

### 2.1 多租户白标化：收款账户存 companies 表

**问题**：环境变量只能存一个平台级账户，各地合伙人/供应商各有自己的对公银行账户。

**方案**：在 `companies` 表增加 `bank_name`、`bank_account`、`tax_id`。客户下单时，通过 `restaurant_id → company_id` 自动拉取所属供应商的收款账户。

### 2.2 对公转账与配送解耦：授信额度（Credit Limit）

**逻辑矛盾**：对公转账 1–3 天到账，客户可能急用燃料。

**方案**：在 `restaurants` 增加 `credit_line`（授信额度）。企业客户选择对公支付时：
- 若订单金额 ≤ 可用授信：**允许立即配送**，财务后期确认到账后恢复额度
- 若超出授信：订单进入「待对公支付」，需财务确认收款后再派单

**意义**：增加平台对企业客户的粘性——“只有在厨帆下单，才能享受账期服务”。

### 2.3 事实驱动：凭证上传证据链

**风险**：对公支付最怕「假回单」。

**方案**：上传凭证时强制记录：
- 上传者 IP
- 地理位置（经纬度）
- 时间戳

存入 `audit_logs.metadata`，作为纠纷解决的硬事实。

---

## 三、数据模型

### 3.1 companies 表扩展

```sql
ALTER TABLE companies ADD COLUMN IF NOT EXISTS bank_name TEXT;
ALTER TABLE companies ADD COLUMN IF NOT EXISTS bank_account TEXT;
ALTER TABLE companies ADD COLUMN IF NOT EXISTS tax_id TEXT;
```

**用途**：每个合伙人/供应商维护自己的对公收款账户。

### 3.2 restaurants 表扩展

```sql
ALTER TABLE restaurants ADD COLUMN IF NOT EXISTS credit_line DECIMAL(12,2) DEFAULT 0;
-- 授信额度（元），0 表示不授信
ALTER TABLE restaurants ADD COLUMN IF NOT EXISTS customer_type TEXT DEFAULT 'individual';
-- individual | enterprise
```

**授信计算**：
- 已用授信 = Σ 订单金额（同一 restaurant，payment_method='corporate' 且 payment_status='pending_transfer'）
- 可用授信 = credit_line - 已用授信
- 当 订单金额 ≤ 可用授信 时，可立即配送

### 3.3 delivery_orders 表扩展

```sql
ALTER TABLE delivery_orders ADD COLUMN IF NOT EXISTS payment_method TEXT DEFAULT 'online';
-- online | corporate
ALTER TABLE delivery_orders ADD COLUMN IF NOT EXISTS payment_status TEXT DEFAULT 'pending';
-- pending | paid | pending_transfer | transfer_confirmed
ALTER TABLE delivery_orders ADD COLUMN IF NOT EXISTS invoice_requested BOOLEAN DEFAULT false;
ALTER TABLE delivery_orders ADD COLUMN IF NOT EXISTS corporate_company_name TEXT;
ALTER TABLE delivery_orders ADD COLUMN IF NOT EXISTS corporate_tax_id TEXT;
ALTER TABLE delivery_orders ADD COLUMN IF NOT EXISTS payment_voucher_url TEXT;
```

### 3.4 audit_logs 凭证审计

`audit_logs` 已存在，`metadata` 为 JSONB。凭证上传时插入：

```json
{
  "action": "VOUCHER_UPLOADED",
  "target_type": "delivery_order",
  "target_id": "订单UUID",
  "metadata": {
    "voucher_url": "...",
    "uploader_ip": "1.2.3.4",
    "uploader_lat": 25.04,
    "uploader_lon": 102.71,
    "uploaded_at": "2026-01-31T12:00:00Z"
  }
}
```

---

## 四、客户端流程（对公支付）

1. 客户在支付页选择「对公支付」
2. 若选择对公，展示**企业信息表单**（可折叠）：
   - 公司名称 *
   - 纳税人识别号 *
   - 是否需要发票：是/否
3. 点击「提交订单」→ 调用创建订单 API，传入 `payment_method=corporate`
4. 服务端逻辑：
   - 获取 `restaurant.company_id` → 拉取 `companies.bank_*` 作为收款账户
   - 计算可用授信，判断是否可立即配送
5. 跳转「待对公支付」结果页，展示：
   - 订单号、金额
   - **供应商收款账户**（来自 companies）
   - 打款备注（订单号）
   - 可选：上传转账凭证（含 IP、地理位置、时间戳审计）
6. 若在授信内：订单可正常进入派单；若超出授信：待财务确认收款后再派单

---

## 五、管理端流程

1. 供应商管理：维护 `companies.bank_name`、`bank_account`、`tax_id`
2. 餐厅管理：为企业客户设置 `credit_line`、`customer_type=enterprise`
3. 订单列表：筛选项增加「待对公支付」「待确认收款」
4. 确认收款：将 `payment_status` 置为 `transfer_confirmed`，恢复授信
5. 查看凭证审计：audit_logs 中按 target_type=delivery_order、action=VOUCHER_UPLOADED 查询

---

## 六、实现细节

### 6.1 授信原子性（防并发超支）

创建对公订单时，授信校验与插入必须在**同一数据库事务**内完成，防止高并发下出现授信超支。实现方式：

- 使用 PostgreSQL 函数 `create_corporate_delivery_order`（RPC）
- 事务内：`SELECT ... FOR UPDATE` 锁定餐厅行 → 计算已用授信 → 校验 → `INSERT` 订单
- 应用层通过 `supabase.rpc("create_corporate_delivery_order", {...})` 调用

### 6.2 IP 解析（CDN 兼容）

凭证上传时获取客户端真实 IP，优先使用 `request.headers.get('x-forwarded-for')`：

- CDN（如 Cloudflare）、反向代理（Nginx）会写入该头
- 格式为 `"client, proxy1, proxy2"`，取第一段为原始客户端 IP
- 审计日志 metadata 中记录 `uploader_ip`，作为争议证据链

### 6.3 空状态处理

供应商未配置收款账户时，前端显示友好提示而非报错或空白：

- API 返回 `success: false, code: "ACCOUNT_NOT_CONFIGURED"`，HTTP 200
- 支付页：选择对公时预检查，若未配置则展示提示并禁用提交按钮
- 结果页：展示空状态卡片（图标 + 标题 + 说明 + 联系提示）

---

## 七、API 设计

### 7.1 获取收款账户（按 restaurant_id）

```
GET /api/orders/corporate-payment-account?restaurant_id=xxx
Response: { bank_name, bank_account, company_name, tax_id }
```

### 7.2 校验授信额度

```
GET /api/orders/credit-check?restaurant_id=xxx&amount=1234.56
Response: { available: 5000, used: 3000, credit_line: 8000, can_deliver: true }
```

### 7.3 创建订单（扩展）

```json
{
  "restaurant_id": "...",
  "payment_method": "corporate",
  "corporate_company_name": "XX科技有限公司",
  "corporate_tax_id": "91xxx",
  "invoice_requested": true,
  "service_type": "...",
  "amount": 1234.56
}
```

### 7.4 上传转账凭证（含审计）

```
POST /api/orders/[id]/upload-voucher
Body: FormData { file: File }
Headers: 优先 x-forwarded-for（CDN 兼容，取第一段为真实 IP）
→ 记录 IP、经纬度（客户端可选传入）、时间戳到 audit_logs
→ 更新 delivery_orders.payment_voucher_url
```

### 7.5 确认对公收款

```
POST /api/orders/[id]/confirm-corporate-payment
Body: { confirmed: true, invoice_number?: "...", note?: "..." }
```

---

## 八、安全与权限

- 收款账户仅对订单所属 restaurant 的客户可见
- 对公收款确认仅允许 `company_admin`、`platform_admin`、`super_admin`
- 凭证上传需校验订单归属（restaurant_id / company_id）
- 企业信息（税号等）需脱敏展示与日志记录

---

## 九、与现有代码的衔接点

| 位置 | 修改点 |
|------|--------|
| `app/payment/page.tsx` | paymentMethods 增加 corporate；handlePayment 分支；授信不足提示 |
| `app/api/orders/create/route.ts` | 接收 payment_method、corporate_*；授信校验；写 payment_status |
| `app/api/orders/corporate-payment-account/route.ts` | 新建：按 restaurant_id 拉取 companies 收款账户 |
| `app/api/orders/credit-check/route.ts` | 新建：授信校验 |
| `app/api/orders/[id]/upload-voucher/route.ts` | 新建：凭证上传 + audit_logs |
| `app/payment/corporate-result/page.tsx` | 新建：对公支付结果页 |
| `delivery_orders`、`companies`、`restaurants` | 迁移脚本新增字段 |

---

## 十、验收标准

### Phase 1
- [ ] companies 表有 bank_name、bank_account、tax_id
- [ ] restaurants 表有 credit_line
- [ ] delivery_orders 表有 payment_method、payment_status 等
- [ ] 客户端可选择「对公支付」
- [ ] 结果页展示**所属供应商**的收款账户（非环境变量）
- [ ] 授信内可立即配送，超授信需确认

### Phase 2
- [ ] 凭证上传写入 audit_logs（IP、经纬度、时间戳）
- [ ] 管理端可确认收款、恢复授信
- [ ] 管理端可维护 companies 收款账户、restaurants 授信额度
