# 本地与部署环境差异排查指南

**现象**：本地测试正常，但部署到线上后：
- 测试账号登录看不到订单列表
- 点击「我的设备」会跳回首页，看不到设备

---

## 一、最可能的原因

### 1. 本地和线上连接的是**不同数据库**

| 环境   | 配置来源           | 数据库 |
|--------|--------------------|--------|
| 本地   | `.env.local`       | 开发/测试 Supabase 项目 |
| 线上   | Vercel 环境变量    | 生产 Supabase 项目 |

若两边指向**不同的 Supabase 项目**，则：
- 本地创建的订单、设备、餐厅等只在本地库
- 线上库是空的或数据完全不同

**排查**：对比本地 `.env.local` 和 Vercel 的 `NEXT_PUBLIC_SUPABASE_URL` 是否一致。

---

### 2. localStorage 按域名隔离

`localStorage` 是按**域名**隔离的：

- `http://localhost:3000` → 一套 localStorage
- `https://xxx.vercel.app` → 另一套 localStorage

因此：
- 本地登录后存的 `restaurantId` 不会带到线上
- 线上必须重新登录，登录流程才会写入 `restaurantId`

**影响**：
- 订单 API 需要 `x-restaurant-id`（来自 localStorage）
- 设备页需要 `restaurantId` 或 Supabase 用户，否则会重定向到首页

---

### 3. 线上数据库缺少测试数据

即便本地和线上连同一个 Supabase 项目：
- 测试订单、设备、餐厅等可能是本地手动建的
- 若从未在线上库执行过迁移或初始化脚本，线上库可能没有对应数据

---

## 二、排查步骤

### 步骤 1：确认 Supabase 项目是否一致

1. 打开 Supabase Dashboard，记下当前项目的 URL（如 `https://xxx.supabase.co`）
2. 对比：
   - 本地：`.env.local` 中的 `NEXT_PUBLIC_SUPABASE_URL`
   - 线上：Vercel 项目 → Settings → Environment Variables
3. 若不一致，要么：
   - 把 Vercel 的 URL 改为与本地相同（用同一 Supabase 项目），  
   - 要么在线上 Supabase 中补齐测试数据。

---

### 步骤 2：确认线上登录和 restaurantId

1. 在线上环境重新登录（不要依赖本地登录状态）
2. 打开浏览器开发者工具 → Application → Local Storage → 选择你的线上域名
3. 查看是否存在 `restaurantId`：
   - 若存在：说明登录流程已正确写入
   - 若不存在：说明登录未写入 `restaurantId`，需检查注册/登录接口

---

### 步骤 3：在线上库中补齐数据

若本地和线上使用**同一个** Supabase 项目，一般无需额外操作。

若线上是**独立生产库**，需要：

1. 在 Supabase SQL Editor 中执行迁移脚本（如 `migrations/` 下）
2. 创建测试餐厅、设备、订单等
3. 确保测试账号对应的 `user_id` 已正确关联：
   - `restaurants.user_id`
   - `user_roles`
   - `user_companies`（如有）

---

### 步骤 4：检查 API 请求

1. 打开开发者工具 → Network
2. 访问订单列表、我的设备页面
3. 查看相关 API 请求：
   - 是否带有 `x-restaurant-id` 请求头
   - 状态码是否为 401/403
   - 响应内容是否为空或错误信息

---

## 三、常见修复

### 问题 A：线上看不到订单

| 可能原因                 | 处理方式                                      |
|--------------------------|-----------------------------------------------|
| 线上库无订单             | 在线上 Supabase 中创建测试订单，或迁移数据   |
| 未传 `x-restaurant-id`   | 检查登录是否成功写入 `localStorage.restaurantId` |
| 401 未授权               | 确认已重新登录，或检查 getUserContext/Token 逻辑 |

### 问题 B：点击「我的设备」跳回首页

设备页会重定向到 `/` 的情况：
- 无 `restaurantId`（localStorage）
- 且无 Supabase 已登录用户

处理方式：
1. 在线上重新登录（手机号或 Supabase 登录）
2. 确认登录接口会写入 `restaurantId`
3. 若用 Supabase Auth，检查线上 Supabase URL 与 Vercel 环境变量是否一致

### 问题 C：本地和线上想用同一套数据

1. 确认本地 `.env.local` 和 Vercel 的 `NEXT_PUBLIC_SUPABASE_URL`、`NEXT_PUBLIC_SUPABASE_ANON_KEY` 指向同一 Supabase 项目
2. 线上重新登录后，应能看到与本地相同的数据（在数据存在的前提下）

---

## 四、快速验证清单

- [ ] 本地与线上 `NEXT_PUBLIC_SUPABASE_URL` 是否一致
- [ ] 线上已重新登录（不要依赖本地登录状态）
- [ ] 线上 localStorage 中存在 `restaurantId`
- [ ] 线上 Supabase 中已有对应餐厅、设备、订单
- [ ] 相关 API 请求带有 `x-restaurant-id` 且返回 200
