# 测试错误修复说明

## 已修复

### 1. AMap.Geolocation 初始化失败（TypeError: AMap.Geolocation is not a constructor）

**原因**：管理端地图看板通过 script 标签加载高德地图，仅加载了基础 AMap，未包含 Geolocation/Geocoder 插件。个人中心、地址管理等页面复用 `window.AMap` 时，插件未就绪导致报错。

**修复**：
- `lib/amap-loader.ts`：不再复用已有的 `window.AMap`，统一通过 `@amap/amap-jsapi-loader` 加载，保证插件可用
- `components/profile-content.tsx`、`app/addresses/page.tsx`：在使用前检查 `AMap.Geolocation`、`AMap.Geocoder` 是否为有效构造函数，否则抛出明确错误

### 2. favicon.ico 404

**修复**：
- `app/layout.tsx`：在 metadata 中增加 `icons: { icon: "/icon.svg" }`
- `next.config.mjs`：对 `/favicon.ico` 请求重定向到 `/icon.svg`

---

## 需环境/配置处理

### 3. WebSocket 连接失败、IoT Dashboard Realtime 订阅超时

**表现**：`WebSocket connection failed`、`[IoT Dashboard] Realtime 订阅失败 (status: 'TIMED_OUT')`、`达到最大重连次数,停止重连`。

**可能原因**：
- 网络或防火墙限制 WebSocket
- Supabase Realtime 未正确配置或不可达
- 代理/VPN 影响 WebSocket 连接

**建议**：
1. 检查 Supabase 项目的 Realtime 是否已启用
2. 在无代理环境下测试
3. 若为内网/受限环境，考虑关闭 Realtime 订阅或改用轮询

### 4. Canvas getImageData 性能警告

**表现**：`Multiple readback operations using getImageData are faster with the willReadFrequently attribute set to true`。

**说明**：该警告来自高德地图 SDK 内部，与项目自身 Canvas 使用无关，可忽略。如要消除，需等待高德 SDK 更新。

---

## 补充修复（2025-01-31）

### 5. 合同设备关系查询 - invalid input syntax for type uuid: "TEST-DEV-001"

**原因**：`rental_contract_devices.device_id` 为 UUID 类型，当设备列表包含非 UUID 格式（如测试设备 `TEST-DEV-001`）时，`.in("device_id", deviceIds)` 会触发 PostgreSQL 错误。

**修复**：`app/devices/page.tsx` 中在查询 `rental_contract_devices` 前，先用正则过滤出合法 UUID，仅对合法 ID 执行查询。非 UUID 设备（如测试设备）将跳过合同关系查询，不影响主流程。
