# 项目架构文档

**项目名称**：我的智能餐厅 - 商业厨房服务APP（SaaS版本）  
**文档版本**：v1.0  
**生成日期**：2026-01-27  
**技术栈**：Next.js 16 + React 19 + TypeScript + Supabase + Tailwind CSS

---

## 一、项目概述

### 1.1 业务定位

本项目是一个面向商业厨房的**一站式后市场服务平台**，为餐厅、酒店等餐饮企业提供从燃料配送、设备租赁到维修保养、供应链采购的全链条服务。

**核心价值主张**：
- 解决餐饮企业后市场服务分散、效率低下的痛点
- 通过SaaS模式实现多租户管理，支持供应商、餐厅、配送员等多角色协同
- 提供从下单、接单、派单到完成、支付的全流程数字化管理

### 1.2 技术架构

```
┌─────────────────────────────────────────────────────────────┐
│                     前端层 (Next.js App Router)              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ 客户端   │  │ 管理端   │  │ 员工端   │  │ 游客端   │   │
│  │ (餐厅)   │  │ (供应商) │  │ (配送/   │  │ (营销)   │   │
│  │          │  │          │  │ 维修)    │  │          │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                  API层 (Next.js API Routes)                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ 订单API  │  │ 设备API  │  │ 财务API  │  │ 事实API  │   │
│  │          │  │          │  │          │  │ (Facts)  │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│              业务逻辑层 (Domain Services)                    │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ 认证授权  │  │ 多租户   │  │ 状态管理  │  │ 审计日志  │   │
│  │          │  │ 隔离     │  │          │  │          │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│              数据层 (Supabase PostgreSQL)                    │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ 用户认证  │  │ 业务数据  │  │ RLS策略  │  │ 实时订阅  │   │
│  │ (Auth)   │  │ (Tables)  │  │ (Security)│  │ (Realtime)│   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 二、目录结构

### 2.1 核心目录

```
my-mind-chufan-app/
├── app/                          # Next.js App Router
│   ├── (admin)/                 # 管理端路由组
│   │   └── dashboard/          # 管理后台
│   ├── (guest)/                 # 访客路由组
│   ├── api/                     # API路由（Next.js API Routes）
│   │   ├── admin/               # 管理员API
│   │   ├── orders/              # 订单API
│   │   ├── equipment/           # 设备API
│   │   ├── finance/             # 财务API
│   │   ├── facts/               # 事实API（Facts驱动架构）
│   │   └── ...
│   ├── page.tsx                 # 根路径（身份调度器）
│   └── layout.tsx               # 根布局
│
├── components/                   # React组件库
│   ├── ui/                      # 基础UI组件（shadcn/ui）
│   ├── error-boundary.tsx       # 错误边界
│   └── ...
│
├── lib/                         # 核心业务逻辑库
│   ├── auth/                    # 认证授权模块
│   │   ├── user-context.ts     # 用户上下文（统一权限入口）
│   │   ├── facts-auth.ts        # Facts API认证
│   │   └── worker-auth.ts      # 员工端认证
│   ├── multi-tenant.ts          # 多租户隔离工具
│   ├── facts/                   # Facts驱动架构核心
│   │   ├── contracts/          # 事实契约
│   │   └── README.md
│   ├── rental/                  # 租赁领域
│   ├── supabase.ts             # Supabase客户端
│   └── ...
│
├── hooks/                       # React Hooks
├── migrations/                  # 数据库迁移脚本
├── docs/                        # 项目文档
└── public/                      # 静态资源
```

### 2.2 关键文件说明

| 文件路径 | 说明 | 重要性 |
|---------|------|--------|
| `app/page.tsx` | 根路径入口，身份调度器 | ⭐⭐⭐⭐⭐ |
| `lib/auth/user-context.ts` | 统一权限入口，所有API必须使用 | ⭐⭐⭐⭐⭐ |
| `lib/multi-tenant.ts` | 多租户数据隔离工具 | ⭐⭐⭐⭐⭐ |
| `lib/supabase.ts` | Supabase客户端初始化 | ⭐⭐⭐⭐ |
| `next.config.mjs` | Next.js配置 | ⭐⭐⭐ |

---

## 三、技术栈详解

### 3.1 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Next.js | 16.0.10 | React框架，App Router模式 |
| React | 19.2.0 | UI框架 |
| TypeScript | ^5 | 类型安全 |
| Tailwind CSS | ^4.1.9 | 样式框架 |
| shadcn/ui | - | UI组件库（基于Radix UI） |
| Framer Motion | ^12.23.26 | 动画库 |
| React Hook Form | ^7.60.0 | 表单管理 |
| Zod | 3.25.76 | 数据验证 |

### 3.2 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Next.js API Routes | 16.0.10 | 服务端API |
| Supabase | ^2.89.0 | BaaS平台（数据库+认证） |
| PostgreSQL | (Supabase) | 关系型数据库 |
| Supabase Auth | - | 用户认证 |
| Supabase RLS | - | 行级安全策略 |

### 3.3 第三方服务

| 服务 | 用途 | 配置位置 |
|------|------|----------|
| Supabase | 数据库+认证 | `.env.local` |
| 高德地图 | 地图服务 | `.env.local` (可选) |
| 支付宝 | 支付服务 | API配置（沙箱环境） |

---

## 四、架构设计模式

### 4.1 Facts驱动架构（Fact-Driven Architecture）

**核心理念**：将业务事实（Facts）作为系统的唯一数据源，所有业务逻辑基于事实进行推导。

**关键组件**：
- `lib/facts/` - Facts核心模块
- `app/api/facts/` - Facts API端点
- Facts契约定义（README.md）

**优势**：
- 数据一致性：单一事实源
- 可追溯性：所有状态变更可追溯
- 可扩展性：新功能基于现有Facts扩展

### 4.2 多租户架构（Multi-Tenant）

**隔离策略**：
- **数据隔离**：通过 `company_id` / `provider_id` 字段隔离
- **权限隔离**：通过 `user_roles` 表和 `getUserContext` 统一管理
- **RLS策略**：数据库层面行级安全策略

**关键文件**：
- `lib/multi-tenant.ts` - 多租户工具函数
- `lib/auth/user-context.ts` - 用户上下文（包含companyId）
- `migrations/*.sql` - RLS策略SQL脚本

### 4.3 权限管理架构（RBAC）

**角色层级**：
```
super_admin (系统级)
  └── platform_admin (平台运营)
      └── company_admin (公司管理员)
          └── staff (员工)
              ├── factory (工厂)
              ├── filler (加气员)
              └── delivery/repair (配送/维修)
```

**权限验证流程**：
1. API接收请求 → `getUserContext(req)` 获取用户上下文
2. 检查用户角色 → 从 `user_roles` 表查询
3. 获取公司ID → 从 `restaurants` 表查询（非super_admin）
4. 数据过滤 → 使用 `companyId` 过滤查询结果

**关键文件**：
- `lib/auth/user-context.ts` - 统一权限入口
- `lib/auth/worker-auth.ts` - 员工端权限验证
- `lib/capabilities.ts` - 能力权限定义

---

## 五、数据模型

### 5.1 核心实体关系

```
users (Supabase Auth)
  ├── user_roles (用户角色)
  └── restaurants (餐厅/商户)
      ├── devices (设备)
      ├── delivery_orders (配送订单)
      ├── repair_orders (维修订单)
      └── equipment_rentals (设备租赁)

companies (供应商公司)
  ├── equipment_catalog (设备目录)
  ├── rental_orders (租赁订单)
  └── rental_ownership_contracts (租赁合同)

workers (员工)
  ├── delivery_orders (配送订单)
  └── repair_orders (维修订单)
```

### 5.2 关键表结构

#### 用户与权限
- `users` - Supabase Auth用户表
- `user_roles` - 用户角色关联表
- `restaurants` - 餐厅/商户表（包含 `company_id` 字段）

#### 订单系统
- `delivery_orders` - 配送订单表
- `repair_orders` - 维修订单表
- `orders_main` - 主订单表（统一订单系统）

#### 设备系统
- `devices` - 设备表
- `equipment_catalog` - 设备目录表（按 `provider_id` 隔离）
- `equipment_rentals` - 设备租赁表

#### 租赁系统
- `rental_orders` - 租赁订单表
- `rental_ownership_contracts` - 租赁合同表
- `usage_snapshots` - 使用快照表

---

## 六、API架构

### 6.1 API路由组织

```
/api/
├── admin/              # 管理员API（COMPANY_LEVEL）
│   ├── create-company
│   ├── create-user
│   └── rental/
│
├── orders/             # 订单API（COMPANY_LEVEL）
│   ├── create
│   ├── accept
│   ├── dispatch
│   └── complete
│
├── equipment/          # 设备API（COMPANY_LEVEL）
│   ├── catalog/
│   └── rental/
│
├── facts/              # 事实API（公开访问）
│   ├── orders/
│   ├── restaurant/
│   └── equipment-rental-stats
│
├── finance/            # 财务API（COMPANY_LEVEL）
│   ├── billing/
│   └── report
│
└── worker/             # 员工端API（STAFF_LEVEL）
    └── login
```

### 6.2 API权限级别

| 级别 | 说明 | 验证方式 | 示例 |
|------|------|----------|------|
| **PUBLIC** | 公开访问 | 无需验证 | `/api/facts/*` |
| **COMPANY_LEVEL** | 公司级权限 | `getUserContext` + `companyId` | `/api/orders/*` |
| **STAFF_LEVEL** | 员工级权限 | `verifyWorkerPermission` | `/api/worker/*` |
| **ADMIN_LEVEL** | 管理员权限 | `getUserContext` + role检查 | `/api/admin/*` |

### 6.3 API设计原则

1. **统一权限入口**：所有需要权限的API必须使用 `getUserContext`
2. **多租户隔离**：所有数据查询必须包含 `companyId` 过滤
3. **错误处理**：统一错误响应格式，包含 `success`、`error`、`data` 字段
4. **审计日志**：关键操作必须写入审计日志

---

## 七、安全架构

### 7.1 认证机制

**Supabase Auth**：
- JWT Token存储在Cookie中
- 自动刷新Token机制
- Session管理由Supabase处理

**关键文件**：
- `lib/supabase.ts` - 客户端初始化
- `lib/supabase/server.ts` - 服务端初始化
- `lib/auth/user-context.ts` - 用户上下文获取

### 7.2 授权机制

**RBAC（基于角色的访问控制）**：
- 角色存储在 `user_roles` 表
- 权限验证通过 `getUserContext` 统一入口
- 能力权限通过 `Capability` 枚举定义

**关键文件**：
- `lib/auth/user-context.ts` - 统一权限入口
- `lib/capabilities.ts` - 能力权限定义
- `lib/auth/requireCapability.ts` - 能力权限验证

### 7.3 数据安全

**RLS（行级安全策略）**：
- 数据库层面数据隔离
- 每个表都有对应的RLS策略
- 策略定义在 `migrations/*.sql` 文件中

**多租户隔离**：
- 应用层通过 `companyId` 过滤
- 数据库层通过RLS策略限制
- 双重保障确保数据隔离

---

## 八、部署架构

### 8.1 环境配置

**必需环境变量**：
```env
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=xxx
SUPABASE_SERVICE_ROLE_KEY=xxx  # 仅服务端使用
```

**可选环境变量**：
```env
NEXT_PUBLIC_AMAP_KEY=xxx  # 高德地图（可选）
NODE_ENV=production
```

### 8.2 构建配置

**Next.js配置** (`next.config.mjs`)：
- TypeScript错误忽略（`ignoreBuildErrors: true`）- ⚠️ 需修复
- 图片未优化（`unoptimized: true`）
- 环境变量显式配置

### 8.3 部署建议

**推荐平台**：
- Vercel（Next.js官方平台）
- 其他支持Next.js的平台（Netlify、Railway等）

**部署前检查**：
1. ✅ 环境变量配置
2. ✅ 数据库迁移执行
3. ✅ RLS策略配置
4. ⚠️ TypeScript错误修复
5. ⚠️ 生产环境优化

---

## 九、开发规范

### 9.1 代码规范

**TypeScript**：
- 严格模式启用（`strict: true`）
- 路径别名：`@/*` 指向项目根目录
- 类型定义优先使用接口（Interface）

**React**：
- 使用函数组件 + Hooks
- 组件文件使用 `.tsx` 扩展名
- Props类型必须定义

### 9.2 文件命名规范

- **组件**：PascalCase（如 `UserProfile.tsx`）
- **工具函数**：camelCase（如 `getUserContext.ts`）
- **API路由**：小写+连字符（如 `create-order/route.ts`）
- **常量**：UPPER_SNAKE_CASE（如 `API_BASE_URL`）

### 9.3 Git规范

**分支策略**：
- `main` - 主分支（生产环境）
- `develop` - 开发分支
- `feature/*` - 功能分支

**提交信息**：
- `feat:` - 新功能
- `fix:` - 修复bug
- `docs:` - 文档更新
- `refactor:` - 代码重构

---

## 十、已知问题与限制

### 10.1 技术债务

1. **TypeScript错误忽略**：`next.config.mjs` 中设置了 `ignoreBuildErrors: true`
   - **影响**：可能隐藏类型错误
   - **建议**：逐步修复类型错误，移除该配置

2. **部分API未接入权限验证**：部分COMPANY_LEVEL API未使用 `getUserContext`
   - **影响**：存在安全风险
   - **建议**：优先修复，见 `阶段2B-4-权限与角色边界梳理.md`

3. **支付回调处理不完整**：支付宝回调仅支持沙箱环境
   - **影响**：生产环境支付功能不完整
   - **建议**：完善支付回调处理

### 10.2 功能限制

1. **离线同步**：已实现但需要进一步测试
2. **数据统计**：部分统计功能不完整
3. **商城功能**：B2B商城部分功能未完成

---

## 十一、扩展性设计

### 11.1 水平扩展

- **无状态API**：所有API路由都是无状态的，支持水平扩展
- **数据库连接池**：Supabase自动管理连接池
- **CDN支持**：静态资源可通过CDN加速

### 11.2 垂直扩展

- **数据库优化**：通过索引和查询优化提升性能
- **缓存策略**：可引入Redis缓存热点数据
- **异步处理**：耗时操作可改为异步任务队列

---

## 十二、监控与日志

### 12.1 日志系统

**审计日志**：
- `audit_logs` 表记录关键操作
- 通过 `writeAuditLog` 函数写入
- 包含操作者、操作类型、目标对象等信息

**应用日志**：
- 使用 `console.log/error` 记录
- 生产环境建议接入日志服务（如Sentry）

### 12.2 监控指标

**运营监控**：
- `/api/ops/overview` - 运营总览
- `/api/ops/exceptions` - 异常订单监控

**性能监控**：
- Vercel Analytics（已集成）
- 可接入APM工具（如New Relic）

---

## 附录

### A. 相关文档

- `docs/1-system-architecture.md` - 系统架构详细文档
- `docs/2-data-schema-part1.md` - 数据模型文档
- `docs/4-api-routes-reference-part1.md` - API参考文档
- `项目汇报.md` - 项目业务说明

### B. 外部资源

- [Next.js文档](https://nextjs.org/docs)
- [Supabase文档](https://supabase.com/docs)
- [Tailwind CSS文档](https://tailwindcss.com/docs)

---

**文档维护**：本文档应随项目演进持续更新，建议每次重大架构变更后更新版本号。
