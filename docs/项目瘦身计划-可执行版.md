# 项目整体瘦身计划（可执行版）

**目标**：在投放市场前将项目从约 1.4G 瘦身，便于克隆、CI 与部署。  
**原则**：先分类 → 再冻结（归档）→ 再物理删除 → 最后校验。**本文档仅规划，不执行任何删除。**

**文档定位**：本计划属于**平台治理**范畴——有生命周期意识、平台脊椎保护、执行边界与未来防复发设计，而非单纯“清理磁盘”。

---

## 一、瘦身流程总览

| 阶段     | 动作说明 |
|----------|----------|
| **分类** | 按下方四类整理清单，区分「可删」「可归档」「绝不删」 |
| **冻结** | 分 **A 类（工程冻结）** 与 **B 类（真正冷冻）**，见下一节 |
| **物理删除** | 按清单执行删除（或依赖 .gitignore + 本地清理） |
| **校验**   | `npm i` / `npm run build` 通过、关键文档与平台代码仍在 |

### 冻结的两种类型（重要：冻结 ≠ zip 一下就行）

| 类型 | 适用场景 | 做法 | 说明 |
|------|----------|------|------|
| **A 类：工程冻结**（推荐，约 80% 用这个） | 历史报告、零散 SQL、一次性脚本等 | **移动到** `docs/archive/`、`scripts/archive/`、`sql/archive/`（或 `scripts/archive-sql/`），**保留为原始文本格式**；目录内加一行 **README** 说明用途与冻结原因 | 可 diff、grep、code search；Cursor 可判断是否真的无用；后续平台演进仍可查阅 |
| **B 类：真正冷冻**（极少数） | 如 `.backup/` 这类历史约束快照，内容极少再被查阅 | 才使用 **zip** 打包后删除 | zip 不可 diff/grep，仅在对内容几乎不再查阅时使用 |

**原则**：优先「移动为 archive/ 目录」；仅在内容极少再被查阅时才压缩。

---

## 二、四大必删类别（按优先级）

### ① 构建产物 / 编译输出（第一优先级）

**特征**：可由命令重新生成、对运行无长期价值、往往体积巨大。

| 路径/模式 | 当前状态 | 建议动作 |
|-----------|----------|----------|
| `/.next/` | 已在 .gitignore | **不提交**；本地若存在则删除，`npm run build` 可重建 |
| `/out/`   | 已在 .gitignore | 同上 |
| `/build/` | 已在 .gitignore | 同上 |
| `/.vercel/` | 已在 .gitignore | 同上 |
| `/.turbo/` | 已加入 .gitignore | 本地删除 |
| `/.cache/` | 已加入 .gitignore | 本地删除 |

**执行要点**：

- 确认 **.gitignore** 已包含：`/node_modules`、`/.next/`、`/out/`、`/build`、`.vercel`、`.turbo`、`.cache`。
- 仅在**本地**删除上述目录实体，不提交这些目录；删除后执行 `npm ci` 与 `npm run build` 做校验。

**防复发（平台工程治理）**：

- 若发现构建产物**已被误提交**到仓库，应通过：
  - `git rm --cached <path>` 从版本库移除（保留本地文件可选）
  - 并**补充 .gitignore** 对应条目
- 目的：防止下次再次进入仓库，而非单次清理。

---

### ② 依赖缓存与包管理冗余（体积王）

| 路径/模式 | 说明 | 建议动作 |
|-----------|------|----------|
| `/node_modules/` | 100% 可重装 | 删除后执行 `npm ci` 或 `npm install` |
| `/.pnpm-store/` | pnpm 缓存（若在项目内） | 可清；若未用 pnpm 可忽略 |
| `/.yarn/`        | Yarn 缓存（若在项目内） | 可清；若未用 Yarn 可忽略 |
| `/.npm/`         | 通常不在项目内 | 见下方权限边界 |
| `/.cache/`       | 各类工具缓存（项目内） | 可清 |

**必须保留**：`package.json`、`package-lock.json`（或 `pnpm-lock.yaml` / `yarn.lock`）。

**执行要点**：

- 若 1.4G 中大部分来自 `node_modules`，删除后重装即可显著瘦身（仓库内不应提交 node_modules）。
- 再次确认 .gitignore 含 `/node_modules`，且仓库中未误提交。

**权限边界（给 Cursor / 执行者的安全说明）**：

- **本计划仅针对「项目仓库内」路径**，不操作用户 Home 目录下的缓存（如 `~/.npm`、`~/.pnpm-store`、`~/.yarn`）。
- 禁止对项目根目录之外的路径执行删除或修改。

---

### ③ 临时调试 / 实验性文件（易遗漏）

**判断公式（执行前先做静态分析）**：

若一个文件**同时满足**以下 2 条，可判定为「临时」、可归档或删：

1. **未被引用**：未被 `import` / `require` / migration 引用 / runtime config 引用。
2. **功能已迁移**：其功能已被迁移到正式目录（如 `migrations/`、`lib/`、`docs/` 等）。

建议：Cursor 先做引用关系检查，再执行归档；不满足上述两条的按「保留」处理。

---

#### 3.1 整目录可归档/删

| 路径 | 说明 | 建议 | 执行前提 |
|------|------|------|----------|
| **`.backup/`** | 内含 constraints 备份及 13 个 `.backup` 文件；与决策约束相关的为历史快照，非平台“脊椎”代码 | **B 类冷冻**：可 zip 后删除（内容极少再被查阅） | **必须先确认**：`.backup/` 中内容**未被**当前平台策略加载、**未被**任何文件 `import`、**未被** `migrations` 引用；否则不删，仅移动至 `docs/archive/backup-constraints/` 并加 README |

#### 3.2 根目录零散文件（A 类工程冻结，优先移动、不先 zip）

- **完成报告/说明类 .md**（约 80+ 个）：如 `2025-01-20-工人接单页MVP开发完成报告.md`、`阶段2B-3-验证结果分析.md`、`订单主表同步问题修复报告.md` 等。  
  → **移至** `docs/archive/reports/`，**保留为原始文本**；在该目录添加 `README.md`，内容示例：`本目录为历史阶段性报告，不参与构建与运行。`  
  → 仅在确认极少再被查阅后，才考虑对 `docs/archive/reports/` 整体打 zip（非默认）。

- **零散 SQL（非 migrations）**：如 `check_and_create_rental_orders.sql`、`诊断Supabase连接问题.sql`、`快速验证策略.sql`、`fix_test_users.sql`、`debug_auth_issue.sql` 等。  
  → 已纳入 `migrations/` 的以 migrations 为准；其余**移至** `scripts/archive-sql/` 或 `sql/archive/`，**保留为原始文本**，并加 README 说明用途。

- **脚本/工具类**：`验证环境变量.js`、`清理构建缓存.ps1` 等。  
  → 若仍在使用可保留在 `scripts/`；否则移至 `scripts/archive/` 并加 README。

#### 3.3 含 test / debug 名称的文件（按判断公式 + 下表复核）

| 文件 | 建议 |
|------|------|
| `scripts/insert-equipment-rental-test-data.sql` | 测试数据脚本，可保留或移至 `scripts/test-data/` |
| `app/(admin)/dashboard/TEST_CHECKLIST.md` | 功能文档，**保留** |
| `fix_test_users.sql` | 根目录临时脚本，**A 类归档后删** |
| `scripts/test-repair-api.ts` | 测试脚本，可保留或 A 类归档 |
| `scripts/get-test-data.sql` | 同上 |
| `scripts/test-env-vars.js` | 同上 |
| `docs/quick-test-restaurant-setup.md` | 文档，**保留** |
| `docs/test-workflow-guide.md` | 文档，**保留** |
| `docs/test-data-setup.sql` | 可保留 |
| `TEST_QRCODE_UI.md` | 根目录，A 类归档至 `docs/archive/reports/` |
| `debug_auth_issue.sql` | 根目录调试用，**A 类归档后删** |
| `components/canvas-debug-overlay.tsx` | 功能组件，**保留** |
| `components/theme-debug.tsx` | 功能组件，**保留** |
| `lib/utils/debug-env.ts` | 工具代码，**保留** |
| `docs/theme-debug-guide.md` 等 | 文档，**保留** |

**原则**：删「临时实例」与「历史报告/一次性脚本」，不删「结构定义」与「仍在用的测试/调试能力」。

---

### ④ 日志、数据快照、Replay 结果

**当前扫描结果**：仓库内未发现 `*.log`、`*.trace.json`、`*.dump.json`、`/replay-output`、`/decision-samples-local`。

**若后续出现**：

- **可删**：`*.log`、`*.trace.json`、`*.dump.json`、`/replay-output`、`/decision-samples-local`（实例数据）。
- **不删**：与 audit / trace / decision 相关的**表结构、接口定义、Replay API 代码**（见下节）。

**未来约束（防复发）**：

- 若后续引入 Replay 本地输出或决策样本数据，应确保：
  - `replay-output/`、`decision-samples-local/` 被 **.gitignore** 覆盖；
  - 示例数据仅放在 `docs/examples/` 或 `scripts/sample-data/`，且体量可控。
- 避免平台学习/Replay 阶段再次把大量运行时产物提交进仓库。

---

## 三、绝对不能删（平台“脊椎”）

以下在瘦身时**仅做清单核对，不移动、不删除**。

| 类别 | 路径/说明 |
|------|------------|
| **平台工程文档** | `docs/platform-engineering/` 整个目录（含 CURRENT_CAPABILITIES、DISPATCH_TAKEOVER_PLAN、GOVERNANCE 等） |
| **决策/调度/学习/Replay** | `lib/platform/`（如 `decision/`、`orchestration/`、`impl/`、`dispatch-gateway.ts`、`models/decision-sample.ts` 等） |
| **审计与事实** | `lib/audit.ts`；数据库侧 `audit_logs`、`trace_logs` 表结构及迁移 |
| **事实层** | `lib/facts/`（contracts、adapters、governance 等） |
| **迁移与表结构** | `migrations/` 下所有 SQL（表结构、RLS 等） |
| **接口/类型定义** | 各处 `interfaces`、`schemas`、类型定义文件（与 decision/audit/trace 相关） |

**校验方式**：瘦身后执行搜索，确认上述路径仍存在且未被误删。

---

## 四、.gitignore 建议（完整拼图）

在现有基础上，建议确保包含（若尚未存在）：

```gitignore
# 构建与缓存
.turbo
.cache
*.tsbuildinfo
next-env.d.ts

# Platform runtime artifacts（防未来）
replay-output/
decision-samples-local/
```

现有已有：`/node_modules`、`/.next/`、`/out/`、`/build`、`.vercel`、`npm-debug.log*`、`yarn-debug.log*`、`.pnpm-debug.log*`、`.env*`。

---

## 五、推荐执行顺序（不自动执行，仅作清单）

顺序微调为：**先冻结（移动不删），再删大头**，心理与工程风险都更低。

| 步骤 | 动作 |
|------|------|
| 1. **打 tag / 备份** | 例如 `git tag pre-slim-YYYYMMDD` 或整库复制一份 |
| 2. **冻结（移动，不删）** | 根目录散落 .md/.sql 移至 `docs/archive/reports/`、`scripts/archive-sql/` 等，加 README；`.backup/` 先做引用检查，再决定移动或 zip |
| 3. **构建产物** | 本地删除 `.next`、`out`、`build`、`.vercel`、`.turbo`、`.cache`；若已误提交则 `git rm --cached` + 补 .gitignore |
| 4. **依赖** | 删除仓库内 `node_modules`（不操作 ~/.npm 等），执行 `npm ci`，确认安装通过 |
| 5. **日志 / 实例** | 若存在 `*.log`、`replay-output` 等，按第四节删除实例数据 |
| 6. **校验** | `npm run build` 通过；确认 `lib/platform`、`lib/audit.ts`、`lib/facts`、`migrations`、`docs/platform-engineering/` 存在且未被误改 |
| 7. **确认 archive 是否需 zip** | 若 `docs/archive/`、`scripts/archive/` 等内容确认极少再被查阅，再考虑对部分目录打 zip 以进一步减体积（非必须） |

---

## 六、预期效果（参考）

- **构建/缓存/依赖**：若 1.4G 主要来自 `node_modules` + `.next`，清理后仓库体积可大幅下降（仅保留源码与 lockfile）。
- **A 类冻结**：历史报告与零散 SQL 以文本形式进入 `archive/`，可 diff、可搜，后续平台演进仍可查阅；根目录更干净。
- **不删平台脊椎**：投放市场后仍可继续做 Dispatch / Learning / Replay 与审计相关演进。
- **防复发**：.gitignore 与「未来约束」可避免构建产物与 Replay 输出再次进入仓库。

---

**文档版本**：v2（按助理建议优化：冻结分 A/B 类、.backup 前提、防复发、权限边界、判断公式、执行顺序、.gitignore 拼图）  
**最后更新**：执行删除前请务必完成「冻结」步骤并校验通过。
