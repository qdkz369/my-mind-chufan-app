# 租赁领域（Rental Domain）

## 职责边界

租赁领域负责管理设备的所有权、租赁合同和计费关系，**不参与使用判断**。

### 核心职责

1. **设备所有权管理**
   - 记录设备的所有权归属和出资结构
   - 支持多主体共同拥有（平台、厂家、租赁公司、金融机构）

2. **租赁合同管理**
   - 管理租赁合同的基本信息（合同号、出租人、承租人、期限等）
   - 记录计费模式（固定费用、按使用量计费、混合模式）
   - 跟踪合同状态（草稿、生效中、已结束、违约）

3. **合同-设备关系**
   - 记录合同中包含的设备
   - 存储约定的计费参数（日租金、月租金、使用量计量单位）

### 职责边界声明

#### ✅ 租赁系统负责

- 设备所有权归属记录
- 租赁合同信息管理
- 计费参数存储（不计算，只存储约定值）
- 合同状态跟踪

#### ❌ 租赁系统不负责

- **不参与使用判断**：租赁系统不判断设备是否可用、是否在使用中
- **不参与业务决策**：不决定订单是否可创建、设备是否可分配
- **不计算费用**：只存储约定的计费参数，不进行实际费用计算
- **不管理订单流程**：不涉及订单创建、支付、完成等流程

### ⛔ 严格禁止事项（关键）

#### 1. 禁止反向影响 Facts

- **禁止**：在租赁逻辑中修改 Facts 表结构
- **禁止**：向 Facts API 返回结果中添加租赁相关字段
- **禁止**：在 Facts 表中添加租赁状态字段
- **原则**：租赁系统只能消费 Facts，不能污染 Facts

#### 2. 禁止判断设备可用性

- **禁止**：在租赁逻辑中判断设备是否"可用"
- **禁止**：基于租赁状态决定设备是否可分配
- **禁止**：基于租赁合同状态阻止订单创建
- **原则**：设备可用性判断必须通过 Facts API 获取，租赁系统不参与

#### 3. 禁止引入支付/结算/发票

- **禁止**：引入 `payment` 相关逻辑
- **禁止**：引入 `settlement`（结算）相关逻辑
- **禁止**：引入 `invoice`（发票）相关逻辑
- **原则**：租赁系统只存储合同和计费参数，不涉及实际支付流程

#### 4. 金额字段仅作记录

- **说明**：所有金额字段（如 `agreed_daily_fee`、`agreed_monthly_fee`）当前仅作记录
- **禁止**：对金额字段进行业务含义解释
- **禁止**：基于金额字段进行业务判断
- **禁止**：计算、汇总、统计金额
- **原则**：金额字段是合同约定的记录，不是业务逻辑的依据

### 数据消费原则

**租赁系统只消费 Facts，不产生业务状态判断。**

- 租赁系统可以读取 Facts API 返回的设备使用事实
- 租赁系统可以基于 Facts 进行合同履约分析
- 租赁系统**不能**基于自身数据判断设备是否可用

### 与其他领域的关系

#### 与 Facts 领域

- **消费关系**：租赁系统消费 Facts API 的数据
- **不污染 Facts**：租赁系统不修改 Facts 表结构，不向 Facts 添加字段

#### 与 Orders 领域

- **独立关系**：租赁系统不引用 Orders，不参与订单流程
- **数据隔离**：订单系统不依赖租赁系统进行使用判断

#### 与 Payment 领域

- **独立关系**：租赁系统不引用 Payment，不参与支付流程
- **计费参数提供**：租赁系统只提供约定的计费参数，不参与实际计费

### 设计原则

1. **只读消费 Facts**：租赁系统通过 Facts API 获取设备使用情况
2. **不产生业务状态**：租赁系统不判断设备是否可用、是否在使用
3. **数据存储为主**：主要职责是存储所有权、合同、计费参数
4. **类型安全**：通过 TypeScript 类型定义确保数据结构一致性

### Usage Snapshot（使用量快照）阶段

Usage Snapshot 是"计费前冻结事实"，用于冻结设备在某一时间窗口内的"可计费使用事实"。

#### ⛔ Usage Snapshot 阶段明确禁止事项（非常重要）

**1. 禁止生成账单**
- **禁止**：基于 Usage Snapshot 生成账单（bill/invoice）
- **禁止**：创建任何账单记录
- **禁止**：触发账单生成流程
- **原则**：Usage Snapshot 只是冻结事实，不是账单

**2. 禁止生成应收应付**
- **禁止**：基于 Usage Snapshot 生成应收（accounts receivable）
- **禁止**：基于 Usage Snapshot 生成应付（accounts payable）
- **禁止**：创建任何财务凭证
- **原则**：Usage Snapshot 不涉及财务核算

**3. 禁止计算金额**
- **禁止**：基于 `usage_value` 计算任何金额
- **禁止**：将 `usage_value` 乘以单价得到费用
- **禁止**：汇总、统计、计算任何金额字段
- **原则**：`usage_value` 只是"量"（使用量），不是"钱"（金额）

**4. 禁止对订单状态产生任何反向影响**
- **禁止**：基于 Usage Snapshot 修改订单状态
- **禁止**：基于 Usage Snapshot 阻止订单创建
- **禁止**：基于 Usage Snapshot 触发订单流程变更
- **禁止**：基于 Usage Snapshot 发送订单相关通知
- **原则**：Usage Snapshot 只消费订单事实，不反向影响订单

**5. 禁止在 Snapshot 中修改或纠正 Facts**
- **禁止**：在生成 Snapshot 时修改 Facts 数据
- **禁止**：在 Snapshot 中纠正或调整 Facts 值
- **禁止**：基于 Snapshot 反向更新 Facts 表
- **原则**：Usage Snapshot 是 Facts 的只读快照，不能修改原始 Facts

#### Usage Snapshot 的职责边界

**✅ Usage Snapshot 负责**
- 冻结设备在时间窗口内的使用事实（只读）
- 记录使用量数值（`usage_value`，这是"量"不是"钱"）
- 记录事实来源（`fact_source`）
- 记录事实时间（`generated_from_fact_at`）
- 状态管理（draft/confirmed/disputed/locked）

**❌ Usage Snapshot 不负责**
- 不生成账单
- 不生成应收应付
- 不计算金额
- 不影响订单状态
- 不修改 Facts

### 未来扩展方向

- 合同履约分析（基于 Facts 数据）
- 计费参数管理（不涉及实际计算）
- 所有权变更历史（只记录，不判断）

---

**重要提醒**：租赁系统是数据存储和合同管理领域，不是业务决策领域。所有使用判断必须通过 Facts API 获取。

**Usage Snapshot 重要提醒**：Usage Snapshot 是"计费前冻结事实"，不是账单，不是应收应付，不计算金额，不影响订单，不修改 Facts。
