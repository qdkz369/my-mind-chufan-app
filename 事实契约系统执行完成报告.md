# 事实契约系统执行完成报告

## 执行时间：2025-01-20

---

## 1. order.fact.ts 内容

**文件路径：** `lib/facts/contracts/order.fact.ts`

**完整内容：**

```typescript
/**
 * 订单事实契约（Order Fact Contract）
 * 
 * 核心原则：
 * - 明确每一个字段的唯一数据来源
 * - 禁止任何"推断""默认""兜底时间"
 * - 空值必须明确表达"事实不存在"或"尚未发生"
 * - 任何 UI 不得自行生成或推断时间
 * 
 * 数据来源约束：
 * - accepted_at / completed_at 只能来自 audit_logs
 * - trace_logs 只能作为事实补充，不得反推订单状态
 */

export type OrderFactContract = {
  /**
   * 订单唯一标识
   * 数据来源：delivery_orders.id
   * 是否允许为空：否
   */
  order_id: string

  /**
   * 餐厅ID（订单归属）
   * 数据来源：delivery_orders.restaurant_id
   * 是否允许为空：否
   */
  restaurant_id: string

  /**
   * 订单状态
   * 数据来源：delivery_orders.status
   * 是否允许为空：否
   */
  status: string

  /**
   * 订单创建时间
   * 数据来源：delivery_orders.created_at
   * 是否允许为空：否
   */
  created_at: string

  /**
   * 订单被接单时间
   * 数据来源：audit_logs.created_at（当 action = ORDER_ACCEPTED 或 ORDER_ACCEPT）
   * 是否允许为空：是
   * 空值含义：事实不存在（audit_logs 中无 ORDER_ACCEPTED 记录）
   * 约束：只能来自 audit_logs 表，严禁推断
   */
  accepted_at: string | null

  /**
   * 订单完成时间
   * 数据来源：audit_logs.created_at（当 action = ORDER_COMPLETED 或 ORDER_COMPLETE）
   * 是否允许为空：是
   * 空值含义：事实不存在（audit_logs 中无 ORDER_COMPLETED 记录）
   * 约束：只能来自 audit_logs 表，严禁推断
   */
  completed_at: string | null

  /**
   * 配送员ID
   * 数据来源：delivery_orders.worker_id
   * 是否允许为空：是
   * 空值含义：事实不存在（订单尚未分配配送员）
   */
  worker_id: string | null
}

export type TraceFactContract = {
  id: string  // trace_logs.id
  asset_id: string  // trace_logs.asset_id
  action_type: '出厂' | '充装' | '配送' | '回收' | '安检'  // trace_logs.action_type
  operator_id: string  // trace_logs.operator_id
  order_id: string | null  // trace_logs.order_id
  created_at: string  // trace_logs.created_at
}

export type AssetFactContract = {
  asset_id: string  // gas_cylinders.id 或 devices.device_id
  status: string  // gas_cylinders.status 或 devices.status
  last_action: string  // trace_logs.action_type（最后一次操作）
  last_action_at: string  // trace_logs.created_at 或 gas_cylinders.updated_at
}

export function validateOrderFactContract(fact: OrderFactContract): {
  valid: boolean
  errors: string[]
}
```

**关键约束：**
- `accepted_at` 和 `completed_at` 使用 `string | null`，不使用 `undefined`
- `null` 明确表示"事实不存在"（audit_logs 中无记录）
- 所有字段都明确标注数据来源表

---

## 2. 修改后的组件 Props 类型

### OrderTimeline 组件

**文件路径：** `components/facts/OrderTimeline.tsx`

**修改位置：** 第 24-32 行

**修改后：**
```typescript
import { OrderFactContract, TraceFactContract } from "@/lib/facts/contracts/order.fact"

interface OrderTimelineProps {
  order: OrderFactContract  // 使用事实契约类型
  traces: TraceFactContract[]  // 使用事实契约类型
  className?: string
}
```

**关键修改：**
- 第 119 行：`if (order.accepted_at !== null && order.accepted_at !== undefined)` - 使用 null 检查
- 第 135 行：`if (order.completed_at !== null && order.completed_at !== undefined)` - 使用 null 检查

---

### AssetFactCard 组件

**文件路径：** `components/facts/AssetFactCard.tsx`

**修改位置：** 第 21-30 行

**修改后：**
```typescript
import { AssetFactContract } from "@/lib/facts/contracts/order.fact"

interface AssetFactCardProps {
  asset: AssetFactContract  // 使用事实契约类型
  className?: string
  onClick?: () => void
}
```

---

## 3. 如何防止未来 UI 绕过事实系统

### 机制 1：TypeScript 类型约束

**实现方式：**
- 所有事实组件 Props 必须使用 `OrderFactContract`、`TraceFactContract`、`AssetFactContract` 类型
- 如果试图使用未在契约中声明的字段，TypeScript 会报错

**约束位置：**
- `components/facts/OrderTimeline.tsx` 第 24-32 行
- `components/facts/AssetFactCard.tsx` 第 21-30 行

**效果：**
- 如果试图传递不符合契约的数据，TypeScript 编译时会报错
- 组件只能访问契约中声明的字段

---

### 机制 2：空值语义明确化

**实现方式：**
- `OrderFactContract` 使用 `string | null` 类型，不使用 `undefined`
- `null` 明确表示"事实不存在"，不是"未定义"

**约束位置：** `lib/facts/contracts/order.fact.ts` 第 76 行、第 91 行

**效果：**
- 如果 `accepted_at` 为 `null`，表示 `audit_logs` 中无 ORDER_ACCEPTED 记录
- UI 组件必须处理 `null` 值，不能假设字段存在

---

### 机制 3：API 层强制使用契约类型

**实现方式：**
- API 返回类型必须使用 `OrderFactContract`、`TraceFactContract`、`AssetFactContract`
- API 层负责将数据库字段映射到契约类型

**约束位置：**
- `app/api/facts/orders/[order_id]/route.ts` 第 179-187 行
- `app/api/facts/restaurant/[restaurant_id]/assets/route.ts` 第 97-110 行

**效果：**
- 如果 API 返回不符合契约的数据，TypeScript 会报错
- 确保 API 层不会返回推断或默认值

---

### 机制 4：组件 Props 类型约束

**实现方式：**
- 所有事实组件 Props 必须使用契约类型
- 组件内部不能直接访问数据库字段结构

**约束位置：**
- `components/facts/OrderTimeline.tsx` 第 24-32 行
- `components/facts/AssetFactCard.tsx` 第 21-30 行

**效果：**
- 如果试图传递不符合契约的数据，TypeScript 会报错
- 组件只能访问契约中声明的字段

---

### 机制 5：验证函数

**实现方式：**
- `validateOrderFactContract` 函数验证契约是否符合约束
- 可以在运行时验证数据完整性

**约束位置：** `lib/facts/contracts/order.fact.ts` 第 224-261 行

**使用示例：**
```typescript
const validation = validateOrderFactContract(orderFact)
if (!validation.valid) {
  console.error("订单事实不符合契约:", validation.errors)
}
```

---

## 总结

### ✅ 已完成的工作

1. ✅ 创建事实契约文件：`lib/facts/contracts/order.fact.ts`
2. ✅ 定义 `OrderFactContract`、`TraceFactContract`、`AssetFactContract` 类型
3. ✅ 明确每个字段的数据来源、是否允许为空、空值含义
4. ✅ 修改 `OrderTimeline` 和 `AssetFactCard` 组件 Props 类型
5. ✅ 修改 API 层使用契约类型
6. ✅ 实现验证函数 `validateOrderFactContract`

### ✅ 防止绕过事实系统的机制

1. **TypeScript 类型约束**：组件 Props 必须使用契约类型
2. **空值语义明确化**：使用 `null` 表示"事实不存在"
3. **API 层强制映射**：API 层负责将数据库字段映射到契约类型
4. **组件 Props 约束**：组件不能直接依赖数据库字段结构
5. **验证函数**：提供运行时验证函数

---

**执行完成时间：** 2025-01-20
