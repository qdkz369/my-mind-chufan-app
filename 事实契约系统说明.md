# 事实契约系统（Fact Contract System）说明

## 概述

事实契约系统（Fact Contract System）是一个类型安全的事实来源约束层，确保所有 UI 组件只能使用明确定义的事实数据，防止绕过事实系统。

---

## 核心文件

### 1. 事实契约定义文件

**文件路径：** `lib/facts/contracts/order.fact.ts`

**用途：** 明确定义所有订单相关事实的唯一数据来源

**包含类型：**
- `OrderFactContract` - 订单事实契约
- `TraceFactContract` - 溯源事实契约
- `AssetFactContract` - 资产事实契约
- `validateOrderFactContract` - 验证函数

---

## 关键约束

### 1. accepted_at / completed_at 只能来自 audit_logs

**约束位置：** `lib/facts/contracts/order.fact.ts` 第 60-85 行

**约束内容：**
```typescript
/**
 * 订单被接单时间
 * 
 * 数据来源：audit_logs.created_at（当 action = ORDER_ACCEPTED 或 ORDER_ACCEPT）
 * 是否允许为空：是
 * 空值含义：事实不存在（audit_logs 中无 ORDER_ACCEPTED 记录）
 * 
 * 约束：
 * - 只能来自 audit_logs 表
 * - 严禁从 delivery_orders.status 推断
 * - 严禁使用 delivery_orders.updated_at 作为兜底
 * - 严禁 UI 自行生成或推断时间
 */
accepted_at: string | null
```

**实现位置：** `app/api/facts/orders/[order_id]/route.ts` 第 126-129 行

---

### 2. 任何 UI 不得自行生成或推断时间

**约束方式：** TypeScript 类型系统

**实现：**
- `OrderFactContract` 使用 `string | null` 类型，不允许 `undefined`
- 组件 Props 必须使用 `OrderFactContract` 类型
- 如果试图使用未声明的字段，TypeScript 会报错

**组件约束：**
- `OrderTimeline` 组件：`components/facts/OrderTimeline.tsx` 第 24-28 行
- `AssetFactCard` 组件：`components/facts/AssetFactCard.tsx` 第 21-26 行

---

### 3. trace_logs 只能作为事实补充，不得反推订单状态

**约束位置：** `lib/facts/contracts/order.fact.ts` 第 88-120 行

**约束内容：**
```typescript
/**
 * 溯源事实契约
 * 
 * 数据来源：trace_logs 表
 * 
 * 约束：
 * - trace_logs 只能作为事实补充，不得反推订单状态
 * - 不得从 trace_logs 推断 accepted_at 或 completed_at
 */
export type TraceFactContract = { ... }
```

---

## 修改后的组件 Props 类型

### OrderTimeline 组件

**文件路径：** `components/facts/OrderTimeline.tsx`

**修改前：**
```typescript
interface OrderTimelineProps {
  order: OrderFact
  traces: TraceFact[]
  className?: string
}
```

**修改后：**
```typescript
interface OrderTimelineProps {
  order: OrderFactContract  // 使用事实契约类型
  traces: TraceFactContract[]  // 使用事实契约类型
  className?: string
}
```

**修改位置：** 第 24-28 行

---

### AssetFactCard 组件

**文件路径：** `components/facts/AssetFactCard.tsx`

**修改前：**
```typescript
interface AssetFactCardProps {
  asset: AssetFact
  className?: string
  onClick?: () => void
}
```

**修改后：**
```typescript
interface AssetFactCardProps {
  asset: AssetFactContract  // 使用事实契约类型
  className?: string
  onClick?: () => void
}
```

**修改位置：** 第 21-26 行

---

## 如何防止未来 UI 绕过事实系统

### 1. TypeScript 类型约束

**机制：**
- 所有事实组件必须使用 `OrderFactContract`、`TraceFactContract`、`AssetFactContract` 类型
- 如果试图使用未在契约中声明的字段，TypeScript 会报错

**示例：**
```typescript
// ❌ 错误：试图使用未声明的字段
const order: OrderFactContract = {
  order_id: "...",
  // inferred_accepted_at: "..."  // TypeScript 报错：属性不存在
}

// ✅ 正确：使用契约中声明的字段
const order: OrderFactContract = {
  order_id: "...",
  accepted_at: null,  // 使用 null 表示事实不存在
}
```

---

### 2. 空值语义明确化

**机制：**
- `OrderFactContract` 使用 `string | null` 类型，不使用 `undefined`
- `null` 明确表示"事实不存在"，不是"未定义"

**实现位置：** `lib/facts/contracts/order.fact.ts` 第 60-85 行

**效果：**
- 如果 `accepted_at` 为 `null`，表示 `audit_logs` 中无 ORDER_ACCEPTED 记录
- UI 组件必须处理 `null` 值，不能假设字段存在

---

### 3. API 层强制使用契约类型

**机制：**
- API 返回类型必须使用 `OrderFactContract`、`TraceFactContract`、`AssetFactContract`
- API 层负责将数据库字段映射到契约类型

**实现位置：**
- `app/api/facts/orders/[order_id]/route.ts` 第 179-187 行
- `app/api/facts/restaurant/[restaurant_id]/assets/route.ts` 第 97-110 行

**效果：**
- 如果 API 返回不符合契约的数据，TypeScript 会报错
- 确保 API 层不会返回推断或默认值

---

### 4. 组件 Props 类型约束

**机制：**
- 所有事实组件 Props 必须使用契约类型
- 组件内部不能直接访问数据库字段结构

**实现位置：**
- `components/facts/OrderTimeline.tsx` 第 24-28 行
- `components/facts/AssetFactCard.tsx` 第 21-26 行

**效果：**
- 如果试图传递不符合契约的数据，TypeScript 会报错
- 组件只能访问契约中声明的字段

---

### 5. 验证函数

**机制：**
- `validateOrderFactContract` 函数验证契约是否符合约束
- 可以在运行时验证数据完整性

**实现位置：** `lib/facts/contracts/order.fact.ts` 第 122-155 行

**使用示例：**
```typescript
const validation = validateOrderFactContract(orderFact)
if (!validation.valid) {
  console.error("订单事实不符合契约:", validation.errors)
}
```

---

## 验证缺失场景

### audit_logs 缺失场景

**契约处理：**
- `accepted_at: string | null` - 如果 `audit_logs` 中无记录，为 `null`
- `completed_at: string | null` - 如果 `audit_logs` 中无记录，为 `null`

**实现位置：** `app/api/facts/orders/[order_id]/route.ts` 第 185-186 行

**效果：**
- API 返回 `null`，明确表示"事实不存在"
- UI 组件必须处理 `null` 值，不能推断

---

### trace_logs 缺失场景

**契约处理：**
- `TraceFactContract[]` - 如果无记录，返回空数组 `[]`
- `AssetFactContract.last_action: string` - 如果无记录，为空字符串 `""`

**实现位置：**
- `app/api/facts/orders/[order_id]/route.ts` 第 201 行、第 259 行
- `app/api/facts/restaurant/[restaurant_id]/assets/route.ts` 第 100 行

**效果：**
- API 返回空数组或空字符串，明确表示"事实不存在"
- UI 组件必须处理空值，不能推断

---

## 防止绕过事实系统的机制总结

1. **类型系统约束**：TypeScript 类型检查确保只能使用契约中声明的字段
2. **空值语义明确**：使用 `null` 明确表示"事实不存在"，不使用 `undefined`
3. **API 层强制映射**：API 层负责将数据库字段映射到契约类型，不允许直接返回数据库结构
4. **组件 Props 约束**：组件 Props 必须使用契约类型，不能直接依赖数据库字段结构
5. **验证函数**：提供运行时验证函数，确保数据符合契约约束

---

**创建时间：** 2025-01-20
