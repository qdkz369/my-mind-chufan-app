# 事实治理输出标准化示例

## 概述

本文档展示了升级后的 Fact Governance Layer 返回的结构化警告格式。

## API 响应结构

### 端点
`GET /api/facts/orders/:order_id`

### 完整示例响应（包含 2 个不同 level 的警告）

```json
{
  "success": true,
  "order": {
    "order_id": "order-123",
    "restaurant_id": "restaurant-456",
    "status": "completed",
    "created_at": "2025-01-20T10:00:00Z",
    "accepted_at": "2025-01-20T10:05:00Z",
    "completed_at": "2025-01-20T09:30:00Z",
    "worker_id": "worker-789"
  },
  "assets": [
    {
      "asset_id": "asset-001",
      "status": "delivered",
      "last_action": "ASSET_DELIVERED",
      "last_action_at": "2025-01-20T11:00:00Z"
    }
  ],
  "traces": [
    {
      "id": "trace-001",
      "asset_id": "asset-001",
      "action_type": "ASSET_DELIVERED",
      "operator_id": "operator-001",
      "order_id": "order-123",
      "created_at": "2025-01-20T09:45:00Z"
    },
    {
      "id": "trace-002",
      "asset_id": "asset-001",
      "action_type": "UNKNOWN_ACTION",
      "operator_id": "operator-002",
      "order_id": "order-123",
      "created_at": "2025-01-20T10:30:00Z"
    }
  ],
  "fact_warnings": [
    "违反事实契约：order.completed_at（2025-01-20T09:30:00Z）早于 order.created_at（2025-01-20T10:00:00Z）。时间逻辑异常。",
    "违反事实契约：traces[1].action_type（UNKNOWN_ACTION）不在允许的枚举值内。允许的值：ASSET_CREATED, ASSET_FILLED, ASSET_DELIVERED, ASSET_RETURNED, ASSET_INSPECTED。",
    "违反事实契约：traces[0].created_at（2025-01-20T09:45:00Z）早于 order.created_at（2025-01-20T10:00:00Z），但该追溯记录关联了当前订单（order_id=order-123）。时间线断裂。"
  ],
  "fact_warnings_human": [
    "违反事实契约：order.completed_at（2025-01-20T09:30:00Z）早于 order.created_at（2025-01-20T10:00:00Z）。时间逻辑异常。",
    "违反事实契约：traces[1].action_type（UNKNOWN_ACTION）不在允许的枚举值内。允许的值：ASSET_CREATED, ASSET_FILLED, ASSET_DELIVERED, ASSET_RETURNED, ASSET_INSPECTED。",
    "违反事实契约：traces[0].created_at（2025-01-20T09:45:00Z）早于 order.created_at（2025-01-20T10:00:00Z），但该追溯记录关联了当前订单（order_id=order-123）。时间线断裂。"
  ],
  "fact_warnings_structured": [
    {
      "code": "FACT_TIME_INVERSION",
      "level": "high",
      "domain": "order",
      "message": "违反事实契约：order.completed_at（2025-01-20T09:30:00Z）早于 order.created_at（2025-01-20T10:00:00Z）。时间逻辑异常。",
      "fields": [
        "order.completed_at",
        "order.created_at"
      ],
      "evidence": {
        "order_id": "order-123",
        "created_at": "2025-01-20T10:00:00Z",
        "completed_at": "2025-01-20T09:30:00Z",
        "time_diff_ms": -1800000
      }
    },
    {
      "code": "FACT_ENUM_VALUE_INVALID",
      "level": "medium",
      "domain": "trace",
      "message": "违反事实契约：traces[1].action_type（UNKNOWN_ACTION）不在允许的枚举值内。允许的值：ASSET_CREATED, ASSET_FILLED, ASSET_DELIVERED, ASSET_RETURNED, ASSET_INSPECTED。",
      "fields": [
        "traces[1].action_type"
      ],
      "evidence": {
        "trace_id": "trace-002",
        "trace_index": 1,
        "invalid_action_type": "UNKNOWN_ACTION",
        "allowed_action_types": [
          "ASSET_CREATED",
          "ASSET_FILLED",
          "ASSET_DELIVERED",
          "ASSET_RETURNED",
          "ASSET_INSPECTED"
        ]
      }
    },
    {
      "code": "FACT_TIMELINE_BREAK",
      "level": "high",
      "domain": "trace",
      "message": "违反事实契约：traces[0].created_at（2025-01-20T09:45:00Z）早于 order.created_at（2025-01-20T10:00:00Z），但该追溯记录关联了当前订单（order_id=order-123）。时间线断裂。",
      "fields": [
        "traces[0].created_at",
        "order.created_at",
        "traces[0].order_id"
      ],
      "evidence": {
        "trace_id": "trace-001",
        "trace_index": 0,
        "trace_created_at": "2025-01-20T09:45:00Z",
        "trace_order_id": "order-123",
        "order_id": "order-123",
        "order_created_at": "2025-01-20T10:00:00Z",
        "time_diff_ms": -900000
      }
    }
  ]
}
```

## 警告代码说明

### FACT_TIME_INVERSION
- **级别**: `high`
- **领域**: `order`
- **描述**: 订单的完成时间早于创建时间，违反了时间逻辑
- **用途**: 需要立即修复的严重问题

### FACT_ENUM_VALUE_INVALID
- **级别**: `medium`
- **领域**: `trace`
- **描述**: 追溯记录的操作类型不在允许的枚举值内
- **用途**: 数据质量问题，需要修复但不会导致功能异常

### FACT_TIMELINE_BREAK
- **级别**: `high`
- **领域**: `trace`
- **描述**: 追溯记录的创建时间早于订单创建时间，但追溯记录关联了该订单
- **用途**: 时间线断裂，需要立即修复

### FACT_TIMELINE_ANOMALY
- **级别**: `low`
- **领域**: `trace`
- **描述**: 追溯记录的创建时间早于订单创建时间，但追溯记录未关联该订单（可能是订单创建前的资产操作，这是合理的）
- **用途**: 低优先级警告，可能需要人工审核

### FACT_ACCEPTED_AT_MISSING_AUDIT_LOG
- **级别**: `medium`
- **领域**: `audit`
- **描述**: 订单有 accepted_at 值，但 audit_logs 中没有对应的 ORDER_ACCEPTED 或 ORDER_ACCEPT 记录
- **用途**: 数据不一致问题，需要修复

## 使用场景

### 1. 管理端治理列表
```typescript
// 按级别分组显示警告
const warningsByLevel = warnings.reduce((acc, warning) => {
  if (!acc[warning.level]) acc[warning.level] = []
  acc[warning.level].push(warning)
  return acc
}, {} as Record<FactWarningLevel, FactWarning[]>)

// 显示高优先级警告
warningsByLevel.high?.forEach(warning => {
  console.log(`[${warning.code}] ${warning.message}`)
})
```

### 2. 自动修复任务
```typescript
// 根据警告代码自动修复
switch (warning.code) {
  case 'FACT_TIME_INVERSION':
    // 修复时间逻辑：交换 created_at 和 completed_at
    await fixTimeInversion(warning.evidence)
    break
  case 'FACT_ENUM_VALUE_INVALID':
    // 修复枚举值：将无效值映射到默认值
    await fixEnumValue(warning.evidence)
    break
}
```

### 3. 事实健康度可视化
```typescript
// 计算健康度分数
const healthScore = calculateHealthScore(
  warnings.filter(w => w.level === 'high').length,
  warnings.filter(w => w.level === 'medium').length,
  warnings.filter(w => w.level === 'low').length
)

// 生成健康度报告
const healthReport = {
  score: healthScore,
  highPriorityIssues: warnings.filter(w => w.level === 'high').length,
  mediumPriorityIssues: warnings.filter(w => w.level === 'medium').length,
  lowPriorityIssues: warnings.filter(w => w.level === 'low').length,
}
```

## 向后兼容性

为了保持向后兼容，API 同时返回：
- `fact_warnings`: 原有的字符串数组格式（向后兼容）
- `fact_warnings_human`: 人类可读格式（与 `fact_warnings` 相同）
- `fact_warnings_structured`: 结构化格式（新增）

```typescript
// 旧代码仍然可以工作
if (response.fact_warnings_human) {
  response.fact_warnings_human.forEach(warning => {
    console.log(warning)
  })
}

// 新代码可以使用结构化格式
if (response.fact_warnings_structured) {
  response.fact_warnings_structured.forEach(warning => {
    console.log(`[${warning.level}] ${warning.code}: ${warning.message}`)
  })
}
```

## 完成状态

✅ 已定义 `FactWarning` 类型  
✅ 已修改 `OrderFactGuard` 函数以生成结构化警告  
✅ 已修改 `OrderFactGovernanceResult` 类型  
✅ 已修改 API 路由以同时返回两种格式  
✅ 已创建完整的示例响应 JSON

**所有任务已完成！**
