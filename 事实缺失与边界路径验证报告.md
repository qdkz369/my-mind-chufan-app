# 事实缺失与边界路径验证报告

## 验证时间：2025-01-20

---

## 一、audit_logs 缺失场景

### 场景描述
当某个 `delivery_order` 只有 `created`，但没有任何 `audit_logs` 记录时

---

### 1.1 API 返回结构是否仍然完整？

**检查位置：** `app/api/facts/orders/[order_id]/route.ts`

**代码路径：**
- 第 97-102 行：查询 `audit_logs` 表
- 第 114-166 行：处理 `audit_logs` 查询结果
- 第 179-187 行：构建 `OrderFact` 对象
- 第 299-304 行：返回 API 响应

**当前行为分析：**

**第 114 行：** `if (!auditLogsError && auditLogsData)`
- 如果 `auditLogsData` 为空数组 `[]`，条件为 `true`（空数组是 truthy）
- 如果 `auditLogsData` 为 `null`，条件为 `false`

**第 162-166 行：** `else` 分支
```typescript
else {
  // audit_logs 为空或不存在
  acceptedAtReason = "audit_logs 无记录"
  completedAtReason = "audit_logs 无记录"
}
```
- 当 `auditLogsData` 为 `null` 或查询失败时，进入此分支
- `acceptedAt` 和 `completedAt` 保持为 `undefined`

**第 185-186 行：** 构建 `OrderFact`
```typescript
accepted_at: acceptedAt || undefined, // 如果不存在则为 undefined
completed_at: completedAt || undefined, // 如果不存在则为 undefined
```

**第 299-304 行：** 返回响应
```typescript
return NextResponse.json({
  success: true,
  order: orderFact,
  assets: assets,
  traces: traces,
})
```

**结论：** ✅ **安全**
- **文件路径：** `app/api/facts/orders/[order_id]/route.ts`
- **行号：** 第 179-187 行、第 299-304 行
- **当前行为：** API 返回结构完整，`accepted_at` 和 `completed_at` 为 `undefined`，不会导致 API 崩溃

---

### 1.2 是否存在 accepted_at / completed_at 被推断、默认或写死的情况？

**检查位置：** `app/api/facts/orders/[order_id]/route.ts`

**代码路径：**
- 第 92-93 行：初始化 `acceptedAt` 和 `completedAt` 为 `undefined`
- 第 114-134 行：从 `audit_logs` 中提取时间戳
- 第 185-186 行：赋值给 `OrderFact`

**当前行为分析：**

**第 92-93 行：**
```typescript
let acceptedAt: string | undefined
let completedAt: string | undefined
```
- 初始值为 `undefined`，不是推断值

**第 126-129 行：**
```typescript
if (actionUpper === "ORDER_ACCEPTED" || actionUpper === "ORDER_ACCEPT") {
  acceptedAt = log.created_at
} else if (actionUpper === "ORDER_COMPLETED" || actionUpper === "ORDER_COMPLETE") {
  completedAt = log.created_at
}
```
- 只有当 `audit_logs` 中存在对应 action 时，才赋值
- 如果不存在，保持 `undefined`

**第 185-186 行：**
```typescript
accepted_at: acceptedAt || undefined, // 从 audit_logs 获取，如果不存在则为 undefined
completed_at: completedAt || undefined, // 从 audit_logs 获取，如果不存在则为 undefined
```
- 使用 `|| undefined`，如果 `acceptedAt` 为 `undefined`，结果仍为 `undefined`
- 没有推断、默认值或写死的情况

**结论：** ✅ **安全**
- **文件路径：** `app/api/facts/orders/[order_id]/route.ts`
- **行号：** 第 92-93 行、第 126-129 行、第 185-186 行
- **当前行为：** `accepted_at` 和 `completed_at` 不会被推断、默认或写死，如果 `audit_logs` 中不存在，则为 `undefined`

---

## 二、trace_logs 缺失场景

### 场景描述
当订单或资产不存在任何 `trace_logs` 时

---

### 2.1 API 返回的是 []、null 还是报错？

**检查位置：** `app/api/facts/orders/[order_id]/route.ts`

**代码路径：**
- 第 190-194 行：查询订单关联的 `trace_logs`
- 第 196-199 行：错误处理
- 第 201 行：处理查询结果
- 第 204-211 行：映射到 `TraceFact[]`
- 第 234-240 行：查询资产最后一次操作
- 第 242-261 行：处理无溯源记录的情况

**当前行为分析：**

**第 190-194 行：** 查询订单关联的 `trace_logs`
```typescript
const { data: tracesData, error: tracesError } = await supabase
  .from("trace_logs")
  .select("id, asset_id, operator_id, action_type, order_id, created_at")
  .eq("order_id", order_id)
  .order("created_at", { ascending: true })
```

**第 196-199 行：** 错误处理
```typescript
if (tracesError) {
  console.error("[订单事实API] 查询溯源记录失败:", tracesError)
  // 查询失败时返回空数组，不阻断流程
}
```

**第 201 行：** 处理查询结果
```typescript
const tracesList = tracesData || []
```
- 如果 `tracesData` 为 `null`，使用空数组 `[]`
- 如果 `tracesData` 为空数组 `[]`，使用空数组 `[]`

**第 204-211 行：** 映射到 `TraceFact[]`
```typescript
const traces: TraceFact[] = tracesList.map((trace) => ({...}))
```
- 如果 `tracesList` 为空数组，`traces` 也为空数组 `[]`

**第 302 行：** 返回响应
```typescript
traces: traces,
```
- 返回空数组 `[]`，不是 `null`，不会报错

**结论：** ✅ **安全**
- **文件路径：** `app/api/facts/orders/[order_id]/route.ts`
- **行号：** 第 201 行、第 204-211 行、第 302 行
- **当前行为：** API 返回空数组 `[]`，不会返回 `null`，不会报错

---

### 2.2 前端组件是否存在直接访问空值导致渲染错误的风险？

#### OrderTimeline 组件

**检查位置：** `components/facts/OrderTimeline.tsx`

**代码路径：**
- 第 159-171 行：遍历 `traces` 数组
- 第 230-226 行：渲染时间线节点

**当前行为分析：**

**第 159 行：** `traces.forEach((trace, index) => {...})`
- 如果 `traces` 为空数组 `[]`，`forEach` 不会执行，不会报错

**第 163 行：** `label: trace.action_type`
- 在 `forEach` 内部，`trace` 对象存在时才访问
- 如果 `traces` 为空数组，不会执行到此行

**第 230 行：** `{timelineNodes.map((node, index) => {...})}`
- `timelineNodes` 至少包含订单创建节点（第 114 行）
- 即使 `traces` 为空，`timelineNodes` 也不会为空数组

**结论：** ✅ **安全**
- **文件路径：** `components/facts/OrderTimeline.tsx`
- **行号：** 第 159-171 行、第 230 行
- **当前行为：** 即使 `traces` 为空数组，组件不会崩溃，至少显示订单创建节点

---

#### AssetFactCard 组件

**检查位置：** `components/facts/AssetFactCard.tsx`

**代码路径：**
- 第 82 行：检查 `last_action` 是否存在
- 第 130-147 行：条件渲染最近一次行为

**当前行为分析：**

**第 82 行：** `const hasLastAction = asset.last_action && asset.last_action !== ""`
- 检查 `last_action` 是否存在且不为空字符串
- 如果 `last_action` 为空字符串（无溯源记录），`hasLastAction` 为 `false`

**第 130-147 行：** 条件渲染
```typescript
{hasLastAction ? (
  // 显示最近一次行为
) : (
  // 显示"暂无行为记录"
)}
```
- 如果 `hasLastAction` 为 `false`，显示"暂无行为记录"，不会访问空值

**第 153 行：** `更新时间：{formatTime(asset.last_action_at)}`
- `formatTime` 函数（第 40-67 行）处理空字符串和无效时间戳
- 第 41-43 行：如果 `timestamp` 为空字符串，返回 "未知"

**结论：** ✅ **安全**
- **文件路径：** `components/facts/AssetFactCard.tsx`
- **行号：** 第 82 行、第 130-147 行、第 153 行
- **当前行为：** 即使 `last_action` 为空字符串，组件不会崩溃，会显示"暂无行为记录"

---

#### API 中资产最后一次操作查询

**检查位置：** `app/api/facts/orders/[order_id]/route.ts`

**代码路径：**
- 第 234-240 行：查询资产最后一次操作
- 第 242-261 行：处理无溯源记录的情况

**当前行为分析：**

**第 234-240 行：** 查询 `trace_logs`
```typescript
const { data: lastTrace, error: lastTraceError } = await supabase
  .from("trace_logs")
  .select("action_type, created_at")
  .eq("asset_id", asset.id)
  .order("created_at", { ascending: false })
  .limit(1)
  .maybeSingle()
```

**第 242 行：** `if (lastTraceError || !lastTrace)`
- 如果查询失败或没有记录，`lastTrace` 为 `null`
- 进入处理无溯源记录的分支

**第 256-261 行：** 返回默认值
```typescript
return {
  asset_id: asset.id,
  status: asset.status,
  last_action: "", // 没有溯源记录时，last_action 为空字符串（事实）
  last_action_at: fallbackTime || "", // 使用 updated_at 或 created_at（事实），如果都没有则使用空字符串（不推断）
}
```
- `last_action` 为空字符串（不是 `null`）
- `last_action_at` 使用 `fallbackTime` 或空字符串（不是 `null`）

**结论：** ✅ **安全**
- **文件路径：** `app/api/facts/orders/[order_id]/route.ts`
- **行号：** 第 242-261 行
- **当前行为：** 如果资产没有 `trace_logs` 记录，返回空字符串，不会返回 `null`，不会导致前端崩溃

---

## 三、时间线断裂场景

### 场景描述
检查是否存在以下非法但可能出现的事实顺序：
1. `completed` 出现，但从未出现 `accepted`
2. `trace_logs.created_at` 早于 `delivery_orders.created_at`

---

### 3.1 completed 出现，但从未出现 accepted

**检查位置：** `components/facts/OrderTimeline.tsx`

**代码路径：**
- 第 118-131 行：添加订单已接单节点
- 第 133-146 行：添加订单已完成节点
- 第 180-185 行：按时间排序

**当前行为分析：**

**第 118 行：** `if (order.accepted_at)`
- 如果 `order.accepted_at` 不存在（`undefined`），不添加"订单已接单"节点
- 不会报错，只是跳过

**第 133 行：** `if (order.completed_at)`
- 如果 `order.completed_at` 存在，添加"订单已完成"节点
- 不检查 `order.accepted_at` 是否存在

**第 180-185 行：** 按时间排序
```typescript
nodes.sort((a, b) => {
  const timeA = new Date(a.timestamp).getTime()
  const timeB = new Date(b.timestamp).getTime()
  return timeA - timeB
})
```
- 只按时间戳排序，不检查逻辑顺序
- 如果 `completed_at` 存在但 `accepted_at` 不存在，时间线会显示：订单创建 → 订单已完成（跳过已接单）

**结论：** ✅ **安全**
- **文件路径：** `components/facts/OrderTimeline.tsx`
- **行号：** 第 118-131 行、第 133-146 行、第 180-185 行
- **当前行为：** 系统会显示时间线，即使逻辑顺序异常（completed 出现但 accepted 不存在），不会崩溃，只是跳过已接单节点

---

### 3.2 trace_logs.created_at 早于 delivery_orders.created_at

**检查位置：** `components/facts/OrderTimeline.tsx`

**代码路径：**
- 第 105-114 行：添加订单创建节点（使用 `order.created_at`）
- 第 159-171 行：添加溯源记录节点（使用 `trace.created_at`）
- 第 180-185 行：按时间排序

**当前行为分析：**

**第 110 行：** `timestamp: order.created_at`
- 订单创建节点使用 `delivery_orders.created_at`

**第 165 行：** `timestamp: trace.created_at`
- 溯源记录节点使用 `trace_logs.created_at`

**第 180-185 行：** 按时间排序
```typescript
nodes.sort((a, b) => {
  const timeA = new Date(a.timestamp).getTime()
  const timeB = new Date(b.timestamp).getTime()
  return timeA - timeB
})
```
- 只按时间戳数值排序，不检查逻辑顺序
- 如果 `trace.created_at` 早于 `order.created_at`，溯源记录会显示在订单创建之前

**结论：** ✅ **安全**
- **文件路径：** `components/facts/OrderTimeline.tsx`
- **行号：** 第 110 行、第 165 行、第 180-185 行
- **当前行为：** 系统会显示时间线，即使时间顺序异常（trace_logs.created_at 早于 delivery_orders.created_at），不会崩溃，按实际时间戳排序显示

---

## 总结

### ✅ 所有场景验证结果

| 场景 | 检查项 | 状态 | 文件路径 | 行号 |
|------|--------|------|---------|------|
| audit_logs 缺失 | API 返回结构完整性 | ✅ 安全 | `app/api/facts/orders/[order_id]/route.ts` | 179-187, 299-304 |
| audit_logs 缺失 | accepted_at/completed_at 推断 | ✅ 安全 | `app/api/facts/orders/[order_id]/route.ts` | 92-93, 126-129, 185-186 |
| trace_logs 缺失 | API 返回类型 | ✅ 安全 | `app/api/facts/orders/[order_id]/route.ts` | 201, 204-211, 302 |
| trace_logs 缺失 | OrderTimeline 渲染风险 | ✅ 安全 | `components/facts/OrderTimeline.tsx` | 159-171, 230 |
| trace_logs 缺失 | AssetFactCard 渲染风险 | ✅ 安全 | `components/facts/AssetFactCard.tsx` | 82, 130-147, 153 |
| trace_logs 缺失 | API 资产查询处理 | ✅ 安全 | `app/api/facts/orders/[order_id]/route.ts` | 242-261 |
| 时间线断裂 | completed 无 accepted | ✅ 安全 | `components/facts/OrderTimeline.tsx` | 118-131, 133-146, 180-185 |
| 时间线断裂 | trace 早于 order | ✅ 安全 | `components/facts/OrderTimeline.tsx` | 110, 165, 180-185 |

---

**验证完成时间：** 2025-01-20
