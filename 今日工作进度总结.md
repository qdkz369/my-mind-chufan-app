# ä»Šæ—¥å·¥ä½œè¿›åº¦æ€»ç»“

**æ—¥æœŸï¼š** 2025-01-25  
**çŠ¶æ€ï¼š** âœ… å·²å®Œæˆï¼Œå¯ç»§ç»­

---

## ğŸ“‹ å·²å®Œæˆä»»åŠ¡

### 1. âœ… API æ‹¦æˆªå™¨å½»åº•ç–é€š

**å®Œæˆå†…å®¹ï¼š**
- ç§»é™¤æ‰€æœ‰çŠ¶æ€æµè½¬æ‹¦æˆªï¼ˆ`app/api/orders/` ç›®å½•ä¸‹ 5 ä¸ªæ–‡ä»¶ï¼‰
- ç§»é™¤å­—æ®µå¼ºåˆ¶æ ¡éªŒï¼ˆ`tracking_code` å’Œ `proof_image` æ”¹ä¸ºå¯é€‰ï¼‰
- ç»Ÿä¸€ä¿®å¤å‰©ä½™ 14 ä¸ª API æ–‡ä»¶ï¼š
  - æ‰€æœ‰ `Request` æ›¿æ¢ä¸º `NextRequest`
  - åˆ é™¤æ‰€æœ‰ `getCurrentCompanyId` å’Œ `getCurrentUserId` è°ƒç”¨
  - ç»Ÿä¸€æ³¨å…¥ `getUserContext` é€»è¾‘
  - æ·»åŠ  Super Admin æ”¾è¡Œé€»è¾‘
- ä¿®å¤ `lib/multi-tenant.ts` ä¸­çš„ throw é”™è¯¯
- ä¿®å¤ `lib/auth/user-context.ts` ä¸­çš„ throw é”™è¯¯ï¼ˆæ”¹ä¸ºè¿”å› nullï¼‰

**ç›¸å…³æ–‡ä»¶ï¼š**
- `APIæ‹¦æˆªå™¨ç–é€šå®Œæˆæ€»ç»“.md`
- `APIç»Ÿä¸€ä¿®å¤å®Œæˆæ€»ç»“.md`

### 2. âœ… è®¢å•ä¸»è¡¨ï¼ˆorder_mainï¼‰ç³»ç»Ÿ

**å®Œæˆå†…å®¹ï¼š**
- åˆ›å»º `order_main` è¡¨ï¼ˆæ•°æ®åº“è¿ç§»ï¼‰
- ä¸º `delivery_orders` å’Œ `rental_orders` è¡¨æ·»åŠ  `main_order_id` å­—æ®µ
- ä¿®æ”¹ç‡ƒæ–™è®¢å• API æ·»åŠ å½±å­å†™å…¥
- ä¿®æ”¹ç§Ÿèµè®¢å• API æ·»åŠ å½±å­å†™å…¥
- åˆ›å»ºè®¢å•åˆ—è¡¨ UIï¼ˆ`app/(dashboard)/orders/page.tsx`ï¼‰
- åˆ›å»ºè®¢å•ä¸»è¡¨åˆ—è¡¨ APIï¼ˆ`app/api/orders/main/list/route.ts`ï¼‰

**æ•°æ®åº“è¿ç§»æ–‡ä»¶ï¼š**
- `migrations/20250125_create_order_main_table.sql`
- `migrations/20250125_add_main_order_id_to_business_tables.sql`

**API æ–‡ä»¶ï¼š**
- `app/api/orders/create/route.ts` - å·²æ·»åŠ å½±å­å†™å…¥
- `app/api/equipment/rental/create/route.ts` - å·²æ·»åŠ å½±å­å†™å…¥
- `app/api/orders/main/list/route.ts` - æ–°å»ºè®¢å•ä¸»è¡¨åˆ—è¡¨ API

**å‰ç«¯æ–‡ä»¶ï¼š**
- `app/(dashboard)/orders/page.tsx` - æ–°å»ºè®¢å•åˆ—è¡¨é¡µé¢

---

## ğŸ” å…³é”®ä¿®æ”¹ç‚¹

### 1. getUserContext è¿”å›ç±»å‹å˜æ›´

**é‡è¦å˜æ›´ï¼š**
- `getUserContext` ç°åœ¨è¿”å› `Promise<UserContext | null>`ï¼ˆä¹‹å‰åªèƒ½è¿”å› `UserContext`ï¼‰
- æ‰€æœ‰ä¸æƒé™ã€å…¬å¸ã€ç”¨æˆ·ç›¸å…³çš„ throw å·²æ”¹ä¸º `console.error` å¹¶è¿”å› `null`
- API è·¯ç”±éœ€è¦å¤„ç† `userContext` ä¸º `null` çš„æƒ…å†µï¼ˆå·²ä½¿ç”¨ try-catch åŒ…è£¹ï¼‰

### 2. Super Admin æ”¾è¡Œé€»è¾‘

**ç»Ÿä¸€æ¨¡å¼ï¼š**
```typescript
// ğŸ”“ æ”¾è¡Œ Super Adminï¼šå¦‚æœç”¨æˆ·æ˜¯ super_adminï¼Œè·³è¿‡æ‰€æœ‰å¤šç§Ÿæˆ·è¿‡æ»¤é€»è¾‘
let userContext
try {
  userContext = await getUserContext(request)
  if (userContext?.role === "super_admin") {
    console.log("[APIåç§°] Super Admin è®¿é—®ï¼Œè·³è¿‡å¤šç§Ÿæˆ·è¿‡æ»¤")
  }
} catch (error) {
  console.warn("[APIåç§°] è·å–ç”¨æˆ·ä¸Šä¸‹æ–‡å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ:", error)
}

// å¤šç§Ÿæˆ·è¿‡æ»¤å¤„ï¼š
if (companyId && userContext?.role !== "super_admin") {
  // åº”ç”¨å¤šç§Ÿæˆ·è¿‡æ»¤
} else if (userContext?.role === "super_admin") {
  console.log("[APIåç§°] Super Admin è®¿é—®ï¼Œä¸åº”ç”¨å¤šç§Ÿæˆ·è¿‡æ»¤")
}
```

### 3. å½±å­å†™å…¥æ¨¡å¼

**ç»Ÿä¸€æ¨¡å¼ï¼š**
```typescript
// ğŸ“ å½±å­å†™å…¥ï¼šåŒæ­¥å†™å…¥ order_main è¡¨
try {
  const adminClient = createClient(supabaseUrl, serviceRoleKey || anonKey!, {...})
  const { data: mainOrder } = await adminClient.from("order_main").insert({...})
  if (mainOrder) {
    await adminClient.from("business_table").update({ main_order_id: mainOrder.id })
  }
} catch (error) {
  console.error("[API] å½±å­å†™å…¥å¼‚å¸¸ï¼ˆä¸å½±å“ä¸»æµç¨‹ï¼‰:", error)
}
```

---

## ğŸ“ å¾…æ‰§è¡Œäº‹é¡¹ï¼ˆæ˜å¤©ç»§ç»­ï¼‰

### 1. æ•°æ®åº“è¿ç§»æ‰§è¡Œ

**éœ€è¦æ‰§è¡Œï¼š**
```sql
-- 1. åˆ›å»º order_main è¡¨
-- æ‰§è¡Œï¼šmigrations/20250125_create_order_main_table.sql

-- 2. æ·»åŠ  main_order_id å­—æ®µ
-- æ‰§è¡Œï¼šmigrations/20250125_add_main_order_id_to_business_tables.sql
```

**éªŒè¯æ­¥éª¤ï¼š**
- æ£€æŸ¥ `order_main` è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ
- æ£€æŸ¥ `delivery_orders.main_order_id` å­—æ®µæ˜¯å¦å­˜åœ¨
- æ£€æŸ¥ `rental_orders.main_order_id` å­—æ®µæ˜¯å¦å­˜åœ¨
- éªŒè¯ RLS ç­–ç•¥æ˜¯å¦æ­£ç¡®

### 2. æµ‹è¯•éªŒè¯

**éœ€è¦æµ‹è¯•ï¼š**
- [ ] åˆ›å»ºç‡ƒæ–™è®¢å• â†’ æ£€æŸ¥ `order_main` è¡¨æ˜¯å¦æœ‰å¯¹åº”è®°å½•
- [ ] åˆ›å»ºç§Ÿèµè®¢å• â†’ æ£€æŸ¥ `order_main` è¡¨æ˜¯å¦æœ‰å¯¹åº”è®°å½•
- [ ] æ£€æŸ¥ `delivery_orders.main_order_id` æ˜¯å¦æ­£ç¡®å…³è”
- [ ] æ£€æŸ¥ `rental_orders.main_order_id` æ˜¯å¦æ­£ç¡®å…³è”
- [ ] è®¿é—® `/orders` é¡µé¢ï¼ŒéªŒè¯è®¢å•åˆ—è¡¨æ˜¾ç¤ºæ­£å¸¸
- [ ] æµ‹è¯•ç­›é€‰åŠŸèƒ½ï¼ˆè®¢å•ç±»å‹ã€çŠ¶æ€ï¼‰
- [ ] æµ‹è¯•åˆ†é¡µåŠŸèƒ½

### 3. æ½œåœ¨é—®é¢˜æ£€æŸ¥

**éœ€è¦æ£€æŸ¥ï¼š**
- [ ] `restaurants` è¡¨æ˜¯å¦æœ‰ `company_id` å­—æ®µï¼ˆRLS ç­–ç•¥ä¾èµ–ï¼‰
- [ ] ç°æœ‰è®¢å•æ•°æ®æ˜¯å¦éœ€è¦è¿ç§»åˆ° `order_main` è¡¨
- [ ] è®¢å•åˆ—è¡¨ API çš„æ€§èƒ½ï¼ˆå¦‚æœè®¢å•æ•°é‡å¾ˆå¤§ï¼‰

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `APIæ‹¦æˆªå™¨ç–é€šå®Œæˆæ€»ç»“.md` - API æ‹¦æˆªå™¨ç–é€šè¯¦ç»†è¯´æ˜
- `APIç»Ÿä¸€ä¿®å¤å®Œæˆæ€»ç»“.md` - API ç»Ÿä¸€ä¿®å¤è¯¦ç»†è¯´æ˜
- `å¤šç§Ÿæˆ·ä¸å¤šè§’è‰²æ•°æ®éš”ç¦»æ¶æ„æŠ¥å‘Š.md` - å¤šç§Ÿæˆ·æ¶æ„è¯´æ˜

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. getUserContext è¿”å› null çš„å¤„ç†

**å½“å‰çŠ¶æ€ï¼š**
- æ‰€æœ‰ API è·¯ç”±å·²ä½¿ç”¨ `try-catch` åŒ…è£¹ `getUserContext`
- å¦‚æœ `userContext` ä¸º `null`ï¼ŒAPI åº”è¯¥è¿”å› 401 æˆ– 403 é”™è¯¯å“åº”
- å½±å­å†™å…¥å¤±è´¥ä¸å½±å“ä¸»æµç¨‹ï¼ˆåªè®°å½•é”™è¯¯ï¼‰

### 2. Super Admin æƒé™

**å®‰å…¨æé†’ï¼š**
- Super Admin ç°åœ¨å¯ä»¥è®¿é—®æ‰€æœ‰æ•°æ®ï¼Œä¸å—å¤šç§Ÿæˆ·è¿‡æ»¤é™åˆ¶
- ç¡®ä¿åªæœ‰å¯ä¿¡ç”¨æˆ·æ‰èƒ½è·å¾— Super Admin è§’è‰²
- è€ƒè™‘æ·»åŠ  Super Admin æ“ä½œå®¡è®¡æ—¥å¿—

### 3. ä¸´æ—¶ä¿®å¤æ ‡è®°

**æ‰€æœ‰ä¿®æ”¹éƒ½æ ‡è®°ä¸º"ä¸´æ—¶ä¿®å¤"ï¼š**
- âš ï¸ è¿™äº›ä¿®æ”¹æ˜¯ä¸ºäº†é¿å… 500 å´©æºƒçš„ä¸´æ—¶æªæ–½
- é¡¹ç›®å¯åŠ¨åï¼Œå»ºè®®é€æ­¥æ¢å¤é€‚å½“çš„é”™è¯¯å¤„ç†
- æ¢å¤æ—¶ï¼Œå»ºè®®å…ˆæ¢å¤å…³é”® API çš„é”™è¯¯å¤„ç†ï¼Œå†æ¢å¤å…¶ä»– API

---

## ğŸš€ æ˜å¤©å¼€å§‹æ­¥éª¤

1. **æ‰§è¡Œæ•°æ®åº“è¿ç§»**
   - åœ¨ Supabase æ§åˆ¶å°æ‰§è¡Œä¸¤ä¸ª SQL è¿ç§»æ–‡ä»¶
   - éªŒè¯è¡¨ç»“æ„å’Œ RLS ç­–ç•¥

2. **æµ‹è¯•å½±å­å†™å…¥**
   - åˆ›å»ºæµ‹è¯•è®¢å•ï¼ˆç‡ƒæ–™å’Œç§Ÿèµï¼‰
   - éªŒè¯ `order_main` è¡¨æ•°æ®
   - éªŒè¯å…³è”å…³ç³»

3. **æµ‹è¯•è®¢å•åˆ—è¡¨**
   - è®¿é—® `/orders` é¡µé¢
   - æµ‹è¯•ç­›é€‰å’Œåˆ†é¡µåŠŸèƒ½
   - éªŒè¯æ•°æ®æ­£ç¡®æ€§

4. **æ€§èƒ½ä¼˜åŒ–ï¼ˆå¦‚éœ€è¦ï¼‰**
   - å¦‚æœè®¢å•æ•°é‡å¾ˆå¤§ï¼Œè€ƒè™‘æ·»åŠ æ›´å¤šç´¢å¼•
   - è€ƒè™‘æ·»åŠ ç¼“å­˜æœºåˆ¶

---

**ä¿å­˜æ—¶é—´ï¼š** 2025-01-25  
**çŠ¶æ€ï¼š** âœ… æ‰€æœ‰ä»£ç å·²ä¿å­˜ï¼Œæ—  linter é”™è¯¯
