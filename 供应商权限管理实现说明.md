# 供应商权限管理和数据隔离实现说明

## ✅ 已完成的安全优化

### 1. 角色判断逻辑严谨性 ✅
**优化前：** `userRole === "admin" && userRole !== "super_admin"`（排除法，容易失效）

**优化后：** 采用**"非超级管理员即隔离"**原则
```typescript
// 只要不是 super_admin，且存在 userCompanyId，就强制注入公司过滤
if (userRole !== "super_admin" && userCompanyId) {
  query = query.eq("company_id", userCompanyId)
}
```

### 2. 最小权限原则（白名单机制）✅
**优化前：** "如果没有分配权限，默认显示所有菜单"（违反最小权限原则）

**优化后：** 默认只显示 `dashboard`，权限采用**白名单机制**
```typescript
// 非超级管理员，严格按权限过滤（白名单）
filteredMenuItems = menuItems.filter(item => {
  // 工作台（dashboard）始终可见
  if (item.key === "dashboard") return true
  // 其他功能必须明确授权（白名单机制）
  return companyPermissions.includes(item.key)
})
```

### 3. 燃料价格保存权限校验 ✅
**优化：** 在提交时校验 `fuel_type` 是否在 `companyFuelTypes` 白名单内
```typescript
// 防止非法越权修改其他油品的单价
if (userRole !== "super_admin" && userCompanyId) {
  if (!companyFuelTypes.includes(fuelId)) {
    alert(`⚠️ 权限不足：您没有权限修改 "${fuelId}" 的价格`)
    return
  }
}
```

### 4. 实时订阅数据泄露防护 ⚠️
**重要：** 前端无法完全控制 WebSocket 数据流，必须在数据库层面开启 RLS

**说明：**
- Supabase 的 `postgres_changes` 实时订阅会在数据库层面推送数据
- 即使前端过滤显示，WebSocket 流仍会把数据推送到浏览器内存
- **解决方案：** 必须确保数据库表开启了 RLS (Row Level Security)
- RLS 策略会在数据库层面过滤，只推送用户有权访问的行

**需要在数据库中执行的 RLS 策略示例：**
```sql
-- 示例：orders 表的 RLS 策略
-- 超级管理员可以查看所有订单
CREATE POLICY "Super admin can view all orders"
  ON orders FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM user_roles
      WHERE user_id = auth.uid()
      AND role = 'super_admin'
    )
  );

-- 供应商只能查看自己公司的订单
CREATE POLICY "Suppliers can view own company orders"
  ON orders FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM user_companies uc
      JOIN user_roles ur ON ur.user_id = auth.uid()
      WHERE uc.user_id = auth.uid()
      AND uc.company_id = orders.company_id
      AND ur.role != 'super_admin'
    )
  );
```

## 数据库表结构

### 1. company_permissions（供应商功能权限表）✅
- `company_id`: 公司ID（外键）
- `permission_key`: 功能模块标识（对应菜单的 key）
  - 可选值：`dashboard`, `restaurants`, `orders`, `repairs`, `equipmentRental`, `rentals`, `productApproval`, `supplierManagement`, `devices`, `workers`, `fuelPricing`, `agreements`, `api`, `analytics`, `settings`
- `enabled`: 是否启用

### 2. company_fuel_types（供应商燃料品种关联表）✅
- `company_id`: 公司ID（外键）
- `fuel_type`: 燃料品种标识
  - 需要与燃料价格表中的 `fuel_type` 字段对应
  - 例如：`lpg`（液化气）、`clean`（热能清洁燃料）、`alcohol`（醇基燃料）、`outdoor`（户外环保燃料）等
- `enabled`: 是否启用

**执行步骤：**
1. 在 Supabase SQL Editor 中执行 `migrations/20250122_supplier_permissions.sql`
2. 验证表是否创建成功

## 数据隔离实现

### 数据查询隔离 ✅
所有数据查询函数已添加 `company_id` 过滤条件：

```typescript
// 示例：loadRestaurants
let query = supabase.from("restaurants").select("*")

// 采用"非超级管理员即隔离"原则
if (userRole !== "super_admin" && userCompanyId) {
  query = query.eq("company_id", userCompanyId)
  console.log('[Restaurants] 🔒 数据隔离：只查询公司ID', userCompanyId, '的餐厅')
}
```

**需要修改的函数：**
- ✅ `loadRestaurants()` - 已添加框架代码（需要确认表结构）
- ⏳ `loadOrders()` / `loadRecentOrders()` - 需要添加
- ⏳ `loadRepairs()` - 需要添加
- ⏳ `loadDevices()` - 需要添加
- ⏳ `loadWorkers()` - 需要添加
- ⏳ `loadServicePoints()` - 需要添加
- ⏳ `loadRentalOrders()` - 需要添加
- ⏳ `loadDeviceRentals()` - 需要添加
- ✅ `loadFuelPricing()` - 需要根据 `companyFuelTypes` 过滤

### 燃料价格过滤 ⏳
在 `renderFuelPricing()` 函数中：
- 如果是供应商，只显示被分配的燃料品种
- 查询时添加 `fuel_type IN (companyFuelTypes)` 条件

```typescript
// 示例：过滤燃料价格显示
const filteredFuelPrices = userRole === "super_admin"
  ? fuelPrices // 超级管理员看到所有
  : fuelPrices.filter(fuel => companyFuelTypes.includes(fuel.id)) // 供应商只看到授权的
```

## 侧边栏菜单过滤 ✅

**实现：** 根据供应商权限动态过滤菜单项

```typescript
// 超级管理员：所有菜单
if (userRole === "super_admin") {
  filteredMenuItems = menuItems
}
// 非超级管理员：白名单机制，默认只显示 dashboard
else if (userRole && userCompanyId) {
  filteredMenuItems = menuItems.filter(item => {
    if (item.key === "dashboard") return true
    return companyPermissions.includes(item.key)
  })
}
// 未登录：只显示 dashboard（安全考虑）
else {
  filteredMenuItems = menuItems.filter(item => item.key === "dashboard")
}
```

## 权限分配界面 ⏳

需要在 `app/(admin)/dashboard/supplier-management.tsx` 中添加：
- 权限分配对话框
- 功能模块选择（多选）
- 燃料品种选择（多选，仅当分配了 `fuelPricing` 权限时显示）

## 数据隔离规则

### 规则总结
1. **超级管理员（super_admin）**：
   - 可以看到所有数据
   - 可以访问所有功能模块

2. **供应商（非 super_admin 且有 company_id）**：
   - 只能看到自己公司的数据（`company_id` 过滤）
   - 只能访问被授权的功能模块（白名单机制）
   - 燃料价格只能看到和修改被分配的品种

3. **未登录或角色未知**：
   - 默认只显示 `dashboard`（最小权限原则）

### 数据表字段要求
所有需要隔离的数据表必须有 `company_id` 字段：
- ✅ `companies` - 已有
- ⏳ `restaurants` - 需要确认是否有 `company_id`
- ⏳ `orders` - 需要确认是否有 `company_id`
- ⏳ `repairs` - 需要确认是否有 `company_id`
- ⏳ `devices` - 需要确认是否有 `company_id`
- ⏳ `workers` - 需要确认是否有 `company_id`
- ⏳ `service_points` - 需要确认是否有 `company_id`
- ⏳ `rental_orders` - 需要确认是否有 `company_id`
- ⏳ `fuel_prices` - 需要确认是否有 `company_id` 或关联机制

## 安全注意事项 ⚠️

### 1. RLS（行级安全策略）必须开启
- **关键：** 实时订阅的数据泄露防护依赖数据库层面的 RLS
- 必须在所有需要隔离的表上开启 RLS
- RLS 策略必须基于 `company_id` 和用户角色进行过滤

### 2. 前后端双重验证
- **前端：** 用于用户体验优化（提前提示、过滤显示）
- **后端：** 用于安全防护（API 层面必须再次验证权限）

### 3. 权限变更需重新登录
- 权限信息在用户登录时加载
- 如果权限变更，需要重新登录才能生效

### 4. 燃料品种权限闭环
- 不仅要在显示时过滤
- 更要在**保存时校验**，防止非法越权修改

## 下一步操作

1. ✅ **执行数据库迁移**：在 Supabase SQL Editor 中执行 `migrations/20250122_supplier_permissions.sql`
2. ⏳ **确认表结构**：检查所有数据表是否有 `company_id` 字段，如果没有需要添加
3. ⏳ **修改所有数据查询函数**：为所有 `loadXxx` 函数添加 `company_id` 过滤
4. ⏳ **配置 RLS 策略**：为所有需要隔离的表添加 RLS 策略
5. ⏳ **实现权限分配界面**：在供应商管理中添加权限分配功能
6. ⏳ **测试数据隔离**：使用供应商账号登录，验证只能看到自己的数据

## 安全原则总结

1. ✅ **最小权限原则**：默认只显示 dashboard，权限采用白名单机制
2. ✅ **非超级管理员即隔离**：只要不是 super_admin，就强制数据隔离
3. ✅ **前后端双重验证**：前端用户体验优化 + 后端安全防护
4. ✅ **数据库层面防护**：RLS 策略确保实时订阅不泄露数据
5. ✅ **权限闭环**：不仅在显示时过滤，更要在保存时校验
