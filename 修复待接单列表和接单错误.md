# 修复待接单列表和接单错误

## 问题描述

### 问题1：待接单列表为空
- 页面显示"暂无待接单订单"
- 产品类型筛选显示为 `clean`
- 控制台警告：没有待接单订单

### 问题2：接单失败
- 错误信息："订单不存在或状态不允许"
- API返回 400 Bad Request
- 发生在完成配送流程的自动接单步骤

## 根本原因

### 原因1：产品类型不匹配
- **前端使用**: `"clean"` (来自 `app/payment/page.tsx`)
- **数据库使用**: `"clean_fuel"` (来自 `lib/types/order.ts` 的 `ProductType.CLEAN_FUEL`)
- **结果**: 查询时使用 `product_type = 'clean'`，但数据库中存储的是 `'clean_fuel'`，导致查询不到数据

### 原因2：错误信息不够详细
- 接单API的错误信息不够详细，无法快速定位问题
- 缺少订单状态的详细日志

## 修复方案

### 修复1：产品类型映射
**文件**: `components/worker/order-list.tsx`

添加产品类型映射逻辑：
```typescript
// 产品类型映射：将前端的 "clean" 映射到数据库的 "clean_fuel"
let dbProductType = productType
if (productType === "clean") {
  dbProductType = "clean_fuel"
} else if (productType === "alcohol") {
  dbProductType = "methanol"
} else if (productType === "outdoor") {
  dbProductType = "outdoor_fuel"
}
```

**映射关系**:
- `"clean"` → `"clean_fuel"` (热能清洁燃料)
- `"alcohol"` → `"methanol"` (甲醇)
- `"outdoor"` → `"outdoor_fuel"` (户外环保燃料)
- `"lpg"` → `"lpg"` (液化气，无需映射)

### 修复2：改进接单API错误处理
**文件**: `app/api/orders/accept/route.ts`

1. **添加详细日志**:
   - 记录订单查询结果
   - 记录订单当前状态
   - 记录状态流转失败的原因

2. **改进错误信息**:
   - 返回订单当前状态
   - 返回订单ID
   - 提供更详细的错误提示

### 修复3：添加产品类型筛选UI
**文件**: `app/worker/page.tsx`

1. **显示当前筛选**:
   - 显示当前筛选的产品类型（中文名称）
   - 提供"清除筛选"按钮

2. **改进错误日志**:
   - 在完成配送流程中添加详细的接单API响应日志

## 修改文件清单

1. ✅ `components/worker/order-list.tsx`
   - 添加产品类型映射逻辑
   - 添加映射日志

2. ✅ `app/api/orders/accept/route.ts`
   - 改进错误处理
   - 添加详细日志
   - 返回更详细的错误信息

3. ✅ `app/worker/page.tsx`
   - 添加产品类型筛选UI
   - 改进完成配送流程的错误日志

## 测试建议

### 测试1：产品类型筛选
1. 登录配送员账号（产品类型为 `clean`）
2. 进入待接单订单页面
3. 验证：
   - 是否显示"当前筛选：热能清洁燃料"
   - 是否能看到 `product_type = 'clean_fuel'` 的订单
   - 点击"清除筛选"后，是否显示所有类型的订单

### 测试2：接单流程
1. 选择一个 `pending` 状态的订单
2. 进入配送证明页面
3. 填写配送信息
4. 点击"完成配送"
5. 验证：
   - 查看控制台日志，确认接单API的请求和响应
   - 如果失败，查看详细的错误信息
   - 订单状态是否正确流转

### 测试3：错误处理
1. 尝试接单一个已经接单的订单（状态为 `accepted`）
2. 验证：
   - 错误信息是否包含订单当前状态
   - 错误信息是否包含订单ID
   - 控制台是否有详细的日志

## 产品类型映射表

| 前端值 | 数据库值 | 中文名称 |
|--------|---------|---------|
| `lpg` | `lpg` | 液化气 |
| `clean` | `clean_fuel` | 热能清洁燃料 |
| `alcohol` | `methanol` | 甲醇 |
| `outdoor` | `outdoor_fuel` | 户外环保燃料 |

## 相关文件

- `components/worker/order-list.tsx` - 订单列表组件
- `app/api/orders/accept/route.ts` - 接单API
- `app/worker/page.tsx` - 工人端主页面
- `lib/types/order.ts` - 订单类型定义
- `app/payment/page.tsx` - 支付页面（产品类型定义）

## 完成时间

2025-01-20
