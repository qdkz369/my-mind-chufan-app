# 修复接单失败后订单列表消失问题

## 问题描述

点击接单按钮后，如果接单失败（返回错误），所有订单就从列表中消失了。

## 根本原因

1. **接单失败后刷新列表**：接单失败时，虽然抛出了异常，但如果 `loadOrders()` 在 catch 之前执行，或者 catch 中又调用了 `loadOrders()`，可能会重新加载列表
2. **加载失败时清空列表**：如果 `loadOrders()` 失败，可能会清空订单列表
3. **错误处理不当**：接单失败时，应该保持当前订单列表，而不是清空

## 修复方案

### 修复1：接单失败时不刷新列表
**文件**: `components/worker/order-list.tsx`

- **修改前**：接单失败后，catch 块中可能会触发 `loadOrders()`
- **修改后**：接单失败时，不调用 `loadOrders()`，保持当前订单列表不变
- **优势**：用户可以看到订单，并可以重试或查看错误原因

### 修复2：加载失败时不清空列表
**文件**: `components/worker/order-list.tsx`

- **修改前**：`loadOrders()` 失败时，可能会清空订单列表
- **修改后**：加载失败时，保留现有订单列表，只显示错误信息
- **优势**：避免用户看到空列表，提供更好的用户体验

### 修复3：改进错误处理
- 添加详细的日志，便于调试
- 保留错误信息，但不影响订单列表显示
- 接单成功后才刷新列表

## 修改内容

### 文件：`components/worker/order-list.tsx`

1. **`handleAccept` 函数**：
   ```typescript
   // 接单失败时，不清空订单列表，只显示错误信息
   catch (err: any) {
     console.error("[接单] 接单失败:", err)
     setError(err.message || "接单失败")
     // 注意：不调用 loadOrders()，保持当前订单列表不变
   }
   ```

2. **`loadOrders` 函数**：
   ```typescript
   // 加载失败时，保留现有订单列表，只显示错误信息
   catch (err: any) {
     console.error("[订单列表] 加载订单失败:", err)
     setError(err.message || "加载订单失败")
     // 注意：不调用 setOrders([])，保持当前订单列表
   }
   ```

## 行为变化

### 修复前
1. 用户点击"接单"
2. 接单失败（例如：订单状态不允许）
3. 订单列表被清空
4. 用户看不到任何订单

### 修复后
1. 用户点击"接单"
2. 接单失败（例如：订单状态不允许）
3. 显示错误信息
4. **订单列表保持不变**，用户可以看到订单并重试

## 优势

1. **更好的用户体验**：
   - 接单失败时，订单不会消失
   - 用户可以查看错误原因
   - 用户可以重试接单

2. **更稳定的界面**：
   - 加载失败时，不会清空列表
   - 避免用户看到空列表的困惑

3. **更好的调试**：
   - 添加了详细的日志
   - 便于排查问题

## 测试建议

1. **测试接单失败场景**：
   - 选择一个订单
   - 模拟接单失败（例如：订单状态不是 pending）
   - 验证：订单列表应该保持不变，只显示错误信息

2. **测试加载失败场景**：
   - 断开网络或模拟API错误
   - 刷新订单列表
   - 验证：如果之前有订单，应该保持不变

3. **测试接单成功场景**：
   - 选择一个 pending 状态的订单
   - 成功接单
   - 验证：订单列表应该刷新，已接单的订单应该消失

## 相关文件

- `components/worker/order-list.tsx` - 订单列表组件

## 完成时间

2025-01-20
