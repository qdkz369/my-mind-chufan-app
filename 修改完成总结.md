# ä¿®æ”¹å®Œæˆæ€»ç»“

## ğŸ“‹ ä¿®æ”¹å†…å®¹

### 1. âœ… ä¿®æ”¹ `lib/auth/user-context.ts`

**ä¿®æ”¹å†…å®¹ï¼š**
- å½»åº•åˆ‡æ¢åˆ° `restaurants` è¡¨è·å– `companyId`
- ä½¿ç”¨ `user_id` å­—æ®µåŒ¹é…å½“å‰ç”¨æˆ·
- ä½¿ç”¨ `maybeSingle()` è€Œä¸æ˜¯ `single()`ï¼Œé¿å…è¡¨ä¸å­˜åœ¨æ—¶æŠ›å‡ºé”™è¯¯
- **é‡è¦**ï¼šå¦‚æœæ‰¾ä¸åˆ°å…¬å¸ï¼Œè¿”å› `null`ï¼ˆè½¬æ¢ä¸º `undefined`ï¼‰ï¼Œ**ç»å¯¹ä¸æŠ›å‡ºé”™è¯¯**

**ä¿®æ”¹ä½ç½®ï¼š** ç¬¬ 294-329 è¡Œ

**å…³é”®å˜æ›´ï¼š**
```typescript
// ä¹‹å‰ï¼šä» user_companies è¡¨è·å–ï¼Œæ‰¾ä¸åˆ°æ—¶æŠ›å‡ºé”™è¯¯
// ç°åœ¨ï¼šä» restaurants è¡¨è·å–ï¼Œæ‰¾ä¸åˆ°æ—¶è¿”å› null

const { data: restaurantData, error: restaurantError } = await adminClient
  .from("restaurants")
  .select("company_id")
  .eq("user_id", userId)
  .not("company_id", "is", null)
  .limit(1)
  .maybeSingle() // ä½¿ç”¨ maybeSingle() é¿å…è¡¨ä¸å­˜åœ¨æ—¶æŠ›å‡ºé”™è¯¯

// å¦‚æœæ‰¾ä¸åˆ°å…¬å¸ï¼Œè¿”å› nullï¼Œç»å¯¹ä¸è¦ throw Error è§¦å‘ 500
return {
  userId,
  role,
  companyId: companyId || undefined, // å°† null è½¬æ¢ä¸º undefined
}
```

### 2. âœ… æ¸…ç†çº¦æŸï¼š`lib/facts/contracts/order.fact.ts`

**ä¿®æ”¹å†…å®¹ï¼š**
- æš‚æ—¶æ³¨é‡Šæ‰æ‰€æœ‰ `errors.push()` çš„å¼ºåˆ¶æ ¡éªŒé€»è¾‘
- æš‚æ—¶æ³¨é‡Šæ‰æ‰€æœ‰å­—æ®µéªŒè¯
- ä¸´æ—¶è¿”å› `valid: true` å’Œç©º `errors` æ•°ç»„ï¼Œé¿å…é˜»ç¢é¡¹ç›®å¯åŠ¨

**ä¿®æ”¹ä½ç½®ï¼š** ç¬¬ 298-335 è¡Œ

**å…³é”®å˜æ›´ï¼š**
```typescript
// ä¹‹å‰ï¼šè¿›è¡Œä¸¥æ ¼éªŒè¯ï¼Œå¦‚æœä¸ç¬¦åˆå¥‘çº¦ä¼šè¿”å› errors
// ç°åœ¨ï¼šæš‚æ—¶æ³¨é‡Šæ‰æ‰€æœ‰éªŒè¯ï¼Œå§‹ç»ˆè¿”å› valid: true

export function validateOrderFactContract(fact: OrderFactContract): {
  valid: boolean
  errors: string[]
} {
  const errors: string[] = []

  // âš ï¸ ä¸´æ—¶æ³¨é‡Šï¼šæš‚æ—¶æ³¨é‡Šæ‰æ‰€æœ‰å¼ºåˆ¶æ ¡éªŒé€»è¾‘
  // æ‰€æœ‰éªŒè¯ä»£ç éƒ½å·²æ³¨é‡Š

  // ä¸´æ—¶è¿”å›ï¼šå§‹ç»ˆè¿”å› valid: trueï¼Œä¸è¿›è¡Œä»»ä½•æ ¡éªŒ
  return {
    valid: true, // ä¸´æ—¶ï¼šå§‹ç»ˆè¿”å› trueï¼Œé¿å…é˜»ç¢é¡¹ç›®å¯åŠ¨
    errors: [], // ä¸´æ—¶ï¼šè¿”å›ç©ºæ•°ç»„
  }
}
```

### 3. âœ… å¿½ç•¥ç¼ºå¤±è¡¨ï¼šè¿ç§»è„šæœ¬å·²å¤„ç†

**æ–‡ä»¶ï¼š** `migrations/20250125_system_structure_finalization.sql`

**å¤„ç†æ–¹å¼ï¼š**
- æ‰€æœ‰å¯¹ `fuel_orders`ã€`order_main`ã€`worker_tasks` è¡¨çš„æ“ä½œéƒ½ä½¿ç”¨äº† `IF EXISTS` æ£€æŸ¥
- å¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œç›¸å…³æ“ä½œä¼šè¢«è·³è¿‡ï¼Œä¸ä¼šæŠ¥é”™

**ç¤ºä¾‹ï¼š**
```sql
-- 2. fuel_orders è¡¨
DO $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM information_schema.tables 
    WHERE table_schema = 'public' AND table_name = 'fuel_orders'
  ) AND NOT EXISTS (
    -- æ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨
  ) THEN
    -- åªæœ‰è¡¨å­˜åœ¨ä¸”å­—æ®µä¸å­˜åœ¨æ—¶æ‰æ‰§è¡Œ
    ALTER TABLE fuel_orders ADD COLUMN company_id ...
  END IF;
END $$;
```

---

## ğŸ” éªŒè¯ç»“æœ

### 1. ä»£ç æ£€æŸ¥
- âœ… `lib/auth/user-context.ts` - æ—  linter é”™è¯¯
- âœ… `lib/facts/contracts/order.fact.ts` - æ—  linter é”™è¯¯

### 2. é€»è¾‘éªŒè¯
- âœ… `getUserContext` ä¸å†æŠ›å‡º "æƒé™ä¸è¶³ï¼šç”¨æˆ·æœªå…³è”ä»»ä½•å…¬å¸" é”™è¯¯
- âœ… `validateOrderFactContract` ä¸å†è¿›è¡Œå¼ºåˆ¶æ ¡éªŒ
- âœ… è¿ç§»è„šæœ¬ä½¿ç”¨ `IF EXISTS` æ£€æŸ¥ï¼Œä¸ä¼šå› è¡¨ä¸å­˜åœ¨è€ŒæŠ¥é”™

### 3. è°ƒç”¨ç‚¹æ£€æŸ¥
- âœ… `validateOrderFactContract` åœ¨ `app/api/facts/orders/[order_id]/route.ts` ä¸­è¢«è°ƒç”¨
- âœ… è°ƒç”¨å¤„å·²å¤„ç†éªŒè¯å¤±è´¥çš„æƒ…å†µï¼Œä¸ä¼šæŠ›å‡ºé”™è¯¯ï¼ˆåªæ˜¯è¿”å›é”™è¯¯å“åº”ï¼‰
- âœ… ç”±äºç°åœ¨å§‹ç»ˆè¿”å› `valid: true`ï¼Œä¸ä¼šè§¦å‘é”™è¯¯å“åº”

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. ä¸´æ—¶ä¿®æ”¹è¯´æ˜

**`lib/facts/contracts/order.fact.ts`ï¼š**
- âš ï¸ æ‰€æœ‰éªŒè¯é€»è¾‘éƒ½å·²æ³¨é‡Šï¼Œè¿™æ˜¯**ä¸´æ—¶æªæ–½**
- é¡¹ç›®å¯åŠ¨åï¼Œå»ºè®®é€æ­¥æ¢å¤éªŒè¯é€»è¾‘
- æ¢å¤æ—¶ï¼Œå»ºè®®å…ˆæ¢å¤éå…³é”®å­—æ®µçš„éªŒè¯ï¼Œå†æ¢å¤å…³é”®å­—æ®µ

### 2. `getUserContext` è¡Œä¸ºå˜æ›´

**ä¹‹å‰ï¼š**
- æ‰¾ä¸åˆ° `companyId` æ—¶æŠ›å‡ºé”™è¯¯ï¼Œå¯¼è‡´ 500

**ç°åœ¨ï¼š**
- æ‰¾ä¸åˆ° `companyId` æ—¶è¿”å› `undefined`
- API è·¯ç”±éœ€è¦å¤„ç† `companyId` ä¸º `undefined` çš„æƒ…å†µ
- å»ºè®®åœ¨ API è·¯ç”±ä¸­æ·»åŠ æ£€æŸ¥ï¼š
  ```typescript
  if (!userContext.companyId && userContext.role !== "super_admin") {
    return NextResponse.json({
      error: "ç”¨æˆ·æœªå…³è”å…¬å¸"
    }, { status: 403 })
  }
  ```

### 3. æ•°æ®è¿ç§»å»ºè®®

**`restaurants` è¡¨æ•°æ®ï¼š**
- ç¡®ä¿ `restaurants` è¡¨æœ‰ `user_id` å’Œ `company_id` å­—æ®µ
- ç¡®ä¿æ¯ä¸ªç”¨æˆ·è‡³å°‘æœ‰ä¸€æ¡ `restaurants` è®°å½•ï¼Œä¸” `company_id` ä¸ä¸º NULL
- å¦‚æœæ•°æ®ä¸å®Œæ•´ï¼Œ`getUserContext` ä¼šè¿”å› `companyId: undefined`

---

## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ

1. **æµ‹è¯• `getUserContext`**
   - éªŒè¯ä» `restaurants` è¡¨è·å– `companyId` æ˜¯å¦æ­£å¸¸å·¥ä½œ
   - éªŒè¯æ‰¾ä¸åˆ°å…¬å¸æ—¶æ˜¯å¦è¿”å› `undefined` è€Œä¸æ˜¯æŠ›å‡ºé”™è¯¯

2. **æµ‹è¯• `validateOrderFactContract`**
   - éªŒè¯æ˜¯å¦ä¸å†è¿›è¡Œå¼ºåˆ¶æ ¡éªŒ
   - éªŒè¯ API æ˜¯å¦æ­£å¸¸è¿”å›æ•°æ®

3. **æ•°æ®å‡†å¤‡**
   - ä¸º `restaurants` è¡¨è®¾ç½® `user_id` å’Œ `company_id`
   - ç¡®ä¿æµ‹è¯•ç”¨æˆ·æœ‰å¯¹åº”çš„é¤å…è®°å½•

4. **é€æ­¥æ¢å¤éªŒè¯**
   - é¡¹ç›®å¯åŠ¨åï¼Œé€æ­¥æ¢å¤ `validateOrderFactContract` çš„éªŒè¯é€»è¾‘
   - å…ˆæ¢å¤éå…³é”®å­—æ®µï¼Œå†æ¢å¤å…³é”®å­—æ®µ

---

**ä¿®æ”¹å®Œæˆæ—¶é—´ï¼š** 2025-01-25  
**ç‰ˆæœ¬ï¼š** 1.0
