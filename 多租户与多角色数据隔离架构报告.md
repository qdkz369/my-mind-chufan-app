# å¤šç§Ÿæˆ·ä¸å¤šè§’è‰²æ•°æ®éš”ç¦»æ¶æ„æŠ¥å‘Š

## ğŸ“‹ ç›®å½•

1. [æ•°æ®åº“å…³è”ç»“æ„](#1-æ•°æ®åº“å…³è”ç»“æ„)
2. [åç«¯æŸ¥è¯¢æ‹¦æˆªé€»è¾‘](#2-åç«¯æŸ¥è¯¢æ‹¦æˆªé€»è¾‘)
3. [ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆContextï¼‰å†…å®¹](#3-ç”¨æˆ·ä¸Šä¸‹æ–‡contextå†…å®¹)
4. [æ•°æ®åº“ RLS ç­–ç•¥å®šä¹‰](#4-æ•°æ®åº“-rls-ç­–ç•¥å®šä¹‰)
5. [æ•°æ®éš”ç¦»æµç¨‹å›¾](#5-æ•°æ®éš”ç¦»æµç¨‹å›¾)
6. [å®‰å…¨æœºåˆ¶æ€»ç»“](#6-å®‰å…¨æœºåˆ¶æ€»ç»“)

---

## 1. æ•°æ®åº“å…³è”ç»“æ„

### 1.1 æ ¸å¿ƒè¡¨å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  auth.users     â”‚  (Supabase Auth ç”¨æˆ·è¡¨)
â”‚  - id (UUID)    â”‚
â”‚  - email        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1:N
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user_companies  â”‚  (ç”¨æˆ·-å…¬å¸å…³è”è¡¨)
â”‚  - id           â”‚
â”‚  - user_id      â”‚â”€â”€â”
â”‚  - company_id    â”‚â”€â”€â”¤
â”‚  - role         â”‚  â”‚
â”‚  - is_primary   â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
         â”‚           â”‚
         â”‚ N:1       â”‚ N:1
         â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   companies     â”‚ â”‚ rental_orders   â”‚
â”‚  - id           â”‚ â”‚  - id           â”‚
â”‚  - name         â”‚ â”‚  - provider_id  â”‚â”€â”€â”
â”‚  - status       â”‚ â”‚  - restaurant_idâ”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  - order_status â”‚  â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                           â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                     â”‚   agreements    â”‚  â”‚
                     â”‚  - id           â”‚  â”‚
                     â”‚  - company_id   â”‚â”€â”€â”˜
                     â”‚  - type         â”‚
                     â”‚  - status       â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 è¡¨ç»“æ„å®šä¹‰

#### 1.2.1 `user_companies` è¡¨ï¼ˆç”¨æˆ·-å…¬å¸å…³è”è¡¨ï¼‰

```sql
CREATE TABLE IF NOT EXISTS user_companies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- ç”¨æˆ·IDï¼ˆå…³è” auth.users è¡¨ï¼‰
  user_id UUID NOT NULL,
  
  -- å…¬å¸IDï¼ˆå…³è” companies è¡¨ï¼‰
  company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
  
  -- ç”¨æˆ·åœ¨å…¬å¸ä¸­çš„è§’è‰²
  role VARCHAR(50) DEFAULT 'member' CHECK (role IN ('member', 'admin', 'owner')),
  
  -- æ˜¯å¦ä¸ºä¸»å…¬å¸ï¼ˆä¸€ä¸ªç”¨æˆ·å¯èƒ½æœ‰å¤šä¸ªå…¬å¸ï¼Œä½†åªæœ‰ä¸€ä¸ªä¸»å…¬å¸ï¼‰
  is_primary BOOLEAN DEFAULT false,
  
  -- æ—¶é—´æˆ³
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- å”¯ä¸€çº¦æŸï¼šä¸€ä¸ªç”¨æˆ·åœ¨ä¸€ä¸ªå…¬å¸ä¸­åªèƒ½æœ‰ä¸€æ¡è®°å½•
  UNIQUE(user_id, company_id)
);
```

**å…³é”®ç´¢å¼•ï¼š**
```sql
CREATE INDEX idx_user_companies_user ON user_companies(user_id);
CREATE INDEX idx_user_companies_company ON user_companies(company_id);
CREATE INDEX idx_user_companies_primary ON user_companies(user_id, is_primary) 
  WHERE is_primary = true;
```

#### 1.2.2 `rental_orders` è¡¨ï¼ˆç§Ÿèµè®¢å•è¡¨ï¼‰

```sql
CREATE TABLE IF NOT EXISTS rental_orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_number VARCHAR(50) UNIQUE NOT NULL,
  restaurant_id UUID NOT NULL,
  user_id UUID,
  equipment_id UUID REFERENCES equipment(id) ON DELETE RESTRICT,
  
  -- ğŸ”’ å¤šç§Ÿæˆ·éš”ç¦»å­—æ®µï¼šä¾›åº”å•†ID
  provider_id UUID REFERENCES companies(id) ON DELETE SET NULL,
  
  -- è®¢å•ä¿¡æ¯
  quantity INTEGER DEFAULT 1,
  rental_period INTEGER NOT NULL,
  start_date DATE NOT NULL,
  end_date DATE,
  monthly_rental_price DECIMAL(10, 2) NOT NULL,
  total_amount DECIMAL(10, 2) NOT NULL,
  deposit_amount DECIMAL(10, 2) DEFAULT 0,
  payment_status VARCHAR(20) DEFAULT 'pending',
  order_status VARCHAR(20) DEFAULT 'pending',
  
  -- æ—¶é—´æˆ³
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**å…³é”®ç´¢å¼•ï¼š**
```sql
CREATE INDEX idx_rental_orders_provider ON rental_orders(provider_id);
CREATE INDEX idx_rental_orders_restaurant ON rental_orders(restaurant_id);
CREATE INDEX idx_rental_orders_user ON rental_orders(user_id);
CREATE INDEX idx_rental_orders_status ON rental_orders(order_status);
```

#### 1.2.3 `agreements` è¡¨ï¼ˆåè®®è¡¨ï¼‰

```sql
CREATE TABLE IF NOT EXISTS agreements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(200) NOT NULL,
  type VARCHAR(50) NOT NULL,
  version VARCHAR(20) DEFAULT '1.0',
  content TEXT NOT NULL,
  content_html TEXT,
  status VARCHAR(20) DEFAULT 'draft' CHECK (status IN ('draft', 'published', 'archived')),
  is_active BOOLEAN DEFAULT false,
  
  -- ğŸ”’ å¤šç§Ÿæˆ·éš”ç¦»å­—æ®µï¼šå…¬å¸IDï¼ˆNULL è¡¨ç¤ºå¹³å°é€šç”¨åè®®ï¼‰
  company_id UUID REFERENCES companies(id) ON DELETE SET NULL,
  
  effective_date DATE,
  expiry_date DATE,
  description TEXT,
  created_by UUID,
  
  -- æ—¶é—´æˆ³
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**å…³é”®ç´¢å¼•ï¼š**
```sql
CREATE INDEX idx_agreements_company_id ON agreements(company_id);
CREATE INDEX idx_agreements_type_status ON agreements(type, status);
CREATE UNIQUE INDEX idx_agreements_unique_active_type 
  ON agreements(company_id, type) 
  WHERE is_active = true AND status = 'published';
```

### 1.3 è®¢å•ä¸å•†æˆ·ç»‘å®šé€»è¾‘

**è®¢å•é€šè¿‡ `provider_id` å­—æ®µä¸ç‰¹å®šä¾›åº”å•†ï¼ˆå…¬å¸ï¼‰ç»‘å®šï¼š**

```sql
-- è®¢å•åˆ›å»ºæ—¶ï¼Œè‡ªåŠ¨å…³è”ä¾›åº”å•†
INSERT INTO rental_orders (
  order_number,
  restaurant_id,
  provider_id,  -- ğŸ”’ å…³é”®ï¼šé€šè¿‡æ­¤å­—æ®µç»‘å®šä¾›åº”å•†
  equipment_id,
  ...
) VALUES (
  'ORD-2025-001',
  'restaurant-uuid',
  'company-uuid',  -- ä» userContext.companyId è·å–
  'equipment-uuid',
  ...
);
```

**æŸ¥è¯¢è®¢å•æ—¶ï¼Œå¼ºåˆ¶æŒ‰ `provider_id` è¿‡æ»¤ï¼š**

```typescript
// ç¤ºä¾‹ï¼šapp/api/equipment/rental/admin/list/route.ts
const companyId = await getCurrentCompanyId(request)

if (companyId) {
  // ğŸ”’ å¼ºåˆ¶è¿‡æ»¤ï¼šåªè¿”å›å½“å‰ä¾›åº”å•†çš„è®¢å•
  query = query.eq("provider_id", companyId)
}
```

---

## 2. åç«¯æŸ¥è¯¢æ‹¦æˆªé€»è¾‘

### 2.1 æ ¸å¿ƒæ‹¦æˆªæ¨¡å—ï¼š`lib/multi-tenant.ts`

#### 2.1.1 `enforceCompanyFilter()` - å¼ºåˆ¶å…¬å¸è¿‡æ»¤

```typescript
/**
 * å¼ºåˆ¶åœ¨æŸ¥è¯¢ä¸­æ·»åŠ  company_id è¿‡æ»¤
 * @param query Supabase æŸ¥è¯¢å¯¹è±¡
 * @param companyId å…¬å¸ID
 * @param companyIdField å…¬å¸IDå­—æ®µåï¼ˆé»˜è®¤ï¼šprovider_idï¼‰
 */
export function enforceCompanyFilter(
  query: any,
  companyId: string | null,
  companyIdField: string = "provider_id"
): any {
  if (!companyId) {
    throw new Error(`ç¼ºå°‘ company_idï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢ã€‚å­—æ®µå: ${companyIdField}`)
  }

  return query.eq(companyIdField, companyId)
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```typescript
// app/api/equipment/rental/admin/list/route.ts
const companyId = await getCurrentCompanyId(request)

if (companyId) {
  // ğŸ”’ å¼ºåˆ¶è¿‡æ»¤ï¼šé˜²æ­¢è¶Šæƒè®¿é—®
  query = enforceCompanyFilter(query, companyId, "provider_id")
  console.log("[è®¾å¤‡ç§Ÿèµç®¡ç†API] åº”ç”¨å¤šç§Ÿæˆ·è¿‡æ»¤ï¼Œcompany_id:", companyId)
}
```

#### 2.1.2 `verifyCompanyAccess()` - éªŒè¯å…¬å¸è®¿é—®æƒé™

```typescript
/**
 * éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®æŒ‡å®šå…¬å¸çš„æ•°æ®
 */
export async function verifyCompanyAccess(
  userId: string,
  companyId: string
): Promise<boolean> {
  try {
    const supabaseClient = createClient(
      supabaseUrl,
      serviceRoleKey || anonKey!,
      {
        auth: {
          persistSession: false,
          autoRefreshToken: false,
        },
      }
    )

    // ä» user_companies è¡¨æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å±äºè¯¥å…¬å¸
    const { data, error } = await supabaseClient
      .from("user_companies")
      .select("company_id")
      .eq("user_id", userId)
      .eq("company_id", companyId)
      .single()

    return !error && !!data
  } catch (error) {
    console.error("[å¤šç§Ÿæˆ·] éªŒè¯å…¬å¸è®¿é—®æƒé™å¤±è´¥:", error)
    return false
  }
}
```

#### 2.1.3 `withCompanyFilter()` - å¤šç§Ÿæˆ·æŸ¥è¯¢åŒ…è£…å™¨

```typescript
/**
 * å¤šç§Ÿæˆ·æŸ¥è¯¢åŒ…è£…å™¨
 * è‡ªåŠ¨æ·»åŠ  company_id è¿‡æ»¤
 */
export function withCompanyFilter<T>(
  query: any,
  companyId: string | null,
  companyIdField: string = "provider_id"
): T {
  if (!companyId) {
    throw new Error("ç¼ºå°‘ company_idï¼ŒæŸ¥è¯¢è¢«æ‹’ç»")
  }
  return enforceCompanyFilter(query, companyId, companyIdField) as T
}
```

### 2.2 API è·¯ç”±ä¸­çš„å®é™…åº”ç”¨

#### 2.2.1 è®¾å¤‡ç§Ÿèµè®¢å•åˆ—è¡¨ API

**æ–‡ä»¶ï¼š** `app/api/equipment/rental/admin/list/route.ts`

```typescript
export async function GET(request: Request) {
  try {
    // 1. è·å–å½“å‰ç”¨æˆ·çš„å…¬å¸ID
    const companyId = searchParams.get("company_id") || 
                      await getCurrentCompanyId(request)

    // 2. æ„å»ºæŸ¥è¯¢
    let query = supabaseClient
      .from("rental_orders")
      .select(`
        *,
        equipment!equipment_id (...),
        restaurants!restaurant_id (...),
        companies!provider_id (...)
      `)

    // 3. ğŸ”’ å¤šç§Ÿæˆ·éš”ç¦»ï¼šå¼ºåˆ¶æŒ‰ provider_id è¿‡æ»¤
    if (companyId) {
      query = enforceCompanyFilter(query, companyId, "provider_id")
      console.log("[è®¾å¤‡ç§Ÿèµç®¡ç†API] åº”ç”¨å¤šç§Ÿæˆ·è¿‡æ»¤ï¼Œcompany_id:", companyId)
    }

    // 4. æ‰§è¡ŒæŸ¥è¯¢
    const { data: orders, error } = await query

    // 5. è¿”å›ç»“æœï¼ˆåªåŒ…å«å½“å‰ä¾›åº”å•†çš„è®¢å•ï¼‰
    return NextResponse.json({
      success: true,
      data: orders || []
    })
  } catch (error) {
    // é”™è¯¯å¤„ç†
  }
}
```

#### 2.2.2 åè®®ç®¡ç† API

**æ–‡ä»¶ï¼š** `app/api/agreements/route.ts`

```typescript
export async function GET(request: NextRequest) {
  try {
    // 1. è·å–ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆåŒ…å« role å’Œ companyIdï¼‰
    const userContext = await getUserContext(request)

    // 2. æ„å»ºæŸ¥è¯¢
    let query = supabaseClient
      .from("agreements")
      .select("*")
      .order("created_at", { ascending: false })

    // 3. ğŸ”’ å¤šç§Ÿæˆ·éš”ç¦»ï¼šæŒ‰ role å’Œ company_id è¿‡æ»¤
    if (userContext.role !== "super_admin" && userContext.role !== "admin") {
      if (userContext.companyId) {
        // æ™®é€šç”¨æˆ·ï¼šåªèƒ½æŸ¥çœ‹è‡ªå·±å…¬å¸çš„åè®®ï¼Œæˆ–è€…å¹³å°é€šç”¨åè®®ï¼ˆcompany_id IS NULLï¼‰
        query = query.or(`company_id.eq.${userContext.companyId},company_id.is.null`)
      } else {
        // å¦‚æœæ²¡æœ‰ companyIdï¼Œåªèƒ½æŸ¥çœ‹å¹³å°é€šç”¨åè®®
        query = query.is("company_id", null)
      }
    }
    // super_admin å’Œ admin å¯ä»¥æŸ¥çœ‹æ‰€æœ‰åè®®ï¼Œä¸éœ€è¦è¿‡æ»¤

    // 4. æ‰§è¡ŒæŸ¥è¯¢
    const { data, error } = await query

    // 5. è¿”å›ç»“æœ
    return NextResponse.json({
      success: true,
      data: data || []
    })
  } catch (error) {
    // é”™è¯¯å¤„ç†
  }
}
```

### 2.3 é˜²æ­¢è¶Šæƒè®¿é—®çš„æ£€æŸ¥ç‚¹

1. **API è·¯ç”±å…¥å£æ£€æŸ¥**
   - æ‰€æœ‰éœ€è¦æƒé™çš„ API å¿…é¡»è°ƒç”¨ `getUserContext(request)`
   - éªŒè¯ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
   - éªŒè¯ç”¨æˆ·è§’è‰²æ˜¯å¦å…è®¸è®¿é—®

2. **æŸ¥è¯¢å‰å¼ºåˆ¶è¿‡æ»¤**
   - ä½¿ç”¨ `enforceCompanyFilter()` å¼ºåˆ¶æ·»åŠ  `company_id` è¿‡æ»¤
   - é `super_admin` å’Œ `admin` è§’è‰²å¿…é¡»æä¾› `companyId`

3. **æ•°æ®å†™å…¥æ—¶éªŒè¯**
   - åˆ›å»ºè®¢å•æ—¶ï¼Œ`provider_id` å¿…é¡»ç­‰äº `userContext.companyId`
   - æ›´æ–°è®¢å•æ—¶ï¼ŒéªŒè¯è®¢å•çš„ `provider_id` æ˜¯å¦å±äºå½“å‰ç”¨æˆ·

---

## 3. ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆContextï¼‰å†…å®¹

### 3.1 UserContext æ¥å£å®šä¹‰

**æ–‡ä»¶ï¼š** `lib/auth/user-context.ts`

```typescript
export type UserRole = "super_admin" | "admin" | "staff" | "factory" | "filler"

export interface UserContext {
  userId: string        // ç”¨æˆ·IDï¼ˆæ¥è‡ª auth.users.idï¼‰
  role: UserRole        // ç”¨æˆ·è§’è‰²ï¼ˆæ¥è‡ª user_roles.roleï¼‰
  companyId?: string    // å…¬å¸IDï¼ˆæ¥è‡ª user_companies.company_idï¼Œsuper_admin ä¸º undefinedï¼‰
}
```

### 3.2 getUserContext() å‡½æ•°å®ç°

```typescript
/**
 * è·å–ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆå”¯ä¸€å¯ä¿¡çš„æƒé™å…¥å£ï¼‰
 * 
 * @param req NextRequest æˆ– Request å¯¹è±¡
 * @returns UserContext å¯¹è±¡ï¼ŒåŒ…å« userIdã€role å’Œå¯é€‰çš„ companyId
 * @throws å¦‚æœç”¨æˆ·æœªç™»å½•ã€æƒé™ä¸è¶³æˆ–é super_admin ç¼ºå°‘ company_idï¼Œä¼šæŠ›å‡ºé”™è¯¯
 */
export async function getUserContext(req: NextRequest | Request): Promise<UserContext> {
  // 1. ä» Supabase Auth session ä¸­è·å– userId
  const supabaseClient = createServerClient(...)
  const { data: { user }, error: authError } = await supabaseClient.auth.getUser()
  
  if (authError || !user) {
    throw new Error("ç”¨æˆ·æœªç™»å½•")
  }
  
  const userId = user.id

  // 2. ä» user_roles è¡¨è·å– role
  const adminClient = createClient(supabaseUrl, serviceRoleKey || anonKey, ...)
  const { data: roleData } = await adminClient
    .from("user_roles")
    .select("role")
    .eq("user_id", userId)
    .single()
  
  const role = roleData.role as UserRole

  // 3. å¦‚æœ role â‰  super_adminï¼Œå¿…é¡»ä» user_companies è·å– company_id
  if (role !== "super_admin") {
    const { data: companyData } = await adminClient
      .from("user_companies")
      .select("company_id")
      .eq("user_id", userId)
      .eq("is_primary", true)
      .single()

    let companyId: string | undefined
    if (companyData) {
      companyId = companyData.company_id
    } else {
      // å¦‚æœæ²¡æœ‰ä¸»å…¬å¸ï¼Œå°è¯•è·å–ç¬¬ä¸€ä¸ªå…¬å¸
      const { data: firstCompany } = await adminClient
        .from("user_companies")
        .select("company_id")
        .eq("user_id", userId)
        .limit(1)
        .single()
      
      companyId = firstCompany?.company_id
    }

    // å¦‚æœæŸ¥ä¸åˆ° company_idï¼Œç›´æ¥æŠ›å‡ºé”™è¯¯
    if (!companyId) {
      throw new Error("æƒé™ä¸è¶³ï¼šç”¨æˆ·æœªå…³è”ä»»ä½•å…¬å¸")
    }

    return {
      userId,
      role,
      companyId,
    }
  }

  // 4. super_admin å…è®¸ companyId ä¸º undefined
  return {
    userId,
    role,
    companyId: undefined,
  }
}
```

### 3.3 UserContext å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | æ¥æº |
|------|------|------|------|
| `userId` | `string` | ç”¨æˆ·å”¯ä¸€æ ‡è¯†ç¬¦ | `auth.users.id` |
| `role` | `UserRole` | ç”¨æˆ·è§’è‰² | `user_roles.role` |
| `companyId` | `string \| undefined` | å…¬å¸IDï¼ˆsuper_admin ä¸º undefinedï¼‰ | `user_companies.company_id` |

### 3.4 è§’è‰²æƒé™çŸ©é˜µ

| è§’è‰² | companyId | æ•°æ®è®¿é—®èŒƒå›´ | è¯´æ˜ |
|------|-----------|--------------|------|
| `super_admin` | `undefined` | æ‰€æœ‰æ•°æ® | ç³»ç»Ÿè¶…çº§ç®¡ç†å‘˜ï¼Œå¯ä»¥è®¿é—®æ‰€æœ‰å…¬å¸çš„æ•°æ® |
| `admin` | `string` | æ‰€æœ‰æ•°æ® | å¹³å°ç®¡ç†å‘˜ï¼Œå¯ä»¥è®¿é—®æ‰€æœ‰å…¬å¸çš„æ•°æ® |
| `staff` | `string` | ä»…è‡ªå·±å…¬å¸çš„æ•°æ® | å…¬å¸å‘˜å·¥ï¼Œåªèƒ½è®¿é—®è‡ªå·±å…¬å¸çš„æ•°æ® |
| `factory` | `string` | ä»…è‡ªå·±å…¬å¸çš„æ•°æ® | å·¥å‚ç”¨æˆ·ï¼Œåªèƒ½è®¿é—®è‡ªå·±å…¬å¸çš„æ•°æ® |
| `filler` | `string` | ä»…è‡ªå·±å…¬å¸çš„æ•°æ® | å¡«å……å‘˜ï¼Œåªèƒ½è®¿é—®è‡ªå·±å…¬å¸çš„æ•°æ® |

### 3.5 ä½¿ç”¨ç¤ºä¾‹

```typescript
// åœ¨ API è·¯ç”±ä¸­ä½¿ç”¨
export async function GET(request: NextRequest) {
  try {
    // è·å–ç”¨æˆ·ä¸Šä¸‹æ–‡
    const userContext = await getUserContext(request)
    
    console.log("ç”¨æˆ·ID:", userContext.userId)
    console.log("ç”¨æˆ·è§’è‰²:", userContext.role)
    console.log("å…¬å¸ID:", userContext.companyId)
    
    // æ ¹æ®è§’è‰²å’Œå…¬å¸IDè¿›è¡Œæ•°æ®è¿‡æ»¤
    if (userContext.role === "super_admin" || userContext.role === "admin") {
      // ç®¡ç†å‘˜ï¼šå¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ•°æ®
      query = supabaseClient.from("orders").select("*")
    } else if (userContext.companyId) {
      // æ™®é€šç”¨æˆ·ï¼šåªèƒ½æŸ¥çœ‹è‡ªå·±å…¬å¸çš„æ•°æ®
      query = supabaseClient
        .from("orders")
        .select("*")
        .eq("provider_id", userContext.companyId)
    } else {
      throw new Error("æƒé™ä¸è¶³ï¼šç”¨æˆ·æœªå…³è”ä»»ä½•å…¬å¸")
    }
    
    // æ‰§è¡ŒæŸ¥è¯¢...
  } catch (error) {
    // é”™è¯¯å¤„ç†
  }
}
```

---

## 4. æ•°æ®åº“ RLS ç­–ç•¥å®šä¹‰

### 4.1 agreements è¡¨ RLS ç­–ç•¥

**æ–‡ä»¶ï¼š** `migrations/20250125_agreements_company_isolation_rls.sql`

#### 4.1.1 æ¨èæ–¹æ¡ˆï¼šä½¿ç”¨ user_companies è¡¨ï¼ˆæ•°æ®åº“å±‚éš”ç¦»ï¼‰

```sql
-- å¯ç”¨ RLS
ALTER TABLE agreements ENABLE ROW LEVEL SECURITY;

-- ç­–ç•¥1ï¼šSELECT - ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±å…¬å¸çš„åè®®æˆ–å¹³å°é€šç”¨åè®®
CREATE POLICY "agreements_company_isolation_select"
ON agreements
FOR SELECT
TO authenticated
USING (
  -- æ¡ä»¶ 1ï¼šåè®®å±äºç”¨æˆ·æ‰€åœ¨çš„å…¬å¸
  company_id IN (
    SELECT company_id 
    FROM user_companies 
    WHERE user_id = auth.uid()
  )
  OR
  -- æ¡ä»¶ 2ï¼šå¹³å°é€šç”¨åè®®ï¼ˆcompany_id IS NULLï¼‰
  company_id IS NULL
);

-- ç­–ç•¥2ï¼šINSERT - ç”¨æˆ·åªèƒ½åˆ›å»ºè‡ªå·±å…¬å¸çš„åè®®æˆ–å¹³å°é€šç”¨åè®®
CREATE POLICY "agreements_company_isolation_insert"
ON agreements
FOR INSERT
TO authenticated
WITH CHECK (
  company_id IN (
    SELECT company_id 
    FROM user_companies 
    WHERE user_id = auth.uid()
  )
  OR
  company_id IS NULL
);

-- ç­–ç•¥3ï¼šUPDATE - ç”¨æˆ·åªèƒ½æ›´æ–°è‡ªå·±å…¬å¸çš„åè®®æˆ–å¹³å°é€šç”¨åè®®
CREATE POLICY "agreements_company_isolation_update"
ON agreements
FOR UPDATE
TO authenticated
USING (
  company_id IN (
    SELECT company_id 
    FROM user_companies 
    WHERE user_id = auth.uid()
  )
  OR
  company_id IS NULL
)
WITH CHECK (
  company_id IN (
    SELECT company_id 
    FROM user_companies 
    WHERE user_id = auth.uid()
  )
  OR
  company_id IS NULL
);

-- ç­–ç•¥4ï¼šDELETE - ç”¨æˆ·åªèƒ½åˆ é™¤è‡ªå·±å…¬å¸çš„åè®®æˆ–å¹³å°é€šç”¨åè®®
CREATE POLICY "agreements_company_isolation_delete"
ON agreements
FOR DELETE
TO authenticated
USING (
  company_id IN (
    SELECT company_id 
    FROM user_companies 
    WHERE user_id = auth.uid()
  )
  OR
  company_id IS NULL
);

-- ç­–ç•¥5ï¼šæœåŠ¡è§’è‰²å®Œå…¨è®¿é—®ï¼ˆAPI è·¯ç”±ä½¿ç”¨ serviceRoleKey æ—¶ç»•è¿‡ RLSï¼‰
CREATE POLICY "Service role full access to agreements"
  ON agreements
  FOR ALL
  TO service_role
  USING (true)
  WITH CHECK (true);
```

**è¯´æ˜ï¼š**
- âœ… **æ•°æ®åº“å±‚éš”ç¦»**ï¼šç›´æ¥åœ¨ RLS ç­–ç•¥ä¸­é€šè¿‡ `user_companies` è¡¨æŸ¥è¯¢ç”¨æˆ·çš„ `company_id`
- âœ… **æ— éœ€è®¾ç½® session variable**ï¼šä½¿ç”¨ `auth.uid()` ç›´æ¥æŸ¥è¯¢ï¼Œæ›´å¯é 
- âœ… **æ”¯æŒå¹³å°é€šç”¨åè®®**ï¼š`company_id IS NULL` çš„åè®®æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥è®¿é—®
- âœ… **å®Œæ•´çš„ CRUD æ“ä½œ**ï¼šSELECTã€INSERTã€UPDATEã€DELETE éƒ½æœ‰å¯¹åº”çš„ç­–ç•¥

#### 4.1.2 å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨ current_settingï¼ˆéœ€è¦åº”ç”¨å±‚è®¾ç½®ï¼‰

```sql
-- æ³¨æ„ï¼šæ­¤æ–¹æ¡ˆéœ€è¦åœ¨æŸ¥è¯¢å‰è®¾ç½® session variable
-- ä½¿ç”¨æ–¹å¼ï¼šSET LOCAL app.current_company_id = 'company-uuid';

CREATE POLICY "agreements_company_isolation"
ON agreements
FOR SELECT
TO authenticated
USING (
  company_id = current_setting('app.current_company_id', true)::uuid
  OR
  company_id IS NULL
);
```

**è¯´æ˜ï¼š**
- âš ï¸ **éœ€è¦åº”ç”¨å±‚é…åˆ**ï¼šåœ¨æ¯æ¬¡æŸ¥è¯¢å‰éœ€è¦æ‰§è¡Œ `SET LOCAL app.current_company_id = 'company-uuid'`
- âš ï¸ **ä¾èµ– session variable**ï¼šå¦‚æœæœªè®¾ç½®æˆ–è®¾ç½®é”™è¯¯ï¼Œå¯èƒ½å¯¼è‡´æŸ¥è¯¢å¤±è´¥
- âœ… **æ€§èƒ½æ›´å¥½**ï¼šå¦‚æœæ­£ç¡®è®¾ç½®ï¼ŒæŸ¥è¯¢æ€§èƒ½å¯èƒ½ç•¥å¥½äºå­æŸ¥è¯¢æ–¹æ¡ˆ

**æ¨èä½¿ç”¨æ–¹æ¡ˆ 1ï¼ˆuser_companies è¡¨ï¼‰ï¼Œå› ä¸ºï¼š**
1. ä¸éœ€è¦åº”ç”¨å±‚é¢å¤–è®¾ç½®
2. æ›´å¯é ï¼Œä¸ä¾èµ– session variable
3. ç¬¦åˆ Supabase RLS æœ€ä½³å®è·µ

### 4.2 rental_orders è¡¨ RLS ç­–ç•¥

**æ–‡ä»¶ï¼š** `å¤šç§Ÿæˆ·RLSç­–ç•¥.sql`

```sql
-- å¯ç”¨ RLS
ALTER TABLE rental_orders ENABLE ROW LEVEL SECURITY;

-- ç­–ç•¥1ï¼šä¾›åº”å•†åªèƒ½çœ‹åˆ°è‡ªå·±çš„è®¢å•
DROP POLICY IF EXISTS "Providers can only see their own rental orders" ON rental_orders;
CREATE POLICY "Providers can only see their own rental orders"
  ON rental_orders
  FOR SELECT
  TO authenticated
  USING (
    -- æ–¹æ¡ˆ1ï¼šå¦‚æœ users è¡¨æœ‰ company_id å­—æ®µ
    -- provider_id IN (SELECT company_id FROM users WHERE id = auth.uid())
    
    -- æ–¹æ¡ˆ2ï¼šå¦‚æœæœ‰ user_companies å…³è”è¡¨
    provider_id IN (
      SELECT company_id 
      FROM user_companies 
      WHERE user_id = auth.uid()
    )
    
    -- æ–¹æ¡ˆ3ï¼šä¸´æ—¶æ–¹æ¡ˆ - é€šè¿‡ RLS å‡½æ•°æ£€æŸ¥ï¼ˆéœ€è¦å®ç°ï¼‰
    -- ç›®å‰å…ˆå…è®¸æ‰€æœ‰è®¤è¯ç”¨æˆ·æŸ¥çœ‹ï¼Œç”±åº”ç”¨å±‚è¿‡æ»¤
    -- true -- âš ï¸ ä¸´æ—¶ï¼šéœ€è¦æ ¹æ®å®é™…ç”¨æˆ·è¡¨ç»“æ„è°ƒæ•´
  );
```

**è¯´æ˜ï¼š**
- å½“å‰ç­–ç•¥ä½¿ç”¨ `user_companies` è¡¨è¿›è¡Œå…³è”æŸ¥è¯¢
- å¦‚æœ `user_companies` è¡¨ä¸å­˜åœ¨æˆ–æŸ¥è¯¢å¤±è´¥ï¼Œç­–ç•¥ä¼šå›é€€åˆ°åº”ç”¨å±‚è¿‡æ»¤
- å»ºè®®ï¼šå®Œå–„ RLS ç­–ç•¥ï¼Œç¡®ä¿æ•°æ®åº“å±‚é¢çš„æ•°æ®éš”ç¦»

### 4.3 user_companies è¡¨ RLS ç­–ç•¥

**æ–‡ä»¶ï¼š** `ä¿®å¤å¤šç§Ÿæˆ·å®‰å…¨æ¼æ´_å®Œæ•´SQLè„šæœ¬.sql`

```sql
-- å¯ç”¨ RLS
ALTER TABLE user_companies ENABLE ROW LEVEL SECURITY;

-- ç­–ç•¥1ï¼šæœåŠ¡è§’è‰²å®Œå…¨è®¿é—®
DROP POLICY IF EXISTS "Service role full access to user companies" ON user_companies;
CREATE POLICY "Service role full access to user companies"
  ON user_companies
  FOR ALL
  TO service_role
  USING (true)
  WITH CHECK (true);

-- ç­–ç•¥2ï¼šç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„å…¬å¸å…³è”
DROP POLICY IF EXISTS "Users can view their own company associations" ON user_companies;
CREATE POLICY "Users can view their own company associations"
  ON user_companies
  FOR SELECT
  TO authenticated
  USING (user_id = auth.uid());

-- ç­–ç•¥3ï¼šç”¨æˆ·åªèƒ½æ’å…¥è‡ªå·±çš„å…¬å¸å…³è”
DROP POLICY IF EXISTS "Users can insert their own company associations" ON user_companies;
CREATE POLICY "Users can insert their own company associations"
  ON user_companies
  FOR INSERT
  TO authenticated
  WITH CHECK (user_id = auth.uid());
```

**è¯´æ˜ï¼š**
- ç”¨æˆ·åªèƒ½æŸ¥çœ‹å’Œåˆ›å»ºè‡ªå·±çš„å…¬å¸å…³è”è®°å½•
- `service_role` ç­–ç•¥å…è®¸ API ä½¿ç”¨ `serviceRoleKey` è¿›è¡Œç®¡ç†æ“ä½œ

### 4.4 RLS ç­–ç•¥æ€»ç»“

| è¡¨å | RLS çŠ¶æ€ | ç­–ç•¥ç±»å‹ | æ•°æ®éš”ç¦»æ–¹å¼ |
|------|----------|----------|--------------|
| `agreements` | âœ… å·²å¯ç”¨ | **æ•°æ®åº“å±‚éš”ç¦»** | é€šè¿‡ `user_companies` è¡¨æŸ¥è¯¢ `company_id` |
| `rental_orders` | âœ… å·²å¯ç”¨ | æ•°æ®åº“å±‚ + åº”ç”¨å±‚ | é€šè¿‡ `provider_id` å­—æ®µè¿‡æ»¤ |
| `user_companies` | âœ… å·²å¯ç”¨ | æ•°æ®åº“å±‚ | é€šè¿‡ `user_id = auth.uid()` è¿‡æ»¤ |
| `companies` | âœ… å·²å¯ç”¨ | åº”ç”¨å±‚è¿‡æ»¤ | é€šè¿‡ `id` å­—æ®µè¿‡æ»¤ |

---

## 5. æ•°æ®éš”ç¦»æµç¨‹å›¾

### 5.1 ç”¨æˆ·ç™»å½•åˆ°æ•°æ®è®¿é—®æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ç™»å½•   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ getUserContext()     â”‚
â”‚ 1. ä» cookies è·å–   â”‚
â”‚    Supabase session  â”‚
â”‚ 2. æŸ¥è¯¢ user_roles   â”‚
â”‚    è·å– role         â”‚
â”‚ 3. æŸ¥è¯¢ user_companiesâ”‚
â”‚    è·å– companyId    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UserContext å¯¹è±¡   â”‚
â”‚ {                   â”‚
â”‚   userId: "...",    â”‚
â”‚   role: "staff",    â”‚
â”‚   companyId: "..."  â”‚
â”‚ }                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API è·¯ç”±å¤„ç†       â”‚
â”‚ 1. æ£€æŸ¥ role        â”‚
â”‚ 2. æ£€æŸ¥ companyId   â”‚
â”‚ 3. æ„å»ºæŸ¥è¯¢         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ enforceCompanyFilterâ”‚
â”‚ å¼ºåˆ¶æ·»åŠ è¿‡æ»¤æ¡ä»¶    â”‚
â”‚ .eq("provider_id",  â”‚
â”‚     companyId)      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢     â”‚
â”‚  (åªè¿”å›å½“å‰å…¬å¸    â”‚
â”‚   çš„æ•°æ®)          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿”å›ç»“æœç»™å‰ç«¯     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»æ£€æŸ¥ç‚¹

```
è¯·æ±‚åˆ°è¾¾ API è·¯ç”±
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€æŸ¥ç‚¹ 1:           â”‚
â”‚ ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼Ÿ    â”‚
â”‚ (getUserContext)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ âœ… æ˜¯
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€æŸ¥ç‚¹ 2:           â”‚
â”‚ ç”¨æˆ·æ˜¯å¦æœ‰ roleï¼Ÿ   â”‚
â”‚ (user_roles è¡¨)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ âœ… æ˜¯
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€æŸ¥ç‚¹ 3:           â”‚
â”‚ ç”¨æˆ·æ˜¯å¦æœ‰ companyId?â”‚
â”‚ (user_companies è¡¨) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ âœ… æ˜¯
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€æŸ¥ç‚¹ 4:           â”‚
â”‚ æŸ¥è¯¢æ˜¯å¦æ·»åŠ äº†      â”‚
â”‚ company_id è¿‡æ»¤ï¼Ÿ   â”‚
â”‚ (enforceCompanyFilter)â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ âœ… æ˜¯
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€æŸ¥ç‚¹ 5:           â”‚
â”‚ RLS ç­–ç•¥æ˜¯å¦ç”Ÿæ•ˆï¼Ÿ  â”‚
â”‚ (æ•°æ®åº“å±‚è¿‡æ»¤)      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ âœ… æ˜¯
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿”å›æ•°æ®            â”‚
â”‚ (ä»…å½“å‰å…¬å¸çš„æ•°æ®)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. å®‰å…¨æœºåˆ¶æ€»ç»“

### 6.1 å¤šå±‚é˜²æŠ¤æœºåˆ¶

| å±‚çº§ | æœºåˆ¶ | å®ç°ä½ç½® | è¯´æ˜ |
|------|------|----------|------|
| **ç¬¬1å±‚ï¼šè®¤è¯å±‚** | Supabase Auth | `getUserContext()` | éªŒè¯ç”¨æˆ·æ˜¯å¦å·²ç™»å½• |
| **ç¬¬2å±‚ï¼šæˆæƒå±‚** | è§’è‰²æ£€æŸ¥ | `getUserContext()` | éªŒè¯ç”¨æˆ·è§’è‰²å’Œå…¬å¸å…³è” |
| **ç¬¬3å±‚ï¼šåº”ç”¨å±‚** | æŸ¥è¯¢è¿‡æ»¤ | `enforceCompanyFilter()` | å¼ºåˆ¶æ·»åŠ  `company_id` è¿‡æ»¤ |
| **ç¬¬4å±‚ï¼šæ•°æ®åº“å±‚** | RLS ç­–ç•¥ | PostgreSQL RLS | æ•°æ®åº“å±‚é¢çš„æ•°æ®éš”ç¦» |

### 6.2 é˜²æ­¢è¶Šæƒè®¿é—®çš„å…³é”®ä»£ç 

#### 6.2.1 è®¢å•åˆ—è¡¨æŸ¥è¯¢ï¼ˆé˜²æ­¢ä¾›åº”å•†æŸ¥çœ‹å…¶ä»–ä¾›åº”å•†çš„è®¢å•ï¼‰

```typescript
// app/api/equipment/rental/admin/list/route.ts
const companyId = await getCurrentCompanyId(request)

if (companyId) {
  // ğŸ”’ å¼ºåˆ¶è¿‡æ»¤ï¼šé˜²æ­¢è¶Šæƒè®¿é—®
  query = enforceCompanyFilter(query, companyId, "provider_id")
  // ç­‰ä»·äºï¼šquery = query.eq("provider_id", companyId)
}
```

#### 6.2.2 åè®®ç®¡ç†æŸ¥è¯¢ï¼ˆé˜²æ­¢ç”¨æˆ·æŸ¥çœ‹å…¶ä»–å…¬å¸çš„åè®®ï¼‰

```typescript
// app/api/agreements/route.ts
const userContext = await getUserContext(request)

if (userContext.role !== "super_admin" && userContext.role !== "admin") {
  if (userContext.companyId) {
    // æ™®é€šç”¨æˆ·ï¼šåªèƒ½æŸ¥çœ‹è‡ªå·±å…¬å¸çš„åè®®ï¼Œæˆ–è€…å¹³å°é€šç”¨åè®®
    query = query.or(`company_id.eq.${userContext.companyId},company_id.is.null`)
  } else {
    // å¦‚æœæ²¡æœ‰ companyIdï¼Œåªèƒ½æŸ¥çœ‹å¹³å°é€šç”¨åè®®
    query = query.is("company_id", null)
  }
}
```

### 6.3 å®‰å…¨æœ€ä½³å®è·µ

1. **ç»Ÿä¸€ä½¿ç”¨ `getUserContext()`**
   - æ‰€æœ‰ API è·¯ç”±å¿…é¡»é€šè¿‡ `getUserContext()` è·å–ç”¨æˆ·ä¸Šä¸‹æ–‡
   - ç¦æ­¢ç›´æ¥æŸ¥è¯¢ `user_roles` æˆ– `user_companies` è¡¨

2. **å¼ºåˆ¶æ•°æ®è¿‡æ»¤**
   - æ‰€æœ‰æŸ¥è¯¢å¿…é¡»ä½¿ç”¨ `enforceCompanyFilter()` æ·»åŠ  `company_id` è¿‡æ»¤
   - é `super_admin` å’Œ `admin` è§’è‰²å¿…é¡»æä¾› `companyId`

3. **æ•°æ®åº“å±‚ RLS ç­–ç•¥**
   - å¯ç”¨ RLS ä½œä¸ºæœ€åä¸€é“é˜²çº¿
   - å³ä½¿åº”ç”¨å±‚è¿‡æ»¤å¤±è´¥ï¼Œæ•°æ®åº“å±‚ä¹Ÿèƒ½é˜»æ­¢è¶Šæƒè®¿é—®

4. **æ—¥å¿—å’Œå®¡è®¡**
   - è®°å½•æ‰€æœ‰æ•°æ®è®¿é—®æ“ä½œ
   - è®°å½•ç”¨æˆ·ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆuserId, role, companyIdï¼‰

---

## ğŸ“ é™„å½•

### A. ç›¸å…³æ–‡ä»¶æ¸…å•

#### æ ¸å¿ƒæ¨¡å—
- `lib/auth/user-context.ts` - ç”¨æˆ·ä¸Šä¸‹æ–‡è§£ææ¨¡å—
- `lib/multi-tenant.ts` - å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»å·¥å…·

#### API è·¯ç”±ç¤ºä¾‹
- `app/api/agreements/route.ts` - åè®®ç®¡ç† API
- `app/api/equipment/rental/admin/list/route.ts` - è®¾å¤‡ç§Ÿèµè®¢å•åˆ—è¡¨ API

#### æ•°æ®åº“è¿ç§»æ–‡ä»¶
- `migrations/20250125_complete_agreements_setup.sql` - åè®®è¡¨ RLS ç­–ç•¥
- `ä¿®å¤å¤šç§Ÿæˆ·å®‰å…¨æ¼æ´_å®Œæ•´SQLè„šæœ¬.sql` - user_companies è¡¨åˆ›å»ºå’Œ RLS ç­–ç•¥
- `å¤šç§Ÿæˆ·RLSç­–ç•¥.sql` - rental_orders è¡¨ RLS ç­–ç•¥

### B. å…³é”® SQL æŸ¥è¯¢ç¤ºä¾‹

#### æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰å…¬å¸
```sql
SELECT 
  uc.*,
  c.name as company_name,
  c.status as company_status
FROM user_companies uc
JOIN companies c ON uc.company_id = c.id
WHERE uc.user_id = 'user-uuid'
ORDER BY uc.is_primary DESC, uc.created_at DESC;
```

#### æŸ¥è¯¢ä¾›åº”å•†çš„æ‰€æœ‰è®¢å•
```sql
SELECT 
  ro.*,
  e.name as equipment_name,
  r.name as restaurant_name
FROM rental_orders ro
LEFT JOIN equipment e ON ro.equipment_id = e.id
LEFT JOIN restaurants r ON ro.restaurant_id = r.id
WHERE ro.provider_id = 'company-uuid'
ORDER BY ro.created_at DESC;
```

#### æŸ¥è¯¢ç”¨æˆ·å¯è®¿é—®çš„åè®®
```sql
SELECT *
FROM agreements
WHERE company_id = 'company-uuid' 
   OR company_id IS NULL  -- å¹³å°é€šç”¨åè®®
ORDER BY created_at DESC;
```

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š** 2025-01-25  
**ç‰ˆæœ¬ï¼š** 1.0  
**ç»´æŠ¤è€…ï¼š** ç³»ç»Ÿæ¶æ„å›¢é˜Ÿ
