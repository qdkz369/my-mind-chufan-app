# å¼‚å¸¸å¤„ç†ç°çŠ¶è¯´æ˜

> æ›´æ–°æ—¶é—´ï¼š2025-01-25

---

## ğŸ“Š æ•´ä½“ç»“è®º

| å¼‚å¸¸åœºæ™¯ | æ•°æ®å­˜å‚¨ | çŠ¶æ€å­—æ®µ | å¤„ç†æµç¨‹ | è‡ªåŠ¨åŒ–ç¨‹åº¦ |
|---------|---------|---------|---------|-----------|
| **è®¾å¤‡æŸå** | âœ… è¡¨ç»“æ„å®Œæ•´ | âœ… å­—æ®µå®Œæ•´ | âŒ **æ— API** | 0% |
| **è®¾å¤‡æœªå½’è¿˜** | âš ï¸ éƒ¨åˆ†æ”¯æŒ | âš ï¸ å‰ç«¯åˆ¤æ–­ | âŒ **æ— æµç¨‹** | 0% |
| **å•†æˆ·ä¸ä»˜è´¹** | âœ… è¡¨ç»“æ„å®Œæ•´ | âœ… çŠ¶æ€å­—æ®µ | âŒ **æ— è‡ªåŠ¨åŒ–** | 0% |

---

## 1ï¸âƒ£ è®¾å¤‡æŸåå¤„ç†ç°çŠ¶

### âœ… å·²å®ç°ï¼šæ•°æ®è¡¨ç»“æ„ï¼ˆ100%ï¼‰

#### 1.1 è¡¨ç»“æ„æ”¯æŒ

**`rental_records` è¡¨**ï¼ˆè®¾å¤‡ç§Ÿèµè®°å½•è¡¨ï¼‰ï¼š
```sql
CREATE TABLE rental_records (
  id UUID PRIMARY KEY,
  rental_order_id UUID REFERENCES rental_orders(id),
  equipment_id UUID REFERENCES equipment(id),
  restaurant_id UUID NOT NULL,
  status VARCHAR(20) DEFAULT 'active',
  -- status å€¼ï¼š'active', 'returned', 'damaged', 'lost'
  
  actual_start_date DATE,
  actual_end_date DATE,
  
  return_condition VARCHAR(50),
  -- return_condition å€¼ï¼š'good', 'normal_wear', 'damaged', 'lost'
  
  damage_fee DECIMAL(10, 2) DEFAULT 0,  -- æŸåèµ”å¿è´¹ç”¨
  notes TEXT,
  ...
);
```

**å­—æ®µè¯´æ˜**ï¼š
- âœ… `status = 'damaged'`ï¼šæ ‡è®°è®¾å¤‡æŸåçŠ¶æ€
- âœ… `return_condition = 'damaged'`ï¼šè®°å½•å½’è¿˜æ—¶è®¾å¤‡æŸå
- âœ… `damage_fee`ï¼šè®°å½•æŸåèµ”å¿è´¹ç”¨
- âœ… `notes`ï¼šè®°å½•æŸåè¯¦æƒ…

---

### âŒ æœªå®ç°ï¼šå¤„ç†æµç¨‹ï¼ˆ0%ï¼‰

#### 1.2 ç¼ºå¤±å†…å®¹

**é—®é¢˜ 1ï¼šæ²¡æœ‰è®¾å¤‡æŸåä¸ŠæŠ¥ API**
- âŒ æ²¡æœ‰ `POST /api/equipment/rental/damage/report` æ¥å£
- âŒ æ— æ³•é€šè¿‡APIè®°å½•è®¾å¤‡æŸåæƒ…å†µ
- âŒ æ— æ³•æ›´æ–° `rental_records` è¡¨

**é—®é¢˜ 2ï¼šæ²¡æœ‰æŸåèµ”å¿è®¡ç®— API**
- âŒ æ²¡æœ‰è‡ªåŠ¨è®¡ç®—èµ”å¿è´¹ç”¨çš„é€»è¾‘
- âŒ `damage_fee` å­—æ®µéœ€è¦æ‰‹åŠ¨å¡«å†™
- âŒ æ²¡æœ‰æŸåç¨‹åº¦è¯„ä¼°æœºåˆ¶

**é—®é¢˜ 3ï¼šæ²¡æœ‰æŸåå¤„ç†æµç¨‹**
- âŒ è®¢å•é€€ç§Ÿæ—¶æ²¡æœ‰è®¾å¤‡æ£€æŸ¥æµç¨‹
- âŒ æ²¡æœ‰æŸåè®°å½•å…³è”åˆ°è®¢å•é€€ç§Ÿ
- âŒ æ²¡æœ‰æŸåèµ”å¿æ”¯ä»˜æµç¨‹

---

### ğŸ“‹ å½“å‰å¤„ç†æ–¹å¼ï¼ˆæ¨æµ‹ï¼‰

**ç°çŠ¶**ï¼š
1. **æ•°æ®åº“å±‚é¢**ï¼šè¡¨ç»“æ„å·²å‡†å¤‡å¥½ï¼Œä½†**æ²¡æœ‰å¯¹åº”çš„API**
2. **ä¸šåŠ¡å±‚é¢**ï¼šå¯èƒ½éœ€è¦**æ‰‹åŠ¨æ“ä½œæ•°æ®åº“**æˆ–é€šè¿‡**ç®¡ç†åå°æ‰‹åŠ¨è®°å½•**
3. **èµ”å¿è®¡ç®—**ï¼šéœ€è¦**äººå·¥è®¡ç®—**åæ‰‹åŠ¨æ›´æ–° `damage_fee` å­—æ®µ

---

### ğŸ’¡ å»ºè®®å®ç°æ–¹æ¡ˆ

**éœ€è¦åˆ›å»ºçš„ API**ï¼š

1. **è®¾å¤‡æŸåä¸ŠæŠ¥ API**
   ```
   POST /api/equipment/rental/damage/report
   {
     "rental_order_id": "uuid",
     "equipment_id": "uuid",
     "damage_type": "è½»å¾®æŸå/ä¸¥é‡æŸå/å®Œå…¨æŸå",
     "damage_description": "æŸåæè¿°",
     "damage_photos": ["url1", "url2"],
     "estimated_fee": 1000.00  // é¢„ä¼°èµ”å¿é‡‘é¢
   }
   ```
   - æ›´æ–° `rental_records.status = 'damaged'`
   - æ›´æ–° `rental_records.return_condition = 'damaged'`
   - è®°å½• `damage_fee` å’Œ `notes`

2. **è®¾å¤‡å½’è¿˜æ£€æŸ¥ API**ï¼ˆé€€ç§Ÿæ—¶ï¼‰
   ```
   POST /api/equipment/rental/return/check
   {
     "rental_order_id": "uuid",
     "return_condition": "good/damaged/lost",
     "damage_fee": 1000.00,
     "return_photos": ["url1", "url2"]
   }
   ```
   - æ£€æŸ¥è®¾å¤‡çŠ¶æ€
   - å¦‚æœæœ‰æŸåï¼Œåˆ›å»º `rental_records` è®°å½•
   - è®¡ç®—èµ”å¿è´¹ç”¨

---

## 2ï¸âƒ£ è®¾å¤‡æœªå½’è¿˜å¤„ç†ç°çŠ¶

### âš ï¸ éƒ¨åˆ†å®ç°ï¼šå‰ç«¯åˆ¤æ–­ï¼ˆ30%ï¼‰

#### 2.1 å‰ç«¯é€¾æœŸåˆ¤æ–­

**ä»£ç ä½ç½®**ï¼š`app/devices/page.tsx`

```typescript
// åˆ¤æ–­æ˜¯å¦é€¾æœŸï¼ˆå¦‚æœåˆåŒå­˜åœ¨ä¸”ç»“æŸæ—¥æœŸå·²è¿‡ï¼‰
const isOverdue = contract && contract.end_at 
  ? new Date(contract.end_at) < new Date()
  : false
```

**åŠŸèƒ½**ï¼š
- âœ… å‰ç«¯å¯ä»¥æ˜¾ç¤ºè®¾å¤‡æ˜¯å¦é€¾æœŸ
- âœ… UIå±•ç¤ºé€¾æœŸæ ‡è¯†ï¼ˆ`is_overdue`ï¼‰

---

### âŒ æœªå®ç°ï¼šåç«¯å¤„ç†ï¼ˆ0%ï¼‰

#### 2.2 ç¼ºå¤±å†…å®¹

**é—®é¢˜ 1ï¼šæ²¡æœ‰è‡ªåŠ¨æ£€æµ‹æœºåˆ¶**
- âŒ æ²¡æœ‰å®šæ—¶ä»»åŠ¡æ£€æŸ¥é€¾æœŸè®¾å¤‡
- âŒ æ²¡æœ‰è‡ªåŠ¨æ›´æ–°è®¢å•çŠ¶æ€ä¸º"é€¾æœŸ"
- âŒ æ²¡æœ‰è‡ªåŠ¨æ ‡è®° `rental_records.status = 'lost'`

**é—®é¢˜ 2ï¼šæ²¡æœ‰å‚¬æ”¶æµç¨‹**
- âŒ æ²¡æœ‰å‚¬æ”¶é€šçŸ¥API
- âŒ æ²¡æœ‰å‚¬æ”¶è®°å½•è¡¨
- âŒ æ²¡æœ‰è‡ªåŠ¨å‘é€å‚¬æ”¶æé†’ï¼ˆçŸ­ä¿¡/é‚®ä»¶/ç«™å†…ä¿¡ï¼‰

**é—®é¢˜ 3ï¼šæ²¡æœ‰å½’è¿˜æé†’**
- âŒ æ²¡æœ‰å½’è¿˜æé†’API
- âŒ æ²¡æœ‰åˆ°æœŸå‰æé†’åŠŸèƒ½
- âŒ æ²¡æœ‰è¶…æœŸæé†’åŠŸèƒ½

**é—®é¢˜ 4ï¼šæ²¡æœ‰å¼ºåˆ¶å½’è¿˜æµç¨‹**
- âŒ æ²¡æœ‰æ ‡è®°è®¾å¤‡ä¸º"æœªå½’è¿˜"
- âŒ æ²¡æœ‰è§¦å‘æ³•å¾‹ç¨‹åºçš„æ ‡è®°
- âŒ æ²¡æœ‰è®¾å¤‡ä¸¢å¤±å¤„ç†æµç¨‹

---

### ğŸ“‹ å½“å‰å¤„ç†æ–¹å¼ï¼ˆæ¨æµ‹ï¼‰

**ç°çŠ¶**ï¼š
1. **å‰ç«¯å±•ç¤º**ï¼šå‰ç«¯å¯ä»¥æ˜¾ç¤ºé€¾æœŸçŠ¶æ€ï¼Œä½†**ä»…ç”¨äºå±•ç¤º**
2. **ä¸šåŠ¡å±‚é¢**ï¼šéœ€è¦**äººå·¥æ£€æŸ¥**å“ªäº›è®¾å¤‡é€¾æœŸæœªå½’è¿˜
3. **å‚¬æ”¶æµç¨‹**ï¼šéœ€è¦**äººå·¥è”ç³»**å®¢æˆ·å‚¬æ”¶
4. **æ•°æ®æ›´æ–°**ï¼šéœ€è¦**æ‰‹åŠ¨æ›´æ–°**æ•°æ®åº“çŠ¶æ€

---

### ğŸ’¡ å»ºè®®å®ç°æ–¹æ¡ˆ

**éœ€è¦åˆ›å»ºçš„ API**ï¼š

1. **é€¾æœŸæ£€æµ‹å®šæ—¶ä»»åŠ¡ / API**
   ```
   POST /api/cron/check-overdue-rentals
   ```
   - æŸ¥è¯¢ `rental_orders` ä¸­ `end_date < ä»Šå¤©` ä¸” `order_status = 'active'` çš„è®¢å•
   - æ›´æ–°è®¢å•çŠ¶æ€æˆ–æ ‡è®°ä¸ºé€¾æœŸ
   - å‘é€é€¾æœŸæé†’

2. **è®¾å¤‡æœªå½’è¿˜æ ‡è®° API**
   ```
   POST /api/equipment/rental/mark-unreturned
   {
     "rental_order_id": "uuid",
     "days_overdue": 30,
     "action": "send_reminder" | "mark_lost" | "legal_action"
   }
   ```
   - æ›´æ–° `rental_records.status = 'lost'`
   - è®°å½•æœªå½’è¿˜åŸå› å’Œæ—¶é—´

3. **å‚¬æ”¶è®°å½• API**
   ```
   POST /api/equipment/rental/collection/log
   {
     "rental_order_id": "uuid",
     "collection_type": "phone" | "email" | "sms",
     "collection_result": "contacted" | "no_response" | "promised_return"
   }
   ```

---

## 3ï¸âƒ£ å•†æˆ·ä¸ä»˜è´¹å¤„ç†ç°çŠ¶

### âœ… å·²å®ç°ï¼šæ•°æ®è¡¨ç»“æ„ï¼ˆ100%ï¼‰

#### 3.1 è´¦æœŸçŠ¶æ€å­—æ®µ

**`rental_billing_cycles` è¡¨**ï¼š
```sql
CREATE TABLE rental_billing_cycles (
  ...
  status VARCHAR(20) DEFAULT 'pending',
  -- status å€¼ï¼š'pending', 'paid', 'partial', 'overdue'
  due_date DATE NOT NULL,  -- åˆ°æœŸæ—¥æœŸ
  amount_due DECIMAL(10, 2),  -- åº”æ”¶é‡‘é¢
  amount_paid DECIMAL(10, 2),  -- å·²æ”¶é‡‘é¢
  ...
);
```

**å­—æ®µè¯´æ˜**ï¼š
- âœ… `status = 'overdue'`ï¼šé€¾æœŸçŠ¶æ€
- âœ… `due_date`ï¼šåˆ°æœŸæ—¥æœŸï¼ˆå¯ç”¨äºåˆ¤æ–­æ˜¯å¦é€¾æœŸï¼‰
- âœ… `amount_due` å’Œ `amount_paid`ï¼šå¯ç”¨äºè®¡ç®—æ¬ æ¬¾é‡‘é¢

#### 3.2 å‰ç«¯é€¾æœŸå±•ç¤º

**ä»£ç ä½ç½®**ï¼š`app/devices/page.tsx`

```typescript
// åˆ¤æ–­æ˜¯å¦é€¾æœŸ
const isOverdue = contract && contract.end_at 
  ? new Date(contract.end_at) < new Date()
  : false

// UIå±•ç¤ºé€¾æœŸæ ‡è¯†
<Badge className={device.lease_status.is_overdue 
  ? "bg-destructive/20 text-destructive border-destructive/30"
  : "bg-green-500/20 text-green-400 border-green-500/30"
}>
  {device.lease_status.is_overdue ? "å·²é€¾æœŸ" : "æ­£å¸¸"}
</Badge>
```

---

### âŒ æœªå®ç°ï¼šè‡ªåŠ¨åŒ–å¤„ç†ï¼ˆ0%ï¼‰

#### 3.3 ç¼ºå¤±å†…å®¹

**é—®é¢˜ 1ï¼šæ²¡æœ‰è‡ªåŠ¨æ ‡è®°é€¾æœŸ**
- âŒ æ²¡æœ‰å®šæ—¶ä»»åŠ¡æ£€æŸ¥ `due_date < ä»Šå¤©` ä¸” `status != 'paid'` çš„è´¦æœŸ
- âŒ æ²¡æœ‰è‡ªåŠ¨æ›´æ–° `status = 'overdue'`
- âŒ éœ€è¦æ‰‹åŠ¨æ ‡è®°é€¾æœŸ

**é—®é¢˜ 2ï¼šæ²¡æœ‰å‚¬æ”¶æµç¨‹**
- âŒ æ²¡æœ‰è‡ªåŠ¨å‘é€å‚¬æ”¶é€šçŸ¥ï¼ˆçŸ­ä¿¡/é‚®ä»¶/ç«™å†…ä¿¡ï¼‰
- âŒ æ²¡æœ‰å‚¬æ”¶è®°å½•è¡¨
- âŒ æ²¡æœ‰å‚¬æ”¶æé†’åŠŸèƒ½

**é—®é¢˜ 3ï¼šæ²¡æœ‰æ¬ æ¬¾ç»Ÿè®¡**
- âŒ æ²¡æœ‰æŸ¥è¯¢æ‰€æœ‰é€¾æœŸè´¦æœŸçš„API
- âŒ æ²¡æœ‰ç»Ÿè®¡æ€»æ¬ æ¬¾é‡‘é¢çš„API
- âŒ æ²¡æœ‰é€¾æœŸè´¦æœŸåˆ—è¡¨æŸ¥è¯¢

**é—®é¢˜ 4ï¼šæ²¡æœ‰æ”¯ä»˜å‚¬æ”¶**
- âŒ æ²¡æœ‰ç”Ÿæˆå‚¬æ”¶å•
- âŒ æ²¡æœ‰å‚¬æ”¶å‡­è¯è®°å½•
- âŒ æ²¡æœ‰æ‰¹é‡å‚¬æ”¶åŠŸèƒ½

---

### ğŸ“‹ å½“å‰å¤„ç†æ–¹å¼ï¼ˆæ¨æµ‹ï¼‰

**ç°çŠ¶**ï¼š
1. **çŠ¶æ€æ ‡è®°**ï¼šéœ€è¦**æ‰‹åŠ¨æŸ¥è¯¢** `due_date < ä»Šå¤©` çš„è´¦æœŸï¼Œç„¶å**æ‰‹åŠ¨æ›´æ–°** `status = 'overdue'`
2. **å‚¬æ”¶æµç¨‹**ï¼šéœ€è¦**äººå·¥è”ç³»**å•†æˆ·å‚¬æ”¶
3. **æ¬ æ¬¾ç»Ÿè®¡**ï¼šéœ€è¦**æ‰‹åŠ¨SQLæŸ¥è¯¢**ç»Ÿè®¡é€¾æœŸé‡‘é¢
4. **æ”¯ä»˜æé†’**ï¼šéœ€è¦**äººå·¥å‘é€**æé†’é€šçŸ¥

---

### ğŸ’¡ å»ºè®®å®ç°æ–¹æ¡ˆ

**éœ€è¦åˆ›å»ºçš„ API**ï¼š

1. **é€¾æœŸæ£€æµ‹å®šæ—¶ä»»åŠ¡ / API**
   ```
   POST /api/cron/check-overdue-billing
   ```
   - æŸ¥è¯¢ `rental_billing_cycles` ä¸­ `due_date < ä»Šå¤©` ä¸” `status IN ('pending', 'partial')` çš„è®°å½•
   - è‡ªåŠ¨æ›´æ–° `status = 'overdue'`
   - å‘é€é€¾æœŸæé†’

2. **é€¾æœŸè´¦æœŸæŸ¥è¯¢ API**
   ```
   GET /api/finance/billing/overdue?restaurant_id=xxx&days=30
   ```
   - æŸ¥è¯¢é€¾æœŸè´¦æœŸåˆ—è¡¨
   - ç»Ÿè®¡é€¾æœŸé‡‘é¢
   - æ”¯æŒæŒ‰é¤å…ã€é€¾æœŸå¤©æ•°ç­›é€‰

3. **å‚¬æ”¶é€šçŸ¥ API**
   ```
   POST /api/finance/collection/notify
   {
     "rental_order_id": "uuid",
     "billing_cycle_id": "uuid",
     "notification_type": "sms" | "email" | "phone",
     "message": "å‚¬æ”¶æ¶ˆæ¯å†…å®¹"
   }
   ```
   - å‘é€å‚¬æ”¶é€šçŸ¥
   - è®°å½•å‚¬æ”¶å†å²

4. **æ¬ æ¬¾ç»Ÿè®¡ API**
   ```
   GET /api/finance/billing/statistics?restaurant_id=xxx
   ```
   - ç»Ÿè®¡æ€»æ¬ æ¬¾é‡‘é¢
   - ç»Ÿè®¡é€¾æœŸè´¦æœŸæ•°é‡
   - ç»Ÿè®¡æœ€é•¿é€¾æœŸå¤©æ•°

---

## 4ï¸âƒ£ æ€»ç»“å¯¹æ¯”è¡¨

| å¼‚å¸¸åœºæ™¯ | æ•°æ®è¡¨ | çŠ¶æ€å­—æ®µ | API | å®šæ—¶ä»»åŠ¡ | è‡ªåŠ¨åŒ– | å®Œæ•´åº¦ |
|---------|--------|---------|-----|---------|--------|--------|
| **è®¾å¤‡æŸå** | âœ… `rental_records` | âœ… `status`, `return_condition`, `damage_fee` | âŒ | âŒ | âŒ | **30%** |
| **è®¾å¤‡æœªå½’è¿˜** | âš ï¸ `rental_orders`, `rental_contracts` | âš ï¸ `order_status`, å‰ç«¯åˆ¤æ–­ | âŒ | âŒ | âŒ | **20%** |
| **å•†æˆ·ä¸ä»˜è´¹** | âœ… `rental_billing_cycles` | âœ… `status = 'overdue'` | âŒ | âŒ | âŒ | **30%** |

---

## 5ï¸âƒ£ ä¼˜å…ˆçº§å»ºè®®

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆä¸šåŠ¡å¿…éœ€ï¼‰

1. **è®¾å¤‡å½’è¿˜æ£€æŸ¥æµç¨‹**
   - å®ç°é€€ç§Ÿæ—¶è®¾å¤‡æ£€æŸ¥API
   - æ”¯æŒè®°å½•è®¾å¤‡æŸåæƒ…å†µ
   - è®¡ç®—èµ”å¿è´¹ç”¨

2. **é€¾æœŸè´¦æœŸè‡ªåŠ¨æ ‡è®°**
   - å®ç°å®šæ—¶ä»»åŠ¡æ£€æŸ¥é€¾æœŸè´¦æœŸ
   - è‡ªåŠ¨æ›´æ–° `status = 'overdue'`
   - å‘é€é€¾æœŸæé†’

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆè¿è¥ä¼˜åŒ–ï¼‰

3. **è®¾å¤‡æœªå½’è¿˜æ£€æµ‹**
   - å®ç°é€¾æœŸè®¾å¤‡æ£€æµ‹å®šæ—¶ä»»åŠ¡
   - æ ‡è®°æœªå½’è¿˜è®¾å¤‡
   - å‘é€å½’è¿˜æé†’

4. **å‚¬æ”¶åŠŸèƒ½**
   - å®ç°å‚¬æ”¶é€šçŸ¥API
   - è®°å½•å‚¬æ”¶å†å²
   - æ”¯æŒå¤šç§é€šçŸ¥æ–¹å¼

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆæ•°æ®åˆ†æï¼‰

5. **æ¬ æ¬¾ç»Ÿè®¡æŠ¥è¡¨**
   - å®ç°æ¬ æ¬¾ç»Ÿè®¡API
   - ç”Ÿæˆæ¬ æ¬¾æŠ¥è¡¨
   - æ”¯æŒæ•°æ®å¯¼å‡º

---

## 6ï¸âƒ£ ç›¸å…³è¡¨ç»“æ„

### rental_recordsï¼ˆè®¾å¤‡ç§Ÿèµè®°å½•ï¼‰
```sql
-- ç”¨äºè®°å½•è®¾å¤‡æŸåæƒ…å†µ
status VARCHAR(20) -- 'active', 'returned', 'damaged', 'lost'
return_condition VARCHAR(50) -- 'good', 'normal_wear', 'damaged', 'lost'
damage_fee DECIMAL(10, 2) -- æŸåèµ”å¿è´¹ç”¨
```

### rental_billing_cyclesï¼ˆè´¦æœŸè¡¨ï¼‰
```sql
-- ç”¨äºè®°å½•é€¾æœŸä»˜è´¹
status VARCHAR(20) -- 'pending', 'paid', 'partial', 'overdue'
due_date DATE -- åˆ°æœŸæ—¥æœŸ
amount_due DECIMAL(10, 2) -- åº”æ”¶é‡‘é¢
amount_paid DECIMAL(10, 2) -- å·²æ”¶é‡‘é¢
```

### rental_ordersï¼ˆç§Ÿèµè®¢å•è¡¨ï¼‰
```sql
-- ç”¨äºåˆ¤æ–­è®¾å¤‡æ˜¯å¦å½’è¿˜
order_status VARCHAR(20) -- 'pending', 'confirmed', 'active', 'completed', 'cancelled'
end_date DATE -- ç§Ÿèµç»“æŸæ—¥æœŸ
```

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-01-25
