# 待接单列表问题排查指南

## 问题描述

待接单导航栏里没有待接数据。

## 可能原因

### 1. 数据库中没有 pending 状态的订单
- 检查 `delivery_orders` 表中是否有 `status = 'pending'` 的记录
- SQL查询：
  ```sql
  SELECT COUNT(*) FROM delivery_orders WHERE status = 'pending';
  ```

### 2. RLS策略限制
- `delivery_orders` 表的 RLS 策略可能阻止了查询
- 检查 RLS 策略是否允许查询 `pending` 状态的订单

### 3. API调用失败
- 检查浏览器控制台的网络请求
- 查看 `/api/orders/pending` 的响应状态码和错误信息

### 4. Worker ID 或权限问题
- 检查 `workerId` 是否正确设置
- 检查工人账号是否有 `delivery` 权限

### 5. 产品类型筛选
- 如果设置了 `productType`，可能没有匹配的订单

## 排查步骤

### 步骤1：检查数据库
```sql
-- 查看所有pending状态的订单
SELECT id, restaurant_id, product_type, status, created_at 
FROM delivery_orders 
WHERE status = 'pending' 
ORDER BY created_at DESC 
LIMIT 10;

-- 查看订单总数
SELECT status, COUNT(*) 
FROM delivery_orders 
GROUP BY status;
```

### 步骤2：检查RLS策略
```sql
-- 查看delivery_orders表的RLS策略
SELECT * FROM pg_policies WHERE tablename = 'delivery_orders';

-- 临时禁用RLS测试（仅用于排查）
ALTER TABLE delivery_orders DISABLE ROW LEVEL SECURITY;
-- 测试后记得恢复
ALTER TABLE delivery_orders ENABLE ROW LEVEL SECURITY;
```

### 步骤3：检查API响应
1. 打开浏览器开发者工具（F12）
2. 切换到"网络"（Network）标签
3. 刷新待接单页面
4. 找到 `/api/orders/pending` 请求
5. 查看：
   - 状态码（应该是200）
   - 响应内容（应该包含 `success: true` 和 `data` 数组）
   - 错误信息（如果有）

### 步骤4：检查控制台日志
现在代码已经添加了详细的日志，打开浏览器控制台查看：
- `[订单列表] 开始加载订单` - 显示请求参数
- `[订单列表] API响应状态` - 显示HTTP状态码
- `[订单列表] API返回数据` - 显示API返回的完整数据
- `[订单列表] 获取到订单数量` - 显示订单数量
- `[待接单订单API] 查询成功` - 服务器端日志

### 步骤5：检查Worker ID
1. 确认已登录配送员账号
2. 检查 `localStorage.getItem("workerId")` 是否有值
3. 检查工人账号的 `worker_types` 是否包含 `'delivery'`

## 修复方案

### 方案1：如果数据库中没有pending订单
创建测试订单：
```sql
INSERT INTO delivery_orders (
  id, restaurant_id, product_type, service_type, status, amount, created_at
) VALUES (
  gen_random_uuid(),
  '你的餐厅ID',
  'lpg',
  '燃料配送',
  'pending',
  100.00,
  NOW()
);
```

### 方案2：如果RLS策略限制
检查并调整RLS策略，确保允许查询 `pending` 状态的订单：
```sql
-- 创建允许查询pending订单的策略
CREATE POLICY "允许查询待接单订单"
ON delivery_orders
FOR SELECT
USING (status = 'pending');
```

### 方案3：如果API调用失败
1. 查看API返回的错误信息
2. 检查服务器日志
3. 根据错误信息修复问题

## 已添加的调试功能

1. **详细的控制台日志**
   - 请求参数
   - API响应
   - 订单数量
   - 错误信息

2. **改进的错误提示**
   - 显示可能的原因
   - 显示筛选条件
   - 提供刷新按钮

3. **服务器端日志**
   - 查询结果
   - 错误详情
   - 订单示例

## 测试建议

1. **打开浏览器控制台**
   - 查看所有日志输出
   - 检查是否有错误

2. **检查网络请求**
   - 查看 `/api/orders/pending` 请求
   - 确认响应状态和内容

3. **测试不同场景**
   - 不设置产品类型筛选
   - 设置不同的产品类型
   - 使用不同的Worker ID

## 相关文件

- `components/worker/order-list.tsx` - 订单列表组件（已添加日志）
- `app/api/orders/pending/route.ts` - 待接单API（已添加日志）
- `app/worker/page.tsx` - 工人端主页面

## 完成时间

2025-01-20
