# æ‰§è¡Œè¯´æ˜ï¼šä¿®å¤å¤šç§Ÿæˆ·å®‰å…¨æ¼æ´

## ğŸ“‹ æ‰§è¡Œæ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ‰“å¼€ Supabase SQL Editor

1. ç™»å½• Supabase Dashboard
2. è¿›å…¥ä½ çš„é¡¹ç›®
3. ç‚¹å‡»å·¦ä¾§èœå•çš„ **SQL Editor**
4. ç‚¹å‡» **New Query** åˆ›å»ºæ–°æŸ¥è¯¢

### ç¬¬äºŒæ­¥ï¼šå¤åˆ¶å¹¶æ‰§è¡Œ SQL è„šæœ¬

1. æ‰“å¼€æ–‡ä»¶ï¼š`ä¿®å¤å¤šç§Ÿæˆ·å®‰å…¨æ¼æ´_å®Œæ•´SQLè„šæœ¬.sql`
2. **å…¨é€‰å¹¶å¤åˆ¶**æ‰€æœ‰ SQL ä»£ç 
3. ç²˜è´´åˆ° Supabase SQL Editor
4. ç‚¹å‡» **Run** æ‰§è¡Œ

### ç¬¬ä¸‰æ­¥ï¼šæ£€æŸ¥æ‰§è¡Œç»“æœ

è„šæœ¬æ‰§è¡Œåï¼Œä¼šæ˜¾ç¤ºéªŒè¯ç»“æœï¼š

#### âœ… é¢„æœŸç»“æœ

1. **user_companies è¡¨**
   - çŠ¶æ€ï¼šâœ… åˆ›å»ºæˆåŠŸ
   - å­—æ®µæ•°é‡ï¼šåº”è¯¥æ˜¾ç¤º 9 ä¸ªå­—æ®µ

2. **status_change_logs è¡¨**
   - çŠ¶æ€ï¼šâœ… åˆ›å»ºæˆåŠŸ
   - å­—æ®µæ•°é‡ï¼šåº”è¯¥æ˜¾ç¤º 9 ä¸ªå­—æ®µ

3. **rental_orders RLS ç­–ç•¥**
   - åº”è¯¥æ˜¾ç¤º 5 ä¸ªç­–ç•¥ï¼š
     - Service role full access to rental orders
     - Users can only see their company's rental orders
     - Users can only insert rental orders for their company
     - Users can only update their company's rental orders
     - Users can only delete their company's rental orders

4. **equipment_catalog RLS ç­–ç•¥**
   - åº”è¯¥æ˜¾ç¤º 5 ä¸ªç­–ç•¥ï¼š
     - Service role full access to equipment catalog
     - Users can view equipment based on their role
     - Users can only insert equipment for their company
     - Users can only update their company's equipment
     - Users can only delete their company's equipment

5. **RLS å·²å¯ç”¨**
   - user_companies: true
   - status_change_logs: true
   - rental_orders: true
   - equipment_catalog: true

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ‰§è¡Œé¡ºåº

**å¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œæ•´ä¸ªè„šæœ¬**ï¼Œå› ä¸ºï¼š
- ç¬¬äºŒæ­¥ä¾èµ–ç¬¬ä¸€æ­¥åˆ›å»ºçš„è¡¨
- ç¬¬ä¸‰æ­¥ä¾èµ–ç¬¬ä¸€æ­¥å’Œç¬¬äºŒæ­¥çš„è¡¨

### 2. å¦‚æœé‡åˆ°é”™è¯¯

#### é”™è¯¯ï¼š`relation "companies" does not exist`

**åŸå› ï¼š** `companies` è¡¨ä¸å­˜åœ¨

**è§£å†³æ–¹æ¡ˆï¼š** å…ˆè¿è¡Œ `å‡çº§rental_ordersè¡¨_æ·»åŠ ä¾›åº”å•†å’Œäº¤ä»˜å‡­è¯.sql` åˆ›å»º `companies` è¡¨

#### é”™è¯¯ï¼š`policy "xxx" already exists`

**åŸå› ï¼š** ç­–ç•¥å·²å­˜åœ¨

**è§£å†³æ–¹æ¡ˆï¼š** è„šæœ¬ä¸­å·²åŒ…å« `DROP POLICY IF EXISTS`ï¼Œåº”è¯¥ä¼šè‡ªåŠ¨åˆ é™¤æ—§ç­–ç•¥ã€‚å¦‚æœä»æœ‰é”™è¯¯ï¼Œå¯ä»¥æ‰‹åŠ¨åˆ é™¤æ—§ç­–ç•¥åå†è¿è¡Œã€‚

#### é”™è¯¯ï¼š`column "provider_id" does not exist`

**åŸå› ï¼š** `rental_orders` æˆ– `equipment_catalog` è¡¨ç¼ºå°‘ `provider_id` å­—æ®µ

**è§£å†³æ–¹æ¡ˆï¼š** å…ˆè¿è¡Œ `å‡çº§rental_ordersè¡¨_æ·»åŠ ä¾›åº”å•†å’Œäº¤ä»˜å‡­è¯.sql` å’Œ `åˆ›å»ºequipment_catalogè¡¨.sql`

---

## ğŸ” éªŒè¯å¤šç§Ÿæˆ·éš”ç¦»æ˜¯å¦ç”Ÿæ•ˆ

### æµ‹è¯•æ­¥éª¤

1. **åˆ›å»ºæµ‹è¯•ç”¨æˆ·å’Œå…¬å¸**

```sql
-- åˆ›å»ºæµ‹è¯•å…¬å¸
INSERT INTO companies (id, name, status) 
VALUES 
  ('11111111-1111-1111-1111-111111111111', 'æµ‹è¯•å…¬å¸A', 'active'),
  ('22222222-2222-2222-2222-222222222222', 'æµ‹è¯•å…¬å¸B', 'active');

-- åˆ›å»ºæµ‹è¯•ç”¨æˆ·å…³è”ï¼ˆå‡è®¾å·²æœ‰ç”¨æˆ·IDï¼‰
-- æ³¨æ„ï¼šéœ€è¦æ›¿æ¢ä¸ºå®é™…çš„ç”¨æˆ·ID
INSERT INTO user_companies (user_id, company_id, role, is_primary)
VALUES 
  ('user-a-id', '11111111-1111-1111-1111-111111111111', 'owner', true),
  ('user-b-id', '22222222-2222-2222-2222-222222222222', 'owner', true);
```

2. **åˆ›å»ºæµ‹è¯•æ•°æ®**

```sql
-- ä¸ºå…¬å¸Aåˆ›å»ºè®¢å•
INSERT INTO rental_orders (order_number, provider_id, order_status)
VALUES ('TEST-A-001', '11111111-1111-1111-1111-111111111111', 'pending');

-- ä¸ºå…¬å¸Båˆ›å»ºè®¢å•
INSERT INTO rental_orders (order_number, provider_id, order_status)
VALUES ('TEST-B-001', '22222222-2222-2222-2222-222222222222', 'pending');
```

3. **æµ‹è¯•æŸ¥è¯¢éš”ç¦»**

ä½¿ç”¨ä¸åŒçš„ç”¨æˆ·èº«ä»½æŸ¥è¯¢ï¼š

```sql
-- ä»¥ç”¨æˆ·Aèº«ä»½æŸ¥è¯¢ï¼ˆåº”è¯¥åªèƒ½çœ‹åˆ°å…¬å¸Açš„è®¢å•ï¼‰
SET LOCAL role TO authenticated;
SET LOCAL request.jwt.claim.sub TO 'user-a-id';

SELECT * FROM rental_orders;
-- åº”è¯¥åªè¿”å› TEST-A-001

-- ä»¥ç”¨æˆ·Bèº«ä»½æŸ¥è¯¢ï¼ˆåº”è¯¥åªèƒ½çœ‹åˆ°å…¬å¸Bçš„è®¢å•ï¼‰
SET LOCAL request.jwt.claim.sub TO 'user-b-id';

SELECT * FROM rental_orders;
-- åº”è¯¥åªè¿”å› TEST-B-001
```

---

## ğŸ“ åç»­æ“ä½œ

### 1. æ›´æ–°ç°æœ‰æ•°æ®

å¦‚æœç°æœ‰æ•°æ®æ²¡æœ‰ `provider_id`ï¼Œéœ€è¦æ‰‹åŠ¨è¡¥å……ï¼š

```sql
-- ä¸ºç°æœ‰è®¢å•åˆ†é…ä¾›åº”å•†ï¼ˆç¤ºä¾‹ï¼‰
UPDATE rental_orders 
SET provider_id = 'your-company-id'
WHERE provider_id IS NULL;
```

### 2. åˆ›å»ºç”¨æˆ·-å…¬å¸å…³è”

ä¸ºæ–°ç”¨æˆ·åˆ›å»ºå…¬å¸å…³è”ï¼š

```sql
INSERT INTO user_companies (user_id, company_id, role, is_primary)
VALUES ('user-id', 'company-id', 'owner', true);
```

### 3. æµ‹è¯• API è·¯ç”±

ç¡®ä¿æ‰€æœ‰ API è·¯ç”±éƒ½æ­£ç¡®ä½¿ç”¨ `company_id` è¿‡æ»¤ï¼š

- âœ… `app/api/equipment/rental/admin/list/route.ts` - å·²æ›´æ–°
- âœ… `app/api/equipment/catalog/list/route.ts` - å·²æ›´æ–°
- â³ å…¶ä»– API è·¯ç”±éœ€è¦ç»§ç»­æ›´æ–°

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] SQL è„šæœ¬æ‰§è¡ŒæˆåŠŸ
- [ ] user_companies è¡¨åˆ›å»ºæˆåŠŸ
- [ ] status_change_logs è¡¨åˆ›å»ºæˆåŠŸ
- [ ] rental_orders RLS ç­–ç•¥åˆ›å»ºæˆåŠŸï¼ˆ5ä¸ªç­–ç•¥ï¼‰
- [ ] equipment_catalog RLS ç­–ç•¥åˆ›å»ºæˆåŠŸï¼ˆ5ä¸ªç­–ç•¥ï¼‰
- [ ] æ‰€æœ‰è¡¨çš„ RLS å·²å¯ç”¨
- [ ] æµ‹è¯•å¤šç§Ÿæˆ·éš”ç¦»æ˜¯å¦ç”Ÿæ•ˆ
- [ ] æ›´æ–°ç°æœ‰æ•°æ®ï¼Œè¡¥å…… provider_id
- [ ] åˆ›å»ºç”¨æˆ·-å…¬å¸å…³è”è®°å½•

---

## ğŸš¨ é‡è¦æé†’

1. **åœ¨å®Œæˆå¤šç§Ÿæˆ·éš”ç¦»ä¹‹å‰ï¼Œä¸è¦å¯ç”¨ä¾›åº”å•†è´¦å·ç™»å½•**
2. **æ‰€æœ‰æ¶‰åŠæ•°æ®çš„ API éƒ½å¿…é¡»æ·»åŠ  `company_id` è¿‡æ»¤**
3. **å®šæœŸå®¡æŸ¥ RLS ç­–ç•¥ï¼Œç¡®ä¿æƒé™æ­£ç¡®**
4. **ç›‘æ§ Supabase å®¡è®¡æ—¥å¿—ï¼Œå‘ç°å¼‚å¸¸è®¿é—®**

æ‰§è¡Œå®Œæˆåï¼Œè¯·å‘Šè¯‰æˆ‘ç»“æœï¼


