# 改进接单错误提示

## 问题描述

接单API返回400错误，错误信息是"订单不存在或状态不允许"，但信息不够详细，用户无法知道具体原因。

## 改进内容

### 1. 更详细的错误信息
**文件**: `app/api/orders/accept/route.ts`

根据订单的实际情况，提供不同的错误信息：

1. **订单状态已改变**：
   - 错误信息：`订单状态已改变，当前状态为：{status}`
   - 说明：订单状态已从 pending 变为其他状态，可能已被其他配送员接单

2. **订单已被接单**：
   - 错误信息：`订单已被其他配送员接单`
   - 说明：订单的 worker_id 或 assigned_to 已有值

3. **RLS策略限制**：
   - 错误信息：`无法更新订单，可能是RLS策略限制`
   - 说明：订单状态为pending，但更新操作失败

4. **订单不存在**：
   - 错误信息：`订单不存在或状态不允许`
   - 说明：查询不到订单

### 2. 前端错误显示
**文件**: `components/worker/order-list.tsx`

- 显示完整的错误信息（包括details）
- 在控制台输出详细的错误日志
- 帮助用户理解为什么接单失败

## 错误信息对照表

| 情况 | 错误信息 | 说明 |
|------|---------|------|
| 订单状态不是pending | `订单状态已改变，当前状态为：{status}` | 订单可能已被接单或完成 |
| 订单已被接单 | `订单已被其他配送员接单` | worker_id 或 assigned_to 已有值 |
| RLS策略限制 | `无法更新订单，可能是RLS策略限制` | 权限问题 |
| 订单不存在 | `订单不存在或状态不允许` | 查询不到订单 |

## 优势

1. **更清晰的错误提示**：
   - 用户能快速了解失败原因
   - 减少困惑和重复尝试

2. **更好的调试体验**：
   - 详细的日志输出
   - 包含订单当前状态信息

3. **更好的用户体验**：
   - 错误信息更友好
   - 提供解决建议

## 测试建议

1. **测试订单状态已改变**：
   - 选择一个订单
   - 在另一个地方将订单状态改为 accepted
   - 尝试接单
   - 验证：应该显示"订单状态已改变"的错误

2. **测试订单已被接单**：
   - 选择一个订单
   - 在另一个地方将订单的 worker_id 设置为其他配送员
   - 尝试接单
   - 验证：应该显示"订单已被其他配送员接单"的错误

3. **测试正常接单**：
   - 选择一个 pending 状态的订单
   - 成功接单
   - 验证：应该成功，订单状态变为 accepted

## 相关文件

- `app/api/orders/accept/route.ts` - 接单API
- `components/worker/order-list.tsx` - 订单列表组件

## 完成时间

2025-01-20
