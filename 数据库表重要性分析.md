# 数据库表重要性分析

## 📊 表分类总览

### ✅ **核心业务表（必须保留）**

这些表是系统运行的核心，**绝对不能删除**：

| 表名 | 用途 | 使用位置 | 重要性 |
|------|------|----------|--------|
| `orders` | 订单表（维修、配送、安装等所有订单） | 管理端、工人端、客户端 | ⭐⭐⭐⭐⭐ |
| `restaurants` | 餐厅信息表 | 全系统 | ⭐⭐⭐⭐⭐ |
| `devices` | 设备表（IoT设备） | 全系统 | ⭐⭐⭐⭐⭐ |
| `workers` | 工人/员工表 | 管理端、工人端 | ⭐⭐⭐⭐⭐ |
| `service_points` | 服务点表 | 管理端 | ⭐⭐⭐⭐ |

### ✅ **设备租赁相关表（业务表）**

| 表名 | 用途 | 使用位置 | 重要性 | 状态 |
|------|------|----------|--------|------|
| `equipment_categories` | 设备分类表 | 客户端设备租赁页面 | ⭐⭐⭐⭐ | ✅ 正常 |
| `equipment` | 设备表（租赁设备） | 客户端设备租赁页面 | ⭐⭐⭐⭐ | ✅ 正常 |
| `rental_orders` | 设备租赁订单表 | 管理端、客户端 | ⭐⭐⭐⭐ | ❌ **已被删除，需重建** |
| `rentals` | 租赁管理表（新表） | 管理端、工人端 | ⭐⭐⭐ | ✅ 正常（备用） |

**注意：** `rental_orders` 和 `rentals` 是两个不同的表：
- `rental_orders`：完整的设备租赁订单表（关联 equipment、restaurants）
- `rentals`：简化的租赁管理表（用于工人端交付流程）

### ❓ **可能废弃的表**

| 表名 | 用途 | 使用位置 | 建议 |
|------|------|----------|------|
| `fuel_level` | 燃料级别表 | 客户端（可能已废弃） | 🔍 检查是否还在使用 |
| `fuel_prices` | 燃料价格表 | 代码中有注释掉的引用 | 🗑️ 可以删除（如果确认不用） |

### 🗑️ **可以归档的表**

如果表名包含以下模式，可以移到归档文件夹：
- `*_old`
- `*_backup`
- `*_temp`
- `*_test`

---

## 📁 SQL 脚本文件组织建议

### 建议的文件夹结构：

```
sql/
├── 核心表/
│   ├── 检查rental_orders表是否存在.sql
│   ├── 重建rental_orders表.sql
│   └── 检查所有表状态.sql
│
├── 设备租赁/
│   ├── 创建设备相关表的完整脚本.sql
│   ├── RENTALS_TABLE_SCHEMA.sql
│   └── check_and_create_rental_orders.sql
│
├── 权限修复/
│   ├── 快速验证并修复策略.sql
│   ├── 彻底修复rental_orders权限问题.sql
│   └── 修复rental_orders表权限.sql
│
└── 归档/
    ├── 验证策略是否创建成功.sql
    └── （其他不再使用的脚本）
```

---

## 🚨 当前问题：rental_orders 表被删除

### 影响范围：
1. ✅ **管理端**：`/api/equipment/rental/admin/list` 会尝试查询 `rental_orders`，失败后会降级查询 `rentals` 表
2. ✅ **客户端**：`/api/equipment/rental/list` 会尝试查询 `rental_orders`，失败后会返回空数组
3. ⚠️ **数据丢失**：如果 `rental_orders` 表中有数据，删除后数据无法恢复（除非有备份）

### 解决方案：
1. **立即执行**：运行 `重建rental_orders表.sql` 脚本
2. **验证**：运行 `检查所有表状态.sql` 确认表已创建
3. **修复权限**：运行 `快速验证并修复策略.sql` 确保 RLS 策略正确

---

## 📝 操作步骤

### 第一步：检查表状态
在 Supabase SQL Editor 中运行：
```sql
-- 运行 "检查所有表状态.sql"
```

### 第二步：重建 rental_orders 表
```sql
-- 运行 "重建rental_orders表.sql"
```

### 第三步：验证和修复权限
```sql
-- 运行 "快速验证并修复策略.sql"
```

### 第四步：整理 SQL 文件
1. 创建 `sql/归档/` 文件夹
2. 将不再使用的脚本移到归档文件夹
3. 保留常用的脚本在根目录或相应分类文件夹

---

## ⚠️ 重要提醒

1. **删除表前请备份**：在 Supabase 中，删除表前建议先导出数据
2. **测试环境优先**：重要操作先在测试环境验证
3. **定期备份**：建议定期备份重要表的数据
4. **版本控制**：SQL 脚本建议使用 Git 进行版本控制


