# 服务端权限验证说明文档

## 概述

本文档说明服务端API路由中的权限验证机制。系统已在关键API路由中添加了工人权限校验，确保只有具有相应权限的工人才能执行对应操作。

---

## 1. 权限验证工具函数

### 1.1 位置
`lib/auth/worker-auth.ts`

### 1.2 核心函数
```typescript
verifyWorkerPermission(
  request: Request,
  requiredPermission: WorkerPermission,
  body?: any
): Promise<{ success: true; worker: WorkerInfo } | NextResponse>
```

### 1.3 功能
- 从请求头（`x-worker-id`）或请求体（`worker_id`）获取工人ID
- 查询数据库验证工人身份和状态（只允许`active`状态的工人）
- 解析`worker_type`字段（支持单个类型、数组、JSON字符串）
- 验证工人是否具有所需权限
- 返回工人信息或错误响应

### 1.4 支持的权限类型
- `"delivery"` - 配送员权限
- `"repair"` - 维修工权限
- `"install"` - 安装工权限

---

## 2. 已添加权限验证的API路由

### 2.1 维修相关API

#### `/api/repair/update` (POST)
- **权限要求：** `repair`（如果请求中包含`worker_id`）
- **验证方式：** 检查请求头`x-worker-id`或请求体`worker_id`
- **说明：** 管理端调用时不需要权限验证，工人端调用时需要验证

**代码示例：**
```typescript
// 如果请求中包含worker_id，验证维修工权限
if (body.worker_id || request.headers.get("x-worker-id")) {
  const authResult = await verifyWorkerPermission(request, "repair", body)
  if (authResult instanceof NextResponse) {
    return authResult // 返回错误响应
  }
}
```

#### `/api/repair/list` (GET)
- **权限要求：** `repair`（如果请求头中包含`x-worker-id`）
- **验证方式：** 检查请求头`x-worker-id`
- **说明：** 管理端调用时不需要权限验证，工人端调用时需要验证

**代码示例：**
```typescript
const workerId = request.headers.get("x-worker-id")
if (workerId) {
  const authResult = await verifyWorkerPermission(request, "repair")
  if (authResult instanceof NextResponse) {
    return authResult
  }
}
```

### 2.2 订单相关API

#### `/api/orders/accept` (POST)
- **权限要求：** `delivery`（必须）
- **验证方式：** 检查请求头`x-worker-id`或请求体`worker_id`
- **说明：** 配送员接单，必须验证权限

#### `/api/orders/complete` (POST)
- **权限要求：** `delivery`（必须）
- **验证方式：** 检查请求头`x-worker-id`或请求体`worker_id`
- **说明：** 配送员完成订单，必须验证权限

#### `/api/orders/pending` (GET)
- **权限要求：** `delivery`（如果请求头中包含`x-worker-id`）
- **验证方式：** 检查请求头`x-worker-id`
- **说明：** 管理端调用时不需要权限验证，工人端调用时需要验证

### 2.3 安装相关API

#### `/api/install` (POST)
- **权限要求：** `install`（必须）
- **验证方式：** 检查请求头`x-worker-id`或请求体`worker_id`
- **说明：** 安装工安装设备，必须验证权限

### 2.4 配送相关API

#### `/api/delivery` (POST)
- **权限要求：** `delivery`（必须）
- **验证方式：** 检查请求头`x-worker-id`或请求体`worker_id`
- **说明：** 配送员记录配送信息，必须验证权限

#### `/api/filling` (POST)
- **权限要求：** `delivery`（必须）
- **验证方式：** 检查请求头`x-worker-id`或请求体`worker_id`
- **说明：** 配送员记录加注/换瓶操作，必须验证权限

---

## 3. 客户端调用方式

### 3.1 在请求头中添加worker_id

**推荐方式：** 在请求头中添加`x-worker-id`

```typescript
const headers: HeadersInit = {
  "Content-Type": "application/json",
}

// 如果已登录，添加worker_id到请求头
if (workerId) {
  headers["x-worker-id"] = workerId
}

const response = await fetch("/api/repair/update", {
  method: "POST",
  headers,
  body: JSON.stringify({
    repair_id: repairId,
    status: "processing",
  }),
})
```

### 3.2 在请求体中添加worker_id

**兼容方式：** 在请求体中添加`worker_id`（同时支持请求头方式）

```typescript
const response = await fetch("/api/repair/update", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
  },
  body: JSON.stringify({
    repair_id: repairId,
    status: "processing",
    worker_id: workerId, // 添加到请求体
  }),
})
```

---

## 4. 权限验证流程

```
客户端发起API请求
    ↓
[可选] 在请求头添加 x-worker-id
[可选] 在请求体中添加 worker_id
    ↓
服务端接收请求
    ↓
调用 verifyWorkerPermission()
    ↓
从请求头或请求体获取 worker_id
    ↓
查询数据库验证工人身份
    ↓
检查工人状态是否为 active
    ↓
解析 worker_type（支持多种格式）
    ↓
检查 worker_types 是否包含所需权限
    ↓
[验证通过] → 返回工人信息，继续处理请求
[验证失败] → 返回 403 错误响应
```

---

## 5. 错误响应格式

### 5.1 缺少工人身份信息
```json
{
  "error": "缺少工人身份信息，请在请求头中添加 x-worker-id 或在请求体中提供 worker_id"
}
```
**状态码：** 401

### 5.2 工人不存在或已离职
```json
{
  "error": "工人不存在或已离职"
}
```
**状态码：** 403

### 5.3 权限不足
```json
{
  "error": "权限不足：需要配送员权限",
  "required": "delivery",
  "current": ["repair", "install"]
}
```
**状态码：** 403

---

## 6. 已更新的客户端组件

### 6.1 工人端页面 (`app/worker/page.tsx`)
- `InstallForm` - 接收`workerId`参数，在API调用时添加权限验证
- `DeliveryForm` - 接收`workerId`参数，在API调用时添加权限验证
- 所有API调用都已更新，添加`x-worker-id`请求头

### 6.2 工人组件

#### `components/worker/repair-list.tsx`
- `loadRepairs` - 添加`x-worker-id`请求头
- `handleAcceptRepair` - 添加`x-worker-id`请求头和请求体`worker_id`
- `handleCompleteRepair` - 添加`x-worker-id`请求头和请求体`worker_id`

#### `components/worker/order-list.tsx`
- `loadOrders` - 添加`x-worker-id`请求头
- `handleAccept` - 添加`x-worker-id`请求头和请求体`worker_id`

---

## 7. 权限验证策略

### 7.1 必须验证权限的API
以下API**必须**提供`worker_id`并验证权限：
- `/api/orders/accept` - 接单（配送员）
- `/api/orders/complete` - 完成订单（配送员）
- `/api/install` - 安装设备（安装工）
- `/api/delivery` - 配送记录（配送员）
- `/api/filling` - 加注/换瓶（配送员）

### 7.2 可选验证权限的API
以下API在**工人端调用时**需要验证权限，**管理端调用时**不需要：
- `/api/repair/update` - 更新维修状态（如果包含`worker_id`）
- `/api/repair/list` - 查看维修列表（如果请求头包含`x-worker-id`）
- `/api/orders/pending` - 查看待接单订单（如果请求头包含`x-worker-id`）

### 7.3 不需要权限验证的API
以下API不需要权限验证（客户端调用）：
- `/api/repair/create` - 客户端创建报修（餐厅用户）
- `/api/restaurant/register` - 餐厅注册
- `/api/restaurant/login` - 餐厅登录

---

## 8. 安全注意事项

### 8.1 双重验证
- **客户端验证：** UI层面控制功能显示（已有）
- **服务端验证：** API层面验证权限（新增）✅

### 8.2 权限验证时机
- 在API路由的**最早期**进行权限验证
- 在访问数据库或执行业务逻辑**之前**验证
- 确保无权限的请求被立即拒绝

### 8.3 数据隔离
- 工人只能操作自己有权限的业务
- 通过权限验证确保数据安全

---

## 9. 测试建议

### 9.1 测试场景

1. **正常权限测试**
   - 配送员调用配送相关API → 应该成功
   - 维修工调用维修相关API → 应该成功
   - 安装工调用安装相关API → 应该成功

2. **权限不足测试**
   - 维修工调用配送API → 应该返回403错误
   - 配送员调用维修API → 应该返回403错误
   - 安装工调用配送API → 应该返回403错误

3. **多职务工人测试**
   - 同时是配送员和维修工的工人 → 可以调用两种API
   - 同时是三种类型的工人 → 可以调用所有API

4. **未登录测试**
   - 不提供`worker_id` → 应该返回401错误
   - 提供无效的`worker_id` → 应该返回403错误

---

## 10. 相关文件

- **权限验证工具：** `lib/auth/worker-auth.ts`
- **维修API：** `app/api/repair/update/route.ts`, `app/api/repair/list/route.ts`
- **订单API：** `app/api/orders/accept/route.ts`, `app/api/orders/complete/route.ts`, `app/api/orders/pending/route.ts`
- **安装API：** `app/api/install/route.ts`
- **配送API：** `app/api/delivery/route.ts`, `app/api/filling/route.ts`
- **工人端页面：** `app/worker/page.tsx`
- **工人组件：** `components/worker/repair-list.tsx`, `components/worker/order-list.tsx`

---

## 11. 后续优化建议

1. **JWT Token认证：** 考虑使用JWT Token替代直接传递`worker_id`，提高安全性
2. **API密钥：** 为管理端API添加API密钥验证
3. **操作日志：** 记录所有权限验证和API调用，便于审计
4. **速率限制：** 添加API调用频率限制，防止滥用

---

**文档生成时间：** 2024年
**最后更新：** 服务端权限验证机制已实现

