# æ ¸å¿ƒæ•°æ®æ¨¡å‹ä¸ä¸šåŠ¡é€»è¾‘æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£è¯´æ˜
æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†ç³»ç»Ÿçš„æ ¸å¿ƒæ•°æ®æ¨¡å‹ã€äº‹å®æ²»ç†å±‚ã€ä¸šåŠ¡çŠ¶æ€æµè½¬å’Œæ•°æ®å…³è”å…³ç³»ï¼Œç”¨äºæŒ‡å¯¼åç»­å¼€å‘ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§å’Œä¸šåŠ¡é€»è¾‘çš„æ­£ç¡®æ€§ã€‚

**ç”Ÿæˆæ—¶é—´**ï¼š2025-01-20  
**æ‰«æèŒƒå›´**ï¼šæ•°æ®åº“ Schemaã€API å®ç°ã€ä¸šåŠ¡é€»è¾‘ä»£ç 

---

## ä¸€ã€æ ¸å¿ƒè¡¨ç»“æ„ (Schema)

### 1.1 è®¢å•è¡¨ï¼š`delivery_orders`

**æ ¸å¿ƒå­—æ®µ**ï¼š
```sql
- id (UUID, PRIMARY KEY)              -- è®¢å•å”¯ä¸€æ ‡è¯†
- restaurant_id (UUID, NOT NULL)      -- é¤å…IDï¼ˆè®¢å•å½’å±ï¼‰
- status (TEXT, NOT NULL)              -- è®¢å•çŠ¶æ€
- created_at (TIMESTAMP)               -- è®¢å•åˆ›å»ºæ—¶é—´
- updated_at (TIMESTAMP)               -- è®¢å•æ›´æ–°æ—¶é—´
- worker_id (UUID, NULLABLE)           -- é…é€å‘˜IDï¼ˆæ¥å•æ—¶å†™å…¥ï¼‰
- assigned_to (UUID, NULLABLE)         -- åˆ†é…å¯¹è±¡ï¼ˆæ¥å•æ—¶å†™å…¥ï¼‰
- customer_confirmed (BOOLEAN)          -- å®¢æˆ·ç¡®è®¤çŠ¶æ€
- tracking_code (TEXT, NULLABLE)        -- æº¯æºç ï¼ˆå®Œæˆé…é€æ—¶å†™å…¥ï¼‰
- proof_image (TEXT, NULLABLE)         -- äº¤ä»˜å‡­è¯å›¾ç‰‡ï¼ˆå®Œæˆé…é€æ—¶å†™å…¥ï¼‰
```

**çŠ¶æ€æšä¸¾å€¼**ï¼š
- `pending` - å¾…æ¥å•
- `accepted` - å·²æ¥å•
- `delivering` - é…é€ä¸­
- `completed` - å·²å®Œæˆ
- `exception` - å¼‚å¸¸
- `rejected` - å·²æ‹’ç»
- `cancelled` - å·²å–æ¶ˆ

**å…³é”®ç´¢å¼•**ï¼š
- `restaurant_id` - ç”¨äºæŒ‰é¤å…æŸ¥è¯¢è®¢å•
- `status` - ç”¨äºçŠ¶æ€ç­›é€‰
- `worker_id` - ç”¨äºæŸ¥è¯¢é…é€å‘˜è®¢å•

### 1.2 è®¾å¤‡è¡¨ï¼š`devices`

**æ ¸å¿ƒå­—æ®µ**ï¼š
```sql
- device_id (TEXT, PRIMARY KEY)        -- è®¾å¤‡å”¯ä¸€æ ‡è¯†ï¼ˆäºŒç»´ç å€¼ï¼‰
- restaurant_id (UUID, NOT NULL)      -- é¤å…IDï¼ˆè®¾å¤‡å½’å±ï¼‰
- status (TEXT)                        -- è®¾å¤‡çŠ¶æ€ï¼ˆactive, online, offline, æŒæœ‰ï¼‰
- model (TEXT, NULLABLE)               -- è®¾å¤‡å‹å·
- address (TEXT, NULLABLE)             -- å®‰è£…åœ°å€
- installer (TEXT, NULLABLE)           -- å®‰è£…äºº
- install_date (TIMESTAMP, NULLABLE)   -- å®‰è£…æ—¥æœŸ
- is_locked (BOOLEAN)                  -- æ˜¯å¦é”å®šï¼ˆç”¨äºç‡ƒæ–™ç›‘æ§ï¼‰
- created_at (TIMESTAMP)               -- åˆ›å»ºæ—¶é—´
- updated_at (TIMESTAMP)               -- æ›´æ–°æ—¶é—´
```

**å…³é”®ç´¢å¼•**ï¼š
- `restaurant_id` - ç”¨äºæŒ‰é¤å…æŸ¥è¯¢è®¾å¤‡
- `status` - ç”¨äºçŠ¶æ€ç­›é€‰

### 1.3 èµ„äº§è¡¨ï¼š`gas_cylinders`

**æ ¸å¿ƒå­—æ®µ**ï¼š
```sql
- id (UUID, PRIMARY KEY)              -- èµ„äº§å”¯ä¸€æ ‡è¯†
- status (TEXT)                        -- èµ„äº§çŠ¶æ€ï¼ˆactive, æŒæœ‰, å›æ”¶ç­‰ï¼‰
- created_at (TIMESTAMP)               -- åˆ›å»ºæ—¶é—´
- updated_at (TIMESTAMP)               -- æ›´æ–°æ—¶é—´
```

**çŠ¶æ€æµè½¬**ï¼š
- å‡ºå‚ â†’ `active`
- é…é€å®Œæˆ â†’ `æŒæœ‰`ï¼ˆç”± `/api/orders/complete` æ›´æ–°ï¼‰
- å›æ”¶ â†’ `å›æ”¶`

### 1.4 æº¯æºè®°å½•è¡¨ï¼š`trace_logs`

**æ ¸å¿ƒå­—æ®µ**ï¼š
```sql
- id (UUID, PRIMARY KEY)              -- æº¯æºè®°å½•å”¯ä¸€æ ‡è¯†
- asset_id (TEXT, NOT NULL)           -- èµ„äº§IDï¼ˆå…³è” gas_cylinders.id æˆ– devices.device_idï¼‰
- operator_id (UUID, NOT NULL)        -- æ“ä½œäººIDï¼ˆé…é€å‘˜IDæˆ–ç³»ç»ŸIDï¼‰
- action_type (TEXT, NOT NULL)         -- æ“ä½œç±»å‹ï¼ˆæšä¸¾å€¼è§ä¸‹æ–‡ï¼‰
- order_id (UUID, NULLABLE)            -- å…³è”è®¢å•IDï¼ˆå¯é€‰ï¼‰
- created_at (TIMESTAMP)               -- æ“ä½œæ—¶é—´
```

**æ“ä½œç±»å‹æšä¸¾**ï¼ˆäº‹å®å±‚ codeï¼‰ï¼š
- `ASSET_CREATED` - èµ„äº§åˆ›å»ºï¼ˆå‡ºå‚ï¼‰
- `ASSET_FILLED` - èµ„äº§å……è£…
- `ASSET_DELIVERED` - èµ„äº§é…é€
- `ASSET_RETURNED` - èµ„äº§å›æ”¶
- `ASSET_INSPECTED` - èµ„äº§å®‰æ£€

**å…³é”®ç´¢å¼•**ï¼š
- `asset_id` - ç”¨äºæŸ¥è¯¢èµ„äº§çš„æ‰€æœ‰æ“ä½œè®°å½•
- `order_id` - ç”¨äºæŸ¥è¯¢è®¢å•å…³è”çš„èµ„äº§æ“ä½œ
- `created_at` - ç”¨äºæ—¶é—´æ’åº

### 1.5 å®¡è®¡æ—¥å¿—è¡¨ï¼š`audit_logs`

**æ ¸å¿ƒå­—æ®µ**ï¼š
```sql
- id (UUID, PRIMARY KEY)              -- å®¡è®¡è®°å½•å”¯ä¸€æ ‡è¯†
- actor_id (UUID, NULLABLE)            -- æ“ä½œäººIDï¼ˆç”¨æˆ·IDæˆ–é…é€å‘˜IDï¼‰
- action (TEXT, NOT NULL)              -- æ“ä½œåŠ¨ä½œï¼ˆORDER_ACCEPTED, ORDER_COMPLETED ç­‰ï¼‰
- target_type (TEXT, NOT NULL)         -- ç›®æ ‡ç±»å‹ï¼ˆdelivery_order, device ç­‰ï¼‰
- target_id (UUID, NOT NULL)           -- ç›®æ ‡IDï¼ˆè®¢å•IDã€è®¾å¤‡IDç­‰ï¼‰
- metadata (JSONB, NULLABLE)           -- å…ƒæ•°æ®ï¼ˆçŠ¶æ€å˜æ›´å‰åã€æ“ä½œäººè§’è‰²ç­‰ï¼‰
- created_at (TIMESTAMP)               -- æ“ä½œæ—¶é—´
```

**å…³é”®æ“ä½œåŠ¨ä½œ**ï¼š
- `ORDER_ACCEPTED` / `ORDER_ACCEPT` - è®¢å•è¢«æ¥å•
- `ORDER_COMPLETED` / `ORDER_COMPLETE` - è®¢å•å®Œæˆ
- `ORDER_DISPATCHED` - è®¢å•æ´¾é€
- `ORDER_REJECTED` - è®¢å•è¢«æ‹’ç»

**å…³é”®ç´¢å¼•**ï¼š
- `target_type` + `target_id` - ç”¨äºæŸ¥è¯¢ç‰¹å®šå¯¹è±¡çš„æ‰€æœ‰æ“ä½œè®°å½•
- `action` - ç”¨äºç­›é€‰ç‰¹å®šæ“ä½œ
- `created_at` - ç”¨äºæ—¶é—´æ’åº

### 1.6 IoT ç›‘æ§æ•°æ®è¡¨ï¼š`fuel_level`

**æ ¸å¿ƒå­—æ®µ**ï¼š
```sql
- id (UUID, PRIMARY KEY)              -- è®°å½•å”¯ä¸€æ ‡è¯†
- device_id (TEXT, NOT NULL)           -- è®¾å¤‡IDï¼ˆå…³è” devices.device_idï¼‰
- percentage (NUMERIC)                 -- ç‡ƒæ–™å‰©ä½™ç™¾åˆ†æ¯”ï¼ˆ0-100ï¼‰
- is_locked (BOOLEAN)                  -- æ˜¯å¦é”å®šï¼ˆä» devices.is_locked åŒæ­¥ï¼‰
- created_at (TIMESTAMP)               -- è®°å½•æ—¶é—´
```

**æ•°æ®æ›´æ–°æ–¹å¼**ï¼š
- âœ… **é€šè¿‡ Webhook å†™å…¥**ï¼ˆ`POST /api/fuel-sensor`ï¼‰
- âŒ **ä¸æ˜¯å®šæ—¶è½®è¯¢æ›´æ–°**

**æ•°æ®æµå‘**ï¼š
```
IoTä¼ æ„Ÿå™¨è®¾å¤‡ â†’ POST /api/fuel-sensor â†’ fuel_level è¡¨
```

**å…³é”®ç´¢å¼•**ï¼š
- `device_id` - ç”¨äºæŸ¥è¯¢è®¾å¤‡çš„å†å²æ•°æ®
- `created_at` - ç”¨äºæ—¶é—´æ’åºå’ŒæŸ¥è¯¢æœ€æ–°æ•°æ®

---

## äºŒã€äº‹å®æ²»ç†å±‚ (Fact Logic)

### 2.1 è®¢å•äº‹å®æ—¶é—´çº¿èšåˆé€»è¾‘

**API ç«¯ç‚¹**ï¼š`GET /api/facts/orders/:order_id`

**æ•°æ®èšåˆæµç¨‹**ï¼š

```
1. æŸ¥è¯¢è®¢å•åŸºæœ¬ä¿¡æ¯
   â””â”€ SELECT * FROM delivery_orders WHERE id = :order_id
      â””â”€ è·å–ï¼šorder_id, restaurant_id, status, created_at, worker_id

2. æŸ¥è¯¢è®¢å•çŠ¶æ€å˜åŒ–è®°å½•
   â””â”€ SELECT * FROM audit_logs 
      WHERE target_type = 'delivery_order' AND target_id = :order_id
      ORDER BY created_at ASC
      â””â”€ æå– accepted_atï¼ˆORDER_ACCEPTED/ORDER_ACCEPT çš„ created_atï¼‰
      â””â”€ æå– completed_atï¼ˆORDER_COMPLETED/ORDER_COMPLETE çš„ created_atï¼‰

3. æŸ¥è¯¢è®¢å•å…³è”çš„æº¯æºè®°å½•
   â””â”€ SELECT * FROM trace_logs 
      WHERE order_id = :order_id
      ORDER BY created_at ASC
      â””â”€ è·å–æ‰€æœ‰èµ„äº§æ“ä½œè®°å½•ï¼ˆæŒ‰æ—¶é—´æ­£åºï¼‰

4. é€šè¿‡ trace_logs åæŸ¥å…³è”èµ„äº§
   â””â”€ æå–æ‰€æœ‰å”¯ä¸€çš„ asset_id
      â””â”€ SELECT * FROM gas_cylinders WHERE id IN (:asset_ids)
         â””â”€ ä¸ºæ¯ä¸ªèµ„äº§æŸ¥è¯¢æœ€åä¸€æ¬¡æ“ä½œï¼ˆä» trace_logsï¼‰
            â””â”€ SELECT * FROM trace_logs 
               WHERE asset_id = :asset_id 
               ORDER BY created_at DESC LIMIT 1
```

**è¿”å›ç»“æ„**ï¼š
```typescript
{
  success: true,
  order: OrderFactContract,      // è®¢å•äº‹å®
  assets: AssetFactContract[],   // å…³è”èµ„äº§äº‹å®åˆ—è¡¨
  traces: TraceFactContract[],    // æº¯æºè®°å½•åˆ—è¡¨ï¼ˆæŒ‰æ—¶é—´æ­£åºï¼‰
  fact_warnings?: string[]        // äº‹å®è­¦å‘Šï¼ˆå¦‚æœ‰ï¼‰
}
```

### 2.2 äº‹å®ä¸ä¸€è‡´è§„åˆ™ï¼ˆFact Governance Rulesï¼‰

**æ²»ç†å±‚æ–‡ä»¶**ï¼š`lib/facts/governance/order.fact.guard.ts`

**æ ¸å¿ƒåŸåˆ™**ï¼š
- âœ… **æš´éœ²å¼‚å¸¸äº‹å®**ï¼Œè€Œéä¿®å¤äº‹å®
- âœ… **ä¸é˜»æ–­ API å“åº”**ï¼Œåªè®°å½•è­¦å‘Š
- âœ… **UI å±‚åªèƒ½å±•ç¤º**ï¼Œä¸å¾—ä¿®å¤æˆ–æ¨æ–­

**å®šä¹‰çš„ 4 ç§ä¸ä¸€è‡´è§„åˆ™**ï¼š

#### è§„åˆ™ 1ï¼š`accepted_at` å­˜åœ¨ä½† `audit_logs` æ— å¯¹åº”è®°å½•
```typescript
if (order.accepted_at !== null && order.accepted_at !== undefined) {
  const hasAcceptRecord = audit_logs.some(log => 
    log.action?.toUpperCase() === "ORDER_ACCEPTED" || 
    log.action?.toUpperCase() === "ORDER_ACCEPT"
  )
  if (!hasAcceptRecord) {
    warnings.push("è¿åäº‹å®å¥‘çº¦ï¼šorder.accepted_at å­˜åœ¨ï¼Œä½† audit_logs ä¸­æ— å¯¹åº”çš„ ORDER_ACCEPTED/ORDER_ACCEPT è®°å½•")
  }
}
```

#### è§„åˆ™ 2ï¼š`completed_at` æ—©äº `created_at`
```typescript
if (order.completed_at && order.created_at) {
  const completedTime = new Date(order.completed_at).getTime()
  const createdTime = new Date(order.created_at).getTime()
  if (completedTime < createdTime) {
    warnings.push("è¿åäº‹å®å¥‘çº¦ï¼šorder.completed_at æ—©äº order.created_atã€‚æ—¶é—´é€»è¾‘å¼‚å¸¸ã€‚")
  }
}
```

#### è§„åˆ™ 3ï¼š`trace.action_type` ä¸åœ¨å…è®¸æšä¸¾å†…
```typescript
const allowedActionTypes = [
  'ASSET_CREATED', 'ASSET_FILLED', 'ASSET_DELIVERED', 
  'ASSET_RETURNED', 'ASSET_INSPECTED'
]
traces.forEach((trace, index) => {
  if (!allowedActionTypes.includes(trace.action_type)) {
    warnings.push(`è¿åäº‹å®å¥‘çº¦ï¼štraces[${index}].action_type ä¸åœ¨å…è®¸çš„æšä¸¾å€¼å†…`)
  }
})
```

#### è§„åˆ™ 4ï¼š`trace.created_at` æ—©äº `order.created_at` ä¸”å…³è”è®¢å•
```typescript
if (order.created_at) {
  traces.forEach((trace, index) => {
    if (trace.created_at < order.created_at) {
      if (trace.order_id === order.order_id) {
        warnings.push("è¿åäº‹å®å¥‘çº¦ï¼šè¿½æº¯è®°å½•æ—©äºè®¢å•åˆ›å»ºï¼Œä½†å…³è”äº†å½“å‰è®¢å•ã€‚æ—¶é—´çº¿æ–­è£‚ã€‚")
      } else {
        warnings.push("æ—¶é—´çº¿å¼‚å¸¸ï¼ˆå¯èƒ½åˆç†ï¼‰ï¼šè¿½æº¯è®°å½•æ—©äºè®¢å•åˆ›å»ºï¼Œä½†æœªå…³è”å½“å‰è®¢å•ã€‚å¯èƒ½æ˜¯è®¢å•åˆ›å»ºå‰çš„èµ„äº§æ“ä½œã€‚")
      }
    }
  })
}
```

**è­¦å‘Šå¤„ç†**ï¼š
- æ‰€æœ‰è­¦å‘Šè®°å½•åˆ° `console.error`
- è­¦å‘Šæ·»åŠ åˆ° API å“åº”çš„ `fact_warnings` å­—æ®µ
- **ä¸é˜»æ–­ API å“åº”**ï¼Œæ•°æ®æ­£å¸¸è¿”å›

---

## ä¸‰ã€ä¸šåŠ¡çŠ¶æ€æµè½¬

### 3.1 è®¢å•ç”Ÿå‘½å‘¨æœŸ

#### é˜¶æ®µ 1ï¼šè®¢å•åˆ›å»º
**è§¦å‘ç‚¹**ï¼šç”¨æˆ·ä¸‹å•ï¼ˆ`/payment` é¡µé¢æäº¤ï¼‰

**æ•°æ®åº“æ“ä½œ**ï¼š
```sql
INSERT INTO delivery_orders (
  id, restaurant_id, status, created_at, updated_at
) VALUES (
  :order_id, :restaurant_id, 'pending', NOW(), NOW()
)
```

**æ¶‰åŠè¡¨**ï¼š
- âœ… `delivery_orders` - åˆ›å»ºè®¢å•è®°å½•

#### é˜¶æ®µ 2ï¼šå‘˜å·¥æ¥å•
**è§¦å‘ç‚¹**ï¼šå‘˜å·¥ç«¯è°ƒç”¨ `POST /api/orders/accept`

**æ•°æ®åº“æ“ä½œ**ï¼š
```sql
UPDATE delivery_orders 
SET 
  status = 'accepted',
  worker_id = :worker_id,
  assigned_to = :worker_id,
  customer_confirmed = true,
  updated_at = NOW()
WHERE id = :order_id AND status = 'pending'
```

**åŒæ—¶å†™å…¥å®¡è®¡æ—¥å¿—**ï¼š
```sql
INSERT INTO audit_logs (
  actor_id, action, target_type, target_id, metadata, created_at
) VALUES (
  :worker_id, 'ORDER_ACCEPTED', 'delivery_order', :order_id, 
  { previous_status: 'pending', next_status: 'accepted' }, NOW()
)
```

**æ¶‰åŠè¡¨**ï¼š
- âœ… `delivery_orders` - æ›´æ–°è®¢å•çŠ¶æ€ã€worker_idã€assigned_to
- âœ… `audit_logs` - è®°å½•æ¥å•æ“ä½œ

**æ ¸å¿ƒå­—æ®µå˜æ›´**ï¼š
- `status`: `pending` â†’ `accepted`
- `worker_id`: `NULL` â†’ `:worker_id`
- `assigned_to`: `NULL` â†’ `:worker_id`
- `customer_confirmed`: `false` â†’ `true`

#### é˜¶æ®µ 3ï¼šé…é€ä¸­
**è§¦å‘ç‚¹**ï¼šè®¢å•çŠ¶æ€æµè½¬åˆ° `delivering`ï¼ˆå¯èƒ½ç”±æ´¾é€ API è§¦å‘ï¼‰

**æ•°æ®åº“æ“ä½œ**ï¼š
```sql
UPDATE delivery_orders 
SET status = 'delivering', updated_at = NOW()
WHERE id = :order_id AND status = 'accepted'
```

**æ¶‰åŠè¡¨**ï¼š
- âœ… `delivery_orders` - æ›´æ–°è®¢å•çŠ¶æ€

#### é˜¶æ®µ 4ï¼šå®Œæˆé…é€
**è§¦å‘ç‚¹**ï¼šå‘˜å·¥ç«¯è°ƒç”¨ `POST /api/orders/complete`

**æ•°æ®åº“æ“ä½œ**ï¼š
```sql
-- 1. æ›´æ–°è®¢å•çŠ¶æ€
UPDATE delivery_orders 
SET 
  status = 'completed',
  tracking_code = :tracking_code,
  proof_image = :proof_image,
  updated_at = NOW()
WHERE id = :order_id AND status = 'delivering'

-- 2. å†™å…¥æº¯æºè®°å½•ï¼ˆå¦‚æœæä¾›äº† asset_idsï¼‰
INSERT INTO trace_logs (
  asset_id, operator_id, action_type, order_id, created_at
) VALUES 
  (:asset_id_1, :worker_id, 'ASSET_DELIVERED', :order_id, NOW()),
  (:asset_id_2, :worker_id, 'ASSET_DELIVERED', :order_id, NOW()),
  ...

-- 3. æ›´æ–°èµ„äº§çŠ¶æ€
UPDATE gas_cylinders 
SET status = 'æŒæœ‰', updated_at = NOW()
WHERE id IN (:asset_ids)

-- 4. å†™å…¥å®¡è®¡æ—¥å¿—
INSERT INTO audit_logs (
  actor_id, action, target_type, target_id, metadata, created_at
) VALUES (
  :worker_id, 'ORDER_COMPLETED', 'delivery_order', :order_id,
  { previous_status: 'delivering', next_status: 'completed', asset_ids: [...] }, NOW()
)
```

**æ¶‰åŠè¡¨**ï¼š
- âœ… `delivery_orders` - æ›´æ–°è®¢å•çŠ¶æ€ã€tracking_codeã€proof_image
- âœ… `trace_logs` - è®°å½•èµ„äº§é…é€æ“ä½œ
- âœ… `gas_cylinders` - æ›´æ–°èµ„äº§çŠ¶æ€ä¸º"æŒæœ‰"
- âœ… `audit_logs` - è®°å½•å®Œæˆæ“ä½œ

**æ ¸å¿ƒå­—æ®µå˜æ›´**ï¼š
- `status`: `delivering` â†’ `completed`
- `tracking_code`: `NULL` â†’ `:tracking_code`
- `proof_image`: `NULL` â†’ `:proof_image`
- `gas_cylinders.status`: `active` â†’ `æŒæœ‰`

### 3.2 çŠ¶æ€æµè½¬ç™½åå•

**æ–‡ä»¶**ï¼š`lib/types/order.ts`

**çŠ¶æ€æµè½¬è§„åˆ™**ï¼š
```typescript
pending â†’ [accepted, rejected, cancelled]
accepted â†’ [delivering, exception]
delivering â†’ [completed, exception, returned]
completed â†’ [] // ç»ˆæ€
exception â†’ [] // ç»ˆæ€
rejected â†’ [] // ç»ˆæ€
cancelled â†’ [] // ç»ˆæ€
```

**éªŒè¯å‡½æ•°**ï¼š`canTransitionDeliveryOrderStatus(currentStatus, targetStatus)`

---

## å››ã€æ•°æ®å…³è”ç°çŠ¶

### 4.1 `restaurantId` ä¸²è”æœºåˆ¶

**æ ¸å¿ƒå…³è”å­—æ®µ**ï¼š`restaurant_id`ï¼ˆUUIDï¼‰

#### ç”¨æˆ· â†’ é¤å…å…³è”
```
ç”¨æˆ·ï¼ˆé€šè¿‡æ‰‹æœºå·ç™»å½•ï¼‰
  â””â”€ localStorage.getItem("restaurantId")
     â””â”€ å­˜å‚¨åœ¨å®¢æˆ·ç«¯ï¼Œç”¨äº API æƒé™éªŒè¯
```

**éªŒè¯é€»è¾‘**ï¼ˆ`lib/auth/facts-auth.ts`ï¼‰ï¼š
```typescript
// 1. æ£€æŸ¥ Supabase Auth user
const { data: { user } } = await supabase.auth.getUser()

// 2. æ£€æŸ¥å®¢æˆ·ç«¯ restaurantIdï¼ˆlocalStorageï¼‰
const restaurantId = localStorage.getItem("restaurantId")

// 3. éªŒè¯è¯·æ±‚ä¸­çš„ restaurant_id æ˜¯å¦åŒ¹é…
if (requestRestaurantId !== userRestaurantId) {
  return 403 // æƒé™æ‹’ç»
}
```

#### é¤å… â†’ è®¾å¤‡å…³è”
```
restaurant_id (delivery_orders.restaurant_id)
  â””â”€ devices.restaurant_id
     â””â”€ ä¸€ä¸ªé¤å…å¯ä»¥æœ‰å¤šä¸ªè®¾å¤‡
```

**æŸ¥è¯¢ç¤ºä¾‹**ï¼š
```sql
SELECT * FROM devices 
WHERE restaurant_id = :restaurant_id
```

#### é¤å… â†’ è®¢å•å…³è”
```
restaurant_id (delivery_orders.restaurant_id)
  â””â”€ ä¸€ä¸ªé¤å…å¯ä»¥æœ‰å¤šä¸ªè®¢å•
```

**æŸ¥è¯¢ç¤ºä¾‹**ï¼š
```sql
SELECT * FROM delivery_orders 
WHERE restaurant_id = :restaurant_id
```

#### è®¢å• â†’ èµ„äº§å…³è”ï¼ˆé€šè¿‡ trace_logsï¼‰
```
delivery_orders.id
  â””â”€ trace_logs.order_id
     â””â”€ trace_logs.asset_id
        â””â”€ gas_cylinders.id
```

**æŸ¥è¯¢ç¤ºä¾‹**ï¼š
```sql
-- æŸ¥è¯¢è®¢å•å…³è”çš„æ‰€æœ‰èµ„äº§
SELECT DISTINCT asset_id 
FROM trace_logs 
WHERE order_id = :order_id
```

### 4.2 æ•°æ®æµå‘å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·ç™»å½•      â”‚
â”‚ (æ‰‹æœºå·/å¯†ç )   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ localStorage    â”‚
â”‚ restaurantId    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 â”‚
         â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   devices è¡¨    â”‚  â”‚ delivery_orders â”‚
â”‚ restaurant_id   â”‚  â”‚ restaurant_id   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚
         â”‚                    â”‚
         â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  fuel_level è¡¨  â”‚  â”‚  trace_logs è¡¨  â”‚
â”‚  device_id      â”‚  â”‚  order_id       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚ gas_cylinders   â”‚
                     â”‚ id (asset_id)   â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 IoT è®¾å¤‡å®æ—¶æ•°æ®æ›´æ–°æœºåˆ¶

#### æ•°æ®æ›´æ–°æ–¹å¼ï¼š**Webhookï¼ˆæ¨é€ï¼‰**

**API ç«¯ç‚¹**ï¼š`POST /api/fuel-sensor`

**è¯·æ±‚æ ¼å¼**ï¼š
```json
{
  "device_id": "è®¾å¤‡ID",
  "percentage": 68.5  // ç‡ƒæ–™å‰©ä½™ç™¾åˆ†æ¯”ï¼ˆ0-100ï¼‰
}
```

**å¤„ç†æµç¨‹**ï¼š
```typescript
1. æ¥æ”¶ä¼ æ„Ÿå™¨æ•°æ®ï¼ˆPOST /api/fuel-sensorï¼‰
   â””â”€ éªŒè¯ device_id å’Œ percentage

2. æŸ¥è¯¢è®¾å¤‡é”å®šçŠ¶æ€
   â””â”€ SELECT is_locked FROM devices WHERE device_id = :device_id

3. æ’å…¥æ–°è®°å½•
   â””â”€ INSERT INTO fuel_level (device_id, percentage, is_locked, created_at)
      VALUES (:device_id, :percentage, :is_locked, NOW())
```

**æ•°æ®æŸ¥è¯¢**ï¼ˆå‰ç«¯å±•ç¤ºï¼‰ï¼š
```typescript
// æŸ¥è¯¢æœ€æ–°æ•°æ®
GET /api/fuel-sensor?device_id=:device_id
  â””â”€ SELECT * FROM fuel_level 
     WHERE device_id = :device_id 
     ORDER BY created_at DESC 
     LIMIT 1
```

**å…³é”®ç‰¹ç‚¹**ï¼š
- âœ… **å®æ—¶æ¨é€**ï¼šä¼ æ„Ÿå™¨ä¸»åŠ¨æ¨é€æ•°æ®ï¼Œæ— éœ€è½®è¯¢
- âœ… **å†å²è®°å½•**ï¼šæ¯æ¬¡æ¨é€éƒ½åˆ›å»ºæ–°è®°å½•ï¼Œä¿ç•™å†å²æ•°æ®
- âœ… **è®¾å¤‡å…³è”**ï¼šé€šè¿‡ `device_id` å…³è”åˆ° `devices` è¡¨
- âœ… **é”å®šçŠ¶æ€åŒæ­¥**ï¼šä» `devices.is_locked` åŒæ­¥åˆ° `fuel_level.is_locked`

**å‰ç«¯å±•ç¤ºé€»è¾‘**ï¼ˆ`components/iot-dashboard.tsx`ï¼‰ï¼š
```typescript
// å½“å‰å®ç°ï¼šæ¨¡æ‹Ÿæ•°æ®ï¼ˆæ¯3ç§’é€’å‡0.1%ï¼‰
// å®é™…åº”è¯¥ï¼šæŸ¥è¯¢ /api/fuel-sensor?device_id=:device_id è·å–æœ€æ–°æ•°æ®
const [fuelLevel, setFuelLevel] = useState(68)
useEffect(() => {
  const interval = setInterval(() => {
    setFuelLevel((prev) => prev - 0.1) // æ¨¡æ‹Ÿæ•°æ®
  }, 3000)
  return () => clearInterval(interval)
}, [])
```

**å»ºè®®æ”¹è¿›**ï¼š
- å°†æ¨¡æ‹Ÿæ•°æ®æ›¿æ¢ä¸ºå®é™… API è°ƒç”¨
- ä½¿ç”¨ Supabase Realtime è®¢é˜… `fuel_level` è¡¨å˜æ›´
- å®ç°æ•°æ®ç¼“å­˜å’Œå¢é‡æ›´æ–°

---

## äº”ã€å…³é”®æ•°æ®çº¦æŸ

### 5.1 äº‹å®å¥‘çº¦çº¦æŸ

**æ ¸å¿ƒåŸåˆ™**ï¼š
- âœ… **åªè¿”å›å®é™…å­˜åœ¨çš„è®°å½•**ï¼Œä¸æ¨æ–­ã€ä¸é»˜è®¤ã€ä¸å…œåº•
- âœ… **ç©ºå€¼æ˜ç¡®è¡¨è¾¾"äº‹å®ä¸å­˜åœ¨"**ï¼Œä½¿ç”¨ `null` è€Œé `undefined`
- âœ… **æ—¶é—´å­—æ®µåªèƒ½æ¥è‡ªå®é™…è®°å½•**ï¼Œä¸èƒ½ä»çŠ¶æ€æ¨æ–­

**å­—æ®µæ¥æºçº¦æŸ**ï¼š

| å­—æ®µ | æ•°æ®æ¥æº | ç©ºå€¼å«ä¹‰ |
|------|---------|---------|
| `order.accepted_at` | `audit_logs.created_at` (ORDER_ACCEPTED) | äº‹å®ä¸å­˜åœ¨ï¼ˆæ— æ¥å•è®°å½•ï¼‰ |
| `order.completed_at` | `audit_logs.created_at` (ORDER_COMPLETED) | äº‹å®ä¸å­˜åœ¨ï¼ˆæ— å®Œæˆè®°å½•ï¼‰ |
| `asset.last_action` | `trace_logs.action_type` (æœ€åä¸€æ¬¡) | ç©ºå­—ç¬¦ä¸²ï¼ˆæ— æº¯æºè®°å½•ï¼‰ |
| `asset.last_action_at` | `trace_logs.created_at` (æœ€åä¸€æ¬¡) | `null`ï¼ˆæ— æº¯æºè®°å½•ï¼‰ |

**ç¦æ­¢æ“ä½œ**ï¼š
- âŒ ä» `delivery_orders.status` æ¨æ–­ `accepted_at` æˆ– `completed_at`
- âŒ ä½¿ç”¨ `delivery_orders.updated_at` ä½œä¸ºæ—¶é—´å…œåº•
- âŒ ä½¿ç”¨ `gas_cylinders.updated_at` ä½œä¸º `last_action_at`
- âŒ UI å±‚è‡ªè¡Œç”Ÿæˆæˆ–æ¨æ–­æ—¶é—´

### 5.2 çŠ¶æ€æµè½¬çº¦æŸ

**çŠ¶æ€æµè½¬å¿…é¡»é€šè¿‡ç™½åå•éªŒè¯**ï¼š
```typescript
canTransitionDeliveryOrderStatus(currentStatus, targetStatus)
```

**ç¦æ­¢æ“ä½œ**ï¼š
- âŒ è·³è¿‡ä¸­é—´çŠ¶æ€ï¼ˆå¦‚ï¼š`pending` â†’ `completed`ï¼‰
- âŒ é€†å‘æµè½¬ï¼ˆå¦‚ï¼š`completed` â†’ `accepted`ï¼‰
- âŒ ç¡¬ç¼–ç çŠ¶æ€æµè½¬é€»è¾‘

### 5.3 æƒé™çº¦æŸ

**æ‰€æœ‰ `/api/facts/**` ç«¯ç‚¹**ï¼š
- âœ… å¿…é¡»éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€
- âœ… å¿…é¡»éªŒè¯ `restaurant_id` åŒ¹é…
- âœ… ç¦æ­¢ä½¿ç”¨ `service role` å¯†é’¥
- âœ… ç¦æ­¢å¤ç”¨ç®¡ç†ç«¯ API

---

## å…­ã€æ•°æ®æµå‘æ€»ç»“

### 6.1 è®¢å•äº‹å®æ—¶é—´çº¿èšåˆæµç¨‹

```
ç”¨æˆ·è¯·æ±‚ GET /api/facts/orders/:order_id
  â”‚
  â”œâ”€ 1. æŸ¥è¯¢ delivery_ordersï¼ˆè®¢å•åŸºæœ¬ä¿¡æ¯ï¼‰
  â”‚     â””â”€ è·å–ï¼šid, restaurant_id, status, created_at, worker_id
  â”‚
  â”œâ”€ 2. æŸ¥è¯¢ audit_logsï¼ˆçŠ¶æ€å˜åŒ–è®°å½•ï¼‰
  â”‚     â””â”€ æå–ï¼šaccepted_at, completed_at
  â”‚
  â”œâ”€ 3. æŸ¥è¯¢ trace_logsï¼ˆèµ„äº§æ“ä½œè®°å½•ï¼‰
  â”‚     â””â”€ è·å–ï¼šæ‰€æœ‰å…³è”è®¢å•çš„èµ„äº§æ“ä½œï¼ˆæŒ‰æ—¶é—´æ­£åºï¼‰
  â”‚
  â”œâ”€ 4. åæŸ¥ gas_cylindersï¼ˆå…³è”èµ„äº§ï¼‰
  â”‚     â””â”€ ä¸ºæ¯ä¸ªèµ„äº§æŸ¥è¯¢æœ€åä¸€æ¬¡æ“ä½œ
  â”‚
  â”œâ”€ 5. äº‹å®æ²»ç†å±‚æ£€æŸ¥
  â”‚     â””â”€ OrderFactGuard() â†’ fact_warnings[]
  â”‚
  â””â”€ 6. è¿”å›èšåˆç»“æœ
        â””â”€ { order, assets, traces, fact_warnings? }
```

### 6.2 è®¢å•çŠ¶æ€æµè½¬æµç¨‹

```
è®¢å•åˆ›å»º
  â”‚
  â”œâ”€ delivery_orders: INSERT (status='pending')
  â”‚
  â–¼
å‘˜å·¥æ¥å•
  â”‚
  â”œâ”€ delivery_orders: UPDATE (status='accepted', worker_id=...)
  â”œâ”€ audit_logs: INSERT (action='ORDER_ACCEPTED')
  â”‚
  â–¼
é…é€ä¸­
  â”‚
  â”œâ”€ delivery_orders: UPDATE (status='delivering')
  â”‚
  â–¼
å®Œæˆé…é€
  â”‚
  â”œâ”€ delivery_orders: UPDATE (status='completed', tracking_code=..., proof_image=...)
  â”œâ”€ trace_logs: INSERT (action_type='ASSET_DELIVERED', asset_id=...)
  â”œâ”€ gas_cylinders: UPDATE (status='æŒæœ‰')
  â””â”€ audit_logs: INSERT (action='ORDER_COMPLETED')
```

### 6.3 IoT æ•°æ®æ›´æ–°æµç¨‹

```
IoTä¼ æ„Ÿå™¨è®¾å¤‡
  â”‚
  â”œâ”€ POST /api/fuel-sensor
  â”‚   â””â”€ { device_id, percentage }
  â”‚
  â”œâ”€ æŸ¥è¯¢ devices.is_locked
  â”‚
  â””â”€ INSERT INTO fuel_level
      â””â”€ (device_id, percentage, is_locked, created_at)
```

---

## ä¸ƒã€å…³é”®ä»£ç ä½ç½®

### 7.1 äº‹å®èšåˆ API
- **è®¢å•äº‹å®**ï¼š`app/api/facts/orders/[order_id]/route.ts`
- **é¤å…æ€»è§ˆ**ï¼š`app/api/facts/restaurant/[restaurant_id]/overview/route.ts`
- **èµ„äº§åˆ—è¡¨**ï¼š`app/api/facts/restaurant/[restaurant_id]/assets/route.ts`

### 7.2 äº‹å®æ²»ç†å±‚
- **æ²»ç†å™¨**ï¼š`lib/facts/governance/order.fact.guard.ts`
- **äº‹å®å¥‘çº¦**ï¼š`lib/facts/contracts/order.fact.ts`
- **ç±»å‹å®šä¹‰**ï¼š`lib/facts/types.ts`

### 7.3 ä¸šåŠ¡çŠ¶æ€æµè½¬
- **æ¥å• API**ï¼š`app/api/orders/accept/route.ts`
- **å®Œæˆ API**ï¼š`app/api/orders/complete/route.ts`
- **çŠ¶æ€æµè½¬éªŒè¯**ï¼š`lib/types/order.ts`

### 7.4 IoT æ•°æ®
- **ä¼ æ„Ÿå™¨ API**ï¼š`app/api/fuel-sensor/route.ts`
- **å‰ç«¯å±•ç¤º**ï¼š`components/iot-dashboard.tsx`

---

## å…«ã€æ³¨æ„äº‹é¡¹ä¸å»ºè®®

### 8.1 æ•°æ®ä¸€è‡´æ€§

1. **æ—¶é—´å­—æ®µæ¥æº**ï¼š
   - âœ… `accepted_at` / `completed_at` åªèƒ½æ¥è‡ª `audit_logs`
   - âŒ ç¦æ­¢ä» `delivery_orders.status` æ¨æ–­

2. **èµ„äº§æ“ä½œè®°å½•**ï¼š
   - âœ… `last_action_at` åªèƒ½æ¥è‡ª `trace_logs.created_at`
   - âŒ ç¦æ­¢ä½¿ç”¨ `gas_cylinders.updated_at` ä½œä¸ºå…œåº•

3. **çŠ¶æ€æµè½¬**ï¼š
   - âœ… å¿…é¡»é€šè¿‡ç™½åå•éªŒè¯
   - âŒ ç¦æ­¢ç¡¬ç¼–ç çŠ¶æ€æµè½¬é€»è¾‘

### 8.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **äº‹å®èšåˆ API**ï¼š
   - è€ƒè™‘æ·»åŠ ç¼“å­˜å±‚ï¼ˆRedisï¼‰
   - ä¼˜åŒ– SQL æŸ¥è¯¢ï¼ˆä½¿ç”¨ JOIN è€Œéå¤šæ¬¡æŸ¥è¯¢ï¼‰

2. **IoT æ•°æ®æŸ¥è¯¢**ï¼š
   - ä½¿ç”¨ Supabase Realtime è®¢é˜…æœ€æ–°æ•°æ®
   - å®ç°æ•°æ®åˆ†é¡µå’Œå¢é‡æ›´æ–°

3. **å®¡è®¡æ—¥å¿—æŸ¥è¯¢**ï¼š
   - æ·»åŠ æ—¶é—´èŒƒå›´ç´¢å¼•
   - è€ƒè™‘å½’æ¡£å†å²æ•°æ®

### 8.3 æ•°æ®è´¨é‡ç›‘æ§

1. **äº‹å®æ²»ç†å±‚**ï¼š
   - å®šæœŸæ£€æŸ¥ `fact_warnings` å‡ºç°é¢‘ç‡
   - å»ºç«‹æ•°æ®è´¨é‡å‘Šè­¦æœºåˆ¶

2. **çŠ¶æ€æµè½¬å¼‚å¸¸**ï¼š
   - ç›‘æ§çŠ¶æ€æµè½¬å¤±è´¥ç‡
   - è®°å½•å¼‚å¸¸æµè½¬å°è¯•

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-01-20  
**ç»´æŠ¤è€…**ï¼šCursor AI Assistant
