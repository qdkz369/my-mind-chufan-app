# 测试登录功能指南

## ✅ 第一步已完成
SQL 策略已成功创建，4条策略都已生效：
- ✅ `service_role_all` - Service Role 完全访问
- ✅ `users_read_own_role` - 用户读取自己的角色
- ✅ `users_insert_own_role` - 用户插入自己的角色
- ✅ `users_update_own_role` - 用户更新自己的角色

---

## 🔄 第二步：清除缓存并重启服务器

### 方法一：使用无痕模式（推荐）
1. 打开浏览器的无痕/隐私模式
   - Chrome/Edge: `Ctrl + Shift + N`
   - Firefox: `Ctrl + Shift + P`
2. 访问 `http://localhost:3000/login`

### 方法二：清除浏览器缓存
1. 按 `Ctrl + Shift + Delete` 打开清除数据对话框
2. 选择"缓存的图片和文件"
3. 时间范围选择"全部时间"
4. 点击"清除数据"
5. 关闭所有浏览器标签页
6. 重新打开浏览器访问 `http://localhost:3000/login`

### 重启开发服务器
```bash
# 如果服务器正在运行，先按 Ctrl+C 停止
# 然后重新启动
npm run dev
```

---

## 🧪 第三步：测试登录功能

### 测试步骤

1. **访问登录页面**
   - 打开 `http://localhost:3000/login`
   - 应该看到登录表单，没有错误提示

2. **输入管理员账号**
   - 邮箱：你的管理员邮箱（例如：`admin@test.com`）
   - 密码：你的管理员密码

3. **点击登录按钮**
   - 观察页面变化
   - 应该看到"登录中..."的加载状态

4. **检查是否成功跳转**
   - ✅ **成功**：自动跳转到 `/dashboard` 页面
   - ❌ **失败**：停留在登录页面或出现错误提示

5. **打开浏览器控制台（F12）**
   - 查看 Console 标签页的日志
   - 查看 Network 标签页的网络请求
   - 记录任何错误信息

---

## 🔍 预期结果

### 成功的标志
- ✅ 登录后自动跳转到 `/dashboard`
- ✅ 控制台没有红色错误信息
- ✅ 网络请求中 `/user_roles` 查询返回 200 状态码
- ✅ 能看到类似 `[登录页] 登录成功，准备跳转到管理后台` 的日志

### 可能的问题和解决方案

#### 问题1：仍然出现登录循环
**症状**：点击登录后一直显示"检查登录状态..."，然后回到登录页面

**检查项**：
1. 确认 SQL 策略已执行（查看 Supabase Dashboard）
2. 检查浏览器控制台的错误信息
3. 检查网络请求中 `/user_roles` 的状态码
4. 确认管理员账号在 `user_roles` 表中有 `super_admin` 或 `admin` 角色

**解决方案**：
- 如果 `/user_roles` 请求返回 403，说明 RLS 策略可能有问题
- 如果返回 404，说明用户没有角色记录，需要执行分配角色的 SQL

#### 问题2：提示"您没有管理员权限"
**症状**：登录成功但提示没有管理员权限

**解决方案**：
1. 在 Supabase SQL Editor 中执行：
```sql
-- 检查用户是否有角色
SELECT * FROM user_roles WHERE user_id = '你的用户ID';

-- 如果没有，分配角色
INSERT INTO user_roles (user_id, role)
VALUES ('你的用户ID', 'super_admin')
ON CONFLICT (user_id) DO UPDATE SET role = 'super_admin';
```

#### 问题3：提示"查询用户角色失败"
**症状**：登录后提示权限配置错误

**检查项**：
1. 确认 RLS 策略已正确创建
2. 检查 `user_roles` 表是否存在
3. 检查用户是否有对应的角色记录

---

## 📊 调试信息收集

如果登录失败，请收集以下信息：

1. **浏览器控制台日志**
   - 复制所有 `[登录页]` 开头的日志
   - 复制所有红色错误信息

2. **网络请求**
   - 找到 `/user_roles` 的请求
   - 查看请求的 URL、状态码、响应内容

3. **Supabase 检查**
   - 确认 `user_roles` 表中有你的用户记录
   - 确认 RLS 策略已创建（4条策略）

---

## 🎯 下一步

如果登录成功：
- ✅ 测试访问其他管理后台页面
- ✅ 测试创建供应商公司功能
- ✅ 确认权限控制正常工作

如果登录失败：
- 📝 收集上述调试信息
- 🔍 根据错误信息定位问题
- 🛠️ 继续优化代码或策略

---

**测试完成后，请告诉我结果！** 🚀
