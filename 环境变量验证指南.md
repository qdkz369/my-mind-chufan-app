# 环境变量验证指南

## 📋 验证方法

### 方法 1：使用 API 测试端点（推荐，最简单）⭐

#### 步骤 1：启动开发服务器

```bash
npm run dev
```

等待服务器启动完成（看到 "Ready" 消息）

#### 步骤 2：访问测试端点

**方式 A：在浏览器中打开**

```
http://localhost:3000/api/test/env
```

**方式 B：使用 PowerShell**

```powershell
Invoke-WebRequest -Uri http://localhost:3000/api/test/env | Select-Object -ExpandProperty Content
```

**方式 C：使用 curl（如果已安装）**

```bash
curl http://localhost:3000/api/test/env
```

#### 预期响应

```json
{
  "timestamp": "2024-01-01T00:00:00.000Z",
  "checks": {
    "required": {
      "NEXT_PUBLIC_SUPABASE_URL": true,
      "NEXT_PUBLIC_SUPABASE_ANON_KEY": true,
      "SUPABASE_SERVICE_ROLE_KEY": true
    },
    "optional": {
      "NEXT_PUBLIC_AMAP_SECURITY_KEY": true
    },
    "supabaseConnection": true,
    "serviceRoleKey": true
  },
  "errors": [],
  "warnings": [],
  "summary": {
    "allRequiredPresent": true,
    "hasErrors": false,
    "hasWarnings": false,
    "status": "success"
  }
}
```

---

### 方法 2：使用测试脚本

#### 步骤 1：运行测试脚本

在项目根目录执行：

```bash
node scripts/test-env-vars.js
```

**注意：** 此方法需要手动解析 `.env.local` 文件，可能不如 API 端点准确。

---

### 方法 3：检查服务器启动日志

#### 步骤 1：启动开发服务器

```bash
npm run dev
```

#### 步骤 2：查看终端输出

查找以下日志信息：

```
[创建公司API] 环境变量检查:
NEXT_PUBLIC_SUPABASE_URL 存在: true
NEXT_PUBLIC_SUPABASE_ANON_KEY 存在: true
SUPABASE_SERVICE_ROLE_KEY 存在: true
```

如果看到这些日志，说明环境变量已正确加载。

---

### 方法 4：测试实际功能（最可靠）

#### 测试 1：登录功能

1. 访问 `http://localhost:3000/login`
2. 尝试使用管理员账号登录
3. 如果登录成功，说明 `NEXT_PUBLIC_SUPABASE_URL` 和 `NEXT_PUBLIC_SUPABASE_ANON_KEY` 正常

#### 测试 2：创建供应商

1. 登录管理后台
2. 访问供应商管理页面
3. 尝试创建新供应商
4. 如果创建成功，说明 `SUPABASE_SERVICE_ROLE_KEY` 正常

#### 测试 3：高德地图功能（如果使用）

1. 访问使用地图的页面
2. 检查地图是否正常加载
3. 如果地图正常显示，说明 `NEXT_PUBLIC_AMAP_SECURITY_KEY` 正常

---

## 🔍 常见问题诊断

### 问题 1：环境变量未加载

**症状：**
- 测试脚本显示变量未配置
- API 返回 `false`

**解决方法：**
1. 确认 `.env.local` 文件在项目根目录
2. 确认文件名是 `.env.local`（注意前面的点）
3. **重启开发服务器**（必须！）

### 问题 2：Supabase 连接失败

**症状：**
- 测试显示连接失败
- 错误代码：`PGRST116` 或其他

**可能原因：**
1. URL 或密钥错误
2. Token 已过期
3. RLS 策略阻止访问

**解决方法：**
1. 检查 Supabase Dashboard 中的 URL 和密钥
2. 重新生成新的密钥
3. 检查 RLS 策略

### 问题 3：Service Role Key 无效

**症状：**
- 创建供应商失败
- 提示 "SUPABASE_SERVICE_ROLE_KEY 未配置"

**解决方法：**
1. 确认 `.env.local` 中有 `SUPABASE_SERVICE_ROLE_KEY`
2. 确认值没有多余空格或引号
3. 重启开发服务器

---

## 📝 验证清单

完成以下检查：

- [ ] 运行测试脚本，所有必需变量显示 ✅
- [ ] 访问 `/api/test/env`，返回 `status: "success"`
- [ ] 服务器启动日志显示环境变量已加载
- [ ] 登录功能正常
- [ ] 创建供应商功能正常（如果已实现）

---

## 🚀 快速验证命令

### 一键验证（推荐）

```bash
# 1. 运行测试脚本
node scripts/test-env-vars.js

# 2. 启动服务器并测试 API（在另一个终端）
npm run dev
# 然后访问 http://localhost:3000/api/test/env
```

### 使用 curl 测试 API

```bash
# 等待服务器启动后执行
curl http://localhost:3000/api/test/env | jq
```

（需要安装 `jq` 来格式化 JSON 输出）

---

## 💡 提示

1. **环境变量只在服务器启动时加载**
   - 修改 `.env.local` 后必须重启服务器

2. **客户端 vs 服务端变量**
   - `NEXT_PUBLIC_*` 变量会暴露到客户端
   - `SUPABASE_SERVICE_ROLE_KEY` 只在服务端可用

3. **生产环境**
   - 在部署平台（如 Vercel）配置环境变量
   - 不要在生产环境使用 `.env.local`

---

**验证完成后，如果所有测试都通过，说明环境变量配置正确！** ✅
