# ç³»ç»Ÿæ¶æ„åˆ†æä¸æ”¹è¿›æ–¹æ¡ˆ

## ğŸ” é—®é¢˜åˆ†æç»“æœ

### 1. âŒ å¤šç§Ÿæˆ·éš”ç¦»æ–¹æ¡ˆ - **ä¸¥é‡å®‰å…¨æ¼æ´**

**ç°çŠ¶ï¼š**
- âŒ **ä»£ç ä¸­å®Œå…¨æ²¡æœ‰ä½¿ç”¨ `company_id` è¿›è¡Œæ•°æ®è¿‡æ»¤**
- âŒ æ‰€æœ‰ API æŸ¥è¯¢éƒ½æ²¡æœ‰æŒ‰ä¾›åº”å•†éš”ç¦»
- âŒ å¦‚æœå¼•å…¥ç¬¬ä¸‰æ–¹ä¾›åº”å•†è´¦å·ï¼Œ**ä¾›åº”å•† A å¯ä»¥çœ‹åˆ°ä¾›åº”å•† B çš„æ‰€æœ‰æ•°æ®**

**é£é™©ç­‰çº§ï¼šğŸ”´ æé«˜**

**å½±å“èŒƒå›´ï¼š**
- `rental_orders` è¡¨ - æ‰€æœ‰ç§Ÿèµè®¢å•
- `equipment_catalog` è¡¨ - æ‰€æœ‰äº§å“ä¿¡æ¯
- `orders` è¡¨ - æ‰€æœ‰è®¢å•ï¼ˆåŒ…æ‹¬æŠ¥ä¿®ï¼‰
- `restaurants` è¡¨ - æ‰€æœ‰é¤å…ä¿¡æ¯

**ç¤ºä¾‹é—®é¢˜ï¼š**
```typescript
// å½“å‰ä»£ç ï¼ˆä¸å®‰å…¨ï¼‰
const { data } = await supabase
  .from("rental_orders")
  .select("*")
  // âŒ æ²¡æœ‰ company_id è¿‡æ»¤ï¼

// åº”è¯¥æ”¹ä¸ºï¼ˆå®‰å…¨ï¼‰
const { data } = await supabase
  .from("rental_orders")
  .select("*")
  .eq("provider_id", currentCompanyId) // âœ… å¿…é¡»è¿‡æ»¤
```

---

### 2. âš ï¸ æ•°æ®åº“å…³è”å®Œæ•´æ€§ - **éƒ¨åˆ†å®ç°**

**ç°çŠ¶ï¼š**
- âœ… SQL è„šæœ¬ä¸­ä½¿ç”¨äº†å¤–é”®ï¼ˆ`REFERENCES companies(id) ON DELETE CASCADE`ï¼‰
- âš ï¸ ä½†ä»£ç ä¸­å¯èƒ½æ²¡æœ‰å……åˆ†åˆ©ç”¨å¤–é”®çº¦æŸ
- âœ… `equipment_catalog` è¡¨è®¾è®¡æ”¯æŒæ‰©å±•ï¼Œä¸ä¼šå†²çª

**å¤–é”®ä½¿ç”¨æƒ…å†µï¼š**
- âœ… `rental_orders.provider_id` â†’ `companies.id` (ON DELETE SET NULL)
- âœ… `equipment_catalog.provider_id` â†’ `companies.id` (ON DELETE CASCADE)
- âœ… `equipment_catalog.category_id` â†’ `equipment_categories.id` (ON DELETE SET NULL)
- âœ… `rental_orders.equipment_id` â†’ `equipment.id` (ON DELETE RESTRICT)

**ç»“è®ºï¼š** æ•°æ®åº“å±‚é¢æœ‰å¤–é”®çº¦æŸï¼Œä½†åº”ç”¨å±‚éœ€è¦åŠ å¼ºéªŒè¯ã€‚

---

### 3. âŒ çŠ¶æ€æµç®¡ç† - **æ•£è½å„å¤„ï¼Œæ— ç»Ÿä¸€é€»è¾‘**

**ç°çŠ¶ï¼š**
- âŒ çŠ¶æ€å˜æ›´é€»è¾‘æ•£è½åœ¨å„ä¸ªå‰ç«¯é¡µé¢
- âŒ æ²¡æœ‰ç»Ÿä¸€çš„åç«¯çŠ¶æ€æœº
- âŒ æ²¡æœ‰çŠ¶æ€å˜æ›´å†å²è®°å½•
- âŒ æ²¡æœ‰çŠ¶æ€å˜æ›´æƒé™éªŒè¯

**å½“å‰å®ç°ä½ç½®ï¼š**
- `app/(admin)/dashboard/page.tsx` - `updateRepairStatus` å‡½æ•°
- `app/(admin)/dashboard/page.tsx` - `handleUpdateRentalOrderStatus` å‡½æ•°
- `app/api/repair/update/route.ts` - ç›´æ¥æ›´æ–°çŠ¶æ€
- `app/api/equipment/rental/update/route.ts` - ç›´æ¥æ›´æ–°çŠ¶æ€

**é—®é¢˜ï¼š**
- æ²¡æœ‰çŠ¶æ€æµè½¬è§„åˆ™éªŒè¯ï¼ˆä¾‹å¦‚ï¼šä¸èƒ½ä» `completed` ç›´æ¥è·³åˆ° `pending`ï¼‰
- æ²¡æœ‰çŠ¶æ€å˜æ›´æ—¥å¿—
- æ²¡æœ‰æƒé™æ£€æŸ¥ï¼ˆè°å¯ä»¥æ”¹å˜çŠ¶æ€ï¼‰

---

### 4. âš ï¸ æ–‡ä»¶å­˜å‚¨é€»è¾‘ - **æ— ä¾›åº”å•†éš”ç¦»**

**ç°çŠ¶ï¼š**
- âŒ ä½¿ç”¨å›ºå®šçš„ bucket åç§°ï¼š`"delivery-proofs"`
- âŒ æ‰€æœ‰ä¾›åº”å•†çš„æ–‡ä»¶æ··åœ¨ä¸€èµ·
- âŒ æ²¡æœ‰æŒ‰ä¾›åº”å•†åˆ†é…ç‹¬ç«‹æ–‡ä»¶å¤¹
- âš ï¸ åªæœ‰æ–‡ä»¶å¤¹å‚æ•° `folder`ï¼Œä½†æ²¡æœ‰å¼ºåˆ¶ä½¿ç”¨ `company_id`

**å½“å‰å®ç°ï¼š**
```typescript
// app/api/storage/upload/route.ts
const BUCKET_NAME = "delivery-proofs" // å›ºå®š
const folder = formData.get("folder") || "proofs" // å¯é€‰ï¼Œä¸å®‰å…¨
```

**é£é™©ï¼š**
- ä¾›åº”å•† A å¯èƒ½è®¿é—®ä¾›åº”å•† B çš„æ–‡ä»¶
- æ–‡ä»¶è·¯å¾„å¯é¢„æµ‹ï¼Œå­˜åœ¨å®‰å…¨é£é™©

---

### 5. âš ï¸ æ€§èƒ½ä¸æ‰©å±•é£é™© - **å­˜åœ¨éšæ‚£**

**ç°çŠ¶ï¼š**
- âš ï¸ ä½¿ç”¨ Supabase ç›´è¿æ¨¡å¼ï¼ˆå®¢æˆ·ç«¯ç›´æ¥è¿æ¥ï¼‰
- âš ï¸ RLS ç­–ç•¥å¯èƒ½ä¸å¤Ÿä¸¥æ ¼
- âš ï¸ æ²¡æœ‰æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–ï¼ˆç´¢å¼•å¯èƒ½ä¸è¶³ï¼‰
- âš ï¸ æ²¡æœ‰è¿æ¥æ± ç®¡ç†

**æ½œåœ¨é—®é¢˜ï¼š**
- **å®‰å…¨é£é™©**ï¼šå¦‚æœ RLS é…ç½®é”™è¯¯ï¼Œå®¢æˆ·ç«¯å¯èƒ½ç»•è¿‡æƒé™
- **æ€§èƒ½é£é™©**ï¼š100 å®¶ä¾›åº”å•† Ã— 1000 å®¢æˆ· = 10ä¸‡å¹¶å‘æŸ¥è¯¢
- **æ‰©å±•é£é™©**ï¼šSupabase å…è´¹ç‰ˆæœ‰è¿æ¥æ•°é™åˆ¶

---

## ğŸ› ï¸ æ”¹è¿›æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šå¤šç§Ÿæˆ·æ•°æ®éš”ç¦»ï¼ˆç´§æ€¥ï¼‰

#### 1.1 åˆ›å»ºä¸­é—´ä»¶å‡½æ•°

åˆ›å»º `lib/multi-tenant.ts`ï¼š

```typescript
/**
 * å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»ä¸­é—´ä»¶
 * ç¡®ä¿æ‰€æœ‰æŸ¥è¯¢éƒ½æŒ‰ company_id è¿‡æ»¤
 */

export function enforceCompanyFilter(
  query: any,
  companyId: string | null,
  companyIdField: string = "provider_id"
) {
  if (!companyId) {
    throw new Error("ç¼ºå°‘ company_idï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢")
  }
  return query.eq(companyIdField, companyId)
}

/**
 * ä»è¯·æ±‚ä¸­è·å–å½“å‰ç”¨æˆ·çš„ company_id
 */
export async function getCurrentCompanyId(request: Request): Promise<string | null> {
  // ä» JWT token ä¸­è·å–
  // æˆ–ä»è¯·æ±‚å¤´ä¸­è·å–
  // æˆ–ä»ç”¨æˆ·è¡¨ä¸­æŸ¥è¯¢
  const authHeader = request.headers.get("authorization")
  // ... å®ç°é€»è¾‘
  return null
}
```

#### 1.2 æ›´æ–°æ‰€æœ‰ API è·¯ç”±

**ç¤ºä¾‹ï¼šæ›´æ–° `app/api/equipment/rental/admin/list/route.ts`**

```typescript
// æ·»åŠ  company_id è¿‡æ»¤
const companyId = searchParams.get("company_id") || await getCurrentCompanyId(request)

if (companyId) {
  query = query.eq("provider_id", companyId) // âœ… å¼ºåˆ¶è¿‡æ»¤
}
```

#### 1.3 åˆ›å»º RLS ç­–ç•¥ï¼ˆæ•°æ®åº“å±‚é¢ï¼‰

```sql
-- ä¸º rental_orders è¡¨åˆ›å»ºå¤šç§Ÿæˆ· RLS ç­–ç•¥
CREATE POLICY "Users can only see their company's rental orders"
  ON rental_orders
  FOR SELECT
  TO authenticated
  USING (
    provider_id IN (
      SELECT company_id FROM user_companies 
      WHERE user_id = auth.uid()
    )
  );
```

---

### æ–¹æ¡ˆ 2ï¼šç»Ÿä¸€çŠ¶æ€æµç®¡ç†

#### 2.1 åˆ›å»ºçŠ¶æ€æœºæœåŠ¡

åˆ›å»º `lib/status-manager.ts`ï¼š

```typescript
/**
 * ç»Ÿä¸€çŠ¶æ€æµç®¡ç†
 */

export const STATUS_TRANSITIONS = {
  rental_orders: {
    pending: ["confirmed", "cancelled"],
    confirmed: ["active", "cancelled"],
    active: ["completed", "cancelled"],
    completed: [], // ç»ˆæ€
    cancelled: [], // ç»ˆæ€
  },
  repairs: {
    pending: ["processing", "cancelled"],
    processing: ["completed", "cancelled"],
    completed: [], // ç»ˆæ€
    cancelled: [], // ç»ˆæ€
  },
}

export function validateStatusTransition(
  table: string,
  currentStatus: string,
  newStatus: string
): boolean {
  const transitions = STATUS_TRANSITIONS[table as keyof typeof STATUS_TRANSITIONS]
  if (!transitions) return false
  
  const allowedStatuses = transitions[currentStatus as keyof typeof transitions]
  return allowedStatuses?.includes(newStatus) || false
}
```

#### 2.2 åˆ›å»ºçŠ¶æ€å˜æ›´ API

åˆ›å»º `app/api/status/transition/route.ts`ï¼š

```typescript
/**
 * POST: ç»Ÿä¸€çš„çŠ¶æ€å˜æ›´æ¥å£
 * åŒ…å«ï¼šçŠ¶æ€éªŒè¯ã€æƒé™æ£€æŸ¥ã€å˜æ›´æ—¥å¿—
 */
export async function POST(request: Request) {
  const { table, record_id, new_status, reason } = await request.json()
  
  // 1. è·å–å½“å‰è®°å½•
  // 2. éªŒè¯çŠ¶æ€æµè½¬æ˜¯å¦åˆæ³•
  // 3. æ£€æŸ¥æƒé™
  // 4. æ›´æ–°çŠ¶æ€
  // 5. è®°å½•å˜æ›´æ—¥å¿—
}
```

---

### æ–¹æ¡ˆ 3ï¼šæ–‡ä»¶å­˜å‚¨éš”ç¦»

#### 3.1 æ›´æ–°å­˜å‚¨ä¸Šä¼  API

ä¿®æ”¹ `app/api/storage/upload/route.ts`ï¼š

```typescript
// ä»è¯·æ±‚ä¸­è·å– company_id
const companyId = formData.get("company_id") as string

if (!companyId) {
  return NextResponse.json(
    { error: "ç¼ºå°‘ company_id" },
    { status: 400 }
  )
}

// ä½¿ç”¨ company_id ä½œä¸ºæ–‡ä»¶å¤¹
const folder = `companies/${companyId}/${formData.get("folder") || "proofs"}`

// å¯é€‰ï¼šä¸ºæ¯ä¸ªä¾›åº”å•†åˆ›å»ºç‹¬ç«‹çš„ bucket
// const BUCKET_NAME = `company-${companyId}-storage`
const BUCKET_NAME = "delivery-proofs" // æˆ–ä½¿ç”¨ç»Ÿä¸€ bucket
```

---

### æ–¹æ¡ˆ 4ï¼šæ€§èƒ½ä¼˜åŒ–

#### 4.1 æ·»åŠ æ•°æ®åº“ç´¢å¼•

```sql
-- ä¸ºå¤šç§Ÿæˆ·æŸ¥è¯¢æ·»åŠ å¤åˆç´¢å¼•
CREATE INDEX idx_rental_orders_provider_status 
  ON rental_orders(provider_id, order_status);

CREATE INDEX idx_equipment_catalog_provider_approved 
  ON equipment_catalog(provider_id, is_approved, status);
```

#### 4.2 ä½¿ç”¨è¿æ¥æ± 

```typescript
// ä½¿ç”¨ Supabase æœåŠ¡ç«¯å®¢æˆ·ç«¯ï¼ˆå·²æœ‰ï¼‰
// ç¡®ä¿ä½¿ç”¨ SUPABASE_SERVICE_ROLE_KEY
```

#### 4.3 æ·»åŠ æŸ¥è¯¢ç¼“å­˜

```typescript
// ä½¿ç”¨ Redis æˆ–å†…å­˜ç¼“å­˜
// ç¼“å­˜ä¾›åº”å•†åˆ—è¡¨ã€äº§å“åˆ—è¡¨ç­‰
```

---

## ğŸ“‹ å®æ–½ä¼˜å…ˆçº§

### ğŸ”´ ç´§æ€¥ï¼ˆç«‹å³æ‰§è¡Œï¼‰

1. **å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»**
   - æ›´æ–°æ‰€æœ‰ API è·¯ç”±ï¼Œæ·»åŠ  `company_id` è¿‡æ»¤
   - åˆ›å»º RLS ç­–ç•¥
   - æ·»åŠ æƒé™éªŒè¯ä¸­é—´ä»¶

### ğŸŸ¡ é‡è¦ï¼ˆæœ¬å‘¨å†…ï¼‰

2. **ç»Ÿä¸€çŠ¶æ€æµç®¡ç†**
   - åˆ›å»ºçŠ¶æ€æœºæœåŠ¡
   - æ›´æ–°æ‰€æœ‰çŠ¶æ€å˜æ›´é€»è¾‘
   - æ·»åŠ çŠ¶æ€å˜æ›´æ—¥å¿—

3. **æ–‡ä»¶å­˜å‚¨éš”ç¦»**
   - æ›´æ–°å­˜å‚¨ä¸Šä¼  API
   - æŒ‰ `company_id` ç»„ç»‡æ–‡ä»¶å¤¹ç»“æ„

### ğŸŸ¢ ä¼˜åŒ–ï¼ˆä¸‹ä¸ªè¿­ä»£ï¼‰

4. **æ€§èƒ½ä¼˜åŒ–**
   - æ·»åŠ æ•°æ®åº“ç´¢å¼•
   - å®ç°æŸ¥è¯¢ç¼“å­˜
   - ä¼˜åŒ–æŸ¥è¯¢è¯­å¥

---

## ğŸš¨ å®‰å…¨å»ºè®®

1. **ç«‹å³ç¦ç”¨ä¾›åº”å•†è´¦å·ç™»å½•**ï¼Œç›´åˆ°å¤šç§Ÿæˆ·éš”ç¦»å®Œæˆ
2. **å®¡æŸ¥æ‰€æœ‰ API è·¯ç”±**ï¼Œç¡®ä¿éƒ½æœ‰ `company_id` è¿‡æ»¤
3. **å¯ç”¨ Supabase å®¡è®¡æ—¥å¿—**ï¼Œç›‘æ§æ•°æ®è®¿é—®
4. **å®šæœŸæ£€æŸ¥ RLS ç­–ç•¥**ï¼Œç¡®ä¿æƒé™æ­£ç¡®

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… åˆ›å»ºå¤šç§Ÿæˆ·éš”ç¦»ä¸­é—´ä»¶
2. âœ… æ›´æ–°æ‰€æœ‰ API è·¯ç”±
3. âœ… åˆ›å»ºç»Ÿä¸€çŠ¶æ€ç®¡ç†æœåŠ¡
4. âœ… æ›´æ–°æ–‡ä»¶å­˜å‚¨é€»è¾‘
5. âœ… æ·»åŠ æ•°æ®åº“ç´¢å¼•

æ‰€æœ‰æ”¹è¿›ä»£ç å°†è‡ªåŠ¨ä¿å­˜ï¼


