# è®¢å•è¯¦æƒ…é¡µé¢æ•°æ®æ¥æºåˆ†æ

## ğŸ“‹ æ•°æ®æ¥æºè·¯å¾„

### å½“å‰å®ç°ï¼šé€šè¿‡ API è·å–æ•°æ®ï¼ˆéç›´æ¥æŸ¥è¯¢æ•°æ®åº“ï¼Œé Mockï¼‰

---

## ğŸ” å®Œæ•´æ•°æ®æµç¨‹

### 1. é¡µé¢ç»„ä»¶
**æ–‡ä»¶ï¼š** `app/user-bound/page.tsx`

---

### 2. æ•°æ®è·å–å…¥å£ï¼ˆuseEffectï¼‰

**ä½ç½®ï¼š** `app/user-bound/page.tsx` ç¬¬ 66-178 è¡Œ

```typescript
useEffect(() => {
  const loadFactData = async () => {
    // ... æ•°æ®è·å–é€»è¾‘
  }
  loadFactData()
}, [])
```

---

### 3. æ•°æ®è·å–æ­¥éª¤ï¼ˆloadFactData å‡½æ•°ï¼‰

#### æ­¥éª¤ 1ï¼šè·å– restaurant_id
**æ¥æºï¼š** `localStorage.getItem("restaurantId")`  
**ä½ç½®ï¼š** ç¬¬ 70-72 è¡Œ

```typescript
const savedRestaurantId = typeof window !== "undefined" 
  ? localStorage.getItem("restaurantId") 
  : null
```

---

#### æ­¥éª¤ 2ï¼šè·å–æœ€æ–°è®¢å• IDï¼ˆç¬¬ä¸€æ¬¡ API è°ƒç”¨ï¼‰
**API è·¯å¾„ï¼š** `GET /api/facts/restaurant/:restaurant_id/latest-order`  
**ä½ç½®ï¼š** ç¬¬ 124-128 è¡Œ

```typescript
const latestOrderResponse = await fetch(
  `/api/facts/restaurant/${savedRestaurantId}/latest-order`,
  {
    headers: {
      "x-restaurant-id": savedRestaurantId,
    },
  }
)
```

**API è¿”å›ï¼š**
```json
{
  "success": true,
  "order_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

**API å®ç°æ–‡ä»¶ï¼š** `app/api/facts/restaurant/[restaurant_id]/latest-order/route.ts`

---

#### æ­¥éª¤ 3ï¼šè·å–è®¢å•äº‹å®æ•°æ®ï¼ˆç¬¬äºŒæ¬¡ API è°ƒç”¨ï¼‰
**API è·¯å¾„ï¼š** `GET /api/facts/orders/:order_id`  
**ä½ç½®ï¼š** ç¬¬ 134-138 è¡Œ

```typescript
const orderFactResponse = await fetch(
  `/api/facts/orders/${latestOrderData.order_id}`,
  {
    headers: {
      "x-restaurant-id": savedRestaurantId,
    },
  }
)
```

**API è¿”å›ï¼š**
```json
{
  "success": true,
  "order": {
    "order_id": "550e8400-e29b-41d4-a716-446655440000",
    "restaurant_id": "123e4567-e89b-12d3-a456-426614174000",
    "status": "completed",
    "created_at": "2025-01-18T08:30:00.000Z",
    "accepted_at": "2025-01-18T09:15:00.000Z",
    "completed_at": "2025-01-18T14:35:00.000Z",
    "worker_id": "987e6543-e21b-34c5-d678-912345678901"
  },
  "assets": [...],
  "traces": [...]
}
```

**API å®ç°æ–‡ä»¶ï¼š** `app/api/facts/orders/[order_id]/route.ts`

---

#### æ­¥éª¤ 4ï¼šè®¾ç½®çŠ¶æ€æ•°æ®
**ä½ç½®ï¼š** ç¬¬ 142-146 è¡Œ

```typescript
setLatestOrder({
  order: orderFactData.order,
  assets: orderFactData.assets || [],
  traces: orderFactData.traces || [],
})
```

---

### 4. æ•°æ®ä¼ é€’ç»™ç»„ä»¶

**ä½ç½®ï¼š** `app/user-bound/page.tsx` ç¬¬ 238-241 è¡Œ

```typescript
<OrderTimeline 
  order={latestOrder.order} 
  traces={latestOrder.traces}
/>
```

---

### 5. ç»„ä»¶å†…éƒ¨å¤„ç†

**ç»„ä»¶æ–‡ä»¶ï¼š** `components/facts/OrderTimeline.tsx`

**æ•°æ®å¤„ç†ï¼š**
- æ¥æ”¶ `order: OrderFact` å’Œ `traces: TraceFact[]` ä½œä¸º props
- åœ¨ `mergeTimelineNodes` å‡½æ•°ä¸­åˆå¹¶è®¢å•çŠ¶æ€å˜åŒ–å’Œæº¯æºè®°å½•
- æŒ‰æ—¶é—´é¡ºåºæ’åºå¹¶æ¸²æŸ“

**ä½ç½®ï¼š** `components/facts/OrderTimeline.tsx` ç¬¬ 73-142 è¡Œ

---

## ğŸ“Š æ•°æ®æ¥æºè·¯å¾„å›¾

```
app/user-bound/page.tsx
  â”‚
  â”œâ”€ useEffect (ç¬¬ 66 è¡Œ)
  â”‚   â”‚
  â”‚   â””â”€ loadFactData() (ç¬¬ 67 è¡Œ)
  â”‚       â”‚
  â”‚       â”œâ”€ 1. localStorage.getItem("restaurantId") (ç¬¬ 70 è¡Œ)
  â”‚       â”‚
  â”‚       â”œâ”€ 2. fetch("/api/facts/restaurant/:restaurant_id/latest-order") (ç¬¬ 124 è¡Œ)
  â”‚       â”‚   â”‚
  â”‚       â”‚   â””â”€ API: app/api/facts/restaurant/[restaurant_id]/latest-order/route.ts
  â”‚       â”‚       â””â”€ æŸ¥è¯¢: delivery_orders è¡¨ (status = "completed")
  â”‚       â”‚           â””â”€ è¿”å›: { order_id: "..." }
  â”‚       â”‚
  â”‚       â”œâ”€ 3. fetch("/api/facts/orders/:order_id") (ç¬¬ 134 è¡Œ)
  â”‚       â”‚   â”‚
  â”‚       â”‚   â””â”€ API: app/api/facts/orders/[order_id]/route.ts
  â”‚       â”‚       â”‚
  â”‚       â”‚       â”œâ”€ æŸ¥è¯¢: delivery_orders è¡¨ (ç¬¬ 52-56 è¡Œ)
  â”‚       â”‚       â”‚   â””â”€ è¿”å›: orderData (id, restaurant_id, status, created_at, updated_at, worker_id)
  â”‚       â”‚       â”‚
  â”‚       â”‚       â”œâ”€ æŸ¥è¯¢: audit_logs è¡¨ (ç¬¬ 97-102 è¡Œ)
  â”‚       â”‚       â”‚   â””â”€ WHERE: target_type = "delivery_order" AND target_id = order_id
  â”‚       â”‚       â”‚   â””â”€ æå–: accepted_at, completed_at
  â”‚       â”‚       â”‚
  â”‚       â”‚       â”œâ”€ æŸ¥è¯¢: trace_logs è¡¨ (ç¬¬ 139-143 è¡Œ)
  â”‚       â”‚       â”‚   â””â”€ WHERE: order_id = order_id
  â”‚       â”‚       â”‚   â””â”€ è¿”å›: traces (æº¯æºè®°å½•)
  â”‚       â”‚       â”‚
  â”‚       â”‚       â””â”€ æŸ¥è¯¢: gas_cylinders è¡¨ (ç¬¬ 170-173 è¡Œ)
  â”‚       â”‚           â””â”€ WHERE: id IN (traces ä¸­çš„ asset_id)
  â”‚       â”‚           â””â”€ è¿”å›: assets (èµ„äº§åˆ—è¡¨)
  â”‚       â”‚
  â”‚       â””â”€ 4. setLatestOrder({ order, assets, traces }) (ç¬¬ 142 è¡Œ)
  â”‚
  â””â”€ OrderTimeline ç»„ä»¶ (ç¬¬ 238 è¡Œ)
      â”‚
      â””â”€ components/facts/OrderTimeline.tsx
          â”‚
          â”œâ”€ æ¥æ”¶ props: order (OrderFact), traces (TraceFact[])
          â”‚
          â”œâ”€ mergeTimelineNodes() (ç¬¬ 73 è¡Œ)
          â”‚   â”œâ”€ åˆå¹¶è®¢å•çŠ¶æ€å˜åŒ–ï¼ˆä» order.accepted_at, order.completed_atï¼‰
          â”‚   â””â”€ åˆå¹¶æº¯æºè®°å½•ï¼ˆä» tracesï¼‰
          â”‚
          â””â”€ æ¸²æŸ“æ—¶é—´çº¿ UI
```

---

## âœ… æ•°æ®æ¥æºç¡®è®¤

### 1. æ˜¯å¦ç›´æ¥æ¥è‡ª delivery_ordersï¼Ÿ
**âŒ å¦**

æ•°æ®ä¸ç›´æ¥æ¥è‡ª `delivery_orders` è¡¨ï¼Œè€Œæ˜¯é€šè¿‡ API å±‚è·å–ã€‚

### 2. æ˜¯å¦é€šè¿‡æŸä¸ª APIï¼Ÿ
**âœ… æ˜¯**

æ•°æ®é€šè¿‡ä»¥ä¸‹ API è·å–ï¼š
1. **ç¬¬ä¸€æ­¥ï¼š** `GET /api/facts/restaurant/:restaurant_id/latest-order`
   - è·å–æœ€æ–°å®Œæˆè®¢å•çš„ ID
   - å®ç°æ–‡ä»¶ï¼š`app/api/facts/restaurant/[restaurant_id]/latest-order/route.ts`
   - æ•°æ®æºï¼š`delivery_orders` è¡¨ï¼ˆæŸ¥è¯¢ `status = "completed"`ï¼‰

2. **ç¬¬äºŒæ­¥ï¼š** `GET /api/facts/orders/:order_id`
   - è·å–å®Œæ•´è®¢å•äº‹å®æ•°æ®ï¼ˆåŒ…æ‹¬ order, assets, tracesï¼‰
   - å®ç°æ–‡ä»¶ï¼š`app/api/facts/orders/[order_id]/route.ts`
   - æ•°æ®æºï¼š
     - `delivery_orders` è¡¨ï¼ˆè®¢å•åŸºæœ¬ä¿¡æ¯ï¼‰
     - `audit_logs` è¡¨ï¼ˆè®¢å•çŠ¶æ€å˜åŒ–ï¼šaccepted_at, completed_atï¼‰
     - `trace_logs` è¡¨ï¼ˆèµ„äº§æº¯æºè®°å½•ï¼‰
     - `gas_cylinders` è¡¨ï¼ˆèµ„äº§ä¿¡æ¯ï¼‰

### 3. æ˜¯å¦å‰ç«¯ mock / å†™æ­»ï¼Ÿ
**âŒ å¦**

æ•°æ®ä¸æ˜¯å‰ç«¯ mock æˆ–å†™æ­»çš„ï¼Œè€Œæ˜¯é€šè¿‡çœŸå®çš„ API è°ƒç”¨è·å–ã€‚

---

## ğŸ”— å®Œæ•´æ•°æ®é“¾è·¯

```
å‰ç«¯é¡µé¢ (app/user-bound/page.tsx)
  â”‚
  â”œâ”€ useEffect
  â”‚   â””â”€ loadFactData()
  â”‚       â”‚
  â”‚       â”œâ”€ fetch("/api/facts/restaurant/:restaurant_id/latest-order")
  â”‚       â”‚   â”‚
  â”‚       â”‚   â””â”€ API å±‚ (app/api/facts/restaurant/[restaurant_id]/latest-order/route.ts)
  â”‚       â”‚       â”‚
  â”‚       â”‚       â””â”€ æ•°æ®åº“å±‚
  â”‚       â”‚           â””â”€ delivery_orders è¡¨ (æŸ¥è¯¢ status = "completed")
  â”‚       â”‚
  â”‚       â””â”€ fetch("/api/facts/orders/:order_id")
  â”‚           â”‚
  â”‚           â””â”€ API å±‚ (app/api/facts/orders/[order_id]/route.ts)
  â”‚               â”‚
  â”‚               â””â”€ æ•°æ®åº“å±‚
  â”‚                   â”œâ”€ delivery_orders è¡¨ (è®¢å•åŸºæœ¬ä¿¡æ¯)
  â”‚                   â”œâ”€ audit_logs è¡¨ (è®¢å•çŠ¶æ€å˜åŒ–)
  â”‚                   â”œâ”€ trace_logs è¡¨ (èµ„äº§æº¯æºè®°å½•)
  â”‚                   â””â”€ gas_cylinders è¡¨ (èµ„äº§ä¿¡æ¯)
  â”‚
  â”œâ”€ setLatestOrder({ order, assets, traces })
  â”‚
  â””â”€ OrderTimeline ç»„ä»¶
      â””â”€ components/facts/OrderTimeline.tsx
          â””â”€ æ¸²æŸ“æ—¶é—´çº¿ UI
```

---

## ğŸ“ å…³é”®ä»£ç ä½ç½®

### å‰ç«¯é¡µé¢
- **æ–‡ä»¶ï¼š** `app/user-bound/page.tsx`
- **useEffectï¼š** ç¬¬ 66-178 è¡Œ
- **fetch è°ƒç”¨ï¼š** ç¬¬ 124 è¡Œï¼ˆlatest-orderï¼‰ã€ç¬¬ 134 è¡Œï¼ˆordersï¼‰
- **ç»„ä»¶ä½¿ç”¨ï¼š** ç¬¬ 238-241 è¡Œ

### API å±‚
- **latest-order APIï¼š** `app/api/facts/restaurant/[restaurant_id]/latest-order/route.ts`
- **orders APIï¼š** `app/api/facts/orders/[order_id]/route.ts`

### ç»„ä»¶å±‚
- **OrderTimeline ç»„ä»¶ï¼š** `components/facts/OrderTimeline.tsx`
- **æ•°æ®å¤„ç†ï¼š** ç¬¬ 73-142 è¡Œï¼ˆmergeTimelineNodes å‡½æ•°ï¼‰

---

## âœ… ç»“è®º

### æ•°æ®æ¥æºè·¯å¾„

1. **å‰ç«¯é¡µé¢ï¼š** `app/user-bound/page.tsx`
2. **æ•°æ®è·å–ï¼š** `useEffect` â†’ `loadFactData()` â†’ `fetch()`
3. **API è°ƒç”¨ï¼š** 
   - ç¬¬ä¸€æ­¥ï¼š`GET /api/facts/restaurant/:restaurant_id/latest-order`
   - ç¬¬äºŒæ­¥ï¼š`GET /api/facts/orders/:order_id`
4. **æ•°æ®ä¼ é€’ï¼š** API è¿”å› â†’ `setLatestOrder()` â†’ `OrderTimeline` ç»„ä»¶
5. **æ•°æ®æ¸²æŸ“ï¼š** `OrderTimeline` ç»„ä»¶å†…éƒ¨åˆå¹¶å’Œæ’åº â†’ æ¸²æŸ“ UI

### æ•°æ®æ¥æºç±»å‹

- âœ… **é€šè¿‡ API è·å–**ï¼ˆéç›´æ¥æŸ¥è¯¢æ•°æ®åº“ï¼‰
- âœ… **çœŸå®æ•°æ®**ï¼ˆé mock / å†™æ­»ï¼‰
- âœ… **å¤šè¡¨èšåˆ**ï¼ˆdelivery_orders + audit_logs + trace_logs + gas_cylindersï¼‰
- âœ… **äº‹å®é©±åŠ¨**ï¼ˆåªè¯»ï¼Œä¸æ¨æ–­ï¼Œä¸ä¿®æ”¹ï¼‰

---

## ğŸ¯ "æ–­å±‚"å®šä½

### å½“å‰æ¶æ„å®Œæ•´
- âœ… å‰ç«¯ â†’ API å±‚ â†’ æ•°æ®åº“å±‚ï¼Œé“¾è·¯å®Œæ•´
- âœ… æ•°æ®æµç¨‹æ¸…æ™°ï¼Œæ— æ–­å±‚
- âœ… æ‰€æœ‰æ•°æ®éƒ½é€šè¿‡ API è·å–ï¼Œç¬¦åˆäº‹å®é©±åŠ¨åŸåˆ™

### å¦‚éœ€å®šä½é—®é¢˜
å¦‚æœ UI å±•ç¤ºæœ‰é—®é¢˜ï¼Œå¯ä»¥æ£€æŸ¥ï¼š
1. **API è°ƒç”¨æ˜¯å¦æˆåŠŸ**ï¼ˆNetwork é¢æ¿æŸ¥çœ‹è¯·æ±‚/å“åº”ï¼‰
2. **API è¿”å›æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®**ï¼ˆæ£€æŸ¥ `success` å­—æ®µå’Œæ•°æ®ç»“æ„ï¼‰
3. **çŠ¶æ€è®¾ç½®æ˜¯å¦æ­£ç¡®**ï¼ˆæ£€æŸ¥ `setLatestOrder` æ˜¯å¦è¢«è°ƒç”¨ï¼‰
4. **ç»„ä»¶æ¥æ”¶æ•°æ®æ˜¯å¦æ­£ç¡®**ï¼ˆæ£€æŸ¥ `OrderTimeline` ç»„ä»¶çš„ propsï¼‰

---

**ç”Ÿæˆæ—¶é—´ï¼š** 2025-01-20  
**åˆ†ææ–‡ä»¶ï¼š** `app/user-bound/page.tsx`ã€`app/api/facts/orders/[order_id]/route.ts`
