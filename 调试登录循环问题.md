# 调试登录循环问题

## 🔍 问题现象
登录后出现循环：点击登录 → 跳转到 `/dashboard` → 又跳回 `/login` → 循环

## 🎯 已实施的修复

### 1. 优化登录逻辑
- ✅ 添加了 500ms 延迟，确保 Cookie 同步
- ✅ 添加了最终会话检查
- ✅ 添加了时间戳参数防止缓存
- ✅ 增强了调试日志

### 2. 优化中间件
- ✅ 添加了详细的调试日志
- ✅ 移除了登录页的自动重定向（避免循环）

## 📋 调试步骤

### 第一步：查看浏览器控制台
打开浏览器控制台（F12），查看 Console 标签页，寻找以下日志：

**登录时的日志序列：**
```
[登录页] 开始登录流程...
[登录页] 登录成功，用户ID: xxx
[登录页] 角色查询结果: {...}
[登录页] 用户角色: super_admin
[登录页] 登录成功，验证会话状态...
[登录页] 会话已验证，用户: xxx@xxx.com
[登录页] 等待 Cookie 同步...
[登录页] Cookie 已同步，准备跳转到管理后台
```

**中间件的日志：**
```
[中间件] 用户已登录，允许访问: xxx@xxx.com 路径: /dashboard
```

### 第二步：查看网络请求
在 Network 标签页中：

1. **查找 `/user_roles` 请求**
   - 状态码应该是 `200`
   - 响应应该包含 `{"role": "super_admin"}` 或 `{"role": "admin"}`

2. **查找 `/dashboard` 请求**
   - 第一次请求：应该是 `200` 或 `307/308`（重定向）
   - 如果看到 `307/308` 重定向到 `/login`，说明中间件检测不到 session

3. **检查 Cookie**
   - 在 Application/Storage 标签页 → Cookies
   - 查找 `sb-xxx-auth-token` 相关的 Cookie
   - 确认 Cookie 是否存在且有效

### 第三步：检查可能的错误

#### 错误1：`[登录页] 查询角色失败`
**原因**：RLS 策略可能有问题
**解决**：
1. 确认 SQL 脚本已执行
2. 在 Supabase Dashboard 中检查策略是否存在
3. 确认用户有角色记录

#### 错误2：`[中间件] 未检测到会话`
**原因**：Cookie 未正确写入或同步
**解决**：
1. 检查浏览器是否禁用了 Cookie
2. 尝试清除所有 Cookie 后重新登录
3. 检查是否有其他扩展程序干扰

#### 错误3：`[登录页] 会话验证失败`
**原因**：Supabase 客户端配置问题
**解决**：
1. 检查 `.env.local` 中的环境变量
2. 确认 Supabase URL 和 Key 正确
3. 重启开发服务器

## 🛠️ 进一步调试

### 如果问题仍然存在，请提供以下信息：

1. **浏览器控制台的完整日志**
   - 复制所有 `[登录页]` 和 `[中间件]` 开头的日志
   - 复制所有红色错误信息

2. **网络请求详情**
   - `/user_roles` 请求的完整信息（URL、状态码、请求头、响应）
   - `/dashboard` 请求的完整信息
   - 所有 Cookie 的名称和值（隐藏敏感信息）

3. **Supabase 检查**
   - 在 Supabase Dashboard → SQL Editor 中执行：
   ```sql
   -- 检查用户角色
   SELECT * FROM user_roles WHERE user_id = '你的用户ID';
   
   -- 检查策略
   SELECT policyname, cmd, roles 
   FROM pg_policies 
   WHERE tablename = 'user_roles';
   ```

## 🔧 临时解决方案

如果问题持续存在，可以尝试：

1. **完全清除浏览器数据**
   - 关闭所有浏览器窗口
   - 清除所有 Cookie 和缓存
   - 重启浏览器

2. **使用不同的浏览器**
   - 尝试 Chrome、Firefox 或 Edge
   - 确认是否是浏览器特定问题

3. **检查 Supabase 客户端配置**
   - 确认 `lib/supabase.ts` 中的配置正确
   - 确认环境变量已加载

4. **临时禁用中间件**
   - 重命名 `proxy.ts` 为 `proxy.ts.bak`
   - 测试登录是否正常
   - 如果正常，说明问题在中间件

---

**请按照上述步骤收集信息，然后告诉我具体的错误日志！** 🔍
