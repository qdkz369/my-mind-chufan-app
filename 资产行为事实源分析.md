# èµ„äº§/è¡Œä¸ºäº‹å®æºåˆ†ææŠ¥å‘Š

## ğŸ“Š äº‹å®æºæ€»è§ˆ

### ä¸€ã€èµ„äº§äº‹å®æº

#### 1ï¸âƒ£ ç¬¬ä¸€äº‹å®æºï¼š`gas_cylinders` è¡¨
**æ–‡ä»¶ï¼š** `migrations/20250120_asset_trace_base.sql`

**è¡¨ç»“æ„ï¼š**
```sql
CREATE TABLE IF NOT EXISTS gas_cylinders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  manufacturer_id UUID,              -- åˆ¶é€ å•†IDï¼ˆå¯ä¸ºç©ºï¼‰
  status TEXT,                       -- çŠ¶æ€ï¼ˆä¸ä½¿ç”¨ enumï¼Œä¿æŒå¼¹æ€§ï¼‰
  production_date DATE,              -- ç”Ÿäº§æ—¥æœŸ
  last_inspect_date DATE,            -- æœ€åæ£€æŸ¥æ—¥æœŸ
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**ç”¨é€”ï¼š**
- å­˜å‚¨ç‡ƒæ°”ç“¶ç­‰èµ„äº§çš„åŸºæœ¬ä¿¡æ¯
- èµ„äº§çŠ¶æ€ç®¡ç†
- ç”Ÿäº§ä¿¡æ¯è®°å½•

**åœ¨ä»£ç ä¸­çš„ä½¿ç”¨ï¼š**
- `app/api/facts/orders/[order_id]/route.ts` ç¬¬ 171 è¡Œ
- é€šè¿‡ `trace_logs` åæŸ¥å…³è”çš„èµ„äº§

---

#### 2ï¸âƒ£ ç¬¬äºŒäº‹å®æºï¼š`devices` è¡¨
**æ–‡ä»¶ï¼š** `database-schema-devices.sql`

**è¡¨ç»“æ„ï¼š**
```sql
CREATE TABLE IF NOT EXISTS devices (
  device_id TEXT PRIMARY KEY,
  model TEXT NOT NULL,
  install_date TIMESTAMPTZ NOT NULL,
  address TEXT NOT NULL,
  installer TEXT,
  status TEXT NOT NULL DEFAULT 'offline' CHECK (status IN ('online', 'offline')),
  is_locked BOOLEAN NOT NULL DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**ç”¨é€”ï¼š**
- å­˜å‚¨è®¾å¤‡èµ„äº§ï¼ˆIoTè®¾å¤‡ã€ç›‘æ§è®¾å¤‡ç­‰ï¼‰
- è®¾å¤‡çŠ¶æ€ç®¡ç†
- å®‰è£…ä¿¡æ¯è®°å½•

**åœ¨ä»£ç ä¸­çš„ä½¿ç”¨ï¼š**
- `app/api/facts/restaurant/[restaurant_id]/assets/route.ts` ç¬¬ 56 è¡Œ
- æŸ¥è¯¢é¤å…å…³è”çš„è®¾å¤‡èµ„äº§

**å…³é”®å­—æ®µï¼š**
- `device_id` - è®¾å¤‡å”¯ä¸€æ ‡è¯†ï¼ˆäºŒç»´ç å€¼ï¼‰
- `restaurant_id` - é¤å…IDï¼ˆå…³è”å…³ç³»ï¼‰
- `status` - è®¾å¤‡çŠ¶æ€ï¼ˆonline/offlineï¼‰

---

### äºŒã€è¡Œä¸ºäº‹å®æº

#### 1ï¸âƒ£ ç¬¬ä¸€ï¼ˆä¸»è¦ï¼‰äº‹å®æºï¼š`trace_logs` è¡¨
**æ–‡ä»¶ï¼š** `migrations/20250120_asset_trace_base.sql`

**è¡¨ç»“æ„ï¼š**
```sql
CREATE TABLE IF NOT EXISTS trace_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  asset_id UUID NOT NULL REFERENCES gas_cylinders(id) ON DELETE CASCADE,
  operator_id UUID,                 -- æ“ä½œå‘˜ID
  action_type TEXT NOT NULL,        -- æ“ä½œç±»å‹ï¼šå‡ºå‚ / å……è£… / é…é€ / å›æ”¶ / å®‰æ£€
  order_id UUID,                    -- å…³è”è®¢å•IDï¼ˆå¯ä¸ºç©ºï¼‰
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**å…³é”®ç‰¹æ€§ï¼š**
- âœ… **åªå…è®¸ INSERT**ï¼ˆé€šè¿‡è§¦å‘å™¨ç¦æ­¢ UPDATE å’Œ DELETEï¼‰
- âœ… **ä¸å¯å˜è®°å½•**ï¼ˆç¬¦åˆäº‹å®é©±åŠ¨åŸåˆ™ï¼‰
- âœ… **å®Œæ•´çš„èµ„äº§ç”Ÿå‘½å‘¨æœŸè®°å½•**

**è¡Œä¸ºç±»å‹ï¼š**
- `å‡ºå‚` - èµ„äº§å‡ºå‚
- `å……è£…` - èµ„äº§å……è£…
- `é…é€` - èµ„äº§é…é€
- `å›æ”¶` - èµ„äº§å›æ”¶
- `å®‰æ£€` - èµ„äº§å®‰æ£€

**åœ¨ä»£ç ä¸­çš„ä½¿ç”¨ï¼š**
- `app/api/facts/orders/[order_id]/route.ts` ç¬¬ 139 è¡Œï¼ˆæŸ¥è¯¢è®¢å•å…³è”çš„æº¯æºè®°å½•ï¼‰
- `app/api/facts/orders/[order_id]/route.ts` ç¬¬ 183 è¡Œï¼ˆæŸ¥è¯¢èµ„äº§æœ€åä¸€æ¬¡æ“ä½œï¼‰
- `app/api/facts/restaurant/[restaurant_id]/assets/route.ts` ç¬¬ 81 è¡Œï¼ˆæŸ¥è¯¢è®¾å¤‡æœ€åä¸€æ¬¡æ“ä½œï¼‰

---

#### 2ï¸âƒ£ ç¬¬äºŒäº‹å®æºï¼š`audit_logs` è¡¨ï¼ˆè®¢å•çŠ¶æ€å˜åŒ–ï¼‰
**æ–‡ä»¶ï¼š** `migrations/20250120_audit_logs.sql`

**è¡¨ç»“æ„ï¼š**
```sql
CREATE TABLE IF NOT EXISTS audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  actor_id UUID,                    -- æ“ä½œè€…IDï¼ˆç”¨æˆ·IDæˆ–å·¥äººIDï¼‰
  action TEXT NOT NULL,             -- æ“ä½œç±»å‹ï¼ˆå¦‚ ORDER_ACCEPT, ORDER_DISPATCH, ORDER_COMPLETEï¼‰
  target_type TEXT,                 -- ç›®æ ‡ç±»å‹ï¼ˆå¦‚ delivery_order, repair_orderï¼‰
  target_id UUID,                   -- ç›®æ ‡IDï¼ˆå¦‚è®¢å•IDï¼‰
  metadata JSONB,                   -- é¢å¤–å…ƒæ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**å½“å‰ç”¨é€”ï¼š**
- âœ… **è®¢å•çŠ¶æ€å˜åŒ–è®°å½•**ï¼ˆ`target_type = "delivery_order"`ï¼‰
- âœ… è®°å½•è®¢å•çš„æ¥å—ã€å®Œæˆç­‰çŠ¶æ€å˜åŒ–
- âŒ **ä¸ç›´æ¥è®°å½•èµ„äº§è¡Œä¸º**ï¼ˆä¸»è¦ç”¨äºè®¢å•å®¡è®¡ï¼‰

**åœ¨ä»£ç ä¸­çš„ä½¿ç”¨ï¼š**
- `app/api/facts/orders/[order_id]/route.ts` ç¬¬ 97 è¡Œï¼ˆæŸ¥è¯¢è®¢å•çŠ¶æ€å˜åŒ–ï¼‰

---

## ğŸ” äº‹å®æºåˆ†æç»“è®º

### èµ„äº§äº‹å®æº

#### âœ… æœ‰å¤šä¸ªäº‹å®æº
1. **`gas_cylinders` è¡¨** - ç‡ƒæ°”ç“¶ç­‰èµ„äº§
2. **`devices` è¡¨** - è®¾å¤‡èµ„äº§

**åŒºåˆ«ï¼š**
- `gas_cylinders` ä¸»è¦ç”¨äºç‡ƒæ°”ç“¶ç­‰å¯ç§»åŠ¨èµ„äº§
- `devices` ä¸»è¦ç”¨äºå›ºå®šè®¾å¤‡ï¼ˆIoTè®¾å¤‡ã€ç›‘æ§è®¾å¤‡ç­‰ï¼‰

**å½“å‰å®ç°ï¼š**
- è®¢å•äº‹å® API ä½¿ç”¨ `gas_cylinders` è¡¨
- é¤å…èµ„äº§åˆ—è¡¨ API ä½¿ç”¨ `devices` è¡¨
- ä¸¤ä¸ªè¡¨é€šè¿‡ä¸åŒçš„ä¸šåŠ¡åœºæ™¯åˆ†åˆ«ä½¿ç”¨

---

### è¡Œä¸ºäº‹å®æº

#### âœ… ä¸»è¦äº‹å®æºï¼š`trace_logs` è¡¨
- **ä¸“é—¨ç”¨äºè®°å½•èµ„äº§è¡Œä¸º**
- **åªå…è®¸ INSERT**ï¼ˆä¸å¯å˜è®°å½•ï¼‰
- **å®Œæ•´çš„èµ„äº§ç”Ÿå‘½å‘¨æœŸè¿½è¸ª**

#### âš ï¸ ç¬¬äºŒäº‹å®æºï¼š`audit_logs` è¡¨ï¼ˆéƒ¨åˆ†ç›¸å…³ï¼‰
- **ä¸»è¦ç”¨äºè®¢å•çŠ¶æ€å˜åŒ–**
- **å½“å‰ä¸ç›´æ¥è®°å½•èµ„äº§è¡Œä¸º**ï¼ˆ`target_type` ä¸»è¦è®°å½• `delivery_order`ï¼‰
- **ç†è®ºä¸Šå¯ä»¥æ‰©å±•**ï¼ˆé€šè¿‡ `target_type` è®°å½•èµ„äº§ç›¸å…³è¡Œä¸ºï¼Œä½†ç›®å‰æœªå®ç°ï¼‰

---

## ğŸ“‹ äº‹å®æºä½¿ç”¨æ˜ å°„

### èµ„äº§äº‹å®æºæ˜ å°„

| èµ„äº§ç±»å‹ | ä¸»è¦äº‹å®æºè¡¨ | API ä½¿ç”¨ | ä»£ç ä½ç½® |
|---------|------------|---------|---------|
| ç‡ƒæ°”ç“¶èµ„äº§ | `gas_cylinders` | `/api/facts/orders/:order_id` | `app/api/facts/orders/[order_id]/route.ts:171` |
| è®¾å¤‡èµ„äº§ | `devices` | `/api/facts/restaurant/:restaurant_id/assets` | `app/api/facts/restaurant/[restaurant_id]/assets/route.ts:56` |

### è¡Œä¸ºäº‹å®æºæ˜ å°„

| è¡Œä¸ºç±»å‹ | äº‹å®æºè¡¨ | è®°å½•å†…å®¹ | API ä½¿ç”¨ | ä»£ç ä½ç½® |
|---------|---------|---------|---------|---------|
| èµ„äº§æ“ä½œè¡Œä¸º | `trace_logs` | å‡ºå‚ã€å……è£…ã€é…é€ã€å›æ”¶ã€å®‰æ£€ | `/api/facts/orders/:order_id`<br>`/api/facts/restaurant/:restaurant_id/assets` | `app/api/facts/orders/[order_id]/route.ts:139`<br>`app/api/facts/restaurant/[restaurant_id]/assets/route.ts:81` |
| è®¢å•çŠ¶æ€å˜åŒ– | `audit_logs` | ORDER_ACCEPTED, ORDER_COMPLETED ç­‰ | `/api/facts/orders/:order_id` | `app/api/facts/orders/[order_id]/route.ts:97` |

---

## âœ… ç»“è®º

### 1. èµ„äº§äº‹å®æº
- âœ… **æœ‰å¤šä¸ªäº‹å®æº**ï¼š`gas_cylinders` å’Œ `devices` è¡¨
- âœ… **ç»“æ„åŒ–å­˜åœ¨**ï¼šä¸¤ä¸ªè¡¨éƒ½æœ‰å®Œæ•´çš„å­—æ®µå®šä¹‰
- âœ… **ç”¨é€”åŒºåˆ†**ï¼šä¸åŒèµ„äº§ç±»å‹ä½¿ç”¨ä¸åŒçš„è¡¨

### 2. è¡Œä¸ºäº‹å®æº
- âœ… **ä¸»è¦äº‹å®æº**ï¼š`trace_logs` è¡¨ï¼ˆä¸“é—¨ç”¨äºèµ„äº§è¡Œä¸ºè®°å½•ï¼‰
- âš ï¸ **ç¬¬äºŒäº‹å®æº**ï¼š`audit_logs` è¡¨ï¼ˆä¸»è¦ç”¨äºè®¢å•çŠ¶æ€å˜åŒ–ï¼Œå½“å‰ä¸ç›´æ¥è®°å½•èµ„äº§è¡Œä¸ºï¼‰
- âœ… **ç»“æ„åŒ–å­˜åœ¨**ï¼š`trace_logs` è¡¨æœ‰å®Œæ•´çš„å­—æ®µå®šä¹‰å’Œåªè¯»çº¦æŸ

### 3. äº‹å®å®Œæ•´æ€§
- âœ… **èµ„äº§äº‹å®**ï¼šé€šè¿‡ `gas_cylinders` å’Œ `devices` è¡¨ç»“æ„åŒ–å­˜å‚¨
- âœ… **è¡Œä¸ºäº‹å®**ï¼šé€šè¿‡ `trace_logs` è¡¨ç»“æ„åŒ–å­˜å‚¨ï¼ˆä¸å¯å˜è®°å½•ï¼‰
- âœ… **è®¢å•çŠ¶æ€äº‹å®**ï¼šé€šè¿‡ `audit_logs` è¡¨ç»“æ„åŒ–å­˜å‚¨

### 4. å»ºè®®
- âœ… å½“å‰æ¶æ„åˆç†ï¼šèµ„äº§è¡Œä¸ºä¸»è¦é€šè¿‡ `trace_logs` è®°å½•
- âœ… `audit_logs` ä¸»è¦ç”¨äºè®¢å•çŠ¶æ€å˜åŒ–ï¼Œç¬¦åˆèŒè´£åˆ†ç¦»åŸåˆ™
- âœ… å¦‚éœ€è®°å½•èµ„äº§ç›¸å…³çš„å®¡è®¡ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡æ‰©å±• `audit_logs` çš„ `target_type` å®ç°ï¼Œä½†ç›®å‰æœªå®ç°æ­¤åŠŸèƒ½

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š** 2025-01-20
**æ•°æ®æ¥æºï¼š** å½“å‰ä»£ç åº“å’Œæ•°æ®åº“ schema æ–‡ä»¶
