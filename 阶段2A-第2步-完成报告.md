# é˜¶æ®µ 2A ç¬¬ 2 æ­¥ - å®ŒæˆæŠ¥å‘Š

## âœ… å·²å®Œæˆå·¥ä½œ

### 1ï¸âƒ£ æ”¹é€  APIï¼š`app/api/admin/create-company/route.ts`

**æ”¹åŠ¨å†…å®¹ï¼š**

1. **åœ¨ handler å¼€å¤´è°ƒç”¨ `getUserContext(request)`**
   - ä½¿ç”¨ç»Ÿä¸€çš„ç”¨æˆ·ä¸Šä¸‹æ–‡è·å–ç”¨æˆ·èº«ä»½å’Œæƒé™
   - æ•è·é”™è¯¯å¹¶è¿”å›ç›¸åº”çš„ HTTP çŠ¶æ€ç ï¼ˆ401 æœªç™»å½•ï¼Œ403 æƒé™ä¸è¶³ï¼‰

2. **æ˜ç¡®è¦æ±‚ï¼š`role === 'super_admin'`**
   - ç§»é™¤äº†åŸæ¥å…è®¸ `admin` è§’è‰²çš„é€»è¾‘
   - ç°åœ¨åªå…è®¸ `super_admin` åˆ›å»ºå…¬å¸
   - å¦‚æœä¸æ˜¯ `super_admin`ï¼Œç›´æ¥è¿”å› 403

3. **åˆ é™¤ç›´æ¥æŸ¥è¯¢ `user_roles` çš„é€»è¾‘**
   - ç§»é™¤äº†ç¬¬ 71-101 è¡Œçš„ç›´æ¥æŸ¥è¯¢ `user_roles` è¡¨çš„ä»£ç 
   - ç§»é™¤äº†ç›¸å…³çš„ `createServerClient` å’Œ `auth.getUser()` è°ƒç”¨
   - ç§»é™¤äº† `supabaseClient` çš„åˆ›å»ºï¼ˆä»…ä¿ç•™ç”¨äºå†™å…¥çš„ `adminSupabaseClient`ï¼‰

4. **ä¿ç•™ä½¿ç”¨ Service Role Key**
   - ç»§ç»­ä½¿ç”¨ Service Role Key åˆ›å»º `adminSupabaseClient`
   - **åŸå› ï¼š** è¿™æ˜¯ç³»ç»Ÿçº§ APIï¼Œéœ€è¦ç»•è¿‡ RLS åˆ›å»ºå…¬å¸è®°å½•

5. **ä¿ç•™å†™å…¥ `user_companies` çš„é€»è¾‘**
   - å†™å…¥æ“ä½œï¼ˆåˆ›å»ºå…³è”è®°å½•ï¼‰å®Œå…¨ä¿ç•™
   - ä½¿ç”¨ `userContext.userId` æ›¿ä»£åŸæ¥çš„ `user.id`

**æƒé™åˆ¤æ–­å…¥å£ï¼š**
- ä½ç½®ï¼šhandler å¼€å¤´ï¼Œç¬¬ 13-50 è¡Œ
- æ–¹å¼ï¼šè°ƒç”¨ `getUserContext(request)` è·å–ç»Ÿä¸€ç”¨æˆ·ä¸Šä¸‹æ–‡
- éªŒè¯ï¼šæ£€æŸ¥ `userContext.role === 'super_admin'`

### 2ï¸âƒ£ æ”¹é€  APIï¼š`app/api/equipment/rental/list/route.ts`

**æ”¹åŠ¨å†…å®¹ï¼š**

1. **åœ¨ handler å¼€å¤´è°ƒç”¨ `getUserContext(request)`**
   - ä½¿ç”¨ç»Ÿä¸€çš„ç”¨æˆ·ä¸Šä¸‹æ–‡è·å–ç”¨æˆ·èº«ä»½å’Œæƒé™
   - æ•è·é”™è¯¯å¹¶è¿”å›ç›¸åº”çš„ HTTP çŠ¶æ€ç ï¼ˆ401 æœªç™»å½•ï¼Œ403 æƒé™ä¸è¶³ï¼‰

2. **ä½¿ç”¨è¿”å›çš„ `companyId` ä½œä¸ºå”¯ä¸€ç§Ÿæˆ·è¿‡æ»¤æ¡ä»¶**
   - ç§»é™¤äº† `getCurrentCompanyId(request)` çš„è°ƒç”¨
   - ç§»é™¤äº†ä»æŸ¥è¯¢å‚æ•°è·å– `company_id` çš„é€»è¾‘
   - ç›´æ¥ä½¿ç”¨ `userContext.companyId` ä½œä¸ºç§Ÿæˆ·è¿‡æ»¤æ¡ä»¶

3. **ç¦æ­¢å†è°ƒç”¨ `getCurrentCompanyId` / `getCurrentUserId`**
   - ç§»é™¤äº† `getCurrentCompanyId` çš„å¯¼å…¥å’Œä½¿ç”¨
   - ç§»é™¤äº†ç›¸å…³çš„å¤šç§Ÿæˆ·å·¥å…·å‡½æ•°è°ƒç”¨

4. **å¦‚æœ `companyId` ä¸å­˜åœ¨ï¼ˆé super_adminï¼‰ï¼Œç›´æ¥è¿”å› 403**
   - æ·»åŠ äº†æ˜¾å¼æ£€æŸ¥ï¼šé `super_admin` ä¸”æ²¡æœ‰ `companyId` æ—¶è¿”å› 403
   - `super_admin` å…è®¸ `companyId` ä¸º `undefined`ï¼Œå¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ•°æ®

5. **æŸ¥è¯¢é€»è¾‘ä¿æŒä¸å˜**
   - åªæ›¿æ¢äº†"èº«ä»½æ¥æº"ï¼ˆä» `getCurrentCompanyId` æ”¹ä¸º `userContext.companyId`ï¼‰
   - å…¶ä»–æŸ¥è¯¢é€»è¾‘ã€ç­›é€‰æ¡ä»¶ã€æ’åºç­‰å®Œå…¨ä¿æŒä¸å˜

**æƒé™åˆ¤æ–­å…¥å£ï¼š**
- ä½ç½®ï¼šhandler å¼€å¤´ï¼Œç¬¬ 13-50 è¡Œ
- æ–¹å¼ï¼šè°ƒç”¨ `getUserContext(request)` è·å–ç»Ÿä¸€ç”¨æˆ·ä¸Šä¸‹æ–‡
- éªŒè¯ï¼šæ£€æŸ¥ `userContext.companyId` æ˜¯å¦å­˜åœ¨ï¼ˆé super_admin æ—¶ï¼‰

## ğŸ“‹ æ›¿æ¢çš„æ—§å‡½æ•°

### `app/api/admin/create-company/route.ts`

**è¢«æ›¿æ¢çš„å‡½æ•°ï¼š**
1. âŒ `createServerClient` - ç”¨äºè·å–ç”¨æˆ· sessionï¼ˆå·²åˆ é™¤ï¼‰
2. âŒ `supabaseClient.auth.getUser()` - ç”¨äºè·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå·²åˆ é™¤ï¼‰
3. âŒ ç›´æ¥æŸ¥è¯¢ `user_roles` è¡¨ - ç”¨äºè·å–ç”¨æˆ·è§’è‰²ï¼ˆå·²åˆ é™¤ï¼‰

**ä¿ç•™çš„å‡½æ•°ï¼š**
1. âœ… `createClient` with Service Role Key - ç”¨äºåˆ›å»ºå…¬å¸è®°å½•ï¼ˆä¿ç•™ï¼‰
2. âœ… å†™å…¥ `user_companies` è¡¨çš„é€»è¾‘ - ç”¨äºåˆ›å»ºå…³è”è®°å½•ï¼ˆä¿ç•™ï¼‰

### `app/api/equipment/rental/list/route.ts`

**è¢«æ›¿æ¢çš„å‡½æ•°ï¼š**
1. âŒ `getCurrentCompanyId(request)` - ç”¨äºè·å–å…¬å¸IDï¼ˆå·²åˆ é™¤ï¼‰

**ä¿ç•™çš„å‡½æ•°ï¼š**
1. âœ… `enforceCompanyFilter` - ç”¨äºåº”ç”¨å¤šç§Ÿæˆ·è¿‡æ»¤ï¼ˆä¿ç•™ï¼‰
2. âœ… `createClient` - ç”¨äºåˆ›å»º Supabase å®¢æˆ·ç«¯ï¼ˆä¿ç•™ï¼‰

## ğŸ” æƒé™åˆ¤æ–­å…¥å£ä½ç½®

### `app/api/admin/create-company/route.ts`

**æƒé™åˆ¤æ–­å…¥å£ï¼š**
- **ä½ç½®ï¼š** handler å¼€å¤´ï¼ˆç¬¬ 13-50 è¡Œï¼‰
- **æ–¹å¼ï¼š** `getUserContext(request)` â†’ æ£€æŸ¥ `userContext.role === 'super_admin'`
- **æµç¨‹ï¼š**
  1. è°ƒç”¨ `getUserContext(request)` è·å–ç”¨æˆ·ä¸Šä¸‹æ–‡
  2. å¦‚æœå¤±è´¥ï¼ˆæœªç™»å½•æˆ–æƒé™ä¸è¶³ï¼‰ï¼Œè¿”å› 401 æˆ– 403
  3. æ£€æŸ¥ `userContext.role === 'super_admin'`
  4. å¦‚æœä¸æ˜¯ `super_admin`ï¼Œè¿”å› 403

### `app/api/equipment/rental/list/route.ts`

**æƒé™åˆ¤æ–­å…¥å£ï¼š**
- **ä½ç½®ï¼š** handler å¼€å¤´ï¼ˆç¬¬ 13-50 è¡Œï¼‰
- **æ–¹å¼ï¼š** `getUserContext(request)` â†’ æ£€æŸ¥ `userContext.companyId` æ˜¯å¦å­˜åœ¨
- **æµç¨‹ï¼š**
  1. è°ƒç”¨ `getUserContext(request)` è·å–ç”¨æˆ·ä¸Šä¸‹æ–‡
  2. å¦‚æœå¤±è´¥ï¼ˆæœªç™»å½•æˆ–æƒé™ä¸è¶³ï¼‰ï¼Œè¿”å› 401 æˆ– 403
  3. æ£€æŸ¥é `super_admin` æ—¶æ˜¯å¦æœ‰ `companyId`
  4. å¦‚æœæ²¡æœ‰ `companyId`ï¼ˆé super_adminï¼‰ï¼Œè¿”å› 403
  5. ä½¿ç”¨ `userContext.companyId` ä½œä¸ºç§Ÿæˆ·è¿‡æ»¤æ¡ä»¶

## ğŸ”‘ Service Role Key ä½¿ç”¨æƒ…å†µ

### `app/api/admin/create-company/route.ts`

**æ˜¯å¦ä½¿ç”¨ Service Role Keyï¼š** âœ… æ˜¯

**ä½¿ç”¨ä½ç½®ï¼š** ç¬¬ 108-133 è¡Œ

**ä½¿ç”¨åŸå› ï¼š**
- è¿™æ˜¯ç³»ç»Ÿçº§ APIï¼Œéœ€è¦åˆ›å»ºå…¬å¸è®°å½•
- éœ€è¦ç»•è¿‡ RLSï¼ˆRow Level Securityï¼‰ç­–ç•¥
- åˆ›å»ºå…¬å¸åéœ€è¦è‡ªåŠ¨åˆ›å»º `user_companies` å…³è”è®°å½•
- è¿™äº›éƒ½æ˜¯ç³»ç»Ÿçº§æ“ä½œï¼Œéœ€è¦ç®¡ç†å‘˜æƒé™

**ä½¿ç”¨æ–¹å¼ï¼š**
```typescript
const adminSupabaseClient = createClient(
  supabaseUrl,
  serviceRoleKey,
  {
    auth: {
      persistSession: false,
      autoRefreshToken: false,
    },
  }
)
```

### `app/api/equipment/rental/list/route.ts`

**æ˜¯å¦ä½¿ç”¨ Service Role Keyï¼š** âš ï¸ å¯é€‰ï¼ˆä¼˜å…ˆä½¿ç”¨ï¼Œä½†å¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ anon keyï¼‰

**ä½¿ç”¨ä½ç½®ï¼š** ç¬¬ 52-58 è¡Œ

**ä½¿ç”¨åŸå› ï¼š**
- ä¼˜å…ˆä½¿ç”¨ Service Role Key ä»¥ç¡®ä¿èƒ½æŸ¥è¯¢åˆ°æ•°æ®
- å¦‚æœæ²¡æœ‰é…ç½® Service Role Keyï¼Œåˆ™ä½¿ç”¨ anon keyï¼ˆä¾èµ– RLS ç­–ç•¥ï¼‰
- è¿™æ˜¯æŸ¥è¯¢æ“ä½œï¼Œç†è®ºä¸Šå¯ä»¥ä½¿ç”¨ anon key + RLSï¼Œä½†ä½¿ç”¨ Service Role Key æ›´å¯é 

**ä½¿ç”¨æ–¹å¼ï¼š**
```typescript
const keyToUse = serviceRoleKey || anonKey
const supabaseClient = createClient(supabaseUrl, keyToUse, {
  auth: {
    persistSession: false,
    autoRefreshToken: false,
  },
})
```

## âœ… éªŒè¯ç»“æœ

1. âœ… ä¸¤ä¸ª API éƒ½å·²æ¥å…¥ `getUserContext`
2. âœ… åˆ é™¤äº†ç›´æ¥æŸ¥è¯¢ `user_roles` å’Œ `user_companies` çš„è¯»å–é€»è¾‘
3. âœ… ä¿ç•™äº†å¿…è¦çš„å†™å…¥æ“ä½œå’Œ Service Role Key ä½¿ç”¨
4. âœ… æƒé™åˆ¤æ–­ç»Ÿä¸€é€šè¿‡ `getUserContext` å…¥å£
5. âœ… æ²¡æœ‰ä¿®æ”¹å…¶ä»– APIã€ä¸é‡æ„ `lib/multi-tenant.ts`ã€ä¸æ–°å¢åŠŸèƒ½ã€ä¸è°ƒæ•´è¿”å›ç»“æ„

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **`getUserContext` é”™è¯¯å¤„ç†ï¼š** ä¸¤ä¸ª API éƒ½æ·»åŠ äº† try-catch æ¥æ•è· `getUserContext` å¯èƒ½æŠ›å‡ºçš„é”™è¯¯ï¼Œå¹¶è¿”å›ç›¸åº”çš„ HTTP çŠ¶æ€ç 

2. **super_admin ç‰¹æ®Šå¤„ç†ï¼š** åœ¨ `equipment/rental/list` API ä¸­ï¼Œ`super_admin` å…è®¸ `companyId` ä¸º `undefined`ï¼Œå¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ•°æ®

3. **å‘åå…¼å®¹ï¼š** æŸ¥è¯¢é€»è¾‘ä¿æŒä¸å˜ï¼Œåªæ›¿æ¢äº†èº«ä»½æ¥æºï¼Œç¡®ä¿åŠŸèƒ½ä¸å—å½±å“
