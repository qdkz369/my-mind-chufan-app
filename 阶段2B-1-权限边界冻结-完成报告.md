# é˜¶æ®µ 2B-1ï¼šæƒé™è¾¹ç•Œå†»ç»“ - å®ŒæˆæŠ¥å‘Š

## âœ… å·²å®Œæˆå·¥ä½œ

å·²æ‰«æå¹¶æ ‡æ³¨ `app/api` ç›®å½•ä¸‹æ‰€æœ‰ 37 ä¸ª API æ–‡ä»¶ï¼ŒæŒ‰æƒé™çº§åˆ«åˆ†ç±»å¹¶æ·»åŠ æ ‡æ³¨æ³¨é‡Šã€‚

## ğŸ“‹ API åˆ†ç±»æ±‡æ€»

### ğŸ”´ SYSTEM_LEVEL APIï¼ˆç³»ç»Ÿçº§ï¼Œåªèƒ½ç”± super_admin è°ƒç”¨ï¼‰

| API è·¯å¾„ | å½“å‰ Key | ç›®æ ‡ Key | è¯´æ˜ |
|---------|---------|---------|------|
| `app/api/admin/create-company/route.ts` | Service Role Key | Service Role Key | åˆ›å»ºä¾›åº”å•†å…¬å¸ï¼Œç³»ç»Ÿçº§æ“ä½œï¼Œå¿…é¡»ä¿ç•™ Service Role Key |
| `app/api/admin/find-user/route.ts` | Service Role Key | Service Role Key | è®¿é—® auth.users è¡¨ï¼Œå¿…é¡»ä½¿ç”¨ Service Role Key |

**æ€»è®¡ï¼š2 ä¸ª**

### ğŸŸ¡ COMPANY_LEVEL APIï¼ˆå…¬å¸çº§ï¼Œadmin/staff è°ƒç”¨ï¼Œå¿…é¡»å¼ºåˆ¶ company_id è¿‡æ»¤ï¼‰

| API è·¯å¾„ | å½“å‰ Key | ç›®æ ‡ Key | è¯´æ˜ |
|---------|---------|---------|------|
| `app/api/equipment/catalog/approve/route.ts` | Service Role Key (ä¼˜å…ˆ) | Anon Key + RLS | å®¡æ ¸äº§å“åº“æ¡ç›® |
| `app/api/equipment/catalog/create/route.ts` | Service Role Key (ä¼˜å…ˆ) | Anon Key + RLS | åˆ›å»ºäº§å“åº“æ¡ç›®ï¼ˆä¾›åº”å•†ä¸Šä¼ ï¼‰ |
| `app/api/equipment/catalog/list/route.ts` | Anon Key | Anon Key + RLS | è·å–äº§å“åº“åˆ—è¡¨ï¼Œå·²ä½¿ç”¨ Anon Keyï¼Œéœ€å®Œå–„ RLS |
| `app/api/equipment/rental/list/route.ts` | Service Role Key (ä¼˜å…ˆ) æˆ– Anon Key | Anon Key + RLS | è·å–ç§Ÿèµè®¢å•åˆ—è¡¨ï¼Œå·²æ¥å…¥ getUserContext |
| `app/api/equipment/rental/create/route.ts` | Anon Key | Anon Key + RLS | åˆ›å»ºç§Ÿèµè®¢å•ï¼Œå·²ä½¿ç”¨ Anon Keyï¼Œéœ€å®Œå–„ RLS |
| `app/api/equipment/rental/admin/list/route.ts` | Service Role Key (ä¼˜å…ˆ) | Anon Key + RLS | è·å–æ‰€æœ‰è®¾å¤‡ç§Ÿèµè®¢å•ï¼ˆç®¡ç†ç«¯ï¼‰ |
| `app/api/equipment/rental/update/route.ts` | Service Role Key (ä¼˜å…ˆ) | Anon Key + RLS | æ›´æ–°ç§Ÿèµè®¢å•çŠ¶æ€ |
| `app/api/equipment/rental/finance/route.ts` | æ— ï¼ˆé¢„ç•™æ¥å£ï¼‰ | å¾…å®ç° | ç¬¬ä¸‰æ–¹é‡‘èæœºæ„APIæ¥å£ï¼ˆé¢„ç•™ï¼‰ |
| `app/api/equipment/list/route.ts` | Service Role Key (ä¼˜å…ˆ) | Anon Key + RLS | è·å–è®¾å¤‡åˆ—è¡¨ |
| `app/api/equipment/categories/route.ts` | Service Role Key (ä¼˜å…ˆ) | Anon Key + RLS | è·å–è®¾å¤‡åˆ†ç±»åˆ—è¡¨ |
| `app/api/status/transition/route.ts` | Service Role Key (ä¼˜å…ˆ) | Anon Key + RLS | ç»Ÿä¸€çš„çŠ¶æ€å˜æ›´æ¥å£ |
| `app/api/orders/create/route.ts` | Anon Key | Anon Key + RLS | åˆ›å»ºè®¢å•ï¼Œå·²ä½¿ç”¨ Anon Keyï¼Œéœ€å®Œå–„ RLS |
| `app/api/storage/upload/route.ts` | Anon Key | Anon Key + RLS | ä¸Šä¼ å›¾ç‰‡åˆ°Supabase Storageï¼Œå·²ä½¿ç”¨ Anon Keyï¼Œéœ€å®Œå–„ RLS |
| `app/api/restaurant/generate-token/route.ts` | Anon Key | Anon Key + RLS | ä¸ºé¤å…ç”Ÿæˆæˆ–æ›´æ–° qr_tokenï¼Œå·²ä½¿ç”¨ Anon Keyï¼Œéœ€å®Œå–„ RLS |
| `app/api/payment/alipay/create/route.ts` | æ— ï¼ˆä¸ç›´æ¥è®¿é—®æ•°æ®åº“ï¼‰ | Anon Key + RLSï¼ˆå¦‚éœ€è¦ï¼‰ | åˆ›å»ºæ”¯ä»˜è®¢å• |

**æ€»è®¡ï¼š15 ä¸ª**

### ğŸŸ¢ STAFF_LEVEL APIï¼ˆå‘˜å·¥çº§ï¼Œåªèƒ½ staff è°ƒç”¨ï¼Œå¿…é¡»ç»‘å®š worker_id/assigned_toï¼‰

| API è·¯å¾„ | å½“å‰ Key | ç›®æ ‡ Key | è¯´æ˜ |
|---------|---------|---------|------|
| `app/api/repair/list/route.ts` | Anon Key | Anon Key + RLS | è·å–æœåŠ¡å·¥å•åˆ—è¡¨ï¼ˆç»´ä¿®/æ¸…æ´/å·¥ç¨‹ï¼‰ |
| `app/api/repair/create/route.ts` | Anon Key æˆ– Service Role Key (fallback) | Anon Key + RLS | åˆ›å»ºæŠ¥ä¿®å·¥å• |
| `app/api/repair/update/route.ts` | Anon Key | Anon Key + RLS | æ›´æ–°æŠ¥ä¿®å·¥å•çŠ¶æ€å’Œé‡‘é¢ |
| `app/api/orders/pending/route.ts` | Anon Key | Anon Key + RLS | è·å–å¾…æ¥å•è®¢å•åˆ—è¡¨ |
| `app/api/orders/accept/route.ts` | Anon Key | Anon Key + RLS | é…é€å‘˜æ¥å• |
| `app/api/orders/dispatch/route.ts` | Anon Key | Anon Key + RLS | é…é€å‘˜æ´¾å• |
| `app/api/orders/complete/route.ts` | Anon Key | Anon Key + RLS | å®Œæˆé…é€ |
| `app/api/install/route.ts` | Anon Key | Anon Key + RLS | æäº¤è®¾å¤‡å®‰è£…ä¿¡æ¯ |
| `app/api/filling/route.ts` | Anon Key | Anon Key + RLS | è®°å½•é…é€æ“ä½œåˆ° filling_logs |
| `app/api/delivery/route.ts` | Anon Key | Anon Key + RLS | å¤„ç†ç‡ƒæ–™é…é€ï¼ˆå›ºå®šæ²¹ç®±/æµåŠ¨é’¢ç“¶ï¼‰ |
| `app/api/delivery/location/route.ts` | Anon Key | Anon Key + RLS | è·å–é…é€å‘˜å®æ—¶GPSä½ç½® |

**æ€»è®¡ï¼š11 ä¸ª**

### ğŸ”µ PUBLIC APIï¼ˆå…¬å¼€è®¿é—®ï¼Œæ— éœ€æƒé™éªŒè¯ï¼‰

| API è·¯å¾„ | å½“å‰ Key | ç›®æ ‡ Key | è¯´æ˜ |
|---------|---------|---------|------|
| `app/api/worker/login/route.ts` | Anon Key | Anon Key + RLS | å·¥äººç™»å½• |
| `app/api/restaurant/register/route.ts` | Anon Key | Anon Key + RLS | æ³¨å†Œæ–°é¤å… |
| `app/api/restaurant/login/route.ts` | Anon Key | Anon Key + RLS | é¤å…ç™»å½• |
| `app/api/restaurant/route.ts` | Anon Key | Anon Key + RLS | æ ¹æ® qr_token è·å–é¤å…ä¿¡æ¯ |
| `app/api/payment/alipay/notify/route.ts` | Anon Key | Anon Key + RLS | æ”¯ä»˜å®æ”¯ä»˜å›è°ƒé€šçŸ¥ï¼ˆéœ€éªŒè¯ç­¾åï¼‰ |
| `app/api/fuel-sensor/route.ts` | Anon Key | Anon Key + RLS | æ¥æ”¶ä¼ æ„Ÿå™¨æ•°æ®ï¼ˆéœ€éªŒè¯è®¾å¤‡èº«ä»½ï¼‰ |
| `app/api/merchant/location/route.ts` | Anon Key | Anon Key + RLS | è·å–å•†æˆ·æ³¨å†Œæ—¶çš„å®šä½åœ°å€ |

**æ€»è®¡ï¼š7 ä¸ª**

### âšª TEST APIï¼ˆæµ‹è¯•/å·¥å…·APIï¼Œæ— éœ€æƒé™éªŒè¯ï¼‰

| API è·¯å¾„ | å½“å‰ Key | ç›®æ ‡ Key | è¯´æ˜ |
|---------|---------|---------|------|
| `app/api/test/env/route.ts` | Service Role Key (ç”¨äºæµ‹è¯•) | æ— éœ€è¿ç§» | æµ‹è¯•ç¯å¢ƒå˜é‡é…ç½® |
| `app/api/worker/check-table/route.ts` | Anon Key | æ— éœ€è¿ç§» | æ£€æŸ¥ workers è¡¨æ˜¯å¦å­˜åœ¨ |

**æ€»è®¡ï¼š2 ä¸ª**

## âš ï¸ å½“å‰"ç”¨é”™äº† Key"çš„ API åˆ—è¡¨

ä»¥ä¸‹ API å½“å‰ä½¿ç”¨ Service Role Keyï¼Œä½†åº”è¯¥è¿ç§»åˆ° Anon Key + RLSï¼š

### COMPANY_LEVEL APIï¼ˆéœ€è¦è¿ç§»ï¼‰

1. **`app/api/equipment/catalog/approve/route.ts`**
   - å½“å‰ï¼šService Role Key (ä¼˜å…ˆ)
   - åº”è¯¥ï¼šAnon Key + RLS
   - åŸå› ï¼šadmin/staff æ“ä½œï¼Œåº”è¯¥é€šè¿‡ RLS ç­–ç•¥æ§åˆ¶æƒé™

2. **`app/api/equipment/catalog/create/route.ts`**
   - å½“å‰ï¼šService Role Key (ä¼˜å…ˆ)
   - åº”è¯¥ï¼šAnon Key + RLS
   - åŸå› ï¼šä¾›åº”å•†ä¸Šä¼ äº§å“ï¼Œåº”è¯¥é€šè¿‡ RLS ç­–ç•¥æ§åˆ¶æƒé™

3. **`app/api/equipment/rental/admin/list/route.ts`**
   - å½“å‰ï¼šService Role Key (ä¼˜å…ˆ)
   - åº”è¯¥ï¼šAnon Key + RLS
   - åŸå› ï¼šç®¡ç†ç«¯åˆ—è¡¨æŸ¥è¯¢ï¼Œåº”è¯¥é€šè¿‡ RLS ç­–ç•¥æ§åˆ¶æƒé™

4. **`app/api/equipment/rental/update/route.ts`**
   - å½“å‰ï¼šService Role Key (ä¼˜å…ˆ)
   - åº”è¯¥ï¼šAnon Key + RLS
   - åŸå› ï¼šæ›´æ–°è®¢å•çŠ¶æ€ï¼Œåº”è¯¥é€šè¿‡ RLS ç­–ç•¥æ§åˆ¶æƒé™

5. **`app/api/equipment/list/route.ts`**
   - å½“å‰ï¼šService Role Key (ä¼˜å…ˆ)
   - åº”è¯¥ï¼šAnon Key + RLS
   - åŸå› ï¼šè®¾å¤‡åˆ—è¡¨æŸ¥è¯¢ï¼Œåº”è¯¥é€šè¿‡ RLS ç­–ç•¥æ§åˆ¶æƒé™

6. **`app/api/equipment/categories/route.ts`**
   - å½“å‰ï¼šService Role Key (ä¼˜å…ˆ)
   - åº”è¯¥ï¼šAnon Key + RLS
   - åŸå› ï¼šè®¾å¤‡åˆ†ç±»æŸ¥è¯¢ï¼Œåº”è¯¥é€šè¿‡ RLS ç­–ç•¥æ§åˆ¶æƒé™

7. **`app/api/status/transition/route.ts`**
   - å½“å‰ï¼šService Role Key (ä¼˜å…ˆ)
   - åº”è¯¥ï¼šAnon Key + RLS
   - åŸå› ï¼šçŠ¶æ€å˜æ›´æ“ä½œï¼Œåº”è¯¥é€šè¿‡ RLS ç­–ç•¥æ§åˆ¶æƒé™

8. **`app/api/equipment/rental/list/route.ts`**
   - å½“å‰ï¼šService Role Key (ä¼˜å…ˆ) æˆ– Anon Key
   - åº”è¯¥ï¼šAnon Key + RLS
   - åŸå› ï¼šå·²æ¥å…¥ getUserContextï¼Œåº”è¯¥å®Œå…¨ä½¿ç”¨ Anon Key + RLS

### STAFF_LEVEL APIï¼ˆéœ€è¦è¿ç§»ï¼‰

9. **`app/api/repair/create/route.ts`**
   - å½“å‰ï¼šAnon Key æˆ– Service Role Key (fallback)
   - åº”è¯¥ï¼šAnon Key + RLS
   - åŸå› ï¼šåˆ›å»ºæŠ¥ä¿®å·¥å•ï¼Œåº”è¯¥é€šè¿‡ RLS ç­–ç•¥æ§åˆ¶æƒé™ï¼Œç§»é™¤ Service Role Key fallback

## ğŸ“Š ç»Ÿè®¡æ±‡æ€»

| æƒé™çº§åˆ« | æ•°é‡ | ä½¿ç”¨ Service Role Key | ä½¿ç”¨ Anon Key | éœ€è¦è¿ç§» |
|---------|------|---------------------|--------------|---------|
| SYSTEM_LEVEL | 2 | 2 | 0 | 0 |
| COMPANY_LEVEL | 15 | 8 | 7 | 8 |
| STAFF_LEVEL | 11 | 1 (fallback) | 11 | 1 |
| PUBLIC | 7 | 0 | 7 | 0 |
| TEST | 2 | 1 | 1 | 0 |
| **æ€»è®¡** | **37** | **12** | **26** | **9** |

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®

### ä¼˜å…ˆçº§ 1ï¼šè¿ç§» COMPANY_LEVEL API

ä»¥ä¸‹ 8 ä¸ª API éœ€è¦ä¼˜å…ˆè¿ç§»åˆ° Anon Key + RLSï¼š

1. `equipment/catalog/approve` - å®¡æ ¸äº§å“
2. `equipment/catalog/create` - åˆ›å»ºäº§å“
3. `equipment/rental/admin/list` - ç®¡ç†ç«¯åˆ—è¡¨
4. `equipment/rental/update` - æ›´æ–°è®¢å•
5. `equipment/list` - è®¾å¤‡åˆ—è¡¨
6. `equipment/categories` - è®¾å¤‡åˆ†ç±»
7. `status/transition` - çŠ¶æ€å˜æ›´
8. `equipment/rental/list` - ç§Ÿèµè®¢å•åˆ—è¡¨ï¼ˆå·²æ¥å…¥ getUserContextï¼Œéœ€å®Œå…¨è¿ç§»ï¼‰

### ä¼˜å…ˆçº§ 2ï¼šè¿ç§» STAFF_LEVEL API

ä»¥ä¸‹ 1 ä¸ª API éœ€è¦è¿ç§»ï¼š

1. `repair/create` - ç§»é™¤ Service Role Key fallbackï¼Œå®Œå…¨ä½¿ç”¨ Anon Key + RLS

### ä¼˜å…ˆçº§ 3ï¼šå®Œå–„ RLS ç­–ç•¥

æ‰€æœ‰ä½¿ç”¨ Anon Key çš„ API éƒ½éœ€è¦å®Œå–„ RLS ç­–ç•¥ï¼Œç¡®ä¿ï¼š
- COMPANY_LEVEL APIï¼šå¼ºåˆ¶æŒ‰ `company_id` è¿‡æ»¤
- STAFF_LEVEL APIï¼šé™åˆ¶åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®ï¼ˆé€šè¿‡ `worker_id` / `assigned_to`ï¼‰

## ğŸ“ æ ‡æ³¨æ ¼å¼è¯´æ˜

æ‰€æœ‰ API æ–‡ä»¶é¡¶éƒ¨å·²æ·»åŠ ä»¥ä¸‹æ ¼å¼çš„æ ‡æ³¨ï¼š

```typescript
// ACCESS_LEVEL: SYSTEM_LEVEL | COMPANY_LEVEL | STAFF_LEVEL | PUBLIC | TEST
// ALLOWED_ROLES: super_admin | admin, staff | staff | æ—  | æ— 
// CURRENT_KEY: Service Role Key | Anon Key | æ— 
// TARGET_KEY: Service Role Key | Anon Key + RLS | å¾…å®ç° | æ— éœ€è¿ç§»
// è¯´æ˜ï¼šå…·ä½“è¯´æ˜
```

## âœ… å®ŒæˆçŠ¶æ€

- âœ… å·²æ‰«ææ‰€æœ‰ 37 ä¸ª API æ–‡ä»¶
- âœ… å·²æŒ‰æƒé™çº§åˆ«åˆ†ç±»
- âœ… å·²æ·»åŠ æ ‡æ³¨æ³¨é‡Š
- âœ… å·²è¯†åˆ«éœ€è¦è¿ç§»çš„ API
- âœ… å·²ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š

**é˜¶æ®µ 2B-1 å®Œæˆï¼æ‰€æœ‰ API å·²æ ‡æ³¨ï¼Œæƒé™è¾¹ç•Œå·²å†»ç»“ã€‚**
